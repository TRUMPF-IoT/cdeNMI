// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
var cde;
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
(function (cde) {
    //////////////////////////////////////////////////////////////////////////////
    /// Interfaces
    //////////////////////////////////////////////////////////////////////////////
    function IsIE() {
        if (!navigator)
            return false; //NodeJS should return false here
        const ua = navigator.userAgent;
        /* MSIE used to detect old browsers and Trident used to newer ones*/
        return ua.indexOf("MSIE ") > -1 || ua.indexOf("Trident/") > -1;
    }
    cde.IsIE = IsIE;
    function cdeEval(pCode, ...param) {
        if (pCode.substring(0, 1) === "[") {
            return JSON.parse(pCode.replace(/'/g, "\""));
        }
        if (pCode.substring(0, 2) === "([" || pCode.substring(0, 2) === "({") {
            const tJ = pCode.substring(1, pCode.length - 1);
            return JSON.parse(tJ.replace(/'/g, "\""));
        }
        return Function('"use strict";return (' + pCode + ')')(...param);
    }
    cde.cdeEval = cdeEval;
    /**
 C-DEngine Base Class for all Databound classes
*/
    class TheDataBase {
        constructor() {
            this.MyEvents = [];
        }
        HasEvent(pName) {
            if (this.MyEvents && this.MyEvents[pName])
                return true;
            return false;
        }
        RegisterEvent(pName, pCallBackSink) {
            if (!this.MyEvents[pName])
                this.MyEvents[pName] = [];
            if (this.MyEvents[pName].indexOf(pCallBackSink) < 0)
                this.MyEvents[pName].push(pCallBackSink);
        }
        UnregisterEvent(pName, pCallback) {
            if (this.MyEvents[pName]) {
                if (!pCallback)
                    this.MyEvents[pName] = [];
                else {
                    for (let i = this.MyEvents[pName].length - 1; i >= 0; i--) { // STEP 1
                        if (this.MyEvents[pName][i] === pCallback) { // STEP 2
                            this.MyEvents[pName].splice(i, 1); // STEP 3
                            break;
                        }
                    }
                }
            }
        }
        FireEvent(FireAsync, pEvtName, ...params) {
            if (this.MyEvents[pEvtName]) {
                for (let mh = 0; mh < this.MyEvents[pEvtName].length; mh++) {
                    if (this.MyEvents[pEvtName][mh]) {
                        try {
                            if (typeof this.MyEvents[pEvtName][mh] === "string") {
                                const EventName = pEvtName;
                                const Parameter = params.length > 1 ? params[1] : null;
                                const PropertyName = params.length > 2 ? params[2] : null;
                                if (params.length < 3) {
                                    if (cde.MyBaseAssets.MyServiceHostInfo.DebugLevel > 3)
                                        debugger;
                                }
                                const tJS = this.MyEvents[EventName][mh];
                                if (tJS.substring(0, 3) === "JS:")
                                    cdeEval(tJS.substring(3));
                                else {
                                    cde.MyBaseAssets.FireEvent(FireAsync, "OnStringEvent", tJS, this, Parameter, PropertyName, params);
                                }
                            }
                            else {
                                if (params.length > 0 && params[0] instanceof cde.TheProcessMessage)
                                    this.MyEvents[pEvtName][mh](this, params[0]);
                                else
                                    this.MyEvents[pEvtName][mh](this, ...params);
                            }
                        }
                        catch (error) {
                            if (pEvtName !== "CDE_NEW_LOGENTRY")
                                cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "cdeCore:FireEvent", "FireEvent:" + error + "<br>" + error.stack);
                        }
                    }
                }
            }
        }
    }
    cde.TheDataBase = TheDataBase;
    /**
 Extension to the C-DEngine Base Class for all Databound classes including Meta Data (i.e. for Table and Form descriptions)
*/
    class TheEngineState extends TheDataBase {
        constructor() {
            super();
            this.IsInitialized = false;
            this.IsEngineScoped = false;
            this.IsEngineReady = false;
        }
    }
    cde.TheEngineState = TheEngineState;
    class TheMetaDataBase extends TheDataBase {
    }
    cde.TheMetaDataBase = TheMetaDataBase;
    class TSM {
        constructor(pEng) {
            this.ENG = pEng;
            this.TIM = new Date();
            this.FID = cde.MyBaseAssets.MyServiceHostInfo.MsgSendCounter++;
            this.PLB = null;
            this.QDX = 5; //Sync with Full CDE
            this.LVL = 4; //Sync with Full CDE
        }
        static GetOriginator(pTSM) {
            if (!pTSM.ORG)
                return "";
            const t = pTSM.ORG.split(';');
            return t[0];
        }
    }
    cde.TSM = TSM;
    class TheDeviceMessage {
    }
    cde.TheDeviceMessage = TheDeviceMessage;
    class TheMeshPicker extends cde.TheDataBase {
    }
    cde.TheMeshPicker = TheMeshPicker;
    class TheISBConnect {
    }
    cde.TheISBConnect = TheISBConnect;
    class cdeP extends TheMetaDataBase {
    }
    cde.cdeP = cdeP;
    class TheThing extends TheMetaDataBase {
    }
    cde.TheThing = TheThing;
    class TheSegment {
    }
    cde.TheSegment = TheSegment;
    class TheProcessMessage {
        constructor(pTopic, pTSM) {
            this.Topic = pTopic;
            this.Message = pTSM;
        }
    }
    cde.TheProcessMessage = TheProcessMessage;
    class TheNV {
    }
    cde.TheNV = TheNV;
    class TheTimeouts {
        constructor() {
            this.HeartBeat = 30;
            this.PickupRate = 250;
            this.InitRate = 100;
            this.HeartBeatMissed = 4;
            this.PickupRateDelay = 1;
            this.WsTimeOut = 5000;
        }
        EnterAdrenalin() {
            this.HeartBeat = 5;
            this.HeartBeatMissed = 30;
        }
        NormalHeartRate() {
            this.HeartBeat = 30;
            this.HeartBeatMissed = 4;
        }
        EnterSleepMode() {
            this.HeartBeat = 100;
            this.HeartBeatMissed = 3;
        }
    }
    cde.TheTimeouts = TheTimeouts;
    class TheCommConfig {
        constructor(ptimout) {
            this.NoISB = false;
            this.RequestPath = null;
            this.DisableRSA = false;
            this.KeepSessionAlive = false;
            this.port = 80;
            this.host = null; ///"127.0.0.1";
            this.Creds = null;
            this.useTLS = false;
            this.cdeTIM = new Date();
            this.IsWSHBDisabled = false;
            this.TO = new TheTimeouts();
            if (ptimout > 0)
                this.TO.WsTimeOut = ptimout;
        }
    }
    cde.TheCommConfig = TheCommConfig;
    class TheCDECredentials {
        constructor() {
            this.QUID = "";
            this.QPWD = "";
            this.QToken = null;
        }
    }
    cde.TheCDECredentials = TheCDECredentials;
    class TheCoreQueueContent {
        constructor(pEng, pTopic, pMsg) {
            this.ENG = pEng;
            this.JMSG = JSON.stringify(pMsg);
            this.TOPIC = pTopic;
        }
    }
    cde.TheCoreQueueContent = TheCoreQueueContent;
    class TheServiceHostInfo {
        constructor() {
            //Embedded Objects
            this.IsEmbedded = false; //Should be set to true if the NMI is hosted in another Site
            this.ResourcePath = ''; //Additional path if NMI resources are merged with other sites resources (i.e. /NMI/ loads all resources under <hostingurl>/NMI/*)
            this.WsTimeOut = 0;
            this.DisableRSA = false;
            this.UToken = "";
            //Target Service Depending Settings
            this.RequestGeoLocation = false;
            this.EnablePinLogin = false;
            this.DoAllowAnonymous = false;
            this.LoginDisallowed = false;
            this.DisableWebWorker = false;
            this.IsUsingUserMapper = false;
            this.AllowSetScopeWithSetAdmin = false;
            this.WebPlatform = 0;
            this.RedPill = false;
            this.LastSID = ""; //4.209: No longer Used!!
            this.KnownRelays = "";
            this.AutoConnectRelay = null;
            this.NMIVersion = 4.0;
            this.WasPortalRequested = false;
            this.PortalPage = "";
            this.ShowClassic = false;
            this.ScreenManagerClass = null;
            this.ShowLogInConsole = false;
            this.ReloadAfterLogout = 0;
            this.ApplicationTitle = "";
            this.MainConfigScreen = "";
            this.TileSize = 78;
            this.TileScale = 1.0;
            this.InputSize = 60;
            this.ScreenClassName = "cdeBrowserTop";
            this.WasInitialScreenVisible = false;
            ///Used by Convenience Apps
            this.IsLiteTheme = false;
            this.UPref = "";
            this.DoesRequireConfiguration = false;
            this.MyStationID = "";
            this.HasInternetAccess = false;
            this.IsAppHosted = false;
            this.IsWebHosted = false;
            this.MsgSendCounter = 0;
            this.DebugLevel = 0;
            this.MyWSServiceUrl = null; //WebSockets URL of the FirstNode - can be emtpy if websockets are disabled
            this.PortalReset = null;
            this.mPortalScreen = null;
            this.mStartScreen = null;
            this.mCurrentLCID = null;
            this.mHideHeader = null;
            this.mAdminPWMustBeSet = null;
            this.mAdminRole = null;
            //FirstNodeID: string = '';
            this.mFirstNodeID = null;
        }
        set PortalScreen(value) { this.mPortalScreen = value; }
        get PortalScreen() {
            if (cde.MyBaseAssets.MyCommStatus.UserPref && cde.MyBaseAssets.MyCommStatus.UserPref.PortalScreen)
                return cde.MyBaseAssets.MyCommStatus.UserPref.PortalScreen;
            return this.mPortalScreen;
        }
        set StartScreen(value) { this.mStartScreen = value; }
        get StartScreen() {
            if (cde.MyBaseAssets.MyCommStatus.UserPref && cde.MyBaseAssets.MyCommStatus.UserPref.StartScreen)
                return cde.MyBaseAssets.MyCommStatus.UserPref.StartScreen;
            return this.mStartScreen;
        }
        set CurrentLCID(value) { this.mCurrentLCID = value; }
        get CurrentLCID() {
            if (cde.MyBaseAssets.MyCommStatus.UserPref && cde.CInt(cde.MyBaseAssets.MyCommStatus.UserPref.LCID) > 0)
                return cde.MyBaseAssets.MyCommStatus.UserPref.LCID;
            return this.mCurrentLCID;
        }
        set HideHeader(value) { this.mHideHeader = value; }
        get HideHeader() {
            if (cde.MyBaseAssets.MyCommStatus.UserPref && cde.CBool(cde.MyBaseAssets.MyCommStatus.UserPref.HideHeader) === true)
                return cde.CBool(cde.MyBaseAssets.MyCommStatus.UserPref.HideHeader);
            return this.mHideHeader;
        }
        set AdminPWMustBeSet(value) { this.mAdminPWMustBeSet = value; }
        get AdminPWMustBeSet() {
            if (cde.CBool(cde.MyBaseAssets.MyCommStatus.AdminPWMustBeSet))
                return true;
            return this.mAdminPWMustBeSet;
        }
        set AdminRole(value) { this.mAdminRole = value; }
        get AdminRole() {
            if (cde.MyBaseAssets.MyCommStatus.AdminRole)
                return cde.MyBaseAssets.MyCommStatus.AdminRole;
            return this.mAdminRole;
        }
        set FirstNodeID(value) { this.mFirstNodeID = value; }
        get FirstNodeID() {
            if (cde.MyBaseAssets.MyCommStatus.FirstNodeID)
                return cde.MyBaseAssets.MyCommStatus.FirstNodeID;
            return this.mFirstNodeID;
        }
        get IsUserLoggedIn() {
            if (cde.MyBaseAssets.MyCommStatus)
                return cde.MyBaseAssets.MyCommStatus.IsUserLoggedIn;
            else
                return false;
        }
        //Moved to MyCommStatus! - can lead to back-incompat if used by a 3rd party extension - all set to read only
        //UserPref: cde.TheUserPreferences;
        //MyServiceUrl: string = '';
        //RequestPath: string = '';
        get CurrentUserName() {
            if (cde.MyBaseAssets.MyCommStatus.UserPref && cde.MyBaseAssets.MyCommStatus.UserPref.CurrentUserName)
                return cde.MyBaseAssets.MyCommStatus.UserPref.CurrentUserName;
            return "";
        }
    }
    cde.TheServiceHostInfo = TheServiceHostInfo;
    class TheWHSI {
        constructor() {
            this.CurrentRSA = null; //CurrentRSA Key used for RSA Encryption
            this.IsConnected = false; //True if the Communication was established
            this.CallerCount = 0; //Amount of SharedWorker ports
            this.InitialNPA = null;
            this.HasAutoLogin = false; //True if the credentials have been set before the Login Dialog appeard (AutoLogin)
            this.FirstNodeID = null; //NodeID of FirstNode after connect
            this.AdminPWMustBeSet = false; //True if FirstNode requires AdminPWToBe Set (browser is unscoped and cannot send any telegrams except "SET_ADMIN_PWD")
            this.AdminRole = null; //Role of the Current User (Not used, yet)
            this.LastPortalScreen = null; //If a user hit F5 this will contain the last portal screen used
            this.LastStartScreen = null; //If a user hit F5 this will contain the last start screen used
            this.MyServiceUrl = null; //Http URL of the FirstNode - can be used for DeepLinks
            this.UserPref = null; //User Preferences (see below) coming in with the CDE_LOGIN_EVENT
        }
        get IsUserLoggedIn() {
            if (this.UserPref)
                return true;
            else
                return false;
        }
    }
    cde.TheWHSI = TheWHSI;
    class TheBaseAssets extends TheDataBase {
        constructor() {
            super(...arguments);
            this.MyServiceHostInfo = new TheServiceHostInfo();
            this.MyCommStatus = new TheWHSI(); //CommChannel Relevant Status
            this.MyEngines = new Array();
        }
        ///Used by Convenience Apps
        static IsConnectionDown() {
            return (!cde.MyCommChannel || !cde.MyCommChannel.IsConnected).toString();
        }
        get HasAutoLogin() { return (cde.MyCommChannel && cde.MyCommChannel.HasAutoLogin === true); }
    }
    cde.TheBaseAssets = TheBaseAssets;
    class TheUserPreferences extends cde.TheDataBase {
        constructor() {
            super(...arguments);
            this.CurrentUserName = null;
            this.PortalScreen = null; //PortalScreen of the NMI (Must be a dashboard)
            this.StartScreen = null; //StartScreen of the NMI (a screen within the PortalScreen Dashboard)
            this.HideHeader = false; //True if the FirstNode wants to see no Header in the browser
        }
    }
    cde.TheUserPreferences = TheUserPreferences;
    //From CommonUtils to reduce references
    function FixupPath(pInPath) {
        if (!pInPath || pInPath.length === 1)
            return "";
        let tPa = "";
        if (cde.MyBaseAssets.MyServiceHostInfo.ResourcePath) {
            tPa = cde.MyBaseAssets.MyServiceHostInfo.ResourcePath;
            if (pInPath.substring(0, 1) !== "/")
                tPa += "/";
        }
        if (cde.MyBaseAssets.MyCommStatus.MyServiceUrl && document.location.origin !== cde.MyBaseAssets.MyCommStatus.MyServiceUrl) {
            if (tPa.length > 0)
                tPa = `${cde.MyBaseAssets.MyCommStatus.MyServiceUrl}/${tPa}`;
            else
                tPa = cde.MyBaseAssets.MyCommStatus.MyServiceUrl;
        }
        if ((tPa.length > 0 && tPa.substring(tPa.length - 1) !== "/") && !pInPath.startsWith("/") && !pInPath.toLowerCase().startsWith("http"))
            tPa += "/";
        return tPa + pInPath;
    }
    cde.FixupPath = FixupPath;
    function DateToString(inDate) {
        const month = inDate.getMonth() + 1;
        const day = inDate.getDate();
        const year = inDate.getFullYear();
        const hours = inDate.getHours();
        const minutes = inDate.getMinutes();
        let ampm = "AM";
        if (hours > 11) {
            ampm = "PM";
        }
        return month + "/" + day + "/" + year + " " + hours + ":" + minutes + " " + ampm;
    }
    cde.DateToString = DateToString;
    function IsNotSet(pInVal) {
        return pInVal === undefined || pInVal === null || pInVal === "";
    }
    cde.IsNotSet = IsNotSet;
    function CStr(pInVal) {
        if (!pInVal)
            return "";
        else
            return pInVal.toString();
    }
    cde.CStr = CStr;
    function CInt(pInVal) {
        if (isNaN(pInVal) || !pInVal)
            return 0;
        let retVal = 0;
        try {
            retVal = parseInt(pInVal);
        }
        catch (ex) {
            //ignored
        }
        if (isNaN(retVal))
            return 0;
        return retVal;
    }
    cde.CInt = CInt;
    function CBool(inStr) {
        if (this.IsNotSet(inStr))
            return false;
        if (typeof (inStr) === "boolean")
            return inStr;
        switch (inStr.toString().toLowerCase()) {
            case "true":
            case "yes":
            case "1":
            case "on": return true;
            default: return false;
        }
    }
    cde.CBool = CBool;
    function CDbl(pInVal) {
        if (isNaN(pInVal) || !pInVal)
            return 0;
        let retVal = 0;
        try {
            retVal = parseFloat(pInVal);
        }
        catch (ex) {
            //ignored
        }
        if (isNaN(retVal))
            return 0;
        return retVal;
    }
    cde.CDbl = CDbl;
    function GetSubstringIndex(pInStr, pSubStr, pOccurance) {
        let times = 0;
        let index = 0;
        while (times < pOccurance && index !== -1) {
            index = pInStr.indexOf(pSubStr, index + pSubStr.length);
            times++;
        }
        return index;
    }
    cde.GetSubstringIndex = GetSubstringIndex;
    function GuidToString(InGuid) {
        if (!InGuid)
            return "";
        let OutGuid = InGuid.replace('{', '').replace('}', '');
        while (OutGuid.indexOf('-') > 0)
            OutGuid = OutGuid.replace('-', '');
        return OutGuid.toUpperCase();
    }
    cde.GuidToString = GuidToString;
    function DeleteAllCookies() {
        const cookies = document.cookie.split("; ");
        for (const element of cookies) {
            const d = window.location.hostname.split(".");
            while (d.length > 0) {
                const cookieBase = encodeURIComponent(element.split(";")[0].split("=")[0]) + '=; expires=Thu, 01-Jan-1970 00:00:01 GMT; domain=' + d.join('.') + ' ;path=';
                const p = location.pathname.split('/');
                document.cookie = cookieBase + '/';
                while (p.length > 0) {
                    document.cookie = cookieBase + p.join('/');
                    p.pop();
                }
                d.shift();
            }
        }
    }
    cde.DeleteAllCookies = DeleteAllCookies;
    cde.MyBaseAssets = new cde.TheBaseAssets();
    cde.MyContentEngine = null;
    cde.MyCommChannel = null;
    cde.MyEventLogger = new TheMetaDataBase();
})(cde || (cde = {}));
// SPDX-FileCopyrightText: 2009-2023 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
var cde;
// SPDX-FileCopyrightText: 2009-2023 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
(function (cde) {
    cde.eTheContentService = "ContentService";
    cde.IsHostRunning = false;
    //Engine Specific Settings
    class TheBaseEngine extends cde.TheThing {
        constructor() {
            super();
            this.eventOverideHeartBeat = null;
            this.EngineState = new cde.TheEngineState();
        }
        GetEngineName() {
            return this.EngineState.ClassName;
        }
        SendInitialize() {
            if (!cde.MyCommChannel)
                return;
            const tTSM = new cde.TSM(this.EngineState.ClassName);
            tTSM.TXT = "CDE_INITIALIZE";
            tTSM.PLS = this.EngineState.ClassName;
            tTSM.LVL = 3;
            cde.MyCommChannel.SendToFirstNode(tTSM);
        }
        SendSubscribe() {
            if (!cde.MyCommChannel)
                return;
            cde.MyCommChannel.Subscribe(this.EngineState.ClassName);
        }
        //Backwards compat:
        RegisterIncomingMessage(pCallback) {
            if (cde.MyCommChannel) {
                cde.MyCommChannel.RegisterEvent("CDE_INCOMING_MSG", (s, p) => { pCallback(p); });
            }
        }
        // Called when a service was found and telegrams are returned
        FireEngineIsReady(pIsReady) {
            this.EngineState.IsEngineReady = pIsReady;
            this.FireEvent(true, "EngineReady", pIsReady);
        }
        HandleMessage(pTopic, pMSG) {
            this.FireEvent(true, "IncomingMessage", new cde.TheProcessMessage(pTopic, pMSG));
        }
        PublishToNode(pTargetNode, pTXT, pPLS, pGRO) {
            if (!cde.MyCommChannel)
                return;
            if (pPLS === undefined)
                pPLS = "";
            cde.MyCommChannel.SendQueued("", "CDE_SYSTEMWIDE", this.GetEngineName(), pTXT, pPLS, 0, 5, 3, pTargetNode, pGRO);
        }
        PublishToFirstNode(pTXT, pPLS) {
            if (!cde.MyCommChannel)
                return;
            if (pPLS === undefined)
                pPLS = "";
            const tTSM = new cde.TSM(this.GetEngineName());
            tTSM.TXT = pTXT;
            tTSM.PLS = pPLS;
            cde.MyCommChannel.SendToFirstNode(tTSM);
        }
        PublishCentral(pTXT, pPLS) {
            if (!cde.MyCommChannel)
                return;
            if (pPLS === undefined)
                pPLS = "";
            cde.MyCommChannel.SendQueued("", this.GetEngineName(), this.GetEngineName(), pTXT, pPLS, 0, 5, 3, "");
        }
        PublishToService(pTXT, pPLS) {
            if (!cde.MyCommChannel)
                return;
            if (pPLS === undefined)
                pPLS = "";
            cde.MyCommChannel.SendQueued("", this.GetEngineName(), this.GetEngineName(), pTXT, pPLS, 8, 5, 3, "");
        }
        PublishToOwner(pOwner, pTXT, pPLS, pTarget, pGRO, pSender) {
            if (!cde.MyCommChannel)
                return;
            if (pPLS === undefined)
                pPLS = "";
            cde.MyCommChannel.SendQueued(pOwner, this.GetEngineName(), this.GetEngineName(), pTXT, pPLS, 8, 5, 3, pTarget, pGRO, pSender);
        }
        PublishToOriginator(pTSM, pTXT, pPLS, pSender) {
            if (!cde.MyCommChannel)
                return;
            if (pPLS === undefined)
                pPLS = "";
            cde.MyCommChannel.SendQueued(pTSM.OWN, this.GetEngineName(), this.GetEngineName(), pTXT, pPLS, 0, pTSM.QDX, pTSM.LVL, cde.TSM.GetOriginator(pTSM), pTSM.ORG, pSender);
        }
        RSAEncrypt(text, token) {
            if (cde.MyCommChannel)
                return cde.MyCommChannel.RSAEncrypt(text, token);
            else
                return text;
        }
        SaveFile(pContent, pName, pMime, IsBinary) {
            let ab;
            if (IsBinary) {
                const bString = atob(pContent);
                ab = new ArrayBuffer(bString.length);
                const ia = new Uint8Array(ab);
                for (let i = 0; i < bString.length; i++) {
                    ia[i] = bString.charCodeAt(i);
                }
            }
            else {
                ab = pContent;
            }
            const bb = new Blob([ab], { type: pMime });
            const tFS = new cde.cdeFileSaver();
            tFS.SaveAs(bb, pName);
        }
    }
    cde.TheBaseEngine = TheBaseEngine;
    function StartEngineHost() {
        if (cde.IsHostRunning)
            return false;
        cde.IsHostRunning = true;
        cde.MyContentEngine = cde.StartNewEngine(cde.eTheContentService);
        cde.MyContentEngine.RegisterEvent("IncomingMessage", (pSender, pProcessMessage) => {
            const pMSG = pProcessMessage.Message;
            if (!pMSG)
                return;
            const tCmd = pMSG.TXT.split(':');
            switch (tCmd[0]) {
                case "CDE_FILE":
                    if (tCmd.length > 2) {
                        if (pMSG.PLB) {
                            cde.MyContentEngine.SaveFile(pMSG.PLB, tCmd[1], tCmd[2], true);
                        }
                        else {
                            cde.MyContentEngine.SaveFile(pMSG.PLS, tCmd[1], tCmd[2], false);
                        }
                    }
                    break;
                case "CDE_ENGINEJS":
                    if (pMSG.PLS && tCmd.length > 1) {
                        cde.MyContentEngine.RegisterEvent("EngineReady", (a) => {
                            if (a === tCmd[1])
                                cdeNMI.MyTCF.FireLazyCreate(a);
                        });
                        if (!cde.MyBaseAssets.MyEngines[tCmd[1]]) {
                            cde.CreateScriptInRoot(tCmd[1], pMSG.PLS);
                            cde.StartNewEngine(tCmd[1]);
                            try {
                                cde.cdeEval(tCmd[1] + ".StartEngine()");
                            }
                            catch (error) {
                                cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "StartEngineHost:HandleEvent", "CDE_ENGINEJS:" + error + "<br>" + error.stack);
                            }
                        }
                    }
                    break;
                case "CDE_CUSTOM_HTML":
                    if (pMSG.PLS && tCmd.length > 1) {
                        const ele = document.getElementById('content');
                        if (ele)
                            ele.innerHTML = pMSG.PLS;
                    }
                    break;
                case "CDE_CUSTOM_CSS":
                    if (pMSG.PLS) {
                        const tCSS = pMSG.PLS.split(';');
                        cde.AddCSSToHeader(tCSS[0], tCSS.length > 1 ? tCSS[1] : null);
                    }
                    break;
                default:
                    break;
            }
        });
        if (cde.MyCommChannel) {
            cde.MyCommChannel.RegisterEvent("CDE_INCOMING_MSG", (pSender, tProgress) => {
                //if (tProgress instanceof cde.TheProcessMessage) { //Does not work with Weg Worker Messages
                if (tProgress && tProgress.Message && tProgress.Message.ENG !== '') {
                    if (cde.MyBaseAssets.MyEngines[tProgress.Message.ENG]) {
                        if (!cde.MyBaseAssets.MyEngines[tProgress.Message.ENG].EngineState.IsInitialized || cde.MyBaseAssets.MyEngines[tProgress.Message.ENG].EngineState.IsEngineScoped !== (tProgress.Message.SID !== '')) {
                            cde.MyBaseAssets.MyEngines[tProgress.Message.ENG].EngineState.IsInitialized = true;
                            cde.MyBaseAssets.MyEngines[tProgress.Message.ENG].EngineState.IsEngineScoped = tProgress.Message.SID !== '';
                            cde.MyBaseAssets.MyEngines[tProgress.Message.ENG].FireEngineIsReady();
                        }
                        try {
                            cde.MyBaseAssets.MyEngines[tProgress.Message.ENG].FireEvent(true, "IncomingMessage", tProgress);
                        }
                        catch (e) {
                            cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "error during process Message:" + e, "cdeEngines:StartEngineHost/eTheContentService");
                        }
                        this.HBCounter = 0;
                    }
                    else {
                        if (cde.MyBaseAssets.MyServiceHostInfo.DebugLevel > 0)
                            cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "Engine Not found:" + tProgress.Message.ENG + "(" + tProgress.Message.TXT + ")", "cdeEngines:StartEngineHost/eTheContentService");
                        cde.MyCommChannel.SendQueued("", cde.eTheContentService, cde.eTheContentService, "CDE_GET_ENGINEJS", tProgress.Message.ENG, 8, 5, 3, ""); //record that we asked for it already...only ask again if not received in a certain time
                    }
                }
                //}
            });
            //Comm Channel was reset - all Engine Re-Init
            cde.MyCommChannel.RegisterEvent("CDE_REINIT_ENGINES", () => {
                for (const tEngine in cde.MyBaseAssets.MyEngines)
                    if (cde.MyBaseAssets.MyEngines.hasOwnProperty(tEngine))
                        cde.MyBaseAssets.MyEngines[tEngine].SendInitialize();
            });
            //Check if any engine wants to send somethign if the queue is empty and the HB is fired
            cde.MyCommChannel.RegisterEvent("CDE_HB_INJECT", () => {
                for (const tEngine in cde.MyBaseAssets.MyEngines) {
                    if (cde.MyBaseAssets.MyEngines.hasOwnProperty(tEngine)) {
                        cde.MyBaseAssets.MyEngines[tEngine].FireEvent(false, "CDE_HB_INJECT");
                    }
                }
            });
            cde.MyCommChannel.RegisterEvent("CDE_ENGINE_GONE", (pSender, tEngine) => {
                if (cde.MyBaseAssets.MyEngines.hasOwnProperty(tEngine)) {
                    cde.MyBaseAssets.MyEngines[tEngine].EngineState.IsInitialized = false;
                    cde.MyBaseAssets.MyEngines[tEngine].FireEngineIsReady(false);
                }
            });
        }
        return true;
    }
    cde.StartEngineHost = StartEngineHost;
    function StartNewEngine(pEngineName) {
        if (!pEngineName)
            return null;
        cde.MyBaseAssets.MyEngines[pEngineName] = new cde.TheBaseEngine();
        cde.MyBaseAssets.MyEngines[pEngineName].EngineState.ClassName = pEngineName;
        cde.MyBaseAssets.MyEngines[pEngineName].EngineState.IsInitialized = false;
        cde.MyBaseAssets.MyEngines[pEngineName].EngineState.IsEngineScoped = false;
        cde.MyBaseAssets.MyEngines[pEngineName].SendInitialize();
        return cde.MyBaseAssets.MyEngines[pEngineName];
    }
    cde.StartNewEngine = StartNewEngine;
    function AddCSSToHeader(pCSSFile, pCSSFileLite) {
        let tFileCSS = cde.FixupPath(pCSSFile); //.toLowerCase();
        if (cde.MyBaseAssets.MyServiceHostInfo.IsLiteTheme && pCSSFileLite)
            tFileCSS = cde.FixupPath(pCSSFileLite); //.toLowerCase();
        const links = document.getElementsByTagName("link");
        if (links.length > 0) {
            for (const element of links) {
                if (element.getAttribute("href").toLowerCase() === tFileCSS.toLowerCase())
                    return;
            }
        }
        const fileref = document.createElement("link");
        fileref.setAttribute("rel", "stylesheet");
        fileref.setAttribute("type", "text/css");
        fileref.setAttribute("cde", "colorScheme");
        fileref.setAttribute("media", "screen");
        fileref.setAttribute("dark", cde.FixupPath(pCSSFile));
        if (pCSSFileLite)
            fileref.setAttribute("lite", cde.FixupPath(pCSSFileLite));
        fileref.setAttribute("cde", "colorScheme");
        fileref.setAttribute("href", tFileCSS + cdeNMI.GenerateFinalString("<%ISID%>"));
        document.getElementsByTagName("head")[0].appendChild(fileref);
    }
    cde.AddCSSToHeader = AddCSSToHeader;
    function CreateScriptInRoot(pScriptName, pScript) {
        const tRoot = document.getElementsByTagName("head")[0]; //'document.getElementById("head");
        if (!tRoot)
            return;
        cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "CreateScriptInRoot", "Creating " + pScriptName + " in doc header");
        const tScripEle = tRoot.getElementsByTagName("script");
        let DoInsert = true;
        if (tScripEle.length > 0) {
            for (const element of tScripEle) {
                if (element.id === pScriptName) {
                    DoInsert = false;
                    break;
                }
            }
        }
        if (DoInsert) {
            const s = document.createElement('script');
            s.type = "text/javascript";
            s.text = pScript;
            s.id = pScriptName;
            tRoot.appendChild(s);
        }
    }
    cde.CreateScriptInRoot = CreateScriptInRoot;
})(cde || (cde = {}));
var cdeCommCore;
(function (cdeCommCore) {
    function StartNewEngine(pEngine) {
        return cde.StartNewEngine(pEngine);
    }
    cdeCommCore.StartNewEngine = StartNewEngine;
    function PublishToOriginator(pOrg, pEngineName, pGRO, pTXT, pPLS, pSender) {
        if (!cde.MyCommChannel)
            return;
        if (pPLS === undefined)
            pPLS = "";
        cde.MyCommChannel.SendQueued("", "CDE_SYSTEMWIDE", pEngineName, pTXT, pPLS, 0, 5, 3, pOrg, pGRO, pSender);
    }
    cdeCommCore.PublishToOriginator = PublishToOriginator;
    function PublishToNode(pTargetNode, pEngineName, pTXT, pPLS) {
        if (!cde.MyCommChannel)
            return;
        if (pPLS === undefined)
            pPLS = "";
        cde.MyCommChannel.SendQueued("", "CDE_SYSTEMWIDE", pEngineName, pTXT, pPLS, 0, 5, 3, pTargetNode);
    }
    cdeCommCore.PublishToNode = PublishToNode;
    function RegisterTopic(InitString) {
        cdeCommCore.PublishToFirstNode("ContentService", "CDE_SUBSCRIBE", InitString);
    }
    cdeCommCore.RegisterTopic = RegisterTopic;
    //Legacy Support please use functions below
    function GetNextMessage(pOwner, pTopic, pEngineName, pTXT, pPLS, pFLG, pQDX, pLVL, pTarget, pGro, pSender) {
        if (!cde.MyCommChannel)
            return;
        if (pPLS === undefined)
            pPLS = "";
        cde.MyCommChannel.SendQueued(pOwner, pTopic, pEngineName, pTXT, pPLS, pFLG, pQDX, pLVL, pTarget, pGro, pSender);
    }
    cdeCommCore.GetNextMessage = GetNextMessage;
    function PublishToFirstNode(pEngineName, pTXT, pPLS) {
        if (!cde.MyCommChannel)
            return;
        if (pPLS === undefined)
            pPLS = "";
        const tTSM = new cde.TSM(pEngineName);
        tTSM.TXT = pTXT;
        tTSM.PLS = pPLS;
        cde.MyCommChannel.SendToFirstNode(tTSM);
    }
    cdeCommCore.PublishToFirstNode = PublishToFirstNode;
    function PublishTSMToFirstNode(pTSM) {
        if (!cde.MyCommChannel)
            return;
        cde.MyCommChannel.SendToFirstNode(pTSM);
    }
    cdeCommCore.PublishTSMToFirstNode = PublishTSMToFirstNode;
    function PublishToOwner(pOwner, pEngineName, pTXT, pPLS, pTarget, pGro, pSender) {
        if (!cde.MyCommChannel)
            return;
        if (pPLS === undefined)
            pPLS = "";
        cde.MyCommChannel.SendQueued(pOwner, pEngineName, pEngineName, pTXT, pPLS, 8, 5, 3, pTarget, pGro, pSender);
    }
    cdeCommCore.PublishToOwner = PublishToOwner;
    ///Used by Convenience Apps
    function PublishToService(pEngineName, pTXT, pPLS) {
        if (!cde.MyCommChannel)
            return;
        if (pPLS === undefined)
            pPLS = "";
        cde.MyCommChannel.SendQueued("", pEngineName, pEngineName, pTXT, pPLS, 8, 5, 3, "");
    }
    cdeCommCore.PublishToService = PublishToService;
    function PublishTSMToService(pTSM) {
        if (!cde.MyCommChannel)
            return;
        cde.MyCommChannel.SendTSM(pTSM);
    }
    cdeCommCore.PublishTSMToService = PublishTSMToService;
    function PublishCentral(pEngineName, pTXT, pPLS) {
        if (!cde.MyCommChannel)
            return;
        if (pPLS === undefined)
            pPLS = "";
        cde.MyCommChannel.SendQueued("", pEngineName, pEngineName, pTXT, pPLS, 0, 5, 3, "");
    }
    cdeCommCore.PublishCentral = PublishCentral;
    function PublishTSMCentral(pTSM) {
        if (!cde.MyCommChannel)
            return;
        cde.MyCommChannel.SendQueued(pTSM.OWN, pTSM.ENG, pTSM.ENG, pTSM.TXT, pTSM.PLS, pTSM.FLG, pTSM.QDX, pTSM.LVL, "");
    }
    cdeCommCore.PublishTSMCentral = PublishTSMCentral;
    ///Used by Convenience Apps
    function IsNotReadyForLogin() {
        return (!cde.MyCommChannel || !cde.MyCommChannel.IsReady).toString();
    }
    cdeCommCore.IsNotReadyForLogin = IsNotReadyForLogin;
    ///Used by Convenience Apps
    function DoAppLogin(pUID, pPWD, pPlatform) {
        cde.MyBaseAssets.MyServiceHostInfo.IsAppHosted = true;
        if (cdeNMI.MyEngine) {
            cdeNMI.MyEngine.Login(null, pUID, pPWD, pPlatform);
        }
    }
    cdeCommCore.DoAppLogin = DoAppLogin;
    function CleanState() {
        cdeNMI.CleanState();
    }
    cdeCommCore.CleanState = CleanState;
})(cdeCommCore || (cdeCommCore = {}));
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
var cdeWEB;
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
(function (cdeWEB) {
    class cdeWebComm extends cde.TheThing {
        constructor() {
            super();
            this.MyConfig = null;
            this.DCreds = null;
            this.MyStationID = ""; //Global Safe (worker use only)
            this.IsPosting = false;
            this.IsRetrying = false;
            this.MyWebSockets = null;
            this.MyServiceUrl = "";
            this.UsesWebSockets = false;
            this.mLoginSent = false;
            this.HasStarted = false;
            this.HealthCounter = 0;
            this.HBCounter = 0;
            this.DeadCounter = 0;
            this.MyCoreQueue = new Array();
            this.Pre4209SID = null;
            this.IsWSConnected = false;
            this.IsConnectionDown = false;
            this.TriesTokenLogin = false;
            this.ForceDisconnect = false;
        }
        get MyHSI() {
            return cde.MyBaseAssets.MyCommStatus;
        }
        get IsConnected() { return this.ForceDisconnect === true ? false : this.MyHSI.IsConnected; }
        set IsConnected(value) {
            if (this.MyHSI.IsConnected !== value) {
                this.MyHSI.IsConnected = value;
                this.UpdateHSI();
                this.FireEvent(true, "CDE_CONN_CHANGED", value);
            }
        }
        UpdateHSI() {
            this.MyHSI.HasAutoLogin = this.HasAutoLogin;
            this.WriteToIDB();
        }
        UpdateCallerHSI(pSource) {
            this.UpdateHSI();
            cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "UpdateHSI", pSource, 1);
        }
        get IsReady() { return this.MyHSI.CurrentRSA !== null; }
        get HasAutoLogin() { return (this.MyConfig && this.MyConfig.Creds !== null); }
        SetTargetRelay(pTarget) {
            let tParts;
            try {
                tParts = pTarget.split(';:;');
                let t = null;
                if (!cde.IsIE()) {
                    t = new URL(tParts[0]);
                }
                else {
                    t = document.createElement("a");
                    t.href = tParts[0];
                }
                let tConf = this.MyConfig;
                if (tConf === null)
                    tConf = new cde.TheCommConfig(0);
                tConf.host = t.hostname;
                tConf.cdeTIM = new Date();
                tConf.port = cde.CInt(t.port);
                if (t.protocol.indexOf("s:", t.protocol.length - 2) !== -1) {
                    tConf.useTLS = true;
                    if (tConf.port === 0)
                        tConf.port = 443;
                }
                else {
                    if (tConf.port === 0)
                        tConf.port = 80;
                }
                if (tParts.length > 1) {
                    tConf.Creds = new cde.TheCDECredentials();
                    tConf.Creds.QUID = tParts[1];
                    if (tParts.length > 2)
                        tConf.Creds.QPWD = tParts[2];
                }
                this.SetConfig(tConf);
                return true;
            }
            catch (ex) {
                const tErr = tParts[0] + " is not a valid Url";
                cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "cdeWebComm:SetTargetRelay", tErr, 2);
                this.FireEvent(true, "CDE_SETSTATUSMSG", tErr, 2);
            }
            return false;
        }
        SetConfig(pConfig) {
            this.MyConfig = pConfig;
            if (!this.MyConfig)
                return;
            if (this.MyConfig.RequestPath && !this.MyHSI.InitialNPA)
                this.MyHSI.InitialNPA = this.MyConfig.RequestPath;
            if (!this.MyConfig.cdeTIM)
                this.MyConfig.cdeTIM = new Date();
            if (!this.MyConfig.TO)
                this.MyConfig.TO = new cde.TheTimeouts();
            if (!this.MyConfig.host && this.MyConfig.uri) {
                this.SetTargetRelay(this.MyConfig.uri);
            }
        }
        StartCommunication(pConfig) {
            if (this.IsConnected || this.HasStarted) //don't start twice
             {
                if (this.IsConnected && this.HasStarted)
                    this.FireEvent(true, "CDE_CONN_CHANGED", true);
                return;
            }
            this.IsConnectionDown = false;
            if (!this.MyDB) {
                if (!('indexedDB' in window)) {
                    this.StartCommPhase2(pConfig);
                    return;
                }
                const req = indexedDB.open('cdeDB', 1);
                req.onupgradeneeded = (ev) => {
                    cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "IndexedDB:message", "In Upgrade Needed", 1);
                    this.MyDB = ev.target.result;
                    if (!this.MyDB.objectStoreNames.contains('CDEJS')) {
                        this.MyDB.createObjectStore('CDEJS', { keyPath: 'id' });
                    }
                    this.StartCommPhase2(pConfig);
                };
                req.onsuccess = (ev) => {
                    cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "IndexedDB:message", "Open Success", 1);
                    this.MyDB = ev.target.result;
                    const transaction = this.MyDB.transaction(['CDEJS']);
                    const objectStore = transaction.objectStore('CDEJS');
                    const request = objectStore.get(1);
                    request.onerror = () => {
                        cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "IndexedDB:message", "Read of Idx1 failed", 3);
                        this.StartCommPhase2(pConfig);
                    };
                    request.onsuccess = () => {
                        cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "IndexedDB:message", "Read Success", 1);
                        if (request.result) {
                            const tConfig = request.result.config;
                            if (tConfig.Creds && tConfig.Creds.QToken && tConfig.Creds.QToken !== "") { //If state is younger than 1minute - use it
                                if (pConfig && pConfig.RequestPath) {
                                    tConfig.RequestPath = pConfig.RequestPath;
                                    if (!this.MyHSI.InitialNPA)
                                        this.MyHSI.InitialNPA = pConfig.RequestPath;
                                }
                                if (pConfig && (pConfig.uri != tConfig.uri || pConfig.wsuri != tConfig.wsuri || pConfig.host != tConfig.host)) {
                                    this.FireEvent(true, "CDE_NEW_LOGENTRY", "IndexedDB:message", 'State ignored - host has changed', 1);
                                    this.DeleteFromIDB();
                                }
                                else {
                                    pConfig = tConfig;
                                    this.FireEvent(true, "CDE_NEW_LOGENTRY", "IndexedDB:message", 'State Restored', 1);
                                }
                            }
                            else {
                                this.FireEvent(true, "CDE_NEW_LOGENTRY", "IndexedDB:message", 'State ignored', 1);
                                this.DeleteFromIDB();
                            }
                            cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "IndexedDB:message", "Starting CommPhase2...", 1);
                            this.StartCommPhase2(pConfig);
                        }
                        else {
                            cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "IndexedDB:message", 'No data record', 2);
                            this.StartCommPhase2(pConfig);
                        }
                    };
                };
                req.onerror = (ev) => {
                    cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "IndexedDB:error", "Error:" + ev, 3);
                    this.StartCommPhase2(pConfig);
                };
            }
            else
                this.StartCommPhase2(pConfig);
        }
        StartCommPhase2(pConfig) {
            if (pConfig) {
                this.SetConfig(pConfig);
            }
            if (this.MyConfig) {
                if (cde.CBool(this.MyConfig.NoISB) === false) {
                    this.HasStarted = true;
                    let tScheme = "http";
                    if (this.MyConfig.useTLS === true)
                        tScheme += "s";
                    this.MyHSI.MyServiceUrl = `${tScheme}://${this.MyConfig.host}:${this.MyConfig.port}`;
                    const isbEndpoint = `${this.MyHSI.MyServiceUrl}/MYISBCONNECT`;
                    this.GetJSON(isbEndpoint, (isb) => {
                        if (isb.ERR) {
                            cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "cdeWebComm:StartCommunication", "MyISBConnect returned: " + isb.ERR, 3);
                            this.FireEvent(true, "CDE_NO_CONNECT", "ISBConnect returned " + isb.ERR + ". Verify ISBConnect is allow on relay");
                        }
                        else {
                            if (isb.WSP > 0) {
                                let tscheme = "ws";
                                if (isb.TLS === true)
                                    tscheme += "s";
                                this.MyConfig.wsuri = `${tscheme}://${this.MyConfig.host}:${isb.WSP}`;
                            }
                            {
                                let tscheme = "http";
                                if (isb.TLS === true)
                                    tscheme += "s";
                                this.MyServiceUrl = `${tscheme}://${this.MyConfig.host}:${this.MyConfig.port}`;
                            }
                            this.MyConfig.RequestPath = isb.NPA;
                            this.MyHSI.InitialNPA = isb.NPA;
                            this.MyHSI.FirstNodeID = isb.FNI;
                            if (isb.ADR) {
                                this.MyHSI.AdminPWMustBeSet = true;
                                this.MyHSI.AdminRole = isb.ADR;
                            }
                            if (cde.CDbl(isb.VER) > 4)
                                cde.MyBaseAssets.MyServiceHostInfo.NMIVersion = cde.CDbl(isb.VER);
                            else
                                cde.MyBaseAssets.MyServiceHostInfo.NMIVersion = 4.0;
                            this.DoStartComm();
                        }
                    }, (error) => {
                        cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "cdeWebComm:StartCommunication", "MyISBConnect failed! :" + error, 3);
                        this.FireEvent(true, "CDE_NO_CONNECT", "ISBConnect failed. Verify ISBConnect is allow on relay");
                    });
                }
            }
            if (!this.HasStarted) {
                this.HasStarted = true;
                this.DoStartComm();
            }
        }
        DoStartComm() {
            let IsStillWorking = false;
            if (!this.MyConfig.TO) {
                this.MyConfig.TO = new cde.TheTimeouts();
            }
            this.StartupWS();
            this.MyHeartBeatMonitor = setInterval(() => {
                if (IsStillWorking || this.IsConnectionDown)
                    return;
                IsStillWorking = true;
                this.HealthCounter++;
                if ((!this.UsesWebSockets || !this.MyConfig.IsWSHBDisabled) && this.HealthCounter % this.MyConfig.TO.HeartBeat === 0) {
                    if (this.MyCoreQueue.length === 0) {
                        this.PickupNextMessage();
                    }
                    if (!this.UsesWebSockets) {
                        if (this.IsConnected) {
                            if (this.HBCounter++ > this.MyConfig.TO.HeartBeatMissed) {
                                this.IsConnected = false;
                                this.IsPosting = false;
                                this.HBCounter = 0;
                            }
                        }
                        else {
                            if (this.DeadCounter++ > this.MyConfig.TO.HeartBeatMissed * 3) {
                                const reason = cde.DateToString(new Date()) + ": Connection Lost because Service is down or unreachable. Click ok to reload this page";
                                cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "cdeNode:StartCommunication", reason, 3);
                                this.EndSession(reason);
                            }
                        }
                    }
                }
                if (this.UsesWebSockets || ((this.HealthCounter % this.MyConfig.TO.PickupRateDelay) === 0 || this.MyCoreQueue.length > 0))
                    this.SendNextMessage(null);
                IsStillWorking = false;
            }, this.MyConfig.TO.PickupRate);
            this.FireEvent(true, "CDE_COMM_STARTED");
        }
        GetConnectionType() {
            let tConnType = "(REST)";
            if (this.UsesWebSockets)
                tConnType = "(WS)";
            return tConnType;
        }
        PickupNextMessage() {
            const tDevMsg = new cde.TheDeviceMessage();
            tDevMsg.TOP = "";
            tDevMsg.MSG = null;
            this.MyCoreQueue.push(tDevMsg);
        }
        SendQueued(pOwner, pTopic, pEngineName, pTXT, pPLS, pFLG, pQDX, pLVL, pTarget, pGRO, pSender) {
            if (!pEngineName)
                return;
            if (this.MyCoreQueue.length > 0 && (pTopic === "CDE_PICKUP" || !pTopic))
                return;
            const tTSM = new cde.TSM(pEngineName);
            if (pTarget && pTarget !== "") {
                pTopic = "CDE_SYSTEMWIDE";
                if (this.Pre4209SID && this.Pre4209SID !== "")
                    pTopic += "@" + this.Pre4209SID;
                pTopic += ";" + pTarget;
            }
            else if (pTopic !== "") {
                if (this.Pre4209SID && this.Pre4209SID !== "")
                    pTopic += "@" + this.Pre4209SID;
            }
            tTSM.SID = this.Pre4209SID;
            tTSM.OWN = pOwner;
            tTSM.FLG = pFLG;
            tTSM.LVL = pLVL;
            tTSM.TXT = pTXT;
            if (pGRO)
                tTSM.GRO = pGRO;
            if ((pFLG & 4096) !== 0) {
                tTSM.PLS = this.RSAEncrypt(pPLS); //ATTENTION: PLS Can exceed encryptable size of token!
            }
            else
                tTSM.PLS = pPLS;
            tTSM.QDX = pQDX;
            tTSM.ORG = cde.MyBaseAssets.MyServiceHostInfo.MyStationID + (pSender ? ":" + pSender : "");
            const tDevMsg = new cde.TheDeviceMessage();
            tDevMsg.TOP = pTopic;
            tDevMsg.MSG = tTSM;
            this.MyCoreQueue.push(tDevMsg);
        }
        SendTSM(tTSM, pTopic, pTarget, pSender) {
            if (this.MyCoreQueue.length > 0 && pTopic === "CDE_PICKUP")
                return;
            if (pTarget && pTarget !== "") {
                pTopic = "CDE_SYSTEMWIDE";
                if (this.Pre4209SID && this.Pre4209SID !== "")
                    pTopic += "@" + this.Pre4209SID;
                pTopic += ";" + pTarget;
            }
            else if (pTopic !== "") {
                if (this.Pre4209SID && this.Pre4209SID !== "")
                    pTopic += "@" + this.Pre4209SID;
            }
            tTSM.SID = this.Pre4209SID;
            if ((tTSM.FLG & 4096) !== 0) {
                tTSM.PLS = this.RSAEncrypt(tTSM.PLS); //ATTENTION: PLS Can exceed encryptable size of token!
            }
            tTSM.ORG = cde.MyBaseAssets.MyServiceHostInfo.MyStationID + (pSender ? ":" + pSender : "");
            const tDevMsg = new cde.TheDeviceMessage();
            tDevMsg.TOP = pTopic ? pTopic : tTSM.ENG;
            tDevMsg.MSG = tTSM;
            this.MyCoreQueue.push(tDevMsg);
        }
        Subscribe(pTopics) {
            const tTSM = new cde.TSM("ContentService");
            tTSM.TXT = "CDE_SUBSCRIBE";
            tTSM.PLS = pTopics;
            if (this.Pre4209SID && this.Pre4209SID !== "")
                tTSM.PLS += "@" + this.Pre4209SID;
            this.SendToFirstNode(tTSM);
        }
        Unsubscribe(pTopics) {
            const tTSM = new cde.TSM("ContentService");
            tTSM.TXT = "CDE_UNSUBSCRIBE";
            tTSM.PLS = pTopics;
            if (this.Pre4209SID && this.Pre4209SID !== "")
                tTSM.PLS += "@" + this.Pre4209SID;
            this.SendToFirstNode(tTSM);
        }
        SendToNode(tOrg, TargetMessage, IncludeLocalNode) {
            this.SendTSM(TargetMessage, null, tOrg);
            if (IncludeLocalNode)
                this.FireEvent(true, "CDE_INCOMING_MSG", new cde.TheProcessMessage(TargetMessage.ENG, TargetMessage));
        }
        SendToOriginator(sourceMessage, TargetMessage, IncludeLocalNode) {
            if (!sourceMessage)
                return;
            this.SendTSM(TargetMessage, null, sourceMessage.ORG);
            if (IncludeLocalNode)
                this.FireEvent(true, "CDE_INCOMING_MSG", new cde.TheProcessMessage(TargetMessage.ENG, TargetMessage));
        }
        SendToFirstNode(TargetMessage) {
            this.SendTSM(TargetMessage, null, this.MyHSI.FirstNodeID);
        }
        Logout() {
            this.EndSession("logout");
        }
        EndSession(reason) {
            if (cde.CBool(this.IsConnectionDown))
                return;
            clearInterval(this.MyHeartBeatMonitor);
            this.HasStarted = false;
            this.IsConnectionDown = true;
            this.IsConnected = false;
            this.IsRetrying = false;
            this.DeleteFromIDB();
            this.FireEvent(true, "CDE_SESSION_ENDED", reason);
        }
        PostError(MyQueuedMsg, errorText, pRetryPath) {
            this.IsPosting = false;
            if (!this.IsRetrying && errorText === "timeout") {
                this.IsRetrying = true;
                this.SendNextMessage(MyQueuedMsg, pRetryPath);
            }
            else {
                if (MyQueuedMsg.ENG !== "") {
                    this.FireEvent(true, "CDE_ENGINE_GONE", MyQueuedMsg.ENG);
                }
                const tErr = cde.DateToString(new Date()) + " Communication was lost.You will need to login again";
                this.FireEvent(true, "CDE_SETSTATUSMSG", tErr, 3);
                cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "PostError", tErr);
                this.EndSession(tErr);
            }
        }
        ///Picks up any REST based Messages
        SendNextMessage(MyQueuedMsg, pRetryPath) {
            if (!MyQueuedMsg && (this.IsPosting || this.MyCoreQueue.length === 0))
                return;
            if (!this.UsesWebSockets && (!this.MyConfig.RequestPath || this.MyConfig.RequestPath === "") && !pRetryPath)
                return;
            if (this.UsesWebSockets && this.IsWSConnected === false)
                return;
            do {
                this.IsPosting = true;
                let uri;
                if (!MyQueuedMsg) {
                    let telCnt = 0;
                    const tDevList = [];
                    do {
                        tDevList[telCnt] = this.MyCoreQueue.shift();
                        telCnt++;
                    } while (this.MyCoreQueue.length > 0 && telCnt < 10);
                    MyQueuedMsg = new cde.TheCoreQueueContent("", "", tDevList);
                    const tRPath = (pRetryPath ? pRetryPath : this.MyConfig.RequestPath);
                    uri = this.MyServiceUrl + encodeURI(tRPath);
                    if (this.UsesWebSockets === false && uri.substr(uri.length - 5, 5) === ".ashx")
                        uri = uri.substr(0, uri.length - 5);
                    if (MyQueuedMsg.TOPIC !== "")
                        uri += "?" + encodeURI(MyQueuedMsg.TOPIC);
                    MyQueuedMsg.RQP = uri;
                    pRetryPath = this.MyConfig.RequestPath;
                    this.MyConfig.RequestPath = "";
                }
                else {
                    uri = MyQueuedMsg.RQP;
                }
                this.WriteToIDB();
                if (this.UsesWebSockets) {
                    this.MyWebSockets.send(MyQueuedMsg.JMSG);
                    this.IsPosting = false;
                    MyQueuedMsg = null;
                }
                else {
                    if (window.fetch) {
                        fetch(uri, {
                            method: "post",
                            body: MyQueuedMsg.JMSG,
                            mode: "cors",
                            cache: "no-cache",
                            redirect: "follow",
                            referrer: "no-referrer",
                            headers: {
                                "Content-Type": "application/json; charset=utf-8"
                            }
                        }).then((resp) => {
                            resp.json().then((m) => {
                                const tMsg = m;
                                this.IsPosting = false;
                                let IsPulsing = false;
                                if (tMsg.length > 0)
                                    for (const element of tMsg) {
                                        if (element.CNT > 0)
                                            IsPulsing = true;
                                        this.IsPosting = !this.ProcessDeviceMessage(element, false);
                                    }
                                if (IsPulsing)
                                    this.SendNextMessage(null);
                            });
                        }).catch((error) => {
                            this.PostError(MyQueuedMsg, error, pRetryPath);
                        });
                    }
                    else {
                        const xhr = new XMLHttpRequest();
                        xhr.open('POST', uri);
                        xhr.setRequestHeader('Content-Type', 'application/json');
                        xhr.onload = () => {
                            if (xhr.status === 200) {
                                try {
                                    const tMsg = JSON.parse(xhr.responseText);
                                    this.IsPosting = false;
                                    let IsPulsing = false;
                                    if (tMsg.length > 0)
                                        for (const element of tMsg) {
                                            if (element.CNT > 0)
                                                IsPulsing = true;
                                            this.IsPosting = !this.ProcessDeviceMessage(element, false);
                                        }
                                    if (IsPulsing)
                                        this.SendNextMessage(null);
                                }
                                catch (tErr) {
                                    cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "cdeWebComm:SendNextMessage", "Message Parse Error:" + tErr);
                                    this.PostError(MyQueuedMsg, "parse failed", pRetryPath);
                                }
                            }
                            else if (xhr.status !== 200) {
                                const tStat = "Message returned: " + xhr.status + " msg:" + xhr.statusText;
                                cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "cdeWebComm:SendNextMessage", tStat);
                                this.PostError(MyQueuedMsg, tStat, pRetryPath);
                            }
                        };
                        xhr.onerror = () => {
                            const tStat = "Message returned: " + xhr.status + " msg:" + xhr.statusText;
                            cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "cdeWebComm:xhrError", tStat);
                            this.EndSession(tStat);
                        };
                        xhr.send(MyQueuedMsg.JMSG);
                    }
                    break;
                }
            } while (this.MyCoreQueue.length > 0);
        }
        ///Starts up the WebSocket Communication
        StartupWS() {
            if (!this.MyConfig.wsuri)
                return false;
            let tUri = this.MyConfig.wsuri;
            if (tUri.indexOf(".ashx") < 0)
                tUri += encodeURI(this.MyConfig.RequestPath);
            try {
                this.MyWebSockets = new WebSocket(tUri);
                if (this.MyConfig.TO.WsTimeOut > 0) {
                    setInterval(() => {
                        if (!this.IsWSConnected && this.UsesWebSockets)
                            this.UsesWebSockets = false;
                    }, this.MyConfig.TO.WsTimeOut);
                }
            }
            catch (e) {
                this.MyWebSockets = null;
                return false;
            }
            if (this.MyWebSockets) {
                this.UsesWebSockets = true;
                this.MyWebSockets.onopen = () => {
                    this.FireEvent(true, "CDE_SETSTATUSMSG", "Connecting to WS...", 2);
                    this.MyWebSockets.send("[{\"MET\":0,\"TOP\":\"CDE_INITWS\",\"CNT\":0}]");
                };
                this.MyWebSockets.onmessage = (args) => {
                    if (!this.UsesWebSockets)
                        return;
                    this.IsWSConnected = true;
                    try {
                        if (args.data.substring(0, 1) !== '[') {
                            cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "cdeWebComm:OnMessage", "Strange Response from WServer:" + args.data);
                        }
                        else {
                            let bIsLarge = false;
                            if (args.data.length > 500000) {
                                cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "cdeWebComm:OnMessage", "Very large Telegram received:" + args.data.length);
                                bIsLarge = true;
                            }
                            const tMsg = JSON.parse(args.data);
                            if (tMsg && tMsg.length > 0) {
                                for (const element of tMsg) {
                                    if (!element.MSG && element.TOP !== "") {
                                        cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "StartUpWS:onMessage", element.TOP);
                                        return;
                                    }
                                    else {
                                        const tTops = element.TOP.split(";:;");
                                        if (tTops[0] === "CDE_CONNECT" && this.MyConfig && this.MyConfig.Creds) {
                                            this.MyHSI.CurrentRSA = element.RSA;
                                            this.Login(this.MyConfig.Creds);
                                            continue;
                                        }
                                    }
                                    if (bIsLarge)
                                        cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "cdeWebComm:OnMessage", "ORG:" + cde.TSM.GetOriginator(element.MSG) + "TXT: " + element.MSG.TXT);
                                    this.ProcessDeviceMessage(element, true);
                                }
                            }
                            else {
                                //debugger
                            }
                        }
                    }
                    catch (e) {
                        cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "cdeWebComm:StartWS", "Error during OnMessage:" + e);
                    }
                };
                this.MyWebSockets.onclose = () => {
                    if (this.UsesWebSockets) {
                        this.UsesWebSockets = false;
                        if (this.IsWSConnected) {
                            const tErr = cde.DateToString(new Date()) + (this.mLoginSent ? " Relay refused login and closed connection" : " WS Communication was closed. You will need to login again");
                            this.FireEvent(true, "CDE_SETSTATUSMSG", tErr, 3);
                            cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "StartUpWS:onclose", tErr);
                            this.EndSession(tErr);
                        }
                        else {
                            const tErr = cde.DateToString(new Date()) + (this.mLoginSent ? " a connection could not be established" : " WS Communication was closed. You will need to login again");
                            this.FireEvent(true, "CDE_SETSTATUSMSG", tErr, 3);
                            cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "StartUpWS:onclose", tErr);
                            this.EndSession(tErr);
                        }
                    }
                };
                this.MyWebSockets.onerror = (args) => {
                    cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "cdeWebComm:onError", "Error during OnMessage:" + args);
                    if (this.UsesWebSockets) {
                        this.UsesWebSockets = false;
                        if (this.IsWSConnected) {
                            const tErr = cde.DateToString(new Date()) + " WS Communication was interrupted. You will need to login again";
                            this.FireEvent(true, "CDE_SETSTATUSMSG", tErr, 3);
                            cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "StartUpWS:onerror", tErr);
                            this.EndSession(tErr);
                        }
                    }
                };
                return true;
            }
            return false;
        }
        ProcessDeviceMessage(tMsg, ViaWS) {
            if (tMsg.MSG)
                this.FireEvent(true, "CDE_INCOMING_MSG", new cde.TheProcessMessage(tMsg.TOP.split(":,:")[0], tMsg.MSG));
            if (ViaWS || tMsg.NPA) {
                let IsHSIDirty = false;
                this.MyConfig.RequestPath = tMsg.NPA;
                if (!this.MyHSI.InitialNPA)
                    this.MyHSI.InitialNPA = tMsg.NPA;
                if (tMsg.RSA && tMsg.RSA !== "" && !this.MyHSI.CurrentRSA) {
                    this.MyHSI.CurrentRSA = tMsg.RSA;
                    if (!this.MyHSI.FirstNodeID && tMsg.MSG) {
                        this.MyHSI.FirstNodeID = cde.TSM.GetOriginator(tMsg.MSG);
                        IsHSIDirty = true;
                    }
                    if (this.DCreds) {
                        this.Login(this.DCreds);
                        this.DCreds = null;
                    }
                }
                this.DeadCounter = 0;
                if (tMsg.DID && tMsg.DID !== "" && this.MyStationID !== tMsg.DID) {
                    this.MyStationID = tMsg.DID;
                    IsHSIDirty = true;
                }
                let tIsConnected = this.IsConnected;
                let tJustLoggedIn = false;
                if (tMsg.TOP === 'ERR:CDE_LOGIN_FAILURE') {
                    //debugger
                    this.MyHSI.UserPref = null;
                    this.mLoginSent = false;
                    this.MyConfig.Creds = null;
                    this.FireEvent(true, "CDE_LOGIN_EVENT", false, "Relay rejected credentials", null);
                    tJustLoggedIn = true;
                    IsHSIDirty = true;
                    this.EndSession("Relay rejected credentials - Login failed");
                }
                else if (tMsg.TOP === 'ERR:CDE_MESHSELECT_FAILURE') {
                    this.MyHSI.UserPref = null;
                    this.mLoginSent = false;
                    this.MyConfig.Creds = null;
                    this.FireEvent(true, "CDE_LOGIN_EVENT", false, "Mesh Picker failed", null);
                    tJustLoggedIn = true;
                    IsHSIDirty = true;
                    this.EndSession("Mesh Selection failed, please reload this page");
                }
                else if (tMsg.TOP.length > 12) {
                    const tLogParts = tMsg.TOP.split(':');
                    if (!this.MyHSI.IsUserLoggedIn) {
                        if (tLogParts[0] === 'LOGIN_SUCCESS') {
                            this.MyHSI.UserPref = new cde.TheUserPreferences();
                            let tScrParts = null;
                            if (tLogParts.length > 1) {
                                tScrParts = tLogParts[1].split(';');
                                if (tScrParts.length > 1) {
                                    this.MyHSI.LastPortalScreen = tScrParts[1];
                                    if (tScrParts.length > 2)
                                        this.MyHSI.UserPref.HideHeader = cde.CBool(tScrParts[2]);
                                }
                                if (!cde.IsNotSet(tScrParts[0])) {
                                    this.MyHSI.LastStartScreen = tScrParts[0];
                                }
                                if (tLogParts.length > 2) {
                                    this.MyHSI.UserPref.CurrentUserName = tLogParts[2];
                                    if (tLogParts.length > 3) {
                                        try {
                                            const pos = cde.GetSubstringIndex(tMsg.TOP, ':', 3);
                                            const tres = tMsg.TOP.substring(pos + 1);
                                            if (tres.length > 2 && tres.substring(0, 1) === "{")
                                                this.MyHSI.UserPref = JSON.parse(tres);
                                            else
                                                this.MyHSI.UserPref.LCID = cde.CInt(tres); //OLD NMIs
                                        }
                                        catch (ee) {
                                            cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "Login:Illegal User Preferences received");
                                        }
                                    }
                                }
                            }
                            if (this.MyConfig["LPS"]) {
                                this.MyHSI.LastPortalScreen = this.MyConfig["LPS"];
                            }
                            if (this.MyConfig["LSSC"]) {
                                this.MyHSI.LastStartScreen = this.MyConfig["LSSC"];
                            }
                            this.MyHSI.UserPref.ScreenParts = tScrParts;
                            this.Pre4209SID = tMsg.SID; //For FirstNodes pre 4.209
                            if (tMsg.SID && tMsg.SID.substring(0, 2) === "UT") {
                                this.Pre4209SID = null;
                                this.MyConfig.Creds = new cde.TheCDECredentials();
                                this.MyConfig.Creds.QToken = tMsg.SID;
                            }
                            this.FireEvent(true, "CDE_LOGIN_EVENT", true, "Login Successful!", this.MyHSI.UserPref);
                            tJustLoggedIn = true;
                            IsHSIDirty = true;
                            this.mLoginSent = false;
                        }
                        else if (tLogParts[0] === 'SELECT_MESH') {
                            const tMeshPicker = tMsg.TOP.substring('SELECT_MESH:'.length);
                            const tMeshes = JSON.parse(tMeshPicker);
                            this.FireEvent(true, "CDE_SELECT_MESH", tMeshes);
                        }
                    }
                }
                if (!ViaWS && tMsg.CNT > 0 && this.MyCoreQueue.length === 0)
                    this.PickupNextMessage();
                tIsConnected = true;
                if (tIsConnected !== this.IsConnected) {
                    if (tIsConnected && !tJustLoggedIn) {
                        this.FireEvent(true, "CDE_SETSTATUSMSG", "Connected to " + this.MyHSI.MyServiceUrl + " using " + (this.UsesWebSockets ? "WS" : "REST"), 1);
                    }
                    this.IsConnected = tIsConnected;
                }
                else {
                    if (IsHSIDirty === true) {
                        this.UpdateCallerHSI("ProcessMsgDirty");
                    }
                }
                if (!this.UsesWebSockets)
                    return true;
            }
            return false;
        }
        Login(credentials) {
            if (this.mLoginSent === true || !credentials)
                return;
            if (!this.MyConfig)
                this.MyConfig = new cde.TheCommConfig(0);
            if (!this.MyHSI.CurrentRSA && !this.MyConfig.DisableRSA) {
                this.DCreds = new cde.TheCDECredentials;
                this.DCreds.QUID = credentials.QUID;
                this.DCreds.QPWD = credentials.QPWD;
                this.DCreds.QToken = credentials.QToken;
                this.FireEvent(true, "CDE_SETSTATUSMSG", "RSA not initialized, yet. Waiting for relay to provide...", 2); //"cdeEngineStatusYellow");
            }
            else {
                if (this.DCreds && ((this.DCreds.QUID && this.DCreds.QPWD) || this.DCreds.QToken)) {
                    credentials.QToken = this.DCreds.QToken;
                    credentials.QUID = this.DCreds.QUID;
                    credentials.QPWD = this.DCreds.QPWD;
                }
                this.DCreds = null;
                this.FireEvent(true, "CDE_SETSTATUSMSG", "Sending credentials to Relay...", 1);
                if (credentials.QToken && credentials.QToken !== "") {
                    this.TriesTokenLogin = true;
                    this.SendQueued(null, "CDE_TLOGIN" + credentials.QToken, "ContentService", null, null, 1, 1, 1, null, null);
                }
                else if (!credentials.QUID || credentials.QUID === "") {
                    const cred = this.RSAEncrypt(credentials.QPWD, this.MyHSI.CurrentRSA);
                    this.SendQueued(null, "CDE_SETESID" + cred, "ContentService", null, null, 1, 1, 1, null, null);
                }
                else {
                    const cred = this.RSAEncrypt(`${credentials.QUID}:;:${credentials.QPWD}`, this.MyHSI.CurrentRSA);
                    this.SendQueued(null, "CDE_LOGIN" + cred, "ContentService", null, null, 1, 1, 1, null, null);
                }
                this.mLoginSent = true;
                this.MyConfig.Creds = new cde.TheCDECredentials();
            }
        }
        SelectMesh(pMeshID) {
            this.SendQueued(null, "CDE_MESHSELECT:" + pMeshID, "ContentService", null, null, 1, 1, 1, null, null);
        }
        RSAEncrypt(text, token) {
            if (this.MyConfig.DisableRSA)
                return text;
            if (!token || token.length === 0)
                token = this.MyHSI.CurrentRSA;
            if (!token || token.length === 0)
                return text;
            const keys = token.split(',');
            const key = new RSAKey();
            key.setPublic(keys[1], keys[0]);
            return key.encrypt(text);
        }
        GetResourceString(pUri, pCallback, pErrocCallback) {
            this.GetGlobalResource("/ClientBin/" + pUri, null, pCallback, pErrocCallback);
        }
        GetJSON(pUri, pCallback, pErrorCallback) {
            this.GetGlobalResource(pUri, null, (pMagic, res) => {
                try {
                    const tJ = JSON.parse(res);
                    pCallback(tJ);
                }
                catch (ex) {
                    if (pErrorCallback)
                        pErrorCallback(pMagic, ex);
                }
            }, (pMagic, err) => {
                if (pErrorCallback)
                    pErrorCallback(pMagic, err);
            });
        }
        GetGlobalResource(pResource, pAddHeader, pCallback, pErrorCallback) {
            if (window.fetch) {
                const fOptions = new Headers();
                if (pAddHeader) {
                    const tHeads = pAddHeader.split(';:;');
                    for (const element of tHeads) {
                        const tHed = element.split('=');
                        if (tHed.length > 1)
                            fOptions.append(tHed[0], tHed[1]);
                    }
                }
                fetch(pResource, { headers: fOptions, cache: "no-store" }).then(d => {
                    if (d.ok) {
                        d.text().then(txt => {
                            pCallback(pResource, txt);
                        });
                    }
                    else {
                        if (pErrorCallback)
                            pErrorCallback(pResource, d.statusText);
                    }
                }).catch(err => {
                    if (pErrorCallback)
                        pErrorCallback(pResource, err);
                });
            }
            else {
                const xhr = new XMLHttpRequest();
                xhr.open('GET', pResource);
                xhr.responseType = 'text';
                if (pAddHeader) {
                    const tHeads = pAddHeader.split(';:;');
                    let tHasAccept = false;
                    for (const element of tHeads) {
                        const tHed = element.split('=');
                        if (tHed[0] === "Accept")
                            tHasAccept = true;
                        if (tHed.length > 1) {
                            xhr.setRequestHeader(tHed[0], tHed[1]);
                        }
                    }
                    if (!tHasAccept)
                        xhr.setRequestHeader("Accept", "*/*");
                }
                xhr.onload = () => {
                    if (xhr.status >= 200 && xhr.status < 400) {
                        if (pCallback)
                            pCallback(pResource, xhr.responseText);
                    }
                    else {
                        if (pErrorCallback)
                            pErrorCallback(pResource, xhr.status + ":" + xhr.statusText);
                    }
                };
                xhr.onerror = () => {
                    if (pErrorCallback)
                        pErrorCallback(pResource, xhr.status + ":" + xhr.statusText);
                };
                xhr.send();
            }
        }
        UpdateCustomSettings(pValues) {
            if (this.MyConfig) {
                for (const key in pValues) {
                    this.MyConfig[key] = pValues[key];
                }
                this.WriteToIDB();
            }
        }
        WriteToIDB() {
            if (!this.MyDB) {
                cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "IndexedDB:WriteToIDB", 'IDB is not ready, yet', 3);
                return;
            }
            this.MyConfig.cdeTIM = new Date();
            const request = this.MyDB.transaction(['CDEJS'], 'readwrite')
                .objectStore('CDEJS')
                .put({ id: 1, config: this.MyConfig }); //whsi: this.MyHSI,
            request.onsuccess = () => {
                //cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "IndexedDB:WriteToIDB", 'The data has been written successfully', 1)
            };
            request.onerror = () => {
                cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "IndexedDB:WriteToIDB", 'The data has been written failed', 3);
            };
        }
        DeleteFromIDB() {
            if (!this.MyDB) {
                cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "IndexedDB:DeleteFromIDB", 'IDB is not ready, yet', 3);
                return;
            }
            const request = this.MyDB.transaction(['CDEJS'], 'readwrite')
                .objectStore('CDEJS')
                .delete(1);
            request.onsuccess = () => {
                cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "IndexedDB:DeleteFromIDB", 'The data has been deleted', 1);
            };
        }
    }
    cdeWEB.cdeWebComm = cdeWebComm;
})(cdeWEB || (cdeWEB = {}));
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
//declare const SharedWorker: {
//    prototype: SharedWorker.SharedWorker;
//    /***
//     *
//     * @param {string} stringUrl    Pathname to JavaScript file
//     * @param {string} name         Name of the worker to execute
//     */
//    new(stringUrl: string, name?: string): SharedWorker.SharedWorker;
//};
var cdeWEB;
//declare const SharedWorker: {
//    prototype: SharedWorker.SharedWorker;
//    /***
//     *
//     * @param {string} stringUrl    Pathname to JavaScript file
//     * @param {string} name         Name of the worker to execute
//     */
//    new(stringUrl: string, name?: string): SharedWorker.SharedWorker;
//};
(function (cdeWEB) {
    class cdeWebWorkerComm extends cde.TheThing {
        constructor() {
            super();
            this.MyHSI = new cde.TheWHSI();
            this.ForceDisconnect = false;
            this.MyConfig = null;
            this.MyWorker = new SharedWorker("ClientBin/CDE/cdeWorker.min.js?" + document.URL);
            this.MyWorker.port.onmessage = (ev) => {
                try {
                    const message = ev.data;
                    if (message.length > 1) {
                        switch (message[0]) {
                            case "CDE_NEW_LOGENTRY":
                                cde.MyEventLogger.FireEvent(true, message[0], ...message.slice(2));
                                break;
                            default:
                                //if ((<string>message[0]).substr(0, 4) == "GRS_") debugger;
                                this.MyHSI = message[1];
                                cde.MyBaseAssets.MyCommStatus = this.MyHSI;
                                this.FireEvent(true, message[0], ...message.slice(2));
                                break;
                        }
                    }
                }
                catch (ee) {
                    cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "WebWorker:OnMessage", ee, 3);
                }
            };
            this.MyWorker.port.start();
        }
        PostToWorker(pArray) {
            if (this.MyWorker) {
                this.MyWorker.port.postMessage(pArray);
                return true;
            }
            return false;
        }
        //Public synchronous Interface Methods returning a value
        get IsConnected() { return this.ForceDisconnect === true ? false : this.MyHSI.IsConnected; }
        set IsConnected(value) { this.MyHSI.IsConnected = value; }
        get IsReady() { return this.MyHSI.CurrentRSA !== null; }
        get HasAutoLogin() { return this.MyHSI.HasAutoLogin; }
        RSAEncrypt(text, token) {
            if (!this.MyHSI || !this.MyHSI.CurrentRSA || (this.MyConfig && this.MyConfig.DisableRSA))
                return text;
            if (!token || token.length === 0)
                token = this.MyHSI.CurrentRSA;
            if (!token || token.length === 0)
                return text;
            const keys = token.split(',');
            const key = new RSAKey();
            key.setPublic(keys[1], keys[0]);
            return key.encrypt(text);
        }
        //To Here
        SetTargetRelay(pTarget) {
            return this.PostToWorker(["SetTargetRelay", pTarget]);
        }
        SetConfig(pConfig) {
            if (pConfig) {
                this.MyConfig = pConfig;
                this.PostToWorker(["SetConfig", pConfig]);
            }
        }
        StartCommunication(pConfig) {
            this.MyConfig = pConfig;
            this.PostToWorker(["StartCommunication", pConfig]);
        }
        SendQueued(pOwner, pTopic, pEngineName, pTXT, pPLS, pFLG, pQDX, pLVL, pTarget, pGRO, pSender) {
            this.PostToWorker(["SendQueued", pOwner, pTopic, pEngineName, pTXT, pPLS, pFLG, pQDX, pLVL, pTarget, pGRO, pSender]);
        }
        Subscribe(pTopics) {
            this.PostToWorker(["Subscribe", pTopics]);
        }
        Unsubscribe(pTopics) {
            this.PostToWorker(["Unsubscribe", pTopics]);
        }
        SendToNode(tOrg, TargetMessage, IncludeLocalNode) {
            this.PostToWorker(["SendToNode", tOrg, TargetMessage, IncludeLocalNode]);
        }
        SendToOriginator(sourceMessage, TargetMessage, IncludeLocalNode) {
            if (!sourceMessage)
                return;
            this.PostToWorker(["SendToOriginator", sourceMessage, TargetMessage, IncludeLocalNode]);
        }
        SendTSM(tTSM, pTopic, pTarget, pSender) {
            this.PostToWorker(["SendTSM", tTSM, pTopic, pTarget, pSender]);
        }
        SendToFirstNode(TargetMessage) {
            this.PostToWorker(["SendToFirstNode", TargetMessage]);
        }
        Logout() {
            this.PostToWorker(["Logout", "User logged out"]);
        }
        Login(credentials) {
            if (credentials)
                this.PostToWorker(["Login", credentials]);
        }
        SelectMesh(pMeshID) {
            if (pMeshID)
                this.PostToWorker(["SelectMesh", pMeshID]);
        }
        UpdateCustomSettings(pValues) {
            if (pValues) {
                this.PostToWorker(["UpdateCustomSettings", pValues]);
            }
        }
        GetResourceString(pResource, pCallback, pErrorCallback) {
            if (pResource && pCallback) {
                this.RegisterEvent("GRS_/ClientBin/" + pResource, (sender, ...pars) => {
                    pCallback(pResource, ...pars);
                    this.UnregisterEvent("GRS_/ClientBin/" + pResource);
                });
                if (pErrorCallback) {
                    this.RegisterEvent("GRS_ERROR_/ClientBin/" + pResource, (sender, ...pars) => {
                        pErrorCallback(pResource, ...pars);
                        this.UnregisterEvent("GRS_/ClientBin/" + pResource);
                        this.UnregisterEvent("GRS_ERROR_/ClientBin/" + pResource);
                    });
                }
                this.PostToWorker(["GetResourceString", pResource]);
            }
        }
        GetGlobalResource(pResource, pAddHeader, pCallback, pErrorCallback) {
            if (pResource && pCallback) {
                this.RegisterEvent("GGR_" + pResource, (sender, ...pars) => {
                    pCallback(pResource, ...pars);
                    this.UnregisterEvent("GGR_" + pResource);
                });
                if (pErrorCallback) {
                    this.RegisterEvent("GGR_ERROR_" + pResource, (sender, ...pars) => {
                        pCallback(pResource, ...pars);
                        this.UnregisterEvent("GGR_ERROR_" + pResource);
                    });
                }
                this.PostToWorker(["GetGlobalResource", pResource, pAddHeader]);
            }
        }
        GetJSON(pUri, pCallback, pErrorCallback) {
            if (pUri && pCallback) {
                this.RegisterEvent("GJ_" + pUri, (sender, ...pars) => {
                    pCallback(pUri, ...pars);
                    this.UnregisterEvent("GJ_" + pUri);
                    if (pErrorCallback)
                        this.UnregisterEvent("GJ_ERROR_" + pUri);
                });
                if (pErrorCallback) {
                    this.RegisterEvent("GJ_ERROR_" + pUri, (sender, ...pars) => {
                        pErrorCallback(pUri, ...pars);
                        this.UnregisterEvent("GJ_" + pUri);
                        this.UnregisterEvent("GJ_ERROR_" + pUri);
                    });
                }
                this.PostToWorker(["GetJSONAsync", pUri]);
            }
        }
    }
    cdeWEB.cdeWebWorkerComm = cdeWebWorkerComm;
})(cdeWEB || (cdeWEB = {}));
// SPDX-FileCopyrightText: Copyright (c) 2003-2005  Tom Wu
//
// SPDX-License-Identifier: BSD-3-Clause
//Author:
//      original code by Tom Wu
//      ported to TypeScript by Chris Muench
//Language:
//      neutral in NMI - verified
//CSS Styles: none
//Dependencies: none
//Version History
//      4.109: Initial Drop
/*
 * Copyright (c) 2003-2005  Tom Wu
 * All Rights Reserved.
 *
 * Permission is hereby granted, free of charge, to any person obtaining
 * a copy of this software and associated documentation files (the
 * "Software"), to deal in the Software without restriction, including
 * without limitation the rights to use, copy, modify, merge, publish,
 * distribute, sublicense, and/or sell copies of the Software, and to
 * permit persons to whom the Software is furnished to do so, subject to
 * the following conditions:
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS-IS" AND WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS, IMPLIED OR OTHERWISE, INCLUDING WITHOUT LIMITATION, ANY
 * WARRANTY OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
 *
 * IN NO EVENT SHALL TOM WU BE LIABLE FOR ANY SPECIAL, INCIDENTAL,
 * INDIRECT OR CONSEQUENTIAL DAMAGES OF ANY KIND, OR ANY DAMAGES WHATSOEVER
 * RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER OR NOT ADVISED OF
 * THE POSSIBILITY OF DAMAGE, AND ON ANY THEORY OF LIABILITY, ARISING OUT
 * OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 *
 * In addition, the following condition applies:
 *
 * All redistributions must retain an intact copy of this copyright notice
 * and disclaimer.
 */
// @ts-nocheck
var dbits;
var canary = 244837814094590;
var j_lm = ((canary & 16777215) == 15715070);
function BigInteger(e, d, f) {
    if (e != null) {
        if ("number" == typeof e) {
            this.fromNumber(e, d, f);
        }
        else {
            if (d == null && "string" != typeof e) {
                this.fromString(e, 256);
            }
            else {
                this.fromString(e, d);
            }
        }
    }
}
function nbi() {
    return new BigInteger(null, null, null);
}
function am1(f, a, b, e, h, g) {
    while (--g >= 0) {
        var d = a * this[f++] + b[e] + h;
        h = Math.floor(d / 67108864);
        b[e++] = d & 67108863;
    }
    return h;
}
function am2(f, q, r, e, o, a) {
    var k = q & 32767, p = q >> 15;
    while (--a >= 0) {
        var d = this[f] & 32767;
        var g = this[f++] >> 15;
        var b = p * d + g * k;
        d = k * d + ((b & 32767) << 15) + r[e] + (o & 1073741823);
        o = (d >>> 30) + (b >>> 15) + p * g + (o >>> 30);
        r[e++] = d & 1073741823;
    }
    return o;
}
function am3(f, q, r, e, o, a) {
    var k = q & 16383, p = q >> 14;
    while (--a >= 0) {
        var d = this[f] & 16383;
        var g = this[f++] >> 14;
        var b = p * d + g * k;
        d = k * d + ((b & 16383) << 14) + r[e] + o;
        o = (d >> 28) + (b >> 14) + p * g;
        r[e++] = d & 268435455;
    }
    return o;
}
BigInteger.prototype.am = am3;
dbits = 28;
BigInteger.prototype.DB = dbits;
BigInteger.prototype.DM = ((1 << dbits) - 1);
BigInteger.prototype.DV = (1 << dbits);
var BI_FP = 52;
BigInteger.prototype.FV = Math.pow(2, BI_FP);
BigInteger.prototype.F1 = BI_FP - dbits;
BigInteger.prototype.F2 = 2 * dbits - BI_FP;
var BI_RM = "0123456789abcdefghijklmnopqrstuvwxyz";
var BI_RC = new Array();
var rr, vv;
var DV;
rr = "0".charCodeAt(0);
for (vv = 0; vv <= 9; ++vv) {
    BI_RC[rr++] = vv;
}
rr = "a".charCodeAt(0);
for (vv = 10; vv < 36; ++vv) {
    BI_RC[rr++] = vv;
}
rr = "A".charCodeAt(0);
for (vv = 10; vv < 36; ++vv) {
    BI_RC[rr++] = vv;
}
function int2char(a) {
    return BI_RM.charAt(a);
}
function intAt(b, a) {
    var d = BI_RC[b.charCodeAt(a)];
    return (d == null) ? -1 : d;
}
function bnpCopyTo(b) {
    for (var a = this.t - 1; a >= 0; --a) {
        b[a] = this[a];
    }
    b.t = this.t;
    b.s = this.s;
}
function bnpFromInt(a) {
    this.t = 1;
    this.s = (a < 0) ? -1 : 0;
    if (a > 0) {
        this[0] = a;
    }
    else {
        if (a < -1) {
            this[0] = a + DV;
        }
        else {
            this.t = 0;
        }
    }
}
function nbv(a) {
    var b = nbi();
    b.fromInt(a);
    return b;
}
function bnpFromString(h, c) {
    var e;
    if (c == 16) {
        e = 4;
    }
    else {
        if (c == 8) {
            e = 3;
        }
        else {
            if (c == 256) {
                e = 8;
            }
            else {
                if (c == 2) {
                    e = 1;
                }
                else {
                    if (c == 32) {
                        e = 5;
                    }
                    else {
                        if (c == 4) {
                            e = 2;
                        }
                        else {
                            this.fromRadix(h, c);
                            return;
                        }
                    }
                }
            }
        }
    }
    this.t = 0;
    this.s = 0;
    var g = h.length, d = false, f = 0;
    while (--g >= 0) {
        var a = (e == 8) ? h[g] & 255 : intAt(h, g);
        if (a < 0) {
            if (h.charAt(g) == "-") {
                d = true;
            }
            continue;
        }
        d = false;
        if (f == 0) {
            this[this.t++] = a;
        }
        else {
            if (f + e > this.DB) {
                this[this.t - 1] |= (a & ((1 << (this.DB - f)) - 1)) << f;
                this[this.t++] = (a >> (this.DB - f));
            }
            else {
                this[this.t - 1] |= a << f;
            }
        }
        f += e;
        if (f >= this.DB) {
            f -= this.DB;
        }
    }
    if (e == 8 && (h[0] & 128) != 0) {
        this.s = -1;
        if (f > 0) {
            this[this.t - 1] |= ((1 << (this.DB - f)) - 1) << f;
        }
    }
    this.clamp();
    if (d) {
        BigInteger.prototype.ZERO.subTo(this, this);
    }
}
function bnpClamp() {
    var a = this.s & this.DM;
    while (this.t > 0 && this[this.t - 1] == a) {
        --this.t;
    }
}
function bnToString(c) {
    if (this.s < 0) {
        return "-" + this.negate().toString(c);
    }
    var e;
    if (c == 16) {
        e = 4;
    }
    else {
        if (c == 8) {
            e = 3;
        }
        else {
            if (c == 2) {
                e = 1;
            }
            else {
                if (c == 32) {
                    e = 5;
                }
                else {
                    if (c == 4) {
                        e = 2;
                    }
                    else {
                        return this.toRadix(c);
                    }
                }
            }
        }
    }
    var g = (1 << e) - 1, l, a = false, h = "", f = this.t;
    var j = this.DB - (f * this.DB) % e;
    if (f-- > 0) {
        if (j < this.DB && (l = this[f] >> j) > 0) {
            a = true;
            h = int2char(l);
        }
        while (f >= 0) {
            if (j < e) {
                l = (this[f] & ((1 << j) - 1)) << (e - j);
                l |= this[--f] >> (j += this.DB - e);
            }
            else {
                l = (this[f] >> (j -= e)) & g;
                if (j <= 0) {
                    j += this.DB;
                    --f;
                }
            }
            if (l > 0) {
                a = true;
            }
            if (a) {
                h += int2char(l);
            }
        }
    }
    return a ? h : "0";
}
function bnNegate() {
    var a = nbi();
    BigInteger.prototype.ZERO.subTo(this, a);
    return a;
}
function bnAbs() {
    return (this.s < 0) ? this.negate() : this;
}
function bnCompareTo(b) {
    var d = this.s - b.s;
    if (d != 0) {
        return d;
    }
    var c = this.t;
    d = c - b.t;
    if (d != 0) {
        return d;
    }
    while (--c >= 0) {
        if ((d = this[c] - b[c]) != 0) {
            return d;
        }
    }
    return 0;
}
function nbits(a) {
    var c = 1, b;
    if ((b = a >>> 16) != 0) {
        a = b;
        c += 16;
    }
    if ((b = a >> 8) != 0) {
        a = b;
        c += 8;
    }
    if ((b = a >> 4) != 0) {
        a = b;
        c += 4;
    }
    if ((b = a >> 2) != 0) {
        a = b;
        c += 2;
    }
    if ((b = a >> 1) != 0) {
        a = b;
        c += 1;
    }
    return c;
}
function bnBitLength() {
    if (this.t <= 0) {
        return 0;
    }
    return this.DB * (this.t - 1) + nbits(this[this.t - 1] ^ (this.s & this.DM));
}
function bnpDLShiftTo(c, b) {
    var a;
    for (a = this.t - 1; a >= 0; --a) {
        b[a + c] = this[a];
    }
    for (a = c - 1; a >= 0; --a) {
        b[a] = 0;
    }
    b.t = this.t + c;
    b.s = this.s;
}
function bnpDRShiftTo(c, b) {
    for (var a = c; a < this.t; ++a) {
        b[a - c] = this[a];
    }
    b.t = Math.max(this.t - c, 0);
    b.s = this.s;
}
function bnpLShiftTo(j, e) {
    var b = j % this.DB;
    var a = this.DB - b;
    var g = (1 << a) - 1;
    var f = Math.floor(j / this.DB), h = (this.s << b) & this.DM, d;
    for (d = this.t - 1; d >= 0; --d) {
        e[d + f + 1] = (this[d] >> a) | h;
        h = (this[d] & g) << b;
    }
    for (d = f - 1; d >= 0; --d) {
        e[d] = 0;
    }
    e[f] = h;
    e.t = this.t + f + 1;
    e.s = this.s;
    e.clamp();
}
function bnpRShiftTo(g, d) {
    d.s = this.s;
    var e = Math.floor(g / this.DB);
    if (e >= this.t) {
        d.t = 0;
        return;
    }
    var b = g % this.DB;
    var a = this.DB - b;
    var f = (1 << b) - 1;
    d[0] = this[e] >> b;
    for (var c = e + 1; c < this.t; ++c) {
        d[c - e - 1] |= (this[c] & f) << a;
        d[c - e] = this[c] >> b;
    }
    if (b > 0) {
        d[this.t - e - 1] |= (this.s & f) << a;
    }
    d.t = this.t - e;
    d.clamp();
}
function bnpSubTo(d, f) {
    var e = 0, g = 0, b = Math.min(d.t, this.t);
    while (e < b) {
        g += this[e] - d[e];
        f[e++] = g & this.DM;
        g >>= this.DB;
    }
    if (d.t < this.t) {
        g -= d.s;
        while (e < this.t) {
            g += this[e];
            f[e++] = g & this.DM;
            g >>= this.DB;
        }
        g += this.s;
    }
    else {
        g += this.s;
        while (e < d.t) {
            g -= d[e];
            f[e++] = g & this.DM;
            g >>= this.DB;
        }
        g -= d.s;
    }
    f.s = (g < 0) ? -1 : 0;
    if (g < -1) {
        f[e++] = this.DV + g;
    }
    else {
        if (g > 0) {
            f[e++] = g;
        }
    }
    f.t = e;
    f.clamp();
}
function bnpMultiplyTo(c, e) {
    var b = this.abs(), f = c.abs();
    var d = b.t;
    e.t = d + f.t;
    while (--d >= 0) {
        e[d] = 0;
    }
    for (d = 0; d < f.t; ++d) {
        e[d + b.t] = b.am(0, f[d], e, d, 0, b.t);
    }
    e.s = 0;
    e.clamp();
    if (this.s != c.s) {
        BigInteger.prototype.ZERO.subTo(e, e);
    }
}
function bnpSquareTo(d) {
    var a = this.abs();
    var b = d.t = 2 * a.t;
    while (--b >= 0) {
        d[b] = 0;
    }
    for (b = 0; b < a.t - 1; ++b) {
        var e = a.am(b, a[b], d, 2 * b, 0, 1);
        if ((d[b + a.t] += a.am(b + 1, 2 * a[b], d, 2 * b + 1, e, a.t - b - 1)) >= a.DV) {
            d[b + a.t] -= a.DV;
            d[b + a.t + 1] = 1;
        }
    }
    if (d.t > 0) {
        d[d.t - 1] += a.am(b, a[b], d, 2 * b, 0, 1);
    }
    d.s = 0;
    d.clamp();
}
function bnpDivRemTo(n, h, g) {
    var w = n.abs();
    if (w.t <= 0) {
        return;
    }
    var k = this.abs();
    if (k.t < w.t) {
        if (h != null) {
            h.fromInt(0);
        }
        if (g != null) {
            this.copyTo(g);
        }
        return;
    }
    if (g == null) {
        g = nbi();
    }
    var d = nbi(), a = this.s, l = n.s;
    var v = this.DB - nbits(w[w.t - 1]);
    if (v > 0) {
        w.lShiftTo(v, d);
        k.lShiftTo(v, g);
    }
    else {
        w.copyTo(d);
        k.copyTo(g);
    }
    var p = d.t;
    var b = d[p - 1];
    if (b == 0) {
        return;
    }
    var o = b * (1 << this.F1) + ((p > 1) ? d[p - 2] >> this.F2 : 0);
    var B = this.FV / o, A = (1 << this.F1) / o, x = 1 << this.F2;
    var u = g.t, s = u - p, f = (h == null) ? nbi() : h;
    d.dlShiftTo(s, f);
    if (g.compareTo(f) >= 0) {
        g[g.t++] = 1;
        g.subTo(f, g);
    }
    BigInteger.prototype.ONE.dlShiftTo(p, f);
    f.subTo(d, d);
    while (d.t < p) {
        d[d.t++] = 0;
    }
    while (--s >= 0) {
        var c = (g[--u] == b) ? this.DM : Math.floor(g[u] * B + (g[u - 1] + x) * A);
        if ((g[u] += d.am(0, c, g, s, 0, p)) < c) {
            d.dlShiftTo(s, f);
            g.subTo(f, g);
            while (g[u] < --c) {
                g.subTo(f, g);
            }
        }
    }
    if (h != null) {
        g.drShiftTo(p, h);
        if (a != l) {
            BigInteger.prototype.ZERO.subTo(h, h);
        }
    }
    g.t = p;
    g.clamp();
    if (v > 0) {
        g.rShiftTo(v, g);
    }
    if (a < 0) {
        BigInteger.prototype.ZERO.subTo(g, g);
    }
}
function bnMod(b) {
    var c = nbi();
    this.abs().divRemTo(b, null, c);
    if (this.s < 0 && c.compareTo(BigInteger.prototype.ZERO) > 0) {
        b.subTo(c, c);
    }
    return c;
}
function Classic(a) {
    this.m = a;
}
function cConvert(a) {
    if (a.s < 0 || a.compareTo(this.m) >= 0) {
        return a.mod(this.m);
    }
    else {
        return a;
    }
}
function cRevert(a) {
    return a;
}
function cReduce(a) {
    a.divRemTo(this.m, null, a);
}
function cMulTo(a, c, b) {
    a.multiplyTo(c, b);
    this.reduce(b);
}
function cSqrTo(a, b) {
    a.squareTo(b);
    this.reduce(b);
}
Classic.prototype.convert = cConvert;
Classic.prototype.revert = cRevert;
Classic.prototype.reduce = cReduce;
Classic.prototype.mulTo = cMulTo;
Classic.prototype.sqrTo = cSqrTo;
function bnpInvDigit() {
    if (this.t < 1) {
        return 0;
    }
    var a = this[0];
    if ((a & 1) == 0) {
        return 0;
    }
    var b = a & 3;
    b = (b * (2 - (a & 15) * b)) & 15;
    b = (b * (2 - (a & 255) * b)) & 255;
    b = (b * (2 - (((a & 65535) * b) & 65535))) & 65535;
    b = (b * (2 - a * b % this.DV)) % this.DV;
    return (b > 0) ? this.DV - b : -b;
}
function Montgomery(a) {
    this.m = a;
    this.mp = a.invDigit();
    this.mpl = this.mp & 32767;
    this.mph = this.mp >> 15;
    this.um = (1 << (a.DB - 15)) - 1;
    this.mt2 = 2 * a.t;
}
function montConvert(a) {
    var b = nbi();
    a.abs().dlShiftTo(this.m.t, b);
    b.divRemTo(this.m, null, b);
    if (a.s < 0 && b.compareTo(BigInteger.prototype.ZERO) > 0) {
        this.m.subTo(b, b);
    }
    return b;
}
function montRevert(a) {
    var b = nbi();
    a.copyTo(b);
    this.reduce(b);
    return b;
}
function montReduce(a) {
    while (a.t <= this.mt2) {
        a[a.t++] = 0;
    }
    for (var c = 0; c < this.m.t; ++c) {
        var b = a[c] & 32767;
        var d = (b * this.mpl + (((b * this.mph + (a[c] >> 15) * this.mpl) & this.um) << 15)) & a.DM;
        b = c + this.m.t;
        a[b] += this.m.am(0, d, a, c, 0, this.m.t);
        while (a[b] >= a.DV) {
            a[b] -= a.DV;
            a[++b]++;
        }
    }
    a.clamp();
    a.drShiftTo(this.m.t, a);
    if (a.compareTo(this.m) >= 0) {
        a.subTo(this.m, a);
    }
}
function montSqrTo(a, b) {
    a.squareTo(b);
    this.reduce(b);
}
function montMulTo(a, c, b) {
    a.multiplyTo(c, b);
    this.reduce(b);
}
Montgomery.prototype.convert = montConvert;
Montgomery.prototype.revert = montRevert;
Montgomery.prototype.reduce = montReduce;
Montgomery.prototype.mulTo = montMulTo;
Montgomery.prototype.sqrTo = montSqrTo;
function bnpIsEven() {
    return ((this.t > 0) ? (this[0] & 1) : this.s) == 0;
}
function bnpExp(h, j) {
    if (h > 4294967295 || h < 1) {
        return BigInteger.prototype.ONE;
    }
    var f = nbi(), a = nbi(), d = j.convert(this), c = nbits(h) - 1;
    d.copyTo(f);
    while (--c >= 0) {
        j.sqrTo(f, a);
        if ((h & (1 << c)) > 0) {
            j.mulTo(a, d, f);
        }
        else {
            var b = f;
            f = a;
            a = b;
        }
    }
    return j.revert(f);
}
function bnModPowInt(b, a) {
    var c;
    if (b < 256 || a.isEven()) {
        c = new Classic(a);
    }
    else {
        c = new Montgomery(a);
    }
    return this.exp(b, c);
}
BigInteger.prototype.copyTo = bnpCopyTo;
BigInteger.prototype.fromInt = bnpFromInt;
BigInteger.prototype.fromString = bnpFromString;
BigInteger.prototype.clamp = bnpClamp;
BigInteger.prototype.dlShiftTo = bnpDLShiftTo;
BigInteger.prototype.drShiftTo = bnpDRShiftTo;
BigInteger.prototype.lShiftTo = bnpLShiftTo;
BigInteger.prototype.rShiftTo = bnpRShiftTo;
BigInteger.prototype.subTo = bnpSubTo;
BigInteger.prototype.multiplyTo = bnpMultiplyTo;
BigInteger.prototype.squareTo = bnpSquareTo;
BigInteger.prototype.divRemTo = bnpDivRemTo;
BigInteger.prototype.invDigit = bnpInvDigit;
BigInteger.prototype.isEven = bnpIsEven;
BigInteger.prototype.exp = bnpExp;
BigInteger.prototype.toString = bnToString;
BigInteger.prototype.negate = bnNegate;
BigInteger.prototype.abs = bnAbs;
BigInteger.prototype.compareTo = bnCompareTo;
BigInteger.prototype.bitLength = bnBitLength;
BigInteger.prototype.mod = bnMod;
BigInteger.prototype.modPowInt = bnModPowInt;
BigInteger.prototype.ZERO = nbv(0);
BigInteger.prototype.ONE = nbv(1);
function Arcfour() {
    this.i = 0;
    this.j = 0;
    this.S = new Array();
}
function ARC4init(d) {
    var c, a, b;
    for (c = 0; c < 256; ++c) {
        this.S[c] = c;
    }
    a = 0;
    for (c = 0; c < 256; ++c) {
        a = (a + this.S[c] + d[c % d.length]) & 255;
        b = this.S[c];
        this.S[c] = this.S[a];
        this.S[a] = b;
    }
    this.i = 0;
    this.j = 0;
}
function ARC4next() {
    var a;
    this.i = (this.i + 1) & 255;
    this.j = (this.j + this.S[this.i]) & 255;
    a = this.S[this.i];
    this.S[this.i] = this.S[this.j];
    this.S[this.j] = a;
    return this.S[(a + this.S[this.i]) & 255];
}
Arcfour.prototype.init = ARC4init;
Arcfour.prototype.next = ARC4next;
function prng_newstate() {
    return new Arcfour();
}
var rng_psize = 256;
var rng_state;
var rng_pool;
var rng_pptr;
function rng_seed_int(a) {
    rng_pool[rng_pptr++] ^= a & 255;
    rng_pool[rng_pptr++] ^= (a >> 8) & 255;
    rng_pool[rng_pptr++] ^= (a >> 16) & 255;
    rng_pool[rng_pptr++] ^= (a >> 24) & 255;
    if (rng_pptr >= rng_psize) {
        rng_pptr -= rng_psize;
    }
}
function rng_seed_time() {
    rng_seed_int(new Date().getTime());
}
if (rng_pool == null) {
    rng_pool = new Array();
    rng_pptr = 0;
    var t;
    while (rng_pptr < rng_psize) {
        if (typeof window === typeof undefined) {
            t = Math.floor(65536 * Math.random()); //NOSONAR - window not available in Web Worker
        }
        else {
            const crypto = window.crypto || window.msCrypto;
            var array = new Uint32Array(1);
            t = Math.floor(65536 * crypto.getRandomValues(array));
        }
        rng_pool[rng_pptr++] = t >>> 8;
        rng_pool[rng_pptr++] = t & 255;
    }
    rng_pptr = 0;
    rng_seed_time();
}
function rng_get_byte() {
    if (rng_state == null) {
        rng_seed_time();
        rng_state = prng_newstate();
        rng_state.init(rng_pool);
        for (rng_pptr = 0; rng_pptr < rng_pool.length; ++rng_pptr) {
            rng_pool[rng_pptr] = 0;
        }
        rng_pptr = 0;
    }
    return rng_state.next();
}
function rng_get_bytes(b) {
    var a;
    for (a = 0; a < b.length; ++a) {
        b[a] = rng_get_byte();
    }
}
function SecureRandom() { }
SecureRandom.prototype.nextBytes = rng_get_bytes;
function parseBigInt(b, a) {
    return new BigInteger(b, a, null);
}
function linebrk(c, d) {
    var a = "";
    var b = 0;
    while (b + d < c.length) {
        a += c.substring(b, b + d) + "\n";
        b += d;
    }
    return a + c.substring(b, c.length);
}
function byte2Hex(a) {
    if (a < 16) {
        return "0" + a.toString(16);
    }
    else {
        return a.toString(16);
    }
}
function pkcs1pad2(e, h) {
    if (h < e.length + 11) {
        return null;
    }
    var g = new Array();
    var d = e.length - 1;
    while (d >= 0 && h > 0) {
        var f = e.charCodeAt(d--);
        if (f < 128) {
            g[--h] = f;
        }
        else {
            if ((f > 127) && (f < 2048)) {
                g[--h] = (f & 63) | 128;
                g[--h] = (f >> 6) | 192;
            }
            else {
                g[--h] = (f & 63) | 128;
                g[--h] = ((f >> 6) & 63) | 128;
                g[--h] = (f >> 12) | 224;
            }
        }
    }
    g[--h] = 0;
    var b = new SecureRandom();
    var a = new Array();
    while (h > 2) {
        a[0] = 0;
        while (a[0] == 0) {
            b.nextBytes(a);
        }
        g[--h] = a[0];
    }
    g[--h] = 2;
    g[--h] = 0;
    return new BigInteger(g, null, null);
}
function RSAKey() {
    this.n = null;
    this.e = 0;
    this.d = null;
    this.p = null;
    this.q = null;
    this.dmp1 = null;
    this.dmq1 = null;
    this.coeff = null;
}
function RSASetPublic(b, a) {
    if (b != null && a != null && b.length > 0 && a.length > 0) {
        this.n = parseBigInt(b, 16);
        this.e = parseInt(a, 16);
    }
}
function RSADoPublic(a) {
    return a.modPowInt(this.e, this.n);
}
function RSAEncrypt(d) {
    var a = pkcs1pad2(d, (this.n.bitLength() + 7) >> 3);
    if (a == null) {
        return null;
    }
    var e = this.doPublic(a);
    if (e == null) {
        return null;
    }
    var b = e.toString(16);
    if ((b.length & 1) == 0) {
        return b;
    }
    else {
        return "0" + b;
    }
}
RSAKey.prototype.doPublic = RSADoPublic;
RSAKey.prototype.setPublic = RSASetPublic;
RSAKey.prototype.encrypt = RSAEncrypt;
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
var cdeSpeech;
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
(function (cdeSpeech) {
    cdeSpeech.synth = window.speechSynthesis;
    function talk(text, lang = "en", voiceIdx = 0) {
        if (!text)
            return;
        try {
            if (cdeSpeech.synth.speaking) {
                return;
            }
            const utterThis = new SpeechSynthesisUtterance(text);
            //utterThis.onend = function (event) {
            //    console.log('talking done');
            //}
            //utterThis.onerror = function (event) {
            //    console.error('Talking error');
            //}
            const voices = cdeSpeech.synth.getVoices();
            //ES5:
            let v = voices[voiceIdx];
            for (const t in voices) {
                if (voices[t].lang.toLowerCase().startsWith(lang.toLowerCase())) {
                    v = voices[t];
                    break;
                }
            }
            //ES6: const v = voices.filter(x => x.lang.includes(lang))[voiceIdx];
            utterThis.voice = v;
            //utterThis.pitch = pitch.value;
            //utterThis.rate = rate.value;
            cdeSpeech.synth.speak(utterThis);
        }
        catch (exception) {
            //ignored
        }
    }
    cdeSpeech.talk = talk;
})(cdeSpeech || (cdeSpeech = {}));
// SPDX-FileCopyrightText: Eli Grey
//
// SPDX-License-Identifier: MIT
/* original code: FileSaver.js
 * A saveAs() FileSaver implementation.
 * 1.3.8
 * 2018 - 03 - 22 14: 03: 47
 *
 * By Eli Grey, https://eligrey.com
 * License: MIT
 * See https://github.com/eligrey/FileSaver.js/blob/master/LICENSE.md
 * @source http://purl.eligrey.com/github/FileSaver.js/blob/master/src/FileSaver.js */
//
//      ported to TypeScript by Chris Muench
//Language:
//      neutral in NMI - verified
//CSS Styles: none
//Dependencies: none
//Version History
//      4.109: Initial Drop
//////////////////////////////////////////////////////////////////////////////
var cde;
// SPDX-FileCopyrightText: Eli Grey
//
// SPDX-License-Identifier: MIT
/* original code: FileSaver.js
 * A saveAs() FileSaver implementation.
 * 1.3.8
 * 2018 - 03 - 22 14: 03: 47
 *
 * By Eli Grey, https://eligrey.com
 * License: MIT
 * See https://github.com/eligrey/FileSaver.js/blob/master/LICENSE.md
 * @source http://purl.eligrey.com/github/FileSaver.js/blob/master/src/FileSaver.js */
//
//      ported to TypeScript by Chris Muench
//Language:
//      neutral in NMI - verified
//CSS Styles: none
//Dependencies: none
//Version History
//      4.109: Initial Drop
//////////////////////////////////////////////////////////////////////////////
(function (cde) {
    class cdeFileSaver extends cde.TheDataBase {
        constructor() {
            super(...arguments);
            this.blob = null;
            this.force = false;
            this.readyState = "INIT";
            this.isSafari = false;
            this.isChromeIos = false;
            this.save_link = document.createElementNS("http://www.w3.org/1999/xhtml", "a");
            this.can_use_save_link = "download" in this.save_link;
            //MySetImmediate = window.setTimeout; //window.setImmediate ||
            this.force_saveable_type = "application/octet-stream";
            this.arbitrary_revoke_timeout = 1000 * 40; // in ms
        }
        SaveAs(blob, name, noAutoBom) {
            //if (window.navigator && window.navigator.msSaveOrOpenBlob) { //IE11+
            //    window.navigator.msSaveOrOpenBlob(blob, name);
            //    return;
            //}
            if (cde.IsIE()) {
                if (cdeNMI.MyToast)
                    cdeNMI.MyToast.ShowToastMessage("Sorry...but IE does not support saving files!");
                return;
            }
            if (!noAutoBom) {
                this.blob = this.AutoBom(blob);
            }
            else
                this.blob = blob;
            const view = window;
            this.isSafari = /constructor/i.test(view.HTMLElement) || view.safari;
            this.isChromeIos = /CriOS\/[\d]+/.test(navigator.userAgent);
            this.force = blob.type === this.force_saveable_type;
            try {
                if (this.can_use_save_link) {
                    this.ObjectUrl = this.GetURL().createObjectURL(blob);
                    window.setTimeout(() => {
                        this.save_link.href = this.ObjectUrl;
                        this.save_link.download = name;
                        this.click(this.save_link);
                        this.DispatchAll();
                        this.revoke(this.ObjectUrl);
                        this.readyState = "DONE";
                    }, 0);
                    return;
                }
            }
            catch (ex) {
                //ignored
            }
            this.FsError();
        }
        GetURL() {
            return window.URL || window.webkitURL || window;
        }
        ;
        click(node) {
            const event = new MouseEvent("click");
            node.dispatchEvent(event);
        }
        revoker(file) {
            if (typeof file === "string") { // file is an object URL
                this.GetURL().revokeObjectURL(file);
            }
            else { // file is a File
                file.remove();
            }
        }
        // the Blob API is fundamentally broken as there is no "downloadfinished" event to subscribe to
        revoke(file) {
            setTimeout(() => this.revoker(file), this.arbitrary_revoke_timeout);
        }
        AutoBom(blob) {
            // prepend BOM for UTF-8 XML and text/* types (including HTML)
            // note: your browser will automatically convert UTF-16 U+FEFF to EF BB BF
            if (/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(blob.type)) { //NOSONAR Not Critical
                return new Blob([String.fromCharCode(0xFEFF), blob], { type: blob.type });
            }
            return blob;
        }
        dispatch(filesaver, eventTypes, event) {
            eventTypes = [].concat(eventTypes);
            let i = eventTypes.length;
            while (i--) {
                const listener = filesaver["on" + eventTypes[i]];
                if (typeof listener === "function") {
                    try {
                        listener.call(filesaver, event || filesaver);
                    }
                    catch (ex) {
                        cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "FileSaver", "dispatch failed: " + ex + ":" + ex.stack);
                    }
                }
            }
        }
        DispatchAll() {
            this.dispatch(this, "writestart progress write writeend".split(" "), null);
        }
        // First try a.download, then web filesystem, then object URLs
        FsError() {
            if ((this.isChromeIos || (this.force && this.isSafari)) && window.FileReader) {
                // Safari doesn't allow downloading of blob urls
                const reader = new FileReader();
                reader.onloadend = () => {
                    let url = (this.isChromeIos ? reader.result : reader.result.replace(/^data:[^;]*;/, 'data:attachment/file;'));
                    const popup = window.open(url, '_blank');
                    if (!popup)
                        window.location.href = url;
                    url = undefined; // release reference before dispatching
                    this.readyState = "DONE";
                    this.DispatchAll();
                };
                reader.readAsDataURL(this.blob);
                this.readyState = "INIT";
                return;
            }
            // don't create more object URLs than needed
            if (!this.ObjectUrl) {
                this.ObjectUrl = this.GetURL().createObjectURL(this.blob);
            }
            if (this.force) {
                window.location.href = this.ObjectUrl;
            }
            else {
                let opened;
                try {
                    opened = window.open(this.ObjectUrl, "_blank");
                }
                catch (_a) {
                    //ignored
                }
                if (!opened) {
                    // Apple does not allow window.open, see https://developer.apple.com/library/safari/documentation/Tools/Conceptual/SafariExtensionGuide/WorkingwithWindowsandTabs/WorkingwithWindowsandTabs.html
                    window.location.href = this.ObjectUrl;
                }
            }
            this.readyState = "DONE";
            this.DispatchAll();
            this.revoke(this.ObjectUrl);
        }
    }
    cde.cdeFileSaver = cdeFileSaver;
})(cde || (cde = {}));
// SPDX-FileCopyrightText: 2009-2023 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
var cdeNMI;
// SPDX-FileCopyrightText: 2009-2023 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
(function (cdeNMI) {
    //////////////////////////////////////////////////////////////////////////////
    /// Interfaces
    //////////////////////////////////////////////////////////////////////////////
    cdeNMI.MyNMIModels = new Array();
    cdeNMI.MyNMINUITags = new Array();
    cdeNMI.MyNMID = new Array();
    cdeNMI.MyNMIThingEvents = [];
    cdeNMI.MyTouchOverlay = null;
    cdeNMI.IsMouseDown = false;
    cdeNMI.Key13Event = null;
    cdeNMI.Key27Event = null;
    cdeNMI.DisableKey36Event = false;
    cdeNMI.IsInEdit = false;
    cdeNMI.eTheNMIEngine = "NMIService"; //Main NMI Service Engine
    //////////////////////////////////////////////////////////////////////////////
    /// Enums
    //////////////////////////////////////////////////////////////////////////////
    let cdeControlType;
    (function (cdeControlType) {
        cdeControlType[cdeControlType["BaseControl"] = 0] = "BaseControl";
        /* NMI Control Types        BaseControl         Done?
          ----------------------------------------------------------------------*/
        cdeControlType[cdeControlType["SingleEnded"] = 1] = "SingleEnded";
        cdeControlType[cdeControlType["ComboBox"] = 2] = "ComboBox";
        cdeControlType[cdeControlType["Radio"] = 3] = "Radio";
        cdeControlType[cdeControlType["SingleCheck"] = 4] = "SingleCheck";
        cdeControlType[cdeControlType["TextArea"] = 5] = "TextArea";
        cdeControlType[cdeControlType["YesNo"] = 6] = "YesNo";
        //YesNoNa = 7,//               ctrlComboBox      RETIRED
        cdeControlType[cdeControlType["Time"] = 8] = "Time";
        cdeControlType[cdeControlType["TimeSpan"] = 9] = "TimeSpan";
        cdeControlType[cdeControlType["Password"] = 10] = "Password";
        //SubmitButton = 11,//         ctrlTileButton      YES        RETIRED! USE ctrlTileButton   
        cdeControlType[cdeControlType["Number"] = 12] = "Number";
        cdeControlType[cdeControlType["Region"] = 13] = "Region";
        cdeControlType[cdeControlType["Country"] = 14] = "Country";
        cdeControlType[cdeControlType["TrueFalse"] = 15] = "TrueFalse";
        cdeControlType[cdeControlType["eMail"] = 16] = "eMail";
        cdeControlType[cdeControlType["ComboOption"] = 17] = "ComboOption";
        cdeControlType[cdeControlType["Month"] = 18] = "Month";
        cdeControlType[cdeControlType["FormButton"] = 19] = "FormButton";
        cdeControlType[cdeControlType["SmartLabel"] = 20] = "SmartLabel";
        cdeControlType[cdeControlType["DateTime"] = 21] = "DateTime";
        cdeControlType[cdeControlType["TileButton"] = 22] = "TileButton";
        cdeControlType[cdeControlType["Table"] = 23] = "Table";
        cdeControlType[cdeControlType["CheckField"] = 24] = "CheckField";
        cdeControlType[cdeControlType["RadioGrid"] = 25] = "RadioGrid";
        cdeControlType[cdeControlType["Screen"] = 26] = "Screen";
        cdeControlType[cdeControlType["TableCell"] = 27] = "TableCell";
        cdeControlType[cdeControlType["TileEntry"] = 28] = "TileEntry";
        cdeControlType[cdeControlType["Picture"] = 29] = "Picture";
        cdeControlType[cdeControlType["CanvasDraw"] = 30] = "CanvasDraw";
        cdeControlType[cdeControlType["URL"] = 31] = "URL";
        cdeControlType[cdeControlType["Curreny"] = 32] = "Curreny";
        cdeControlType[cdeControlType["Slider"] = 33] = "Slider";
        cdeControlType[cdeControlType["BarChart"] = 34] = "BarChart";
        cdeControlType[cdeControlType["Toast"] = 35] = "Toast";
        cdeControlType[cdeControlType["TouchDraw"] = 36] = "TouchDraw";
        cdeControlType[cdeControlType["Popup"] = 37] = "Popup";
        cdeControlType[cdeControlType["DrawOverlay"] = 38] = "DrawOverlay";
        //Accordion = 39, //           ctrlAccordion      RETIRED!!!
        cdeControlType[cdeControlType["DropUploader"] = 40] = "DropUploader";
        cdeControlType[cdeControlType["RevealButton"] = 41] = "RevealButton";
        cdeControlType[cdeControlType["PinButton"] = 42] = "PinButton";
        //CenteredTable = 43,//       ctrlCenteredTable   RETIRED!!!
        cdeControlType[cdeControlType["Dashboard"] = 44] = "Dashboard";
        cdeControlType[cdeControlType["FormView"] = 45] = "FormView";
        cdeControlType[cdeControlType["TouchOverlay"] = 46] = "TouchOverlay";
        cdeControlType[cdeControlType["MuTLock"] = 47] = "MuTLock";
        cdeControlType[cdeControlType["ProgressBar"] = 48] = "ProgressBar";
        cdeControlType[cdeControlType["TileGroup"] = 49] = "TileGroup";
        cdeControlType[cdeControlType["VideoViewer"] = 50] = "VideoViewer";
        cdeControlType[cdeControlType["UserControl"] = 51] = "UserControl";
        cdeControlType[cdeControlType["TableRow"] = 52] = "TableRow";
        cdeControlType[cdeControlType["IPAddress"] = 53] = "IPAddress";
        cdeControlType[cdeControlType["Shape"] = 54] = "Shape";
        cdeControlType[cdeControlType["CollapsibleGroup"] = 55] = "CollapsibleGroup";
        cdeControlType[cdeControlType["AboutButton"] = 56] = "AboutButton";
        cdeControlType[cdeControlType["StatusLight"] = 57] = "StatusLight";
        cdeControlType[cdeControlType["FacePlate"] = 58] = "FacePlate";
        //New controls in 4.1
        cdeControlType[cdeControlType["LoginScreen"] = 59] = "LoginScreen";
        cdeControlType[cdeControlType["ShapeRecognizer"] = 60] = "ShapeRecognizer";
        cdeControlType[cdeControlType["ScreenManager"] = 61] = "ScreenManager";
        cdeControlType[cdeControlType["LogoButton"] = 62] = "LogoButton";
        cdeControlType[cdeControlType["ThingPicker"] = 63] = "ThingPicker";
        cdeControlType[cdeControlType["ImageSlider"] = 64] = "ImageSlider";
        cdeControlType[cdeControlType["CircularGauge"] = 65] = "CircularGauge";
        cdeControlType[cdeControlType["SmartGauge"] = 66] = "SmartGauge";
        cdeControlType[cdeControlType["IFrameView"] = 67] = "IFrameView";
        cdeControlType[cdeControlType["PropertyPicker"] = 68] = "PropertyPicker";
        cdeControlType[cdeControlType["PropertyPickerCtrl"] = 69] = "PropertyPickerCtrl";
        cdeControlType[cdeControlType["ToolTip"] = 70] = "ToolTip";
        cdeControlType[cdeControlType["ComboLookup"] = 71] = "ComboLookup";
        cdeControlType[cdeControlType["UserMenu"] = 72] = "UserMenu";
        cdeControlType[cdeControlType["MeshPicker"] = 73] = "MeshPicker";
        cdeControlType[cdeControlType["HashIcon"] = 74] = "HashIcon";
        cdeControlType[cdeControlType["CertPicker"] = 75] = "CertPicker";
        cdeControlType[cdeControlType["DeviceTypePicker"] = 76] = "DeviceTypePicker";
    })(cdeControlType = cdeNMI.cdeControlType || (cdeNMI.cdeControlType = {}));
    let cdeInputEventType;
    (function (cdeInputEventType) {
        cdeInputEventType[cdeInputEventType["UNKOWN"] = 0] = "UNKOWN";
        cdeInputEventType[cdeInputEventType["MOUSE"] = 1] = "MOUSE";
        cdeInputEventType[cdeInputEventType["TOUCH"] = 2] = "TOUCH";
        cdeInputEventType[cdeInputEventType["PEN"] = 3] = "PEN";
        cdeInputEventType[cdeInputEventType["ERASER"] = 4] = "ERASER";
        cdeInputEventType[cdeInputEventType["LEAP"] = 5] = "LEAP";
        cdeInputEventType[cdeInputEventType["KEYBOARD"] = 6] = "KEYBOARD";
        cdeInputEventType[cdeInputEventType["KINECT"] = 7] = "KINECT";
    })(cdeInputEventType = cdeNMI.cdeInputEventType || (cdeNMI.cdeInputEventType = {}));
    let cdeInputEvent;
    (function (cdeInputEvent) {
        cdeInputEvent[cdeInputEvent["IDLE"] = 0] = "IDLE";
        cdeInputEvent[cdeInputEvent["START"] = 1] = "START";
        cdeInputEvent[cdeInputEvent["MOVE"] = 2] = "MOVE";
        cdeInputEvent[cdeInputEvent["END"] = 3] = "END";
    })(cdeInputEvent = cdeNMI.cdeInputEvent || (cdeNMI.cdeInputEvent = {}));
    cdeNMI.TheEscapeMap = {
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        "\"": "&quot;",
        "'": '&#39',
    };
    //////////////////////////////////////////////////////////////////////////////
    /// Data Models
    //////////////////////////////////////////////////////////////////////////////
    /**
    ThePlanarImage is used to transfer blobs of Image Information to the C-DEngine NMI UX
    */
    class ThePlanarImage {
    }
    cdeNMI.ThePlanarImage = ThePlanarImage;
    class TheScreenTrans {
    }
    cdeNMI.TheScreenTrans = TheScreenTrans;
    class TheFLDOR {
    }
    cdeNMI.TheFLDOR = TheFLDOR;
    class TheFOR extends cde.TheMetaDataBase {
    }
    cdeNMI.TheFOR = TheFOR;
    class TheNMIScene extends cde.TheMetaDataBase {
    }
    cdeNMI.TheNMIScene = TheNMIScene;
    class TheNMIResource {
    }
    cdeNMI.TheNMIResource = TheNMIResource;
    class TheKey {
        constructor(pEvt) {
            if (!pEvt)
                return;
            this.altKey = pEvt.altKey;
            //this.Cchar = pEvt.char;
            this.charCode = pEvt.charCode;
            this.ctrlKey = pEvt.ctrlKey;
            this.key = pEvt.key;
            this.keyCode = pEvt.keyCode;
            //this.locale = pEvt.locale;
            this.location = pEvt.location;
            this.metaKey = pEvt.metaKey;
            this.repeat = pEvt.repeat;
            this.shiftKey = pEvt.shiftKey;
            this.which = pEvt.which;
            //this.JOYSTICK = pEvt.DOM_KEY_LOCATION_JOYSTICK;
            this.LEFT = pEvt.DOM_KEY_LOCATION_LEFT;
            //this.MOBILE = pEvt.DOM_KEY_LOCATION_MOBILE;
            this.NUMPAD = pEvt.DOM_KEY_LOCATION_NUMPAD;
            this.STANDARD = pEvt.DOM_KEY_LOCATION_STANDARD;
            this.RIGHT = pEvt.DOM_KEY_LOCATION_RIGHT;
            this.eventPhase = pEvt.eventPhase;
            this.isTrusted = pEvt.isTrusted;
            this.returnValue = pEvt.returnValue;
            this.timeStamp = pEvt.timeStamp;
            this.type = pEvt.type;
        }
    }
    cdeNMI.TheKey = TheKey;
    class TheDrawingPoint {
        constructor(x, y) {
            this.x = x ? x : 0;
            this.y = y ? y : 0;
            this.z = 0;
            this.t = 0;
        }
        toString() {
            return "X,Y,Z,T:" + this.x + "," + this.y + "," + this.z + ":t=" + this.t;
        }
    }
    cdeNMI.TheDrawingPoint = TheDrawingPoint;
    class ThePointer {
        constructor(pEle, pID, pX, pY, pZ, pStroke, pPointerType, pPointerEvent, pButtons) {
            this.Identifier = pID;
            this.Position = new TheDrawingPoint();
            this.Position.x = pX;
            this.Position.y = pY;
            this.Position.z = pZ;
            this.Position.t = pStroke;
            this.Shift = new TheDrawingPoint();
            this.AdjPosition = new TheDrawingPoint();
            this.StartPosition = new TheDrawingPoint();
            this.StartPosition.x = pX;
            this.StartPosition.y = pY;
            this.StartPosition.z = pZ;
            this.StartPosition.t = pStroke;
            this.pointerType = pPointerType;
            if (pPointerEvent)
                this.pointerEvent = pPointerEvent;
            else
                this.pointerEvent = cdeInputEvent.IDLE;
            this.Pressure = pStroke;
            this.Buttons = pButtons;
            this.Ele2DocPosition = ThePointer.ComputeDocumentToElementDelta(pEle);
            this.Update(pEle, this.Position);
        }
        Update(pControl, pPointer) {
            this.Shift.x = pPointer.x - this.Position.x;
            this.Shift.y = pPointer.y - this.Position.y;
            this.Shift.z = pPointer.z - this.Position.z;
            this.Shift.t = pPointer.t - this.Position.t;
            this.Position.x = pPointer.x;
            this.Position.y = pPointer.y;
            this.Position.z = pPointer.z;
            this.Position.t = pPointer.t;
            this.AdjPosition = ThePointer.targetRelativeX(pControl, this.Position, this.Ele2DocPosition);
            this.AdjPosition.t = pPointer.t;
            this.Pressure = pPointer.t;
            this.IsOnObject = true; // ThePointer.IsOnObject(pControl, this.Position, this.Ele2DocPosition); //V4.110: TODO find better algo..does not work right
        }
        static IsOnObject(tControl, t, pDocumentDelta) {
            const elementMouseIsOver = document.elementFromPoint(t.x, t.y);
            return (elementMouseIsOver === tControl);
        }
        static targetRelativeX(pControl, p, documentToTargetDelta) {
            const tRes = new TheDrawingPoint();
            tRes.x = Math.max(0, Math.min(p.x - documentToTargetDelta.x, pControl.offsetWidth));
            tRes.y = Math.max(0, Math.min(p.y - documentToTargetDelta.y, pControl.offsetHeight));
            return tRes;
        }
        //  we send target-relative coordinates to the draw functions
        //  this calculates the delta needed to convert pageX/Y to offsetX/Y because offsetX/Y don't exist in the TouchEvent object or in Firefox's MouseEvent object
        static ComputeDocumentToElementDelta(theElement) {
            const tPoint = new TheDrawingPoint();
            let HasFixedRoot = false;
            for (let offsetElement = theElement; offsetElement; offsetElement = offsetElement.offsetParent) {
                tPoint.x += offsetElement.offsetLeft;
                tPoint.y += offsetElement.offsetTop;
                const ol = offsetElement;
                if (ol.NMIControl && ol.NMIControl.ScreenScale) {
                    const sc = ol.NMIControl.ScreenScale;
                    if (sc != 0.0 && sc != 1.0) {
                        tPoint.x *= sc;
                        tPoint.y *= sc;
                    }
                }
                if (offsetElement.className && cde.MyBaseAssets.MyServiceHostInfo.WebPlatform === 0 && (offsetElement.className === 'cdeHeader'))
                    HasFixedRoot = true;
            }
            if (HasFixedRoot) {
                tPoint.x += window.pageXOffset;
                tPoint.y += window.pageYOffset;
            }
            return tPoint;
        }
        ///Need to remain here that Model does not require cdeNMIUtils
        PathLength() {
            return cdeNMI.Vector2Distance(this.StartPosition, this.Position);
        }
        PathAngle() {
            return cdeNMI.Vector2GetAngle(this.StartPosition, this.Position);
        }
        toString() {
            return "ID: " + this.Identifier + "CP:" + this.Position.toString() + " IP:" + this.StartPosition.toString() + " AP:" + this.AdjPosition.toString() + " Type:" + this.pointerType + " Event:" + this.pointerEvent;
        }
    }
    cdeNMI.ThePointer = ThePointer;
    /////////////////////////////////////////////////////////////
    /// NMI ViewModels
    /////////////////////////////////////////////////////////////
    class TheScreenInfo extends cde.TheMetaDataBase {
        constructor() {
            super(...arguments);
            this.MyStorageInfo = new Array();
            this.MyStorageMirror = [];
            this.MyStorageMeta = new Array();
        }
    }
    cdeNMI.TheScreenInfo = TheScreenInfo;
    class TheDashPanelInfo extends cde.TheThing {
    }
    cdeNMI.TheDashPanelInfo = TheDashPanelInfo;
    class TheDashboardInfo extends cde.TheThing {
    }
    cdeNMI.TheDashboardInfo = TheDashboardInfo;
    class TheFieldInfo extends cde.TheThing {
        constructor(pType, pWidth, pHeader, pFlags, pFormID, pBag) {
            super();
            this.Type = pType;
            if (pBag)
                this.PropertyBag = pBag;
            else
                this.PropertyBag = [];
            if (pHeader)
                this.PropertyBag.push("Title=" + pHeader);
            if (pWidth)
                this.PropertyBag.push("FldWidth=" + pWidth);
            if (pFlags)
                this.Flags = pFlags;
            if (pFormID)
                this.FormID = cde.GuidToString(pFormID);
        }
        static NewTFI(pType, pOrder, pHeader, pFlags, pBag) {
            const tTFI = new TheFieldInfo(pType, null, pHeader, pFlags, null, pBag);
            if (pOrder > 0)
                tTFI.FldOrder = pOrder;
            return tTFI;
        }
    }
    cdeNMI.TheFieldInfo = TheFieldInfo;
    class TheFormInfo extends cde.TheThing {
        constructor() {
            super(...arguments);
            this.DefaultView = 0;
            this.IsReadOnly = false;
            this.IsLiveData = false;
            this.IsAlwaysEmpty = false;
            this.IsPostingOnSubmit = false;
            this.IsUsingAbsolute = false;
            this.GetFromFirstNodeOnly = false;
            this.GetFromServiceOnly = false;
            this.IsGenerated = false;
            this.CurrentRow = 0; //New in 4.1 contains the Row of the table
        }
    }
    cdeNMI.TheFormInfo = TheFormInfo;
    class TheDrawingObject {
        constructor(pLeft, pTop) {
            this.Left = pLeft ? pLeft : 0;
            this.Top = pTop ? pTop : 0;
        }
    }
    cdeNMI.TheDrawingObject = TheDrawingObject;
    class TheComboLookup {
    }
    cdeNMI.TheComboLookup = TheComboLookup;
    class TheStrokePoint {
    }
    cdeNMI.TheStrokePoint = TheStrokePoint;
    class TheTRF {
        constructor(pTN, pRN, pFldInfo) {
            this.RowFilter = null;
            this.FldName = null;
            this.ModelID = null;
            this.RowID = null;
            this.TableName = pTN;
            this.RowNo = pRN;
            this.FldInfo = pFldInfo;
        }
        GetHash() {
            let ret = this.TableName + this.RowNo;
            if (this.FldInfo)
                ret += this.FldInfo.FldOrder;
            return ret;
        }
        GetDataRow() {
            try {
                if (cdeNMI.MyNMIModels[this.ModelID]) {
                    if (cdeNMI.MyNMIModels[this.ModelID].MyStorageMirror[this.TableName]) {
                        return cdeNMI.MyNMIModels[this.ModelID].MyStorageMirror[this.TableName][this.RowNo];
                    }
                }
            }
            catch (ex) {
                cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "TheTRF:GetDataRow", ex);
            }
            return null;
        }
        GetMID() {
            let tN = null;
            try {
                if (cdeNMI.MyNMIModels[this.ModelID]) {
                    if (cdeNMI.MyNMIModels[this.ModelID].MyStorageMirror[this.TableName]) {
                        if (cdeNMI.MyNMIModels[this.ModelID].MyStorageMirror[this.TableName][this.RowNo]) {
                            tN = cdeNMI.MyNMIModels[this.ModelID].MyStorageMirror[this.TableName][this.RowNo].cdeMID;
                        }
                    }
                }
            }
            catch (ex) {
                cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "TheTRF:GetMID", ex);
            }
            if (!tN && this.FldInfo)
                tN = this.FldInfo.cdeMID;
            return tN;
        }
        GetOwner() {
            let tN = null;
            try {
                if (cdeNMI.MyNMIModels[this.ModelID]) {
                    if (cdeNMI.MyNMIModels[this.ModelID].MyStorageMirror[this.TableName]) {
                        if (cdeNMI.MyNMIModels[this.ModelID].MyStorageMirror[this.TableName][this.RowNo]) {
                            tN = cdeNMI.MyNMIModels[this.ModelID].MyStorageMirror[this.TableName][this.RowNo].cdeO;
                        }
                    }
                }
            }
            catch (ex) {
                cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "TheTRF:GetMID", ex);
            }
            if (!tN && this.FldInfo)
                tN = this.FldInfo.cdeO;
            return tN;
        }
        GetNodeID() {
            let tN = null;
            try {
                if (cdeNMI.MyNMIModels[this.ModelID]) {
                    if (cdeNMI.MyNMIModels[this.ModelID].MyStorageMirror[this.TableName]) {
                        if (cdeNMI.MyNMIModels[this.ModelID].MyStorageMirror[this.TableName][this.RowNo]) {
                            tN = cdeNMI.MyNMIModels[this.ModelID].MyStorageMirror[this.TableName][this.RowNo].cdeN;
                            if (!tN) {
                                // WARNING: this is a fallback if the StorageMirror was not using TheMetaDataBase as base class and will not work Multi-Node! 
                                tN = cdeNMI.MyNMIModels[this.ModelID].cdeN;
                            }
                        }
                    }
                }
            }
            catch (ex) {
                cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "TheTRF:GetNodeID", ex);
            }
            if (!tN && this.FldInfo)
                tN = this.FldInfo.cdeN;
            return tN;
        }
        static SetFlagsOnly(pFlags) {
            return new cdeNMI.TheTRF("", 0, new cdeNMI.TheFieldInfo(cdeNMI.cdeControlType.BaseControl, 0, "", pFlags));
        }
        static FromScreenForm(tModel, tFormID) {
            const tFormInfo = (tModel && tModel.MyStorageMeta && tModel.MyStorageMeta[tFormID]) ? tModel.MyStorageMeta[tFormID] : null;
            const tTRF = new cdeNMI.TheTRF(tFormID, tFormInfo && tFormInfo.CurrentRow ? tFormInfo.CurrentRow : 0, null);
            tTRF.FldInfo = new TheFieldInfo(cdeControlType.BaseControl);
            if (tFormInfo) {
                switch (tFormInfo.DefaultView) {
                    case 0:
                        tTRF.FldInfo.Type = cdeControlType.Table;
                        break;
                    case 1:
                        tTRF.FldInfo.Type = cdeControlType.FormView;
                        break;
                    case 2:
                        tTRF.FldInfo.Type = cdeControlType.IFrameView;
                        break;
                }
                tTRF.FldInfo.cdeO = tFormInfo.cdeO;
                tTRF.FldInfo.cdeN = tFormInfo.cdeN;
                tTRF.FldInfo.cdeMID = tFormInfo.cdeMID;
            }
            return tTRF;
        }
        static GetTRF(pModelID, pDef) {
            if (!pDef || !pDef.TableName)
                return null;
            if (!pModelID)
                pModelID = cde.MyBaseAssets.MyServiceHostInfo.PortalScreen;
            pModelID = cde.GuidToString(pModelID);
            const tModel = cdeNMI.MyNMIModels[pModelID];
            if (!tModel || tModel.MyStorageMirror[pDef.TableName])
                return null;
            const tRow = pDef.RowNo;
            if (pDef.RowFilter) {
                // do nothing
            }
            return tModel.MyStorageMirror[pDef.TableName][tRow][pDef.FldName];
        }
    }
    cdeNMI.TheTRF = TheTRF;
    class TheNMISettings {
        constructor() {
            this.TileMargin = 1;
            this.IsInEdit = false;
            this.IDCounter = 1;
            this.StrokeSize = 0.3;
            this.DeadPathLength = 40;
            this.SupportsMouse = false;
            this.SupportsTouch = false;
            this.SupportsPointer = false;
            this.SupportsTouchForce = false;
            this.SupportsTouchForceChange = false;
            this.mIsScrolling = false;
            if (typeof Touch !== 'undefined') {
                // In Android, new Touch requires arguments.
                try {
                    if (Touch.prototype.hasOwnProperty('force') || 'force' in new Touch(null)) {
                        this.SupportsTouchForce = true;
                    }
                }
                catch (e) {
                    //ignored
                }
            }
            this.SupportsTouch = 'ontouchstart' in window.document && this.SupportsTouchForce;
            this.SupportsMouse = 'onmousemove' in window.document && !this.SupportsTouch;
            this.SupportsPointer = 'onpointermove' in window.document;
            this.SupportsTouchForceChange = 'ontouchforcechange' in window.document;
        }
        set IsScrolling(value) {
            this.mIsScrolling = value;
            if (value === true)
                this.mLastScrollTime = new Date().getTime();
        }
        get IsScrolling() {
            const Res = this.mLastScrollTime && new Date().getTime() < this.mLastScrollTime + 500;
            this.mIsScrolling = cde.CBool(Res);
            return Res;
        }
    }
    cdeNMI.TheNMISettings = TheNMISettings;
    cdeNMI.MyNMISettings = new TheNMISettings();
    class TheNavHistory {
    }
    cdeNMI.TheNavHistory = TheNavHistory;
    class TheFlashCache {
        static AddCache(pName, pValue, exp) {
            if (cdeNMI.MyFlashCache[pName]) {
                cdeNMI.MyFlashCache[pName].Value = pValue;
                cdeNMI.MyFlashCache[pName].Stamp = Math.ceil((new Date()).getTime() - (new Date(2014, 4, 1)).getTime());
                return;
            }
            const tSt = new cdeNMI.TheFlashCache();
            tSt.Value = pValue;
            tSt.Stamp = Math.ceil((new Date()).getTime() - (new Date(2014, 4, 1)).getTime());
            if (exp)
                tSt.Exp = exp;
            else
                tSt.Exp = 3000;
            cdeNMI.MyFlashCache[pName] = tSt;
        }
        static GetCache(pName) {
            if (!cdeNMI.MyFlashCache[pName])
                return null;
            if (Math.ceil((new Date()).getTime() - (new Date(2014, 4, 1)).getTime()) - cdeNMI.MyFlashCache[pName].Stamp > cdeNMI.MyFlashCache[pName].Exp) {
                //cdeNMI.MyFlashCache.splice(cdeNMI.MyFlashCache.findIndex(cdeNMI.MyFlashCache[pName]), 1);   //V4.110:TODO ES5/ES6 incompat Test this NOT SUPPORTED IN ES5
                return null;
            }
            return cdeNMI.MyFlashCache[pName].Value;
        }
        static FlushCache() {
            cdeNMI.MyFlashCache = [];
        }
    }
    cdeNMI.TheFlashCache = TheFlashCache;
    cdeNMI.MyFlashCache = [];
    class TheNodeInfo extends cde.TheMetaDataBase {
    }
    cdeNMI.TheNodeInfo = TheNodeInfo;
    class TheControlBlock {
    }
    cdeNMI.TheControlBlock = TheControlBlock;
    cdeNMI.MyTCBs = [];
    class TheFaceWait {
    }
    cdeNMI.TheFaceWait = TheFaceWait;
    class TheNMIC {
    }
    cdeNMI.TheNMIC = TheNMIC;
    class TheComboOption {
    }
    cdeNMI.TheComboOption = TheComboOption;
    class ThePB {
        static GetPropNameFromBag(pBag, bDontTrim) {
            let ePos = pBag.indexOf("=");
            if (ePos < 0) {
                ePos = pBag.length;
            }
            if (cde.CBool(bDontTrim))
                return pBag.substring(0, ePos);
            return pBag.substring(0, ePos).trim();
        }
        static RemoveProperty(pBag, pName) {
            if (pBag && pBag.length > 0) {
                for (let jj = 0; jj < pBag.length; jj++) {
                    const ePos = pBag[jj].indexOf("=");
                    if (ePos >= 0) {
                        const tPropName = pBag[jj].substring(0, ePos).trim();
                        if (tPropName === pName) {
                            pBag.splice(jj, 1);
                            return;
                        }
                    }
                }
            }
        }
        static UpdateProperty(pBag, pName, pValue) {
            if (!pBag)
                return;
            if (pBag && pBag.length > 0) {
                for (let jj = 0; jj < pBag.length; jj++) {
                    const ePos = pBag[jj].indexOf("=");
                    if (ePos >= 0) {
                        const tPropName = pBag[jj].substring(0, ePos).trim();
                        if (tPropName === pName) {
                            pBag[jj] = pName + "=" + pValue;
                            return;
                        }
                    }
                }
            }
        }
        static GetValueFromBagByName(pBag, pName, bDontTrim) {
            if (pBag && pBag.length > 0) {
                for (const element of pBag) {
                    const ePos = element.indexOf("=");
                    if (ePos >= 0) {
                        const tPropName = element.substring(0, ePos).trim();
                        const tProValue = (bDontTrim === true ? element.substring(ePos + 1) : element.substring(ePos + 1).trim());
                        if (tPropName === pName)
                            return tProValue;
                    }
                }
            }
            return null;
        }
        // Has to stay any for any field with a PropertyBag
        static ConvertPropertiesFromBag(tFldInfo, pBag) {
            if (!tFldInfo)
                return;
            if (!tFldInfo.PropertyBag)
                tFldInfo.PropertyBag = [];
            for (const element of tFldInfo.PropertyBag) {
                this.ConvertBagToSettings(tFldInfo, element);
            }
            if (pBag) {
                for (const element of pBag) {
                    this.ConvertBagToSettings(tFldInfo, element);
                }
            }
        }
        static ConvertBagToSettings(pFldInfo, pBagString) {
            if (!pFldInfo || !pBagString)
                return;
            let ePos = pBagString.indexOf("=");
            let bHasValue = true;
            if (ePos < 0) {
                ePos = pBagString.length;
                bHasValue = false;
            }
            let tPropName = pBagString.substring(0, ePos).trim();
            if (tPropName === "Value")
                tPropName = "iValue";
            if (bHasValue) {
                const tProValue = pBagString.substring(ePos + 1).trim();
                if (tPropName === 'Flags' || tPropName === 'FldOrder' || tPropName === 'ACL')
                    pFldInfo[tPropName] = cde.CInt(tProValue);
                else
                    pFldInfo[tPropName] = tProValue;
            }
            else
                pFldInfo[tPropName] = true;
        }
        static SetPropertiesFromBag(pCtrl, pBag, pRow, pIsLive, pIsInTable) {
            if (!pBag || !pCtrl)
                return;
            for (const element of pBag) {
                let ePos = element.indexOf("=");
                let bHasValue = true;
                if (ePos < 0) {
                    ePos = element.length;
                    bHasValue = false;
                }
                let tPropName = element.substring(0, ePos).trim();
                if (tPropName === "Value")
                    tPropName = "iValue";
                if (cde.CBool(pIsInTable) && (tPropName === "TileWidth" || tPropName === "TileLeft" || tPropName === "TileTop" || tPropName === "IsAbsolute"))
                    continue;
                if (pCtrl.MyBaseType === cdeControlType.TileEntry && (tPropName.toLowerCase() === "onthingevent"))
                    continue;
                let tProValue = "";
                try {
                    if (bHasValue) {
                        tProValue = element.substring(ePos + 1).trim();
                        cdeNMI.ThePB.SetRawProperty(pCtrl, tPropName, tProValue, pRow, pIsLive);
                    }
                    else {
                        pCtrl.SetProperty(tPropName, true);
                    }
                }
                catch (except) {
                    cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "ThePB:SetPropertyFromBag", "SetPropertyFromBag failed to SetP on " + tPropName + " to " + tProValue);
                }
            }
        }
        static SetRawProperty(pCtrl, tPropName, pProValue, pRow, pIsLive) {
            if (!tPropName)
                return;
            let tProValue = pProValue;
            if (!tProValue)
                tProValue = "";
            switch (tPropName.toLowerCase()) {
                case "onthingevent":
                    try {
                        let tEvParts;
                        if (pIsLive)
                            tEvParts = tProValue.split(';');
                        else
                            tEvParts = cdeNMI.GenerateFinalString(tProValue, pRow).split(';');
                        pCtrl.RegisterThingSetP(tEvParts[0], tEvParts[1]);
                    }
                    catch (e) {
                        //ignored
                    }
                    break;
                default:
                    if (tPropName !== "HTML" && tPropName !== "OnClick" && tProValue.indexOf("<%") >= 0 && tProValue.indexOf("%>") >= 0) {
                        tProValue = cdeNMI.GenerateFinalString(tProValue, pRow);
                        pCtrl.SetDataItem(tPropName, tProValue);
                    }
                    else {
                        if (tProValue && tProValue.indexOf('%') >= 0) {
                            tProValue = cdeNMI.GenerateFinalString(tProValue, pRow, null, true);
                        }
                        pCtrl.SetProperty(tPropName, tProValue);
                    }
                    break;
            }
        }
        static GetSetting(pFieldInfo, pName) {
            let res = null;
            if (pFieldInfo) {
                res = pFieldInfo[pName];
                if (!res && pFieldInfo.PropertyBag)
                    res = cdeNMI.ThePB.GetValueFromBagByName(pFieldInfo.PropertyBag, pName);
            }
            return res;
        }
    }
    cdeNMI.ThePB = ThePB;
    class TheLanguageResource {
        constructor() {
            this.LCID = 0;
            this.MyResources = {};
        }
    }
    cdeNMI.TheLanguageResource = TheLanguageResource;
    class TheLocalizer extends cde.TheDataBase {
        constructor() {
            super(...arguments);
            this.LocalResources = new TheLanguageResource();
            this.mRequestedLCID = 0;
        }
        SetLCID(pLCID) {
            if (pLCID !== this.LocalResources.LCID) {
                this.mRequestedLCID = pLCID;
                if (pLCID === 1033) {
                    this.LocalResources = new TheLanguageResource();
                    this.LocalResources.LCID = pLCID;
                }
                else {
                    this.GetResources();
                    return;
                }
            }
            this.FireEvent(true, "OnLCIDChanged", this.LocalResources.LCID);
        }
        GetCurrentLCID() {
            return this.LocalResources.LCID;
        }
        GetResources() {
            if (this.mRequestedLCID > 0 && this.mRequestedLCID !== 1033) {
                if (cdeNMI.MyEngine) {
                    cdeNMI.MyEngine.cdeGetResource("Lang/NMIlang" + cde.CStr(this.mRequestedLCID) + ".json", (c, t) => { this.SetResources(t); }, null, 3000);
                    return;
                }
            }
            this.FireEvent(true, "OnLCIDChanged", this.LocalResources.LCID);
        }
        SetResources(pT) {
            if (pT && pT !== "TIMEOUT" && pT !== "Not Found") {
                try {
                    const pDATA = JSON.parse(pT);
                    if (this.mRequestedLCID === pDATA.LCID) {
                        for (const idx in pDATA.MyResources) {
                            this.LocalResources.MyResources[idx] = pDATA.MyResources[idx];
                        }
                        this.LocalResources.LCID = pDATA.LCID;
                    }
                }
                catch (e) {
                    cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "cdeNMI:SetResource", "failed with " + e + ":" + e.stack);
                }
            }
            this.FireEvent(true, "OnLCIDChanged", this.LocalResources.LCID);
        }
        SaveResources() {
            const tS = JSON.stringify(this.LocalResources);
            if (cde.MyContentEngine)
                cde.MyContentEngine.SaveFile(tS, "NMIlang" + this.LocalResources.LCID + ".json", "application/json", false);
        }
        T(pKEY) {
            if (typeof pKEY !== "string" || !pKEY || pKEY === "")
                return "";
            pKEY = pKEY.replace('&nbsp;', ' ');
            if (this.LocalResources.MyResources[pKEY])
                return cdeNMI.IconFAShim(this.LocalResources.MyResources[pKEY]);
            else {
                if (cde.MyBaseAssets.MyServiceHostInfo.RedPill && !pKEY.startsWith("(Waiting for control #"))
                    this.LocalResources.MyResources[pKEY] = pKEY; // pKEY;
                return cdeNMI.IconFAShim(pKEY);
            }
        }
    }
    cdeNMI.TheLocalizer = TheLocalizer;
    cdeNMI.TL = new TheLocalizer();
})(cdeNMI || (cdeNMI = {}));
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
var cdeNMI;
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
(function (cdeNMI) {
    class TheControlFactory extends cde.TheMetaDataBase {
        constructor() {
            super();
            this.cdeControlTypeNames = new Array();
            this.MyNMIControls = [];
            this.MyKnownControls = new Array();
            //////////////////////////////////////////////////////////////////////////////
            /// NMI Lazy Control Loader
            //////////////////////////////////////////////////////////////////////////////
            this.MyLazyCallbacks = [];
            this.stringToFunction = function (str) {
                const arr = str.split(".");
                const fn = (window);
                let outFn = fn;
                for (let i = 0, len = arr.length; i < len; i++) {
                    outFn = outFn[arr[i]];
                }
                if (typeof outFn !== "function") {
                    throw new Error("function not found");
                }
                return outFn;
            };
            this.cdeControlTypeNames[0] = "cdeNMI.TheNMIBaseControl";
            this.cdeControlTypeNames[1] = "cdeNMI.ctrlEditBox";
            this.cdeControlTypeNames[2] = "cdeNMI.ctrlComboBox";
            //Radion coming soon
            this.cdeControlTypeNames[4] = "cdeNMI.ctrlCheckBox";
            this.cdeControlTypeNames[5] = "cdeNMI.ctrlEditBox";
            this.cdeControlTypeNames[6] = "cdeNMI.ctrlComboBox";
            this.cdeControlTypeNames[7] = "cdeNMI.ctrlComboBox";
            this.cdeControlTypeNames[8] = "cdeNMI.ctrlDateTimePicker"; //TODO: New Time Picker
            this.cdeControlTypeNames[9] = "cdeNMI.ctrlDateTimePicker"; //TODO: New TimeSpan Picker
            this.cdeControlTypeNames[10] = "cdeNMI.ctrlEditBox";
            this.cdeControlTypeNames[11] = "cdeNMI.ctrlTileButton"; //11: Submit Button Retired
            this.cdeControlTypeNames[12] = "cdeNMI.ctrlEditBox";
            this.cdeControlTypeNames[13] = "cdeNMI.ctrlComboBox";
            this.cdeControlTypeNames[14] = "cdeNMI.ctrlComboBox";
            this.cdeControlTypeNames[15] = "cdeNMI.ctrlComboBox";
            this.cdeControlTypeNames[16] = "cdeNMI.ctrlEditBox";
            this.cdeControlTypeNames[17] = "cdeNMI.ctrlComboBox"; //Todo:Combo Option
            this.cdeControlTypeNames[18] = "cdeNMI.ctrlDateTimePicker";
            this.cdeControlTypeNames[20] = "cdeNMI.ctrlSmartLabel";
            this.cdeControlTypeNames[21] = "cdeNMI.ctrlDateTimePicker"; //TODO: Time Picker
            this.cdeControlTypeNames[22] = "cdeNMI.ctrlTileButton";
            this.cdeControlTypeNames[23] = "cdeNMI.ctrlTableView";
            this.cdeControlTypeNames[24] = "cdeNMI.ctrlCheckField";
            this.cdeControlTypeNames[26] = "cdeNMI.TheNMIScreen";
            this.cdeControlTypeNames[28] = "cdeNMI.ctrlTileEntry";
            this.cdeControlTypeNames[29] = "cdeNMI.ctrlZoomImage";
            this.cdeControlTypeNames[30] = "cdeNMI.ctrlCanvasDraw";
            this.cdeControlTypeNames[31] = "cdeNMI.ctrlEditBox";
            this.cdeControlTypeNames[32] = "cdeNMI.ctrlEditBox";
            this.cdeControlTypeNames[33] = "cdeNMI.ctrlEndlessSlider";
            this.cdeControlTypeNames[34] = "cdeNMI.ctrlBarChart";
            this.cdeControlTypeNames[35] = "cdeNMI.TheToast";
            this.cdeControlTypeNames[36] = "cdeNMI.ctrlTouchDraw";
            this.cdeControlTypeNames[37] = "cdeNMI.ThePopup";
            this.cdeControlTypeNames[38] = "cdeNMI.ctrlDrawOverlay";
            this.cdeControlTypeNames[40] = "cdeNMI.ctrlDropUploader";
            this.cdeControlTypeNames[41] = "cdeNMI.ctrlRevealButton";
            this.cdeControlTypeNames[42] = "cdeNMI.ctrlPinButton";
            this.cdeControlTypeNames[44] = "cdeNMI.TheDashboard";
            this.cdeControlTypeNames[45] = "cdeNMI.ctrlFormView";
            this.cdeControlTypeNames[46] = "cdeNMI.ctrlTouchOverlay";
            this.cdeControlTypeNames[47] = "cdeNMI.ctrlMoTLock";
            this.cdeControlTypeNames[48] = "cdeNMI.ctrlProgressBar";
            this.cdeControlTypeNames[49] = "cdeNMI.ctrlTileGroup";
            this.cdeControlTypeNames[50] = "cdeNMI.ctrlVideoViewer";
            this.cdeControlTypeNames[53] = "cdeNMI.ctrlEditBox";
            this.cdeControlTypeNames[54] = "cdeNMI.ctrlShape";
            this.cdeControlTypeNames[55] = "cdeNMI.ctrlCollapsibleGroup";
            this.cdeControlTypeNames[56] = "cdeNMI.ctrlAboutButton";
            this.cdeControlTypeNames[57] = "cdeNMI.ctrlStatusLight";
            this.cdeControlTypeNames[58] = "cdeNMI.ctrlFacePlate";
            this.cdeControlTypeNames[59] = "cdeNMI.TheLoginScreen";
            this.cdeControlTypeNames[60] = "cdeNMI.TheShapeRecognizer";
            this.cdeControlTypeNames[61] = "cdeNMI.TheScreenManager";
            this.cdeControlTypeNames[62] = "cdeNMI.ctrlLogoButton";
            this.cdeControlTypeNames[63] = "cdeNMI.ctrlThingPicker"; //ThingPicker
            this.cdeControlTypeNames[64] = "cdeNMI.ctrlImageSlider2";
            this.cdeControlTypeNames[65] = "cdeNMI.ctrlCircularGauge2";
            this.cdeControlTypeNames[66] = "cdeNMI.ctrlSmartGauge2";
            this.cdeControlTypeNames[67] = "cdeNMI.ctrlIFrameView";
            this.cdeControlTypeNames[68] = "cdeNMI.ctrlPropertyPicker"; //Goes to PropertyPickerCtrl control
            this.cdeControlTypeNames[69] = "cdeNMI.ctrlPropertyPicker"; //The real Property Picker (no edit Box);
            this.cdeControlTypeNames[70] = "cdeNMI.ctrlToolTip";
            this.cdeControlTypeNames[71] = "cdeNMI.ctrlComboLookup";
            this.cdeControlTypeNames[72] = "cdeNMI.ctrlUserMenu";
            this.cdeControlTypeNames[73] = "cdeNMI.ctrlMeshPicker";
            this.cdeControlTypeNames[74] = "cdeNMI.ctrlHashIcon";
            this.cdeControlTypeNames[75] = "cdeNMI.ctrlCertPicker";
            this.cdeControlTypeNames[76] = "cdeNMI.ctrlDeviceTypePicker";
            this.MyKnownControls[0] = "CMyDashboard";
            this.MyKnownControls[1] = "CMyChart";
            this.MyKnownControls[2] = "CMyTable";
            this.MyKnownControls[3] = "CMyForm";
            this.MyKnownControls[4] = "CMyData";
            this.MyKnownControls[5] = "CMyHTML";
            this.MyKnownControls[6] = "CMySCRIPT";
            this.MyKnownControls[7] = "CMyInfo";
            this.MyKnownControls[8] = "CMyNavigator";
            this.MyKnownControls[9] = "CMyLiveScreen";
            this.MyKnownControls[10] = "CMyIFrame";
            this.MyNMIControls["TABLES"] = [];
        }
        //Required to register customer controls
        InitTCF() {
            this.FireEvent(true, "ControlTypeFactory_Ready");
        }
        RegisterKnownControl(pIDX, pName) {
            this.MyKnownControls[pIDX] = pName;
        }
        IsControlNameKnown(pName) {
            return cdeNMI.DoesArrayContain(this.MyKnownControls, pName);
        }
        RegisterControl(pGroup, pID, pCtrl) {
            if (!this.MyNMIControls[pGroup])
                this.MyNMIControls[pGroup] = [];
            if (pID && pCtrl)
                this.MyNMIControls[pGroup][pID] = pCtrl;
        }
        DeleteRegisteredControl(pGroup, pID) {
            if (this.MyNMIControls[pGroup] && this.MyNMIControls[pGroup][pID])
                delete this.MyNMIControls[pGroup][pID];
        }
        GetRegisteredControl(pGroup, pID) {
            if (this.MyNMIControls[pGroup] && this.MyNMIControls[pGroup][pID])
                return this.MyNMIControls[pGroup][pID];
            return null;
        }
        GetRegisteredControlGroup(pGroup) {
            if (this.MyNMIControls[pGroup])
                return this.MyNMIControls[pGroup];
            return null;
        }
        UnregisterControl(tOWN, pID) {
            tOWN = cde.GuidToString(tOWN);
            pID = cde.GuidToString(pID);
            //if (this.MyNMIControls[tOWN] && this.MyNMIControls[tOWN][pID]) {
            const tc = this.GetRegisteredControl(tOWN, pID); // this.MyNMIControls[tOWN][pID];
            if (tc) {
                if (cdeNMI.MyEngine) {
                    const tThingOwn = cde.GuidToString(tc.GetProperty("MyThing"));
                    if (cdeNMI.MyNMIThingEvents[tThingOwn] && cdeNMI.MyNMIThingEvents[tThingOwn][pID])
                        delete cdeNMI.MyNMIThingEvents[tThingOwn][pID];
                }
                //delete this.MyNMIControls[tOWN][pID];
                this.DeleteRegisteredControl(tOWN, pID);
            }
            //}
        }
        IsComboBased(pFldType) {
            switch (pFldType) {
                case 2:
                case 6:
                case 7:
                case 8:
                case 9:
                case 13:
                case 14:
                case 15:
                case 17:
                case 18:
                case 21:
                    return true;
            }
            return false;
        }
        IsTypeNumeric(pFldType) {
            switch (pFldType) {
                case 12:
                    return true;
            }
            return false;
        }
        RegisterControlType(pCType, pTypeName) {
            this.cdeControlTypeNames[pCType] = pTypeName;
        }
        GetControlByName(pCTYpe) {
            if (!this.cdeControlTypeNames[pCTYpe])
                return null;
            else
                return this.cdeControlTypeNames[pCTYpe];
        }
        RegisterControlName(pCType, pTypeName) {
            this.cdeControlTypeNames[pCType] = pTypeName;
        }
        GetControlType(pCTYpe) {
            if (!this.cdeControlTypeNames[pCTYpe])
                return this.cdeControlTypeNames[0];
            else
                return this.cdeControlTypeNames[pCTYpe];
        }
        FireLazyCreate(pEngineName, pTargetControl = null, IsRecurse = false) {
            if (!pEngineName || !this.MyLazyCallbacks[pEngineName])
                return;
            for (let mh = this.MyLazyCallbacks[pEngineName].length - 1; mh >= 0; mh--) {
                if (this.MyLazyCallbacks[pEngineName][mh].CallBack) {
                    if (this.CreateControlLazy(this.MyLazyCallbacks[pEngineName][mh].TargetControl, pEngineName, this.MyLazyCallbacks[pEngineName][mh].ControlType, this.MyLazyCallbacks[pEngineName][mh].CallBack, this.MyLazyCallbacks[pEngineName][mh].Cookie))
                        this.MyLazyCallbacks[pEngineName].splice(mh, 1);
                }
            }
            if (!IsRecurse && this.MyLazyCallbacks[pEngineName].length > 0)
                this.FireLazyCreate(pEngineName, pTargetControl, true);
        }
        CreateNMIControl(pControlType, bReturnNull = false) {
            if (!this.cdeControlTypeNames[pControlType] || this.cdeControlTypeNames[pControlType] === '') {
                cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "cdeNMI:CreateNMIControl", "Unkown Control Type specified: " + pControlType);
                if (bReturnNull)
                    return null;
                return this.CreateBaseControl();
            }
            let tControl = this.CreateControlLazy(null, cdeNMI.eTheNMIEngine, this.cdeControlTypeNames[pControlType], this.CreateNMICallback, null);
            if (!tControl) {
                if (bReturnNull)
                    return null;
                cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "cdeNMI:CreateNMIControlAsync", "Control Type specified not found: " + pControlType);
                tControl = this.CreateBaseControl();
            }
            return tControl;
        }
        CreateBaseControl() {
            try {
                return new cdeNMI[this.cdeControlTypeNames[0].split('.')[1]]();
            }
            catch (_a) {
                //ignored
            }
            return null;
        }
        CreateNMICallback() {
            //TODO: Later replace dummy with real control
        }
        CreateNMIControlAsync(pTargetControl, pControlType, callback) {
            if (!this.cdeControlTypeNames[pControlType]) {
                cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "cdeNMI:CreateNMIControlAsync", "Unkown Control Type specified: " + pControlType);
                return null;
            }
            return this.CreateControlLazy(pTargetControl, cdeNMI.eTheNMIEngine, this.cdeControlTypeNames[pControlType], callback, null);
        }
        CreateControlLazy(pTargetControl, pEngineName, pControlType, callback, cookie) {
            let tResControl = null;
            let bSuccess = false;
            if (pControlType && pControlType.length > 0) {
                try {
                    const mClass = this.stringToFunction(pControlType);
                    tResControl = new mClass();
                    bSuccess = true;
                    tResControl.MyParentCtrl = pTargetControl;
                    if (callback)
                        callback(pTargetControl, tResControl, cookie);
                }
                catch (e) {
                    cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "cdeNMI:CreateControlLazy", "LazyLoad failed:(" + pControlType + ") " + e + ":" + e.stack);
                }
            }
            else {
                return null;
            }
            if (!bSuccess && pEngineName && callback) {
                if (!this.MyLazyCallbacks[pEngineName]) {
                    this.MyLazyCallbacks[pEngineName] = [];
                    if (!cde.MyBaseAssets.MyEngines[pEngineName] && cdeNMI.MyEngine)
                        cdeNMI.MyEngine.PublishToNMI("NMI_GET_ENGINEJS", pEngineName);
                }
                let HasCallback = false;
                for (let mh = 0; mh < this.MyLazyCallbacks[pEngineName].length; mh++) {
                    if (this.MyLazyCallbacks[pEngineName][mh].Cookie === cookie) {
                        HasCallback = true;
                        break;
                    }
                }
                if (!HasCallback)
                    this.MyLazyCallbacks[pEngineName].push({ ControlType: pControlType, TargetControl: pTargetControl, CallBack: callback, Cookie: cookie });
            }
            return tResControl;
        }
        SetControlEssentials(pTEControl, pTgtControl, pTEControlMyTRF) {
            //var pTEControl: ctrlTileEntry = this;
            if (!pTEControl)
                return;
            if (!pTEControlMyTRF)
                pTEControlMyTRF = pTEControl.MyTRF;
            if (!pTEControlMyTRF)
                return;
            try {
                let tFldInfo = pTEControlMyTRF.FldInfo;
                let tScreenInfo = null;
                if (cdeNMI.MyEngine)
                    tScreenInfo = cdeNMI.MyNMIModels[pTEControlMyTRF.ModelID];
                if (!tFldInfo && pTEControl)
                    tFldInfo = pTEControl.MyFieldInfo;
                if (pTEControl !== pTgtControl) {
                    pTEControl.MyNMIControl = pTgtControl;
                    pTEControl.MyTEContent.AppendChild(pTEControl.MyNMIControl);
                    if (pTgtControl.MyBaseType === cdeNMI.cdeControlType.Table) //Possibly remove other control types from further processing
                        return;
                    //ID Management
                    const tID = pTEControl.GetProperty("ID");
                    const tOldID = pTgtControl.GetProperty("ID");
                    pTgtControl.SetProperty("ID", tID);
                    cdeNMI.MyTCF.UnregisterControl(tID, tOldID);
                    if (!pTgtControl.MyTRF)
                        pTgtControl.MyTRF = pTEControlMyTRF;
                    if (!pTgtControl.MyFieldInfo) {
                        pTgtControl.MyFieldInfo = pTEControl.MyFieldInfo;
                    }
                    //Size Management
                    if (!cde.IsNotSet(pTgtControl.GetProperty("NoTE")))
                        pTEControl.SetProperty("NoTE", pTgtControl.GetProperty("NoTE"));
                    if (!cde.IsNotSet(pTgtControl.GetProperty("UseTE")))
                        pTEControl.SetProperty("UseTE", pTgtControl.GetProperty("UseTE"));
                    if (!cde.IsNotSet(pTgtControl.GetProperty("TileFactorX")))
                        pTEControl.SetProperty("TileFactorX", pTgtControl.GetProperty("TileFactorX"));
                    if (!cde.IsNotSet(pTgtControl.GetProperty("TileFactorY")))
                        pTEControl.SetProperty("TileFactorY", pTgtControl.GetProperty("TileFactorY"));
                    if (!cde.CBool(pTEControl.GetProperty("IsInTable"))) {
                        pTEControl.SetProperty("MinTileWidth", pTgtControl.GetProperty("MinTileWidth"));
                        pTEControl.SetProperty("MinTileHeight", pTgtControl.GetProperty("MinTileHeight"));
                        if (cde.CInt(pTgtControl.GetProperty("TileWidth")) > 0)
                            pTEControl.SetProperty("TileWidth", pTgtControl.GetProperty("TileWidth"));
                        if (cde.CInt(pTgtControl.GetProperty("TileHeight")) > 0)
                            pTEControl.SetProperty("TileHeight", pTgtControl.GetProperty("TileHeight"));
                        if (cde.CBool(pTgtControl.GetProperty("ShowOverflow")))
                            pTEControl.MyTEContainer.GetElement().style.overflow = "initial";
                        pTgtControl.SetProperty("ControlTW", cde.CInt(pTEControl.GetProperty("ControlTW")));
                        pTgtControl.SetProperty("ControlTH", cde.CInt(pTEControl.GetProperty("ControlTH")));
                    }
                }
                pTgtControl.RegisterNMIControl();
                if (tFldInfo && tFldInfo.DataItem) {
                    pTgtControl.SetProperty("DataItem", tFldInfo.DataItem);
                }
                let tDataRow = null;
                if (tScreenInfo && tScreenInfo.MyStorageMirror[pTEControlMyTRF.TableName]) {
                    tDataRow = tScreenInfo.MyStorageMirror[pTEControlMyTRF.TableName][pTgtControl.MyTRF ? pTgtControl.MyTRF.RowNo : 0];
                    let tFldContentLC = cdeNMI.GetFldContent(tDataRow, pTgtControl.MyFieldInfo, tScreenInfo.IsGenerated);
                    if (!cde.IsNotSet(tFldContentLC)) {
                        if (pTgtControl.MyFieldInfo && pTgtControl.MyFieldInfo.Type === cdeNMI.cdeControlType.Picture && tFldContentLC && tFldContentLC.length > 255)
                            tFldContentLC = "data:image/jpeg;base64," + tFldContentLC;
                        pTgtControl.SetProperty("iValue", tFldContentLC);
                    }
                    tFldInfo["OnClick"] = cdeNMI.GenerateFinalString(tFldInfo["OnClick"], tDataRow);
                    cdeNMI.ThePB.SetRawProperty(pTgtControl, "OnThingEvent", tFldInfo["OnThingEvent"], tDataRow, tScreenInfo.IsLiveForm);
                }
                else {
                    if (tFldInfo["OnThingEvent"] && tScreenInfo.IsLiveForm === true)
                        cdeNMI.ThePB.SetRawProperty(pTgtControl, "OnThingEvent", tFldInfo["OnThingEvent"], null, tScreenInfo.IsLiveForm);
                    if (tFldInfo["DefaultValue"] && !pTgtControl.GetProperty("Value"))
                        pTgtControl.SetProperty("iValue", tFldInfo["DefaultValue"]);
                }
                tFldInfo["Title"] = cdeNMI.GenerateFinalString(tFldInfo["Title"], tDataRow);
                if (!cde.CBool(pTEControl.GetProperty("IsInTable")) &&
                    !cde.CBool(tFldInfo["IsInTable"])) {
                    if (tFldInfo["Options"])
                        tFldInfo["OptionsLive"] = cdeNMI.GenerateFinalString(tFldInfo["Options"], tDataRow);
                    if (tFldInfo && tFldInfo.PropertyBag && tFldInfo.PropertyBag.length > 0) {
                        cdeNMI.ThePB.SetPropertiesFromBag(pTEControl, tFldInfo.PropertyBag, (tScreenInfo && tScreenInfo.MyStorageMirror[pTEControlMyTRF.TableName]) ? tScreenInfo.MyStorageMirror[pTEControlMyTRF.TableName][pTgtControl.MyTRF ? pTgtControl.MyTRF.RowNo : 0] : null, tScreenInfo ? tScreenInfo.IsLiveForm : false, cde.CBool(pTEControl.GetProperty("IsInTable")));
                    }
                    if (tScreenInfo && pTEControlMyTRF.FldInfo) {
                        const tFormInfo = tScreenInfo.MyStorageMeta[cde.GuidToString(pTEControlMyTRF.FldInfo.FormID)];
                        if (tFormInfo && tFormInfo.IsUsingAbsolute && cde.CInt(tFldInfo["ParentFld"]) === 0) {
                            pTEControl.SetProperty("IsAbsolute", true);
                        }
                    }
                    if (pTEControl.GetProperty("RenderTarget")) {
                        const tTarget = cdeNMI.GenerateFinalString(pTEControl.GetProperty("RenderTarget"), false, pTEControl.MyTRF); //.replace("%ID%", this.GetProperty("ID"));
                        pTEControl.FindRenderTarget(tTarget);
                    }
                }
                pTgtControl.SetProperty("TabIndex", !pTgtControl.MyTarget || cde.CBool(pTgtControl.MyTarget.GetProperty("IsUnloaded")) ? -1 : tFldInfo.FldOrder);
                const tPos = pTgtControl.MyTarget.MyChildren.indexOf(pTgtControl);
                if (tPos >= 0)
                    pTgtControl.MyTarget.MyChildren.splice(tPos, 1);
                pTgtControl.MyTarget.MyChildren.push(pTgtControl);
                pTgtControl.ApplySkin();
            }
            catch (eee) {
                cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "TileEntry:SetControlEssentials", eee.message + ":" + eee.stack);
                if (pTEControl)
                    pTEControl.SetProperty("PlaceHolder", eee.message);
            }
        }
        ToggleGroup(pScreenID, pPara) {
            if (!pScreenID || !pPara)
                return;
            const tCtrl = cdeNMI.MyTCF.GetRegisteredControl("TABLES", cde.GuidToString(pScreenID)); // cdeNMI.MyEngine.MyNMIControls["TABLES"][cde.GuidToString(pScreenID)];
            if (tCtrl) {
                const tV = pPara.split(':');
                const tGroup = tV[0];
                let tID = tV.length > 1 ? tV[1] : null;
                if (tV.length > 2 && tCtrl.MyBaseType === cdeNMI.cdeControlType.FormView) {
                    const tForm = tCtrl;
                    let tRealCondition = "";
                    try {
                        if (tV.length > 3) {
                            tRealCondition = tForm.ReplaceMarcos(tV[3], tForm.MyFormControls);
                            const IsTrue = cde.cdeEval(tRealCondition);
                            if (IsTrue)
                                tID = tV[2];
                        }
                        else {
                            const resID = tForm.ReplaceMarcos(tV[2], tForm.MyFormControls);
                            if (resID && resID.length > 0)
                                tID = resID;
                        }
                    }
                    catch (e) {
                        //cdeNMI.ShowToastMessage("Validating Hide-Condition Error:" + e, "in: (" + tHideCondition + ") resolved to<br/>" + tRealCondition);
                        cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "Validating Group-Condition Error:" + e, "in: (" + pPara + ") resolved to<br/>" + tRealCondition);
                    }
                }
                tCtrl.SetProperty("StartGroup", pPara);
                this.ToggleChildren(tCtrl, tGroup, tID);
            }
        }
        ToggleChildren(pControl, pGroup, pID) {
            for (const iPC in pControl.MyChildren) {
                if (pControl.MyChildren.hasOwnProperty(iPC)) {
                    const tCtrl = pControl.MyChildren[iPC];
                    if (tCtrl.GetProperty("Group")) {
                        if (tCtrl.GetProperty("Group").toString().startsWith(pGroup)) {
                            if (pID === null || tCtrl.GetProperty("Group") !== pGroup + ":" + pID) {
                                if (tCtrl.MyBaseType === cdeNMI.cdeControlType.CollapsibleGroup)
                                    tCtrl.ToggleDrop(false, true);
                                else {
                                    tCtrl.SetProperty("Visibility", false);
                                    if (tCtrl.GetTE())
                                        tCtrl.GetTE().SetProperty("Visibility", false);
                                }
                            }
                            else {
                                if (tCtrl.MyBaseType === cdeNMI.cdeControlType.CollapsibleGroup)
                                    tCtrl.ToggleDrop(true, true);
                                else {
                                    tCtrl.SetProperty("Visibility", true);
                                    if (tCtrl.GetTE())
                                        tCtrl.GetTE().SetProperty("Visibility", true);
                                }
                            }
                        }
                    }
                    else if (tCtrl.MyBaseType === cdeNMI.cdeControlType.TileButton && typeof tCtrl.GetProperty("OnClick") === "string") {
                        const tOncl = tCtrl.GetProperty("OnClick");
                        if (tOncl === "GRP:" + pGroup + ":" + pID) {
                            if (!tCtrl.GetElement().classList.contains("cdeTabSelected"))
                                tCtrl.GetElement().classList.add("cdeTabSelected");
                            if (tCtrl.GetElement().classList.contains("cdeTabNotSelected"))
                                tCtrl.GetElement().classList.remove("cdeTabNotSelected");
                        }
                        else if (tOncl.startsWith("GRP:" + pGroup)) {
                            if (!tCtrl.GetElement().classList.contains("cdeTabNotSelected"))
                                tCtrl.GetElement().classList.add("cdeTabNotSelected");
                            if (tCtrl.GetElement().classList.contains("cdeTabSelected"))
                                tCtrl.GetElement().classList.remove("cdeTabSelected");
                        }
                    }
                    this.ToggleChildren(tCtrl, pGroup, pID);
                }
            }
        }
        FireControls(pProcessMessage) {
            if (!pProcessMessage || !pProcessMessage.Message)
                return false;
            const IsSETP = ((pProcessMessage.Message.TXT.substr(0, 5) === 'SETNP' || pProcessMessage.Message.TXT.substr(0, 6) === 'SETFNP') && !(!pProcessMessage.Message.PLS)); //Tuning - UX Properties only
            const tOWN = (pProcessMessage.Message && pProcessMessage.Message.OWN) ? cde.GuidToString(pProcessMessage.Message.OWN) : null; //Tuning
            let tProps = null; //Tuning
            let tInfo;
            let tControl;
            if (IsSETP) {
                tProps = pProcessMessage.Message.PLS.split(":;:");
                if (tOWN && tProps) {
                    let tIsTP = null;
                    let tTargetControl = cdeNMI.cdeControlType.BaseControl;
                    let tFldOrder = -1;
                    const tp = pProcessMessage.Message.TXT.split(":");
                    if (pProcessMessage.Message.TXT.substr(0, 6) === 'SETFNP') {
                        if (tp.length > 1) {
                            tIsTP = cde.GuidToString(tp[1]);
                        }
                    }
                    if (tp.length > 2) {
                        const tCtrlParts = tp[2].split(';');
                        tTargetControl = cde.CInt(tCtrlParts[0]);
                        if (tCtrlParts.length > 1)
                            tFldOrder = cde.CInt(tCtrlParts[1]);
                    }
                    const myNmiControl = cdeNMI.MyTCF.GetRegisteredControlGroup(tOWN);
                    for (tInfo in myNmiControl) {
                        if (myNmiControl.hasOwnProperty(tInfo)) {
                            tControl = myNmiControl[tInfo];
                            if (tIsTP && tIsTP !== "NULL" && tControl && tInfo !== tIsTP)
                                continue;
                            for (let i = 0; i < tProps.length; i++) {
                                const pos = tProps[i].indexOf("=");
                                const tPName = pos < 0 ? tProps[i] : tProps[i].substr(0, pos);
                                if (pos < 0) {
                                    tControl.SetProperty(tProps[i], true);
                                }
                                else {
                                    if (pos > 0 && pos < tProps[i].length) {
                                        let tPV = "";
                                        if (pos < tProps[i].length - 1)
                                            tPV = tProps[i].substr(pos + 1);
                                        if (tPV.substr(0, 11) !== "&^CDESP1^&:") {
                                            if (tTargetControl > 0 && tControl.MyBaseType > 0 && tControl.MyBaseType !== tTargetControl)
                                                continue;
                                            if (tFldOrder >= 0 && tControl.MyTRF && tControl.MyTRF.FldInfo && tControl.MyTRF.FldInfo.FldOrder !== tFldOrder)
                                                continue;
                                            if (tControl.GetTE())
                                                cdeNMI.ThePB.SetRawProperty(tControl.GetTE(), tPName.trim(), tPV.trim());
                                            else
                                                cdeNMI.ThePB.SetRawProperty(tControl, tPName.trim(), tPV.trim());
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            else {
                if (tOWN) {
                    const myNmiThingEvent = cdeNMI.MyNMIThingEvents[tOWN];
                    for (tInfo in myNmiThingEvent) {
                        if (myNmiThingEvent.hasOwnProperty(tInfo)) {
                            tControl = myNmiThingEvent[tInfo];
                            tControl.FireEvent(false, "SETP", pProcessMessage);
                        }
                    }
                }
                else {
                    return false;
                }
            }
            return true;
        }
        static AddAdHocSmartControl(pParent, pID, pType, pHeader, pFlags, pBag) {
            const tTRF = new cdeNMI.TheTRF("NOTABLE", 0, cdeNMI.TheFieldInfo.NewTFI(pType, 0, pHeader, pFlags, pBag));
            const tTileEntry = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileEntry).Create(pParent, { TRF: tTRF });
            tTileEntry.CreateControl(pID);
            return tTileEntry;
        }
    }
    cdeNMI.TheControlFactory = TheControlFactory;
    cdeNMI.MyTCF = new TheControlFactory();
})(cdeNMI || (cdeNMI = {}));
// SPDX-FileCopyrightText: 2009-2023 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
var cdeNMI;
// SPDX-FileCopyrightText: 2009-2023 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
(function (cdeNMI) {
    /////////////////////////////////////////////////////////////
    /// NMI HTML5 Controls
    /////////////////////////////////////////////////////////////
    /**
    Base NMI Control ALL controls inherit from
    */
    class TheNMIBaseControl extends cde.TheThing {
        constructor(pTarget, pTRF) {
            super();
            this.MyTarget = null; //The parent Control
            this.MyParentCtrl = null; //The surrounding Tile Entry Control
            this.MyDataView = null; //The owning Form/Table (DataView)
            this.MyNMIControl = null; //First SubControl
            this.MyTE = null; /// ctrlTileEntry = null;      //If the control is inside a TE the instance of the TE is found here - V4.107: Any control can be container of another control
            this.MyBaseType = cdeNMI.cdeControlType.BaseControl; //cdeControl Type of the control
            this.MyScreenID = null; //The Screen ID (Model) Associated with the Control
            this.MyFormID = null; //Form that contains the Control
            this.MyEngineName = null; //The Plugin (Engine) associated with the control
            this.MyTRF = null; //TheTRF (Table Row Field) definition of the Control
            this.MyFieldInfo = null; //TheFieldInfo of the Control
            this.TouchPoints = 0;
            this.PreventManipulation = false;
            this.PreventDefault = false;
            this.Visibility = true;
            this.IsDisabled = false;
            this.Is3DObject = false;
            this.IsDirty = false;
            this.HasFacePlate = false;
            this.MyWidth = 0;
            this.MyHeight = 0;
            this.MyDirtyList = [];
            this.lastXYById = [];
            this.MyChildren = [];
            this.MySubControls = [];
            this.WasClicked = false;
            this.MyRenderTarget = null;
            this.MyDataItems = [];
            this.PropertyBag = [];
            if (pTarget) {
                this.MyTarget = pTarget;
                this.MyFormID = pTarget.MyFormID;
            }
            this.MyTRF = pTRF;
            if (pTRF) {
                this.MyFieldInfo = pTRF.FldInfo;
                if (pTRF.FldInfo)
                    this.PropertyBag["ID"] = cde.GuidToString(pTRF.FldInfo.cdeMID);
                else
                    this.PropertyBag["ID"] = "CNMIC" + cdeNMI.MyNMISettings.IDCounter++;
                if (pTRF.FldInfo && !this.MyFormID)
                    this.MyFormID = pTRF.FldInfo.FormID;
            }
            else
                this.PropertyBag["ID"] = "CNMIC" + cdeNMI.MyNMISettings.IDCounter++;
            this.PropertyBag["Disabled"] = false;
            this.PropertyBag["TouchPoints"] = 0;
            this.PreventManipulation = false;
            this.PropertyBag["AreEventsHooked"] = false;
        }
        GetPropertyBag() {
            return this.PropertyBag;
        }
        SetTRF(pTRF, pPropertyBag) {
            if (pTRF) {
                this.MyTRF = pTRF;
                if (pTRF.FldInfo) {
                    this.MyFieldInfo = pTRF.FldInfo;
                    if (this.MyFieldInfo.FormID)
                        this.MyFormID = this.MyFieldInfo.FormID;
                    cdeNMI.ThePB.ConvertPropertiesFromBag(this.MyFieldInfo, pPropertyBag);
                }
            }
            else {
                if (!this.MyFieldInfo && pPropertyBag) {
                    this.MyFieldInfo = new cdeNMI.TheFieldInfo(this.MyBaseType);
                    this.MyTRF = new cdeNMI.TheTRF("", 0, this.MyFieldInfo);
                    cdeNMI.ThePB.ConvertPropertiesFromBag(this.MyFieldInfo, pPropertyBag);
                }
            }
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            if (pTargetControl) {
                this.MyTarget = pTargetControl;
                this.MyTarget.MyChildren.push(this);
            }
            this.SetTRF(pTRF, pPropertyBag);
            if (pScreenID)
                this.MyScreenID = cde.GuidToString(pScreenID);
            if (!this.MyFormID && pTargetControl)
                this.MyFormID = pTargetControl.MyFormID;
            if (cde.CBool(this.GetProperty("DisallowEdit")) === false)
                this.RegisterEvent("NMI_SHAPE_RECOGNIZED", (pSend, pName, pScore) => { this.eventShapeRecognized(pSend, pName, pScore); });
            return true;
        }
        eventShapeRecognized(sender, pName, pScore) {
            if (!cde.MyBaseAssets.MyServiceHostInfo.RedPill)
                return;
            if (pScore > 1) {
                cdeNMI.ShowToastMessage("Name: " + pName + " Score:" + pScore.toFixed(2));
                if (cde.MyEventLogger)
                    cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "ShapeRecognizer", "Name: " + pName + " Score:" + pScore.toFixed(2));
                switch (pName) {
                    case "circle":
                    case "rightmouse": {
                        if (cde.CBool(this.GetSetting("DisallowEdit")) === true)
                            return;
                        const tEl = this.GetElement();
                        if (tEl && !tEl.classList.contains("cde-is-selected")) {
                            tEl.classList.add("cde-is-selected");
                        }
                        const tSideBar = document.getElementById("cdeSideBarRight");
                        if (tSideBar && !tSideBar.classList.contains("cde-animate-right")) {
                            tSideBar.classList.add("cde-animate-right");
                            tSideBar.style.display = '';
                            if (cdeNMI.MyEngine)
                                cdeNMI.MyEngine.PublishToNMI("NMI_SHOW_EDITOR", `${this.MyTRF.FldInfo.cdeMID};${sender.MyFormID};${this.MyTRF.FldInfo.cdeO}`, this.MyTRF.FldInfo.cdeN);
                            const tS = cdeNMI.TheNMIScreen.GetScreenByID(sender.MyFormID);
                            if (tS === null || tS === void 0 ? void 0 : tS.MyOverlay)
                                tS.MyOverlay.SetProperty("IsDisabled", true);
                        }
                        break;
                    }
                }
            }
            else {
                cdeNMI.ShowToastMessage("Guess is : " + pName + " but Score too low:" + pScore.toFixed(2));
            }
        }
        SaveProperty(pName, pValue) {
            if (this.MyDirtyList.indexOf(pName) < 0)
                this.MyDirtyList.push(pName);
            this.SetProperty(pName, pValue);
        }
        SetProperty(pName, pValue) {
            try {
                if (pName === "PreventManipulation") {
                    if (typeof pValue === "undefined" || cde.CBool(pValue)) {
                        pValue = true;
                    }
                    this.PreventManipulation = pValue;
                    return;
                }
                if (pName === "PreventDefault" || pName === "EnableMT") {
                    if (typeof pValue === "undefined" || cde.CBool(pValue)) {
                        pValue = true;
                    }
                    this.PreventDefault = pValue;
                    return;
                }
                let tOldValue = this.PropertyBag[pName];
                if (pName === "iValue") {
                    tOldValue = this.PropertyBag["Value"];
                    this.PropertyBag["Value"] = pValue;
                    if (pValue !== tOldValue) {
                        this.FireEvent(false, "OniValueChanged", "SetProperty", pValue, pName);
                    }
                    return;
                }
                else
                    this.PropertyBag[pName] = pValue;
                if (pName === "OnThingEvent") {
                    this.RegisterSetP((pControl, pMsg) => {
                        if (pMsg.Message.TXT.substring(0, 4) === "SETP" || pMsg.Message.TXT.substring(0, 5) === "SETFP") { //ThingProperties only
                            const tProps = pMsg.Message.PLS.split(":;:");
                            for (const element of tProps) {
                                const pos = element.indexOf("=");
                                let tPropName = "";
                                let tPropValue = true;
                                if (pos < 0) {
                                    tPropName = element;
                                    tPropValue = true;
                                }
                                else {
                                    if (pos > 0 && pos < element.length) {
                                        tPropName = element.substring(0, pos);
                                        if (pos < element.length + 1)
                                            tPropValue = element.substring(pos + 1);
                                        if (tPropName.substring(0, 11) === "&^CDESP1^&:")
                                            continue;
                                    }
                                }
                                if (tPropName.length > 0) {
                                    if (tPropName === pControl.GetProperty("OnThingEvent")) {
                                        pControl.SetProperty("iValue", tPropValue);
                                        if (pControl.MyTRF && (pControl.MyTRF.ModelID || pControl.MyScreenID)) {
                                            const tModel = cdeNMI.MyNMIModels[pControl.MyTRF.ModelID ? pControl.MyTRF.ModelID : pControl.MyScreenID];
                                            if (tModel && tModel.MyStorageMirror[pControl.MyTRF.TableName])
                                                cdeNMI.UpdFldContent(tModel.MyStorageMirror[pControl.MyTRF.TableName][pControl.MyTRF.RowNo], pControl.MyFieldInfo, tPropValue, null);
                                        }
                                        else {
                                            const tCtrl = pControl.MyNMIControl;
                                            if (tCtrl && tCtrl.MyTRF && tCtrl.MyScreenID) {
                                                const tIModel = cdeNMI.MyNMIModels[tCtrl.MyScreenID];
                                                if (tIModel && tIModel.MyStorageMirror[tCtrl.MyTRF.TableName])
                                                    cdeNMI.UpdFldContent(tIModel.MyStorageMirror[tCtrl.MyTRF.TableName][tCtrl.MyTRF.RowNo], tCtrl.MyFieldInfo, tPropValue, null);
                                            }
                                        }
                                        this.FireEvent(true, "OnPropertyChanged", "SetProperty", tPropValue, "iValue");
                                    }
                                }
                            }
                        }
                    });
                }
                if (pName === "OniValueChanged") {
                    this.RegisterEvent("OniValueChanged", pValue);
                    this.FireEvent(true, "OniValueChanged", "SetProperty", this.PropertyBag["Value"], "Value");
                }
                else if (pName === "OnValueChanged") {
                    this.RegisterEvent("OnValueChanged", pValue);
                    return;
                }
                else if (pName === "OnPropertyChanged") {
                    this.RegisterEvent("OnPropertyChanged", pValue);
                    return;
                }
                else if (pName === "OnPropertySet") {
                    this.RegisterEvent("OnPropertySet", pValue);
                    return;
                }
                else if (pName === "RegisterEvent") {
                    const tPara = pValue.split(":;:");
                    if (tPara.length > 1) {
                        this.RegisterEvent(tPara[0], tPara[1]);
                    }
                }
                else if (pName === "Value") {
                    if (pValue !== tOldValue) {
                        this.IsDirty = true;
                        this.FireEvent(true, "OnValueChanged", "SetProperty", pValue, this.MyTRF);
                        this.FireEvent(true, "OniValueChanged", "SetProperty", pValue, pName);
                    }
                }
                else if (pName === "Visibility" && this.MyRootElement) {
                    pValue = cde.CBool(pValue);
                    this.Visibility = pValue;
                    if (typeof pValue === "undefined" || pValue) {
                        this.MyRootElement.style.display = '';
                        this.OnLoad(this.Visibility);
                    }
                    else {
                        this.MyRootElement.style.display = 'none';
                        this.OnUnload();
                    }
                }
                else if (pName === "IsOwnerDown") {
                    if (pValue === true) {
                        if (this.GetProperty(pName) === true)
                            return;
                        this.mOldClassName = this.MyRootElement.className;
                        this.MyRootElement.className += " cdeNodeGone";
                    }
                    else {
                        if (this.GetProperty(pName) !== true)
                            return;
                        this.MyRootElement.className = this.mOldClassName;
                    }
                }
                else if (pName === "Disabled" && this.MyRootElement) {
                    this.IsDisabled = cde.CBool(pValue);
                    if (this.IsDisabled) {
                        this.MyRootElement.style.opacity = "0.5";
                    }
                    else {
                        this.MyRootElement.style.opacity = "1.0";
                    }
                }
                else if (pName === "Draggable") {
                    this.MyRootElement.draggable = cde.CBool(pValue);
                }
                else if (pName === "TID") {
                    this.PropertyBag["ID"] = pValue; //Set ID to ThingID without setting root ID of the field - required for table updates
                }
                else if ((pName === "ID" || pName === "MID") && pValue && this.MyRootElement) {
                    this.MyRootElement.id = cde.GuidToString(pValue);
                    this.PropertyBag["ID"] = pValue;
                }
                else if (pName === "ClassName" && (pValue || pValue === "") && this.MyRootElement) {
                    this.MyRootElement.className = pValue;
                }
                else if (pName === "AddClassName" && (pValue || pValue === "") && this.MyRootElement) {
                    if (!this.MyRootElement.classList.contains(pValue))
                        this.MyRootElement.classList.add(pValue);
                }
                else if (pName === "RemoveClassName" && (pValue || pValue === "") && this.MyRootElement) {
                    if (this.MyRootElement.classList.contains(pValue))
                        this.MyRootElement.classList.remove(pValue);
                }
                else if (pName === "TEClassName" && (pValue || pValue === "")) {
                    if (this.MyTE && this.MyTE.MyNMIControl)
                        this.MyTE.MyNMIControl.SetProperty("ClassName", pValue);
                }
                else if (pName === "Display" && pValue && this.MyRootElement) {
                    this.MyRootElement.style.display = pValue;
                }
                else if ((pName === "DragX" || pName === "DragY") && pValue) {
                    this.MyRootElement.style.transform = `translate(${cde.CDbl(this.GetProperty("DragX"))}px, ${cde.CDbl(this.GetProperty("DragY"))}px)`;
                }
                else if (pName === "Style" && pValue && this.MyRootElement) {
                    this.MyRootElement.style.cssText += pValue;
                }
                else if (pName === "MaxHeight" && pValue && this.MyRootElement) {
                    this.MyRootElement.style.maxHeight = pValue;
                }
                else if (pName === "Opacity" && this.MyRootElement) {
                    this.MyRootElement.style.opacity = pValue;
                }
                else if (pName === "HorizontalAlignment" && this.MyRootElement) {
                    this.MyRootElement.style.textAlign = pValue.toLowerCase();
                }
                else if (pName === "VerticalAlignment" && this.MyRootElement) {
                    this.MyRootElement.style.verticalAlign = pValue.toLowerCase();
                }
                else if (pName === "Float" && this.MyRootElement) {
                    this.MyRootElement.style.cssFloat = pValue;
                }
                else if (pName === "FontSize" && this.MyRootElement) {
                    this.MyRootElement.style.fontSize = pValue + "px";
                }
                else if (pName === "Margin" && this.MyRootElement) {
                    this.MyRootElement.style.margin = pValue + "px";
                }
                else if (pName === "Z-Index" && this.MyRootElement) {
                    this.MyRootElement.style.zIndex = pValue.toString();
                }
                else if (pName === "PixelWidth" && this.MyRootElement) {
                    if (pValue) {
                        if (pValue.toString().endsWith("px") || pValue.toString().endsWith("%") || pValue === "auto")
                            this.MyRootElement.style.width = pValue;
                        else
                            this.MyRootElement.style.width = pValue + "px";
                    }
                }
                else if (pName === "PixelHeight" && this.MyRootElement) {
                    if (pValue) {
                        if (pValue.toString().endsWith("px") || pValue.toString().endsWith("%") || pValue === "auto")
                            this.MyRootElement.style.height = pValue;
                        else
                            this.MyRootElement.style.height = pValue + "px";
                    }
                }
                else if (pName === "TileFactorX" && this.MyRootElement) {
                    this.SetInitialWidth(1);
                }
                else if (pName === "TileFactorY" && this.MyRootElement) {
                    this.SetInitialHeight(1);
                }
                else if (pName === "TileWidth" && this.MyRootElement) {
                    pValue = cde.CInt(pValue);
                    if (pValue === 0)
                        pValue = 1;
                    const tScrolRes = 0;
                    this.SetWidth(this.MyRootElement, pValue, this.MyBaseType === cdeNMI.cdeControlType.Screen ? tScrolRes : (this.MyBaseType === cdeNMI.cdeControlType.TileEntry ? 0 : 1));
                }
                else if (pName === "TileHeight" && this.MyRootElement) {
                    pValue = cde.CInt(pValue);
                    if (pValue < 0)
                        this.MyRootElement.style.height = "inherit";
                    else {
                        if (pValue < 1)
                            pValue = 1;
                        this.SetHeight(this.MyRootElement, pValue, this.MyBaseType === cdeNMI.cdeControlType.Screen ? 0 : (this.MyBaseType === cdeNMI.cdeControlType.TileEntry ? 0 : 1));
                    }
                }
                else if (pName === "MaxTileWidth" && this.MyRootElement) {
                    pValue = cde.CInt(pValue);
                    let tMaxWid = cdeNMI.GetSizeFromTile(pValue);
                    if (cde.MyBaseAssets.MyServiceHostInfo.WebPlatform !== 1 && this.MyBaseType === cdeNMI.cdeControlType.CollapsibleGroup && this.MyFieldInfo && this.MyFieldInfo.FldOrder === 1 && cde.CBool(this.GetProperty("UseMargin")) === true) {
                        const tSegments = Math.floor(pValue / 6);
                        if (tSegments > 0)
                            tMaxWid += cdeNMI.GetSizeFromTile(tSegments) / 2;
                    }
                    if (!cde.CBool(this.GetProperty("FitToScreen")) && cdeNMI.MyScreenManager && cdeNMI.MyScreenManager.DocumentWidth > 0 && tMaxWid > cdeNMI.MyScreenManager.DocumentWidth)
                        tMaxWid = cdeNMI.MyScreenManager.DocumentWidth - (cdeNMI.GetSizeFromTile(1));
                    this.MyRootElement.style.maxWidth = tMaxWid + "px";
                }
                else if (pName === "BackgroundImage" && this.MyRootElement) {
                    if (pValue.substr(0, 1) === "{") {
                        let tPlanar = null;
                        tPlanar = JSON.parse(pValue);
                        this.MyRootElement.style.backgroundImage = "url('data:image/jpeg;base64," + tPlanar.Bits + "')";
                    }
                    else {
                        this.MyRootElement.style.backgroundImage = "url('" + pValue + "')";
                    }
                }
                else if (pName === "TileLeft" && this.MyRootElement) {
                    pValue = cde.CInt(pValue);
                    this.MyRootElement.style.left = ((cdeNMI.GetSizeFromTile(1) * pValue) + (cdeNMI.MyNMISettings.TileMargin * ((pValue * 2) + 1))).toString() + "px";
                }
                else if (pName === "TileTop" && this.MyRootElement) {
                    pValue = cde.CInt(pValue);
                    this.MyRootElement.style.top = ((cdeNMI.GetSizeFromTile(1) * pValue) + (cdeNMI.MyNMISettings.TileMargin * ((pValue * 2) + 1))).toString() + "px";
                }
                else if (pName === "Top" && this.MyRootElement) {
                    pValue = cde.CInt(pValue);
                    this.MyRootElement.style.top = pValue.toString() + "px";
                }
                else if (pName === "Left" && this.MyRootElement) {
                    pValue = cde.CInt(pValue);
                    this.MyRootElement.style.left = pValue.toString() + "px";
                }
                else if (pName === "Right" && this.MyRootElement) {
                    pValue = cde.CInt(pValue);
                    this.MyRootElement.style.right = pValue.toString() + "px";
                }
                else if (pName === "IsAbsolute" && this.MyRootElement) {
                    if (cde.CBool(pValue)) {
                        this.MyRootElement.style.position = "absolute";
                    }
                    else
                        this.MyRootElement.style.position = "relative";
                }
                else if (pName === "IsHitTestDisabled" && this.MyRootElement) {
                    if (cde.CBool(pValue))
                        this.MyRootElement.style.pointerEvents = 'none';
                    else
                        this.MyRootElement.style.pointerEvents = '';
                }
                else if (pName === "NUITags" && pValue && cdeNMI.MyEngine) {
                    const t = pValue.toString().split(';');
                    for (const element of t)
                        cdeNMI.MyNMINUITags[element] = this;
                }
                else if (pName === "EngineName" && pValue && pValue !== "") {
                    this.MyEngineName = pValue;
                }
                else if (pName === "cdeNMID" && pValue && pValue !== "") {
                    cdeNMI.MyNMID[pValue] = this;
                }
                if (pValue !== tOldValue) {
                    this.FireEvent(true, "OnPropertyChanged", "SetProperty", pValue, pName);
                    const tS = this.GetProperty(pName + "_TCB");
                    if (tS) {
                        const tSpan = document.getElementById(tS.TargetID);
                        if (tSpan) {
                            tSpan.innerHTML = pValue;
                        }
                    }
                }
            }
            catch (exe) {
                cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "BaseControl:SetProperty", "Could not set property:" + exe);
            }
            this.FireEvent(true, "OnPropertySet", "SetProperty", pValue, pName);
        }
        SetToDefault(bOnlyIfEmpty) {
            if (bOnlyIfEmpty && !cde.IsNotSet(this.GetProperty("Value")))
                return null;
            if (this.MyFieldInfo && this.MyFieldInfo["DefaultValue"]) {
                this.SetProperty("iValue", this.MyFieldInfo["DefaultValue"]);
                return this.MyFieldInfo["DefaultValue"];
            }
            else {
                this.SetProperty("iValue", null);
            }
            return null;
        }
        toJSON() {
            const myarray = [];
            const propertyBag = this.PropertyBag;
            for (const tID in propertyBag) {
                if (propertyBag.hasOwnProperty(tID)) {
                    const item = {
                        "N": tID,
                        "V": propertyBag[tID]
                    };
                    myarray.push(item);
                }
            }
            return {
                "PropertyBag": myarray,
                "ScreenID": this.MyScreenID,
                "TRF": this.MyTRF,
                "EngineName": this.MyEngineName,
                "BaseType": this.MyBaseType,
                "FieldInfo": this.MyFieldInfo
            };
        }
        /**
            Registers an event on the current Control derived from The NMIBaseControl
        */
        RegisterIncomingMessage(pEngineName, eventHandler) {
            const tID = this.RegisterNMIControl();
            this.MyEngineName = pEngineName;
            if (cdeNMI.MyEngine)
                cdeNMI.MyEngine.RegisterIncomingMsg(this, tID, pEngineName);
            this.RegisterEvent("IncomingMessage", eventHandler);
        }
        RegisterNMIControl() {
            let tOWN = this.GetProperty("UXID");
            if (!tOWN) {
                if (this.MyFieldInfo && this.MyFieldInfo.cdeMID)
                    tOWN = this.MyFieldInfo.cdeMID;
                else
                    return null;
            }
            tOWN = cde.GuidToString(tOWN);
            const tID = cde.GuidToString(this.GetProperty("ID"));
            if (cdeNMI.MyTCF) {
                cdeNMI.MyTCF.RegisterControl(tOWN, tID, this);
            }
            return tID;
        }
        RegisterThingSetP(pOWN, pName) {
            const tOWN = cde.GuidToString(pOWN);
            const tID = cde.GuidToString(this.GetProperty("ID"));
            this.SetProperty("MyThing", tOWN);
            if (!cdeNMI.MyNMIThingEvents[tOWN])
                cdeNMI.MyNMIThingEvents[tOWN] = [];
            cdeNMI.MyNMIThingEvents[tOWN][tID] = this;
            this.SetProperty("OnThingEvent", pName);
        }
        RegisterSetP(eventHandler) {
            this.RegisterNMIControl();
            this.RegisterEvent("SETP", eventHandler); //ThingProperties:SETP
        }
        Create(pTargetControl, pOptions) {
            try {
                if (pOptions) {
                    if (pOptions.Cookie)
                        this.SetProperty("Cookie", pOptions.Cookie);
                    this.InitControl(pTargetControl, pOptions.TRF, pOptions.PreInitBag, pOptions.ScreenID);
                    if (pOptions.PostInitBag) {
                        cdeNMI.ThePB.SetPropertiesFromBag(this, pOptions.PostInitBag);
                    }
                }
                else {
                    this.InitControl(pTargetControl);
                }
            }
            catch (exe) {
                cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "BaseControl:Create", "Failed with Exception:" + exe);
                return null;
            }
            return this;
        }
        SetTE(pTE) {
            this.MyTE = pTE;
        }
        GetTE() {
            return this.MyTE;
        }
        ReloadData() {
            return false;
        }
        ToggleDrop(doClose, doForce) {
            //overrride if required
        }
        SetElement(pRootControl, pHookEvents, pContainerElement, NoFireOnLoad) {
            if (pRootControl) {
                this.MyRootElement = pRootControl;
                pRootControl.cookie = this;
                if (typeof interact !== 'undefined' && cde.CBool(this.GetSetting("AllowDrag"))) {
                    interact(pRootControl).draggable({
                        listeners: {
                            start(event) {
                                const ele = event.target.cookie;
                                ele.FireEvent(false, "DragStart");
                            },
                            move(event) {
                                const ts = cdeNMI.TheNMIScreen.GetScreenByID(event.target.cookie.MyFormID);
                                let rat = 1.0;
                                if (ts)
                                    rat = ts.ScreenScale;
                                const ele = event.target.cookie;
                                if (ele) {
                                    ele.SaveProperty("DragX", cde.CDbl(ele.GetProperty("DragX")) + event.dx / rat);
                                    ele.SaveProperty("DragY", cde.CDbl(ele.GetProperty("DragY")) + event.dy / rat);
                                }
                            },
                        }
                    });
                }
            }
            else {
                if (this.MyTarget)
                    this.MyRootElement = this.MyTarget.GetContainerElement();
            }
            if (pContainerElement) {
                this.MyContainerElement = pContainerElement;
            }
            if (this.MyTarget && this.MyTarget.GetContainerElement() && this.MyTarget.GetContainerElement() !== this.MyRootElement) {
                this.MyTarget.AppendElement(pRootControl);
            }
            this.MyRootElement.NMIControl = this;
            if (pHookEvents && this.GetSetting("Disabled") !== true) {
                this.HookEvents(false);
            }
            if (this.MyFieldInfo && cde.CBool(NoFireOnLoad) !== true) {
                if (this.GetSetting("OnLoaded") && cdeNMI.MyEngine) { //OnLoaded OK
                    cdeNMI.MyEngine.PublishToNMI("NMI_FLD_LOADED:" + this.MyFieldInfo.cdeMID, this.GetSetting("OnLoaded"), this.cdeN); //OnLoaded OK
                }
            }
        }
        DeleteControl(tControl) {
            if (!tControl)
                return;
            if (this.GetContainerElement() && tControl.GetContainerElement().parentElement === this.MyRootElement)
                this.GetContainerElement().removeChild(tControl.GetElement());
        }
        AppendChild(pChild) {
            if (pChild && this.GetContainerElement())
                this.GetContainerElement().appendChild(pChild.GetElement());
        }
        RemoveChild(pChild) {
            if (pChild) {
                this.GetContainerElement().removeChild(pChild.GetElement());
            }
        }
        AppendElement(pEle) {
            this.GetContainerElement().appendChild(pEle);
        }
        HookEvents(bDoCapture) {
            if (this.PropertyBag["AreEventsHooked"] === true)
                return;
            this.PropertyBag["AreEventsHooked"] = true;
            this.MyRootElement.addEventListener("selectstart", (e) => { cdeNMI.StopPointerEvents(e); }, bDoCapture);
            this.MyRootElement.addEventListener("contextmenu", (e) => { cdeNMI.StopPointerEvents(e); }, bDoCapture);
            this.MyRootElement.addEventListener("MSHoldVisual", (e) => { cdeNMI.StopPointerEvents(e); }, bDoCapture);
            this.MyRootElement.addEventListener("keyup", (evt) => this.sinkDoKey(evt), bDoCapture);
            this.MyRootElement.addEventListener("keydown", (evt) => this.sinkDoKey(evt), bDoCapture);
            if (cdeNMI.MyNMISettings.SupportsPointer) {
                //  W3C pointer model = IE11
                this.MyRootElement.addEventListener("pointerdown", (evt) => this.sinkDoEvent(evt), bDoCapture);
                this.MyRootElement.addEventListener("pointermove", (evt) => this.sinkDoEvent(evt), bDoCapture);
                this.MyRootElement.addEventListener("pointerup", (evt) => this.sinkDoEvent(evt), bDoCapture);
                this.MyRootElement.addEventListener("pointercancel", (evt) => this.sinkDoEvent(evt), bDoCapture);
                if (this.PropertyBag["IsPointerOutAllowed"] !== true) {
                    this.MyRootElement.addEventListener("pointerout", (evt) => this.sinkDoEvent(evt), bDoCapture);
                }
            }
            else if (this.MyRootElement.addEventListener) {
                //  iOS touch model
                this.MyRootElement.addEventListener("touchstart", (evt) => this.sinkDoEvent(evt), bDoCapture);
                this.MyRootElement.addEventListener("touchmove", (evt) => this.sinkDoEvent(evt), bDoCapture);
                this.MyRootElement.addEventListener("touchend", (evt) => this.sinkDoEvent(evt), bDoCapture);
                this.MyRootElement.addEventListener("touchcancel", (evt) => this.sinkDoEvent(evt), bDoCapture);
                //  mouse model
                this.MyRootElement.addEventListener("mousedown", (evt) => this.sinkDoEvent(evt), bDoCapture);
                this.MyRootElement.addEventListener("mousemove", (evt) => this.sinkDoEvent(evt), bDoCapture);
                this.MyRootElement.addEventListener("mouseup", (evt) => this.sinkDoEvent(evt), bDoCapture);
                if (this.PropertyBag["IsPointerOutAllowed"] !== true) {
                    this.MyRootElement.addEventListener("mouseleave", (evt) => this.sinkDoEvent(evt), bDoCapture);
                }
            }
        }
        PreventDefaultManipulationAndMouseEvent(evtObj) {
            let MyControlstyle;
            if (this.PreventDefault) {
                cdeNMI.StopPointerEvents(evtObj);
                MyControlstyle = this.MyRootElement.style;
                MyControlstyle.touchAction = "none";
            }
            else {
                MyControlstyle = this.MyRootElement.style;
                MyControlstyle.touchAction = "auto";
            }
            if (evtObj && this.PreventManipulation) {
                if (evtObj.preventManipulation)
                    evtObj.preventManipulation();
                if (evtObj.preventMouseEvent)
                    evtObj.preventMouseEvent();
            }
        }
        static GetControlXY(o) {
            let z = o, x = 0, y = 0, c;
            while (z && !isNaN(z.offsetLeft) && !isNaN(z.offsetTop)) {
                const anyWindow = window;
                c = anyWindow.globalStorage ? null : window.getComputedStyle(z, null);
                x += z.offsetLeft - z.scrollLeft + (c ? parseInt(c.getPropertyValue('border-left-width'), 10) : 0);
                y += z.offsetTop - z.scrollTop + (c ? parseInt(c.getPropertyValue('border-top-width'), 10) : 0);
                z = z.offsetParent;
            }
            return { x: o.X = x, y: o.Y = y };
        }
        static findPos(obj, foundScrollLeft, foundScrollTop) {
            let curleft = 0;
            let curtop = 0;
            if (obj.offsetLeft)
                curleft += parseInt(obj.offsetLeft);
            if (obj.offsetTop)
                curtop += parseInt(obj.offsetTop);
            if (obj.scrollTop && obj.scrollTop > 0) {
                curtop -= parseInt(obj.scrollTop);
                foundScrollTop = true;
            }
            if (obj.scrollLeft && obj.scrollLeft > 0) {
                curleft -= parseInt(obj.scrollLeft);
                foundScrollLeft = true;
            }
            let pos;
            if (obj.offsetParent) {
                pos = TheNMIBaseControl.findPos(obj.offsetParent, foundScrollLeft, foundScrollTop);
                curleft += pos.x;
                curtop += pos.y;
            }
            else if (obj.ownerDocument) {
                let thewindow = obj.ownerDocument.defaultView;
                if (!thewindow && obj.ownerDocument.parentWindow)
                    thewindow = obj.ownerDocument.parentWindow;
                if (thewindow) {
                    if (!foundScrollTop && thewindow.scrollY && thewindow.scrollY > 0)
                        curtop -= parseInt(thewindow.scrollY);
                    if (!foundScrollLeft && thewindow.scrollX && thewindow.scrollX > 0)
                        curleft -= parseInt(thewindow.scrollX);
                    if (thewindow.frameElement) {
                        pos = TheNMIBaseControl.findPos(thewindow.frameElement, 0, 0);
                        curleft += pos.x;
                        curtop += pos.y;
                    }
                }
            }
            return { x: curleft, y: curtop };
        }
        EnsurePageXY(eventObj) {
            if (typeof eventObj.pageX === 'undefined') {
                const tDoc = cdeNMI.ThePointer.ComputeDocumentToElementDelta(this.MyRootElement);
                eventObj.pageX = eventObj.offsetX + tDoc.x;
                eventObj.pageY = eventObj.offsetY + tDoc.y;
            }
        }
        GetTouchPointer(pID) {
            const lastXyById = this.lastXYById;
            for (const index in lastXyById) {
                if (lastXyById.hasOwnProperty(index)) {
                    if (lastXyById[index] && lastXyById[index].Identifier === pID)
                        return lastXyById[index];
                }
            }
            return null;
        }
        GetTouchPointerIdx(pID) {
            const lastXyById = this.lastXYById;
            for (const index in lastXyById) {
                if (lastXyById.hasOwnProperty(index)) {
                    if (lastXyById[index] && lastXyById[index].Identifier === pID)
                        return parseInt(index);
                }
            }
            return -1;
        }
        sinkDoKey(pKeyEvt) {
            switch (pKeyEvt.type) {
                case "keyup":
                    this.FireEvent(true, "KeyUp", pKeyEvt);
                    break;
                case "keydown":
                    this.FireEvent(true, "KeyDown", pKeyEvt);
                    break;
            }
        }
        sinkDoEvent(pEvtObj) {
            if (cde.CBool(this.GetProperty("IsHitTestDisabled")) || cde.CBool(this.GetProperty("IsUnhooked")))
                return;
            if (pEvtObj.type === "mousemove" && this.lastXYById.length === 0 && !cde.CBool(this.GetProperty("AllowMoveWithoutDown")))
                return;
            const IsTouchDown = pEvtObj.type.match(/(start|down)$/i) !== null;
            const IsTouchMove = pEvtObj.type.match(/move$/i) !== null;
            const IsTouchEnd = pEvtObj.type.match(/(up|end|cancel|out|leave)$/i) !== null;
            const IsTouchCancel = pEvtObj.type.match(/(cancel|out|leave)$/i) !== null;
            if (IsTouchDown && pEvtObj.buttons === 1) {
                cdeNMI.IsMouseDown = true;
            }
            if (IsTouchEnd && pEvtObj.buttons === 0) {
                cdeNMI.IsMouseDown = false;
            }
            let tEvtType = cdeNMI.cdeInputEvent.IDLE;
            if (IsTouchDown)
                tEvtType = cdeNMI.cdeInputEvent.START;
            else if (IsTouchMove)
                tEvtType = cdeNMI.cdeInputEvent.MOVE;
            else
                tEvtType = cdeNMI.cdeInputEvent.END;
            if (this.PreventManipulation || this.PreventDefault) //IsTouchDown
                this.PreventDefaultManipulationAndMouseEvent(pEvtObj);
            const pointerList = pEvtObj.changedTouches ? pEvtObj.changedTouches : [pEvtObj];
            let tPS = this.lastXYById.length;
            if (IsTouchDown)
                tPS += pointerList.length;
            this.TouchPoints = tPS;
            for (const element of pointerList) {
                const pointerObj = element;
                const pointerId = (typeof pointerObj.identifier !== 'undefined') ? pointerObj.identifier : (typeof pointerObj.pointerId !== 'undefined') ? pointerObj.pointerId : 1;
                this.EnsurePageXY(pointerObj);
                let tTouchObj = null;
                if (this.GetProperty("IsOverlay") === true)
                    tTouchObj = new cdeNMI.ThePointer(this.MyRootElement, pointerId, pointerObj.clientX, pointerObj.clientY, 0, this.GetStrokeWidth(pEvtObj), this.GetEventType(pEvtObj), tEvtType, pEvtObj.buttons);
                else
                    tTouchObj = new cdeNMI.ThePointer(this.MyRootElement, pointerId, pointerObj.pageX, pointerObj.pageY, 0, this.GetStrokeWidth(pEvtObj), this.GetEventType(pEvtObj), tEvtType, pEvtObj.buttons);
                let lastTouchObj = this.GetTouchPointer(pointerId);
                let idx;
                if (IsTouchDown) {
                    if (lastTouchObj) {
                        idx = this.GetTouchPointerIdx(lastTouchObj.Identifier);
                        this.lastXYById.splice(idx, 1);
                        if (this.HasEvent("PointerUp") && pEvtObj.currentTarget !== document) {
                            lastTouchObj.Update(this.MyRootElement, tTouchObj.Position);
                            lastTouchObj.pointerEvent = cdeNMI.cdeInputEvent.END;
                            if (!cdeNMI.MyNMISettings.IsScrolling)
                                this.FireEvent(true, "PointerUp", pEvtObj, lastTouchObj);
                        }
                    }
                    else
                        lastTouchObj = tTouchObj;
                    //  init last page positions for this pointer
                    this.lastXYById.push(lastTouchObj);
                    if (this.HasEvent("PointerDown") && (pEvtObj.type === "mousedown" || pEvtObj.currentTarget !== document)) {
                        lastTouchObj.Update(this.MyRootElement, tTouchObj.Position);
                        lastTouchObj.pointerEvent = tTouchObj.pointerEvent;
                        if (!cdeNMI.MyNMISettings.IsScrolling)
                            this.FireEvent(true, "PointerDown", pEvtObj, lastTouchObj);
                        if (this.PreventDefault)
                            cdeNMI.StopPointerEvents(pEvtObj);
                    }
                }
                else if (IsTouchMove) {
                    if (lastTouchObj && !(lastTouchObj.Position.x === tTouchObj.Position.x && lastTouchObj.Position.y === tTouchObj.Position.y)) {
                        lastTouchObj.Update(this.MyRootElement, tTouchObj.Position);
                        lastTouchObj.pointerEvent = tTouchObj.pointerEvent;
                        if (this.HasEvent("PointerMove") && (pEvtObj.type === "mousemove" || pEvtObj.currentTarget !== document)) {
                            if (!cdeNMI.MyNMISettings.IsScrolling)
                                this.FireEvent(true, "PointerMove", pEvtObj, lastTouchObj);
                            if (this.PreventDefault)
                                cdeNMI.StopPointerEvents(pEvtObj);
                        }
                    }
                    else if (!lastTouchObj && cde.CBool(this.GetProperty("AllowMoveWithoutDown"))) {
                        lastTouchObj = tTouchObj;
                        this.lastXYById.push(lastTouchObj);
                        if (this.HasEvent("PointerMove") && (pEvtObj.type === "mousemove" || pEvtObj.currentTarget !== document)) {
                            if (!cdeNMI.MyNMISettings.IsScrolling)
                                this.FireEvent(true, "PointerMove", pEvtObj, tTouchObj);
                            if (this.PreventDefault)
                                cdeNMI.StopPointerEvents(pEvtObj);
                        }
                    }
                }
                else if (IsTouchEnd) {
                    if (lastTouchObj) {
                        if (cdeNMI.MyTouchOverlay && (!cdeNMI.MyTouchOverlay.CurrentControl || !(cdeNMI.MyTouchOverlay.CurrentControl === this || (cdeNMI.MyTouchOverlay.CurrentControl).MyNMIControl === this))) { //V4.107: MyEditControl is now in MyFirstChild
                            if (cdeNMI.MyTouchOverlay.MyBaseType === this.MyBaseType || cde.CInt(this.GetElement().style.zIndex) < 1000) {
                                if (this.PreventDefault)
                                    cdeNMI.StopPointerEvents(pEvtObj);
                                if (!cdeNMI.MyNMISettings.IsScrolling)
                                    cdeNMI.MyTouchOverlay.FireEvent(false, "Touched");
                                idx = this.GetTouchPointerIdx(lastTouchObj.Identifier);
                                this.lastXYById.splice(idx, 1);
                                break;
                            }
                        }
                        if (this.HasEvent("PointerUp") && !IsTouchCancel && (pEvtObj.type === "mouseup" || pEvtObj.currentTarget !== document)) {
                            lastTouchObj.Update(this.MyRootElement, tTouchObj.Position);
                            lastTouchObj.pointerEvent = tTouchObj.pointerEvent;
                            if (!cdeNMI.MyNMISettings.IsScrolling)
                                this.FireEvent(true, "PointerUp", pEvtObj, lastTouchObj);
                            cdeNMI.StopPointerEvents(pEvtObj);
                        }
                        else if (this.HasEvent("PointerCancel") && IsTouchCancel && (pEvtObj.type === "mouseup" || pEvtObj.currentTarget !== document)) {
                            lastTouchObj.Update(this.MyRootElement, tTouchObj.Position);
                            lastTouchObj.pointerEvent = tTouchObj.pointerEvent;
                            if (!cdeNMI.MyNMISettings.IsScrolling)
                                this.FireEvent(true, "PointerCancel", pEvtObj, lastTouchObj);
                            if (this.PreventDefault)
                                cdeNMI.StopPointerEvents(pEvtObj);
                        }
                        idx = this.GetTouchPointerIdx(lastTouchObj.Identifier);
                        this.lastXYById.splice(idx, 1);
                    }
                }
            }
            this.TouchPoints = this.lastXYById.length;
        }
        GetEventType(pEvent) {
            const msEvent = pEvent;
            if (msEvent.mozInputSource) {
                switch (msEvent.mozInputSource) { //Pen
                    case 6: //keyboard
                        return cdeNMI.cdeInputEventType.KEYBOARD;
                    case 3: //Erasor
                        return cdeNMI.cdeInputEventType.ERASER;
                    case 2: //Pen
                        return cdeNMI.cdeInputEventType.PEN;
                    case 5: //Touch
                        return cdeNMI.cdeInputEventType.TOUCH;
                    case 1: //Mouse
                        return cdeNMI.cdeInputEventType.MOUSE;
                    default:
                        return cdeNMI.cdeInputEventType.UNKOWN;
                }
            }
            else if (msEvent.pointerType) {
                if (msEvent.buttons && (msEvent.buttons & 32) !== 0)
                    return cdeNMI.cdeInputEventType.ERASER;
                if (typeof msEvent.pointerType === "string") {
                    switch (msEvent.pointerType) {
                        case "touch":
                            return cdeNMI.cdeInputEventType.TOUCH;
                        case "pen":
                            return cdeNMI.cdeInputEventType.PEN;
                        case "mouse":
                            return cdeNMI.cdeInputEventType.MOUSE;
                        default:
                            return cdeNMI.cdeInputEventType.UNKOWN;
                    }
                }
                else {
                    switch (msEvent.pointerType) {
                        case msEvent.MSPOINTER_TYPE_TOUCH:
                            return cdeNMI.cdeInputEventType.TOUCH;
                        case msEvent.MSPOINTER_TYPE_PEN:
                            return cdeNMI.cdeInputEventType.PEN;
                        case msEvent.MSPOINTER_TYPE_MOUSE:
                            return cdeNMI.cdeInputEventType.MOUSE;
                        default:
                            return cdeNMI.cdeInputEventType.UNKOWN;
                    }
                }
            }
            return cdeNMI.cdeInputEventType.MOUSE;
        }
        GetStrokeWidth(pEvent) {
            let tStroke = 20;
            const msEvent = pEvent;
            if (msEvent.mozInputSource) {
                let tPressure = 0.5;
                if (msEvent.mozPressure)
                    tPressure = msEvent.mozPressure;
                switch (msEvent.mozInputSource) { //Pen
                    case 3: //Erasor
                        tStroke = tPressure * 50;
                        break;
                    case 2: //Pen
                        tStroke = tPressure * 20;
                        break;
                    case 5: //Touch
                        tStroke = 20 * tPressure;
                        break;
                    case 1: //Mouse
                        tStroke = 5;
                        break;
                    default:
                        break;
                }
            }
            else if (msEvent.pointerType) {
                if (typeof msEvent.pointerType === "string") {
                    switch (msEvent.pointerType) {
                        case "touch":
                            tStroke = 20 * msEvent.pressure;
                            if (tStroke < 1)
                                tStroke = 20;
                            break;
                        case "pen":
                            tStroke = msEvent.pressure * 20;
                            if (tStroke < 1)
                                tStroke = 1;
                            break;
                        case "mouse":
                            tStroke = 5;
                            break;
                    }
                }
                else {
                    switch (msEvent.pointerType) {
                        case msEvent.MSPOINTER_TYPE_TOUCH:
                            tStroke = 20 * msEvent.pressure;
                            if (tStroke < 1)
                                tStroke = 20;
                            break;
                        case msEvent.MSPOINTER_TYPE_PEN:
                            tStroke = msEvent.pressure * 20;
                            if (tStroke < 1)
                                tStroke = 1;
                            break;
                        case msEvent.MSPOINTER_TYPE_MOUSE:
                            tStroke = 5;
                            break;
                    }
                }
            }
            if (msEvent.touches && msEvent.touches.length > 0 && msEvent.touches[0].force) {
                tStroke = 20 * msEvent.touches[0].force;
                if (tStroke < 1)
                    tStroke = 1;
            }
            return tStroke;
        }
        DoFireClick(pTargetObj, pEvent, pPointer) {
            if (!pTargetObj || !pTargetObj.HasEvent("OnClick"))
                return;
            const TPs = pTargetObj.GetProperty("TouchPoints");
            if (!pPointer || ((pPointer.IsOnObject || cde.CBool(pTargetObj.GetProperty("IgnoreHitTarget"))) && pPointer.PathLength() < cdeNMI.MyNMISettings.DeadPathLength)) {
                pTargetObj.WasClicked = true;
                window.setTimeout(() => {
                    pTargetObj.FireEvent(true, "OnClick", pEvent, TPs, pTargetObj.GetProperty("Cookie"), pTargetObj.GetProperty("Parent"));
                }, 100);
            }
        }
        SetDataItem(pName, pValue) {
            this.MyDataItems[pName] = pValue;
        }
        OnLoad(bIsVisible) {
            this.SetProperty("IsUnloaded", false);
            for (const tdx in this.MyChildren) {
                this.MyChildren[tdx].SetProperty("TabIndex", this.MyChildren[tdx].MyFieldInfo ? this.MyChildren[tdx].MyFieldInfo.FldOrder + 101 : 100);
                this.MyChildren[tdx].OnLoad(bIsVisible);
            }
        }
        OnUnload() {
            this.SetProperty("IsUnloaded", true);
            for (const tdx in this.MyChildren) {
                this.MyChildren[tdx].SetProperty("TabIndex", -1);
                this.MyChildren[tdx].OnUnload();
            }
        }
        GetSetting(pName, pDefault, CompileAsJSON) {
            let res = null;
            if (this.MyFieldInfo) {
                res = this.MyFieldInfo[pName];
                if (res && CompileAsJSON === true) {
                    try {
                        res = JSON.parse(res);
                    }
                    catch (_a) {
                        res = null;
                    }
                }
                if (!res && this.MyFieldInfo.PropertyBag) {
                    res = cdeNMI.ThePB.GetValueFromBagByName(this.MyFieldInfo.PropertyBag, pName);
                    if (res && CompileAsJSON === true) {
                        try {
                            res = JSON.parse(res);
                        }
                        catch (_b) {
                            res = null;
                        }
                    }
                }
            }
            if (!res && pDefault)
                res = pDefault;
            return res;
        }
        GetProperty(pName) {
            if (pName === "PreventManipulation") {
                return this.PreventManipulation;
            }
            if (pName === "PreventDefault" || pName === "EnableMT") {
                return this.PreventDefault;
            }
            if (pName === "TouchPoints")
                return this.TouchPoints;
            if (this.PropertyBag[pName] !== undefined)
                return this.PropertyBag[pName];
            else {
                if (this.MyFieldInfo && this.MyFieldInfo[pName])
                    return this.MyFieldInfo[pName];
            }
            return null;
        }
        GetElement() {
            return this.MyRootElement;
        }
        GetContainerElement() {
            if (!this.MyContainerElement)
                return this.MyRootElement;
            else
                return this.MyContainerElement;
        }
        ApplySkin() {
            //override if needed
        }
        PostCreate(pTE) {
            //override if needed
        }
        OnNUITag(pTag, pCookie) {
            //override if needed
        }
        FindRenderTarget(pTarget) {
            if (!this.MyRootElement)
                return;
            this.MyRenderTarget = document.getElementById(pTarget);
            if (this.MyRenderTarget) {
                this.MyRootElement.parentNode.removeChild(this.MyRootElement);
                if (this.MyRenderTarget.children.length === 0) {
                    this.MyRenderTarget.appendChild(this.MyRootElement);
                    this.SetProperty("Visibility", true);
                }
            }
            else {
                setTimeout(() => {
                    if (!this.MyRenderTarget)
                        this.FindRenderTarget(pTarget);
                }, 1000);
            }
        }
        ShowFieldContent(pContent, pFieldInfo, pScreenID) {
            if (!pFieldInfo)
                pFieldInfo = this.MyFieldInfo;
            if (!pScreenID)
                pScreenID = this.MyScreenID;
            if (pFieldInfo && (pFieldInfo.Flags & 1) !== 0) {
                if (!pContent || pContent.length === 0)
                    return "";
                else
                    return "*****";
            }
            else {
                if (!cde.IsNotSet(pContent)) {
                    if (pFieldInfo) {
                        let tOptions;
                        let tFormat;
                        switch (pFieldInfo.Type) {
                            case cdeNMI.cdeControlType.Curreny:
                                if (!pContent)
                                    pContent = "Zero";
                                else
                                    pContent = "$" + parseFloat(pContent).toFixed(2);
                                break;
                            case cdeNMI.cdeControlType.DateTime:
                                if (!pContent)
                                    pContent = "&nbsp;";
                                else {
                                    const mDate = cdeNMI.cdeJsonDate2JSDate(pContent);
                                    if (mDate.toString() !== "Invalid Date") {
                                        if (mDate.getFullYear() < 2) {
                                            pContent = "";
                                        }
                                        else {
                                            try {
                                                if (pFieldInfo["Format"])
                                                    pContent = cdeNMI.FormatDate(mDate, pFieldInfo["Format"]);
                                                else
                                                    pContent = cdeNMI.FormatDate(mDate, "YYYY-MM-DD HH:mm:ss");
                                            }
                                            catch (ex) {
                                                pContent = mDate.toLocaleDateString() + " " + mDate.toLocaleTimeString();
                                            }
                                        }
                                    }
                                }
                                break;
                            case cdeNMI.cdeControlType.Number:
                                if (pContent) {
                                    tFormat = pFieldInfo["Format"];
                                    if (!cde.IsNotSet(tFormat)) {
                                        pContent = parseFloat(pContent).toFixed(parseInt(tFormat));
                                    }
                                }
                                else
                                    pContent = "0";
                                break;
                            case cdeNMI.cdeControlType.SingleCheck:
                                {
                                    tOptions = null;
                                    tOptions = pFieldInfo["Options"];
                                    if (!tOptions)
                                        tOptions = "true;false";
                                    const tOpts = tOptions.split(';');
                                    if (cde.CBool(pContent))
                                        pContent = tOpts[0];
                                    else
                                        pContent = tOpts.length > 1 ? tOpts[1] : "";
                                }
                                break;
                            //case cdeControlType.ThingPicker:
                            case cdeNMI.cdeControlType.ComboLookup:
                                {
                                    const tTableName = cde.GuidToString(this.GetSetting("StorageTarget"));
                                    let tScreenid = pScreenID;
                                    if (this.GetSetting("ModelID"))
                                        tScreenid = this.GetSetting("ModelID");
                                    const tScreenInfo = cdeNMI.MyNMIModels[cde.GuidToString(tScreenid)];
                                    if (!tScreenInfo || !tScreenInfo.MyStorageMirror[tTableName])
                                        return pContent;
                                    else {
                                        for (const tRow of tScreenInfo.MyStorageMirror[tTableName]) {
                                            const tName = cdeNMI.GetFldContentByName(tRow, this.GetSetting("ValueFld"), false);
                                            if (tName && cde.GuidToString(tName) === cde.GuidToString(pContent))
                                                return cdeNMI.GetFldContentByName(tRow, this.GetSetting("NameFld"), false);
                                        }
                                    }
                                }
                                break;
                            case cdeNMI.cdeControlType.ComboBox:
                                tOptions = this.GetProperty("OptionsLive");
                                if (!tOptions)
                                    tOptions = this.GetSetting("OptionsLive");
                                if (!tOptions)
                                    tOptions = this.GetProperty("Options");
                                if (!tOptions)
                                    tOptions = this.GetSetting("Options");
                                if (tOptions) {
                                    if (tOptions.substr(0, 6) === "LOOKUP") {
                                        let tParas = tOptions.split(':');
                                        if (tParas.length === 2) {
                                            switch (tParas[1]) {
                                                case "THINGPICKER":
                                                    tParas = "LOOKUP:b510837f-3b75-4cf2-a900-d36c19113a13:MyPropertyBag.FriendlyName.Value:cdeMID:MyPropertyBag.DeviceType.Value:FAFA22FF-96AC-42CF-B1DB-7C073053FC39".split(':');
                                                    break;
                                                case "PROPERTYPICKER":
                                                    break;
                                            }
                                        }
                                        if (tParas.length < 3) {
                                            break;
                                        }
                                        else {
                                            const tTableName = cde.GuidToString(tParas[1]);
                                            let tScreenid = pScreenID;
                                            if (tParas.length > 5)
                                                tScreenid = tParas[5];
                                            const tScreenInfo = cdeNMI.MyNMIModels[cde.GuidToString(tScreenid)];
                                            if (!tScreenInfo || !tScreenInfo.MyStorageMirror[tTableName]) {
                                                const tDT = pFieldInfo["DisplayField"];
                                                if (tDT) {
                                                    if (tScreenInfo.MyStorageMirror[cde.GuidToString(pFieldInfo.FormID)]) {
                                                        const tTargetTable = tScreenInfo.MyStorageMirror[cde.GuidToString(pFieldInfo.FormID)];
                                                        for (const tRow of tTargetTable) {
                                                            const tName = cdeNMI.GetFldContentByName(tRow, tParas[3], false);
                                                            if (tName && cde.GuidToString(tName) === cde.GuidToString(pContent)) {
                                                                const tFinal = cdeNMI.GetFldContentByName(tRow, tDT, false);
                                                                if (tFinal)
                                                                    return tFinal;
                                                            }
                                                        }
                                                    }
                                                }
                                                return pContent;
                                            }
                                            else {
                                                for (const tRow of tScreenInfo.MyStorageMirror[tTableName]) {
                                                    const tName = cdeNMI.GetFldContentByName(tRow, tParas[3], false);
                                                    if (tName && cde.GuidToString(tName) === cde.GuidToString(pContent))
                                                        return cdeNMI.GetFldContentByName(tRow, tParas[2], false);
                                                }
                                            }
                                        }
                                    }
                                    else {
                                        if (this.GetProperty("LiveOptions"))
                                            tOptions = this.GetProperty("LiveOptions");
                                        if (!tOptions && this.GetProperty("OptionsLive"))
                                            tOptions = this.GetProperty("OptionsLive");
                                        const tGroups = tOptions.split(';:;');
                                        for (const element of tGroups) {
                                            let i;
                                            if (element.substring(0, 1) === "[") {
                                                const tJOpgs = JSON.parse(element);
                                                for (i = 0; i < tJOpgs.length; i++) {
                                                    if (tJOpgs[i].V === pContent)
                                                        return tJOpgs[i].N;
                                                }
                                            }
                                            else {
                                                const tOps = element.split(';');
                                                for (i = 0; i < tOps.length; i++) {
                                                    if (tGroups.length > 1 && i === 0)
                                                        continue;
                                                    const tOptVal = tOps[i].split(':');
                                                    if (tOptVal.length > 1) {
                                                        if (pContent === tOptVal[1] || ((!pContent || pContent === '') && tOptVal[1] === '0'))
                                                            return tOptVal[0];
                                                    }
                                                    else {
                                                        if (pContent === tOptVal[0])
                                                            return tOptVal[0];
                                                    }
                                                }
                                                if (tOptions.substring(0, 12) === "SCREENPICKER") {
                                                    if (cdeNMI.MyEngine) {
                                                        cdeNMI.MyEngine.PublishToNMI('NMI_GET_DATA:SCREENRESOLVE:' + this.GetProperty("ID") + ':' + this.GetProperty("UXID") + ':' + pContent, '', this.MyFieldInfo ? this.MyFieldInfo.cdeN : null);
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                                break;
                            case cdeNMI.cdeControlType.ThingPicker:
                                return this.GetNameFromValue(pContent);
                            default:
                                if (pContent && (pFieldInfo.Flags & 256) === 0)
                                    pContent = cdeNMI.cdeEscapeHtml(pContent);
                                tFormat = pFieldInfo["Format"];
                                if (!tFormat)
                                    tFormat = this.GetProperty("Format");
                                if (!cde.IsNotSet(tFormat)) {
                                    if (cde.CInt(tFormat) > 0) {
                                        if (pContent && pContent.length > parseInt(tFormat)) {
                                            if (isNaN(Number(pContent)) === true)
                                                pContent = pContent.substring(0, parseInt(tFormat));
                                            else
                                                pContent = cde.CDbl(pContent).toFixed(parseInt(tFormat));
                                        }
                                    }
                                    else {
                                        pContent = tFormat.format(pContent);
                                        if (this.GetProperty("Cookie"))
                                            pContent = cdeNMI.GenerateFinalString(pContent, this.GetProperty("Cookie"));
                                        pContent = cdeNMI.GenerateFinalString(pContent, null, this.MyTRF);
                                    }
                                }
                                break;
                        }
                    }
                    return pContent;
                }
            }
            return "";
        }
        GetNameFromValue(pVal) {
            if (pVal.length === 0)
                return pVal;
            if (!this.GetProperty("ThingFriendlyName")) {
                return pVal;
            }
            else {
                return this.GetProperty("ThingFriendlyName");
            }
        }
        SetInitialSize(tMargin = 1) {
            this.SetInitialWidth(tMargin);
            this.SetInitialHeight(tMargin);
        }
        SetInitialWidth(tMargin = 1) {
            if (cde.CInt(this.GetSetting("PixelWidth")) != 0)
                return cde.CInt(this.GetSetting("PixelWidth"));
            //SIZING: Needs to be the same on all SF Controls
            let tW = cde.CInt(this.GetSetting("ControlTW"));
            if (tW === 0 && this.GetProperty("ControlTW"))
                tW = cde.CInt(this.GetProperty("ControlTW"));
            if (this.GetSetting("TileWidth"))
                tW = cde.CInt(this.GetSetting("TileWidth"));
            if (tW === 0 && this.GetProperty("TileWidth"))
                tW = cde.CInt(this.GetProperty("TileWidth"));
            return this.SetWidth(this.GetElement(), tW, tMargin);
        }
        SetInitialHeight(tMargin = 1) {
            if (cde.CInt(this.GetSetting("PixelHeight")) != 0)
                return cde.CInt(this.GetSetting("PixelHeight"));
            let tH = cde.CInt(this.GetSetting("ControlTH"));
            if (tH === 0 && this.GetProperty("ControlTH"))
                tH = cde.CInt(this.GetProperty("ControlTH"));
            if (this.GetSetting("TileHeight"))
                tH = cde.CInt(this.GetSetting("TileHeight"));
            if (tH === 0 && this.GetProperty("TileHeight"))
                tH = cde.CInt(this.GetProperty("TileHeight"));
            return this.SetHeight(this.GetElement(), tH, tMargin);
        }
        IsAChildBigger(tW) {
            for (const i in this.MyChildren) {
                if (this.MyChildren[i].MyBaseType !== cdeNMI.cdeControlType.Table) {
                    if (this.MyChildren[i].MyBaseType !== cdeNMI.cdeControlType.CollapsibleGroup || cde.CBool(this.MyChildren[i].GetProperty("AllowHorizontalExpand")) === false) {
                        if (cde.CInt(this.MyChildren[i].GetSegmentWidth()) > tW)
                            return true;
                    }
                    if (this.MyChildren[i].IsAChildBigger(tW) === true)
                        return true;
                }
            }
            return false;
        }
        IsAParentSmaller(tW) {
            if (this.MyTarget) {
                if (this.MyTarget.MyBaseType !== cdeNMI.cdeControlType.CollapsibleGroup || cde.CBool(this.MyTarget.GetProperty("AllowHorizontalExpand")) === false) {
                    if (cde.CInt(this.MyTarget.GetSegmentWidth()) < tW)
                        return true;
                    if (this.MyTarget.IsAParentSmaller(tW) === true)
                        return true;
                }
            }
            return false;
        }
        GetSegmentWidth() {
            let tWid = cdeNMI.GetSizeFromTile(this.GetProperty("TileWidth"));
            if (cde.CInt(this.GetProperty("TileFactorX")) > 1)
                tWid /= cde.CInt(this.GetProperty("TileFactorX"));
            else {
                if (cde.CInt(this.GetSetting("TileFactorX")) > 1)
                    tWid /= cde.CInt(this.GetSetting("TileFactorX"));
            }
            return Math.floor(tWid / cdeNMI.GetSizeFromTile(6));
        }
        SetWidth(pElement, tW, tMargin = 1, tDontCheckMaxWidth = false) {
            if (tW > 0) {
                if (this.GetProperty("MaxTileWidth") && tW > cde.CInt(this.GetProperty("MaxTileWidth")))
                    tW = cde.CInt(this.GetProperty("MaxTileWidth"));
                if (this.GetProperty("MinTileWidth") && tW < cde.CInt(this.GetProperty("MinTileWidth")))
                    tW = cde.CInt(this.GetProperty("MinTileWidth"));
                let tWid = cdeNMI.GetSizeFromTile(tW); // - tMargin; //-1 compensates for 1px margin
                if (cde.CInt(this.GetProperty("TileFactorX")) > 1)
                    tWid /= cde.CInt(this.GetProperty("TileFactorX"));
                else {
                    if (cde.CInt(this.GetSetting("TileFactorX")) > 1)
                        tWid /= cde.CInt(this.GetSetting("TileFactorX"));
                }
                if (cde.MyBaseAssets.MyServiceHostInfo.WebPlatform !== 1 && this.MyBaseType === cdeNMI.cdeControlType.CollapsibleGroup && this.MyFieldInfo && this.MyFieldInfo.FldOrder === 1 && cde.CBool(this.GetProperty("UseMargin")) === true) {
                    const tSegments = Math.floor(tW / 6);
                    if (tSegments > 0)
                        tWid += cdeNMI.GetSizeFromTile(tSegments) / 2;
                }
                const tFTS = cde.CBool(this.GetProperty("FitToScreen"));
                if (!tDontCheckMaxWidth && !tFTS && cdeNMI.MyScreenManager && cdeNMI.MyScreenManager.DocumentWidth > 0 && tWid > cdeNMI.MyScreenManager.DocumentWidth)
                    tWid = cdeNMI.MyScreenManager.DocumentWidth - (cdeNMI.GetSizeFromTile(1));
                if (pElement) {
                    pElement.style.width = tWid + "px";
                    this.MyWidth = tWid;
                }
                return tWid;
            }
            else {
                //debugger
            }
            return -1;
        }
        SetHeight(pElement, tH, tMargin = 1) {
            if (tH > 0) {
                if (this.GetProperty("MaxTileHeight") && tH > cde.CInt(this.GetProperty("MaxTileHeight")))
                    tH = cde.CInt(this.GetProperty("MaxTileHeight"));
                if (this.GetProperty("MinTileHeight") && tH < cde.CInt(this.GetProperty("MinTileHeight")))
                    tH = cde.CInt(this.GetProperty("MinTileHeight"));
                let tHei = cdeNMI.GetSizeFromTile(tH) - tMargin;
                if (cde.CInt(this.GetProperty("TileFactorY")) > 1) {
                    tHei /= cde.CInt(this.GetProperty("TileFactorY"));
                }
                else {
                    if (cde.CInt(this.GetSetting("TileFactorY")) > 1)
                        tHei /= cde.CInt(this.GetSetting("TileFactorY"));
                }
                if (pElement)
                    pElement.style.height = tHei + "px";
                this.MyHeight = tHei;
                return tHei;
            }
            else {
                if (pElement)
                    pElement.style.height = "inherit";
            }
            return -1;
        }
        static GetTileEntry(node) {
            const els = (node).getElementsByTagName("*");
            for (let i = 0, j = els.length; i < j; i++) {
                const tEle = els[i];
                if (tEle.className === "cdeTileEntryText")
                    return tEle;
            }
            return null;
        }
        //Backwards Compat requirements
        static SetPropertiesFromBag(pCtrl, pBag, pRow, pIsLive, pIsInTable) {
            return cdeNMI.ThePB.SetPropertiesFromBag(pCtrl, pBag, pRow, pIsLive, pIsInTable);
        }
    }
    cdeNMI.TheNMIBaseControl = TheNMIBaseControl;
})(cdeNMI || (cdeNMI = {}));
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
var cdeNMI;
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
(function (cdeNMI) {
    /**
    * Creates a new Screen Control that can host other controls and will be added to the NMI Screen Manager
    *
    * 4.1 Ready
     * tuned and cleaned
    */
    class TheNMIScreen extends cdeNMI.TheNMIBaseControl {
        constructor(pTRF) {
            super(null, pTRF);
            this.divDragContent = null;
            this.mDragButton = null;
            this.pos1 = 0;
            this.pos2 = 0;
            this.pos3 = 0;
            this.pos4 = 0;
            this.oldz = "";
            this.oldBC = "";
            this.ScreenScale = 0.0;
            this.IsDragging = false;
            this.MyScreenDIV = null;
            this.MyScreen = null; //BackCompat
            this.mDivDashboardContent = null;
            this.DisallowHeaderToggle = false;
            this.mIsInitialized = false;
            this.IsIFrame = false;
            this.MyHostNode = "";
            this.MyRefreshButton = null;
            this.MySavePin = null;
            this.MyShowAllPin = null;
            this.MyRefreshPin = null;
            this.MyCloseButton = null;
            this.MyPinButton = null;
            this.MyDrawPin = null;
            this.MyOverlay = null;
            this.MyPinArea = null;
            this.MyScreenTitle = null;
            this.HasRenderTarget = false;
            this.oldTop = 0;
            this.oldLeft = 0;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.Screen;
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            let tRenderTarget = this.GetSetting("RenderTarget");
            this.divDragContent = document.getElementById("Screen_" + this.MyScreenID);
            if (!this.divDragContent) {
                this.divDragContent = document.createElement("div");
                this.divDragContent.id = "Screen_" + this.MyScreenID;
                this.divDragContent.style.position = "relative"; //V4.107: New...double check with all scenarios
                const tAdd = this.GetSetting("DashBoardID");
                if (document.getElementById(tRenderTarget))
                    this.HasRenderTarget = true;
                else
                    tRenderTarget = "MyDashboard" + (tAdd ? tAdd : "");
                let tMainDash = document.getElementById(tRenderTarget);
                if (!tMainDash) {
                    tMainDash = document.createElement("div");
                    tMainDash.className = "cdeMyDashboard";
                    tMainDash.id = "MyDashboard" + (tAdd ? tAdd : "");
                    const tBody = document.getElementsByTagName("body");
                    if (tBody)
                        document.body.insertBefore(tMainDash, document.body.firstChild);
                    else
                        document.appendChild(document.createElement("body")).appendChild(tMainDash);
                }
                if (cde.CBool(this.GetSetting("AllowDrag"))) {
                    this.MyScreenDIV = document.createElement('div');
                    this.MyScreenDIV.style.position = "absolute";
                    this.MyScreenDIV.style.overflow = "hidden";
                    this.MyScreenDIV.style.zIndex = "400";
                    this.divDragContent.appendChild(this.MyScreenDIV);
                    tMainDash.appendChild(this.divDragContent); // 
                    this.SetElement(this.divDragContent, false, this.MyScreenDIV);
                }
                else {
                    this.MyScreenDIV = this.divDragContent;
                    tMainDash.appendChild(this.MyScreenDIV);
                    this.SetElement(this.MyScreenDIV);
                }
            }
            else {
                this.divDragContent.style.position = "relative"; //V4.107: New...double check with all scenarios
                this.MyScreenDIV = this.divDragContent;
                this.SetElement(this.MyScreenDIV);
            }
            this.MyScreen = this.MyScreenDIV; //BackCompat
            this.MyScreenDIV.className = cde.MyBaseAssets.MyServiceHostInfo.ScreenClassName; // "cdeBrowserTop";
            if (this.GetSetting("ScreenClassName"))
                this.MyScreenDIV.className = this.GetSetting("ScreenClassName");
            if (cde.CBool(this.GetSetting("ShowFullScreen")) === true) {
                this.MyScreenDIV.style.width = "100%";
            }
            this.divDragContent.classList.add("cde-animate-opacity");
            if (!cde.CBool(this.GetSetting("NeverHide")) && !cde.CBool(this.GetSetting("HidePins")) && !cde.MyBaseAssets.MyServiceHostInfo.HideHeader && cde.MyBaseAssets.MyServiceHostInfo.WebPlatform !== 2 && cde.MyBaseAssets.MyServiceHostInfo.WebPlatform !== 4) {
                const IsTesla = (cde.MyBaseAssets.MyServiceHostInfo.WebPlatform === 5);
                this.MyPinArea = cdeNMI.MyTCF.CreateBaseControl().Create(this);
                const tPinDiv = document.createElement("div");
                if (IsTesla)
                    tPinDiv.className = "cdePinAreaTesla";
                else
                    tPinDiv.className = "cdePinArea";
                this.MyPinArea.SetElement(tPinDiv);
                this.MyScreenTitle = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SmartLabel).Create(this.MyPinArea, { ScreenID: this.MyScreenID, PreInitBag: ["Element=h1"], PostInitBag: [(this.GetSetting("ScreenTitle") ? "iValue=" + this.GetSetting("ScreenTitle") : ""), "ClassName=cdeScreenTitle"] });
                const tAllPins = cdeNMI.MyTCF.CreateBaseControl().Create(this.MyPinArea);
                const tAllPinDiv = document.createElement("div");
                tAllPinDiv.className = "cdeAllPinArea";
                tAllPins.SetElement(tAllPinDiv);
                if (!this.HasRenderTarget) {
                    if (!cde.CBool(this.GetSetting("HidePinPins"))) {
                        this.MyPinButton = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.PinButton).Create(tAllPins, { ScreenID: this.MyScreenID, PostInitBag: ["iValue=" + (this.GetSetting("IsPinned") === true), "Right=0", "Top=6"] });
                        this.MyPinButton.SetProperty("OnClick", (val, evt, pointer) => {
                            if (evt.button === 2) {
                                if (!cdeNMI.MyScreenManager)
                                    return;
                                const tScreen = cdeNMI.MyScreenManager.GetScreenByID(this.MyScreenID);
                                if (tScreen) {
                                    if (cdeNMI.MyPopUp)
                                        cdeNMI.MyPopUp.Show('Are you sure you want to make this screen your home screen? ', false, null, 1, (tPopup, pParent, cookie) => {
                                            this.SaveHomeScreen(cookie);
                                        }, null, tScreen);
                                    else
                                        this.SaveHomeScreen(tScreen);
                                }
                            }
                            else {
                                if (!cde.CBool(this.GetProperty("IsPinned"))) {
                                    this.SetProperty("IsPinned", true);
                                }
                                else {
                                    if (cdeNMI.MyScreenManager && (this !== cdeNMI.MyScreenManager.GetCurrentScreen() || cdeNMI.MyScreenManager.AreScreensPinned(this) > 0)) {
                                        this.SetProperty("Visibility", false);
                                        if (this === cdeNMI.MyScreenManager.GetCurrentScreen()) {
                                            const tNS = cdeNMI.MyScreenManager.FindPinnedScreen();
                                            if (tNS)
                                                cdeNMI.MyScreenManager.SetCurrentScreen(tNS);
                                        }
                                    }
                                    this.SetProperty("IsPinned", false);
                                }
                                this.ShowPin();
                            }
                        });
                        let tPosRight = 35;
                        if (IsTesla) {
                            this.MyPinButton.SetProperty("Content", "<i class='fa fa-2x'>&#xf08d;</i>");
                            tPosRight = 60;
                        }
                        else
                            this.MyPinButton.SetProperty("Content", "<i class='fa'>&#xf08d;</i>");
                        this.ShowPin();
                        const tUpPin = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.PinButton).Create(tAllPins, { ScreenID: this.MyScreenID, PostInitBag: ["iValue=true", "Right=" + tPosRight, "Top=6", "ClassName=cdeDivUp"] });
                        tUpPin.SetProperty("OnClick", (val, evt, pointer) => {
                            const tH = this.GetElement();
                            const tParent = tH.parentElement;
                            let tLPos = -1;
                            for (let index = 0; index < tH.parentElement.children.length; index++) {
                                if (tH.parentElement.children[index] === tH) {
                                    if (tLPos >= 0) {
                                        const tNode = tH.parentElement.children[tLPos];
                                        tH.parentElement.removeChild(tH);
                                        tParent.insertBefore(tH, tNode);
                                    }
                                    break;
                                }
                                if (tH.parentElement.children[index].style.display !== 'none')
                                    tLPos = index;
                            }
                            if (cdeNMI.MyScreenManager)
                                cdeNMI.MyScreenManager.RenumberScreens();
                        });
                        if (IsTesla) {
                            tUpPin.SetProperty("Content", "<i class='fa fa-2x'>&#xf062;</i>");
                            tPosRight = 120;
                        }
                        else {
                            tUpPin.SetProperty("Content", "<i class='fa'>&#xf062;</i>");
                            tPosRight = 70;
                        }
                        const tDnPin = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.PinButton).Create(tAllPins, { ScreenID: this.MyScreenID, PostInitBag: ["iValue=true", "Right=" + tPosRight, "Top=6", "ClassName=cdeDivDown"] });
                        tDnPin.SetProperty("OnClick", (val, evt, pointer) => {
                            const tH = this.GetElement();
                            const tParent = tH.parentElement;
                            let tLPos = -1;
                            for (let index = tH.parentElement.children.length - 1; index >= 0; index--) {
                                if (tH.parentElement.children[index] === tH) {
                                    if (tLPos < tH.parentElement.children.length - 1) {
                                        const tNode = tH.parentElement.children[tLPos + 1];
                                        if (tNode === tH)
                                            break;
                                        tH.parentElement.removeChild(tH);
                                        tParent.insertBefore(tH, tNode);
                                    }
                                    else {
                                        tH.parentElement.removeChild(tH);
                                        tParent.appendChild(tH);
                                    }
                                    break;
                                }
                                if (tH.parentElement.children[index].style.display !== 'none')
                                    tLPos = index;
                            }
                            if (cdeNMI.MyScreenManager)
                                cdeNMI.MyScreenManager.RenumberScreens();
                        });
                        if (IsTesla) {
                            tDnPin.SetProperty("Content", "<i class='fa fa-2x'>&#xf063;</i>");
                        }
                        else {
                            tDnPin.SetProperty("Content", "<i class='fa'>&#xf063;</i>");
                        }
                    }
                    else {
                        if (cde.CBool(this.GetSetting("IsPopup")) === true) {
                            this.MyCloseButton = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.PinButton).Create(tAllPins, { ScreenID: this.MyScreenID, PostInitBag: ["Right=0", "Top=6", "ClassName=cdeDivSave"] });
                            this.MyCloseButton.SetProperty("OnClick", (val, evt, pointer) => {
                                if (cdeNMI.MyScreenManager) {
                                    cdeNMI.MyScreenManager.TransitToScreen(this.GetProperty("OldScreen"));
                                }
                            });
                            this.MyCloseButton.SetProperty("Content", "<i class='fa'>&#xf410;</i>");
                        }
                    }
                }
                if (!IsTesla) {
                    this.MySavePin = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.PinButton).Create(tAllPins, { ScreenID: this.MyScreenID, PostInitBag: ["iValue=true", "Right=140", "Top=6", "ClassName=cdeDivSave"] });
                    this.MySavePin.SetProperty("OnClick", (val, evt, pointer) => {
                        var _a, _b, _c;
                        const tScreen = cdeNMI.MyTCF.GetRegisteredControl("TABLES", this.MyScreenID);
                        if (tScreen) {
                            if (evt.button === 2) {
                                if (cdeNMI.MyEngine) {
                                    cdeNMI.MyEngine.PublishToNMI("NMI_CLEAR_SCREEN:" + this.MyScreenID, tScreen.MyDataRow.cdeN);
                                    cdeNMI.ShowToastMessage("Screen options cleared");
                                }
                                else
                                    cdeNMI.ShowToastMessage("No NMI Engine found - Screen options not cleared!");
                            }
                            else {
                                if (cdeNMI.MyEngine) {
                                    const tScene = new cdeNMI.TheFOR();
                                    tScene.ID = this.MyScreenID;
                                    tScene.TileWidth = tScreen.GetProperty("TileWidth");
                                    if (tScreen.GetProperty("StartGroup"))
                                        tScene.StartGroup = tScreen.GetProperty("StartGroup");
                                    tScene.Flds = new Array();
                                    for (const i in tScreen.MyFormControls) {
                                        const tF = tScreen.MyFormControls[i];
                                        const tOpt = new cdeNMI.TheFLDOR();
                                        tOpt.PO = [];
                                        if (tF.MyFieldInfo)
                                            tOpt.FldOrder = tF.MyFieldInfo.FldOrder;
                                        if (((_a = tF.MyDirtyList) === null || _a === void 0 ? void 0 : _a.length) > 0) {
                                            for (const element of tF.MyDirtyList) {
                                                tOpt.PO.push(`${element}=${tF.GetProperty(element)}`);
                                            }
                                            tScene.Flds.push(tOpt);
                                        }
                                        if (((_c = (_b = tF.MyNMIControl) === null || _b === void 0 ? void 0 : _b.MyDirtyList) === null || _c === void 0 ? void 0 : _c.length) > 0) {
                                            for (const element of tF.MyNMIControl.MyDirtyList) {
                                                tOpt.PO.push(`${element}=${tF.MyNMIControl.GetProperty(element)}`);
                                            }
                                            tScene.Flds.push(tOpt);
                                        }
                                        if (tF.MyBaseType === cdeNMI.cdeControlType.CollapsibleGroup) {
                                            if (tScene.TileWidth === null) {
                                                if (cde.CBool(tF.GetProperty("AllowHorizontalExpand")) === true)
                                                    tScene.TileWidth = tF.GetProperty("ControlTW");
                                                else
                                                    tScene.TileWidth = 0;
                                            }
                                            tOpt.PO.push("DoClose=" + !cde.CBool(tF.GetProperty("IsOpen")));
                                            if (cde.CInt(tF.GetProperty("TileWidth")) > 0)
                                                tOpt.PO.push("TileWidth=" + tF.GetProperty("TileWidth"));
                                            tScene.Flds.push(tOpt);
                                        }
                                    }
                                    const tStr = JSON.stringify(tScene);
                                    cdeNMI.MyEngine.PublishToNMI("NMI_SAVE_SCREEN:" + this.MyScreenID, tStr, tScreen.MyDataRow.cdeN);
                                    cdeNMI.ShowToastMessage("Screen options saved");
                                }
                                else {
                                    cdeNMI.ShowToastMessage("No NMI Engine found - Screen options not saved");
                                }
                            }
                        }
                    });
                    this.MySavePin.SetProperty("Content", "<i class='fa'>&#xf0c7;</i>");
                    this.MySavePin.SetProperty("Visibility", false);
                    this.MyShowAllPin = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.PinButton).Create(tAllPins, { ScreenID: this.MyScreenID, PostInitBag: ["iValue=true", "Right=175", "Top=6", "ClassName=cdeDivSave"] });
                    this.MyShowAllPin.SetProperty("Content", "<i class='fa'>&#xf06e;</i>");
                    this.MyShowAllPin.SetProperty("Visibility", false);
                }
                this.MyRefreshPin = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.PinButton).Create(tAllPins, { ScreenID: this.MyScreenID, PostInitBag: ["iValue=true", "Left=0", "Top=6", "ClassName=cdeDivRefresh"] });
                this.MyRefreshPin.SetProperty("OnClick", (val, evt, pointer) => {
                    if (!cdeNMI.MyEngine || !cdeNMI.MyScreenManager)
                        return;
                    const tScreen = cdeNMI.MyScreenManager.GetScreenByID(this.MyScreenID);
                    if (tScreen) {
                        if (this.MyNMIControl && this.MyNMIControl.ReloadData() === true)
                            return;
                        let bForce = false;
                        if (evt.button !== 2)
                            bForce = true;
                        const tFetch = 'NMI_GET_DATA:' + this.MyScreenID + ':' + tScreen.GetProperty("ControlClass") + ':' + tScreen.GetProperty("DashID") + ':true:' + bForce;
                        cdeNMI.MyEngine.PublishToNMI(tFetch, '', this.MyFieldInfo ? this.MyFieldInfo.cdeN : null);
                    }
                });
                if (IsTesla)
                    this.MyRefreshPin.SetProperty("Content", "<i class='fa fa-3x'>&#xf021;</i>");
                else
                    this.MyRefreshPin.SetProperty("Content", "<i class='fa'>&#xf021;</i>");
                this.MyRefreshPin.SetProperty("Visibility", false);
                if (cde.MyBaseAssets.MyServiceHostInfo.RedPill === true) {
                    this.MyDrawPin = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.PinButton).Create(tAllPins, { ScreenID: this.MyScreenID, PostInitBag: ["iValue=true", "Right=105", "Top=6", "ClassName=cdeDivDraw"] });
                    this.MyDrawPin.SetProperty("OnClick", (val, evt, pointer) => {
                        if (!this.MyOverlay) {
                            const tcr = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.DrawOverlay);
                            tcr.MyFormID = this.MyScreenID;
                            this.MyOverlay = tcr.Create(this, { PreInitBag: ["HideClear=true", "EnableRecognizer=true"], ScreenID: this.MyScreenID });
                        }
                        else {
                            cdeNMI.UnselectAllControls();
                            this.RemoveChild(this.MyOverlay);
                            this.MyOverlay = null;
                        }
                    });
                    this.MyDrawPin.SetProperty("Content", "<i class='fa'>&#xf044;</i>");
                    this.MyDrawPin.SetProperty("Visibility", !cde.CBool(this.GetSetting("UseIFrame")));
                }
                if (cde.CBool(this.GetSetting("AllowDrag"))) {
                    this.mDragButton = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.PinButton).Create(tAllPins, { ScreenID: this.MyScreenID, PostInitBag: ["iValue=true", "Right=175", "Top=6", "ClassName=cdeDivDraw"] });
                    this.mDragButton.SetProperty("Content", "<i class='fa'>&#xF0b2;</i>");
                    this.mDragButton.SetProperty("HoverClassName", "cdeDragButton");
                    this.mDragButton.SetProperty("OnPointerDown", (sender, e) => {
                        if (this.IsDragging) {
                            this.closeDragElement(e);
                            return;
                        }
                        e = e || window.event;
                        e.preventDefault();
                        this.pos3 = e.clientX;
                        this.pos4 = e.clientY;
                        this.mDragButton.SetProperty("Foreground", "green");
                        this.IsDragging = true;
                        this.oldz = this.MyScreenDIV.style.zIndex;
                        this.MyScreenDIV.style.zIndex = "450";
                        document.onpointerup = (evt) => { this.closeDragElement(evt); };
                        document.onpointermove = (evt) => { this.elementDrag(evt); };
                    });
                }
            }
            if (cde.CBool(this.GetSetting("UseIFrame"))) {
                this.mDivDashboardContent = document.createElement("iframe");
                this.mDivDashboardContent.className = "cdeDashboardIFrame";
                this.mDivDashboardContent.style.width = "inherit";
                this.mDivDashboardContent.style.height = "inherit";
                this.IsIFrame = true;
                this.mDivDashboardContent.onload = (evt) => {
                    this.FireEvent(true, "OnIFrameLoaded", evt);
                };
            }
            else
                this.mDivDashboardContent = document.createElement("div");
            this.mDivDashboardContent.id = "Content_" + this.MyScreenID;
            this.mDivDashboardContent.className = "CMyDashboard";
            if (cde.CBool(this.GetSetting("ShowFullScreen")) === true) {
                this.mDivDashboardContent.style.width = "100%";
                this.mDivDashboardContent.style.display = "flex";
                this.mDivDashboardContent.style.verticalAlign = "middle";
                this.mDivDashboardContent.style.height = (window.innerHeight - cdeNMI.GetSizeFromTile(1)) + "px";
            }
            this.MyScreenDIV.appendChild(this.mDivDashboardContent);
            this.MyContainerElement = this.mDivDashboardContent;
            if (cdeNMI.MyScreenManager) {
                this.SetProperty("FldOrder", cdeNMI.MyScreenManager.GetScreenIndex());
                if (cde.CBool(this.GetProperty("IsPopup"))) {
                    cdeNMI.MyScreenManager.RegisterEvent("OnWindowResize", () => { this.ResizePopup(); });
                    cdeNMI.MyScreenManager.RegisterEvent("OnWindowScroll", () => { this.ResizePopup(); });
                }
            }
            return true;
        }
        closeDragElement(e) {
            e.stopPropagation();
            e.preventDefault();
            this.IsDragging = false;
            /* stop moving when mouse button is released:*/
            document.onpointermove = null;
            document.onpointerup = null;
            this.mDragButton.SetProperty("Foreground", null);
            this.MyScreenDIV.style.zIndex = this.oldz;
            this.ApplySkin();
        }
        elementDrag(e) {
            e = e || window.event;
            e.preventDefault();
            // calculate the new cursor position:
            this.pos1 = this.pos3 - e.clientX;
            this.pos2 = this.pos4 - e.clientY;
            this.pos3 = e.clientX;
            this.pos4 = e.clientY;
            if (this.pos1 === 0 && this.pos2 === 0) {
                this.closeDragElement(e);
                return;
            }
            this.IsDragging = true;
            // set the element's new position:
            this.oldTop = (this.oldTop - this.pos2);
            this.oldLeft = (this.oldLeft - this.pos1);
            this.MyScreenDIV.style.top = (this.oldTop) + "px";
            this.MyScreenDIV.style.left = (this.oldLeft) + "px";
        }
        SaveHomeScreen(tScreen) {
            const tScene = new cdeNMI.TheNMIScene();
            tScene.FriendlyName = "MyHome";
            tScene.IsPublic = false;
            tScene.Screens = new Array();
            const tS = new cdeNMI.TheScreenTrans();
            tS.ID = this.MyScreenID;
            tS.DashID = tScreen.GetProperty("DashID");
            let tStr = "RESET";
            if (tS.DashID) {
                tS.IsVisible = true;
                tS.IsPinned = false;
                tS.FldOrder = -1;
                tScene.Screens.push(tS);
                tStr = JSON.stringify(tScene);
            }
            if (cdeNMI.MyEngine)
                cdeNMI.MyEngine.PublishToNMI("NMI_SAVE_HOMESCENE", tStr);
            cdeNMI.ShowToastMessage("Home Scene saved!");
        }
        SetInitialized(bRegisterOnly) {
            this.mIsInitialized = true;
            if (cdeNMI.MyScreenManager && !cde.CBool(this.GetSetting("NeverHide")))
                cdeNMI.MyScreenManager.RegisterScreen(this.MyScreenID, this, bRegisterOnly);
            this.ResizePopup();
        }
        ResizePopup() {
            if (cde.CBool(this.GetProperty("IsPopup"))) {
                this.GetElement().style.left = (window.innerWidth / 2 - (this.GetElement().clientWidth / 2) + "px");
                let tH = this.GetElement().clientHeight;
                if (tH === 0)
                    tH = cdeNMI.GetSizeFromTile(this.GetProperty("TileHeight"));
                this.GetElement().style.top = ((window.innerHeight / 2 - (tH / 2) + window.scrollY) + "px");
            }
        }
        GetInitialized() {
            return this.mIsInitialized;
        }
        ApplySkin() {
            if (!this.IsIFrame && cde.CBool(this.GetProperty("AllowScrolling")) && this.GetContainerElement())
                this.GetContainerElement().style.width = (this.MyScreenDIV.clientWidth + 20) + "px";
        }
        SetProperty(pName, pValue) {
            if (pName.startsWith("IsOwnerDown")) {
                const tCmds = pName.split(':');
                if (tCmds.length < 2)
                    return;
                if (pValue === true) {
                    if (this.GetProperty(pName) === true)
                        return;
                    if (this.GetProperty("IsDashboard") === true) {
                        for (const cl in this.MyChildren) {
                            const tBut = this.MyChildren[cl];
                            if (tBut && tBut.MyFieldInfo && tBut.MyFieldInfo.cdeN === tCmds[1])
                                tBut.SetProperty("IsOwnerDown", true);
                        }
                    }
                    else {
                        if (!this.MyScreenDIV.classList.contains("cdeNodeGone"))
                            this.MyScreenDIV.classList.add("cdeNodeGone");
                    }
                }
                else {
                    if (this.GetProperty(pName) !== true)
                        return;
                    if (this.GetProperty("IsDashboard") === true) {
                        for (const cl in this.MyChildren) {
                            const tBut = this.MyChildren[cl];
                            if (tBut && tBut.MyFieldInfo && tBut.MyFieldInfo.cdeN === tCmds[1])
                                tBut.SetProperty("IsOwnerDown", false);
                        }
                    }
                    else {
                        this.MyScreenDIV.classList.remove("cdeNodeGone");
                    }
                }
            }
            if (pName === "Visibility" && cde.CBool(pValue) === false) {
                //debugger
            }
            if (pName === "ClassName" && this.GetContainerElement()) {
                this.GetContainerElement().className = pValue;
            }
            else if (pName === "ScreenClassName") {
                super.SetProperty("ClassName", pValue + " cde-animate-opacity");
            }
            else
                super.SetProperty(pName, pValue);
            if ((pName === "Value" || pName === "iValue" || pName === "Text" || pName === "Label" || pName === "Caption" || pName === "Title") && this.MyScreenTitle) {
                const tFormat = this.GetProperty("LabelFormat");
                if (tFormat)
                    pValue = tFormat.format(pValue);
                this.MyScreenTitle.SetProperty("Text", pValue);
            }
            else if ((pName === "LabelFormat" || pName === "ScreenTitle") && this.MyScreenTitle && pValue) {
                if (pValue.indexOf("{0}") >= 0)
                    pValue = pValue.format(this.GetProperty("iValue"));
                this.MyScreenTitle.SetProperty("Text", pValue);
            }
            else if (pName === "IsPinned") {
                this.ShowPin();
            }
            else if (pName === "Source" && this.IsIFrame) {
                this.MyContainerElement.src = pValue;
            }
            else if (pName === "OnIFRameLoaded" && this.IsIFrame) {
                this.RegisterEvent("OnIFrameLoaded", pValue);
            }
            else if (pName === "TileHeight" && this.GetContainerElement()) {
                if (!cde.CBool(this.GetSetting("HidePins")))
                    this.GetContainerElement().style.height = (this.GetElement().clientHeight - 44) + "px"; //44=39 +5
                else
                    this.GetContainerElement().style.height = "inherit";
            }
            else if (pName === "TileWidth") {
                this.ApplySkin();
            }
            else if (pName === "AllowScrolling" && this.GetContainerElement()) {
                this.GetContainerElement().style.overflow = "auto";
                this.ApplySkin();
            }
            else if (pName === "HidePins" && this.MyPinArea) {
                this.MyPinArea.SetProperty("Visibility", !cde.CBool(pValue));
            }
        }
        OnLoad(bIsVisible) {
            if (this.MyNMIControl)
                this.MyNMIControl.OnLoad(bIsVisible);
            super.OnLoad();
            this.SetProperty("LastShow", new Date());
            this.FireEvent(true, "OnLoaded");
            if (cde.CBool(this.GetProperty("IsPopup"))) {
                this.ResizePopup();
            }
        }
        ShowPin() {
            if (!this.MyPinButton)
                return;
            if (cde.CBool(this.GetProperty("IsPinned")) === true) {
                this.MyPinButton.SetProperty("iValue", true);
                this.MyPinButton.SetProperty("ClassName", "cdePinDiv");
            }
            else {
                this.MyPinButton.SetProperty("ClassName", "cdePinDiv fa-rotate-45");
                this.MyPinButton.SetProperty("iValue", false);
            }
        }
        ShowFullscreen(bFull) {
            if (this.MyScreenDIV) {
                this.SetProperty("IsFullScreen", bFull);
                if (bFull)
                    this.MyScreenDIV.style.maxWidth = "100%";
                else
                    this.MyScreenDIV.style.maxWidth = "";
            }
        }
        Clear(bClearKids) {
            if (bClearKids)
                this.ClearChildren(bClearKids);
            if (this.divDragContent)
                this.divDragContent.classList.remove("cde-animate-opacity");
            this.GetContainerElement().innerHTML = "";
        }
        ClearChildren(bClearKids) {
            if (!cdeNMI.MyScreenManager)
                return;
            for (const tIdx in this.MyChildren)
                cdeNMI.MyScreenManager.DeleteScreenByID(tIdx, bClearKids);
        }
        AppendChild(pEle) {
            this.GetContainerElement().appendChild(pEle.GetElement());
        }
        AppendContent(pEle) {
            this.GetContainerElement().innerHTML = pEle;
        }
        CreateHTMLView(pHTML) {
            if (this.GetContainerElement())
                this.GetContainerElement().innerHTML = pHTML;
        }
        CreateScriptInView(pScript) {
            if (!this.GetContainerElement())
                return;
            const tScripEle = this.GetContainerElement().getElementsByTagName("script");
            if (tScripEle.length === 0) {
                if (this.mIsInitialized)
                    return;
                this.GetContainerElement().innerHTML = "";
                const s = document.createElement('script');
                s.type = "text/javascript";
                s.text = pScript;
                this.GetContainerElement().appendChild(s);
            }
        }
        CreateCSSInView(pStyle) {
            if (!this.GetContainerElement())
                return;
            const tScripEle = this.GetContainerElement().getElementsByTagName("style");
            if (tScripEle.length > 0) {
                tScripEle[0].innerText = pStyle;
            }
            else {
                const s = document.createElement('style');
                s.type = "text/css";
                s.innerText = pStyle;
                this.GetContainerElement().insertBefore(s, this.GetContainerElement().firstChild);
            }
        }
        UpdateCSSInView(pStyle) {
            if (!this.GetContainerElement())
                return;
            const tScripEle = this.GetContainerElement().getElementsByTagName("style");
            if (tScripEle.length > 0) {
                tScripEle[0].innerText = pStyle;
            }
        }
        RemoveCSSInView() {
            if (!this.GetContainerElement())
                return;
            const tScripEle = this.GetContainerElement().getElementsByTagName("style");
            if (tScripEle.length > 0) {
                tScripEle[0].parentElement.removeChild(tScripEle[0]);
            }
        }
        OnNUITag(pTag, pCookie) {
            if (cdeNMI.MyScreenManager)
                cdeNMI.MyScreenManager.TransitToScreen(this.MyScreenID);
        }
        //Backwards compat
        static GetScreenByID(pScreenID) {
            if (cdeNMI.MyScreenManager)
                return cdeNMI.MyScreenManager.GetScreenByID(pScreenID);
            return null;
        }
    }
    cdeNMI.TheNMIScreen = TheNMIScreen;
})(cdeNMI || (cdeNMI = {}));
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
var cdeNMI;
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
(function (cdeNMI) {
    /**
     * TheScreenManager manages the main portal screen, screen navigation, login/off etc
     * */
    class TheScreenManager extends cdeNMI.TheNMIBaseControl {
        constructor(pTarget) {
            super(null);
            this.divSideBarRight = null;
            this.MyNMIScreens = new Array(); //All currently registered screens
            this.MyNavHistory = new Array(); //Navigation Histor
            this.MyDrawOverlay = null; // Draw / Annotation overlay
            this.MyMainBackButton = null; // Main Back Button 
            this.MyPopupOverlay = null;
            this.CurrentScreen = null; //The Current screen visible in the NMI
            this.CurrentView = null; //CurrentView (scene) displayed
            this.StartView = null; //Start View (scece) when user logs in
            this.IsHeaderVisible = true; //Is the HEader visible or not
            this.IsBrowserFullscreen = false; //Is the HEader visible or not
            this.WasLoginHandled = false;
            this.ScreenOrder = 0; //All Screens have a uinique order
            this.WaitingForScreen = null; //Temporary screen shown until a screen has loaded
            this.DocumentWidth = 0;
            this.IsLoaded = false;
            this.MyBaseType = cdeNMI.cdeControlType.ScreenManager;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            cdeNMI.MyNMIPortal = new cdeNMI.TheNMIScreen(null);
            cdeNMI.MyNMIPortal.MyFormID = "NMIPORTAL";
            cdeNMI.MyNMIPortal.MyScreenID = "MYNMIPORTAL";
            cdeNMI.MyNMIPortal.SetProperty("IsAlwaysVisible", true);
            let tPortal = document.getElementById("MyNMIPortal");
            if (!tPortal) {
                tPortal = document.createElement("div");
                tPortal.className = "cdeNMIPortal";
                tPortal.id = "MyNMIPortal";
                const tBody = document.getElementsByTagName("body");
                if (tBody)
                    document.body.insertBefore(tPortal, document.body.firstChild);
                else
                    document.appendChild(document.createElement("body")).appendChild(tPortal);
            }
            document.body.oncontextmenu = () => { return false; };
            cdeNMI.MyNMIPortal.SetElement(tPortal);
            this.RegisterScreen(cdeNMI.MyNMIPortal.MyScreenID, cdeNMI.MyNMIPortal, true);
            this.IsBrowserFS();
            let mDivMainDashboard = document.getElementById("MyDashboard");
            if (!mDivMainDashboard) {
                mDivMainDashboard = document.createElement("div");
                mDivMainDashboard.className = "cdeMyDashboard";
                mDivMainDashboard.id = "MyDashboard";
                tPortal.appendChild(mDivMainDashboard);
            }
            this.divSideBarRight = document.getElementById("cdeSideBarRight");
            if (!this.divSideBarRight) {
                this.divSideBarRight = document.createElement("div");
                this.divSideBarRight.id = "cdeSideBarRight";
                this.divSideBarRight.className = "cdeSideBarRight cdeBlurBack";
                this.divSideBarRight.style.display = "none";
                const divSideBarRightHead = document.createElement("div");
                divSideBarRightHead.id = "cdeInSideBarRightHeader";
                divSideBarRightHead.className = "cdeSideRightHeader";
                this.divSideBarRight.appendChild(divSideBarRightHead);
                const tCtrl = new cdeNMI.TheNMIBaseControl();
                tCtrl.SetElement(divSideBarRightHead);
                const tDnPin = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.PinButton).Create(tCtrl, { ScreenID: this.MyScreenID, PostInitBag: ["Left=6", "Top=6", "ClassName=cdeDivDraw"] });
                tDnPin.SetProperty("OnClick", (val, evt, pointer) => {
                    var _a;
                    this.divSideBarRight.style.display = 'none';
                    this.divSideBarRight.classList.remove("cde-animate-right");
                    cdeNMI.UnselectAllControls();
                    if ((_a = this.CurrentScreen) === null || _a === void 0 ? void 0 : _a.MyOverlay)
                        this.CurrentScreen.MyOverlay.SetProperty("IsDisabled", false);
                });
                tDnPin.SetProperty("Content", "<i class='fa fa-2x'>&#xf061;</i>");
                const divSideBarRightIn = document.createElement("div");
                divSideBarRightIn.id = "cdeInSideBarRight";
                this.divSideBarRight.appendChild(divSideBarRightIn);
                document.body.appendChild(this.divSideBarRight);
            }
            this.DocumentWidth = document.body.clientWidth + cdeNMI.GetSizeFromTile(1);
            this.SetElement(tPortal, false, mDivMainDashboard);
            this.IsLoaded = true;
            this.FireEvent(false, "OnIsLoaded", this.IsLoaded);
            return true;
        }
        RegisterEvents() {
            if (window.addEventListener) {
                window.addEventListener("resize", () => { this.ResizeEventHandler(); }, false);
                window.addEventListener("scroll", () => { this.ScollEventHandler(); }, false);
            }
            document.onkeydown = (evt) => {
                const keyCode = evt ? (evt.which ? evt.which : evt.keyCode) : evt.keyCode;
                if (keyCode === 13) {
                    if (cdeNMI.Key13Event !== null)
                        cdeNMI.Key13Event(evt);
                    cdeNMI.Key13Event = null;
                }
                else if (keyCode === 27) {
                    //For escape.
                    if (cdeNMI.Key27Event !== null)
                        cdeNMI.Key27Event(evt);
                    cdeNMI.Key27Event = null;
                }
                else if (keyCode === 36 && cde.MyBaseAssets.MyServiceHostInfo.WasPortalRequested && cdeNMI.Key13Event === null) {
                    if (!cdeNMI.DisableKey36Event)
                        this.GotoStationHome(false);
                }
                else if (keyCode === 10009) {
                    if (cdeNMI.MyScreenManager)
                        cdeNMI.MyScreenManager.NavigateBack(false);
                }
                else if (keyCode === 39) {
                    cdeNMI.focusNextElement(false);
                }
                else if (keyCode === 37) {
                    cdeNMI.focusNextElement(true);
                }
                if (keyCode > 47 && keyCode < 58 && cdeNMI.Key13Event === null) {
                    this.TransitToScreenIDX(keyCode - 48);
                }
            };
            window.onpopstate = () => {
                this.NavigateBack(false);
            };
            if (!cde.MyBaseAssets.MyServiceHostInfo.DoAllowAnonymous) {
                if (!cde.MyBaseAssets.MyCommStatus.IsUserLoggedIn) {
                    cdeNMI.MyLoginScreen = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.LoginScreen, true);
                    if (cdeNMI.MyLoginScreen) {
                        cdeNMI.MyLoginScreen.RegisterEvent("OnLogin", (s, p, t) => { this.HandleLogin(p, t); });
                        cdeNMI.MyLoginScreen.Create(null);
                        this.CreateLoginButtonOnly();
                    }
                    else {
                        if (cdeNMI.MyPopUp)
                            cdeNMI.MyPopUp.Show("NMI Requires Login but no login provider found. Access is denied", true, null, null, () => {
                                cdeNMI.ResetBrowserToPortal();
                            });
                    }
                }
                else {
                    this.HandleLogin(true);
                }
            }
            if (cdeNMI.MyEngine) {
                cdeNMI.MyEngine.RegisterEvent("CDE_SETSTATUSMSG", (sender, a, b) => { this.SetStatusMsg(a, b); });
                cdeNMI.MyEngine.RegisterEvent("CDE_SETPLATFORM", (sender, pID) => { this.SetPlatform(pID); });
                if (cdeNMI.MyEngine.IsConnectedAndReady)
                    this.sinkEngineReady(cdeNMI.MyEngine, true);
                else
                    cdeNMI.MyEngine.RegisterEvent("EngineReady", (sender, bReady) => { this.sinkEngineReady(sender, bReady); });
            }
            else {
                this.sinkEngineReady(null, true);
            }
        }
        RemoveAllScreens() {
            this.MyNMIScreens = new Array(); //All currently registered screens
            this.MyNavHistory = new Array(); //Navigation Histor
            let mDivMainDashboard = document.getElementById("MyDashboard");
            if (mDivMainDashboard)
                mDivMainDashboard.innerHTML = "";
            mDivMainDashboard = document.getElementById("MyDashboardLOGIN");
            if (mDivMainDashboard)
                mDivMainDashboard.innerHTML = "";
        }
        ResizeEventHandler() {
            this.DocumentWidth = document.body.clientWidth + cdeNMI.GetSizeFromTile(1);
            this.IsBrowserFS();
            this.FireEvent(true, "OnWindowResize");
        }
        ScollEventHandler() {
            this.FireEvent(true, "OnWindowScroll");
        }
        IsBrowserFS() {
            if (window.innerWidth === screen.width && window.innerHeight === screen.height) {
                if (!this.IsBrowserFullscreen) {
                    this.IsBrowserFullscreen = true;
                    this.FireEvent(true, "OnBrowserFullscreen", true);
                }
            }
            else {
                if (this.IsBrowserFullscreen) {
                    this.IsBrowserFullscreen = false;
                    this.FireEvent(true, "OnBrowserFullscreen", false);
                }
            }
        }
        CreateLoginButtonOnly() {
            let tileButHeaderBtnLogin;
            if (cde.MyBaseAssets.MyServiceHostInfo.WebPlatform !== 0) {
                tileButHeaderBtnLogin = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(null, { PreInitBag: ["ControlTW=1", "ControlTH=1"], PostInitBag: ["Title=<span class='fa fa-5x' style='font-size:40px'>&#xf011;</span>", "ClassName=MyHeaderButton"] });
                tileButHeaderBtnLogin.SetProperty("OnClick", (pSender, evt) => {
                    if (evt.button === 2 && cde.MyBaseAssets.MyServiceHostInfo.WasPortalRequested === true) {
                        this.TransitToScreen(cde.MyBaseAssets.MyServiceHostInfo.PortalScreen);
                    }
                    else
                        cdeNMI.ResetBrowserToPortal();
                });
            }
            else {
                tileButHeaderBtnLogin = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.UserMenu).Create(null);
            }
            tileButHeaderBtnLogin.SetProperty("TabIndex", 15);
            let divHeadButtonContentRight = document.getElementById("HeaderButtonContentRight");
            if (!divHeadButtonContentRight) {
                divHeadButtonContentRight = document.createElement("div");
                divHeadButtonContentRight.className = "cdeHeaderButtonContentRight";
                divHeadButtonContentRight.id = "HeaderButtonContentRight";
                let tMyHeader = document.getElementById("MyHeader");
                if (!tMyHeader) {
                    tMyHeader = document.createElement("div");
                    tMyHeader.className = "cdeLogoffTopRight";
                    tMyHeader.id = "MyLogoffButton";
                    this.GetElement().parentNode.insertBefore(tMyHeader, this.GetElement().nextSibling);
                }
                tMyHeader.appendChild(divHeadButtonContentRight);
            }
            if (cde.MyBaseAssets.MyServiceHostInfo.WebPlatform !== 1) {
                const tClock = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(null, { PreInitBag: ["ControlTW=2", "ControlTH=1"], PostInitBag: ["Title=" + cdeNMI.UpdateClock(), "ClassName=MyHeaderButton"] });
                tClock.SetProperty("Disabled", true);
                divHeadButtonContentRight.appendChild(tClock.GetElement());
                cdeNMI.StartClock(tClock);
            }
            divHeadButtonContentRight.appendChild(tileButHeaderBtnLogin.GetElement());
            if (cde.MyBaseAssets.MyCommStatus.UserPref && cde.MyBaseAssets.MyCommStatus.UserPref.CurrentUserName)
                tileButHeaderBtnLogin.SetProperty("Caption", "<span class='fa fa-5x' style='font-size:40px'>&#xf2bd;</span></br>" + cde.MyBaseAssets.MyCommStatus.UserPref.CurrentUserName);
        }
        SetApplicationBar() {
            //override if needed
        }
        ShowCreateViewPopup() {
            const tGroup = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileGroup).Create(null);
            tGroup.SetProperty("ClassName", "cdeTextCrop");
            const tFld2 = new cdeNMI.TheFieldInfo(cdeNMI.cdeControlType.SingleEnded, -1, "Name:", 2);
            tFld2.FormID = "SAVEVIEW";
            const tEdit = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SingleEnded).Create(tGroup, { TRF: new cdeNMI.TheTRF("SceneName", 1, tFld2), PostInitBag: ["ClassName=cdeInput cdeInputCenter", "iValue=My Scene"] });
            cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SmartLabel).Create(tGroup, { PostInitBag: ["iValue=Make Scene available to all user:"] });
            const tCheck = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SingleCheck).Create(tGroup, { TRF: new cdeNMI.TheTRF("IsPublic", 2, new cdeNMI.TheFieldInfo(cdeNMI.cdeControlType.SingleCheck, 3, "Is Public:", 2)), PostInitBag: ["Title=yes"] });
            tCheck.SetProperty("Style", "float:none;");
            if (cdeNMI.MyPopUp) {
                const tPopup = cdeNMI.MyPopUp.Show("Name this Scene:", false, tGroup, 0, (obj) => {
                    const pC = obj.GetProperty("tEdit");
                    const tCe = obj.GetProperty("tCheck");
                    const tSceeneName = pC.GetProperty("Value");
                    if (tSceeneName && tSceeneName.length > 0) {
                        const tScene = new cdeNMI.TheNMIScene();
                        tScene.FriendlyName = tSceeneName;
                        tScene.IsPublic = tCe.GetProperty("Value");
                        tScene.Screens = new Array();
                        for (const i in this.MyNMIScreens) {
                            if (this.MyNMIScreens.hasOwnProperty(i)) {
                                const tS = new cdeNMI.TheScreenTrans();
                                tS.ID = this.MyNMIScreens[i].MyScreenID;
                                tS.DashID = this.MyNMIScreens[i].GetProperty("DashID");
                                tS.IsVisible = this.MyNMIScreens[i].GetProperty("Visibility");
                                tS.IsPinned = this.MyNMIScreens[i].GetProperty("IsPinned");
                                tS.FldOrder = this.MyNMIScreens[i].GetProperty("FldOrder");
                                if (tS.IsVisible || tS.IsPinned)
                                    tScene.Screens.push(tS);
                            }
                        }
                        const tStr = JSON.stringify(tScene);
                        if (cdeNMI.MyEngine) {
                            cdeNMI.MyEngine.PublishToNMI("NMI_SAVE_SCENE:" + tSceeneName, tStr);
                            cdeNMI.ShowToastMessage("Scene " + tSceeneName + " saved!");
                        }
                    }
                });
                tPopup.SetProperty("tEdit", tEdit);
                tPopup.SetProperty("tCheck", tCheck);
                tPopup.SetProperty("YesLabel", "Save");
                tPopup.SetProperty("NoLabel", "Cancel");
            }
        }
        SetView(pView, ClearScreens = false) {
            if (!pView)
                return;
            if (ClearScreens === true)
                this.ClearScenes();
            this.CurrentView = pView;
            if (cde.MyBaseAssets.MyServiceHostInfo.StartScreen)
                this.StartView = this.CurrentView;
        }
        ShowView() {
            if (!this.CurrentView)
                return;
            for (const tScreen1 in this.MyNMIScreens) {
                if (this.MyNMIScreens.hasOwnProperty(tScreen1)) {
                    this.MyNMIScreens[tScreen1].SetProperty("IsPinned", false);
                    this.ShowHideScreen(this.MyNMIScreens[tScreen1]);
                }
            }
            let cntVisibleScreens = 0;
            let i;
            let tScreen;
            for (i = 0; i < this.CurrentView.Screens.length; i++) {
                tScreen = this.GetScreenByID(this.CurrentView.Screens[i].ID);
                if (tScreen) {
                    if (cdeNMI.MyEngine)
                        cdeNMI.MyEngine.CheckDataToFetch(this.CurrentView.Screens[i].ID);
                    tScreen.SetProperty("IsPinned", this.CurrentView.Screens[i].IsPinned);
                    this.ShowHideScreen(tScreen, this.CurrentView.Screens[i].IsVisible);
                    tScreen.SetProperty("FldOrder", this.CurrentView.Screens[i].FldOrder);
                    if (this.CurrentView.Screens[i].IsVisible) {
                        cntVisibleScreens++;
                        this.CurrentScreen = tScreen;
                        if (cdeNMI.MyEngine)
                            cdeNMI.MyEngine.PublishToNMI("NMI_SHOW_SCREEN", tScreen.MyScreenID, tScreen.MyFieldInfo ? tScreen.MyFieldInfo.cdeN : null);
                    }
                }
                else {
                    if (cdeNMI.MyEngine)
                        cdeNMI.MyEngine.GetScreenMeta(this.CurrentView.Screens[i].DashID, false);
                }
            }
            const tArr = cdeNMI.SortArray(this.CurrentView.Screens, "FldOrder", false, true);
            for (i = 0; i < tArr.length; i++) {
                tScreen = this.GetScreenByID(tArr[i].ID);
                this.MoveScreenToTop(tScreen);
            }
            if (cntVisibleScreens === this.CurrentView.Screens.length)
                this.CurrentView = null;
        }
        RenderHeader(bIsVisible) {
            return;
        }
        RequestPortalScreen(pForceLoad) {
            if (cdeNMI.MyEngine)
                cdeNMI.MyEngine.GetScreenMeta(cde.MyBaseAssets.MyServiceHostInfo.PortalScreen, pForceLoad);
        }
        SetPlatform(pID) {
            if (pID === 2)
                this.SetHoloLens();
        }
        GetDeepLink() {
            const tFetch = this.CurrentScreen.MyScreenID + ';' + this.CurrentScreen.GetProperty("DashID") + ";-;" + this.CurrentScreen.GetProperty("ScreenTitle");
            cdeNMI.ShowToastMessage("Deep Link created!", tFetch);
            return tFetch;
        }
        SetHoloLens() {
            document.body.style.background = "black";
            const t = (document.getElementById('MyNMIPortal'));
            if (t)
                t.style.marginTop = "0";
            cdeNMI.ShowToastMessage("Welcome to HoloLens Mode!");
            return "";
        }
        ShowHideDrawOverlay() {
            if (!this.MyDrawOverlay) {
                cdeNMI.ShowToastMessage("Welcome to your Scratch Board", "You draw on the screen and save your drawings to your Relay");
                this.MyDrawOverlay = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.DrawOverlay).Create(cdeNMI.MyNMIPortal, { TRF: new cdeNMI.TheTRF("ScratchBoard", 0, null), PostInitBag: ["ClassName=cdeDrawOverlay"] });
                this.MyDrawOverlay.SetProperty("IsSynced", true);
                this.MyDrawOverlay.SetProperty("ShowPlay", true);
                this.MyDrawOverlay.SetProperty("IsOverlay", true);
                this.MyDrawOverlay.SetProperty("ShowColors", true);
                this.MyDrawOverlay.SetProperty("AutoAdjust", true);
                this.MyDrawOverlay.RegisterEvent("OnSavePicture", (pEvent, para) => {
                    cdeNMI.ShowToastMessage("Drawing Saved", para[1]);
                });
            }
            else {
                if (cdeNMI.MyNMIPortal)
                    cdeNMI.MyNMIPortal.DeleteControl(this.MyDrawOverlay);
                this.MyDrawOverlay = null;
            }
        }
        sinkEngineReady(pSender, bIsReady) {
            if (cde.MyBaseAssets.MyServiceHostInfo.DoAllowAnonymous || cde.MyBaseAssets.MyCommStatus.IsUserLoggedIn) {
                if (pSender === null || bIsReady) {
                    this.HandleLogin(true);
                }
            }
        }
        HandleLogin(pIsLoggedIn, tScreenParts) {
            if (this.WasLoginHandled)
                return;
            if (pIsLoggedIn === true) {
                this.WasLoginHandled = true;
                this.SetApplicationBar();
                cde.MyBaseAssets.MyServiceHostInfo.WasPortalRequested = false;
                this.FireEvent(false, "OnHandleLogin", true);
                if (cde.MyBaseAssets.MyCommStatus.LastPortalScreen) {
                    if (cdeNMI.MyEngine)
                        cdeNMI.MyEngine.GetScreenMeta(cde.MyBaseAssets.MyCommStatus.LastPortalScreen, false);
                }
                else
                    this.RequestPortalScreen(false);
                if (cdeNMI.MyEngine) {
                    cdeNMI.MyEngine.IsConnectedAndReady = true;
                    if (cde.MyBaseAssets.MyCommStatus.LastStartScreen) {
                        cdeNMI.MyEngine.GetScene(cde.MyBaseAssets.MyCommStatus.LastStartScreen);
                    }
                    else if (cde.MyBaseAssets.MyServiceHostInfo.StartScreen) {
                        cdeNMI.MyEngine.GetScene(cde.MyBaseAssets.MyServiceHostInfo.StartScreen);
                    }
                }
                else {
                    this.TransitToScreen(cde.MyBaseAssets.MyServiceHostInfo.StartScreen);
                }
            }
        }
        SetStatusMsg(pStatusMsg, pState) {
            if (cdeNMI.MyLoginScreen)
                cdeNMI.MyLoginScreen.SetStatusMsg(pStatusMsg, pState);
            if (pState === 3) {
                if (cdeNMI.MyPopUp)
                    cdeNMI.MyPopUp.Show(pStatusMsg, true, null, null, () => {
                        cdeNMI.ResetBrowserToPortal();
                    });
                else
                    cdeNMI.ResetBrowserToPortal();
            }
        }
        FindDashpanel(pScreenID, pID) {
            pID = cde.GuidToString(pID);
            const tModel = cdeNMI.MyNMIModels[pScreenID];
            if (!tModel)
                return null;
            for (const element of tModel.MyDashPanels) {
                if (cde.GuidToString(element.cdeMID) === pID) {
                    return element;
                }
            }
            return null;
        }
        SetScreenState(pScreenID, pScreenName) {
            if (cde.IsNotSet(pScreenID))
                pScreenID = cde.GuidToString(cde.MyBaseAssets.MyServiceHostInfo.PortalScreen);
            const tDash = this.FindDashpanel(pScreenID, pScreenName);
            if (tDash) {
                if (tDash.IsFullSceen)
                    this.RenderHeader(false);
                else
                    this.RenderHeader(true);
                return cdeNMI.ThePB.GetValueFromBagByName(tDash.PropertyBag, "Title");
            }
            return cde.MyBaseAssets.MyServiceHostInfo.ApplicationTitle;
        }
        ClearScenes() {
            this.CurrentScreen = null;
            for (const i in this.MyNMIScreens) {
                if (this.MyNMIScreens.hasOwnProperty(i)) {
                    this.MyNMIScreens[i].SetProperty("IsPinned", false);
                    this.ShowHideScreen(this.MyNMIScreens[i]);
                }
            }
        }
        ClearAndGoHome() {
            this.ClearScenes();
            this.GotoStationHome(false);
        }
        AreScreensPinned(pScreen) {
            let tFound = 0;
            for (const i in this.MyNMIScreens) {
                if (this.MyNMIScreens.hasOwnProperty(i)) {
                    if (this.MyNMIScreens[i] !== pScreen && this.MyNMIScreens[i].GetProperty("IsPinned") === true) {
                        tFound++;
                    }
                }
            }
            return tFound;
        }
        FindPinnedScreen() {
            for (const i in this.MyNMIScreens) {
                if (this.MyNMIScreens.hasOwnProperty(i)) {
                    if (this.MyNMIScreens[i].GetProperty("IsPinned") === true) {
                        return this.MyNMIScreens[i];
                    }
                }
            }
            return null;
        }
        SetCurrentScreen(pScreen, pRowID, pOwnerTable) {
            this.CurrentScreen = pScreen;
            if (!pScreen)
                return;
            if (pRowID)
                this.CurrentScreen.SetProperty("TTSCookie", pRowID);
            else
                this.CurrentScreen.SetProperty("TTSCookie", null);
            if (this.CurrentScreen.MyNMIControl) {
                if (pRowID)
                    this.CurrentScreen.MyNMIControl.SetProperty("TTSCookie", pRowID);
                else
                    this.CurrentScreen.MyNMIControl.SetProperty("TTSCookie", null);
            }
            if (pOwnerTable) {
                this.CurrentScreen.SetProperty("MyOwnerTable", pOwnerTable);
                if (this.CurrentScreen.MyNMIControl)
                    this.CurrentScreen.MyNMIControl.SetProperty("MyOwnerTable", pOwnerTable);
            }
            if (cdeNMI.MyEngine)
                cdeNMI.MyEngine.PublishToNMI("NMI_SHOW_SCREEN" + (pRowID ? ":" + pRowID : ""), this.CurrentScreen.MyScreenID, this.CurrentScreen.MyFieldInfo ? this.CurrentScreen.MyFieldInfo.cdeN : null);
        }
        GetCurrentScreen() {
            return this.CurrentScreen;
        }
        GetScreenByID(pScreenID) {
            pScreenID = cde.GuidToString(pScreenID);
            return this.MyNMIScreens[pScreenID];
        }
        DeleteScreenByID(pScreenID, bDeleteKids) {
            const tScreen = this.GetScreenByID(pScreenID);
            if (!tScreen)
                return false;
            if (bDeleteKids) {
                tScreen.Clear(bDeleteKids);
                if (this.MyNMIScreens.hasOwnProperty(pScreenID)) {
                    delete this.MyNMIScreens[pScreenID];
                }
            }
            return true;
        }
        RegisterScreen(pID, pScreen, bRegisterOnly) {
            if (!pScreen)
                return;
            pID = cde.GuidToString(pID);
            this.MyNMIScreens[pID] = pScreen;
            pScreen.SetProperty("LastShow", new Date());
            if (bRegisterOnly)
                return;
            if (!this.CurrentScreen || this.CurrentScreen.MyScreenID !== pID)
                this.ShowHideScreen(pScreen);
        }
        ShowHeader(bShow) {
            //override if needed
        }
        ShowAllScreens() {
            for (const i in this.MyNMIScreens) {
                if (this.MyNMIScreens.hasOwnProperty(i)) {
                    if (this.MyNMIScreens[i].MyScreenID !== "CDELOGINSCREEN") {
                        if (cdeNMI.MyEngine)
                            cdeNMI.MyEngine.CheckDataToFetch(this.MyNMIScreens[i].MyScreenID);
                        this.ShowHideScreen(this.MyNMIScreens[i], true);
                    }
                }
            }
        }
        TransitToWaitingScreen(pTargetScreen) {
            if (this.WaitingForScreen && cde.GuidToString(this.WaitingForScreen) === pTargetScreen) {
                this.TransitToScreen(this.WaitingForScreen, false, false);
                this.WaitingForScreen = null;
            }
        }
        TransitToScreenIDX(pIDX) {
            if (this.CurrentScreen && this.CurrentScreen.GetProperty("IsDashboard")) {
                for (const tdx in this.CurrentScreen.MyChildren) {
                    const tS = this.CurrentScreen.MyChildren[tdx];
                    if (tS && tS.MyRC >= 0 && tS.MyRC === pIDX) {
                        this.TransitToScreen(tdx);
                        break;
                    }
                }
            }
        }
        TransitToScreen(pTargetScreen, MustExist = false, DontTryLoad = false, pCookie, pOwnerTable) {
            if (cde.CBool(cde.TheBaseAssets.IsConnectionDown()) === true) {
                cdeNMI.ResetBrowserToPortal();
                return;
            }
            if (!pTargetScreen)
                pTargetScreen = cde.MyBaseAssets.MyServiceHostInfo.PortalScreen;
            if (!cde.MyBaseAssets.MyServiceHostInfo.WasInitialScreenVisible) {
                if (cde.MyBaseAssets.MyServiceHostInfo.DoesRequireConfiguration && !cde.MyBaseAssets.MyServiceHostInfo.DoAllowAnonymous && cde.MyBaseAssets.MyServiceHostInfo.MainConfigScreen) {
                    if (cdeNMI.MyPopUp)
                        cdeNMI.MyPopUp.Show('Your Relay is not completely configured, yet. Do you want to do this now?', false, null, 1, (tPopup, parent, cookie) => {
                            cdeNMI.MyScreenManager.TransitToScreen(cde.MyBaseAssets.MyServiceHostInfo.MainConfigScreen);
                        }, null, this, parent);
                }
            }
            if (this.MyPopupOverlay) {
                this.RemoveChild(this.MyPopupOverlay);
                this.MyPopupOverlay = null;
            }
            const tScrolPos = document.body.scrollTop;
            const tTargetScreen = cde.GuidToString(pTargetScreen);
            const tOldScreen = this.GetCurrentScreen();
            this.SetCurrentScreen(null);
            for (const i in this.MyNMIScreens) {
                if (this.MyNMIScreens.hasOwnProperty(i)) {
                    if (i === tTargetScreen) {
                        if (tOldScreen && tOldScreen.MyScreenID === i) {
                            this.SetCurrentScreen(tOldScreen, pCookie, pOwnerTable);
                            break;
                        }
                        this.SetCurrentScreen(this.MyNMIScreens[i], pCookie, pOwnerTable);
                        let tScreenInfo = null;
                        if (cdeNMI.MyEngine) {
                            tScreenInfo = cdeNMI.MyNMIModels[this.CurrentScreen.MyScreenID];
                            if (tScreenInfo && tScreenInfo.MyDashboard && tScreenInfo.MyDashboard["InitialState"] &&
                                (!tOldScreen || cde.GuidToString(tScreenInfo.MyDashboard["InitialState"]) !== tOldScreen.MyScreenID)) {
                                this.TransitToScreen(tScreenInfo.MyDashboard["InitialState"]);
                                return;
                            }
                            if (!DontTryLoad)
                                cdeNMI.MyEngine.CheckDataToFetch(pTargetScreen);
                        }
                        this.SetScreenState("", pTargetScreen);
                        this.ShowHideScreen(this.CurrentScreen, true);
                        this.MoveScreenToTop(this.CurrentScreen);
                        if (cde.CBool(this.CurrentScreen.GetProperty("IsPopup"))) {
                            this.MyPopupOverlay = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TouchOverlay).Create(this);
                            this.MyPopupOverlay.SetProperty("ClassName", "cdePopupOverlay");
                            this.CurrentScreen.GetElement().style.position = "absolute";
                            this.CurrentScreen.GetElement().style.zIndex = "1100";
                            this.CurrentScreen.GetElement().style.left = (window.innerWidth / 2 - (this.CurrentScreen.GetElement().clientWidth / 2) + "px");
                            this.CurrentScreen.GetElement().className = "cdePopupTemplate cde-animate-opacity";
                            this.CurrentScreen.SetProperty("ClassName", "cdePopupContent");
                            this.CurrentScreen.SetProperty("OldScreen", tOldScreen.MyScreenID);
                        }
                        else {
                            if (tOldScreen && !this.CurrentScreen.HasRenderTarget)
                                this.ShowHideScreen(tOldScreen);
                            if (cde.MyCommChannel) {
                                const tScreenTrack = new Array();
                                tScreenTrack["LSSC"] = pTargetScreen;
                                if (this.CurrentScreen.GetProperty("DashID"))
                                    tScreenTrack["LPS"] = this.CurrentScreen.GetProperty("DashID");
                                cde.MyCommChannel.UpdateCustomSettings(tScreenTrack);
                            }
                        }
                        this.CurrentScreen.ShowFullscreen(false);
                        if (this.CurrentScreen.GetProperty("IsFullScreen"))
                            cdeNMI.TogglePortalFull(true);
                        else
                            cdeNMI.TogglePortalFull(false);
                        try {
                            if ((!this.CurrentScreen.MyFieldInfo || cde.CBool(this.CurrentScreen.MyFieldInfo["IsTemplate"]) !== true) && !cde.CBool(this.CurrentScreen.GetProperty("IsPopup"))) {
                                const tH = { ScreenID: pTargetScreen, ScrolPos: tScrolPos };
                                this.MyNavHistory.push(tH);
                                window.history.pushState(pTargetScreen, tTargetScreen);
                                document.body.scrollTop = document.documentElement.scrollTop = 0;
                                if (this.MyMainBackButton) {
                                    if (this.MyNavHistory.length < 2)
                                        this.MyMainBackButton.SetProperty("Disabled", true);
                                    else
                                        this.MyMainBackButton.SetProperty("Disabled", false);
                                }
                            }
                        }
                        catch (e) {
                            //ignored
                        }
                    }
                    else {
                        if (this.MyNMIScreens[i] !== tOldScreen)
                            this.ShowHideScreen(this.MyNMIScreens[i]);
                    }
                }
            }
            if (!this.CurrentScreen) {
                this.SetCurrentScreen(this.GetScreenByID(pTargetScreen), pCookie, pOwnerTable);
                if (!this.CurrentScreen) {
                    if (MustExist) {
                        if (cdeNMI.MyEngine)
                            cdeNMI.MyEngine.PublishToNMI("NMI_GET_SCREEN", pTargetScreen);
                        this.WaitingForScreen = pTargetScreen;
                        return;
                    }
                    if (pTargetScreen === cde.MyBaseAssets.MyServiceHostInfo.StartScreen) {
                        if (!this.CurrentView)
                            this.CurrentView = this.StartView;
                        if (this.CurrentView) {
                            this.ShowView();
                            return;
                        }
                        else {
                            this.WaitingForScreen = pTargetScreen;
                            return;
                        }
                    }
                    if (cde.MyBaseAssets.MyServiceHostInfo.StartScreen)
                        pTargetScreen = cde.MyBaseAssets.MyServiceHostInfo.StartScreen;
                    else
                        pTargetScreen = cde.MyBaseAssets.MyServiceHostInfo.PortalScreen;
                    this.MyNavHistory.push({ ScreenID: pTargetScreen, ScrolPos: tScrolPos });
                    if (this.MyMainBackButton)
                        this.MyMainBackButton.SetProperty("Disabled", false);
                    this.SetCurrentScreen(this.GetScreenByID(pTargetScreen), pCookie, pOwnerTable);
                }
                if (!this.CurrentScreen) {
                    if (cdeNMI.MyLoginScreen)
                        this.ShowHideScreen(cdeNMI.MyLoginScreen, true);
                    return;
                }
                if (!DontTryLoad && cdeNMI.MyEngine)
                    cdeNMI.MyEngine.CheckDataToFetch(pTargetScreen);
                this.ShowHideScreen(this.CurrentScreen, true);
            }
            if (!cde.MyBaseAssets.MyServiceHostInfo.WasInitialScreenVisible)
                cdeNMI.ResetKeyCorder();
            cde.MyBaseAssets.MyServiceHostInfo.WasInitialScreenVisible = true;
            if (pTargetScreen === cde.MyBaseAssets.MyServiceHostInfo.PortalScreen) {
                cdeNMI.cdeBlendInTiles('.cdeLiveTile');
                this.RenderHeader(true);
            }
            else {
                cdeNMI.cdeBlendInTiles('.cdeLiveTile');
            }
            this.CurrentView = null;
        }
        ShowHideScreen(pScreen, doShow = false) {
            if (!pScreen)
                return;
            if (!doShow) {
                if (!pScreen.GetProperty("IsPinned") && cde.CBool(pScreen.GetProperty("IsAlwaysVisible")) !== true) {
                    if (pScreen.Visibility)
                        pScreen.OnUnload();
                    pScreen.SetProperty("Visibility", false);
                }
            }
            else {
                if (!pScreen.Visibility)
                    pScreen.OnLoad(true);
                pScreen.SetProperty("Visibility", true);
            }
        }
        SwitchTheme(pToDark) {
            //overide if needed
        }
        GotoStationHome(IsManual) {
            if (cde.MyBaseAssets.MyServiceHostInfo.StartScreen !== "")
                this.TransitToScreen(cde.MyBaseAssets.MyServiceHostInfo.StartScreen, true);
            else
                this.TransitToScreen(cde.MyBaseAssets.MyServiceHostInfo.PortalScreen, true);
        }
        ///Used by Convenience Apps
        NavigateBack(DoHome) {
            if (cde.CBool(cde.TheBaseAssets.IsConnectionDown()) === true) {
                cdeNMI.ResetBrowserToPortal();
                return;
            }
            if (cdeNMI.MyPopUp)
                cdeNMI.MyPopUp.Hide(false);
            this.FireEvent(false, "NavigateBackClicked");
            if (this.MyNavHistory.length > 1) {
                let tH = this.MyNavHistory.pop();
                const tSP = tH.ScrolPos;
                tH = this.MyNavHistory.pop();
                this.TransitToScreen(tH.ScreenID);
                document.body.scrollTop = document.documentElement.scrollTop = tSP;
            }
            else
                this.GotoStationHome(true);
            if (this.MyMainBackButton) {
                if (this.MyNavHistory.length < 2)
                    this.MyMainBackButton.SetProperty("Disabled", true);
                else
                    this.MyMainBackButton.SetProperty("Disabled", false);
            }
        }
        CntScreenPinned() {
            let cnt = 0;
            for (const i in this.MyNMIScreens) {
                if (this.MyNMIScreens.hasOwnProperty(i)) {
                    if (this.MyNMIScreens[i].GetProperty("IsPinned") === true)
                        cnt++;
                }
            }
            return cnt;
        }
        MoveScreenToTop(pScreen) {
            if (!pScreen)
                return;
            const tH = pScreen.GetElement();
            const tParent = tH.parentElement;
            if (!tParent)
                return;
            const tNode0 = tParent.children[0];
            if (tNode0 === tH)
                return;
            tH.parentElement.removeChild(tH);
            tParent.insertBefore(tH, tNode0);
            this.RenumberScreens();
        }
        RenumberScreens() {
            const tRoot = document.getElementById("MyDashboard");
            if (tRoot) {
                for (let i = 0; i < tRoot.children.length; i++) {
                    const tC = tRoot.children[i];
                    const tc = tC.id.split('_');
                    if (tc.length > 1 && tc[0].toLowerCase() === "screen") {
                        const tScreen = this.GetScreenByID(tc[1]);
                        if (tScreen)
                            tScreen.SetProperty("FldOrder", i);
                    }
                }
            }
        }
        UpdateScreenStatus(mh, pIsDown) {
            for (const ts in this.MyNMIScreens) {
                if (this.MyNMIScreens[ts].MyHostNode === mh || this.MyNMIScreens[ts].GetProperty("IsDashboard") === true) {
                    if (ts === cde.GuidToString(cde.MyBaseAssets.MyServiceHostInfo.PortalScreen))
                        continue;
                    this.MyNMIScreens[ts].SetProperty("IsOwnerDown:" + mh, pIsDown);
                }
            }
        }
        GetScreenIndex() {
            return this.ScreenOrder++;
        }
        GetScreenList() {
            let tLst = "";
            for (const tIdx in this.MyNMIScreens) {
                const tS = this.MyNMIScreens[tIdx];
                if (!tS || !tS.GetProperty("Description") || tIdx === "CDELOGINSCREEN" || (tS.MyHostNode !== cde.MyBaseAssets.MyCommStatus.FirstNodeID))
                    continue;
                tLst += ";" + cdeNMI.StripHTML(tS.GetProperty("Description")) + ":" + tIdx;
            }
            return tLst;
        }
        IsScreenInView(pCurrentView, pID) {
            if (!pCurrentView)
                return true;
            for (const element of pCurrentView.Screens) {
                if (element.ID === pID) {
                    const tScreen = this.GetScreenByID(element.ID);
                    if (tScreen) {
                        tScreen.SetProperty("IsPinned", element.IsPinned);
                        this.ShowHideScreen(tScreen, element.IsVisible);
                        tScreen.SetProperty("FldOrder", element.FldOrder);
                    }
                    return element.IsVisible;
                }
            }
            return false;
        }
        CreateHTMLScreen(pScreenID, pHTML) {
            const tScreen = cdeNMI.MyScreenManager.GetScreenByID(pScreenID);
            if (tScreen) {
                tScreen.CreateHTMLView(pHTML);
                tScreen.SetInitialized(true);
            }
            return tScreen;
        }
        CreateScriptScreen(pScreenID, pScript) {
            const tScreen = this.GetScreenByID(pScreenID);
            if (tScreen) {
                tScreen.CreateScriptInView(pScript);
                tScreen.SetInitialized(true);
            }
            return tScreen;
        }
        CreateIFrameScreen(pScreenID, pURL) {
            const tScreen = this.GetScreenByID(pScreenID);
            if (tScreen) {
                tScreen.SetProperty("Source", pURL);
                tScreen.SetInitialized(true);
            }
            return tScreen;
        }
        CreateDataViewScreen(tModel, pMSG, tTableName, pExtraInfo, pScreenID, bForceInitData, pRowMID) {
            const tModelId = cde.GuidToString(tModel.cdeMID);
            if (pMSG && (typeof (pMSG.PLS) === "object" || (pMSG.PLS !== "" && pMSG.PLS !== "[]"))) {
                const tParts = pMSG.PLS.split(":-MODELUPDATE-:");
                const pMSGPLS = tParts[0];
                if (!tModel.MyStorageMirror[tTableName] || cde.CBool(bForceInitData) === true) {
                    tModel.MyStorageMirror[tTableName] = (typeof (pMSGPLS) === "object" ? pMSGPLS : JSON.parse(pMSGPLS));
                    cdeNMI.MyEngine.FireEvent(false, "RecordUpdated_" + tTableName + "_" + 0, tModelId, tTableName, 0);
                }
                else {
                    const tTable = (typeof (pMSGPLS) === "object" ? pMSGPLS : JSON.parse(pMSGPLS));
                    for (const element of tTable) {
                        const tLen = tModel.MyStorageMirror[tTableName].length;
                        let tFoundOne = false;
                        for (let tc = 0; tc < tLen; tc++) {
                            if (tModel.MyStorageMirror[tTableName][tc].cdeMID === element.cdeMID) {
                                tModel.MyStorageMirror[tTableName][tc] = element;
                                tFoundOne = true;
                                break;
                            }
                        }
                        if (!tFoundOne)
                            tModel.MyStorageMirror[tTableName][tLen] = element;
                        cdeNMI.MyEngine.FireEvent(false, "RecordUpdated_" + tTableName + "_" + tLen, tModelId, tTableName, tLen);
                    }
                }
                if (tParts.length > 1 && tModel.MyStorageMeta && (tModel.MyStorageMeta[tTableName] || cde.CBool(bForceInitData) === true)) {
                    const ttModel = JSON.parse(tParts[1]);
                    tModel.MyStorageMeta[tTableName] = ttModel;
                }
                if (cdeNMI.MyEngine)
                    cdeNMI.MyEngine.FireLazyLoaded(tModelId, tTableName, tModel.MyStorageMirror[tTableName]);
                if (pScreenID === "noview")
                    return null;
            }
            const tFormInfo = (tModel && tModel.MyStorageMeta && tModel.MyStorageMeta[tTableName]) ? tModel.MyStorageMeta[tTableName] : null;
            let pTarget = null;
            if (pScreenID) {
                pTarget = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.BaseControl);
                pTarget.MyScreenID = cde.GuidToString(pScreenID);
                let tTargetElem = document.getElementById('Content_' + pTarget.MyScreenID);
                if (!tTargetElem)
                    tTargetElem = document.getElementById(pTarget.MyScreenID);
                pTarget.SetElement(tTargetElem);
            }
            let tBaseControl = null;
            const tScreen = cdeNMI.MyScreenManager && pScreenID ? cdeNMI.MyScreenManager.GetScreenByID(pScreenID) : null;
            if (tScreen === null || tScreen === void 0 ? void 0 : tScreen.MyOverlay) {
                cdeNMI.UnselectAllControls();
                tScreen.RemoveChild(tScreen.MyOverlay);
                tScreen.MyOverlay = null;
            }
            if (tFormInfo) {
                const tTRF = cdeNMI.TheTRF.FromScreenForm(tModel, tTableName);
                if (tFormInfo.IsAlwaysEmpty === true)
                    tTRF.RowNo = -1;
                const tFTS = cde.CBool(cdeNMI.ThePB.GetValueFromBagByName(tFormInfo.PropertyBag, "FitToScreen"));
                const tRef = cde.GuidToString(cdeNMI.ThePB.GetValueFromBagByName(tFormInfo.PropertyBag, "TableReference"));
                if (!pRowMID && tScreen && tScreen.GetProperty("TTSCookie")) {
                    pRowMID = tScreen.GetProperty("TTSCookie");
                }
                if (pRowMID) {
                    tTRF.RowID = pRowMID;
                    tTRF.RowNo = -1;
                    if (tRef)
                        tTableName = tRef;
                    if (!tModel.MyStorageMirror[tTableName]) {
                        if (cdeNMI.MyPopUp)
                            cdeNMI.MyPopUp.Show("Template in use but has no Table Reference");
                    }
                    else {
                        const tLen = tModel.MyStorageMirror[tTableName].length;
                        for (let tc = 0; tc < tLen; tc++) {
                            if (tModel.MyStorageMirror[tTableName][tc].cdeMID === tTRF.RowID) {
                                tTRF.RowNo = tc;
                                break;
                            }
                        }
                    }
                }
                tBaseControl = cdeNMI.MyTCF.CreateNMIControl(tTRF.FldInfo.Type).Create(pTarget, { ScreenID: cde.GuidToString(tModel.MyDashboard.cdeMID), TRF: tTRF, PreInitBag: ["ExtraInfo=" + pExtraInfo, (tFTS === true ? "FitToScreen=" + tFTS : ""), (tRef ? "TableReference=" + tRef : "")], PostInitBag: tFormInfo.PropertyBag });
                if (tBaseControl && cdeNMI.MyTCF && pTarget) {
                    const tableTE = cdeNMI.MyTCF.GetRegisteredControl(pTarget.MyScreenID, "TE");
                    if (tableTE) {
                        tBaseControl.SetTE(tableTE);
                    }
                }
                if (tScreen) {
                    if (tFTS === true) {
                        tScreen.ScreenScale = 1.0;
                        tScreen.GetElement().style.transformOrigin = "top left";
                        let tWid = cde.CInt(cdeNMI.ThePB.GetValueFromBagByName(tFormInfo.PropertyBag, "TileWidth"));
                        if (tWid > 0)
                            tWid = cdeNMI.GetSizeFromTile(tWid);
                        else
                            tWid = cde.CInt(cdeNMI.ThePB.GetValueFromBagByName(tFormInfo.PropertyBag, "PixelWidth"));
                        if (tWid > 0)
                            tScreen.ScreenScale = (document.body.clientWidth - 20) / tWid;
                        let tHei = cde.CInt(cdeNMI.ThePB.GetValueFromBagByName(tFormInfo.PropertyBag, "TileHeight"));
                        if (tHei > 0)
                            tHei = cdeNMI.GetSizeFromTile(tHei);
                        else
                            tHei = cde.CInt(cdeNMI.ThePB.GetValueFromBagByName(tFormInfo.PropertyBag, "PixelHeight"));
                        if (tHei > 0) {
                            const tRatioH = (window.innerHeight - cdeNMI.GetSizeFromTile(1)) / tHei;
                            if (tRatioH < tScreen.ScreenScale)
                                tScreen.ScreenScale = tRatioH;
                        }
                        if (tScreen.ScreenScale != 1.0)
                            tScreen.GetElement().style.transform = "scale(" + tScreen.ScreenScale + ")";
                    }
                    tBaseControl.OnLoaded();
                    if (tBaseControl && tBaseControl.MyFieldInfo)
                        cdeNMI.ThePB.SetPropertiesFromBag(tScreen, tBaseControl.MyFieldInfo.PropertyBag, null, false, false);
                    tScreen.SetInitialized(true);
                    if (tScreen.MySavePin)
                        tScreen.MySavePin.SetProperty("Visibility", true);
                    if (tScreen.MyRefreshPin && (!tRef || tRef.length === 0))
                        tScreen.MyRefreshPin.SetProperty("Visibility", true);
                    if (tBaseControl)
                        tScreen.MyNMIControl = tBaseControl;
                }
            }
            else {
                if (tScreen) {
                    const tToFetch = tTableName + ":CMyForm:" + tTableName + ":" + cde.GuidToString(tScreen.GetProperty("DashID")) + ":true:false";
                    if (cdeNMI.MyEngine) {
                        //debugger
                    }
                    else {
                        this.FireEvent(true, "FetchData", tToFetch);
                    }
                    return null;
                }
            }
            if (pScreenID)
                cdeNMI.MyTCF.RegisterControl("TABLES", pTarget.MyScreenID, tBaseControl);
            else
                cdeNMI.MyTCF.RegisterControl("TABLES", tTableName, tBaseControl);
            return tBaseControl;
        }
        CreateLiveScreen(pModel) {
            const tModelId = cde.GuidToString(pModel.cdeMID);
            if (!cdeNMI.MyNMIModels[tModelId] || pModel.ForceReload)
                cdeNMI.MyNMIModels[tModelId] = pModel;
            else {
                if (!cdeNMI.MyNMIModels[tModelId].MyStorageMirror)
                    cdeNMI.MyNMIModels[tModelId].MyStorageMirror = [];
            }
            if (pModel && pModel.MyStorageInfo) {
                if (!cdeNMI.MyNMIModels[tModelId].MyStorageMeta)
                    cdeNMI.MyNMIModels[tModelId].MyStorageMeta = [];
                for (const element of pModel.MyStorageInfo) { //Check if there is better Way!
                    cdeNMI.MyNMIModels[tModelId].MyStorageMeta[tModelId] = element;
                }
            }
            const pTarget = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.BaseControl);
            pTarget.MyScreenID = tModelId;
            const pTargetElem = document.getElementById('Content_' + cde.GuidToString(tModelId));
            if (!pTargetElem) {
                //debugger 
            }
            else {
                const tTRF = cdeNMI.TheTRF.FromScreenForm(pModel, tModelId);
                pTarget.SetElement(pTargetElem);
                const tBaseControl = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.FormView).Create(pTarget, { ScreenID: tModelId, TRF: tTRF, PreInitBag: ["ILF=true"] });
                cdeNMI.MyTCF.RegisterControl("TABLES", tModelId, tBaseControl);
                const tScreen = cdeNMI.MyScreenManager && tModelId ? cdeNMI.MyScreenManager.GetScreenByID(tModelId) : null;
                if (tScreen) {
                    tScreen.SetInitialized(true);
                    if (tScreen.MySavePin)
                        tScreen.MySavePin.SetProperty("Visibility", true);
                    if (tScreen.MyRefreshPin)
                        tScreen.MyRefreshPin.SetProperty("Visibility", true);
                    if (tBaseControl)
                        tScreen.MyNMIControl = tBaseControl;
                }
                return tBaseControl;
            }
            return null;
        }
        CreateDashboard(tModel, pInScreenGuid) {
            let tModelId = cde.GuidToString(tModel.cdeMID);
            let IsModelReady = false;
            if (tModel.MyDashboard) {
                tModelId = cde.GuidToString(tModel.MyDashboard.cdeMID);
                if (!cdeNMI.MyNMIModels[tModelId] || tModel.ForceReload)
                    cdeNMI.MyNMIModels[tModelId] = tModel;
                else {
                    if (cdeNMI.MyNMIModels[tModelId] && !cdeNMI.MyNMIModels[tModelId].MyDashboard)
                        cdeNMI.MyNMIModels[tModelId].MyDashboard = tModel.MyDashboard;
                    if (!cdeNMI.MyNMIModels[tModelId].MyStorageMirror)
                        cdeNMI.MyNMIModels[tModelId].MyStorageMirror = [];
                }
                IsModelReady = true;
                cde.MyBaseAssets.MyServiceHostInfo.WasPortalRequested = true;
            }
            if (!cdeNMI.MyNMIModels[tModelId] || (IsModelReady && tModel.ForceReload)) {
                cdeNMI.MyNMIModels[tModelId] = tModel;
            }
            else {
                if (tModel && tModel.MyDashPanels && tModel.MyDashPanels.length > 0) {
                    const tExiting = {};
                    let j;
                    for (j = 0; j < cdeNMI.MyNMIModels[tModelId].MyDashPanels.length; j++) {
                        if (cdeNMI.MyNMIModels[tModelId].MyDashPanels[j].cdeN === tModel.cdeN) {
                            tExiting[cdeNMI.MyNMIModels[tModelId].MyDashPanels[j].cdeMID] = false;
                        }
                    }
                    for (const element of tModel.MyDashPanels) {
                        let tFoundOne = false;
                        for (j = 0; j < cdeNMI.MyNMIModels[tModelId].MyDashPanels.length; j++) {
                            if (element.cdeMID === cdeNMI.MyNMIModels[tModelId].MyDashPanels[j].cdeMID) {
                                cdeNMI.MyNMIModels[tModelId].MyDashPanels[j] = element;
                                tFoundOne = true;
                                tExiting[cdeNMI.MyNMIModels[tModelId].MyDashPanels[j].cdeMID] = true;
                                break;
                            }
                        }
                        if (!tFoundOne) {
                            cdeNMI.MyNMIModels[tModelId].MyDashPanels.push(element);
                            tExiting[element.cdeMID] = true;
                        }
                    }
                    for (j = cdeNMI.MyNMIModels[tModelId].MyDashPanels.length - 1; j >= 0; j--) {
                        if (cdeNMI.MyNMIModels[tModelId].MyDashPanels[j].cdeN === tModel.cdeN && (!tExiting[cdeNMI.MyNMIModels[tModelId].MyDashPanels[j].cdeMID] || tExiting[cdeNMI.MyNMIModels[tModelId].MyDashPanels[j].cdeMID] === false)) {
                            if (cdeNMI.MyScreenManager)
                                cdeNMI.MyScreenManager.DeleteScreenByID(cdeNMI.MyNMIModels[tModelId].MyDashPanels[j].cdeMID, false);
                            cdeNMI.MyNMIModels[tModelId].MyDashPanels.splice(j, 1);
                        }
                    }
                }
            }
            if (tModel && tModel.MyStorageInfo) {
                if (!cdeNMI.MyNMIModels[tModelId].MyStorageMeta)
                    cdeNMI.MyNMIModels[tModelId].MyStorageMeta = [];
                for (const element of tModel.MyStorageInfo) { //Check if there is better Way!
                    cdeNMI.MyNMIModels[tModelId].MyStorageMeta[cde.GuidToString(element.AssociatedClassName)] = element;
                }
            }
            if (IsModelReady) {
                const tDash = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.Dashboard, true);
                if (tDash)
                    tDash.Create(cdeNMI.MyScreenManager, { ScreenID: tModelId, PreInitBag: [pInScreenGuid] });
                return tDash;
            }
            return null;
        }
    }
    cdeNMI.TheScreenManager = TheScreenManager;
    class TheScreenManagerClassic extends cdeNMI.TheScreenManager {
        constructor() {
            super(null);
            this.MyHeaderTitle = null;
            this.MyThemeSwitch = null;
            this.mLogoButton = null;
            this.mHeaderTileSize = 0;
            this.MyBaseType = cdeNMI.cdeControlType.ScreenManager;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            this.MyHeader = document.getElementById("MyHeader");
            if (!this.MyHeader) {
                this.MyHeader = document.createElement("div");
                this.MyHeader.className = "cdeHeader";
                this.MyHeader.id = "MyHeader";
                this.GetElement().parentNode.insertBefore(this.MyHeader, this.GetElement().nextSibling);
            }
            if (cde.MyBaseAssets.MyServiceHostInfo.WebPlatform === 5) {
                const tHeaderBuffer = document.createElement("div");
                tHeaderBuffer.className = "cdeBottomSpacer";
                const tInBuff = document.createElement("div");
                tHeaderBuffer.style.height = "100px";
                tHeaderBuffer.style.width = "10px";
                tHeaderBuffer.appendChild(tInBuff);
                this.GetElement().parentNode.insertBefore(tHeaderBuffer, this.GetElement().nextSibling);
            }
            this.mDivHeaderButtons = document.getElementById("HeaderButtonContent");
            if (!this.mDivHeaderButtons) {
                this.mDivHeaderButtons = document.createElement("div");
                this.mDivHeaderButtons.id = "HeaderButtonContent";
                this.MyHeader.appendChild(this.mDivHeaderButtons);
            }
            let tTitle = cde.MyBaseAssets.MyServiceHostInfo.ApplicationTitle;
            this.mDivHeaderTitle = document.getElementById("cdeHeaderTitle");
            if (!this.mDivHeaderTitle) {
                this.mDivHeaderTitle = document.createElement("div");
                this.mDivHeaderTitle.className = "cdeMyHeaderTitle";
                this.mDivHeaderTitle.id = "cdeHeaderTitle";
                this.MyHeader.appendChild(this.mDivHeaderTitle);
            }
            else {
                tTitle = this.mDivHeaderTitle.innerHTML;
            }
            this.MyHeaderTitle = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SmartLabel).Create(null, { PreInitBag: ["Element=span"], PostInitBag: ["iValue=" + tTitle, "ClassName=cdeMyHeaderTitle"] });
            this.mDivHeaderTitle.innerHTML = "";
            this.mDivHeaderTitle.appendChild(this.MyHeaderTitle.GetElement());
            if (cde.MyBaseAssets.MyServiceHostInfo.WebPlatform !== 1 && cde.MyBaseAssets.MyServiceHostInfo.WebPlatform !== 5) {
                const tPortal = document.getElementById("MyNMIPortal");
                tPortal.style.marginTop = "78px";
            }
            this.RegisterEvents();
            return true;
        }
        SetApplicationBar() {
            if (this.mDivHeadButtonContent)
                return;
            this.mDivHeadButtonContent = document.getElementById("HeaderButtonContent");
            if (!this.mDivHeadButtonContent) //No Applicatin Bar if HeaderButtonContent is missing
                return;
            this.MyMainBackButton = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(null, { PreInitBag: ["ControlTW=1", "ControlTH=1"], PostInitBag: ["Title=<span class='fa' style='font-size:40px'>&#xf359;</span>", "ClassName=MyHeaderButton"] });
            this.MyMainBackButton.SetProperty("OnClick", (sender, e, tPs) => {
                this.NavigateBack(false);
            });
            this.MyMainBackButton.SetProperty("TabIndex", 5);
            this.MyMainBackButton.SetProperty("Disabled", true);
            this.MyMainBackButton.SetProperty("Visibility", this.IsBrowserFullscreen || cde.MyBaseAssets.MyServiceHostInfo.WebPlatform > 2 || cde.MyBaseAssets.MyServiceHostInfo.IsAppHosted === true);
            this.MyThemeSwitch = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(null, { PreInitBag: ["ControlTW=1", "ControlTH=1"], PostInitBag: ["Title=<span class='fa' style='font-size:40px'>&#xf185;</span>", "ClassName=cdeVertCenter"] });
            this.MyThemeSwitch.SetProperty("OnClick", () => cdeNMI.ToggleTheme());
            const tileButHeaderBtnTheme2 = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(null, { PreInitBag: ["ControlTW=1", "ControlTH=1"], PostInitBag: ["Title=<span class='fa' style='font-size:40px'>&#xf0c7;</span>", "ClassName=cdeVertCenter"] });
            tileButHeaderBtnTheme2.SetProperty("OnClick", (sender, e, tPs) => {
                if (e.button === 2) {
                    if (this.CurrentScreen) {
                        if (cdeNMI.MyPopUp)
                            cdeNMI.MyPopUp.Show(cde.MyBaseAssets.MyCommStatus.MyServiceUrl + "/nmi?CDEDL=" + this.CurrentScreen.MyScreenID + ";" + this.CurrentScreen.GetProperty("DashID"), true);
                    }
                    else {
                        if (this.StartView && this.StartView.FriendlyName === "MyHome") {
                            const tScene = this.StartView;
                            tScene.Screens = new Array();
                            for (const i in this.MyNMIScreens) {
                                if (this.MyNMIScreens.hasOwnProperty(i)) {
                                    const tS = new cdeNMI.TheScreenTrans();
                                    tS.ID = this.MyNMIScreens[i].MyScreenID;
                                    tS.DashID = this.MyNMIScreens[i].GetProperty("DashID");
                                    tS.IsVisible = this.MyNMIScreens[i].GetProperty("Visibility");
                                    tS.IsPinned = this.MyNMIScreens[i].GetProperty("IsPinned");
                                    tS.FldOrder = this.MyNMIScreens[i].GetProperty("FldOrder");
                                    if (tS.IsVisible || tS.IsPinned)
                                        tScene.Screens.push(tS);
                                }
                            }
                            const tStr = JSON.stringify(tScene);
                            if (cdeNMI.MyEngine) {
                                cdeNMI.MyEngine.PublishToNMI("NMI_SAVE_HOMESCENE", tStr);
                                cdeNMI.ShowToastMessage("My Home Scene updated!");
                            }
                        }
                    }
                    return;
                }
                this.ShowCreateViewPopup();
            });
            const tileButHeaderBtnTheme3 = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(null, { PreInitBag: ["ControlTW=1", "ControlTH=1"], PostInitBag: ["Title=<span class='fa' style='font-size:40px'>&#xf1fc;</span>", "ClassName=cdeVertCenter"] });
            tileButHeaderBtnTheme3.SetProperty("OnClick", (sender, e, tPs) => {
                if (cdeNMI.MyPopUp)
                    cdeNMI.MyPopUp.Hide(false);
                this.ShowHideDrawOverlay();
            });
            const tileButHeaderBtnTheme4 = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(null, { PreInitBag: ["ControlTW=1", "ControlTH=1"], PostInitBag: ["Title=<span class='fa' style='font-size:40px'>&#xf021;</span>", "ClassName=cdeVertCenter"] });
            tileButHeaderBtnTheme4.SetProperty("OnClick", (sender, e, tPs) => {
                if (cdeNMI.MyPopUp)
                    cdeNMI.MyPopUp.Hide(false);
                let bForce = false;
                if (e.button === 2)
                    bForce = true;
                if (this.CurrentScreen && this.CurrentScreen !== this.GetScreenByID(cde.MyBaseAssets.MyServiceHostInfo.PortalScreen)) {
                    if (this.CurrentScreen.MyRefreshButton) {
                        this.CurrentScreen.MyRefreshButton.DoFireClick(null);
                        return;
                    }
                    else {
                        if (cdeNMI.MyEngine) {
                            const tFetch = 'NMI_GET_DATA:' + this.CurrentScreen.MyScreenID + ':' + this.CurrentScreen.GetProperty("ControlClass") + ':' + this.CurrentScreen.GetProperty("DashID") + ':true:' + bForce;
                            cdeNMI.MyEngine.PublishToNMI(tFetch, '', this.CurrentScreen.MyFieldInfo ? this.CurrentScreen.MyFieldInfo.cdeN : null);
                        }
                    }
                    return;
                }
                if (cde.MyBaseAssets.MyServiceHostInfo.StartScreen === "")
                    cdeNMI.MyNMIModels[cde.GuidToString(cde.MyBaseAssets.MyServiceHostInfo.PortalScreen)] = null;
                if (cdeNMI.MyToast)
                    cdeNMI.MyToast.ShowToastMessage("Portal Refresh sent!", "Touch the home icon to see the changes", 10000);
                if (cdeNMI.MyEngine)
                    cdeNMI.MyEngine.RequestReloadModel(cde.MyBaseAssets.MyServiceHostInfo.PortalScreen);
                this.RequestPortalScreen(cde.MyBaseAssets.MyServiceHostInfo.StartScreen ? true : bForce);
            });
            const InnerControlArray = new Array();
            if (cde.MyBaseAssets.MyServiceHostInfo.WebPlatform < 2)
                InnerControlArray[0] = this.MyThemeSwitch;
            if (cde.MyBaseAssets.MyServiceHostInfo.WebPlatform === 0) {
                InnerControlArray[1] = tileButHeaderBtnTheme2;
                InnerControlArray[2] = tileButHeaderBtnTheme3;
                InnerControlArray[3] = tileButHeaderBtnTheme4;
            }
            this.mLogoButton = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.LogoButton).Create(null, { PreInitBag: ["ControlTW=1", "ControlTH=1"] });
            this.mLogoButton.SetProperty("OnClick", (t, e, pP) => {
                if (cdeNMI.MyPopUp)
                    cdeNMI.MyPopUp.Hide(false);
                if (e.button === 2)
                    this.ClearAndGoHome();
                else
                    this.GotoStationHome(false);
            });
            const tReveal = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.RevealButton).Create(null);
            tReveal.SetProperty("Image", this.mLogoButton);
            tReveal.SetProperty("TabIndex", 6);
            tReveal.SetProperty("ControlArray", InnerControlArray);
            if (this.mDivHeadButtonContent) {
                this.mDivHeadButtonContent.appendChild(tReveal.GetElement());
            }
            if (cde.MyBaseAssets.MyServiceHostInfo.WebPlatform > 1 && cde.MyBaseAssets.MyServiceHostInfo.WebPlatform !== 4) {
                if (this.mDivHeadButtonContent) {
                    this.mDivHeadButtonContent.appendChild(this.MyThemeSwitch.GetElement());
                    this.mDivHeadButtonContent.appendChild(tileButHeaderBtnTheme4.GetElement());
                }
            }
            if (this.mDivHeadButtonContent) {
                if (cde.MyBaseAssets.MyServiceHostInfo.WebPlatform !== 1 || cde.MyBaseAssets.MyServiceHostInfo.IsAppHosted === true) {
                    if (cde.MyBaseAssets.MyServiceHostInfo.IsAppHosted)
                        this.MyMainBackButton.SetProperty("Visibility", true);
                    this.mDivHeadButtonContent.insertBefore(this.MyMainBackButton.GetElement(), this.mDivHeadButtonContent.children[0]);
                    this.RegisterEvent("OnBrowserFullscreen", (sender, para) => {
                        if (cde.MyBaseAssets.MyServiceHostInfo.WebPlatform < 2)
                            this.MyMainBackButton.SetProperty("Visibility", para);
                    });
                }
                if (cde.MyBaseAssets.MyServiceHostInfo.WebPlatform === 2)
                    this.SetHoloLens();
            }
            cdeNMI.ApplyTheme();
        }
        SetStatusMsg(pStatusMsg, pState) {
            if (this.mLogoButton)
                this.mLogoButton.SetProperty("LogoState", pState);
            super.SetStatusMsg(pStatusMsg, pState);
        }
        CreateLoginButtonOnly() {
            super.CreateLoginButtonOnly();
        }
        ResizeEventHandler() {
            super.ResizeEventHandler();
            if (this.MyHeaderTitle) {
                if (this.mHeaderTileSize === 0)
                    this.mHeaderTileSize = this.MyHeaderTitle.GetElement().parentElement.offsetWidth + cdeNMI.GetSizeFromTile(5);
                if (window.outerWidth < this.mHeaderTileSize)
                    this.MyHeaderTitle.SetProperty("Visibility", false);
                else
                    this.MyHeaderTitle.SetProperty("Visibility", true);
            }
        }
        RenderHeader(bIsVisible) {
            return;
        }
        ShowHeader(bShow) {
            if (!cde.CBool(bShow)) {
                if (this.MyHeader)
                    this.MyHeader.style.display = 'none';
            }
            else {
                if (this.MyHeader && cde.MyBaseAssets.MyServiceHostInfo.WebPlatform !== 2)
                    this.MyHeader.style.display = '';
            }
        }
        SwitchTheme(bToDark) {
            if (this.MyThemeSwitch) {
                if (bToDark)
                    this.MyThemeSwitch.SetProperty("Title", "<span class='fa' style='font-size:40px'>&#xf185;</span>");
                else
                    this.MyThemeSwitch.SetProperty("Title", "<span class='fa' style='font-size:40px'>&#xf186;</span>");
            }
        }
        SetHoloLens() {
            super.SetHoloLens();
            (document.getElementById('MyHeader')).style.display = "none";
            return "";
        }
    }
    cdeNMI.TheScreenManagerClassic = TheScreenManagerClassic;
    class TheScreenManagerModern extends cdeNMI.TheScreenManager {
        constructor() {
            super(null);
            this.MyHeaderTitle = null;
            this.MyThemeSwitch = null;
            this.MyLogoButton = null;
            this.mHeaderTileSize = 0;
            this.mSideBarState = 0;
            this.MyBaseType = cdeNMI.cdeControlType.ScreenManager;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            this.MyHeader = document.getElementById("MyHeader");
            if (!this.MyHeader) {
                this.MyHeader = document.createElement("div");
                this.MyHeader.className = "cdeHeader";
                this.MyHeader.id = "MyHeader";
                this.GetElement().parentNode.insertBefore(this.MyHeader, this.GetElement().nextSibling);
            }
            this.mDivHeaderButtons = document.getElementById("HeaderButtonContent");
            if (!this.mDivHeaderButtons) {
                this.mDivHeaderButtons = document.createElement("div");
                this.mDivHeaderButtons.id = "HeaderButtonContent";
                this.MyHeader.appendChild(this.mDivHeaderButtons);
            }
            this.mDivSideBar = document.getElementById("cdeSideBar");
            if (!this.mDivSideBar && cde.MyBaseAssets.MyServiceHostInfo.ShowClassic !== true) {
                this.mDivSideBar = document.createElement("div");
                this.mDivSideBar.id = "cdeSideBar";
                this.mDivSideBar.className = "cdeSideBar";
                if (cde.MyBaseAssets.MyServiceHostInfo.WebPlatform === 5) {
                    this.mDivSideBar.style.marginBottom = "48px";
                }
                else
                    this.mDivSideBar.style.marginTop = "48px";
                this.MyHeader.parentNode.insertBefore(this.mDivSideBar, this.MyHeader.nextSibling);
            }
            this.mDivHeaderTitle = document.getElementById("cdeHeaderTitle");
            let tTitle = cde.MyBaseAssets.MyServiceHostInfo.ApplicationTitle;
            if (!this.mDivHeaderTitle) {
                this.mDivHeaderTitle = document.createElement("div");
                this.mDivHeaderTitle.className = "cdeMyHeaderTitleModern";
                this.mDivHeaderTitle.id = "cdeHeaderTitle";
                this.MyHeader.appendChild(this.mDivHeaderTitle);
            }
            else {
                tTitle = this.mDivHeaderTitle.innerHTML;
            }
            this.MyHeaderTitle = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SmartLabel).Create(null, { PreInitBag: ["Element=span"], PostInitBag: ["iValue=" + tTitle, "ClassName=cdeMyHeaderTitleModern"] });
            this.mDivHeaderTitle.innerHTML = "";
            this.mDivHeaderTitle.appendChild(this.MyHeaderTitle.GetElement());
            if (cde.MyBaseAssets.MyServiceHostInfo.WebPlatform !== 1) {
                const tPortal = document.getElementById("MyNMIPortal");
                if (cde.MyBaseAssets.MyServiceHostInfo.WebPlatform !== 5)
                    tPortal.style.marginTop = "50px";
            }
            this.RegisterEvents();
            return true;
        }
        SetApplicationBar() {
            if (this.mDivHeadButtonContent)
                return;
            this.mDivHeadButtonContent = document.getElementById("HeaderButtonContent");
            if (!this.mDivHeadButtonContent) //No Applicatin Bar if HeaderButtonContent is missing
                return;
            this.MyMainBackButton = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(null, { PreInitBag: ["ControlTW=1", "ControlTH=1", "TileFactorX=2", "TileFactorY=2"], PostInitBag: ["Title=<span class='fa' style='font-size:24px'>&#xf359;</span>", "ClassName=MyHeaderButton", "PixelHeight=48"] });
            this.MyMainBackButton.SetProperty("OnClick", (sender, e, tPs) => {
                this.NavigateBack(false);
            });
            this.MyMainBackButton.SetProperty("TabIndex", 5);
            this.MyMainBackButton.SetProperty("Disabled", true);
            this.MyMainBackButton.SetProperty("Visibility", false);
            const tIconGroup = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileGroup).Create(null, { PreInitBag: ["ControlTW=4", "ControlTH=1", "TileFactorY=2"] });
            tIconGroup.SetProperty("ClassName", "cdeSideTiles");
            if (this.mDivSideBar)
                this.mDivSideBar.appendChild(tIconGroup.GetElement());
            const tHomeButton = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(tIconGroup, { PreInitBag: ["ControlTW=1", "ControlTH=1", "TileFactorX=2", "TileFactorY=2"], PostInitBag: ["Title=<span class='fa' style='font-size:24px'>&#xf015;</span>", "ClassName=cdeVertCenter"] });
            tHomeButton.SetProperty("OnClick", (sender, e, tPs) => {
                if (cdeNMI.MyPopUp)
                    cdeNMI.MyPopUp.Hide(false);
                if (e.button === 2)
                    this.ClearAndGoHome();
                else {
                    this.GotoStationHome(false);
                }
                this.ToggleSideBar(2);
            });
            this.MyThemeSwitch = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(tIconGroup, { PreInitBag: ["ControlTW=1", "ControlTH=1", "TileFactorX=2", "TileFactorY=2"], PostInitBag: ["Title=<span class='fa' style='font-size:24px'>&#xf185;</span>", "ClassName=cdeVertCenter"] });
            this.MyThemeSwitch.SetProperty("OnClick", () => cdeNMI.ToggleTheme());
            const tileButHeaderBtnTheme2 = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(tIconGroup, { PreInitBag: ["ControlTW=1", "ControlTH=1", "TileFactorX=2", "TileFactorY=2"], PostInitBag: ["Title=<span class='fa' style='font-size:24px'>&#xf0c7;</span>", "ClassName=cdeVertCenter"] });
            tileButHeaderBtnTheme2.SetProperty("OnClick", (sender, e, tPs) => {
                if (e.button === 2) {
                    if (this.CurrentScreen) {
                        if (cdeNMI.MyPopUp)
                            cdeNMI.MyPopUp.Show(cde.MyBaseAssets.MyCommStatus.MyServiceUrl + "/nmi?CDEDL=" + this.CurrentScreen.MyScreenID + ";" + this.CurrentScreen.GetProperty("DashID"), true);
                    }
                    else {
                        if (this.StartView && this.StartView.FriendlyName === "MyHome") {
                            const tScene = this.StartView;
                            tScene.Screens = new Array();
                            for (const i in this.MyNMIScreens) {
                                if (this.MyNMIScreens.hasOwnProperty(i)) {
                                    const tS = new cdeNMI.TheScreenTrans();
                                    tS.ID = this.MyNMIScreens[i].MyScreenID;
                                    tS.DashID = this.MyNMIScreens[i].GetProperty("DashID");
                                    tS.IsVisible = this.MyNMIScreens[i].GetProperty("Visibility");
                                    tS.IsPinned = this.MyNMIScreens[i].GetProperty("IsPinned");
                                    tS.FldOrder = this.MyNMIScreens[i].GetProperty("FldOrder");
                                    if (tS.IsVisible || tS.IsPinned)
                                        tScene.Screens.push(tS);
                                }
                            }
                            const tStr = JSON.stringify(tScene);
                            if (cdeNMI.MyEngine) {
                                cdeNMI.MyEngine.PublishToNMI("NMI_SAVE_HOMESCENE", tStr);
                                cdeNMI.ShowToastMessage("My Home Scene updated!");
                            }
                        }
                    }
                    return;
                }
                this.ShowCreateViewPopup();
                this.ToggleSideBar(2);
            });
            const tileButHeaderBtnTheme3 = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(tIconGroup, { PreInitBag: ["ControlTW=1", "ControlTH=1", "TileFactorX=2", "TileFactorY=2"], PostInitBag: ["Title=<span class='fa' style='font-size:24px'>&#xf1fc;</span>", "ClassName=cdeVertCenter"] });
            tileButHeaderBtnTheme3.SetProperty("OnClick", (sender, e, tPs) => {
                if (cdeNMI.MyPopUp)
                    cdeNMI.MyPopUp.Hide(false);
                this.ToggleSideBar(2);
                this.ShowHideDrawOverlay();
            });
            const tileButHeaderBtnTheme4 = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(tIconGroup, { PreInitBag: ["ControlTW=1", "ControlTH=1", "TileFactorX=2", "TileFactorY=2"], PostInitBag: ["Title=<span class='fa' style='font-size:24px'>&#xf021;</span>", "ClassName=cdeVertCenter"] });
            tileButHeaderBtnTheme4.SetProperty("OnClick", (sender, e, tPs) => {
                if (cdeNMI.MyPopUp)
                    cdeNMI.MyPopUp.Hide(false);
                this.ToggleSideBar(2);
                let bForce = false;
                if (e.button === 2)
                    bForce = true;
                if (this.CurrentScreen && this.CurrentScreen !== this.GetScreenByID(cde.MyBaseAssets.MyServiceHostInfo.PortalScreen)) {
                    if (this.CurrentScreen.MyRefreshButton) {
                        this.CurrentScreen.MyRefreshButton.DoFireClick(null);
                        return;
                    }
                    else {
                        if (cdeNMI.MyEngine) {
                            const tFetch = 'NMI_GET_DATA:' + this.CurrentScreen.MyScreenID + ':' + this.CurrentScreen.GetProperty("ControlClass") + ':' + this.CurrentScreen.GetProperty("DashID") + ':true:' + bForce;
                            cdeNMI.MyEngine.PublishToNMI(tFetch, '', this.CurrentScreen.MyFieldInfo ? this.CurrentScreen.MyFieldInfo.cdeN : null);
                        }
                    }
                    return;
                }
                if (cde.MyBaseAssets.MyServiceHostInfo.StartScreen === "")
                    cdeNMI.MyNMIModels[cde.GuidToString(cde.MyBaseAssets.MyServiceHostInfo.PortalScreen)] = null;
                if (cdeNMI.MyToast)
                    cdeNMI.MyToast.ShowToastMessage("Portal Refresh sent!", "Touch the home icon to see the changes", 10000);
                if (cdeNMI.MyEngine)
                    cdeNMI.MyEngine.RequestReloadModel(cde.MyBaseAssets.MyServiceHostInfo.PortalScreen);
                this.RequestPortalScreen(cde.MyBaseAssets.MyServiceHostInfo.StartScreen ? true : bForce);
            });
            if (cde.MyBaseAssets.MyServiceHostInfo.RedPill) {
                const tSTL = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(tIconGroup, { PreInitBag: ["ControlTW=1", "ControlTH=1", "TileFactorX=2", "TileFactorY=2"], PostInitBag: ["Title=<span class='fa' style='font-size:24px; color:red;'>&#xf0c7;</span>", "ClassName=cdeVertCenter"] });
                tSTL.SetProperty("OnClick", (sender, e, tPs) => {
                    if (cdeNMI.MyPopUp)
                        cdeNMI.MyPopUp.Hide(false);
                    this.ToggleSideBar(2);
                    cdeNMI.TL.SaveResources();
                });
            }
            this.MyLogoButton = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.LogoButton).Create(null, { PreInitBag: ["ControlTW=1", "ControlTH=1", "TileFactorX=2", "TileFactorY=2"], PostInitBag: ["ClassName=MyHeaderButton", "PixelHeight=48", "PixelWidth=48", "FontSize=48"] });
            this.MyLogoButton.SetProperty("OnClick", (sender, e, tPs) => {
                if (cdeNMI.MyPopUp)
                    cdeNMI.MyPopUp.Hide(false);
                if (this.MyDrawOverlay)
                    this.ShowHideDrawOverlay();
                if (e.button === 2)
                    this.ClearAndGoHome();
                else {
                    this.ToggleSideBar(-1);
                }
            });
            if (this.mDivHeadButtonContent) {
                this.mDivHeadButtonContent.appendChild(this.MyLogoButton.GetElement());
                if (cde.MyBaseAssets.MyServiceHostInfo.WebPlatform !== 1 || cde.MyBaseAssets.MyServiceHostInfo.IsAppHosted) {
                    if (cde.MyBaseAssets.MyServiceHostInfo.IsAppHosted)
                        this.MyMainBackButton.SetProperty("Visibility", true);
                    this.mDivHeadButtonContent.insertBefore(this.MyMainBackButton.GetElement(), this.mDivHeadButtonContent.children[0]);
                    this.RegisterEvent("OnBrowserFullscreen", (sender, para) => {
                        this.MyMainBackButton.SetProperty("Visibility", para);
                    });
                }
                if (cde.MyBaseAssets.MyServiceHostInfo.WebPlatform === 2)
                    this.SetHoloLens();
            }
            if (cde.MyBaseAssets.MyServiceHostInfo.HideHeader) {
                this.MyHeader.style.display = "none";
                const tPortal = document.getElementById("MyNMIPortal");
                tPortal.style.marginTop = "0px";
            }
            this.mDivScreenList = document.createElement("div");
            this.mDivScreenList.className = "cdeScreenList";
            this.mDivScreenList.id = "cdeScreenList";
            if (this.mDivSideBar)
                this.mDivSideBar.appendChild(this.mDivScreenList);
            cdeNMI.ApplyTheme();
        }
        SetStatusMsg(pStatusMsg, pState) {
            if (this.MyLogoButton) {
                if (pState === 1)
                    this.MyLogoButton.SetProperty("Reset", 1);
                else
                    this.MyLogoButton.SetProperty("LogoState", pState);
            }
            super.SetStatusMsg(pStatusMsg, pState);
        }
        CreateScreenList() {
            if (!this.mDivScreenList)
                return;
            this.mDivScreenList.innerHTML = "";
            const tAllScreens = cdeNMI.SortNamedArray(this.MyNMIScreens, "LastShow", false, true);
            for (const idx in tAllScreens) {
                const tScreen = this.GetScreenByID(idx);
                if (!tScreen || !tScreen.GetInitialized() || (tScreen.MyFieldInfo && cde.CBool(tScreen.MyFieldInfo["HideFromSideBar"]) === true) || cde.CBool(tScreen.GetProperty("HideFromSideBar")) === true)
                    continue;
                let tTitle = "";
                tTitle = tScreen.GetProperty("ScreenTitle");
                if (!tTitle)
                    tTitle = tScreen.GetProperty("Title");
                if (!tTitle)
                    tTitle = tScreen.GetProperty("Caption");
                if (tTitle && tTitle.endsWith("-HIDE"))
                    continue;
                let tIcon = "<span class='fa fa-2x' style='vertical-align:middle;'>&#xf03e;</span>";
                if (tScreen.GetProperty("SideBarTitle")) {
                    tTitle = tScreen.GetProperty("SideBarTitle");
                }
                if (!tTitle)
                    continue;
                const nTitle = cdeNMI.StripHTML(tTitle);
                if (nTitle !== tTitle) {
                    if (tTitle.indexOf("'fa") >= 0 || tTitle.indexOf("\"fa") >= 0) {
                        if (tTitle.indexOf("fa fa") > 0 && tTitle.length > 32) {
                            const tP = tTitle.indexOf("</i>");
                            if (tP >= 0) {
                                tIcon = tTitle.substring(0, tP + 4).replace("fa-5x", "fa-2x");
                                tTitle = cdeNMI.StripHTML(tTitle.substring(tP + 4));
                            }
                        }
                        else {
                            tTitle = nTitle;
                        }
                    }
                    else
                        tTitle = nTitle;
                }
                if (tScreen.GetProperty("SideBarIconFA")) {
                    tIcon = "<span class='fa fa-2x' style='vertical-align:middle;'>" + tScreen.GetProperty("SideBarIconFA") + "</span>";
                }
                if (nTitle.startsWith("Loading..."))
                    continue;
                if (nTitle === "")
                    tTitle = "No Title - due to html strip";
                const tIconGroup = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileGroup).Create(null, { PreInitBag: ["ControlTH=1", "TileFactorY=2"], PostInitBag: ["TileWidth=4"] });
                this.mDivScreenList.appendChild(tIconGroup.GetElement());
                const tFormImg = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(tIconGroup, { PreInitBag: ["ControlTH=1", "TileFactorY=2"], PostInitBag: ["TileWidth=4", "Title=" + tIcon + "&nbsp;&nbsp;" + tTitle, "ClassName=cdeScreenListButton"] });
                tFormImg.SetProperty("Cookie", idx);
                tFormImg.SetProperty("OnClick", (sender, e, tPs) => {
                    if (cdeNMI.MyPopUp)
                        cdeNMI.MyPopUp.Hide(false);
                    this.ToggleSideBar(2);
                    const tIDX = sender.GetProperty("Cookie");
                    this.TransitToScreen(tIDX);
                });
            }
        }
        ToggleSideBar(pSetState) {
            if (!this.mDivSideBar)
                return;
            if (pSetState >= 0)
                this.mSideBarState = pSetState;
            switch (this.mSideBarState) {
                case 0:
                    this.mDivSideBar.style.width = (cdeNMI.GetSizeFromTile(1) / 2) + "px";
                    this.mSideBarState = 1;
                    this.mDivSideBar.classList.remove("cde-animate-left");
                    this.mDivScreenList.style.bottom = ((cdeNMI.GetSizeFromTile(1) / 2) * 6) + "px";
                    this.CreateScreenList();
                    break;
                case 1:
                    this.mDivSideBar.style.width = cdeNMI.GetSizeFromTile(4) + "px";
                    if (!this.mDivSideBar.classList.contains("cde-animate-left"))
                        this.mDivSideBar.classList.add("cde-animate-left");
                    this.mSideBarState = 2;
                    this.mDivScreenList.style.bottom = ((cdeNMI.GetSizeFromTile(1) / 2) * 2) + "px";
                    this.CreateScreenList();
                    break;
                case 2:
                    this.mDivSideBar.style.width = "0px";
                    this.mDivSideBar.classList.remove("cde-animate-left");
                    this.mSideBarState = 0;
                    break;
            }
        }
        CreateLoginButtonOnly() {
            let tileButHeaderBtnLogin;
            if (cde.MyBaseAssets.MyServiceHostInfo.WebPlatform !== 0) {
                tileButHeaderBtnLogin = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(null, { PreInitBag: ["ControlTW=1", "ControlTH=1", "TileFactorX=2", "TileFactorY=2"], PostInitBag: ["Title=<span class='fa' style='font-size:24px'>&#xf2bd;</span>", "ClassName=MyHeaderButton", "PixelHeight=48"] });
                tileButHeaderBtnLogin.SetProperty("OnClick", (pSender, evt) => {
                    if (evt.button === 2 && cde.MyBaseAssets.MyServiceHostInfo.WasPortalRequested === true) {
                        this.TransitToScreen(cde.MyBaseAssets.MyServiceHostInfo.PortalScreen);
                    }
                    else
                        cdeNMI.ResetBrowserToPortal();
                });
            }
            else {
                tileButHeaderBtnLogin = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.UserMenu).Create(null, { PreInitBag: ["TileFactorY=2"] });
            }
            tileButHeaderBtnLogin.SetProperty("TabIndex", 15);
            let divHeadButtonContentRight = document.getElementById("HeaderButtonContentRight");
            if (!divHeadButtonContentRight) {
                divHeadButtonContentRight = document.createElement("div");
                divHeadButtonContentRight.className = "cdeHeaderButtonContentRight";
                divHeadButtonContentRight.id = "HeaderButtonContentRight";
                let tMyHeader = document.getElementById("MyHeader");
                if (!tMyHeader) {
                    tMyHeader = document.createElement("div");
                    tMyHeader.className = "cdeLogoffTopRight";
                    tMyHeader.id = "MyLogoffButton";
                    this.GetElement().parentNode.insertBefore(tMyHeader, this.GetElement().nextSibling);
                }
                tMyHeader.appendChild(divHeadButtonContentRight);
            }
            if (cde.MyBaseAssets.MyServiceHostInfo.WebPlatform !== 1) {
                const tClock = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(null, { PreInitBag: ["ControlTW=1", "ControlTH=1", "TileFactorY=2"], PostInitBag: ["Title=" + cdeNMI.UpdateClock(2), "ClassName=cdeClock", "PixelHeight=48"] });
                tClock.SetProperty("Disabled", true);
                divHeadButtonContentRight.appendChild(tClock.GetElement());
                cdeNMI.StartClock(tClock, 2);
            }
            divHeadButtonContentRight.appendChild(tileButHeaderBtnLogin.GetElement());
        }
        ResizeEventHandler() {
            super.ResizeEventHandler();
            if (this.MyHeaderTitle) {
                if (this.mHeaderTileSize === 0)
                    this.mHeaderTileSize = this.MyHeaderTitle.GetElement().parentElement.offsetWidth + cdeNMI.GetSizeFromTile(5);
                if (window.outerWidth < this.mHeaderTileSize)
                    this.MyHeaderTitle.SetProperty("Visibility", false);
                else
                    this.MyHeaderTitle.SetProperty("Visibility", true);
            }
        }
        RenderHeader(bIsVisible) {
            return;
        }
        ShowHeader(bShow) {
            if (!cde.CBool(bShow)) {
                if (this.MyHeader)
                    this.MyHeader.style.display = 'none';
            }
            else {
                if (this.MyHeader && cde.MyBaseAssets.MyServiceHostInfo.WebPlatform !== 2)
                    this.MyHeader.style.display = '';
            }
        }
        SwitchTheme(bToDark) {
            if (this.MyThemeSwitch) {
                if (bToDark)
                    this.MyThemeSwitch.SetProperty("Title", "<span class='fa' style='font-size:23px'>&#xf185;</span>");
                else
                    this.MyThemeSwitch.SetProperty("Title", "<span class='fa' style='font-size:23px'>&#xf186;</span>");
            }
        }
        SetHoloLens() {
            super.SetHoloLens();
            (document.getElementById('MyHeader')).style.display = "none";
            return "";
        }
        TransitToScreen(pTargetScreen, MustExist = false, DontTryLoad = false, pCookie, pOwnerTable) {
            this.ToggleSideBar(2);
            super.TransitToScreen(pTargetScreen, MustExist, DontTryLoad, pCookie, pOwnerTable);
        }
    }
    cdeNMI.TheScreenManagerModern = TheScreenManagerModern;
})(cdeNMI || (cdeNMI = {}));
// SPDX-FileCopyrightText: 2009-2023 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
if (!String.prototype.endsWith) {
    String.prototype.endsWith = function (suffix) {
        return this.indexOf(suffix, this.length - suffix.length) !== -1;
    };
}
if (!String.prototype.startsWith) {
    String.prototype.startsWith = function (suffix) {
        return this.indexOf(suffix) !== -1;
    };
}
if (!String.prototype.format) {
    String.prototype.format = function (...params) {
        let formatted = this;
        for (let i = 0; i < params.length; i++) {
            const regexp = new RegExp('\\{' + i + '\\}', 'gi');
            formatted = formatted.replace(regexp, params[i]);
        }
        return formatted;
    };
}
var cdeNMI;
(function (cdeNMI) {
    function StopPointerEvents(evt) {
        if (!evt)
            return;
        if (evt.stopPropagation)
            evt.stopPropagation();
        if (evt.preventDefault)
            evt.preventDefault();
    }
    cdeNMI.StopPointerEvents = StopPointerEvents;
    function SetZIndex(pEle, pIDX) {
        if (pEle) {
            pEle.style.position = "relative";
            pEle.style.zIndex = pIDX.toString();
        }
    }
    cdeNMI.SetZIndex = SetZIndex;
    function cdeEscapeHtml(source) {
        return String(source).replace(/[&<>"']/g, s => cdeNMI.TheEscapeMap[s]);
    }
    cdeNMI.cdeEscapeHtml = cdeEscapeHtml;
    function GetControlWidth(pControl) {
        let tTileX = pControl.GetSetting("TileWidth");
        if (!tTileX)
            tTileX = 4;
        if (cde.CBool(pControl.GetSetting("NoTE")) === true)
            tTileX -= 2;
        if (tTileX < 0)
            tTileX = 1;
        return tTileX;
    }
    cdeNMI.GetControlWidth = GetControlWidth;
    /// MultiTouch Check
    function IsTouchDevice() {
        const el = document.createElement('div');
        el.setAttribute('ongesturestart', 'return;');
        if (typeof el.ontouchmove === "object") {
            return true;
        }
        else {
            return false;
        }
    }
    cdeNMI.IsTouchDevice = IsTouchDevice;
    function CleanState() {
        if (cde.MyBaseAssets.MyServiceHostInfo.PortalPage !== "")
            cdeNMI.ResetBrowserToPortal();
        else
            window.location.reload();
    }
    cdeNMI.CleanState = CleanState;
    function ResetKeyCorder() {
        cdeNMI.Key13Event = null;
        cdeNMI.Key27Event = null;
        cdeNMI.IsInEdit = false;
        cdeNMI.DisableKey36Event = false;
    }
    cdeNMI.ResetKeyCorder = ResetKeyCorder;
    //////// Animations //////////////////////////////
    function cdeBlendInTiles(subClass) {
        return;
    }
    cdeNMI.cdeBlendInTiles = cdeBlendInTiles;
    function RequestSync() {
        if (cde.MyContentEngine)
            cde.MyContentEngine.PublishToService('CDE_INIT_SYNC', '');
        if (cdeNMI.MyEngine)
            cdeNMI.MyEngine.FireEvent(true, "NMI_TOAST", 'Sync request sent to Relay');
    }
    cdeNMI.RequestSync = RequestSync;
    function ShowToastMessage(pTopic, pText, pTime) {
        if (cdeNMI.MyToast)
            cdeNMI.MyToast.ShowToastMessage(pTopic, pText, pTime);
    }
    cdeNMI.ShowToastMessage = ShowToastMessage;
    function cdeDoRequestUpdate() {
        if (cde.MyContentEngine)
            cde.MyContentEngine.PublishToFirstNode('CDE_REQ_UPDATE', '');
        if (cdeNMI.MyPopUp)
            cdeNMI.MyPopUp.Show('Relay is restarting in several seconds. Click ok to logout', true, null, 1, cdeNMI.CleanState);
    }
    function RequestUpdate() {
        if (cdeNMI.MyPopUp)
            cdeNMI.MyPopUp.Show('Are you sure you want to install this update? Your relay will restart and you need to login again.', false, null, 1, cdeDoRequestUpdate);
    }
    cdeNMI.RequestUpdate = RequestUpdate;
    function UpdateClock(pFactor = 1) {
        if (pFactor < 1)
            pFactor = 1;
        return moment().format("[<span style='font-size:" + (32 / pFactor) + "px; font-weight: bold;'>]HH:mm[</span></BR><span style='font-size:" + (24 / pFactor) + "px'>]YYYY-MM-DD");
    }
    cdeNMI.UpdateClock = UpdateClock;
    function FormatDate(pDate, pFormat) {
        return moment(pDate).format(pFormat);
    }
    cdeNMI.FormatDate = FormatDate;
    function FormatDateNow(pFormat) {
        return moment(Date.now()).format(pFormat);
    }
    cdeNMI.FormatDateNow = FormatDateNow;
    function StartClock(pControl, pFactor = 1) {
        if (!pControl)
            return;
        setInterval(() => {
            pControl.SetProperty("iValue", UpdateClock(pFactor));
        }, 60000);
    }
    cdeNMI.StartClock = StartClock;
    function GetLocation(href) {
        const l = document.createElement("a");
        l.href = href;
        return l;
    }
    cdeNMI.GetLocation = GetLocation;
    function RequestScopeID() {
        const tEdit = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.Password).Create(null, { TRF: new cdeNMI.TheTRF("SecID", 1, new cdeNMI.TheFieldInfo(cdeNMI.cdeControlType.SingleEnded, -1, "SecID:", 2, "SCOPEREQ")), PostInitBag: ["InnerClassName=cdeInput cdeInputCenter"] });
        if (cdeNMI.MyPopUp) {
            const tPopup = cdeNMI.MyPopUp.Show('Are you sure you want to request a new Security ID?</br>All agents and nodes connected to this relay will have to update their corresponding IDs as well. If this is a secondary Relay, enter the ID of your primary relay here, otherwise leave this field blank', false, tEdit, 1, (obj) => {
                const pC = obj.GetProperty("tEdit");
                let tID = "";
                if (pC)
                    tID = pC.GetProperty("Value");
                if (cde.MyContentEngine)
                    cde.MyContentEngine.PublishToFirstNode('CDE_REQ_SCOPEID', cde.MyContentEngine.RSAEncrypt(tID));
            });
            tPopup.SetProperty("tEdit", tEdit);
        }
    }
    cdeNMI.RequestScopeID = RequestScopeID;
    function TogglePortalFull(pShowFull) {
        const t = document.getElementById('MyNMIPortal');
        if (t) {
            if (pShowFull)
                t.style.width = "100%";
            else
                t.style.width = null;
        }
    }
    cdeNMI.TogglePortalFull = TogglePortalFull;
    ///Used by Convenience Apps
    function NUITagAction(pTag, pCookie) {
        const tControl = cdeNMI.MyNMINUITags[pTag];
        if (pTag === "go home") {
            if (cdeNMI.MyScreenManager)
                cdeNMI.MyScreenManager.GotoStationHome(false);
        }
        else if (pTag === "go back") {
            if (cdeNMI.MyScreenManager)
                cdeNMI.MyScreenManager.NavigateBack(false);
        }
        else if (tControl) {
            tControl.OnNUITag(pTag, pCookie);
        }
    }
    cdeNMI.NUITagAction = NUITagAction;
    ///Used by Convenience Apps
    function GetAllNUITags() {
        let tRes = "go home;go back";
        for (const i in cdeNMI.MyNMINUITags) {
            if (Object.prototype.hasOwnProperty.call(cdeNMI.MyNMINUITags, i)) {
                if (tRes.length > 0)
                    tRes += ";";
                tRes += i;
            }
        }
        return tRes;
    }
    cdeNMI.GetAllNUITags = GetAllNUITags;
    function GetCurrentScreen() {
        if (cdeNMI.MyScreenManager) {
            return cdeNMI.MyScreenManager.GetCurrentScreen();
        }
        return "";
    }
    cdeNMI.GetCurrentScreen = GetCurrentScreen;
    ///Used by Convenience Apps
    function ApplyTheme() {
        let schemes;
        let i;
        let t;
        if (cde.MyBaseAssets.MyServiceHostInfo.IsLiteTheme) {
            schemes = document.getElementsByTagName("link");
            for (i = 0; i < schemes.length; i++) {
                if (!schemes[i].hasAttribute("lite"))
                    continue;
                t = schemes[i].attributes["lite"];
                if (t) {
                    schemes[i].setAttribute("href", t.nodeValue + cdeNMI.GenerateFinalString("<%ISID%>"));
                }
            }
            if (cdeNMI.MyScreenManager) {
                cdeNMI.MyScreenManager.SwitchTheme(false);
            }
        }
        else {
            schemes = document.getElementsByTagName("link");
            for (i = 0; i < schemes.length; i++) {
                if (!schemes[i].hasAttribute("dark"))
                    continue;
                t = schemes[i].attributes["dark"];
                if (t) {
                    schemes[i].setAttribute("href", t.nodeValue + cdeNMI.GenerateFinalString("<%ISID%>"));
                }
            }
            if (cdeNMI.MyScreenManager) {
                cdeNMI.MyScreenManager.SwitchTheme(true);
            }
        }
        cde.MyBaseAssets.FireEvent(true, "ThemeSwitched", cde.MyBaseAssets.MyServiceHostInfo.IsLiteTheme);
    }
    cdeNMI.ApplyTheme = ApplyTheme;
    function ToggleTheme() {
        cde.MyBaseAssets.MyServiceHostInfo.IsLiteTheme = !cde.MyBaseAssets.MyServiceHostInfo.IsLiteTheme;
        ApplyTheme();
    }
    cdeNMI.ToggleTheme = ToggleTheme;
    function AddCSSB4Header(pCSSFile, pCSSFileLite) {
        let tFileCSS = cde.FixupPath(pCSSFile).toLowerCase();
        if (cde.MyBaseAssets.MyServiceHostInfo.IsLiteTheme && pCSSFileLite)
            tFileCSS = cde.FixupPath(pCSSFileLite).toLowerCase();
        const links = document.getElementsByTagName("link");
        if (links.length > 0) {
            for (const element of links) {
                if (element.getAttribute("href").toLowerCase() === tFileCSS)
                    return;
            }
        }
        const fileref = document.createElement("link");
        fileref.setAttribute("rel", "stylesheet");
        fileref.setAttribute("type", "text/css");
        fileref.setAttribute("cde", "colorScheme");
        fileref.setAttribute("media", "screen");
        fileref.setAttribute("dark", cde.FixupPath(pCSSFile));
        if (pCSSFileLite)
            fileref.setAttribute("lite", cde.FixupPath(pCSSFileLite));
        fileref.setAttribute("cde", "colorScheme");
        fileref.setAttribute("href", tFileCSS + cdeNMI.GenerateFinalString("<%ISID%>"));
        const tHead = document.getElementsByTagName("head")[0];
        tHead.insertBefore(fileref, tHead.childNodes[0]);
    }
    cdeNMI.AddCSSB4Header = AddCSSB4Header;
    function InsertCSS(pCSSName) {
        const headID = document.getElementsByTagName("head")[0];
        const cssNode = document.createElement('link');
        cssNode.type = 'text/css';
        cssNode.rel = 'stylesheet';
        cssNode.href = pCSSName + '.css';
        cssNode.media = 'screen';
        headID.appendChild(cssNode);
    }
    cdeNMI.InsertCSS = InsertCSS;
    function ThingLookup(tDefaults) {
        let retStr = cdeNMI.TheFlashCache.GetCache(tDefaults);
        if (retStr)
            return retStr;
        retStr = "";
        const MyTableName = cde.GuidToString('B510837F-3B75-4CF2-A900-D36C19113A13');
        const tParas = tDefaults.split(':');
        if (tParas.length > 2) {
            const tMyScreenInfo = cdeNMI.MyNMIModels[cde.GuidToString('FAFA22FF-96AC-42CF-B1DB-7C073053FC39')]; //Possible has to come from Paras
            if (!tMyScreenInfo || !tMyScreenInfo.MyStorageMirror[MyTableName])
                return "";
            for (const tRow of tMyScreenInfo.MyStorageMirror[MyTableName]) {
                const tSearch = cdeNMI.GetFldContentByName(tRow, "MyPropertyBag." + tParas[0] + ".Value", false);
                if (!tSearch || tSearch.length === 0)
                    continue;
                if (cde.GuidToString(tSearch) !== cde.GuidToString(tParas[1]))
                    continue;
                const tName = cdeNMI.GetFldContentByName(tRow, "MyPropertyBag." + tParas[2] + ".Value", false);
                if (tName && tName !== "")
                    retStr = tName;
                cdeNMI.TheFlashCache.AddCache(tDefaults, retStr, 3000);
            }
        }
        return retStr;
    }
    cdeNMI.ThingLookup = ThingLookup;
    function cdeParseHTML(pTargetControl, pTRF, pHTML) {
        if (pTargetControl === null)
            return;
        if (pTargetControl.HasFacePlate === true)
            return;
        pTargetControl.HasFacePlate = true;
        if (cdeNMI.MyEngine && pTRF && pTRF.ModelID && pTRF.TableName) {
            const tWait = new cdeNMI.TheFaceWait();
            tWait.TRF = pTRF;
            tWait.TargetControl = pTargetControl;
            tWait.HTML = pHTML;
            cdeNMI.MyEngine.LoadTableLazy(pTRF.ModelID, pTRF.TableName, cdeNMI.DoParseHTML, tWait);
        }
        else {
            pTargetControl.GetContainerElement().innerHTML = pHTML;
        }
    }
    cdeNMI.cdeParseHTML = cdeParseHTML;
    function GetStringSegment(pInStr, pStart, pEnd) {
        if (!pInStr || !pStart || !pEnd)
            return null;
        const pos = pInStr.indexOf(pStart);
        if (pos < 0)
            return null;
        const posEnd = pInStr.indexOf(pEnd, pos + pStart.length);
        if (posEnd < 0)
            return null;
        const Outer = pInStr.substring(pos, posEnd + pEnd.length);
        if (Outer.length < pStart.length + pEnd.length + 1)
            return null;
        return Outer.substring(pStart.length, Outer.length - pEnd.length);
    }
    cdeNMI.GetStringSegment = GetStringSegment;
    function ReturnStringSegment(pHTML, pStart, pEnd) {
        if (!pHTML || !pStart || !pEnd)
            return null;
        const tSeg = new cde.TheSegment();
        const pos = pHTML.indexOf(pStart);
        if (pos < 0)
            return null;
        const posEnd = pHTML.indexOf(pEnd, pos + pStart.length);
        if (posEnd < 0)
            return null;
        tSeg.Outer = pHTML.substring(pos, posEnd + pEnd.length);
        if (tSeg.Outer.length < pStart.length + pEnd.length + 1)
            return null;
        tSeg.Inner = tSeg.Outer.substring(pStart.length, tSeg.Outer.length - pEnd.length);
        return tSeg;
    }
    cdeNMI.ReturnStringSegment = ReturnStringSegment;
    function CreateTCB(pFacePlate, pName, pType = cdeNMI.cdeControlType.SingleEnded) {
        const pTRF = pFacePlate.TRF;
        const tTCB = new cdeNMI.TheControlBlock();
        tTCB.TargetID = "CNMIC" + (cdeNMI.MyNMISettings.IDCounter++);
        tTCB.MyControl = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SmartLabel);
        let tFldContent = "";
        const tFldInfo = new cdeNMI.TheFieldInfo(cdeNMI.cdeControlType.SmartLabel, 0, null);
        tFldInfo.DataItem = "MyPropertyBag." + pName + ".Value";
        let tOwnerThingID = "";
        if (pTRF && pTRF.FldInfo) {
            tOwnerThingID = cde.GuidToString(pTRF.FldInfo.cdeO);
            const fO = pTRF.FldInfo["FaceOwner"];
            if (fO)
                tOwnerThingID = cde.GuidToString(fO);
            tFldInfo.cdeO = pTRF.FldInfo.cdeO;
            tFldInfo.FormID = cde.GuidToString(pTRF.TableName);
            tFldInfo.cdeN = pTRF.FldInfo.cdeN;
            tFldInfo.Type = pType;
            tFldInfo["Element"] = "span";
            const tMyScreenInfo = cdeNMI.MyNMIModels[pTRF.ModelID];
            if (tMyScreenInfo && tMyScreenInfo.MyStorageMirror[tOwnerThingID]) {
                tFldContent = cdeNMI.GetFldContent(tMyScreenInfo.MyStorageMirror[tOwnerThingID][pTRF.RowNo], tFldInfo, false);
            }
            const tTRF = new cdeNMI.TheTRF(tOwnerThingID, pTRF ? pTRF.RowNo : 0, tFldInfo);
            tTRF.ModelID = pTRF ? pTRF.ModelID : null;
            tTCB.MyControl.InitControl(null, tTRF);
            tTCB.MyControl.SetProperty("iValue", tFldContent);
            if (!cdeNMI.MyTCBs[tTRF.TableName + "_" + pTRF.RowNo])
                cdeNMI.MyTCBs[tTRF.TableName + "_" + pTRF.RowNo] = [];
            cdeNMI.MyTCBs[tTRF.TableName + "_" + pTRF.RowNo].push(tTCB);
            pTRF.TableName = tTRF.TableName;
            cdeNMI.ThePB.SetRawProperty(tTCB.MyControl, "OnThingEvent", tFldInfo.cdeO + ";" + pName);
        }
        pFacePlate.TargetControl.MySubControls.push(tTCB);
        return tTCB;
    }
    cdeNMI.CreateTCB = CreateTCB;
    function ParseTagMacro(pFacePlate, pMacro, pTag, pEncloser = "") {
        if (!pMacro)
            return null;
        let tSeg = cdeNMI.ReturnStringSegment(pFacePlate.HTML, pMacro, '%>' + pEncloser);
        if (tSeg === null)
            return null;
        let tTCB = CreateTCB(pFacePlate, tSeg.Inner);
        pFacePlate.HTML = pFacePlate.HTML.replace(tSeg.Outer, pTag + tTCB.MyControl.GetProperty("Value") + '" ID="' + tTCB.TargetID + "_TGT" + pEncloser);
        tTCB.MyControl.SetProperty("Visibility", false);
        tTCB.MyControl.SetProperty("MyTCB", tTCB);
        pFacePlate.HTML += "<span ID=" + tTCB.TargetID + "></span>";
        return tTCB;
    }
    cdeNMI.ParseTagMacro = ParseTagMacro;
    function DoParseHTML(pTable, pFacePlate) {
        let tSeg;
        let tTCB;
        while (true) {
            tSeg = cdeNMI.ReturnStringSegment(pFacePlate.HTML, "<%P:", "%>");
            if (tSeg === null)
                break;
            tTCB = new cdeNMI.TheControlBlock();
            tTCB.TargetID = "CNMIC" + (cdeNMI.MyNMISettings.IDCounter++);
            pFacePlate.TargetControl.SetProperty(tSeg.Inner + "_TCB", tTCB);
            pFacePlate.HTML = pFacePlate.HTML.replace(tSeg.Outer, "<span ID=" + tTCB.TargetID + "></span>");
        }
        while (true) {
            tSeg = cdeNMI.ReturnStringSegment(pFacePlate.HTML, "<%C21:", "%>");
            if (tSeg === null)
                break;
            tTCB = CreateTCB(pFacePlate, tSeg.Inner, cdeNMI.cdeControlType.DateTime);
            pFacePlate.HTML = pFacePlate.HTML.replace(tSeg.Outer, "<span ID=" + tTCB.TargetID + "></span>");
        }
        while (true) {
            tSeg = cdeNMI.ReturnStringSegment(pFacePlate.HTML, "<%C20:", "%>");
            if (tSeg === null)
                break;
            tTCB = CreateTCB(pFacePlate, tSeg.Inner);
            pFacePlate.HTML = pFacePlate.HTML.replace(tSeg.Outer, "<span ID=" + tTCB.TargetID + "></span>");
        }
        while (true) {
            tTCB = cdeNMI.ParseTagMacro(pFacePlate, '<%I:', '');
            if (tTCB === null)
                break;
            tTCB.OnIValueChanged = (sender, pEvt, pVal) => {
                const ttcb = sender.GetProperty("MyTCB");
                if (pVal && document.getElementById(ttcb.TargetID + "_TGT")) {
                    document.getElementById(ttcb.TargetID + "_TGT").src = cde.FixupPath(pVal + cdeNMI.GenerateFinalString("<%ISID%>"));
                }
            };
        }
        while (true) {
            tTCB = cdeNMI.ParseTagMacro(pFacePlate, '<%V:', '');
            if (tTCB === null)
                break;
            tTCB.OnIValueChanged = (sender, pEvt, pVal) => {
                const ttcb = sender.GetProperty("MyTCB");
                if (pVal && document.getElementById(ttcb.TargetID + "_TGT"))
                    document.getElementById(ttcb.TargetID + "_TGT").value = pVal;
            };
        }
        while (true) {
            tTCB = cdeNMI.ParseTagMacro(pFacePlate, 'cdeTAG="<%S:', 'style="', '"');
            if (tTCB === null)
                break;
            tTCB.OnIValueChanged = (sender, pEvt, pVal) => {
                const ttcb = sender.GetProperty("MyTCB");
                if (pVal && document.getElementById(ttcb.TargetID + "_TGT"))
                    document.getElementById(ttcb.TargetID + "_TGT").style.cssText = pVal;
            };
        }
        while (true) {
            tTCB = cdeNMI.ParseTagMacro(pFacePlate, 'cdeTAG="<%C:', 'class="', '"');
            if (tTCB === null)
                break;
            tTCB.OnIValueChanged = (sender, pEvt, pVal) => {
                const ttcb = sender.GetProperty("MyTCB");
                if (pVal && document.getElementById(ttcb.TargetID + "_TGT"))
                    document.getElementById(ttcb.TargetID + "_TGT").className = pVal;
            };
        }
        pFacePlate.HTML = cdeNMI.GenerateFinalString(pFacePlate.HTML, false, pFacePlate.TRF);
        pFacePlate.TargetControl.GetContainerElement().innerHTML = pFacePlate.HTML;
        for (const element of pFacePlate.TargetControl.MySubControls) {
            const tELE = document.getElementById(element.TargetID);
            if (tELE) {
                const tP = tELE.parentElement;
                tP.replaceChild(element.MyControl.GetElement(), tELE);
                if (element.OnIValueChanged)
                    element.MyControl.SetProperty("OniValueChanged", element.OnIValueChanged);
            }
        }
        if (pFacePlate && pFacePlate.TRF) {
            cdeNMI.MyEngine.RegisterEvent("RecordUpdated_" + pFacePlate.TRF.TableName + "_" + pFacePlate.TRF.RowNo, (pSI, pModelGUID, tTabName, tRowID, pDirtyMask) => {
                UpdateFldsFromTable(pModelGUID, tTabName, tRowID);
            });
            UpdateFldsFromTable(pFacePlate.TRF.ModelID, pFacePlate.TRF.TableName, pFacePlate.TRF.RowNo);
        }
        function UpdateFldsFromTable(pModelGUID, tTabName, tRowID) {
            if (pModelGUID && pModelGUID !== "") {
                const tMod = cdeNMI.MyNMIModels[pModelGUID];
                if (tMod.MyStorageMirror[tTabName] && tMod.MyStorageMirror[tTabName][tRowID]) {
                    for (const tIdx in cdeNMI.MyTCBs[tTabName + "_" + tRowID]) {
                        const tTCB2 = cdeNMI.MyTCBs[tTabName + "_" + tRowID][tIdx];
                        if (tTCB2) {
                            if (!tMod.MyStorageMirror[tTabName][tRowID].hasOwnProperty('SecToken')) {
                                const tCont = cdeNMI.GetFldContent(tMod.MyStorageMirror[tTabName][tRowID], tTCB2.MyControl.MyFieldInfo, false);
                                if (tTCB2.MyControl.GetProperty("Value") !== tCont)
                                    tTCB2.MyControl.SetProperty("iValue", tCont);
                            }
                        }
                    }
                }
            }
        }
    }
    cdeNMI.DoParseHTML = DoParseHTML;
    function GenerateFinalString(pInStr, pData, pTRF, pKeepMacro) {
        if (!pInStr)
            return pInStr;
        if (typeof pInStr !== "string")
            pInStr = pInStr.toString();
        let outStr = pInStr;
        if (outStr.indexOf('<%UN%>') >= 0) {
            if (cde.MyBaseAssets.MyCommStatus.UserPref && cde.MyBaseAssets.MyCommStatus.UserPref.CurrentUserName)
                outStr = outStr.replace('<%UN%>', cde.MyBaseAssets.MyCommStatus.UserPref.CurrentUserName);
            else
                outStr = outStr.replace('<%UN%>', '');
        }
        if (outStr.indexOf('<%ISID%>') >= 0) {
            const tN = cde.MyBaseAssets.MyCommStatus.InitialNPA;
            const len = (tN.indexOf(".ashx") > 0 ? 5 : 0);
            const tISID = (!tN ? "" : "?SID=" + tN.substring(4, tN.length - len));
            outStr = outStr.replace('<%ISID%>', tISID);
        }
        if (outStr.indexOf('<%NOW%>') >= 0) {
            outStr = outStr.replace('<%NOW%>', moment(Date.now()).format("YYYY-MM-DD HH:mm:ss"));
        }
        if (pTRF && !pData) {
            const tScreenInfo = cdeNMI.MyNMIModels[pTRF.ModelID];
            if (tScreenInfo && tScreenInfo.MyStorageMirror && tScreenInfo.MyStorageMirror[pTRF.TableName])
                pData = tScreenInfo.MyStorageMirror[pTRF.TableName][pTRF.RowNo];
        }
        if (pData && pData !== true) {
            if (outStr.indexOf('<%NN%>') >= 0) {
                try {
                    outStr = outStr.replace('<%NN%>', pData.cdeN && cdeNMI.MyEngine ? cdeNMI.MyEngine.GetKnownNodeName(pData.cdeN) : '');
                }
                catch (_a) {
                    outStr = outStr.replace('<%NN%>', '');
                }
            }
            for (const index in pData) {
                if (Object.prototype.hasOwnProperty.call(pData, index)) {
                    if (index === "MyPropertyBag" && outStr.indexOf('%') >= 0) {
                        const myPropertyBag = pData["MyPropertyBag"];
                        for (const tBagItem in myPropertyBag) {
                            if (Object.prototype.hasOwnProperty.call(myPropertyBag, tBagItem)) {
                                if (outStr.indexOf('%MyPropertyBag.' + tBagItem + '.Value%') >= 0) {
                                    outStr = outStr.replace('%MyPropertyBag.' + tBagItem + '.Value%', myPropertyBag[tBagItem]["Value"]);
                                }
                                else if (outStr.indexOf('<%' + tBagItem + '%>') >= 0) {
                                    outStr = outStr.replace('<%' + tBagItem + '%>', myPropertyBag[tBagItem]["Value"]);
                                }
                                else if (outStr.indexOf('%' + tBagItem + '%') >= 0 && myPropertyBag[tBagItem]["Value"]) {
                                    outStr = outStr
                                        .replace('%' + tBagItem + '%', myPropertyBag[tBagItem]["Value"]);
                                }
                            }
                        }
                    }
                    let repl;
                    let tInStr;
                    if (outStr.indexOf('<%' + index + '%>') >= 0) {
                        repl = "";
                        if (pData[index]) {
                            if (typeof pData[index] !== "string")
                                repl = pData[index].toString();
                            else
                                repl = pData[index];
                        }
                        tInStr = "";
                        do {
                            tInStr = outStr;
                            outStr = outStr.replace('<%' + index + '%>', GenerateFinalString(repl, pData, pTRF));
                        } while (tInStr !== outStr);
                    }
                    else if (pData[index] &&
                        pData[index].MyFieldInfo &&
                        pData[index].MyFieldInfo.FldOrder &&
                        outStr.indexOf('<%' + pData[index].MyFieldInfo.FldOrder + ".") >= 0) {
                        const tFldO = pData[index].MyFieldInfo.FldOrder.toString();
                        const tPos = outStr.indexOf('<%' + tFldO + ".") + tFldO.length + 3;
                        const tPosEnd = outStr.indexOf("%>", tPos);
                        const tPropName = outStr.substring(tPos, tPosEnd);
                        const tVal = pData[index].GetProperty(tPropName);
                        if (tVal) {
                            outStr = tVal.toString();
                        }
                    }
                    else if (outStr.indexOf('%' + index + '%') >= 0) {
                        repl = "";
                        if (pData[index]) {
                            if (typeof pData[index] !== "string")
                                repl = pData[index].toString();
                            else
                                repl = pData[index];
                        }
                        tInStr = "";
                        do {
                            tInStr = outStr;
                            outStr = outStr.replace('%' + index + '%', GenerateFinalString(repl, pData, pTRF));
                        } while (tInStr !== outStr);
                    }
                }
            }
        }
        if (pTRF && pTRF.FldInfo) {
            let tT = 1;
            let gfsoutStr;
            while (tT === 1) {
                gfsoutStr = outStr;
                if (gfsoutStr.indexOf("%") < 0)
                    break; // 3 Recursions allowed then out...
                const tFound = cdeNMI.ReturnStringSegment(gfsoutStr, "%", "%");
                if (tFound) {
                    const tFl = pTRF.FldInfo[tFound.Inner];
                    if (tFl)
                        gfsoutStr = gfsoutStr.replace(tFound.Outer, tFl);
                }
                if (gfsoutStr !== outStr)
                    outStr = gfsoutStr;
                else
                    tT = 0;
            }
        }
        if (!pKeepMacro) {
            while (outStr.indexOf("<%") >= 0) {
                if (outStr.indexOf("%>") > 0) {
                    const tPre = outStr.substring(0, outStr.indexOf("<%"));
                    outStr = tPre + outStr.substring(outStr.indexOf("%>") + 2);
                }
                else
                    break;
            }
        }
        return outStr;
    }
    cdeNMI.GenerateFinalString = GenerateFinalString;
    function IconFAShim(pInstr) {
        if (pInstr.indexOf("&#x") < 0)
            return pInstr;
        let tOut = pInstr.replace("&#xf20e;", "&#xf61f;");
        tOut = tOut.replace("&#xf05D;", "&#xf058;");
        tOut = tOut.replace("&#xf0f6;", "&#xf46d;");
        return tOut;
    }
    cdeNMI.IconFAShim = IconFAShim;
    function IconShim(pInstr) {
        if (pInstr.indexOf("<$Loading$>") >= 0)
            pInstr = pInstr.replace("<$Loading$>", "Loading... <i class='fa fa-spinner fa-pulse'></i>");
        if (pInstr.indexOf("<$IsIso$>") >= 0)
            pInstr = pInstr.replace("<$IsIso$>", "<i class='fa fa-3x' style='color:green'>&#xf045;</i>");
        if (pInstr.indexOf("<$IsoNot$>") >= 0)
            pInstr = pInstr.replace("<$IsoNot$>", "<i class='fa fa-3x'>&#xf096;</i>");
        if (pInstr.indexOf("<$IsEnabled$>") >= 0)
            pInstr = pInstr.replace("<$IsEnabled$>", "<i class='fa fa-3x' style='color:green'>&#xf05D;</i>");
        if (pInstr.indexOf("<$IsDisabled$>") >= 0)
            pInstr = pInstr.replace("<$IsDisabled$>", "<i class='fa fa-3x' style='color:red'>&#xf05E;</i>");
        if (pInstr.indexOf("<$IsUnloaded>") >= 0)
            pInstr = pInstr.replace("<$IsUnloaded>", "<i class='fa fa-4x' style='color:green'>&#xf04B;</i>");
        if (pInstr.indexOf("<$IsLoaded$>") >= 0)
            pInstr = pInstr.replace("<$IsLoaded$>", "<i class='fa fa-4x' style='color:red'>&#xf04D;</i>");
        if (pInstr.indexOf("<$NoBreak$>") >= 0)
            pInstr = pInstr.replace("<$NoBreak$>", "&nbsp;");
        return pInstr;
    }
    cdeNMI.IconShim = IconShim;
    function AddFieldComment(pTarget, pFieldInfo) {
        if (!pFieldInfo)
            return null;
        const tHelpText = pFieldInfo["HelpText"];
        let dHelp = null;
        if (tHelpText && tHelpText !== "") {
            dHelp = document.createElement("div");
            dHelp.className = "cdeFormEntryComment";
            dHelp.innerHTML = tHelpText;
            pTarget.appendChild(dHelp);
        }
        return dHelp;
    }
    cdeNMI.AddFieldComment = AddFieldComment;
    function UpdFldContent(pRowData, pFormField, pNewValue, pOldValues) {
        if (!pRowData || !pFormField || !pFormField.DataItem)
            return false;
        const tDataItem = pFormField.DataItem.split('.');
        let tFldName = tDataItem[1];
        if (tDataItem.length > 3) {
            for (let i = 2; i < tDataItem.length - 1; i++) {
                tFldName += "." + tDataItem[i];
            }
        }
        let tFldContent = pRowData[tDataItem[0]];
        let tHasNewValue = false;
        if (tDataItem.length > 1) {
            for (let u = 1; u < tDataItem.length - 1; u++) {
                if (tFldContent === undefined) {
                    break;
                }
                else {
                    tFldContent = tFldContent[tDataItem[u]];
                }
            }
            if (!tFldContent) {
                if (tDataItem[0] === "MyPropertyBag" && !cde.IsNotSet(pNewValue)) {
                    if (!pRowData[tDataItem[0]])
                        pRowData[tDataItem[0]] = {};
                    pRowData[tDataItem[0]][tFldName] = new cde.cdeP();
                    pRowData[tDataItem[0]][tFldName].Name = tFldName;
                    pRowData[tDataItem[0]][tFldName].Value = pNewValue;
                    tHasNewValue = true;
                }
            }
            else {
                if ((pFormField && cde.CBool(pFormField["ForceSet"])) || (tFldContent[tDataItem[tDataItem.length - 1]] !== pNewValue && (!pOldValues || pOldValues[tDataItem[tDataItem.length - 1]] !== pNewValue))) {
                    if (pOldValues && !pOldValues[tDataItem[tDataItem.length - 1]])
                        pOldValues[tDataItem[tDataItem.length - 1]] = tFldContent[tDataItem[tDataItem.length - 1]];
                    //testing for encrypt with ((pFormField.Flags & 1) != 0 && cde.MyContentEngine) 
                    //  then encrypt with RSA tFldContent[tDataItem[tDataItem.length - 1]] = "&^CDEP5^&:" + cde.MyContentEngine.RSAEncrypt(pNewValue); //coming soon...RSA does fail at the moment else
                    tFldContent[tDataItem[tDataItem.length - 1]] = pNewValue; //NOSONAR this is correct for now
                    tHasNewValue = true;
                }
            }
        }
        else {
            if (pRowData.hasOwnProperty('SecToken') || (tFldContent !== pNewValue && (!pOldValues || pOldValues[tDataItem[0]] !== pNewValue))) {
                if (pOldValues && !pOldValues[tDataItem[0]])
                    pOldValues[tDataItem[0]] = tFldContent;
                if (pRowData.hasOwnProperty('SecToken') && (pFormField.Flags & 1) !== 0) {
                    if (pRowData.SecToken === "")
                        pRowData.SecToken = "CDE!";
                    pRowData.SecToken += ";:;" + pFormField.FldOrder + "=" + pNewValue;
                    pRowData[tDataItem[0]] = null;
                }
                else {
                    pRowData[tDataItem[0]] = pNewValue;
                }
                tHasNewValue = true;
            }
        }
        return tHasNewValue;
    }
    cdeNMI.UpdFldContent = UpdFldContent;
    function SortArrayByProperty(pInArray, property, IsNumeric, pSortDescending) {
        if (!pInArray)
            return [];
        const tArray = pInArray.slice(0);
        return tArray.sort((a, b) => {
            let c;
            let d;
            if (property.indexOf('.') > 0) {
                c = cdeNMI.GetFldContentByName(a, property, false);
                d = cdeNMI.GetFldContentByName(b, property, false);
            }
            else {
                c = IsNumeric ? parseFloat(a[property]) : a[property].toString();
                d = IsNumeric ? parseFloat(b[property]) : b[property].toString();
            }
            if (c === d)
                return 0;
            return pSortDescending ? d > c ? 1 : -1 : d < c ? 1 : -1;
        });
    }
    cdeNMI.SortArrayByProperty = SortArrayByProperty;
    function GetFldContent(pTableRow, pFormField, pIsGenerated) {
        if (!pFormField || !pFormField.DataItem || !pFormField.DataItem || !pTableRow)
            return null;
        const tFldName = pFormField.DataItem.split('.');
        let tFldContent;
        if (tFldName.length > 3) { //SubProperties here
            let tFldRealName = tFldName[1];
            for (let i = 2; i < tFldName.length - 1; i++) {
                tFldRealName += "." + tFldName[i];
            }
            tFldContent = pTableRow[tFldName[0]];
            if (tFldContent[tFldRealName]) {
                tFldContent = tFldContent[tFldRealName];
                tFldContent = tFldContent[tFldName[tFldName.length - 1]];
            }
            else {
                const tSubProps = tFldRealName.split('].[');
                let pBag = tFldContent;
                let tMainProp = null;
                for (const element of tSubProps) {
                    tMainProp = pBag[element.replace('[', '').replace(']', '')];
                    pBag = tMainProp.cdePB;
                }
                if (tMainProp)
                    tFldContent = tMainProp[tFldName[tFldName.length - 1]];
            }
        }
        else {
            if (tFldName[0] === "cdeN") {
                if (cdeNMI.MyEngine && !cdeNMI.MyEngine.IsNodeDown(pTableRow.cdeN)) {
                    tFldContent = cdeNMI.MyEngine.GetKnownNodeName(pTableRow.cdeN);
                }
                if (!tFldContent)
                    tFldContent = pTableRow.cdeN;
                return tFldContent;
            }
            else
                tFldContent = pTableRow[tFldName[0]];
            if (tFldName.length > 1) {
                for (let u = 1; u < tFldName.length; u++) {
                    if (tFldContent === undefined) {
                        tFldContent = "";
                        break;
                    }
                    else {
                        tFldContent = tFldContent[tFldName[u]];
                        if (pIsGenerated && tFldContent !== undefined && tFldContent.length > 5 && tFldContent.substring(0, 5) === "/Date") {
                            pFormField.Type = 21;
                            pFormField["FldWidth"] = 5;
                        }
                    }
                }
            }
        }
        return tFldContent;
    }
    cdeNMI.GetFldContent = GetFldContent;
    function GetFldContentByName(pTableRow, pFormField, pIsDeepRow) {
        if (!pFormField)
            return null;
        let tFldContent = null;
        try {
            const tFldName = pFormField.split('.');
            if (pIsDeepRow) {
                let tFldRealName = tFldName[1];
                if (tFldName.length > 3) {
                    for (let i = 2; i < tFldName.length - 1; i++) {
                        tFldRealName += "." + tFldName[i];
                    }
                }
                tFldContent = pTableRow[tFldRealName];
            }
            else {
                tFldContent = pTableRow[tFldName[0]];
                if (tFldName.length > 1) {
                    for (let u = 1; u < tFldName.length; u++) {
                        if (tFldContent === undefined) {
                            tFldContent = "";
                            break;
                        }
                        else {
                            tFldContent = tFldContent[tFldName[u]];
                        }
                    }
                }
            }
        }
        catch (ee) {
            cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "nmiUtils:GetFldContentByName:error", ee);
        }
        return tFldContent;
    }
    cdeNMI.GetFldContentByName = GetFldContentByName;
    function RemoveCookies() {
        const res = document.cookie;
        const multiple = res.split(";");
        for (const element of multiple) {
            const key = element.split("=");
            document.cookie = key[0] + " =; expires = Thu, 01 Jan 1970 00:00:00 UTC";
        }
    }
    cdeNMI.RemoveCookies = RemoveCookies;
    class TheMaterialTouch {
        constructor(customOptions) {
            this.options_default = {
                classes: {
                    rippleContainer: 'md-ripple-wrapper',
                    ripple: 'md-ripple-effect'
                },
                transition: {
                    delay: 0,
                    duration: 300
                },
                opacity: 0.3,
                size: 100,
                center: false
            };
            this.options = null;
            this.data = { transition: false };
            this.mItem = null;
            const optionsDefault = this.options_default;
            this.options = (customOptions ? this.MergeObject(optionsDefault, customOptions) : optionsDefault);
        }
        MergeObject(...params) {
            const self = this, arraynew = {};
            for (let ai in arguments) {
                if (arguments.hasOwnProperty(ai)) {
                    const array = arguments[ai];
                    for (let index in array) {
                        if (array.hasOwnProperty(index)) {
                            let value;
                            if (array.hasOwnProperty(index)) {
                                if (typeof array[index] === 'object' && arraynew[index] && typeof arraynew[index] === 'object')
                                    value = self.MergeObject(arraynew[index], array[index]);
                                else
                                    value = array[index];
                                arraynew[index] = value;
                            }
                        }
                    }
                }
            }
            return arraynew;
        }
        ShowWave(item, e) {
            this.mItem = item;
            const clickX = e.x;
            const clickY = e.y;
            const width = item.offsetWidth;
            const height = item.offsetHeight;
            const size = this.options.size;
            let rippleWrapper = null;
            if (item.querySelector !== undefined)
                rippleWrapper = item.querySelector('.' + this.options.classes.rippleContainer);
            if (!rippleWrapper) {
                rippleWrapper = document.createElement('div');
                rippleWrapper.setAttribute('class', this.options.classes.rippleContainer);
                item.appendChild(rippleWrapper);
            }
            const ripple = document.createElement('div');
            ripple.setAttribute('class', this.options.classes.ripple);
            ripple.style.opacity = this.options.opacity;
            ripple.style.top = clickY + 'px';
            ripple.style.left = clickX + 'px';
            ripple.style.width = "0";
            ripple.style.height = "0";
            rippleWrapper.appendChild(ripple);
            let newX = (clickX - (size / 2)), newY = (clickY - (size / 2));
            if (this.options.center) {
                newX = (width / 2) - (size / 2);
                newY = (height / 2) - (size / 2);
            }
            this.DoRender(ripple, {
                top: newY + 'px',
                left: newX + 'px',
                width: size + 'px',
                height: size + 'px'
            });
            setTimeout(() => {
                this.EndWave(this.mItem);
            }, 100);
        }
        EndWave(item) {
            const rippleWrapper = item.querySelector('.' + this.options.classes.rippleContainer);
            let ripples;
            if (rippleWrapper && rippleWrapper.children) {
                ripples = rippleWrapper.children;
                [].forEach.call(ripples, (ripple) => {
                    this.DoRender(ripple, { opacity: 0 });
                    setTimeout(() => {
                        if (ripple.parentElement)
                            ripple.parentElement.removeChild(ripple);
                    }, this.options.transition.duration);
                });
            }
        }
        EasyMeOut(pTime, pVal1, pVal2, pDura) {
            return pVal2 * (-Math.pow(2, -10 * pTime / pDura) + 1) + pVal1;
        }
        DoRender(obj, properties, duration) {
            const propertiesObject = {};
            const timeStart = new Date().getTime();
            if (!duration && duration !== 0)
                duration = this.options.transition.duration;
            for (const prop in properties) {
                if (properties.hasOwnProperty(prop)) {
                    propertiesObject[prop] = obj.style[prop];
                }
            }
            this.data.transition = true;
            const animate = setInterval(() => {
                let timePassed = new Date().getTime() - timeStart;
                if (timePassed >= duration)
                    timePassed = duration;
                // Run property update per property
                let propValue;
                let prop;
                for (prop in properties) {
                    if (properties.hasOwnProperty(prop)) {
                        propValue = properties[prop];
                        let defaultValue = propertiesObject[prop], newValue = null, defaultSuffix = null, negative = 0;
                        if (typeof defaultValue === 'string')
                            defaultSuffix = defaultValue.replace(/^\-?[0-9\.]+(.*)$/, '$1'); //NOSONAR Not Critical
                        defaultValue = parseFloat(defaultValue);
                        propValue = parseFloat(propValue);
                        negative = (propValue < defaultValue ? propValue : defaultValue);
                        defaultValue = defaultValue - negative;
                        propValue = propValue - negative;
                        if (defaultValue > propValue) {
                            newValue = defaultValue - this.EasyMeOut(timePassed, propValue, defaultValue, duration);
                            if (newValue < propValue)
                                newValue = propValue;
                        }
                        else if (defaultValue !== propValue) {
                            newValue = this.EasyMeOut(timePassed, defaultValue, propValue, duration);
                            if (newValue > propValue)
                                newValue = propValue;
                        }
                        else {
                            newValue = propValue;
                        }
                        // Remember "negative"? Add it back
                        if (negative !== 0)
                            newValue = newValue + negative;
                        newValue = newValue + '';
                        newValue = newValue.replace(/(\d+(\.\d{0,3})?).*/, "$1");
                        newValue = parseFloat(newValue);
                        if (defaultSuffix) {
                            newValue = newValue + defaultSuffix;
                        }
                        obj.style[prop] = newValue;
                    }
                }
                if (timePassed >= duration) {
                    clearInterval(animate);
                    // Make sure all properties are set to the correct final value
                    for (prop in properties) {
                        if (properties.hasOwnProperty(prop)) {
                            propValue = properties[prop];
                            let propSuffix = null;
                            if (typeof propValue === 'string')
                                propSuffix = propValue.replace(/^\-?[0-9\.]+(.*)$/, '$1'); //NOSONAR Not Critical
                            propValue = parseFloat(propValue);
                            obj.style[prop] = (propSuffix ? propValue + propSuffix : propValue);
                            // Set transition to false
                            this.data.transition = false;
                        }
                    }
                }
            }, 24);
        }
    }
    cdeNMI.TheMaterialTouch = TheMaterialTouch;
    function cdeJsonDate2JSDate(jsonDateIn) {
        if (jsonDateIn instanceof Date)
            return jsonDateIn;
        const jsonDate = cde.CStr(jsonDateIn);
        if (jsonDate.substring(0, 2) === "\/") {
            const offset = new Date().getTimezoneOffset() * 60000;
            const parts = /\/Date\((-?\d+)([+-]\d{2})?(\d{2})?.*/.exec(jsonDate); //NOSONAR Not Critical
            if (parts[2] === undefined)
                parts[2] = "0";
            if (parts[3] === undefined)
                parts[3] = "0";
            return new Date(+parts[1] + offset + parseInt(parts[2]) * 3600000 + parseInt(parts[3]) * 60000);
        }
        else {
            if (jsonDate.substring(0, 1) === "/")
                return new Date(parseInt(jsonDate.substring(6)));
            else
                return new Date(jsonDate);
        }
    }
    cdeNMI.cdeJsonDate2JSDate = cdeJsonDate2JSDate;
    function DoesArrayContain(pArray, pCont) {
        for (const element of pArray) {
            if (element === pCont)
                return true;
        }
        return false;
    }
    cdeNMI.DoesArrayContain = DoesArrayContain;
    function SortArray(pInArray, property, IsNumeric, pSortDescending) {
        if (!pInArray)
            return [];
        const tArray = pInArray.slice(0);
        return tArray.sort((a, b) => {
            if (!a[property])
                a[property] = "";
            if (!b[property])
                b[property] = "";
            const c = IsNumeric ? parseFloat(a[property]) : a[property].toString();
            const d = IsNumeric ? parseFloat(b[property]) : b[property].toString();
            if (c === d)
                return 0;
            return pSortDescending ? d > c ? 1 : -1 : d < c ? 1 : -1;
        });
    }
    cdeNMI.SortArray = SortArray;
    function SortNamedArray(pInArray, property, IsNumeric, pSortDescending) {
        const tuples = [];
        const pOutArray = new Array();
        try {
            for (const key in pInArray)
                tuples.push([key, pInArray[key]]);
            tuples.sort(function (a, b) {
                let aa = a[1].GetProperty(property);
                if (!aa)
                    aa = "";
                let bb = b[1].GetProperty(property);
                if (!bb)
                    bb = "";
                const c = IsNumeric ? parseFloat(aa) : aa.toString();
                const d = IsNumeric ? parseFloat(bb) : bb.toString();
                if (c === d)
                    return 0;
                return pSortDescending ? d > c ? 1 : -1 : d < c ? 1 : -1;
            });
            for (const element of tuples) {
                const tkey = element[0];
                const tvalue = element[1];
                pOutArray[tkey] = tvalue;
            }
        }
        catch (ee) {
            cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "nmiUtils:SortNamedArray:error:" + ee, ee.stack);
            return pInArray;
        }
        return pOutArray;
    }
    cdeNMI.SortNamedArray = SortNamedArray;
    function ResizeIframe(pEleName) {
        if (document.getElementById(pEleName)) {
            let height = document.documentElement.clientHeight;
            const wid = document.documentElement.clientWidth - 5;
            height -= (document.getElementById(pEleName).parentElement.offsetTop + 10);
            document.getElementById(pEleName).style.height = height + "px";
            document.getElementById(pEleName).style.width = wid + "px";
        }
    }
    cdeNMI.ResizeIframe = ResizeIframe;
    function cdeSleep(ms) {
        const dt = new Date();
        dt.setTime(dt.getTime() + ms);
        while (new Date().getTime() < dt.getTime())
            ;
    }
    cdeNMI.cdeSleep = cdeSleep;
    function StripHTML(inStr) {
        const div = document.createElement("div");
        div.innerHTML = inStr;
        return div.textContent || div.innerText || "";
    }
    cdeNMI.StripHTML = StripHTML;
    function cdeRunAsync(MyFunc, pTimeDelay, ...params) {
        if (!pTimeDelay || pTimeDelay === 0)
            MyFunc(params);
        else {
            setTimeout(MyFunc, pTimeDelay, params);
        }
    }
    cdeNMI.cdeRunAsync = cdeRunAsync;
    function DateToMini(inDate) {
        const month = inDate.getMonth() + 1;
        const day = inDate.getDate();
        const year = inDate.getFullYear();
        const hours = inDate.getHours();
        const minutes = inDate.getMinutes();
        const seconds = inDate.getSeconds();
        let ampm = "AM";
        if (hours > 11) {
            ampm = "PM";
        }
        return month + day + year + "_" + hours + "_" + minutes + "_" + seconds + "_" + ampm;
    }
    cdeNMI.DateToMini = DateToMini;
    function DateToString(inDate) {
        return cde.DateToString(inDate);
    }
    cdeNMI.DateToString = DateToString;
    function CalculateTransform(offsetX, offsetY) {
        const tileMid = 75;
        let tX;
        let tY;
        const tDegBase = 30;
        let tDeg;
        if ((offsetX < tileMid) && (offsetY < tileMid)) {
            tX = (offsetX - tileMid) / tileMid;
            tY = -(offsetY - tileMid) / tileMid;
            tDeg = Math.max((tDegBase * tX), (tDegBase * tY));
        }
        else if ((offsetX > tileMid) && (offsetY < tileMid)) {
            tX = -(offsetX - tileMid) / tileMid;
            tY = (offsetY - tileMid) / tileMid;
            tDeg = Math.max((tDegBase * tX), (tDegBase * tY));
        }
        else if ((offsetX < tileMid) && (offsetY > tileMid)) {
            tX = -(offsetX - tileMid) / tileMid;
            tY = (offsetY - tileMid) / tileMid;
            tDeg = -Math.max((tDegBase * tX), (tDegBase * tY));
        }
        else {
            tX = (offsetX - tileMid) / tileMid;
            tY = -(offsetY - tileMid) / tileMid;
            tDeg = -Math.max((tDegBase * tX), (tDegBase * tY));
        }
        return "rotate3d(" + tY + "," + tX + ", 0," + tDeg + "deg)";
    }
    cdeNMI.CalculateTransform = CalculateTransform;
    function Check4ValidPassword(pwd) {
        if (!pwd || pwd.length === 0)
            return true;
        if (pwd.length < 8)
            return false;
        return true;
    }
    cdeNMI.Check4ValidPassword = Check4ValidPassword;
    function Check4ValidEmail(email) {
        if (!email || email.length === 0)
            return true;
        const filter = /([!#-'*+\/-9=?A-Z^-~-]+(.[!#-'*+\/-9=?A-Z^-~-]+)*|"([]!#-[^-~ \t]|(\[\t -~]))+")@([!#-'*+\/-9=?A-Z^-~-]+(.[!#-'*+\/-9=?A-Z^-~-]+)*|[[\t -Z^-~]*])/; //NOSONAR RFC5322 validation
        if (!email || !filter.test(email.toLowerCase()) || email.substring(0, 1) === '.' || email.substring(email.length - 1, 1) === '.')
            return false;
        return true;
    }
    cdeNMI.Check4ValidEmail = Check4ValidEmail;
    function IsSamePassword(pPass1, pPass2, AllowMotLock) {
        if ((!pPass1 || pPass1.length === 0) && (!pPass2 || pPass2.length === 0))
            return true;
        if ((!pPass1 && pPass2) || (pPass1 && !pPass2))
            return false;
        if (AllowMotLock && pPass1.indexOf(';') > 0) {
            if (!pPass2)
                return false;
            const MotLockParts = pPass1.split(';');
            const MotL2 = pPass2.split(';');
            let IsMotLock = true;
            let i;
            for (i = 0; i < MotLockParts.length; i++) {
                if (MotLockParts[i].length === 0) {
                    IsMotLock = false;
                    break;
                }
            }
            if (IsMotLock) {
                for (i = 0; i < MotLockParts.length; i++) {
                    if (MotL2[i].length === 0)
                        return false;
                    const Arr1 = MotLockParts[i].split('');
                    const Arr2 = MotL2[i].split('');
                    if (Arr1.length !== Arr2.length)
                        return false;
                    Arr1.sort();
                    Arr2.sort();
                    for (let j = 0; j < Arr1.length; j++) {
                        if (Arr1[j] !== Arr2[j])
                            return false;
                    }
                }
                return true;
            }
        }
        if (pPass1 === pPass2)
            return true;
        return false;
    }
    cdeNMI.IsSamePassword = IsSamePassword;
    function CColorToHex(color) {
        if (color.substring(0, 1) === '#') {
            return color;
        }
        const digits = /(.*?)rgb\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/.exec(color); //NOSONAR Not Critical
        const red = parseInt(digits[2]);
        const green = parseInt(digits[3]);
        const blue = parseInt(digits[4]);
        const rgb = blue | (green << 8) | (red << 16);
        return digits[1] + '#' + rgb.toString(16);
    }
    cdeNMI.CColorToHex = CColorToHex;
    function HasPlaceholderSupport() {
        const input = document.createElement('input');
        return ('placeholder' in input);
    }
    cdeNMI.HasPlaceholderSupport = HasPlaceholderSupport;
    function cdeMinMax(pValue, sourceMax, sourceMin, targetMax, targetMin) {
        pValue = (pValue - sourceMin) * (targetMax - targetMin) / (sourceMax - sourceMin) + targetMin;
        return pValue;
    }
    cdeNMI.cdeMinMax = cdeMinMax;
    function LoadJsCssFile(filename, filetype) {
        if (filetype === "js") {
            const fileref = document.createElement('script');
            fileref.setAttribute("type", "text/javascript");
            fileref.setAttribute("src", filename);
            document.getElementsByTagName("head")[0].appendChild(fileref);
        }
        else if (filetype === "css") {
            const cssfileref = document.createElement("link");
            cssfileref.setAttribute("rel", "stylesheet");
            cssfileref.setAttribute("type", "text/css");
            cssfileref.setAttribute("href", filename);
            document.getElementsByTagName("head")[0].appendChild(cssfileref);
        }
    }
    cdeNMI.LoadJsCssFile = LoadJsCssFile;
    function SortArrayEx(pInArray, property, IsNumeric, pSortDescending) {
        if (!pInArray)
            return [];
        const tArray = pInArray.slice(0);
        return tArray.sort((a, b) => {
            let c;
            let d;
            let ac;
            let bc;
            if (!IsNumeric) {
                const tProps = property.split(',');
                for (const element of tProps) {
                    ac = a[element];
                    if (!ac)
                        ac = "";
                    bc = b[element];
                    if (!bc)
                        bc = "";
                    if (c && c.length > 0)
                        c += ".";
                    c += ac.toString();
                    if (d && d.length > 0)
                        d += ".";
                    d += bc.toString();
                }
            }
            else {
                ac = a[property];
                if (!ac)
                    ac = "";
                bc = b[property];
                if (!bc)
                    bc = "";
                c = IsNumeric ? parseFloat(ac) : ac.toString();
                d = IsNumeric ? parseFloat(bc) : bc.toString();
            }
            if (c === d)
                return 0;
            return pSortDescending ? d > c ? 1 : -1 : d < c ? 1 : -1;
        });
    }
    cdeNMI.SortArrayEx = SortArrayEx;
    const BASE64_MARKER = ';base64,';
    function convertBase64ToBinary(dataURI) {
        const base64Index = dataURI.indexOf(BASE64_MARKER) + BASE64_MARKER.length;
        const base64 = dataURI.substring(base64Index);
        const raw = window.atob(base64);
        const rawLength = raw.length;
        const array = new Uint8Array(new ArrayBuffer(rawLength));
        for (let i = 0; i < rawLength; i++) {
            array[i] = raw.charCodeAt(i);
        }
        return array;
    }
    cdeNMI.convertBase64ToBinary = convertBase64ToBinary;
    // Converts from degrees to radians.
    function toRadians(degrees) {
        return degrees * Math.PI / 180;
    }
    cdeNMI.toRadians = toRadians;
    // Converts from radians to degrees.
    function toDegrees(radians) {
        return radians * 180 / Math.PI;
    }
    cdeNMI.toDegrees = toDegrees;
    function ValidateIPaddress(inputText) {
        if (!inputText || inputText.length === 0)
            return true;
        const ipformat = /^(25[0-5]|2[0-4]\d|[01]?\d\d?)\.(25[0-5]|2[0-4]\d|[01]?\d\d?)\.(25[0-5]|2[0-4]\d|[01]?\d\d?)\.(25[0-5]|2[0-4]\d|[01]?\d\d?)$/;
        if (inputText.match(ipformat)) {
            return true;
        }
        return false;
    }
    cdeNMI.ValidateIPaddress = ValidateIPaddress;
    function ResetBrowserToPortal() {
        if (cde.MyCommChannel)
            cde.MyCommChannel.Logout();
        window.location.href = cde.MyBaseAssets.MyServiceHostInfo.PortalPage;
    }
    cdeNMI.ResetBrowserToPortal = ResetBrowserToPortal;
    function Vector2Distance(a, b) {
        return Math.sqrt(Math.pow(a.x - b.x, 2.0) + Math.pow(a.y - b.y, 2.0));
    }
    cdeNMI.Vector2Distance = Vector2Distance;
    function Vector2GetAngle(c, f) {
        return (180.0 * (1.0 + (Math.atan2(c.y - f.y, c.x - f.x) / Math.PI)));
    }
    cdeNMI.Vector2GetAngle = Vector2GetAngle;
    function GetSizeFromTile(pTile, pDelta) {
        pTile = Math.floor(pTile);
        if (!pTile || pTile === 0)
            return 0;
        return (cde.MyBaseAssets.MyServiceHostInfo.TileSize * pTile);
    }
    cdeNMI.GetSizeFromTile = GetSizeFromTile;
    function NotifyHost(pText) {
        if (window.external) {
            try {
                const tWin = window;
                if (tWin.external.notify)
                    tWin.external.notify(pText);
            }
            catch (e) {
                if (cdeNMI.MyPopUp)
                    cdeNMI.MyPopUp.Show("Error: " + e, true);
            }
        }
    }
    cdeNMI.NotifyHost = NotifyHost;
    function UnselectAllControls() {
        const allSelected = document.getElementsByClassName("cde-is-selected");
        for (const element of allSelected) {
            element.classList.remove("cde-is-selected");
        }
    }
    cdeNMI.UnselectAllControls = UnselectAllControls;
    function GetControlFromPoint(x, y) {
        let element;
        const elements = [];
        let tResControl = null;
        const oldVisibility = [];
        while (true) {
            element = document.elementFromPoint(x, y);
            if (!element || element === document.documentElement) {
                break;
            }
            if (element.getAttribute("cdesel") && !tResControl) {
                const myNmiControl = cdeNMI.MyTCF.GetRegisteredControlGroup(element.getAttribute("cdemid"));
                for (const tInfo in myNmiControl) {
                    if (myNmiControl.hasOwnProperty(tInfo)) {
                        tResControl = myNmiControl[tInfo];
                        break;
                    }
                }
            }
            elements.push(element);
            oldVisibility.push(element.style.visibility);
            element.style.visibility = 'hidden'; // Temporarily hide the element (without changing the layout)
        }
        for (let k = 0; k < elements.length; k++) {
            elements[k].style.visibility = oldVisibility[k];
        }
        return tResControl;
    }
    cdeNMI.GetControlFromPoint = GetControlFromPoint;
    function GetAllElementsFromPoint(x, y) {
        let element;
        const elements = [];
        const oldVisibility = [];
        while (true) {
            element = document.elementFromPoint(x, y);
            if (!element || element === document.documentElement) {
                break;
            }
            elements.push(element);
            oldVisibility.push(element.style.visibility);
            element.style.visibility = 'hidden'; // Temporarily hide the element (without changing the layout)
        }
        for (let k = 0; k < elements.length; k++) {
            elements[k].style.visibility = oldVisibility[k];
        }
        elements.reverse();
        return elements;
    }
    cdeNMI.GetAllElementsFromPoint = GetAllElementsFromPoint;
    function focusNextElement(goBack) {
        const focussableElements = 'a:not([disabled]), button:not([disabled]), input[type=text]:not([disabled]), [tabindex]:not([disabled]):not([tabindex="-1"])';
        const focussable = Array.prototype.filter.call(document.querySelectorAll(focussableElements), function (element) {
            return element.offsetWidth > 0 || element.offsetHeight > 0 || element === document.activeElement;
        });
        const index = focussable.indexOf(document.activeElement);
        if (index > -1) {
            if (goBack === true) {
                const nextElement = focussable[index - 1] || focussable[0];
                nextElement.focus();
            }
            else {
                const nextElement = focussable[index + 1] || focussable[0];
                nextElement.focus();
            }
        }
        else {
            focussable[0].focus();
        }
    }
    cdeNMI.focusNextElement = focusNextElement;
})(cdeNMI || (cdeNMI = {}));
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
var cdeNMI;
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
(function (cdeNMI) {
    //////////////////////////////////////////////////////////////////////////////
    /// The NMI Base Service Engine
    //////////////////////////////////////////////////////////////////////////////
    class TheNMIServiceBase extends cde.TheThing {
        constructor() {
            super();
            this.MyBaseEngine = null;
            this.IsConnectedAndReady = false;
            this.MyNMIIncomingEvents = []; //Not needed in Local...can we drop this????
            this.MetaRequested = [];
            this.DataToFetch = new Array();
            this.DataFetching = new Array(); //Should be emtpied if Fetch was successful
            this.MyLazyTableCallbacks = [];
            this.MyBaseEngine = cde.StartNewEngine(cdeNMI.eTheNMIEngine);
            cde.MyBaseAssets.RegisterEvent("OnStringEvent", (sender, tJS, TargetControl, Parameter, PropertyName, params) => { this.OnStringEvent(tJS, TargetControl, Parameter, PropertyName, params); });
        }
        GetBaseEngine() {
            return this.MyBaseEngine;
        }
        RegisterIncomingMsg(pCtrl, pID, pEng) {
            if (!pCtrl)
                return;
            if (!pEng)
                pEng = cdeNMI.eTheNMIEngine;
            const tEngs = pEng.split(";");
            for (let i = 0; i < tEngs.length; i++) {
                if (!this.MyNMIIncomingEvents[tEngs[i]])
                    this.MyNMIIncomingEvents[tEngs[i]] = [];
                this.MyNMIIncomingEvents[tEngs[i]][pID] = pCtrl;
            }
        }
        RequestEngineStatus() {
            this.FireEvent(true, "CDE_SETSTATUSMSG", "BaseEngine is ready", 1);
        }
        OnStringEvent(tJS, TargetControl, Parameter, PropertyName, params) {
            if (tJS.startsWith("jsAction:")) {
                const pDashType = tJS.split(':');
                if (pDashType.length < 2)
                    return;
                switch (pDashType[1]) {
                    case "PTS":
                        {
                            if (pDashType.length < 4)
                                return;
                            let tPLS = "";
                            if (pDashType.length > 4)
                                tPLS = pDashType[4];
                            if (cde.MyCommChannel)
                                cde.MyCommChannel.SendQueued("", pDashType[2], pDashType[2], pDashType[3], tPLS, 0, 5, 3, "");
                            if (pDashType.length > 5)
                                cdeNMI.ShowToastMessage(pDashType[5]);
                        }
                        return;
                    case "GS":
                        if (pDashType.length < 3)
                            return;
                        if (cdeNMI.MyEngine)
                            cdeNMI.MyEngine.GetScene(pDashType[2]);
                        return;
                    case "POP":
                        if (pDashType.length < 3)
                            return;
                        if (cdeNMI.MyPopUp)
                            cdeNMI.MyPopUp.Show(pDashType[2], true);
                        return;
                    case "TOAST":
                        if (pDashType.length < 3)
                            return;
                        if (cdeNMI.MyToast)
                            cdeNMI.MyToast.ShowToastMessage(pDashType[2]);
                        return;
                    case "TTS":
                        if (pDashType.length < 3)
                            return;
                        if (cdeNMI.MyScreenManager)
                            cdeNMI.MyScreenManager.TransitToScreen(pDashType[2], true);
                        return;
                    case "CFU":
                        if (cdeNMI.MyEngine)
                            cdeNMI.MyEngine.CheckForUpdates();
                        return;
                    default:
                        tJS = pDashType[1];
                        break;
                }
            }
            if (tJS.startsWith("TTS:")) {
                if (cdeNMI.MyScreenManager) {
                    const tScrParts = tJS.split(':');
                    if (tScrParts[1] === "CLOSE") {
                        const tLast = cdeNMI.MyScreenManager.GetCurrentScreen();
                        if (tLast) {
                            const tOld = tLast.GetProperty("OldScreen");
                            if (tOld)
                                cdeNMI.MyScreenManager.TransitToScreen(tOld);
                        }
                    }
                    else {
                        cdeNMI.MyScreenManager.TransitToScreen(cde.GuidToString(tScrParts[1]), true, false, tScrParts.length > 2 ? tScrParts[2] : null);
                    }
                }
                return;
            }
            else if (tJS.startsWith("GRP:")) {
                cdeNMI.MyTCF.ToggleGroup(TargetControl.MyFormID, tJS.substr(4));
                return;
            }
            else if (tJS.startsWith("PTOT:")) {
                if (!cde.MyCommChannel)
                    return;
                const tPa = tJS.substr(5).split(';:;');
                if (tPa.length < 6)
                    return;
                if (tPa[0].length === 0 || PropertyName === tPa[0]) {
                    let tID = TargetControl.GetProperty('MID');
                    if (!tID)
                        tID = TargetControl.GetProperty('ID');
                    cde.MyCommChannel.SendQueued(tPa[1], tPa[2], tPa[2], tPa[3] + ':' + tID + ':' + tPa[4], Parameter + ':' + tPa[4] + ':' + (TargetControl.MyTRF && TargetControl.MyTRF.RowID ? TargetControl.MyTRF.RowID : 0), 8, 5, 3, TargetControl.MyTRF ? TargetControl.MyTRF.GetNodeID() : tPa[5]);
                }
                return;
            }
            else if (tJS.startsWith("PTOR:")) {
                if (!cde.MyCommChannel)
                    return;
                const tPa = tJS.substr(5).split(';:;');
                if (tPa.length < 6)
                    return;
                if (tPa[0].length === 0 || PropertyName === tPa[0]) {
                    let tID = TargetControl.GetProperty('MID');
                    if (!tID)
                        tID = TargetControl.GetProperty('ID');
                    cde.MyCommChannel.SendQueued(TargetControl.MyTRF ? TargetControl.MyTRF.GetMID() : tPa[1], tPa[2], tPa[2], tPa[3] + ':' + tID + ':' + tPa[4], Parameter, // + ':' + tPa[4] + ':' + (TargetControl.MyTRF && TargetControl.MyTRF.RowID ? TargetControl.MyTRF.RowID : 0),
                    8, 5, 3, TargetControl.MyTRF ? TargetControl.MyTRF.GetNodeID() : tPa[5]);
                }
                return;
            }
            else if (tJS.startsWith("SEV:")) {
                const tProp = tJS.substr(4);
                let ti = "";
                if (tProp === "Value")
                    ti = "i";
                if (PropertyName === tProp)
                    TargetControl.SetProperty(ti + "Value", Parameter);
                return;
            }
            else if (tJS.startsWith("if (PropertyName==")) {
                if (tJS.indexOf("PublishToOwner") < 0) {
                    const tProp = cdeNMI.GetStringSegment(tJS, "'", "'");
                    let ti = "";
                    if (tProp === "Value")
                        ti = "i";
                    if (PropertyName === tProp)
                        TargetControl.SetProperty(ti + "Value", Parameter);
                    return;
                }
            }
            else if (tJS.startsWith("MyNMID:")) {
                const tPa = tJS.substr(7).split(';:;');
                if (tPa.length < 2)
                    return;
                cdeNMI.MyNMID[tPa[0]].SetProperty(tPa[1], Parameter);
                return;
            }
            if (cde.MyBaseAssets.MyServiceHostInfo.DebugLevel > 0)
                cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "FireEvent:EVAL", "UPDATE Plugin! eval() will be dropped in the future! Code: " + tJS);
            eval(tJS); //NOSONAR known and will be removed in a future version
        }
        //////////////////////////////////////////////////////////////////////////////
        /// NMI Data Fetcher
        //////////////////////////////////////////////////////////////////////////////
        AddDataToFetch(pToFetch) {
            if (!this.HasDataToFetch(pToFetch))
                this.DataToFetch.push(pToFetch);
        }
        HasDataToFetch(pToFetch) {
            return cdeNMI.DoesArrayContain(this.DataToFetch, pToFetch);
        }
        CheckDataToFetch(pScreenID) {
            if (!pScreenID)
                return;
            pScreenID = cde.GuidToString(pScreenID);
            const tScreen = cdeNMI.MyScreenManager ? cdeNMI.MyScreenManager.GetScreenByID(pScreenID) : null;
            let HasFound = (tScreen && tScreen.GetInitialized());
            if (!HasFound) {
                if (this.DataToFetch.length > 0) {
                    for (let i = 0; i < this.DataToFetch.length; i++) {
                        const tParts = this.DataToFetch[i].split(':');
                        if (cdeNMI.DoesArrayContain(this.DataFetching, cde.GuidToString(tParts[0])))
                            continue;
                        if (cde.GuidToString(tParts[0]) === pScreenID) {
                            if (!cdeNMI.MyTCF.IsControlNameKnown(tParts[1])) {
                                if (!cde.MyBaseAssets.MyEngines[tParts[1]])
                                    cde.StartNewEngine(tParts[1]);
                            }
                            this.PublishToNodeGET_NMI_DATA(this.DataToFetch[i]);
                            this.DataFetching.push(pScreenID);
                            this.DataToFetch.splice(i, 1);
                            HasFound = true;
                            break;
                        }
                    }
                }
            }
            if (!HasFound) {
                if (this.DataFetching.length > 0) {
                    for (let i = 0; i < this.DataFetching.length; i++) {
                        if (this.DataFetching[i] === pScreenID) {
                            HasFound = true;
                            break;
                        }
                    }
                }
                if (!HasFound) {
                    const tNF = pScreenID + ':auto:' + pScreenID;
                    this.DataToFetch.push(tNF);
                    this.CheckDataToFetch(pScreenID);
                }
            }
        }
        PublishToNodeGET_NMI_DATA(pRes) {
        }
        //////////////////////////////////////////////////////////////////////////////
        /// NMI Lazy Table Loader
        //////////////////////////////////////////////////////////////////////////////
        FireLazyLoaded(pScreenID, pTableName, pMirror) {
            if (!pScreenID || !pTableName || !this.MyLazyTableCallbacks[pScreenID + ',' + pTableName])
                return;
            for (let mh = 0; mh < this.MyLazyTableCallbacks[pScreenID + ',' + pTableName].length; mh++) {
                if (this.MyLazyTableCallbacks[pScreenID + ',' + pTableName][mh].CallBack) {
                    this.MyLazyTableCallbacks[pScreenID + ',' + pTableName][mh].CallBack(pMirror, this.MyLazyTableCallbacks[pScreenID + ',' + pTableName][mh].Cookie);
                }
            }
        }
        UnregisterLazyLoader(pScreenID, pTableName, pCallback) {
            if (!this.MyLazyTableCallbacks[pScreenID + ',' + pTableName])
                return;
            for (let mh = 0; mh < this.MyLazyTableCallbacks[pScreenID + ',' + pTableName].length; mh++) {
                if (this.MyLazyTableCallbacks[pScreenID + ',' + pTableName][mh].CallBack === pCallback) {
                    this.MyLazyTableCallbacks[pScreenID + ',' + pTableName].splice(mh, 1);
                    return;
                }
            }
        }
        LoadTableLazy(pScreenID, pTableName, pCallback, cookie) {
            if (!pCallback || !pScreenID || !pTableName)
                return;
            if (cdeNMI.MyNMIModels[pScreenID] && cdeNMI.MyNMIModels[pScreenID].MyStorageMirror[pTableName]) {
                pCallback(cdeNMI.MyNMIModels[pScreenID].MyStorageMirror[pTableName], cookie);
            }
            else
                pCallback(null, cookie);
            if (!this.MyLazyTableCallbacks[pScreenID + ',' + pTableName]) {
                this.MyLazyTableCallbacks[pScreenID + ',' + pTableName] = [];
            }
            this.MyLazyTableCallbacks[pScreenID + ',' + pTableName].push({ ScreenID: pScreenID, TableName: pTableName, CallBack: pCallback, Cookie: cookie });
        }
        //////////////////////////////////////////////////////////////////////////////
        /// NMI Global Scripts Management
        //////////////////////////////////////////////////////////////////////////////
        cdeGetScript(pScriptName, pCallBack = null, cookie = null, pTimeout = 0, pScriptType = null) {
        }
        cdeGetStyle(pResource, pCallBack = null, cookie = null, pTimeout) {
        }
        cdeGetResource(pResource, pCallBack, cookie = null, pTimeout) {
        }
        cdeGetImage(pResource, pCallBack, cookie = null, pTimeout) {
        }
        PublishToNMI(pCommand, pPayload, pTargetNode) {
        }
        CheckForUpdates() {
        }
        GetScreenMeta(pGuid, pForceLoad) {
            return false;
        }
        GetScene(sceneID) {
        }
        IsNodeDown(pNodeID) {
            return false;
        }
        GetKnownNodeName(pNodeID) {
            return "";
        }
        RegisterKnownNode(pNodeID, pNodeName) {
        }
        RequestReloadModel(pModelID) {
            this.MetaRequested[cde.GuidToString(pModelID)] = false;
        }
        ValidateUID(pUID) {
            if (!cdeNMI.Check4ValidEmail(pUID))
                return "eMail invalid! Please enter a valid eMail address";
            return null;
        }
        Login(pTarget, pUID, pPWD, pPlatform) {
            if (!cde.MyCommChannel)
                return;
            if (pTarget) {
                if (cde.MyCommChannel.SetTargetRelay(pTarget))
                    cde.MyCommChannel.StartCommunication();
                else
                    return;
            }
            if (pPlatform) {
                cde.MyBaseAssets.MyServiceHostInfo.WebPlatform = pPlatform;
                this.FireEvent(false, "CDE_SETPLATFORM", pPlatform);
            }
            if (cde.MyBaseAssets.MyServiceHostInfo.IsUsingUserMapper && !cde.MyBaseAssets.MyServiceHostInfo.EnablePinLogin) {
                cde.MyCommChannel.Login({ QPWD: pPWD, QUID: pUID, QToken: null });
            }
            else {
                cde.MyCommChannel.Login({ QPWD: pUID, QUID: null, QToken: null });
            }
        }
        SelectMesh(pTargetMesh) {
            cde.MyCommChannel.SelectMesh(pTargetMesh);
        }
        BaseOnHandleMessage(pProcessMessage) {
            const pMSG = pProcessMessage.Message;
            if (!pMSG)
                return true;
            if (pProcessMessage.Topic === "NMI_ERROR") {
                if (cdeNMI.MyPopUp)
                    cdeNMI.MyPopUp.Show(pMSG.PLS, true, null, 1, () => { document.location.reload(); });
                return true;
            }
            if (pProcessMessage.Topic === "NMI_INFO") {
                if (cdeNMI.MyPopUp)
                    cdeNMI.MyPopUp.Show(pMSG.PLS, true);
                return true;
            }
            if (pProcessMessage.Topic === "NMI_TOAST" || pMSG.TXT.endsWith(":ERR")) {
                if (cdeNMI.MyToast)
                    cdeNMI.MyToast.ShowToastMessage(pMSG.TXT, pMSG.PLS);
                return true;
            }
            if (pProcessMessage.Topic === "NMI_ALERT") {
                const tCmd = pMSG.TXT.split(':;:');
                if (cdeNMI.MyToast)
                    cdeNMI.MyToast.ShowToastMessage("ALERT", pMSG.PLS, tCmd.length > 1 ? cde.CInt(tCmd[1]) : 0);
                return true;
            }
            const tCmd = pMSG.TXT.split(':');
            let tModel;
            switch (tCmd[0]) {
                case "NMI_ERROR":
                    if (cdeNMI.MyPopUp)
                        cdeNMI.MyPopUp.Show(pMSG.PLS, true, null, 1);
                    return true;
                case "NMI_INFO":
                    if (cdeNMI.MyPopUp)
                        cdeNMI.MyPopUp.Show(pMSG.PLS, true);
                    return true;
                case "NMI_TOAST":
                    if (cdeNMI.MyToast)
                        cdeNMI.MyToast.ShowToastMessage(pMSG.PLS);
                    return true;
                case "NMI_ALERT":
                    if (cdeNMI.MyToast)
                        cdeNMI.MyToast.ShowToastMessage("Alert!", pMSG.PLS, tCmd.length > 1 ? cde.CInt(tCmd[1]) : 15000);
                    return true;
                case "NMI_AUDIO":
                    {
                        const audio = new Audio(cde.MyBaseAssets.MyCommStatus.MyServiceUrl + "/" + pMSG.PLS);
                        audio.play();
                    }
                    return true;
                case "NMI_TALK":
                    {
                        const tP = tCmd;
                        cdeSpeech.talk(pMSG.PLS, tP.length > 1 ? tP[1] : "en", tP.length > 2 ? cde.CInt(tP[2]) : 0);
                    }
                    return true;
                case "NMI_RESET":
                    if (tCmd.length > 1) {
                        if (cdeNMI.MyPopUp)
                            cdeNMI.MyPopUp.Show(pMSG.PLS, true);
                    }
                    else {
                        window.location.reload();
                    }
                    return true;
                case "NMI_REFRESH_META":
                    if (cdeNMI.MyScreenManager) {
                        if (cdeNMI.MyEngine)
                            cdeNMI.MyEngine.RequestReloadModel(cde.MyBaseAssets.MyServiceHostInfo.PortalScreen);
                        cdeNMI.MyScreenManager.RequestPortalScreen(true);
                    }
                    return true;
                case "NMI_GS":
                    if (cdeNMI.MyEngine)
                        cdeNMI.MyEngine.GetScene(pMSG.PLS);
                    return true;
                case "NMI_TTS":
                    if (cdeNMI.MyScreenManager) {
                        cdeNMI.MyScreenManager.ClearScenes();
                        cdeNMI.MyScreenManager.TransitToScreen(pMSG.PLS, true);
                    }
                    return true;
                case "NMI_LIVESCREENMETA":
                    if (pMSG.PLS) {
                        tModel = JSON.parse(pMSG.PLS);
                        if (!tModel)
                            break;
                        if (cdeNMI.MyScreenManager)
                            cdeNMI.MyScreenManager.CreateLiveScreen(tModel);
                    }
                    break;
                case "NMI_REQ_DASH":
                    if (pMSG.PLS) {
                        this.PublishToNodeGET_NMI_DATA(pMSG.PLS);
                    }
                    return true;
                case "NMI_NODEPONG":
                    return true;
                case "NMI_THEME":
                    if (pMSG.PLS) {
                        cde.MyBaseAssets.MyServiceHostInfo.IsLiteTheme = cde.CBool(pMSG.PLS);
                        cdeNMI.ApplyTheme();
                    }
                    return true;
                case "NMI_SCREENMETA":
                    if (pMSG.PLS) {
                        if (typeof pMSG.PLS === 'string')
                            tModel = JSON.parse(pMSG.PLS);
                        else
                            tModel = pMSG.PLS;
                        if (!tModel)
                            break;
                        this.RegisterKnownNode(tModel.cdeN, tModel.NodeName);
                        if (cdeNMI.MyScreenManager) {
                            cdeNMI.MyScreenManager.CreateDashboard(tModel, (tCmd.length > 1 ? "ScreenGuid=" + tCmd[1] : null));
                        }
                    }
                    break;
                case "NMI_CUSTOM_SCRIPT":
                    if (pMSG.PLS && tCmd.length > 1 && cdeNMI.MyScreenManager) {
                        cdeNMI.MyScreenManager.CreateScriptScreen(tCmd[1], pMSG.PLS);
                    }
                    break;
                case "NMI_ENGINEJS":
                    if (pMSG.PLS && tCmd.length > 1) {
                        cdeNMI.RegisterEvent("EngineReady", (a) => {
                            if (a === tCmd[1])
                                cdeNMI.MyTCF.FireLazyCreate(a);
                        });
                        if (!cde.MyBaseAssets.MyEngines[tCmd[1]]) {
                            cde.CreateScriptInRoot(tCmd[1], pMSG.PLS);
                            cde.StartNewEngine(tCmd[1]);
                            try {
                                cde.cdeEval(tCmd[1] + ".StartEngine()");
                            }
                            catch (error) {
                                cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "NMIServiceBase:HandleEvent", "NMI_ENGINEJS:" + error + "<br>" + error.stack);
                            }
                        }
                    }
                    break;
                case "NMI_CUSTOM_HTML":
                    if (pMSG.PLS && tCmd.length > 1 && cdeNMI.MyScreenManager) {
                        cdeNMI.MyScreenManager.CreateHTMLScreen(tCmd[1], pMSG.PLS);
                    }
                    break;
                case "NMI_CUSTOM_CSS":
                    if (pMSG.PLS) {
                        const tCSS = pMSG.PLS.split(';');
                        cde.AddCSSToHeader(tCSS[0], tCSS.length > 1 ? tCSS[1] : null);
                    }
                    break;
                case "NMI_UPD_DATA_RET":
                    {
                        if (tCmd.length < 2 || tCmd[2] === "ERR")
                            if (cdeNMI.MyPopUp)
                                cdeNMI.MyPopUp.Show('There was an error processing your request: ' + pMSG.PLS, true);
                            else {
                                let tModelMid = "";
                                if (tCmd.length > 2 && tCmd[2] !== "")
                                    tModelMid = cde.GuidToString(tCmd[2]);
                                else
                                    tModelMid = cde.GuidToString(cde.MyBaseAssets.MyServiceHostInfo.PortalScreen);
                                tModel = cdeNMI.MyNMIModels[tModelMid];
                                if (!tModel)
                                    return true;
                                if (!tModel.MyStorageMirror)
                                    tModel.MyStorageMirror = [];
                                const tTableGuid = cde.GuidToString(tCmd[1]);
                                const tRecord = JSON.parse(pMSG.PLS);
                                if (tModel.MyStorageMirror[tTableGuid] && tModel.MyStorageMirror[tTableGuid].length > 0) {
                                    for (let tRowNo = 0; tRowNo < tModel.MyStorageMirror[tTableGuid].length; tRowNo++) {
                                        if (tModel.MyStorageMeta[tTableGuid].IsAlwaysEmpty || tModel.MyStorageMirror[tTableGuid][tRowNo].cdeMID === tRecord.cdeMID) {
                                            tModel.MyStorageMirror[tTableGuid][tRowNo] = tRecord;
                                            this.FireEvent(false, "RecordUpdated_" + tTableGuid + "_" + tRowNo, tModelMid, tTableGuid, tRowNo);
                                            break;
                                        }
                                    }
                                }
                                else {
                                    if (tModel.MyStorageMirror[tTableGuid])
                                        tModel.MyStorageMirror[tTableGuid][0] = tRecord;
                                }
                            }
                    }
                    break;
                case "NMI_SET_SCENE":
                    if (cdeNMI.MyScreenManager) {
                        cdeNMI.MyScreenManager.SetView(JSON.parse(pMSG.PLS), true);
                    }
                    break;
                case "NMI_SET_DATA":
                    if (tCmd.length < 2 || tCmd[2] === "ERR") {
                        if (cdeNMI.MyPopUp)
                            cdeNMI.MyPopUp.Show('There was an error processing your request: ' + pMSG.PLS, true);
                    }
                    else {
                        if (tCmd.length > 2 && tCmd[2] !== "") {
                            tModel = cdeNMI.MyNMIModels[cde.GuidToString(tCmd[2])];
                            if (!tModel) {
                                //TODO: Decide what to do: either request Model or quit!
                                cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "TheNMIService:OnHandleMessage", "Model not found for " + tCmd[2]);
                                return true;
                            }
                            if (!tModel.MyStorageMirror)
                                tModel.MyStorageMirror = [];
                        }
                        else
                            tModel = cdeNMI.MyNMIModels[cde.GuidToString(cde.MyBaseAssets.MyServiceHostInfo.PortalScreen)];
                        if (tModel) {
                            const tTableName = cde.GuidToString(tCmd[1]);
                            if (cdeNMI.MyScreenManager)
                                cdeNMI.MyScreenManager.CreateDataViewScreen(tModel, pMSG, tTableName, pMSG.TXT, tCmd.length > 3 ? tCmd[3] : null, (tCmd.length > 6 && tCmd[6] === 'true') || (tCmd.length === 5 && tCmd[4] === 'true'));
                        }
                    }
                    break;
                case "NMI_SCOPID":
                    cde.MyBaseAssets.MyServiceHostInfo.DoesRequireConfiguration = false;
                    if (cdeNMI.MyPopUp)
                        cdeNMI.MyPopUp.Show('Your new Security ID is: ' + pMSG.PLS + '</br>Please write it down in a secure place.</br>You will need this ID for any secondary relays or agents that want to talk to this relay', true, null, 0, this.sinkScopeIDSet);
                    return true;
                default:
                    this.FireEvent(true, tCmd[0], pMSG);
                    break;
            }
            return false;
        }
        sinkScopeIDSet() {
            if (cdeNMI.MyScreenManager)
                cdeNMI.MyScreenManager.TransitToScreen(cde.MyBaseAssets.MyServiceHostInfo.PortalScreen);
        }
        ///BackCompat Requirements
        static cdeGetScript(pName, pCallback, pCookie, pTimeOut, pType) {
            cdeNMI.MyEngine.cdeGetScript(pName, pCallback, pCookie, pTimeOut, pType);
        }
        static cdeGetStyle(pResource, pCallBack = null, cookie = null) {
            cdeNMI.MyEngine.cdeGetStyle(pResource, pCallBack, cookie);
        }
    }
    TheNMIServiceBase.MyNMISettings = cdeNMI.MyNMISettings;
    cdeNMI.TheNMIServiceBase = TheNMIServiceBase;
})(cdeNMI || (cdeNMI = {}));
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
var cdeNMI;
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
(function (cdeNMI) {
    //////////////////////////////////////////////////////////////////////////////
    /// The NMI Base Service Engine
    //////////////////////////////////////////////////////////////////////////////
    class TheNMIServiceLocal extends cdeNMI.TheNMIServiceBase {
        static StartEngine() {
            cdeNMI.MyEngine = new TheNMIServiceLocal();
            cdeNMI.MyEngine.IsConnectedAndReady = true;
            cdeNMI.MyEngine.GetBaseEngine().EngineState.IsInitialized = true;
            cdeNMI.MyEngine.GetBaseEngine().FireEngineIsReady(true);
        }
        constructor() {
            super();
        }
        ValidateUID(pUID) {
            if (pUID && pUID.length > 2)
                return null;
            return "Wrong Username!";
        }
        Login(pTarget, pUID, pPWD, pPlatform) {
            if (pUID === "nmi") {
                cde.MyBaseAssets.MyCommStatus.UserPref = new cde.TheUserPreferences(); //We could set some values here 
                this.FireEvent(true, "CDE_LOGIN_EVENT", true);
            }
            else
                this.FireEvent(true, "CDE_LOGIN_EVENT", false, "Login failed! unknown credentials");
        }
        RequestEngineStatus() {
            this.FireEvent(true, "CDE_SETSTATUSMSG", "Local-Engine Provider ready", 1);
        }
        //////////////////////////////////////////////////////////////////////////////
        /// NMI Global Scripts Management
        //////////////////////////////////////////////////////////////////////////////
        cdeGetScript(pScriptName, pCallBack = null, cookie = null, pTimeout = 0, pType = null) {
            if (!pScriptName)
                return;
            fetch("/ClientBin/Scripts/" + pScriptName).then(d => {
                if (d.ok) {
                    d.text().then(txt => {
                        const s = document.createElement('script');
                        const prior = document.getElementsByTagName('script')[0];
                        if (pType)
                            s.type = pType;
                        else
                            s.type = "text/javascript";
                        s.text = txt.replace(String.fromCharCode(65279), '');
                        prior.parentNode.insertBefore(s, prior);
                        pCallBack(cookie, txt);
                    });
                }
            });
        }
        cdeGetStyle(pResource, pCallBack = null, cookie = null, pTimeout = 0) {
            if (!pResource)
                return;
            fetch("/ClientBin/CSS/" + pResource).then(d => {
                if (d.ok) {
                    d.text().then(txt => {
                        const css = document.createElement('style');
                        css.type = 'text/css';
                        if (css.styleSheet)
                            css.styleSheet.cssText = txt.replace(String.fromCharCode(65279), '');
                        else
                            css.appendChild(document.createTextNode(txt.replace(String.fromCharCode(65279), '')));
                        document.getElementsByTagName("head")[0].appendChild(css);
                        pCallBack(cookie, txt);
                    });
                }
            });
        }
        PublishToNodeGET_NMI_DATA(pRes) {
            const tParts = pRes.split(':');
            fetch("/ClientBin/JSON/" + tParts[0] + ".JSON").then(d => {
                if (d.ok) {
                    d.json().then(tJSon => {
                        this.OnHandleMessage(tJSon);
                    });
                }
            });
        }
        cdeGetResource(pResource, pCallBack, cookie = null, pTimeout = 0) {
            if (!pResource)
                return;
            fetch("/ClientBin/" + pResource).then(d => {
                if (d.ok) {
                    d.text().then(txt => {
                        pCallBack(cookie, txt);
                    });
                }
                else {
                    pCallBack(cookie, "ERR:" + d.statusText);
                }
            });
        }
        cdeGetImage(pResource, pCallBack, cookie = null, pTimeout = 0) {
            if (!pResource)
                return;
            fetch("/ClientBin/" + pResource).then(d => {
                if (d.ok) {
                    d.text().then(txt => {
                        pCallBack(cookie, txt);
                    });
                }
                else {
                    pCallBack(cookie, "ERR:" + d.statusText);
                }
            });
        }
        GetScreenMeta(pGuid, pForceLoad) {
            this.PublishToNodeGET_NMI_DATA(pGuid);
            return false;
        }
        OnHandleMessage(pProcessMessage) {
            const pMSG = pProcessMessage.Message;
            if (!pMSG)
                return;
            if (super.BaseOnHandleMessage(pProcessMessage))
                return;
            if (cdeNMI.MyScreenManager) {
                cdeNMI.MyScreenManager.ShowView();
            }
        }
    }
    cdeNMI.TheNMIServiceLocal = TheNMIServiceLocal;
})(cdeNMI || (cdeNMI = {}));
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
var cdeNMI;
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
(function (cdeNMI) {
    //////////////////////////////////////////////////////////////////////////////
    /// The NMI Base Service Engine
    //////////////////////////////////////////////////////////////////////////////
    class TheNMIService extends cdeNMI.TheNMIServiceBase {
        constructor() {
            super();
            this.mLastStatus = "NMI-Engine is starting...";
            this.mLastState = 0;
            this.AreEnginesRequested = false;
            this.MyKnownNodes = new Array();
            this.MyPingTimer = null;
            this.MyGlobalResources = [];
            this.MyBaseEngine.RegisterEvent("IncomingMessage", (pSender, pProcessMessage) => { this.OnHandleMessage(pProcessMessage); });
        }
        static StartEngine() {
            const tEngine = new TheNMIService();
            cdeNMI.MyEngine = tEngine;
            tEngine.MyPingTimer = setInterval(() => {
                if (Object.keys(tEngine.MyKnownNodes).length === 0)
                    return;
                const tNow = (new Date()).getTime();
                for (const mh in tEngine.MyKnownNodes) {
                    //if (tNow - tEngine.MyKnownNodes[mh].LastPing > 30000)
                    cdeNMI.MyEngine.PublishToNMI("NMI_NODEPING", cde.MyBaseAssets.MyServiceHostInfo.UPref, mh);
                    if (tEngine.MyKnownNodes[mh].IsDown !== true && tNow - tEngine.MyKnownNodes[mh].LastPing > 60000) {
                        tEngine.MyKnownNodes[mh].IsDown = true;
                        cdeNMI.MyScreenManager.UpdateScreenStatus(mh, true);
                    }
                }
            }, 10000);
            window.addEventListener("message", (e) => {
                try {
                    if (e.origin !== "") //NOSONAR: Must check with NMI Viewer app that uses this
                        return;
                    if (!e.data)
                        return;
                    //let res = e.data;
                    const cred = e.data.split(';:;');
                    switch (cred[0]) { //TODO: V4.109: Security Review: can we control this by the Relay? Reflect all to Relay?
                        case "APPLOG":
                            if (cred.length > 2) {
                                cdeNMI.MyEngine.Login(cred[1], cred[2]);
                                //res = "Done";
                            }
                            break;
                    }
                    if (e.data.startsWith("OK:"))
                        return;
                    //const tText: string = cde.CStr(e.data);
                    //const tOrig: string = cde.CStr(e.origin);
                    //e.source.postMessage("OK:" + tText, tOrig); //TODO: 4.109: Why does this not work??
                }
                catch (_a) {
                    // ignored
                }
            }, false);
            if (cde.MyCommChannel) {
                cde.MyCommChannel.RegisterEvent("CDE_SETSTATUSMSG", (s, m, st) => { tEngine.sinkStatus(m, st); });
                cde.MyCommChannel.RegisterEvent("CDE_LOGIN_EVENT", (s, l, r, p) => { tEngine.sinkLogin(l, r, p); });
                cde.MyCommChannel.RegisterEvent("CDE_INCOMING_MSG", (s, p) => { tEngine.FireIncoming(p); });
                cde.MyCommChannel.RegisterEvent("CDE_SELECT_MESH", (s, p) => { tEngine.RequestSelectMesh(p); });
                cde.MyBaseAssets.MyEngines[cdeNMI.eTheNMIEngine].SendInitialize();
            }
            else {
                tEngine.GetBaseEngine().FireEngineIsReady(true);
            }
        }
        sinkStatus(pStatus, pLevel) {
            this.mLastStatus = pStatus;
            this.mLastState = pLevel;
            this.FireEvent(true, "CDE_SETSTATUSMSG", pStatus, pLevel);
        }
        sinkLogin(bIsLoggedIn, pReason, pUserPref) {
            this.FireEvent(true, "CDE_LOGIN_EVENT", bIsLoggedIn, pReason, pUserPref);
        }
        RequestEngineStatus() {
            this.FireEvent(true, "CDE_SETSTATUSMSG", this.mLastStatus, this.mLastState);
        }
        RequestSelectMesh(pMeshes) {
            this.FireEvent(true, "CDE_SELECT_MESH", pMeshes);
        }
        AddToGlobalScripts(pRes) {
            if (!pRes)
                return;
            this.MyGlobalResources.push(pRes);
            if (pRes.Timeout && pRes.Timeout > 0) {
                pRes.TimeoutHandler = setTimeout(() => {
                    pRes.Resource = "TIMEOUT";
                    TheNMIService.FireCallbacks(pRes);
                }, pRes.Timeout);
            }
        }
        PublishToNodeGET_NMI_DATA(pRes) {
            this.PublishToNMI('NMI_GET_DATA:' + pRes);
        }
        //////////////////////////////////////////////////////////////////////////////
        /// NMI Global Scripts Management
        //////////////////////////////////////////////////////////////////////////////
        PublishToNMI(pCommand, pPayload, pTargetNode, bNodeIsOwner) {
            if (pTargetNode) {
                if (bNodeIsOwner === true)
                    this.GetBaseEngine().PublishToOwner(pTargetNode, pCommand, pPayload);
                else
                    this.GetBaseEngine().PublishToNode(pTargetNode, pCommand, pPayload);
            }
            else
                this.GetBaseEngine().PublishToService(pCommand, pPayload);
        }
        cdeGetScript(pScriptName, pCallBack = null, cookie = null, pTimeout = 0, scriptType = null) {
            if (!pScriptName)
                return;
            for (let mh = 0; mh < this.MyGlobalResources.length; mh++) {
                if (this.MyGlobalResources[mh].ResourceName === pScriptName) {
                    if (this.MyGlobalResources[mh].IsCreated === true && pCallBack)
                        pCallBack(this.MyGlobalResources[mh].Cookie, this.MyGlobalResources[mh].Resource);
                    return;
                }
            }
            if (pCallBack) {
                const t = { ResourceName: pScriptName, CallBacks: [], Cookie: cookie, IsCreated: false, Resource: null, Timeout: pTimeout, ResourceType: scriptType };
                t.CallBacks.push(pCallBack);
                this.AddToGlobalScripts(t);
            }
            this.GetBaseEngine().PublishToService("NMI_GET_GLOBAL_SCRIPT", pScriptName);
        }
        CreateGlobalScript(pScriptName, pScript) {
            let mh = 0;
            for (mh = 0; mh < this.MyGlobalResources.length; mh++) {
                if (this.MyGlobalResources[mh].ResourceName === pScriptName) {
                    if (this.MyGlobalResources[mh].IsCreated === true)
                        return false;
                    else {
                        this.MyGlobalResources[mh].IsCreated = true;
                        break;
                    }
                }
            }
            try {
                const s = document.createElement('script');
                const prior = document.getElementsByTagName('script')[0];
                if (this.MyGlobalResources[mh] && this.MyGlobalResources[mh].ResourceType)
                    s.type = this.MyGlobalResources[mh].ResourceType;
                else
                    s.type = "text/javascript";
                s.text = pScript.replace(String.fromCharCode(65279), '');
                prior.parentNode.insertBefore(s, prior);
                TheNMIService.FireCallbacks(this.MyGlobalResources[mh]);
            }
            catch (e) {
                cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "cdeNMI:CreateGlobalScripts", "Script Execution (" + pScriptName + ") failed with " + e + ":" + e.stack);
            }
        }
        static FireCallbacks(pNMIRes) {
            if (!pNMIRes)
                return;
            if (pNMIRes.TimeoutHandler && pNMIRes.TimeoutHandler > 0)
                clearTimeout(pNMIRes.TimeoutHandler);
            for (let mh = 0; mh < pNMIRes.CallBacks.length; mh++) {
                if (pNMIRes.CallBacks[mh]) {
                    pNMIRes.CallBacks[mh](pNMIRes.Cookie, pNMIRes.Resource);
                }
            }
        }
        cdeGetStyle(pResource, pCallBack = null, cookie = null, pTimeout = 0) {
            if (!pResource)
                return;
            for (let mh = 0; mh < this.MyGlobalResources.length; mh++) {
                if (this.MyGlobalResources[mh].ResourceName === pResource) {
                    if (this.MyGlobalResources[mh].IsCreated === true && pCallBack)
                        pCallBack(this.MyGlobalResources[mh].Cookie, this.MyGlobalResources[mh].Resource);
                    return;
                }
            }
            if (pCallBack) {
                const t = { ResourceName: pResource, CallBacks: [], Cookie: cookie, IsCreated: false, Resource: null, Timeout: pTimeout, ResourceType: null };
                t.CallBacks.push(pCallBack);
                this.AddToGlobalScripts(t);
            }
            this.GetBaseEngine().PublishToService("NMI_GET_GLOBAL_STYLE", pResource);
        }
        CreateInlineCSS(pResName, pResource) {
            let mh = 0;
            for (mh = 0; mh < this.MyGlobalResources.length; mh++) {
                if (this.MyGlobalResources[mh].ResourceName === pResName) {
                    if (this.MyGlobalResources[mh].IsCreated === true)
                        return false;
                    else {
                        this.MyGlobalResources[mh].IsCreated = true;
                        break;
                    }
                }
            }
            try {
                const css = document.createElement('style');
                css.type = 'text/css';
                if (css.styleSheet)
                    css.styleSheet.cssText = pResource.replace(String.fromCharCode(65279), '');
                else
                    css.appendChild(document.createTextNode(pResource.replace(String.fromCharCode(65279), '')));
                document.getElementsByTagName("head")[0].appendChild(css);
                TheNMIService.FireCallbacks(this.MyGlobalResources[mh]);
            }
            catch (e) {
                cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "TheNMIService:CreateInlineCSS", "Style Inlining (" + pResName + ") failed with " + e);
            }
        }
        cdeGetImage(pResource, pCallBack, cookie = null, pTimeout = 0) {
            if (!pResource)
                return;
            for (let mh = 0; mh < this.MyGlobalResources.length; mh++) {
                if (this.MyGlobalResources[mh].ResourceName === pResource) {
                    if (pCallBack) {
                        if (this.MyGlobalResources[mh].IsCreated === true)
                            pCallBack(this.MyGlobalResources[mh].Cookie, this.MyGlobalResources[mh].Resource);
                        else {
                            if (this.MyGlobalResources[mh].Cookie !== cookie)
                                this.MyGlobalResources[mh].CallBacks.push(pCallBack);
                        }
                    }
                    return;
                }
            }
            if (pCallBack) {
                const t = { ResourceName: pResource, CallBacks: [], Cookie: cookie, IsCreated: false, Resource: null, Timeout: pTimeout, ResourceType: null };
                t.CallBacks.push(pCallBack);
                this.AddToGlobalScripts(t);
            }
            this.GetBaseEngine().PublishToService("NMI_GET_GLOBAL_IMAGE", pResource);
        }
        cdeGetResource(pResName, pCallBack, cookie = null, pTimeout = 0) {
            if (!pResName)
                return;
            for (let mh = 0; mh < this.MyGlobalResources.length; mh++) {
                if (this.MyGlobalResources[mh].ResourceName === pResName) {
                    let tTryAgain = false;
                    if (pCallBack) {
                        if (this.MyGlobalResources[mh].IsCreated === true)
                            pCallBack(this.MyGlobalResources[mh].Cookie, this.MyGlobalResources[mh].Resource);
                        else {
                            this.MyGlobalResources[mh].CallBacks.push(pCallBack);
                            if (this.MyGlobalResources[mh].Resource === "TIMEOUT") {
                                this.MyGlobalResources[mh].Resource = null;
                                tTryAgain = true;
                            }
                        }
                    }
                    if (!tTryAgain)
                        return;
                }
            }
            if (pCallBack) {
                const t = { ResourceName: pResName, CallBacks: [], Cookie: cookie, IsCreated: false, Resource: null, Timeout: pTimeout, ResourceType: null };
                t.CallBacks.push(pCallBack);
                this.AddToGlobalScripts(t);
            }
            if (cde.MyCommChannel) {
                if (cde.MyBaseAssets.MyServiceHostInfo.IsWebHosted === true || !cde.MyCommChannel.IsReady) {
                    cde.MyCommChannel.GetResourceString(pResName, (pRes, pResData) => {
                        this.ReturnGlobalResource(pRes, pResData);
                    });
                }
                else {
                    this.GetBaseEngine().PublishToService("NMI_GET_GLOBAL_RESOURCE", pResName);
                }
            }
            else
                this.ReturnGlobalResource(pResName, null);
        }
        ReturnGlobalResource(pResName, pResource) {
            let mh = 0;
            let bFound = false;
            for (mh = 0; mh < this.MyGlobalResources.length; mh++) {
                if (this.MyGlobalResources[mh].ResourceName === pResName) {
                    if (!this.MyGlobalResources[mh].IsCreated) {
                        if (pResource)
                            this.MyGlobalResources[mh].Resource = pResource.replace(String.fromCharCode(65279), '');
                        this.MyGlobalResources[mh].IsCreated = true;
                    }
                    bFound = true;
                    break;
                }
            }
            try {
                if (bFound)
                    TheNMIService.FireCallbacks(this.MyGlobalResources[mh]);
                else
                    cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "TheNMIService:ReturnGlobalResource", "Resource sent but not found in request table (" + pResName + ")");
            }
            catch (e) {
                cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "TheNMIService:ReturnGlobalResource", "Resource return (" + pResName + ") failed with " + e);
            }
        }
        CheckForUpdates() {
            if (cdeNMI.MyToast)
                cdeNMI.MyToast.ShowToastMessage("Checking for update...", "Updates will be visible in the main portal. Touch the home icon to see if you have updates", 10000);
            this.PublishToNMI('NMI_CHECK4_UPDATE');
        }
        GetScreenMeta(pGuid, pForceLoad) {
            if ((!cdeNMI.MyNMIModels[cde.GuidToString(pGuid)] && !this.MetaRequested[cde.GuidToString(pGuid)]) || pForceLoad) {
                if (pForceLoad) {
                    cdeNMI.MyNMIModels[cde.GuidToString(pGuid)] = null;
                }
                this.PublishToNMI('NMI_GET_SCREENMETA' + (pForceLoad ? 'F' : ''), pGuid); // Guid is Dashboard ID
                this.MetaRequested[cde.GuidToString(pGuid)] = true;
                return true;
            }
            return false;
        }
        GetScene(sceneID) {
            this.PublishToNMI('NMI_GET_SCENE', sceneID);
        }
        IsNodeDown(pNodeID) {
            return this.MyKnownNodes[pNodeID] && this.MyKnownNodes[pNodeID].IsDown === true;
        }
        GetKnownNodeName(pNodeID) {
            if (this.MyKnownNodes[pNodeID])
                return this.MyKnownNodes[pNodeID].NodeName;
            return "";
        }
        RegisterKnownNode(pNodeID, pNodeName) {
            let tNode = null;
            if (this.MyKnownNodes[pNodeID])
                tNode = this.MyKnownNodes[pNodeID];
            else
                tNode = new cdeNMI.TheNodeInfo();
            tNode.cdeN = pNodeID;
            if (tNode.IsDown === true) {
                tNode.IsDown = false;
                if (cdeNMI.MyScreenManager)
                    cdeNMI.MyScreenManager.UpdateScreenStatus(pNodeID, false);
            }
            tNode.IsDown = false;
            if (!tNode.NodeName)
                tNode.NodeName = pNodeName ? pNodeName : pNodeID;
            if (tNode.NodeName === pNodeID && pNodeName)
                tNode.NodeName = pNodeName;
            tNode.LastPing = (new Date()).getTime();
            this.MyKnownNodes[pNodeID] = tNode;
        }
        FireIncoming(pProcessMessage) {
            if (!pProcessMessage || !pProcessMessage.Message)
                return;
            if (pProcessMessage.Message.ENG === cdeNMI.eTheNMIEngine) {
                if (!cdeNMI.MyTCF.FireControls(pProcessMessage))
                    this.FireEvent(true, "IncomingMessage", pProcessMessage);
                //return;
            }
            const myNmiIncomingEvent = this.MyNMIIncomingEvents[pProcessMessage.Message.ENG];
            for (const tInfo in myNmiIncomingEvent) {
                //if (myNmiIncomingEvent.hasOwnProperty(tInfo)) {
                const tControl = myNmiIncomingEvent[tInfo];
                if (tControl) {
                    tControl.FireEvent(false, "IncomingMessage", new cde.TheProcessMessage(pProcessMessage.Topic, pProcessMessage.Message));
                }
                //}
            }
        }
        // Message Handler for C-DEngine Messages
        OnHandleMessage(pProcessMessage) {
            const pMSG = pProcessMessage.Message;
            if (!pMSG)
                return;
            if (!this.AreEnginesRequested && cde.MyBaseAssets.MyCommStatus.IsUserLoggedIn) {
                this.AreEnginesRequested = true;
                this.PublishToNMI("NMI_GET_ENGINEJS");
            }
            this.RegisterKnownNode(cde.TSM.GetOriginator(pMSG));
            if (super.BaseOnHandleMessage(pProcessMessage)) {
                if (cdeNMI.MyScreenManager) {
                    cdeNMI.MyScreenManager.ShowView();
                }
                return;
            }
            const tCmd = pMSG.TXT.split(':');
            switch (tCmd[0]) {
                case "NMI_GLOBAL_IMAGE":
                    if (pMSG.PLS && tCmd.length > 1) {
                        this.ReturnGlobalResource(tCmd[1], pMSG.PLS);
                    }
                    break;
                case "NMI_GLOBAL_RESOURCE":
                    if (pMSG.PLS && tCmd.length > 1) {
                        this.ReturnGlobalResource(tCmd[1], pMSG.PLS);
                    }
                    break;
                case "NMI_GLOBAL_SCRIPT":
                    if (pMSG.PLS && tCmd.length > 1) {
                        this.CreateGlobalScript(tCmd[1], pMSG.PLS);
                    }
                    break;
                case "NMI_GLOBAL_STYLE":
                    if (pMSG.PLS && tCmd.length > 1) {
                        this.CreateInlineCSS(tCmd[1], pMSG.PLS);
                    }
                    break;
                default:
                    return;
            }
            if (cdeNMI.MyScreenManager) {
                cdeNMI.MyScreenManager.ShowView();
            }
        }
        sinkScopeIDSet() {
            if (cdeNMI.MyScreenManager)
                cdeNMI.MyScreenManager.TransitToScreen(cde.MyBaseAssets.MyServiceHostInfo.PortalScreen);
        }
    }
    cdeNMI.TheNMIService = TheNMIService;
})(cdeNMI || (cdeNMI = {}));
// SPDX-FileCopyrightText: Copyright (C) 2007-2012, Jacob O. Wobbrock, Andrew D. Wilson and Yang Li.
//
// SPDX-License-Identifier: BSD-3-Clause
//
//Author:
//      original code see below
//      ported to TypeScript and adopted by Chris Muench
//Language:
//      translated for NMI - verified
//      MyLogger events - must be translated in Log Receiver if required
//CSS Styles: none
//Dependencies:
//      cdeCore
//      cdeNMIModel
//      cdeNMIBaseControl
//Version History
//      4.109: Initial Drop
/**
* The $1 Unistroke Recognizer (JavaScript version)
*
*	Jacob O. Wobbrock, Ph.D.
* 	The Information School
*	University of Washington
*	Seattle, WA 98195-2840
*	wobbrock@uw.edu
*
*	Andrew D. Wilson, Ph.D.
*	Microsoft Research
*	One Microsoft Way
*	Redmond, WA 98052
*	awilson@microsoft.com
*
*	Yang Li, Ph.D.
*	Department of Computer Science and Engineering
* 	University of Washington
*	Seattle, WA 98195-2840
* 	yangli@cs.washington.edu
*
*
* The academic publication for the $1 recognizer, and what should be
* used to cite it, is:
*
*  Wobbrock, J.O., Wilson, A.D. and Li, Y. (2007). Gestures without
*	   libraries, toolkits or training: A $1 recognizer for user interface
*	   prototypes. Proceedings of the ACM Symposium on User Interface
*	   Software and Technology (UIST '07). Newport, Rhode Island (October
*	   7-10, 2007). New York: ACM Press, pp. 159-168.
*
* The Protractor enhancement was separately published by Yang Li and programmed
* here by Jacob O. Wobbrock:
*
*  Li, Y. (2010). Protractor: A fast and accurate gesture
*	  recognizer. Proceedings of the ACM Conference on Human
*	  Factors in Computing Systems (CHI '10). Atlanta, Georgia
*	  (April 10-15, 2010). New York: ACM Press, pp. 2169-2172.
*
* This software is distributed under the "New BSD License" agreement:
*
* Copyright (C) 2007-2012, Jacob O. Wobbrock, Andrew D. Wilson and Yang Li.
* All rights reserved. Last updated July 14, 2018.
*
* Redistribution and use in source and binary forms, with or without
* modification, are permitted provided that the following conditions are met:
*    * Redistributions of source code must retain the above copyright
*      notice, this list of conditions and the following disclaimer.
*    * Redistributions in binary form must reproduce the above copyright
*      notice, this list of conditions and the following disclaimer in the
*      documentation and/or other materials provided with the distribution.
*    * Neither the names of the University of Washington nor Microsoft,
*      nor the names of its contributors may be used to endorse or promote
*      products derived from this software without specific prior written
*      permission.
*
* THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
* IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
* THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
* PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL Jacob O. Wobbrock OR Andrew D. Wilson
* OR Yang Li BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY,
* OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
* SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
* INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
* STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
* OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
**/
var cdeNMI;
// SPDX-FileCopyrightText: Copyright (C) 2007-2012, Jacob O. Wobbrock, Andrew D. Wilson and Yang Li.
//
// SPDX-License-Identifier: BSD-3-Clause
//
//Author:
//      original code see below
//      ported to TypeScript and adopted by Chris Muench
//Language:
//      translated for NMI - verified
//      MyLogger events - must be translated in Log Receiver if required
//CSS Styles: none
//Dependencies:
//      cdeCore
//      cdeNMIModel
//      cdeNMIBaseControl
//Version History
//      4.109: Initial Drop
/**
* The $1 Unistroke Recognizer (JavaScript version)
*
*	Jacob O. Wobbrock, Ph.D.
* 	The Information School
*	University of Washington
*	Seattle, WA 98195-2840
*	wobbrock@uw.edu
*
*	Andrew D. Wilson, Ph.D.
*	Microsoft Research
*	One Microsoft Way
*	Redmond, WA 98052
*	awilson@microsoft.com
*
*	Yang Li, Ph.D.
*	Department of Computer Science and Engineering
* 	University of Washington
*	Seattle, WA 98195-2840
* 	yangli@cs.washington.edu
*
*
* The academic publication for the $1 recognizer, and what should be
* used to cite it, is:
*
*  Wobbrock, J.O., Wilson, A.D. and Li, Y. (2007). Gestures without
*	   libraries, toolkits or training: A $1 recognizer for user interface
*	   prototypes. Proceedings of the ACM Symposium on User Interface
*	   Software and Technology (UIST '07). Newport, Rhode Island (October
*	   7-10, 2007). New York: ACM Press, pp. 159-168.
*
* The Protractor enhancement was separately published by Yang Li and programmed
* here by Jacob O. Wobbrock:
*
*  Li, Y. (2010). Protractor: A fast and accurate gesture
*	  recognizer. Proceedings of the ACM Conference on Human
*	  Factors in Computing Systems (CHI '10). Atlanta, Georgia
*	  (April 10-15, 2010). New York: ACM Press, pp. 2169-2172.
*
* This software is distributed under the "New BSD License" agreement:
*
* Copyright (C) 2007-2012, Jacob O. Wobbrock, Andrew D. Wilson and Yang Li.
* All rights reserved. Last updated July 14, 2018.
*
* Redistribution and use in source and binary forms, with or without
* modification, are permitted provided that the following conditions are met:
*    * Redistributions of source code must retain the above copyright
*      notice, this list of conditions and the following disclaimer.
*    * Redistributions in binary form must reproduce the above copyright
*      notice, this list of conditions and the following disclaimer in the
*      documentation and/or other materials provided with the distribution.
*    * Neither the names of the University of Washington nor Microsoft,
*      nor the names of its contributors may be used to endorse or promote
*      products derived from this software without specific prior written
*      permission.
*
* THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
* IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
* THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
* PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL Jacob O. Wobbrock OR Andrew D. Wilson
* OR Yang Li BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY,
* OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
* SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
* INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
* STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
* OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
**/
(function (cdeNMI) {
    //
    // Rectangle class
    //
    class TheRectangle {
        constructor(x, y, width, height) {
            this.X = x;
            this.Y = y;
            this.Width = width;
            this.Height = height;
        }
    }
    cdeNMI.TheRectangle = TheRectangle;
    //
    // Unistroke class: a unistroke template
    //
    class Unistroke {
        constructor(pSR, name, points) {
            this.Name = name;
            this.Points = pSR.Resample(points, pSR.NumPoints);
            const radians = pSR.IndicativeAngle(this.Points);
            this.Points = pSR.RotateBy(this.Points, -radians);
            this.Points = pSR.ScaleTo(this.Points, pSR.SquareSize);
            this.Points = pSR.TranslateTo(this.Points, pSR.Origin);
            this.Vector = pSR.Vectorize(this.Points); // for Protractor
        }
    }
    cdeNMI.Unistroke = Unistroke;
    //
    // Result class
    //
    class TheRecognizerResult {
        constructor(name, score, ms) {
            this.Name = name;
            this.Score = score;
            this.Time = ms;
        }
    }
    cdeNMI.TheRecognizerResult = TheRecognizerResult;
    //
    // DollarRecognizer class
    //
    class TheShapeRecognizer extends cdeNMI.TheNMIBaseControl {
        constructor() {
            super();
            this.NumUnistrokes = 16;
            this.NumPoints = 64;
            this.SquareSize = 250.0;
            this.Origin = new cdeNMI.TheDrawingPoint(0, 0);
            this.Diagonal = Math.sqrt(this.SquareSize * this.SquareSize + this.SquareSize * this.SquareSize);
            this.HalfDiagonal = 0.5 * this.Diagonal;
            this.AngleRange = this.Deg2Rad(45.0);
            this.AnglePrecision = this.Deg2Rad(2.0);
            this.Phi = 0.5 * (-1.0 + Math.sqrt(5.0)); // Golden Ratio
            this.MyBaseType = cdeNMI.cdeControlType.ShapeRecognizer;
            //
            // one built-in unistroke per gesture type
            //
            this.Unistrokes = new Array(this.NumUnistrokes);
            this.Unistrokes[0] = new Unistroke(this, "triangle", [new cdeNMI.TheDrawingPoint(137, 139), new cdeNMI.TheDrawingPoint(135, 141), new cdeNMI.TheDrawingPoint(133, 144), new cdeNMI.TheDrawingPoint(132, 146), new cdeNMI.TheDrawingPoint(130, 149), new cdeNMI.TheDrawingPoint(128, 151), new cdeNMI.TheDrawingPoint(126, 155), new cdeNMI.TheDrawingPoint(123, 160), new cdeNMI.TheDrawingPoint(120, 166), new cdeNMI.TheDrawingPoint(116, 171), new cdeNMI.TheDrawingPoint(112, 177), new cdeNMI.TheDrawingPoint(107, 183), new cdeNMI.TheDrawingPoint(102, 188), new cdeNMI.TheDrawingPoint(100, 191), new cdeNMI.TheDrawingPoint(95, 195), new cdeNMI.TheDrawingPoint(90, 199), new cdeNMI.TheDrawingPoint(86, 203), new cdeNMI.TheDrawingPoint(82, 206), new cdeNMI.TheDrawingPoint(80, 209), new cdeNMI.TheDrawingPoint(75, 213), new cdeNMI.TheDrawingPoint(73, 213), new cdeNMI.TheDrawingPoint(70, 216), new cdeNMI.TheDrawingPoint(67, 219), new cdeNMI.TheDrawingPoint(64, 221), new cdeNMI.TheDrawingPoint(61, 223), new cdeNMI.TheDrawingPoint(60, 225), new cdeNMI.TheDrawingPoint(62, 226), new cdeNMI.TheDrawingPoint(65, 225), new cdeNMI.TheDrawingPoint(67, 226), new cdeNMI.TheDrawingPoint(74, 226), new cdeNMI.TheDrawingPoint(77, 227), new cdeNMI.TheDrawingPoint(85, 229), new cdeNMI.TheDrawingPoint(91, 230), new cdeNMI.TheDrawingPoint(99, 231), new cdeNMI.TheDrawingPoint(108, 232), new cdeNMI.TheDrawingPoint(116, 233), new cdeNMI.TheDrawingPoint(125, 233), new cdeNMI.TheDrawingPoint(134, 234), new cdeNMI.TheDrawingPoint(145, 233), new cdeNMI.TheDrawingPoint(153, 232), new cdeNMI.TheDrawingPoint(160, 233), new cdeNMI.TheDrawingPoint(170, 234), new cdeNMI.TheDrawingPoint(177, 235), new cdeNMI.TheDrawingPoint(179, 236), new cdeNMI.TheDrawingPoint(186, 237), new cdeNMI.TheDrawingPoint(193, 238), new cdeNMI.TheDrawingPoint(198, 239), new cdeNMI.TheDrawingPoint(200, 237), new cdeNMI.TheDrawingPoint(202, 239), new cdeNMI.TheDrawingPoint(204, 238), new cdeNMI.TheDrawingPoint(206, 234), new cdeNMI.TheDrawingPoint(205, 230), new cdeNMI.TheDrawingPoint(202, 222), new cdeNMI.TheDrawingPoint(197, 216), new cdeNMI.TheDrawingPoint(192, 207), new cdeNMI.TheDrawingPoint(186, 198), new cdeNMI.TheDrawingPoint(179, 189), new cdeNMI.TheDrawingPoint(174, 183), new cdeNMI.TheDrawingPoint(170, 178), new cdeNMI.TheDrawingPoint(164, 171), new cdeNMI.TheDrawingPoint(161, 168), new cdeNMI.TheDrawingPoint(154, 160), new cdeNMI.TheDrawingPoint(148, 155), new cdeNMI.TheDrawingPoint(143, 150), new cdeNMI.TheDrawingPoint(138, 148), new cdeNMI.TheDrawingPoint(136, 148)]);
            this.Unistrokes[1] = new Unistroke(this, "x", [new cdeNMI.TheDrawingPoint(87, 142), new cdeNMI.TheDrawingPoint(89, 145), new cdeNMI.TheDrawingPoint(91, 148), new cdeNMI.TheDrawingPoint(93, 151), new cdeNMI.TheDrawingPoint(96, 155), new cdeNMI.TheDrawingPoint(98, 157), new cdeNMI.TheDrawingPoint(100, 160), new cdeNMI.TheDrawingPoint(102, 162), new cdeNMI.TheDrawingPoint(106, 167), new cdeNMI.TheDrawingPoint(108, 169), new cdeNMI.TheDrawingPoint(110, 171), new cdeNMI.TheDrawingPoint(115, 177), new cdeNMI.TheDrawingPoint(119, 183), new cdeNMI.TheDrawingPoint(123, 189), new cdeNMI.TheDrawingPoint(127, 193), new cdeNMI.TheDrawingPoint(129, 196), new cdeNMI.TheDrawingPoint(133, 200), new cdeNMI.TheDrawingPoint(137, 206), new cdeNMI.TheDrawingPoint(140, 209), new cdeNMI.TheDrawingPoint(143, 212), new cdeNMI.TheDrawingPoint(146, 215), new cdeNMI.TheDrawingPoint(151, 220), new cdeNMI.TheDrawingPoint(153, 222), new cdeNMI.TheDrawingPoint(155, 223), new cdeNMI.TheDrawingPoint(157, 225), new cdeNMI.TheDrawingPoint(158, 223), new cdeNMI.TheDrawingPoint(157, 218), new cdeNMI.TheDrawingPoint(155, 211), new cdeNMI.TheDrawingPoint(154, 208), new cdeNMI.TheDrawingPoint(152, 200), new cdeNMI.TheDrawingPoint(150, 189), new cdeNMI.TheDrawingPoint(148, 179), new cdeNMI.TheDrawingPoint(147, 170), new cdeNMI.TheDrawingPoint(147, 158), new cdeNMI.TheDrawingPoint(147, 148), new cdeNMI.TheDrawingPoint(147, 141), new cdeNMI.TheDrawingPoint(147, 136), new cdeNMI.TheDrawingPoint(144, 135), new cdeNMI.TheDrawingPoint(142, 137), new cdeNMI.TheDrawingPoint(140, 139), new cdeNMI.TheDrawingPoint(135, 145), new cdeNMI.TheDrawingPoint(131, 152), new cdeNMI.TheDrawingPoint(124, 163), new cdeNMI.TheDrawingPoint(116, 177), new cdeNMI.TheDrawingPoint(108, 191), new cdeNMI.TheDrawingPoint(100, 206), new cdeNMI.TheDrawingPoint(94, 217), new cdeNMI.TheDrawingPoint(91, 222), new cdeNMI.TheDrawingPoint(89, 225), new cdeNMI.TheDrawingPoint(87, 226), new cdeNMI.TheDrawingPoint(87, 224)]);
            this.Unistrokes[2] = new Unistroke(this, "rectangle", [new cdeNMI.TheDrawingPoint(78, 149), new cdeNMI.TheDrawingPoint(78, 153), new cdeNMI.TheDrawingPoint(78, 157), new cdeNMI.TheDrawingPoint(78, 160), new cdeNMI.TheDrawingPoint(79, 162), new cdeNMI.TheDrawingPoint(79, 164), new cdeNMI.TheDrawingPoint(79, 167), new cdeNMI.TheDrawingPoint(79, 169), new cdeNMI.TheDrawingPoint(79, 173), new cdeNMI.TheDrawingPoint(79, 178), new cdeNMI.TheDrawingPoint(79, 183), new cdeNMI.TheDrawingPoint(80, 189), new cdeNMI.TheDrawingPoint(80, 193), new cdeNMI.TheDrawingPoint(80, 198), new cdeNMI.TheDrawingPoint(80, 202), new cdeNMI.TheDrawingPoint(81, 208), new cdeNMI.TheDrawingPoint(81, 210), new cdeNMI.TheDrawingPoint(81, 216), new cdeNMI.TheDrawingPoint(82, 222), new cdeNMI.TheDrawingPoint(82, 224), new cdeNMI.TheDrawingPoint(82, 227), new cdeNMI.TheDrawingPoint(83, 229), new cdeNMI.TheDrawingPoint(83, 231), new cdeNMI.TheDrawingPoint(85, 230), new cdeNMI.TheDrawingPoint(88, 232), new cdeNMI.TheDrawingPoint(90, 233), new cdeNMI.TheDrawingPoint(92, 232), new cdeNMI.TheDrawingPoint(94, 233), new cdeNMI.TheDrawingPoint(99, 232), new cdeNMI.TheDrawingPoint(102, 233), new cdeNMI.TheDrawingPoint(106, 233), new cdeNMI.TheDrawingPoint(109, 234), new cdeNMI.TheDrawingPoint(117, 235), new cdeNMI.TheDrawingPoint(123, 236), new cdeNMI.TheDrawingPoint(126, 236), new cdeNMI.TheDrawingPoint(135, 237), new cdeNMI.TheDrawingPoint(142, 238), new cdeNMI.TheDrawingPoint(145, 238), new cdeNMI.TheDrawingPoint(152, 238), new cdeNMI.TheDrawingPoint(154, 239), new cdeNMI.TheDrawingPoint(165, 238), new cdeNMI.TheDrawingPoint(174, 237), new cdeNMI.TheDrawingPoint(179, 236), new cdeNMI.TheDrawingPoint(186, 235), new cdeNMI.TheDrawingPoint(191, 235), new cdeNMI.TheDrawingPoint(195, 233), new cdeNMI.TheDrawingPoint(197, 233), new cdeNMI.TheDrawingPoint(200, 233), new cdeNMI.TheDrawingPoint(201, 235), new cdeNMI.TheDrawingPoint(201, 233), new cdeNMI.TheDrawingPoint(199, 231), new cdeNMI.TheDrawingPoint(198, 226), new cdeNMI.TheDrawingPoint(198, 220), new cdeNMI.TheDrawingPoint(196, 207), new cdeNMI.TheDrawingPoint(195, 195), new cdeNMI.TheDrawingPoint(195, 181), new cdeNMI.TheDrawingPoint(195, 173), new cdeNMI.TheDrawingPoint(195, 163), new cdeNMI.TheDrawingPoint(194, 155), new cdeNMI.TheDrawingPoint(192, 145), new cdeNMI.TheDrawingPoint(192, 143), new cdeNMI.TheDrawingPoint(192, 138), new cdeNMI.TheDrawingPoint(191, 135), new cdeNMI.TheDrawingPoint(191, 133), new cdeNMI.TheDrawingPoint(191, 130), new cdeNMI.TheDrawingPoint(190, 128), new cdeNMI.TheDrawingPoint(188, 129), new cdeNMI.TheDrawingPoint(186, 129), new cdeNMI.TheDrawingPoint(181, 132), new cdeNMI.TheDrawingPoint(173, 131), new cdeNMI.TheDrawingPoint(162, 131), new cdeNMI.TheDrawingPoint(151, 132), new cdeNMI.TheDrawingPoint(149, 132), new cdeNMI.TheDrawingPoint(138, 132), new cdeNMI.TheDrawingPoint(136, 132), new cdeNMI.TheDrawingPoint(122, 131), new cdeNMI.TheDrawingPoint(120, 131), new cdeNMI.TheDrawingPoint(109, 130), new cdeNMI.TheDrawingPoint(107, 130), new cdeNMI.TheDrawingPoint(90, 132), new cdeNMI.TheDrawingPoint(81, 133), new cdeNMI.TheDrawingPoint(76, 133)]);
            this.Unistrokes[3] = new Unistroke(this, "circle", [new cdeNMI.TheDrawingPoint(127, 141), new cdeNMI.TheDrawingPoint(124, 140), new cdeNMI.TheDrawingPoint(120, 139), new cdeNMI.TheDrawingPoint(118, 139), new cdeNMI.TheDrawingPoint(116, 139), new cdeNMI.TheDrawingPoint(111, 140), new cdeNMI.TheDrawingPoint(109, 141), new cdeNMI.TheDrawingPoint(104, 144), new cdeNMI.TheDrawingPoint(100, 147), new cdeNMI.TheDrawingPoint(96, 152), new cdeNMI.TheDrawingPoint(93, 157), new cdeNMI.TheDrawingPoint(90, 163), new cdeNMI.TheDrawingPoint(87, 169), new cdeNMI.TheDrawingPoint(85, 175), new cdeNMI.TheDrawingPoint(83, 181), new cdeNMI.TheDrawingPoint(82, 190), new cdeNMI.TheDrawingPoint(82, 195), new cdeNMI.TheDrawingPoint(83, 200), new cdeNMI.TheDrawingPoint(84, 205), new cdeNMI.TheDrawingPoint(88, 213), new cdeNMI.TheDrawingPoint(91, 216), new cdeNMI.TheDrawingPoint(96, 219), new cdeNMI.TheDrawingPoint(103, 222), new cdeNMI.TheDrawingPoint(108, 224), new cdeNMI.TheDrawingPoint(111, 224), new cdeNMI.TheDrawingPoint(120, 224), new cdeNMI.TheDrawingPoint(133, 223), new cdeNMI.TheDrawingPoint(142, 222), new cdeNMI.TheDrawingPoint(152, 218), new cdeNMI.TheDrawingPoint(160, 214), new cdeNMI.TheDrawingPoint(167, 210), new cdeNMI.TheDrawingPoint(173, 204), new cdeNMI.TheDrawingPoint(178, 198), new cdeNMI.TheDrawingPoint(179, 196), new cdeNMI.TheDrawingPoint(182, 188), new cdeNMI.TheDrawingPoint(182, 177), new cdeNMI.TheDrawingPoint(178, 167), new cdeNMI.TheDrawingPoint(170, 150), new cdeNMI.TheDrawingPoint(163, 138), new cdeNMI.TheDrawingPoint(152, 130), new cdeNMI.TheDrawingPoint(143, 129), new cdeNMI.TheDrawingPoint(140, 131), new cdeNMI.TheDrawingPoint(129, 136), new cdeNMI.TheDrawingPoint(126, 139)]);
            this.Unistrokes[4] = new Unistroke(this, "check", [new cdeNMI.TheDrawingPoint(91, 185), new cdeNMI.TheDrawingPoint(93, 185), new cdeNMI.TheDrawingPoint(95, 185), new cdeNMI.TheDrawingPoint(97, 185), new cdeNMI.TheDrawingPoint(100, 188), new cdeNMI.TheDrawingPoint(102, 189), new cdeNMI.TheDrawingPoint(104, 190), new cdeNMI.TheDrawingPoint(106, 193), new cdeNMI.TheDrawingPoint(108, 195), new cdeNMI.TheDrawingPoint(110, 198), new cdeNMI.TheDrawingPoint(112, 201), new cdeNMI.TheDrawingPoint(114, 204), new cdeNMI.TheDrawingPoint(115, 207), new cdeNMI.TheDrawingPoint(117, 210), new cdeNMI.TheDrawingPoint(118, 212), new cdeNMI.TheDrawingPoint(120, 214), new cdeNMI.TheDrawingPoint(121, 217), new cdeNMI.TheDrawingPoint(122, 219), new cdeNMI.TheDrawingPoint(123, 222), new cdeNMI.TheDrawingPoint(124, 224), new cdeNMI.TheDrawingPoint(126, 226), new cdeNMI.TheDrawingPoint(127, 229), new cdeNMI.TheDrawingPoint(129, 231), new cdeNMI.TheDrawingPoint(130, 233), new cdeNMI.TheDrawingPoint(129, 231), new cdeNMI.TheDrawingPoint(129, 228), new cdeNMI.TheDrawingPoint(129, 226), new cdeNMI.TheDrawingPoint(129, 224), new cdeNMI.TheDrawingPoint(129, 221), new cdeNMI.TheDrawingPoint(129, 218), new cdeNMI.TheDrawingPoint(129, 212), new cdeNMI.TheDrawingPoint(129, 208), new cdeNMI.TheDrawingPoint(130, 198), new cdeNMI.TheDrawingPoint(132, 189), new cdeNMI.TheDrawingPoint(134, 182), new cdeNMI.TheDrawingPoint(137, 173), new cdeNMI.TheDrawingPoint(143, 164), new cdeNMI.TheDrawingPoint(147, 157), new cdeNMI.TheDrawingPoint(151, 151), new cdeNMI.TheDrawingPoint(155, 144), new cdeNMI.TheDrawingPoint(161, 137), new cdeNMI.TheDrawingPoint(165, 131), new cdeNMI.TheDrawingPoint(171, 122), new cdeNMI.TheDrawingPoint(174, 118), new cdeNMI.TheDrawingPoint(176, 114), new cdeNMI.TheDrawingPoint(177, 112), new cdeNMI.TheDrawingPoint(177, 114), new cdeNMI.TheDrawingPoint(175, 116), new cdeNMI.TheDrawingPoint(173, 118)]);
            this.Unistrokes[5] = new Unistroke(this, "caret", [new cdeNMI.TheDrawingPoint(79, 245), new cdeNMI.TheDrawingPoint(79, 242), new cdeNMI.TheDrawingPoint(79, 239), new cdeNMI.TheDrawingPoint(80, 237), new cdeNMI.TheDrawingPoint(80, 234), new cdeNMI.TheDrawingPoint(81, 232), new cdeNMI.TheDrawingPoint(82, 230), new cdeNMI.TheDrawingPoint(84, 224), new cdeNMI.TheDrawingPoint(86, 220), new cdeNMI.TheDrawingPoint(86, 218), new cdeNMI.TheDrawingPoint(87, 216), new cdeNMI.TheDrawingPoint(88, 213), new cdeNMI.TheDrawingPoint(90, 207), new cdeNMI.TheDrawingPoint(91, 202), new cdeNMI.TheDrawingPoint(92, 200), new cdeNMI.TheDrawingPoint(93, 194), new cdeNMI.TheDrawingPoint(94, 192), new cdeNMI.TheDrawingPoint(96, 189), new cdeNMI.TheDrawingPoint(97, 186), new cdeNMI.TheDrawingPoint(100, 179), new cdeNMI.TheDrawingPoint(102, 173), new cdeNMI.TheDrawingPoint(105, 165), new cdeNMI.TheDrawingPoint(107, 160), new cdeNMI.TheDrawingPoint(109, 158), new cdeNMI.TheDrawingPoint(112, 151), new cdeNMI.TheDrawingPoint(115, 144), new cdeNMI.TheDrawingPoint(117, 139), new cdeNMI.TheDrawingPoint(119, 136), new cdeNMI.TheDrawingPoint(119, 134), new cdeNMI.TheDrawingPoint(120, 132), new cdeNMI.TheDrawingPoint(121, 129), new cdeNMI.TheDrawingPoint(122, 127), new cdeNMI.TheDrawingPoint(124, 125), new cdeNMI.TheDrawingPoint(126, 124), new cdeNMI.TheDrawingPoint(129, 125), new cdeNMI.TheDrawingPoint(131, 127), new cdeNMI.TheDrawingPoint(132, 130), new cdeNMI.TheDrawingPoint(136, 139), new cdeNMI.TheDrawingPoint(141, 154), new cdeNMI.TheDrawingPoint(145, 166), new cdeNMI.TheDrawingPoint(151, 182), new cdeNMI.TheDrawingPoint(156, 193), new cdeNMI.TheDrawingPoint(157, 196), new cdeNMI.TheDrawingPoint(161, 209), new cdeNMI.TheDrawingPoint(162, 211), new cdeNMI.TheDrawingPoint(167, 223), new cdeNMI.TheDrawingPoint(169, 229), new cdeNMI.TheDrawingPoint(170, 231), new cdeNMI.TheDrawingPoint(173, 237), new cdeNMI.TheDrawingPoint(176, 242), new cdeNMI.TheDrawingPoint(177, 244), new cdeNMI.TheDrawingPoint(179, 250), new cdeNMI.TheDrawingPoint(181, 255), new cdeNMI.TheDrawingPoint(182, 257)]);
            this.Unistrokes[6] = new Unistroke(this, "zig-zag", [new cdeNMI.TheDrawingPoint(307, 216), new cdeNMI.TheDrawingPoint(333, 186), new cdeNMI.TheDrawingPoint(356, 215), new cdeNMI.TheDrawingPoint(375, 186), new cdeNMI.TheDrawingPoint(399, 216), new cdeNMI.TheDrawingPoint(418, 186)]);
            this.Unistrokes[7] = new Unistroke(this, "arrow", [new cdeNMI.TheDrawingPoint(68, 222), new cdeNMI.TheDrawingPoint(70, 220), new cdeNMI.TheDrawingPoint(73, 218), new cdeNMI.TheDrawingPoint(75, 217), new cdeNMI.TheDrawingPoint(77, 215), new cdeNMI.TheDrawingPoint(80, 213), new cdeNMI.TheDrawingPoint(82, 212), new cdeNMI.TheDrawingPoint(84, 210), new cdeNMI.TheDrawingPoint(87, 209), new cdeNMI.TheDrawingPoint(89, 208), new cdeNMI.TheDrawingPoint(92, 206), new cdeNMI.TheDrawingPoint(95, 204), new cdeNMI.TheDrawingPoint(101, 201), new cdeNMI.TheDrawingPoint(106, 198), new cdeNMI.TheDrawingPoint(112, 194), new cdeNMI.TheDrawingPoint(118, 191), new cdeNMI.TheDrawingPoint(124, 187), new cdeNMI.TheDrawingPoint(127, 186), new cdeNMI.TheDrawingPoint(132, 183), new cdeNMI.TheDrawingPoint(138, 181), new cdeNMI.TheDrawingPoint(141, 180), new cdeNMI.TheDrawingPoint(146, 178), new cdeNMI.TheDrawingPoint(154, 173), new cdeNMI.TheDrawingPoint(159, 171), new cdeNMI.TheDrawingPoint(161, 170), new cdeNMI.TheDrawingPoint(166, 167), new cdeNMI.TheDrawingPoint(168, 167), new cdeNMI.TheDrawingPoint(171, 166), new cdeNMI.TheDrawingPoint(174, 164), new cdeNMI.TheDrawingPoint(177, 162), new cdeNMI.TheDrawingPoint(180, 160), new cdeNMI.TheDrawingPoint(182, 158), new cdeNMI.TheDrawingPoint(183, 156), new cdeNMI.TheDrawingPoint(181, 154), new cdeNMI.TheDrawingPoint(178, 153), new cdeNMI.TheDrawingPoint(171, 153), new cdeNMI.TheDrawingPoint(164, 153), new cdeNMI.TheDrawingPoint(160, 153), new cdeNMI.TheDrawingPoint(150, 154), new cdeNMI.TheDrawingPoint(147, 155), new cdeNMI.TheDrawingPoint(141, 157), new cdeNMI.TheDrawingPoint(137, 158), new cdeNMI.TheDrawingPoint(135, 158), new cdeNMI.TheDrawingPoint(137, 158), new cdeNMI.TheDrawingPoint(140, 157), new cdeNMI.TheDrawingPoint(143, 156), new cdeNMI.TheDrawingPoint(151, 154), new cdeNMI.TheDrawingPoint(160, 152), new cdeNMI.TheDrawingPoint(170, 149), new cdeNMI.TheDrawingPoint(179, 147), new cdeNMI.TheDrawingPoint(185, 145), new cdeNMI.TheDrawingPoint(192, 144), new cdeNMI.TheDrawingPoint(196, 144), new cdeNMI.TheDrawingPoint(198, 144), new cdeNMI.TheDrawingPoint(200, 144), new cdeNMI.TheDrawingPoint(201, 147), new cdeNMI.TheDrawingPoint(199, 149), new cdeNMI.TheDrawingPoint(194, 157), new cdeNMI.TheDrawingPoint(191, 160), new cdeNMI.TheDrawingPoint(186, 167), new cdeNMI.TheDrawingPoint(180, 176), new cdeNMI.TheDrawingPoint(177, 179), new cdeNMI.TheDrawingPoint(171, 187), new cdeNMI.TheDrawingPoint(169, 189), new cdeNMI.TheDrawingPoint(165, 194), new cdeNMI.TheDrawingPoint(164, 196)]);
            this.Unistrokes[8] = new Unistroke(this, "left square bracket", [new cdeNMI.TheDrawingPoint(140, 124), new cdeNMI.TheDrawingPoint(138, 123), new cdeNMI.TheDrawingPoint(135, 122), new cdeNMI.TheDrawingPoint(133, 123), new cdeNMI.TheDrawingPoint(130, 123), new cdeNMI.TheDrawingPoint(128, 124), new cdeNMI.TheDrawingPoint(125, 125), new cdeNMI.TheDrawingPoint(122, 124), new cdeNMI.TheDrawingPoint(120, 124), new cdeNMI.TheDrawingPoint(118, 124), new cdeNMI.TheDrawingPoint(116, 125), new cdeNMI.TheDrawingPoint(113, 125), new cdeNMI.TheDrawingPoint(111, 125), new cdeNMI.TheDrawingPoint(108, 124), new cdeNMI.TheDrawingPoint(106, 125), new cdeNMI.TheDrawingPoint(104, 125), new cdeNMI.TheDrawingPoint(102, 124), new cdeNMI.TheDrawingPoint(100, 123), new cdeNMI.TheDrawingPoint(98, 123), new cdeNMI.TheDrawingPoint(95, 124), new cdeNMI.TheDrawingPoint(93, 123), new cdeNMI.TheDrawingPoint(90, 124), new cdeNMI.TheDrawingPoint(88, 124), new cdeNMI.TheDrawingPoint(85, 125), new cdeNMI.TheDrawingPoint(83, 126), new cdeNMI.TheDrawingPoint(81, 127), new cdeNMI.TheDrawingPoint(81, 129), new cdeNMI.TheDrawingPoint(82, 131), new cdeNMI.TheDrawingPoint(82, 134), new cdeNMI.TheDrawingPoint(83, 138), new cdeNMI.TheDrawingPoint(84, 141), new cdeNMI.TheDrawingPoint(84, 144), new cdeNMI.TheDrawingPoint(85, 148), new cdeNMI.TheDrawingPoint(85, 151), new cdeNMI.TheDrawingPoint(86, 156), new cdeNMI.TheDrawingPoint(86, 160), new cdeNMI.TheDrawingPoint(86, 164), new cdeNMI.TheDrawingPoint(86, 168), new cdeNMI.TheDrawingPoint(87, 171), new cdeNMI.TheDrawingPoint(87, 175), new cdeNMI.TheDrawingPoint(87, 179), new cdeNMI.TheDrawingPoint(87, 182), new cdeNMI.TheDrawingPoint(87, 186), new cdeNMI.TheDrawingPoint(88, 188), new cdeNMI.TheDrawingPoint(88, 195), new cdeNMI.TheDrawingPoint(88, 198), new cdeNMI.TheDrawingPoint(88, 201), new cdeNMI.TheDrawingPoint(88, 207), new cdeNMI.TheDrawingPoint(89, 211), new cdeNMI.TheDrawingPoint(89, 213), new cdeNMI.TheDrawingPoint(89, 217), new cdeNMI.TheDrawingPoint(89, 222), new cdeNMI.TheDrawingPoint(88, 225), new cdeNMI.TheDrawingPoint(88, 229), new cdeNMI.TheDrawingPoint(88, 231), new cdeNMI.TheDrawingPoint(88, 233), new cdeNMI.TheDrawingPoint(88, 235), new cdeNMI.TheDrawingPoint(89, 237), new cdeNMI.TheDrawingPoint(89, 240), new cdeNMI.TheDrawingPoint(89, 242), new cdeNMI.TheDrawingPoint(91, 241), new cdeNMI.TheDrawingPoint(94, 241), new cdeNMI.TheDrawingPoint(96, 240), new cdeNMI.TheDrawingPoint(98, 239), new cdeNMI.TheDrawingPoint(105, 240), new cdeNMI.TheDrawingPoint(109, 240), new cdeNMI.TheDrawingPoint(113, 239), new cdeNMI.TheDrawingPoint(116, 240), new cdeNMI.TheDrawingPoint(121, 239), new cdeNMI.TheDrawingPoint(130, 240), new cdeNMI.TheDrawingPoint(136, 237), new cdeNMI.TheDrawingPoint(139, 237), new cdeNMI.TheDrawingPoint(144, 238), new cdeNMI.TheDrawingPoint(151, 237), new cdeNMI.TheDrawingPoint(157, 236), new cdeNMI.TheDrawingPoint(159, 237)]);
            this.Unistrokes[9] = new Unistroke(this, "right square bracket", [new cdeNMI.TheDrawingPoint(112, 138), new cdeNMI.TheDrawingPoint(112, 136), new cdeNMI.TheDrawingPoint(115, 136), new cdeNMI.TheDrawingPoint(118, 137), new cdeNMI.TheDrawingPoint(120, 136), new cdeNMI.TheDrawingPoint(123, 136), new cdeNMI.TheDrawingPoint(125, 136), new cdeNMI.TheDrawingPoint(128, 136), new cdeNMI.TheDrawingPoint(131, 136), new cdeNMI.TheDrawingPoint(134, 135), new cdeNMI.TheDrawingPoint(137, 135), new cdeNMI.TheDrawingPoint(140, 134), new cdeNMI.TheDrawingPoint(143, 133), new cdeNMI.TheDrawingPoint(145, 132), new cdeNMI.TheDrawingPoint(147, 132), new cdeNMI.TheDrawingPoint(149, 132), new cdeNMI.TheDrawingPoint(152, 132), new cdeNMI.TheDrawingPoint(153, 134), new cdeNMI.TheDrawingPoint(154, 137), new cdeNMI.TheDrawingPoint(155, 141), new cdeNMI.TheDrawingPoint(156, 144), new cdeNMI.TheDrawingPoint(157, 152), new cdeNMI.TheDrawingPoint(158, 161), new cdeNMI.TheDrawingPoint(160, 170), new cdeNMI.TheDrawingPoint(162, 182), new cdeNMI.TheDrawingPoint(164, 192), new cdeNMI.TheDrawingPoint(166, 200), new cdeNMI.TheDrawingPoint(167, 209), new cdeNMI.TheDrawingPoint(168, 214), new cdeNMI.TheDrawingPoint(168, 216), new cdeNMI.TheDrawingPoint(169, 221), new cdeNMI.TheDrawingPoint(169, 223), new cdeNMI.TheDrawingPoint(169, 228), new cdeNMI.TheDrawingPoint(169, 231), new cdeNMI.TheDrawingPoint(166, 233), new cdeNMI.TheDrawingPoint(164, 234), new cdeNMI.TheDrawingPoint(161, 235), new cdeNMI.TheDrawingPoint(155, 236), new cdeNMI.TheDrawingPoint(147, 235), new cdeNMI.TheDrawingPoint(140, 233), new cdeNMI.TheDrawingPoint(131, 233), new cdeNMI.TheDrawingPoint(124, 233), new cdeNMI.TheDrawingPoint(117, 235), new cdeNMI.TheDrawingPoint(114, 238), new cdeNMI.TheDrawingPoint(112, 238)]);
            this.Unistrokes[10] = new Unistroke(this, "v", [new cdeNMI.TheDrawingPoint(89, 164), new cdeNMI.TheDrawingPoint(90, 162), new cdeNMI.TheDrawingPoint(92, 162), new cdeNMI.TheDrawingPoint(94, 164), new cdeNMI.TheDrawingPoint(95, 166), new cdeNMI.TheDrawingPoint(96, 169), new cdeNMI.TheDrawingPoint(97, 171), new cdeNMI.TheDrawingPoint(99, 175), new cdeNMI.TheDrawingPoint(101, 178), new cdeNMI.TheDrawingPoint(103, 182), new cdeNMI.TheDrawingPoint(106, 189), new cdeNMI.TheDrawingPoint(108, 194), new cdeNMI.TheDrawingPoint(111, 199), new cdeNMI.TheDrawingPoint(114, 204), new cdeNMI.TheDrawingPoint(117, 209), new cdeNMI.TheDrawingPoint(119, 214), new cdeNMI.TheDrawingPoint(122, 218), new cdeNMI.TheDrawingPoint(124, 222), new cdeNMI.TheDrawingPoint(126, 225), new cdeNMI.TheDrawingPoint(128, 228), new cdeNMI.TheDrawingPoint(130, 229), new cdeNMI.TheDrawingPoint(133, 233), new cdeNMI.TheDrawingPoint(134, 236), new cdeNMI.TheDrawingPoint(136, 239), new cdeNMI.TheDrawingPoint(138, 240), new cdeNMI.TheDrawingPoint(139, 242), new cdeNMI.TheDrawingPoint(140, 244), new cdeNMI.TheDrawingPoint(142, 242), new cdeNMI.TheDrawingPoint(142, 240), new cdeNMI.TheDrawingPoint(142, 237), new cdeNMI.TheDrawingPoint(143, 235), new cdeNMI.TheDrawingPoint(143, 233), new cdeNMI.TheDrawingPoint(145, 229), new cdeNMI.TheDrawingPoint(146, 226), new cdeNMI.TheDrawingPoint(148, 217), new cdeNMI.TheDrawingPoint(149, 208), new cdeNMI.TheDrawingPoint(149, 205), new cdeNMI.TheDrawingPoint(151, 196), new cdeNMI.TheDrawingPoint(151, 193), new cdeNMI.TheDrawingPoint(153, 182), new cdeNMI.TheDrawingPoint(155, 172), new cdeNMI.TheDrawingPoint(157, 165), new cdeNMI.TheDrawingPoint(159, 160), new cdeNMI.TheDrawingPoint(162, 155), new cdeNMI.TheDrawingPoint(164, 150), new cdeNMI.TheDrawingPoint(165, 148), new cdeNMI.TheDrawingPoint(166, 146)]);
            this.Unistrokes[11] = new Unistroke(this, "delete", [new cdeNMI.TheDrawingPoint(123, 129), new cdeNMI.TheDrawingPoint(123, 131), new cdeNMI.TheDrawingPoint(124, 133), new cdeNMI.TheDrawingPoint(125, 136), new cdeNMI.TheDrawingPoint(127, 140), new cdeNMI.TheDrawingPoint(129, 142), new cdeNMI.TheDrawingPoint(133, 148), new cdeNMI.TheDrawingPoint(137, 154), new cdeNMI.TheDrawingPoint(143, 158), new cdeNMI.TheDrawingPoint(145, 161), new cdeNMI.TheDrawingPoint(148, 164), new cdeNMI.TheDrawingPoint(153, 170), new cdeNMI.TheDrawingPoint(158, 176), new cdeNMI.TheDrawingPoint(160, 178), new cdeNMI.TheDrawingPoint(164, 183), new cdeNMI.TheDrawingPoint(168, 188), new cdeNMI.TheDrawingPoint(171, 191), new cdeNMI.TheDrawingPoint(175, 196), new cdeNMI.TheDrawingPoint(178, 200), new cdeNMI.TheDrawingPoint(180, 202), new cdeNMI.TheDrawingPoint(181, 205), new cdeNMI.TheDrawingPoint(184, 208), new cdeNMI.TheDrawingPoint(186, 210), new cdeNMI.TheDrawingPoint(187, 213), new cdeNMI.TheDrawingPoint(188, 215), new cdeNMI.TheDrawingPoint(186, 212), new cdeNMI.TheDrawingPoint(183, 211), new cdeNMI.TheDrawingPoint(177, 208), new cdeNMI.TheDrawingPoint(169, 206), new cdeNMI.TheDrawingPoint(162, 205), new cdeNMI.TheDrawingPoint(154, 207), new cdeNMI.TheDrawingPoint(145, 209), new cdeNMI.TheDrawingPoint(137, 210), new cdeNMI.TheDrawingPoint(129, 214), new cdeNMI.TheDrawingPoint(122, 217), new cdeNMI.TheDrawingPoint(118, 218), new cdeNMI.TheDrawingPoint(111, 221), new cdeNMI.TheDrawingPoint(109, 222), new cdeNMI.TheDrawingPoint(110, 219), new cdeNMI.TheDrawingPoint(112, 217), new cdeNMI.TheDrawingPoint(118, 209), new cdeNMI.TheDrawingPoint(120, 207), new cdeNMI.TheDrawingPoint(128, 196), new cdeNMI.TheDrawingPoint(135, 187), new cdeNMI.TheDrawingPoint(138, 183), new cdeNMI.TheDrawingPoint(148, 167), new cdeNMI.TheDrawingPoint(157, 153), new cdeNMI.TheDrawingPoint(163, 145), new cdeNMI.TheDrawingPoint(165, 142), new cdeNMI.TheDrawingPoint(172, 133), new cdeNMI.TheDrawingPoint(177, 127), new cdeNMI.TheDrawingPoint(179, 127), new cdeNMI.TheDrawingPoint(180, 125)]);
            this.Unistrokes[12] = new Unistroke(this, "left curly brace", [new cdeNMI.TheDrawingPoint(150, 116), new cdeNMI.TheDrawingPoint(147, 117), new cdeNMI.TheDrawingPoint(145, 116), new cdeNMI.TheDrawingPoint(142, 116), new cdeNMI.TheDrawingPoint(139, 117), new cdeNMI.TheDrawingPoint(136, 117), new cdeNMI.TheDrawingPoint(133, 118), new cdeNMI.TheDrawingPoint(129, 121), new cdeNMI.TheDrawingPoint(126, 122), new cdeNMI.TheDrawingPoint(123, 123), new cdeNMI.TheDrawingPoint(120, 125), new cdeNMI.TheDrawingPoint(118, 127), new cdeNMI.TheDrawingPoint(115, 128), new cdeNMI.TheDrawingPoint(113, 129), new cdeNMI.TheDrawingPoint(112, 131), new cdeNMI.TheDrawingPoint(113, 134), new cdeNMI.TheDrawingPoint(115, 134), new cdeNMI.TheDrawingPoint(117, 135), new cdeNMI.TheDrawingPoint(120, 135), new cdeNMI.TheDrawingPoint(123, 137), new cdeNMI.TheDrawingPoint(126, 138), new cdeNMI.TheDrawingPoint(129, 140), new cdeNMI.TheDrawingPoint(135, 143), new cdeNMI.TheDrawingPoint(137, 144), new cdeNMI.TheDrawingPoint(139, 147), new cdeNMI.TheDrawingPoint(141, 149), new cdeNMI.TheDrawingPoint(140, 152), new cdeNMI.TheDrawingPoint(139, 155), new cdeNMI.TheDrawingPoint(134, 159), new cdeNMI.TheDrawingPoint(131, 161), new cdeNMI.TheDrawingPoint(124, 166), new cdeNMI.TheDrawingPoint(121, 166), new cdeNMI.TheDrawingPoint(117, 166), new cdeNMI.TheDrawingPoint(114, 167), new cdeNMI.TheDrawingPoint(112, 166), new cdeNMI.TheDrawingPoint(114, 164), new cdeNMI.TheDrawingPoint(116, 163), new cdeNMI.TheDrawingPoint(118, 163), new cdeNMI.TheDrawingPoint(120, 162), new cdeNMI.TheDrawingPoint(122, 163), new cdeNMI.TheDrawingPoint(125, 164), new cdeNMI.TheDrawingPoint(127, 165), new cdeNMI.TheDrawingPoint(129, 166), new cdeNMI.TheDrawingPoint(130, 168), new cdeNMI.TheDrawingPoint(129, 171), new cdeNMI.TheDrawingPoint(127, 175), new cdeNMI.TheDrawingPoint(125, 179), new cdeNMI.TheDrawingPoint(123, 184), new cdeNMI.TheDrawingPoint(121, 190), new cdeNMI.TheDrawingPoint(120, 194), new cdeNMI.TheDrawingPoint(119, 199), new cdeNMI.TheDrawingPoint(120, 202), new cdeNMI.TheDrawingPoint(123, 207), new cdeNMI.TheDrawingPoint(127, 211), new cdeNMI.TheDrawingPoint(133, 215), new cdeNMI.TheDrawingPoint(142, 219), new cdeNMI.TheDrawingPoint(148, 220), new cdeNMI.TheDrawingPoint(151, 221)]);
            this.Unistrokes[13] = new Unistroke(this, "right curly brace", [new cdeNMI.TheDrawingPoint(117, 132), new cdeNMI.TheDrawingPoint(115, 132), new cdeNMI.TheDrawingPoint(115, 129), new cdeNMI.TheDrawingPoint(117, 129), new cdeNMI.TheDrawingPoint(119, 128), new cdeNMI.TheDrawingPoint(122, 127), new cdeNMI.TheDrawingPoint(125, 127), new cdeNMI.TheDrawingPoint(127, 127), new cdeNMI.TheDrawingPoint(130, 127), new cdeNMI.TheDrawingPoint(133, 129), new cdeNMI.TheDrawingPoint(136, 129), new cdeNMI.TheDrawingPoint(138, 130), new cdeNMI.TheDrawingPoint(140, 131), new cdeNMI.TheDrawingPoint(143, 134), new cdeNMI.TheDrawingPoint(144, 136), new cdeNMI.TheDrawingPoint(145, 139), new cdeNMI.TheDrawingPoint(145, 142), new cdeNMI.TheDrawingPoint(145, 145), new cdeNMI.TheDrawingPoint(145, 147), new cdeNMI.TheDrawingPoint(145, 149), new cdeNMI.TheDrawingPoint(144, 152), new cdeNMI.TheDrawingPoint(142, 157), new cdeNMI.TheDrawingPoint(141, 160), new cdeNMI.TheDrawingPoint(139, 163), new cdeNMI.TheDrawingPoint(137, 166), new cdeNMI.TheDrawingPoint(135, 167), new cdeNMI.TheDrawingPoint(133, 169), new cdeNMI.TheDrawingPoint(131, 172), new cdeNMI.TheDrawingPoint(128, 173), new cdeNMI.TheDrawingPoint(126, 176), new cdeNMI.TheDrawingPoint(125, 178), new cdeNMI.TheDrawingPoint(125, 180), new cdeNMI.TheDrawingPoint(125, 182), new cdeNMI.TheDrawingPoint(126, 184), new cdeNMI.TheDrawingPoint(128, 187), new cdeNMI.TheDrawingPoint(130, 187), new cdeNMI.TheDrawingPoint(132, 188), new cdeNMI.TheDrawingPoint(135, 189), new cdeNMI.TheDrawingPoint(140, 189), new cdeNMI.TheDrawingPoint(145, 189), new cdeNMI.TheDrawingPoint(150, 187), new cdeNMI.TheDrawingPoint(155, 186), new cdeNMI.TheDrawingPoint(157, 185), new cdeNMI.TheDrawingPoint(159, 184), new cdeNMI.TheDrawingPoint(156, 185), new cdeNMI.TheDrawingPoint(154, 185), new cdeNMI.TheDrawingPoint(149, 185), new cdeNMI.TheDrawingPoint(145, 187), new cdeNMI.TheDrawingPoint(141, 188), new cdeNMI.TheDrawingPoint(136, 191), new cdeNMI.TheDrawingPoint(134, 191), new cdeNMI.TheDrawingPoint(131, 192), new cdeNMI.TheDrawingPoint(129, 193), new cdeNMI.TheDrawingPoint(129, 195), new cdeNMI.TheDrawingPoint(129, 197), new cdeNMI.TheDrawingPoint(131, 200), new cdeNMI.TheDrawingPoint(133, 202), new cdeNMI.TheDrawingPoint(136, 206), new cdeNMI.TheDrawingPoint(139, 211), new cdeNMI.TheDrawingPoint(142, 215), new cdeNMI.TheDrawingPoint(145, 220), new cdeNMI.TheDrawingPoint(147, 225), new cdeNMI.TheDrawingPoint(148, 231), new cdeNMI.TheDrawingPoint(147, 239), new cdeNMI.TheDrawingPoint(144, 244), new cdeNMI.TheDrawingPoint(139, 248), new cdeNMI.TheDrawingPoint(134, 250), new cdeNMI.TheDrawingPoint(126, 253), new cdeNMI.TheDrawingPoint(119, 253), new cdeNMI.TheDrawingPoint(115, 253)]);
            this.Unistrokes[14] = new Unistroke(this, "star", [new cdeNMI.TheDrawingPoint(75, 250), new cdeNMI.TheDrawingPoint(75, 247), new cdeNMI.TheDrawingPoint(77, 244), new cdeNMI.TheDrawingPoint(78, 242), new cdeNMI.TheDrawingPoint(79, 239), new cdeNMI.TheDrawingPoint(80, 237), new cdeNMI.TheDrawingPoint(82, 234), new cdeNMI.TheDrawingPoint(82, 232), new cdeNMI.TheDrawingPoint(84, 229), new cdeNMI.TheDrawingPoint(85, 225), new cdeNMI.TheDrawingPoint(87, 222), new cdeNMI.TheDrawingPoint(88, 219), new cdeNMI.TheDrawingPoint(89, 216), new cdeNMI.TheDrawingPoint(91, 212), new cdeNMI.TheDrawingPoint(92, 208), new cdeNMI.TheDrawingPoint(94, 204), new cdeNMI.TheDrawingPoint(95, 201), new cdeNMI.TheDrawingPoint(96, 196), new cdeNMI.TheDrawingPoint(97, 194), new cdeNMI.TheDrawingPoint(98, 191), new cdeNMI.TheDrawingPoint(100, 185), new cdeNMI.TheDrawingPoint(102, 178), new cdeNMI.TheDrawingPoint(104, 173), new cdeNMI.TheDrawingPoint(104, 171), new cdeNMI.TheDrawingPoint(105, 164), new cdeNMI.TheDrawingPoint(106, 158), new cdeNMI.TheDrawingPoint(107, 156), new cdeNMI.TheDrawingPoint(107, 152), new cdeNMI.TheDrawingPoint(108, 145), new cdeNMI.TheDrawingPoint(109, 141), new cdeNMI.TheDrawingPoint(110, 139), new cdeNMI.TheDrawingPoint(112, 133), new cdeNMI.TheDrawingPoint(113, 131), new cdeNMI.TheDrawingPoint(116, 127), new cdeNMI.TheDrawingPoint(117, 125), new cdeNMI.TheDrawingPoint(119, 122), new cdeNMI.TheDrawingPoint(121, 121), new cdeNMI.TheDrawingPoint(123, 120), new cdeNMI.TheDrawingPoint(125, 122), new cdeNMI.TheDrawingPoint(125, 125), new cdeNMI.TheDrawingPoint(127, 130), new cdeNMI.TheDrawingPoint(128, 133), new cdeNMI.TheDrawingPoint(131, 143), new cdeNMI.TheDrawingPoint(136, 153), new cdeNMI.TheDrawingPoint(140, 163), new cdeNMI.TheDrawingPoint(144, 172), new cdeNMI.TheDrawingPoint(145, 175), new cdeNMI.TheDrawingPoint(151, 189), new cdeNMI.TheDrawingPoint(156, 201), new cdeNMI.TheDrawingPoint(161, 213), new cdeNMI.TheDrawingPoint(166, 225), new cdeNMI.TheDrawingPoint(169, 233), new cdeNMI.TheDrawingPoint(171, 236), new cdeNMI.TheDrawingPoint(174, 243), new cdeNMI.TheDrawingPoint(177, 247), new cdeNMI.TheDrawingPoint(178, 249), new cdeNMI.TheDrawingPoint(179, 251), new cdeNMI.TheDrawingPoint(180, 253), new cdeNMI.TheDrawingPoint(180, 255), new cdeNMI.TheDrawingPoint(179, 257), new cdeNMI.TheDrawingPoint(177, 257), new cdeNMI.TheDrawingPoint(174, 255), new cdeNMI.TheDrawingPoint(169, 250), new cdeNMI.TheDrawingPoint(164, 247), new cdeNMI.TheDrawingPoint(160, 245), new cdeNMI.TheDrawingPoint(149, 238), new cdeNMI.TheDrawingPoint(138, 230), new cdeNMI.TheDrawingPoint(127, 221), new cdeNMI.TheDrawingPoint(124, 220), new cdeNMI.TheDrawingPoint(112, 212), new cdeNMI.TheDrawingPoint(110, 210), new cdeNMI.TheDrawingPoint(96, 201), new cdeNMI.TheDrawingPoint(84, 195), new cdeNMI.TheDrawingPoint(74, 190), new cdeNMI.TheDrawingPoint(64, 182), new cdeNMI.TheDrawingPoint(55, 175), new cdeNMI.TheDrawingPoint(51, 172), new cdeNMI.TheDrawingPoint(49, 170), new cdeNMI.TheDrawingPoint(51, 169), new cdeNMI.TheDrawingPoint(56, 169), new cdeNMI.TheDrawingPoint(66, 169), new cdeNMI.TheDrawingPoint(78, 168), new cdeNMI.TheDrawingPoint(92, 166), new cdeNMI.TheDrawingPoint(107, 164), new cdeNMI.TheDrawingPoint(123, 161), new cdeNMI.TheDrawingPoint(140, 162), new cdeNMI.TheDrawingPoint(156, 162), new cdeNMI.TheDrawingPoint(171, 160), new cdeNMI.TheDrawingPoint(173, 160), new cdeNMI.TheDrawingPoint(186, 160), new cdeNMI.TheDrawingPoint(195, 160), new cdeNMI.TheDrawingPoint(198, 161), new cdeNMI.TheDrawingPoint(203, 163), new cdeNMI.TheDrawingPoint(208, 163), new cdeNMI.TheDrawingPoint(206, 164), new cdeNMI.TheDrawingPoint(200, 167), new cdeNMI.TheDrawingPoint(187, 172), new cdeNMI.TheDrawingPoint(174, 179), new cdeNMI.TheDrawingPoint(172, 181), new cdeNMI.TheDrawingPoint(153, 192), new cdeNMI.TheDrawingPoint(137, 201), new cdeNMI.TheDrawingPoint(123, 211), new cdeNMI.TheDrawingPoint(112, 220), new cdeNMI.TheDrawingPoint(99, 229), new cdeNMI.TheDrawingPoint(90, 237), new cdeNMI.TheDrawingPoint(80, 244), new cdeNMI.TheDrawingPoint(73, 250), new cdeNMI.TheDrawingPoint(69, 254), new cdeNMI.TheDrawingPoint(69, 252)]);
            this.Unistrokes[15] = new Unistroke(this, "pigtail", [new cdeNMI.TheDrawingPoint(81, 219), new cdeNMI.TheDrawingPoint(84, 218), new cdeNMI.TheDrawingPoint(86, 220), new cdeNMI.TheDrawingPoint(88, 220), new cdeNMI.TheDrawingPoint(90, 220), new cdeNMI.TheDrawingPoint(92, 219), new cdeNMI.TheDrawingPoint(95, 220), new cdeNMI.TheDrawingPoint(97, 219), new cdeNMI.TheDrawingPoint(99, 220), new cdeNMI.TheDrawingPoint(102, 218), new cdeNMI.TheDrawingPoint(105, 217), new cdeNMI.TheDrawingPoint(107, 216), new cdeNMI.TheDrawingPoint(110, 216), new cdeNMI.TheDrawingPoint(113, 214), new cdeNMI.TheDrawingPoint(116, 212), new cdeNMI.TheDrawingPoint(118, 210), new cdeNMI.TheDrawingPoint(121, 208), new cdeNMI.TheDrawingPoint(124, 205), new cdeNMI.TheDrawingPoint(126, 202), new cdeNMI.TheDrawingPoint(129, 199), new cdeNMI.TheDrawingPoint(132, 196), new cdeNMI.TheDrawingPoint(136, 191), new cdeNMI.TheDrawingPoint(139, 187), new cdeNMI.TheDrawingPoint(142, 182), new cdeNMI.TheDrawingPoint(144, 179), new cdeNMI.TheDrawingPoint(146, 174), new cdeNMI.TheDrawingPoint(148, 170), new cdeNMI.TheDrawingPoint(149, 168), new cdeNMI.TheDrawingPoint(151, 162), new cdeNMI.TheDrawingPoint(152, 160), new cdeNMI.TheDrawingPoint(152, 157), new cdeNMI.TheDrawingPoint(152, 155), new cdeNMI.TheDrawingPoint(152, 151), new cdeNMI.TheDrawingPoint(152, 149), new cdeNMI.TheDrawingPoint(152, 146), new cdeNMI.TheDrawingPoint(149, 142), new cdeNMI.TheDrawingPoint(148, 139), new cdeNMI.TheDrawingPoint(145, 137), new cdeNMI.TheDrawingPoint(141, 135), new cdeNMI.TheDrawingPoint(139, 135), new cdeNMI.TheDrawingPoint(134, 136), new cdeNMI.TheDrawingPoint(130, 140), new cdeNMI.TheDrawingPoint(128, 142), new cdeNMI.TheDrawingPoint(126, 145), new cdeNMI.TheDrawingPoint(122, 150), new cdeNMI.TheDrawingPoint(119, 158), new cdeNMI.TheDrawingPoint(117, 163), new cdeNMI.TheDrawingPoint(115, 170), new cdeNMI.TheDrawingPoint(114, 175), new cdeNMI.TheDrawingPoint(117, 184), new cdeNMI.TheDrawingPoint(120, 190), new cdeNMI.TheDrawingPoint(125, 199), new cdeNMI.TheDrawingPoint(129, 203), new cdeNMI.TheDrawingPoint(133, 208), new cdeNMI.TheDrawingPoint(138, 213), new cdeNMI.TheDrawingPoint(145, 215), new cdeNMI.TheDrawingPoint(155, 218), new cdeNMI.TheDrawingPoint(164, 219), new cdeNMI.TheDrawingPoint(166, 219), new cdeNMI.TheDrawingPoint(177, 219), new cdeNMI.TheDrawingPoint(182, 218), new cdeNMI.TheDrawingPoint(192, 216), new cdeNMI.TheDrawingPoint(196, 213), new cdeNMI.TheDrawingPoint(199, 212), new cdeNMI.TheDrawingPoint(201, 211)]);
        }
        //
        // The $1 Gesture Recognizer API begins here -- 3 methods: Recognize(), AddGesture(), and DeleteUserGestures()
        //
        Recognize(inPoints, useProtractor) {
            const t0 = Date.now();
            let points = this.Resample(inPoints, this.NumPoints);
            const radians = this.IndicativeAngle(points);
            points = this.RotateBy(points, -radians);
            points = this.ScaleTo(points, this.SquareSize);
            points = this.TranslateTo(points, this.Origin);
            const vector = this.Vectorize(points); // for Protractor
            let b = +Infinity;
            let u = -1;
            for (let i = 0; i < this.Unistrokes.length; i++) // for each unistroke
             {
                let d;
                if (useProtractor) // for Protractor
                    d = this.OptimalCosineDistance(this.Unistrokes[i].Vector, vector);
                else // Golden Section Search (original $1)
                    d = this.DistanceAtBestAngle(points, this.Unistrokes[i], -this.AngleRange, +this.AngleRange, this.AnglePrecision);
                if (d < b) {
                    b = d; // best (least) distance
                    u = i; // unistroke index
                }
            }
            const t1 = Date.now();
            return (u === -1) ? new TheRecognizerResult("No match", 0.0, t1 - t0) : new TheRecognizerResult(this.Unistrokes[u].Name, useProtractor ? 1.0 / b : 1.0 - b / this.HalfDiagonal, t1 - t0);
        }
        AddGesture(name, points) {
            this.Unistrokes[this.Unistrokes.length] = new Unistroke(this, name, points); // append new unistroke
            let num = 0;
            for (let i = 0; i < this.Unistrokes.length; i++) {
                if (this.Unistrokes[i].Name === name)
                    num++;
            }
            return num;
        }
        DeleteUserGestures() {
            this.Unistrokes.length = this.NumUnistrokes; // clear any beyond the original set
            return this.NumUnistrokes;
        }
        //
        // Private helper functions from here on down
        //
        Resample(points, n) {
            const I = this.PathLength(points) / (n - 1); // interval length
            let D = 0.0;
            const newpoints = new Array(points[0]);
            for (let i = 1; i < points.length; i++) {
                const d = this.Distance(points[i - 1], points[i]);
                if ((D + d) >= I) {
                    const qx = points[i - 1].x + ((I - D) / d) * (points[i].x - points[i - 1].x);
                    const qy = points[i - 1].y + ((I - D) / d) * (points[i].y - points[i - 1].y);
                    const q = new cdeNMI.TheDrawingPoint(qx, qy);
                    newpoints[newpoints.length] = q; // append new point 'q'
                    points.splice(i, 0, q); // insert 'q' at position i in points s.t. 'q' will be the next i
                    D = 0.0;
                }
                else
                    D += d;
            }
            if (newpoints.length === n - 1) // somtimes we fall a rounding-error short of adding the last point, so add it if so
                newpoints[newpoints.length] = new cdeNMI.TheDrawingPoint(points[points.length - 1].x, points[points.length - 1].y);
            return newpoints;
        }
        IndicativeAngle(points) {
            const c = this.Centroid(points);
            return Math.atan2(c.y - points[0].y, c.x - points[0].x);
        }
        RotateBy(points, radians) {
            const c = this.Centroid(points);
            const cos = Math.cos(radians);
            const sin = Math.sin(radians);
            const newpoints = [];
            for (let i = 0; i < points.length; i++) {
                const qx = (points[i].x - c.x) * cos - (points[i].y - c.y) * sin + c.x;
                const qy = (points[i].x - c.x) * sin + (points[i].y - c.y) * cos + c.y;
                newpoints[newpoints.length] = new cdeNMI.TheDrawingPoint(qx, qy);
            }
            return newpoints;
        }
        ScaleTo(points, size) {
            const B = this.BoundingBox(points);
            const newpoints = [];
            for (let i = 0; i < points.length; i++) {
                const qx = points[i].x * (size / B.Width);
                const qy = points[i].x * (size / B.Height);
                newpoints[newpoints.length] = new cdeNMI.TheDrawingPoint(qx, qy);
            }
            return newpoints;
        }
        TranslateTo(points, pt) {
            const c = this.Centroid(points);
            const newpoints = [];
            for (let i = 0; i < points.length; i++) {
                const qx = points[i].x + pt.x - c.x;
                const qy = points[i].y + pt.y - c.y;
                newpoints[newpoints.length] = new cdeNMI.TheDrawingPoint(qx, qy);
            }
            return newpoints;
        }
        Vectorize(points) {
            let sum = 0.0;
            const vector = [];
            for (let i = 0; i < points.length; i++) {
                vector[vector.length] = points[i].x;
                vector[vector.length] = points[i].y;
                sum += points[i].x * points[i].x + points[i].y * points[i].y;
            }
            const magnitude = Math.sqrt(sum);
            for (let i = 0; i < vector.length; i++)
                vector[i] /= magnitude;
            return vector;
        }
        OptimalCosineDistance(v1, v2) {
            let a = 0.0;
            let b = 0.0;
            for (let i = 0; i < v1.length; i += 2) {
                a += v1[i] * v2[i] + v1[i + 1] * v2[i + 1];
                b += v1[i] * v2[i + 1] - v1[i + 1] * v2[i];
            }
            const angle = Math.atan(b / a);
            return Math.acos(a * Math.cos(angle) + b * Math.sin(angle));
        }
        DistanceAtBestAngle(points, T, a, b, threshold) {
            let x1 = this.Phi * a + (1.0 - this.Phi) * b;
            let f1 = this.DistanceAtAngle(points, T, x1);
            let x2 = (1.0 - this.Phi) * a + this.Phi * b;
            let f2 = this.DistanceAtAngle(points, T, x2);
            while (Math.abs(b - a) > threshold) {
                if (f1 < f2) {
                    b = x2;
                    x2 = x1;
                    f2 = f1;
                    x1 = this.Phi * a + (1.0 - this.Phi) * b;
                    f1 = this.DistanceAtAngle(points, T, x1);
                }
                else {
                    a = x1;
                    x1 = x2;
                    f1 = f2;
                    x2 = (1.0 - this.Phi) * a + this.Phi * b;
                    f2 = this.DistanceAtAngle(points, T, x2);
                }
            }
            return Math.min(f1, f2);
        }
        DistanceAtAngle(points, T, radians) {
            const newpoints = this.RotateBy(points, radians);
            return this.PathDistance(newpoints, T.Points);
        }
        Centroid(points) {
            let x = 0.0, y = 0.0;
            for (let i = 0; i < points.length; i++) {
                x += points[i].x;
                y += points[i].y;
            }
            x /= points.length;
            y /= points.length;
            return new cdeNMI.TheDrawingPoint(x, y);
        }
        BoundingBox(points) {
            let minX = +Infinity, maxX = -Infinity, minY = +Infinity, maxY = -Infinity;
            for (let i = 0; i < points.length; i++) {
                minX = Math.min(minX, points[i].x);
                minY = Math.min(minY, points[i].y);
                maxX = Math.max(maxX, points[i].x);
                maxY = Math.max(maxY, points[i].y);
            }
            return new TheRectangle(minX, minY, maxX - minX, maxY - minY);
        }
        PathDistance(pts1, pts2) {
            let d = 0.0;
            for (let i = 0; i < pts1.length; i++) // assumes pts1.length == pts2.length
                d += this.Distance(pts1[i], pts2[i]);
            return d / pts1.length;
        }
        PathLength(points) {
            let d = 0.0;
            for (let i = 1; i < points.length; i++)
                d += this.Distance(points[i - 1], points[i]);
            return d;
        }
        Distance(p1, p2) {
            const dx = p2.x - p1.x;
            const dy = p2.y - p1.y;
            return Math.sqrt(dx * dx + dy * dy);
        }
        Deg2Rad(d) { return (d * Math.PI / 180.0); }
        RecogizeShape(pDrawObject, ScoreMin, useProtractor = true) {
            const tPts = new Array();
            for (const tt in pDrawObject.ComplexData) {
                tPts.push(new cdeNMI.TheDrawingPoint(pDrawObject.ComplexData[tt].PO.x, pDrawObject.ComplexData[tt].PO.y));
            }
            if (tPts.length < 3)
                return null;
            const res = this.Recognize(tPts, useProtractor);
            if (res) {
                if (res.Score > ScoreMin) {
                    //cdeNMI.ShowToastMessage("Name: " + res.Name + " Score:" + res.Score + " Time:" + res.Time);
                    cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "ShapeRecognizer", "Name: " + res.Name + " Accu:" + res.Score.toFixed(2) + " Time:" + res.Time);
                    return res;
                }
                else {
                    //cdeNMI.ShowToastMessage("Guess is : " + res.Name + " but Score too low:" + res.Score);
                    return null;
                }
            }
            return null;
        }
    }
    cdeNMI.TheShapeRecognizer = TheShapeRecognizer;
})(cdeNMI || (cdeNMI = {}));
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
var cdeNMI;
(function (cdeNMI) {
    class ctrlDateTimePicker extends cdeNMI.TheNMIBaseControl {
        constructor(pTRF) {
            super(null, pTRF);
            this.NeedRefresh = false;
            this.myPicker = null;
            this.mFrameDiv = null;
            this.MyEditBox = null;
            this.mWidSub = 20;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.ComboBox;
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            this.SetProperty("HasChoices", false);
            this.mFrameDiv = document.createElement("div");
            //this.mFrameDiv.style.margin = "auto";
            this.mFrameDiv.style.width = "inherit";
            this.mFrameDiv.style.height = "inherit";
            this.mFrameDiv.className = "ctrlInput";
            this.SetElement(this.mFrameDiv);
            this.MyEditBox = document.createElement("input");
            this.MyEditBox.style.cssFloat = "left";
            this.MyEditBox.id = "DTP" + cde.GuidToString(this.MyFieldInfo.cdeMID);
            if (!cde.CBool(this.GetProperty("EnableAutoFill")) && !cde.CBool(this.GetProperty("InTemplate"))) {
                this.MyEditBox.name = "EB" + cde.GuidToString(this.MyFieldInfo.cdeMID) + "_" + Math.floor((Math.random() * 1000) + 1); //NOSONAR not crypto related
                this.MyEditBox.autocomplete = "new-password";
            }
            if (cde.CBool(this.GetSetting("NoTE"))) {
                const tLabel = document.createElement("label");
                tLabel.htmlFor = "cdeIMP" + cde.GuidToString(this.MyFieldInfo.cdeMID);
                tLabel.className = "cdeTesInput";
                tLabel.appendChild(this.MyEditBox);
                const tSpanLabel = document.createElement("span");
                tSpanLabel.className = "label";
                tSpanLabel.innerHTML = this.GetSetting("Title");
                tLabel.appendChild(tSpanLabel);
                const tSpanFocus = document.createElement("span");
                tSpanFocus.className = "focus-bg";
                tLabel.appendChild(tSpanFocus);
                this.mWidSub = 25;
                this.mFrameDiv.appendChild(tLabel);
            }
            else {
                this.mFrameDiv.appendChild(this.MyEditBox);
                this.MyEditBox.className = "cdeInput";
            }
            this.MyEditBox.className = "cdeInput flatpickr flatpickr-input";
            if (cde.CInt(this.GetSetting("TileFactorY")) > 1 && !this.MyEditBox.classList.contains("cdeSmall"))
                this.MyEditBox.classList.add("cdeSmall");
            if (this.MyFieldInfo && (this.MyFieldInfo.Flags & 2) === 0)
                this.SetProperty("Disabled", true);
            return true;
        }
        ShowComboPicker() {
            if (this.myPicker)
                this.myPicker.show();
        }
        ApplySkin() {
            const pickOptions = {
                mode: "single",
                enableTime: true,
                noCalendar: false,
                time_24hr: true,
                showMonths: 1,
                dateFormat: "Y-m-d H:i",
                onChange: (selectedDates, tRealVal) => {
                    if ((tRealVal && tRealVal !== "") && this.GetProperty("Value") !== tRealVal) {
                        this.IsDirty = true;
                        this.SetProperty("Value", tRealVal);
                        ///this.FireEvent(false, "OnValueChanged", event, this.GetProperty("Value"), this.MyTRF);
                    }
                },
                plugins: []
            };
            if (this.MyFieldInfo && (this.MyFieldInfo.Flags & 2) !== 0) {
                switch (this.MyFieldInfo.Type) {
                    case cdeNMI.cdeControlType.Month:
                        pickOptions.plugins = [
                            new monthSelectPlugin({
                                shorthand: true,
                                dateFormat: "F",
                                altFormat: "F Y",
                                theme: "dark" // defaults to "light"
                            })
                        ];
                        break;
                    case cdeNMI.cdeControlType.TimeSpan:
                        pickOptions.mode = "range";
                        break;
                    case cdeNMI.cdeControlType.Time:
                        pickOptions.noCalendar = true;
                        pickOptions.dateFormat = "H:i";
                        break;
                    case cdeNMI.cdeControlType.DateTime:
                        if (cde.CBool(this.GetProperty("DateOnly"))) {
                            pickOptions.enableTime = false;
                        }
                        break;
                }
            }
            this.myPicker = flatpickr(this.MyEditBox, pickOptions);
        }
        SetProperty(pName, pValue) {
            if ((pName === "Value" || pName === "iValue") && pValue !== null) {
                if (this.MyEditBox) {
                    this.MyEditBox.value = this.ShowFieldContent(pValue);
                }
                this.IsDirty = true;
            }
            else if (pName === "Disabled" && this.MyEditBox) {
                if ((!this.MyFieldInfo || (this.MyFieldInfo.Flags & 2) === 0))
                    pValue = true;
                this.MyEditBox.disabled = cde.CBool(pValue);
            }
            else if (pName === "Background" && this.MyEditBox && pValue) {
                this.MyEditBox.style.background = pValue;
            }
            else if (pName === "MainBackground" && this.MyEditBox && pValue) {
                this.MyEditBox.parentElement.style.background = pValue;
            }
            else if (pName === "Foreground" && this.MyEditBox && pValue) {
                this.MyEditBox.style.color = pValue;
            }
            else if (pName === "InnerClassName" && this.MyEditBox && pValue) {
                this.MyEditBox.className = pValue;
            }
            else if (pName === "InnerStyle" && this.MyEditBox && pValue) {
                this.MyEditBox.style.cssText = pValue;
            }
            else if (pName === "Z-Index" && this.MyEditBox) {
                this.MyEditBox.style.zIndex = pValue.toString();
            }
            super.SetProperty(pName, pValue);
        }
    }
    cdeNMI.ctrlDateTimePicker = ctrlDateTimePicker;
})(cdeNMI || (cdeNMI = {}));
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
const cdeSortAlphabet = '*!@_.()#^&%-=+01234567989abcdefghijklmnopqrstuvwxyz';
var cdeNMI;
(function (cdeNMI) {
    class ctrlComboBox extends cdeNMI.TheNMIBaseControl {
        constructor(pTRF) {
            super(null, pTRF);
            this.MyComboBox = null;
            this.MyComboDiv = null;
            this.HasGroups = false;
            this.MyTableName = null;
            this.MyLookup = null;
            this.HideInput = false;
            this.NeedRefresh = false;
            this.WasInputCreated = false;
            this.HasLoaded = false;
            this.DoShow = false;
            this.DontFire = false;
            this.MySep = ";";
            this.ControlText = "ctrlComboBox";
            this.RefreshCombo = '[{"V":"CDE_NOP","N":"loading...please wait"}]';
            this.myChoices = null;
            this.myChoicesOptions = {
                delimiter: this.MySep,
                editItems: false,
                maxItemCount: 1,
                removeItemButton: false,
                searchEnabled: false,
                shouldSort: true,
                searchResultLimit: 100,
                shouldSortItems: true,
                duplicateItemsAllowed: false,
                position: "bottom",
                fuseOptions: {
                    ignoreLocation: true,
                    threshold: 0.1,
                    location: 0,
                    distance: 1000,
                },
                sorter: function (a, b) {
                    const indexA = cdeSortAlphabet.indexOf(a[0]), indexB = cdeSortAlphabet.indexOf(b[0]);
                    if (indexA === indexB) {
                        // same first character, sort regular
                        if (a < b) {
                            return -1;
                        }
                        else if (a > b) {
                            return 1;
                        }
                        return 0;
                    }
                    else {
                        return indexA - indexB;
                    }
                }
            };
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            if (this.MyBaseType === cdeNMI.cdeControlType.BaseControl)
                this.MyBaseType = cdeNMI.cdeControlType.ComboBox;
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            this.SetProperty("HasChoices", false);
            if (this.MyFieldInfo && this.MyFieldInfo["DefaultValue"] && !this.MyFieldInfo["Value"])
                this.MyFieldInfo["Value"] = this.MyFieldInfo["DefaultValue"];
            if (this.MyFieldInfo && this.MyFieldInfo["HideInput"])
                this.HideInput = true;
            if (this.MyFieldInfo)
                super.SetProperty("UXID", this.MyFieldInfo.cdeMID);
            this.CalculateOption(null);
            this.RegisterEvent("OnDelete", () => {
                cdeNMI.MyEngine.UnregisterLazyLoader(this.MyScreenID, this.MyTableName, this.HandleLazyLoad);
            });
            return true;
        }
        AddChoice(pValue) {
            if (!pValue)
                return false;
            let tEx;
            if (this.MyCurrentData.length > 0) {
                tEx = this.MyCurrentData.filter(element => element.value === pValue.value);
            }
            if (!tEx || tEx.length === 0) {
                this.MyCurrentData.push(pValue);
                return true;
            }
            else {
                tEx.forEach((vl) => {
                    if (vl.label === vl.value && vl.label !== pValue.label)
                        vl.label = pValue.label;
                });
            }
            return false;
        }
        SetProperty(pName, pValue) {
            if ((pName === "Value" || pName === "iValue") && pValue !== null) {
                if (this.myChoices) {
                    const tChoices = pValue.toString().split(this.MySep);
                    this.DontFire = true;
                    try {
                        for (let i = 0; i < tChoices.length; i++) {
                            const tC = new cdeNMI.TheComboOption();
                            tC.value = tChoices[i];
                            tC.label = tChoices[i];
                            this.AddChoice(tC);
                        }
                        if (this.MyCurrentData.length > 0) {
                            this.myChoices.setChoices(this.MyCurrentData, "value", "label", true);
                            this.myChoices.removeActiveItems();
                            this.myChoices.setChoiceByValue(tChoices);
                        }
                        //const tH=this.myChoices.items;
                    }
                    catch (_a) {
                        //empty
                    }
                    this.DontFire = false;
                }
                this.IsDirty = true;
            }
            else if ((pName === "SetChoice" || pName === "SetChoiceV") && pValue) {
                //TODO: Find pValue in MyCurrentData. If not add to 
                this.AddChoice(pValue);
                this.DontFire = true;
                this.myChoices.setChoices(this.MyCurrentData, "value", "label", true);
                this.myChoices.setChoiceByValue(pValue.value);
                this.DontFire = false;
                if (pName === "SetChoiceV")
                    super.SetProperty("Value", pValue.value);
                return;
            }
            else if (pName === "LiveOptions" && pValue) {
                super.SetProperty(pName, pValue);
                this.ShowComboPicker();
                return;
            }
            else if (pName === "ScreenFriendlyName" && pValue) {
                let tO = this.GetProperty("LiveOptions");
                if (!tO)
                    tO = pValue.toString();
                else
                    tO += this.MySep + pValue;
                this.SetProperty("LiveOptions", tO);
                this.MyComboBox.value = tO.split(':')[0];
                return;
            }
            else if (pName === "Background" && this.MyComboBox && pValue) {
                this.MyComboBox.style.background = pValue;
            }
            else if (pName === "MainBackground" && this.MyComboDiv && pValue) {
                this.MyComboDiv.parentElement.style.background = pValue;
            }
            else if (pName === "Foreground" && this.MyComboBox && pValue) {
                this.MyComboBox.style.color = pValue;
            }
            else if (pName === "InnerClassName" && this.MyComboBox && pValue) {
                this.MyComboBox.className = pValue;
            }
            else if (pName === "InnerStyle" && this.MyComboBox && pValue) {
                this.MyComboBox.style.cssText = pValue;
            }
            else if (pName === "Options" && this.MyComboDiv) {
                if (!this.CalPicker(pValue)) {
                    this.MyFieldInfo["OptionsLive"] = pValue;
                    if (this.myChoices)
                        this.CreateComboOptions(pValue, null, false);
                    else
                        this.CalculateOption(pValue);
                }
            }
            else if (pName === "Z-Index" && this.MyComboBox) {
                this.MyComboBox.style.zIndex = pValue.toString();
            }
            else if (pName === "Separator") {
                this.MySep = pValue;
            }
            super.SetProperty(pName, pValue);
        }
        HandleLazyLoad(table, pCookie) {
            const tComboControl = pCookie.ComboControl;
            if (table)
                tComboControl.HasLoaded = true;
            tComboControl.CreateComboFromLookup(table, pCookie);
            if (!table || !tComboControl.myChoices) {
                tComboControl.SetProperty("HasChoices", true);
                tComboControl.NeedRefresh = true;
                tComboControl.ApplySkiny();
            }
        }
        CalculateOption(tChoiceOptions) {
            if (this.myChoices)
                return;
            if (this.MyFieldInfo) {
                if (this.MyFieldInfo["OptionsLive"])
                    tChoiceOptions = this.MyFieldInfo["OptionsLive"];
                if (!tChoiceOptions)
                    tChoiceOptions = this.MyFieldInfo["Options"];
                if (!tChoiceOptions)
                    tChoiceOptions = "No Options Specified:CDE_NOP";
            }
            let SortOptions = false;
            if (this.MyFieldInfo) {
                this.MyBaseType = this.MyFieldInfo.Type;
                switch (this.MyFieldInfo.Type) {
                    case cdeNMI.cdeControlType.YesNo:
                        tChoiceOptions = "Yes:Y;No:N";
                        if (cde.CBool(this.GetProperty("IncludeNA")))
                            tChoiceOptions += ";N/A:A";
                        break;
                    case cdeNMI.cdeControlType.TrueFalse:
                        tChoiceOptions = "True;False";
                        break;
                    case cdeNMI.cdeControlType.Month: //Months
                        this.myChoicesOptions.searchEnabled = true;
                        tChoiceOptions = "January;Feburary;March;April;May;June;July;August;September;October;November;December";
                        break;
                    case cdeNMI.cdeControlType.Country:
                        {
                            this.myChoicesOptions.searchEnabled = true;
                            const states = ["United States", "Germany", "Afghanistan", "Albania", "Algeria", "Andorra", "Angola", "Antarctica", "Antigua and Barbuda", "Argentina",
                                "Armenia", "Australia", "Austria", "Azerbaijan", "Bahamas", "Bahrain", "Bangladesh", "Barbados", "Belarus", "Belgium", "Belize", "Benin", "Bermuda",
                                "Bhutan", "Bolivia", "Bosnia and Herzegovina", "Botswana", "Brazil", "Brunei", "Bulgaria", "Burkina Faso", "Burma", "Burundi", "Cambodia", "Cameroon",
                                "Canada", "Cape Verde", "Central African Republic", "Chad", "Chile", "China", "Colombia", "Comoros", "Congo, Democratic Republic",
                                "Congo, Republic of the", "Costa Rica", "Cote d'Ivoire", "Croatia", "Cuba", "Cyprus", "Czech Republic", "Denmark", "Djibouti", "Dominica",
                                "Dominican Republic", "East Timor", "Ecuador", "Egypt", "El Salvador", "Equatorial Guinea", "Eritrea", "Estonia", "Ethiopia", "Fiji", "Finland",
                                "France", "Gabon", "Gambia", "Georgia", "Ghana", "Greece", "Greenland", "Grenada", "Guatemala", "Guinea", "Guinea-Bissau", "Guyana", "Haiti",
                                "Honduras", "Hong Kong", "Hungary", "Iceland", "India", "Indonesia", "Iran", "Iraq", "Ireland", "Israel", "Italy", "Jamaica", "Japan", "Jordan",
                                "Kazakhstan", "Kenya", "Kiribati", "Korea, North", "Korea, South", "Kuwait", "Kyrgyzstan", "Laos", "Latvia", "Lebanon", "Lesotho", "Liberia", "Libya",
                                "Liechtenstein", "Lithuania", "Luxembourg", "Macedonia", "Madagascar", "Malawi", "Malaysia", "Maldives", "Mali", "Malta", "Marshall Islands", "Mauritania",
                                "Mauritius", "Mexico", "Micronesia", "Moldova", "Mongolia", "Morocco", "Monaco", "Mozambique", "Namibia", "Nauru", "Nepal", "Netherlands", "New Zealand",
                                "Nicaragua", "Niger", "Nigeria", "Norway", "Oman", "Pakistan", "Panama", "Papua New Guinea", "Paraguay", "Peru", "Philippines", "Poland", "Portugal",
                                "Qatar", "Romania", "Russia", "Rwanda", "Samoa", "San Marino", " Sao Tome", "Saudi Arabia", "Senegal", "Serbia and Montenegro", "Seychelles",
                                "Sierra Leone", "Singapore", "Slovakia", "Slovenia", "Solomon Islands", "Somalia", "South Africa", "Spain", "Sri Lanka", "Sudan", "Suriname",
                                "Swaziland", "Sweden", "Switzerland", "Syria", "Taiwan", "Tajikistan", "Tanzania", "Thailand", "Togo", "Tonga", "Trinidad and Tobago", "Tunisia",
                                "Turkey", "Turkmenistan", "Uganda", "Ukraine", "United Arab Emirates", "United Kingdom", "Uruguay", "Uzbekistan", "Vanuatu", "Venezuela", "Vietnam",
                                "Yemen", "Zambia", "Zimbabwe"];
                            tChoiceOptions = "";
                            for (const idx in states) {
                                if (tChoiceOptions.length > 0)
                                    tChoiceOptions += ";";
                                tChoiceOptions += states[idx];
                            }
                        }
                        break;
                    default:
                        this.myChoicesOptions.searchEnabled = false;
                        SortOptions = true;
                        break;
                }
            }
            if (tChoiceOptions) {
                if (!this.MyComboDiv) {
                    this.MyComboDiv = document.createElement("div");
                    this.MyComboDiv.className = "cdeComboBox";
                    this.SetElement(this.MyComboDiv);
                }
                if (!this.MyComboBox) {
                    this.MyComboBox = document.createElement("select");
                    this.MyComboBox.id = cde.GuidToString(this.GetProperty("ID"));
                    ;
                    if (this.MyFieldInfo.Type === cdeNMI.cdeControlType.ComboOption) {
                        this.MyComboBox.multiple = true;
                    }
                    this.MyComboDiv.appendChild(this.MyComboBox);
                }
                if (tChoiceOptions.substr(0, 6) === "LOOKUP") {
                    let tParas = tChoiceOptions.split(':');
                    if (tParas.length > 1) {
                        switch (tParas[1]) {
                            case "THINGPICKER":
                                tParas = "LOOKUP:b510837f-3b75-4cf2-a900-d36c19113a13:MyPropertyBag.FriendlyName.Value:cdeMID:MyPropertyBag.DeviceType.Value:FAFA22FF-96AC-42CF-B1DB-7C073053FC39".split(':');
                                break;
                            case "PROPERTYPICKER":
                                this.SetProperty("UXID", this.MyFieldInfo.cdeMID);
                                this.RegisterNMIControl();
                                tParas = null;
                                this.CreateComboOptions("Loading please wait...:CDE_NOP", "CDE_NOP", false);
                                break;
                        }
                    }
                    if (tParas) {
                        if (tParas.length < 3) {
                            this.CreateComboOptions("Lookup definition incomplete:CDE_NOP", "CDE_NOP", false);
                        }
                        else {
                            let tScreenid = this.MyScreenID;
                            if (tParas.length > 5)
                                tScreenid = tParas[5];
                            this.MyScreenID = cde.GuidToString(tScreenid);
                            this.MyTableName = cde.GuidToString(tParas[1]);
                            let tGName = null;
                            if (tParas.length > 4)
                                tGName = tParas[4];
                            if (!this.MyLookup) {
                                this.MyLookup = { ComboControl: this, Content: this.GetProperty("Value"), SrcFld: tParas[2], TgtID: tParas[3], GroupName: tGName };
                            }
                            //this.CreateComboOptions('[{"V":"CDE_LLL","N":"Select to Load Lookup Table"}]', "CDE_LLL", false);
                            if (cdeNMI.MyEngine) {
                                cdeNMI.MyEngine.LoadTableLazy(this.MyScreenID, this.MyTableName, this.HandleLazyLoad, this.MyLookup);
                                return;
                            }
                        }
                    }
                }
                else {
                    if (!this.CalPicker(null))
                        this.CreateComboOptions(tChoiceOptions, this.GetProperty("Value"), SortOptions);
                }
                this.SetProperty("HasChoices", true);
                this.ApplySkiny();
            }
        }
        ApplySkin() {
            this.ApplySkiny();
        }
        OnHideDropDown() {
            const cDropDownEle = this.GetElement().getElementsByClassName("choices__list choices__list--dropdown")[0];
            if (cDropDownEle && window.innerWidth > 1024) {
                cDropDownEle.style.top = null;
                cDropDownEle.style.bottom = null; //"initial";
                cDropDownEle.style.width = null; //"800px";
            }
        }
        OnShowDropDown() {
            const cDropDownEle = this.GetElement().getElementsByClassName("choices__list choices__list--dropdown is-active")[0];
            if (cDropDownEle && window.innerWidth > 1024) {
                if (window.innerHeight - (cDropDownEle.getBoundingClientRect().top - window.scrollY) < 300) {
                    cDropDownEle.style.bottom = "0px";
                    cDropDownEle.style.left = "0px";
                    cDropDownEle.style.width = "100%";
                }
                else {
                    cDropDownEle.style.top = (cDropDownEle.getBoundingClientRect().top - window.scrollY) + "px";
                }
            }
            this.myChoices.setChoices(this.MyCurrentData, "value", "label", true);
            if (this.NeedRefresh)
                this.CalculateOption(null);
            if (this.HasGroups)
                return;
            if (cde.IsNotSet(this.GetProperty("Value"))) {
                if (this.MyLookup !== null)
                    this.myChoices.setChoiceByValue("CDE_LLL");
                else {
                    if (this.GetProperty("Options") && this.GetProperty("Options").substr("CDE_NOP") > 0)
                        this.myChoices.setChoiceByValue("CDE_NOP");
                }
            }
            else
                this.myChoices.setChoiceByValue(this.GetProperty("Value"));
        }
        SetOptions() {
            if (this.MyFieldInfo.Type === cdeNMI.cdeControlType.ComboOption) {
                this.myChoicesOptions.editItems = false;
                this.myChoicesOptions.removeItemButton = true;
                this.myChoicesOptions.maxItemCount = 1;
            }
        }
        ApplySkiny() {
            if (this.myChoices && this.NeedRefresh === false)
                return;
            try {
                if (!this.myChoices && Choices) {
                    this.SetOptions();
                    if (cde.CBool(this.GetProperty("AllowMultiSelect")))
                        this.myChoicesOptions.maxItemCount = -1;
                    if (this.GetProperty("Separator")) {
                        this.myChoicesOptions.delimiter = this.GetProperty("Separator");
                        this.MySep = this.myChoicesOptions.delimiter;
                    }
                    this.myChoices = new Choices(this.MyComboBox, this.myChoicesOptions);
                    this.myChoices.setChoices(this.MyCurrentData, "value", "label", true);
                    if (!this.MyFieldInfo || (this.MyFieldInfo.Flags & 2) === 0) {
                        this.myChoices.disable();
                    }
                    else {
                        this.myChoices.passedElement.element.addEventListener('showDropdown', () => {
                            this.OnShowDropDown();
                        }, false);
                        this.myChoices.passedElement.element.addEventListener('hideDropdown', () => {
                            this.OnHideDropDown();
                        }, false);
                        if (this.MyFieldInfo.Type === cdeNMI.cdeControlType.ComboOption && cde.CBool(this.GetProperty("AllowNewEntry")) === true) {
                            this.myChoices.passedElement.element.addEventListener('search', (event) => {
                                const tRealVal = event.detail.value;
                                //const myC = this.MyCurrentData;
                                const tCI = new cdeNMI.TheComboOption();
                                tCI.label = tRealVal;
                                tCI.value = tRealVal;
                                //myC.push(tCI);
                                this.myChoices.setChoices([tCI], "value", "label", true);
                            }, false);
                        }
                        this.myChoices.passedElement.element.addEventListener('removeItem', (event) => {
                            if (this.DontFire === true || !cde.CBool(this.GetProperty("AllowMultiSelect")))
                                return;
                            const tRealVal = event.detail.value;
                            this.ComboUpdateValue(tRealVal, true);
                        }, false);
                        this.myChoices.passedElement.element.addEventListener('choice', (event) => {
                            if (this.DontFire === true)
                                return;
                            const tRealVal = event.detail.choice.value;
                            if (this.GetProperty("Value") !== tRealVal) {
                                if (!this.ComboUpdateValue(tRealVal)) {
                                    event.detail.choice.disabled = true;
                                    event.preventDefault();
                                    return false;
                                }
                            }
                        }, false);
                    }
                }
                else {
                    this.myChoices.clearChoices();
                    this.myChoices.setChoices(this.MyCurrentData, "value", "label", true);
                }
                this.SetToDefault(true);
            }
            catch (e) {
                cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", this.ControlText + ":ApplySkiny", "Exception :" + e);
            }
        }
        SetTE(pTE) {
            super.SetTE(pTE);
            if (this.MyTE && cde.CBool(this.GetProperty("NoTE")) === true) {
                this.MyTE.DontHideLabel = true;
                this.MyTE.MyTELabel.SetProperty("Visibility", true);
                this.MyTE.MyTELabel.SetProperty("PixelHeight", 18);
                this.MyTE.MyTELabel.SetProperty("LabelClassName", "cdeTileEntryLabelSmall");
            }
        }
        CalPicker(tLO) {
            if (!tLO)
                tLO = this.GetProperty("OptionsLive");
            if (!tLO)
                tLO = this.GetProperty("Options");
            if (tLO && tLO.startsWith("SCREENPICKER")) {
                let tLst = tLO.substr(13);
                if (cdeNMI.MyScreenManager)
                    tLst += cdeNMI.MyScreenManager.GetScreenList();
                super.SetProperty("OptionsLive", tLst);
                super.SetProperty("LiveOptions", tLst);
                this.CreateComboOptions(tLst, this.GetProperty("Value"), true);
                this.ApplySkiny();
                return true;
            }
            return false;
        }
        CreateComboOptions(pChoiceOptions, pContent, SortOptions) {
            if (!pChoiceOptions)
                return;
            this.MyCurrentData = new Array();
            this.HasGroups = false;
            let tOpt;
            let i;
            if (pChoiceOptions.substr(0, 1) === "[") {
                const tJOpgs = JSON.parse(pChoiceOptions);
                for (i = 0; i < tJOpgs.length; i++) {
                    tOpt = new cdeNMI.TheComboOption;
                    tOpt.value = tJOpgs[i].V;
                    let tPrefix = "";
                    if (tOpt.value.startsWith("CDE_"))
                        tPrefix = "===> ";
                    if (tJOpgs[i].G || this.HasGroups) {
                        if (tJOpgs[i].G) {
                            tOpt.group = tJOpgs[i].G;
                            this.HasGroups = true;
                        }
                        else {
                            tOpt.group = "No Group";
                        }
                    }
                    if (tJOpgs[i].H)
                        tOpt.html = tJOpgs[i].H;
                    else
                        tOpt.label = tPrefix + tJOpgs[i].N.replace('_', ' ');
                    tOpt.disabled = cde.CBool(tJOpgs[i].D);
                    this.MyCurrentData.push(tOpt);
                }
            }
            else {
                const tGroups = pChoiceOptions.split(';:;');
                if (tGroups.length > 1) {
                    this.HasGroups = true;
                    tGroups.sort();
                }
                let tOps;
                for (let tGrp = 0; tGrp < tGroups.length; tGrp++) {
                    let tOption = tGroups[tGrp];
                    if (this.HasGroups) {
                        tOps = tGroups[tGrp].split(this.MySep);
                        if (tOps.length > 1)
                            tOption = tOps[1];
                    }
                    tOps = tOption.split(this.MySep);
                    if (SortOptions)
                        tOps.sort();
                    for (i = 0; i < tOps.length; i++) {
                        const tOptVal = tOps[i].split(':');
                        tOpt = new cdeNMI.TheComboOption;
                        if (tOptVal.length > 1)
                            tOpt.value = tOptVal[1];
                        else
                            tOpt.value = tOptVal[0];
                        if (this.HasGroups)
                            tOpt.group = tOps[0];
                        tOpt.label = tOptVal[0].replace('_', ' ');
                        this.MyCurrentData.push(tOpt);
                    }
                }
            }
            if (this.HasGroups === true) {
                this.BuildGroups();
            }
        }
        BuildGroups() {
            let id = 1;
            const newData = [];
            for (let i = 0; i < this.MyCurrentData.length; i++) {
                const tOpt = this.MyCurrentData[i];
                const tGroups = newData.filter(e => e.label === tOpt.group);
                if (tGroups.length > 0) {
                    tGroups[0].choices.push(tOpt);
                }
                else {
                    const tNewGroup = new cdeNMI.TheComboOption();
                    //tNewGroup.disabled = true;
                    tNewGroup.id = id;
                    id++;
                    tNewGroup.value = tOpt.group;
                    tNewGroup.label = tOpt.group;
                    tNewGroup.choices = [];
                    tNewGroup.choices.push(tOpt);
                    newData.push(tNewGroup);
                }
            }
            this.MyCurrentData = newData;
        }
        CreateComboFromLookup(pMyStorageMirror, pCookie) {
            let tArray = [];
            const tComboControl = pCookie.ComboControl;
            if (!pMyStorageMirror) {
                if (pCookie.GroupName)
                    tComboControl.CreateComboOptions('[{"G":"Other Options...","V":"CDE_LLL","N":"Loading, please wait..."}]', "CDE_LLL", false); //"G":"Other Options...",
                else
                    tComboControl.CreateComboOptions('[{"V":"CDE_LLL","N":"Loading, please wait..."}]', "CDE_LLL", false); //"G":"Other Options...",
                if (!this.myChoices)
                    this.ComboUpdateValue("CDE_LLL");
                return;
            }
            let tOpt;
            try {
                const tGroupLookup = this.GetProperty("GroupLookup");
                const tFilter = this.GetProperty("Filter"); //"Platform=2"; // 
                let tFilterFld = null;
                let tFilterVal = [];
                if (tFilter && tFilter.split('=').length > 1) {
                    tFilterFld = tFilter.split('=')[0];
                    const tFVal = tFilter.split('=')[1];
                    if (tFVal.substr(0, 1) === "[")
                        tFilterVal = JSON.parse(tFVal);
                    else
                        tFilterVal[0] = tFVal;
                }
                tComboControl.MyCurrentData = new Array();
                if (pCookie.GroupName) { //Has Groups
                    tComboControl.HasGroups = true;
                }
                let row;
                for (row = 0; row < pMyStorageMirror.length; row++) {
                    const tRow = pMyStorageMirror[row];
                    if (tRow[tFilterFld] && tFilterVal.length > 0) {
                        let tFound = false;
                        for (let iii = 0; iii < tFilterVal.length; iii++) {
                            if (tRow[tFilterFld] === tFilterVal[iii]) {
                                tFound = true;
                                break;
                            }
                        }
                        if (!tFound)
                            continue;
                    }
                    if (tComboControl.HasGroups) {
                        const tGroup = cdeNMI.GetFldContentByName(tRow, pCookie.GroupName, false);
                        if (tGroup && tGroup !== "")
                            tArray.push(tRow);
                    }
                    else {
                        const tName = cdeNMI.GetFldContentByName(tRow, pCookie.SrcFld, false);
                        if (tName && tName !== "")
                            tArray.push(tRow);
                    }
                }
                if (tComboControl.HasGroups)
                    tArray = cdeNMI.SortArrayByProperty(tArray, pCookie.GroupName, false, false);
                else
                    tArray = cdeNMI.SortArrayByProperty(tArray, pCookie.SrcFld, false, false);
                for (row = 0; row < tArray.length; row++) {
                    tOpt = new cdeNMI.TheComboOption();
                    if (tComboControl.HasGroups) {
                        let tGR = cdeNMI.GetFldContentByName(tArray[row], pCookie.GroupName, false);
                        if (tGroupLookup)
                            tGR = this.GetTextFromOptions(tGR, tGroupLookup);
                        tOpt.group = tGR;
                    }
                    const tText = cdeNMI.GetFldContentByName(tArray[row], pCookie.SrcFld, false);
                    let tVal = tText;
                    if (pCookie.TgtID)
                        tVal = cdeNMI.GetFldContentByName(tArray[row], pCookie.TgtID, false);
                    if (!cde.IsNotSet(tVal))
                        tOpt.value = tVal;
                    tOpt.label = tText;
                    tComboControl.MyCurrentData.push(tOpt);
                }
            }
            catch (eee) {
                cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", this.ControlText + ":CreateComboFromLookup:AssembleData", eee);
            }
            if (cde.CBool(tComboControl.GetProperty("RefreshOnLoad")) !== true) {
                tOpt = new cdeNMI.TheComboOption();
                if (tComboControl.HasGroups) {
                    tOpt.group = "Other Options...";
                }
                tOpt.value = 'CDE_LLL';
                tOpt.label = "--- Select to Load Lookup Table ---";
                tComboControl.MyCurrentData.push(tOpt);
            }
            if (cde.CBool(tComboControl.GetProperty("AddEmptyEntry")) === true) {
                tOpt = new cdeNMI.TheComboOption();
                if (tComboControl.HasGroups) {
                    tOpt.group = "Other Options...";
                }
                tOpt.value = 'CDE_NOP';
                tOpt.label = "- empty -";
                tComboControl.MyCurrentData.push(tOpt);
            }
            if ((tComboControl.MyFieldInfo.Flags & 2) === 0)
                tComboControl.MyComboBox.disabled = true;
            if (tComboControl.myChoices) {
                try {
                    tComboControl.myChoices.setChoices(tComboControl.MyCurrentData, "value", "label", true);
                }
                catch (eee) {
                    cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", this.ControlText + ":CreateComboFromLookup", eee);
                    tComboControl.NeedRefresh = true;
                    tComboControl.ApplySkiny();
                }
            }
        }
        GetTextFromOptions(pContent, pOptions) {
            const tOps = pOptions.split(this.MySep);
            for (let i = 0; i < tOps.length; i++) {
                const tOptVal = tOps[i].split(':');
                if (tOptVal.length > 1) {
                    if (pContent === tOptVal[1] || ((!pContent || pContent === '') && tOptVal[1] === '0'))
                        return tOptVal[0];
                }
                else {
                    if (pContent === tOptVal[0])
                        return tOptVal[0];
                }
            }
            return pContent;
        }
        ShowComboPicker() {
            if (this.MyFieldInfo && this.MyFieldInfo["OptionsLive"]) {
                let tChoiceOptions = this.MyFieldInfo["OptionsLive"];
                const tParas = tChoiceOptions.split(':');
                if (tParas.length > 1) {
                    switch (tParas[1]) {
                        case "PROPERTYPICKER":
                            tChoiceOptions = this.GetProperty("LiveOptions");
                            if (!tChoiceOptions) {
                                if (tParas[2].length > 0) {
                                    if (cdeNMI.MyEngine) {
                                        cdeNMI.MyEngine.PublishToNMI('NMI_GET_DATA:PROPERTYPICKER:' + this.GetProperty("ID") + ':' + this.GetProperty("UXID") + ':' + tParas[2], '', this.MyFieldInfo ? this.MyFieldInfo.cdeN : null);
                                        tChoiceOptions = "loading ... please wait";
                                    }
                                    else {
                                        tChoiceOptions = "No NMI Engine available - cannot load";
                                    }
                                }
                                else {
                                    tChoiceOptions = "You have to Select a Thing first";
                                }
                            }
                            else {
                                this.CreateComboOptions(tChoiceOptions, this.GetProperty("Value"), true);
                                this.NeedRefresh = true;
                                this.ApplySkiny();
                            }
                            break;
                    }
                }
            }
            try {
                this.myChoices.showDropdown();
            }
            catch (e) {
                cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", this.ControlText + ":ShowComboPicker", e);
            }
        }
        ComboSelect(pEle) {
            this.ComboUpdateValue(pEle.value);
        }
        ComboUpdateValue(pValue, DoRemove) {
            if (pValue === "CDE_PPP") {
                this.SetProperty("LiveOptions", null);
                this.ShowComboPicker();
            }
            else if (pValue === "CDE_LLL") {
                this.NeedRefresh = true;
                if (cdeNMI.MyEngine)
                    cdeNMI.MyEngine.PublishToNMI('NMI_GET_DATA:' + this.MyTableName + ':CMyTable:' + this.MyTableName + ':' + this.MyScreenID + ":false:true", '', this.MyFieldInfo ? this.MyFieldInfo.cdeN : null);
            }
            else {
                if (cde.CBool(this.GetProperty("AllowMultiSelect"))) {
                    const allVal = this.myChoices.getValue(true);
                    if (!DoRemove)
                        allVal.push(pValue);
                    pValue = allVal.join(this.MySep);
                    if (pValue.length === 0)
                        pValue = null;
                }
                else if (DoRemove === true) {
                    pValue = null;
                }
                const tOldVal = this.GetProperty("Value");
                if (tOldVal !== pValue) {
                    //if (cde.CBool(this.GetProperty("AllowMultiSelect")) && tOldVal) {
                    //    const tC = tOldVal.split(this.MySep);
                    //    if (tC.length > 0 && tC.filter(e => e === pValue).length>0) {
                    //        return;
                    //    }
                    //}
                    //else
                    this.SetProperty("Value", pValue);
                    return true;
                }
            }
            return false;
        }
    }
    cdeNMI.ctrlComboBox = ctrlComboBox;
})(cdeNMI || (cdeNMI = {}));
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
var cdeNMI;
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
(function (cdeNMI) {
    class ctrlComboLookup extends cdeNMI.ctrlComboBox {
        constructor(pTRF) {
            super(pTRF);
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            if (this.MyBaseType === cdeNMI.cdeControlType.BaseControl) {
                this.MyBaseType = cdeNMI.cdeControlType.ComboLookup;
                this.ControlText = "ctrlComboLookup";
            }
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            return true;
        }
        CalculateOption() {
            if (this.myChoices)
                return;
            if (!this.MyComboDiv) {
                this.MyComboDiv = document.createElement("div");
                this.MyComboDiv.className = "cdeComboBox";
                this.SetElement(this.MyComboDiv);
            }
            if (!this.MyComboBox) {
                this.MyComboBox = document.createElement("select");
                this.MyComboBox.id = cde.GuidToString(this.GetProperty("ID"));
                ;
                if (this.MyFieldInfo.Type === cdeNMI.cdeControlType.ComboOption) {
                    this.MyComboBox.multiple = true;
                }
                this.MyComboDiv.appendChild(this.MyComboBox);
            }
            if (this.GetSetting("GroupFld"))
                this.HasGroups = true;
            //var tParas: string[] = "LOOKUP:b510837f-3b75-4cf2-a900-d36c19113a13:MyPropertyBag.FriendlyName.Value:cdeMID:MyPropertyBag.DeviceType.Value:FAFA22FF-96AC-42CF-B1DB-7C073053FC39".split(':');
            this.MyTableName = cde.GuidToString(this.GetSetting("StorageTarget"));
            if (!this.MyLookup) {
                this.MyLookup = { ComboControl: this, Content: this.GetProperty("Value"), SrcFld: this.GetProperty("NameFld"), TgtID: this.GetSetting("ValueFld"), GroupName: this.GetSetting("GroupFld") };
            }
            if (cdeNMI.MyEngine) {
                let tScreenid = this.MyScreenID;
                if (this.GetSetting("ModelID"))
                    tScreenid = this.GetSetting("ModelID");
                this.MyScreenID = tScreenid;
                cdeNMI.MyEngine.LoadTableLazy(tScreenid, this.MyTableName, this.HandleLazyLoad, this.MyLookup);
                return;
            }
            this.SetProperty("HasChoices", true);
            this.ApplySkiny();
        }
        OnShowDropDown() {
            super.OnShowDropDown();
            try {
                if (!this.HasLoaded || cde.CBool(this.GetProperty("RefreshOnLoad")) === true)
                    this.ComboUpdateValue("CDE_LLL");
            }
            catch (ee) {
                cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", this.ControlText + ":onBeforeShow", "Exception :" + ee);
            }
        }
        SetOptions() {
            this.myChoicesOptions.editItems = true;
            this.myChoicesOptions.searchEnabled = true;
            this.myChoicesOptions.removeItemButton = true;
            this.myChoicesOptions.maxItemCount = 1;
            this.myChoicesOptions.searchResultLimit = 100;
        }
    }
    cdeNMI.ctrlComboLookup = ctrlComboLookup;
})(cdeNMI || (cdeNMI = {}));
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
var cdeNMI;
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
(function (cdeNMI) {
    class ctrlPropertyPicker extends cdeNMI.ctrlComboLookup {
        constructor(pTRF) {
            super(pTRF);
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            if (this.MyBaseType === cdeNMI.cdeControlType.BaseControl) {
                this.ControlText = "ctrlPropertyPicker";
                this.RefreshCombo = '[{"V":"CDE_NOP","N":"loading...please wait"}]';
                this.MyBaseType = cdeNMI.cdeControlType.PropertyPicker;
            }
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            return true;
        }
        SetProperty(pName, pValue) {
            if (pName === "LiveOptions" && pValue) {
                super.SetProperty(pName, pValue);
                this.LoadComboContent(this.DoShow);
                return;
            }
            super.SetProperty(pName, pValue);
        }
        CalculateOption() {
            if (this.myChoices)
                return;
            if (!this.MyComboDiv) {
                this.MyComboDiv = document.createElement("div");
                this.MyComboDiv.className = "cdeComboBox";
                this.SetElement(this.MyComboDiv);
            }
            if (!this.MyComboBox) {
                this.MyComboBox = document.createElement("select");
                this.MyComboBox.id = cde.GuidToString(this.GetProperty("ID"));
                ;
                if (cde.CBool(this.GetProperty("AllowMultiSelect"))) {
                    this.MyComboBox.multiple = true;
                }
                this.MyComboDiv.appendChild(this.MyComboBox);
            }
            this.RegisterNMIControl();
            this.CreateComboOptions(this.RefreshCombo, "CDE_NOP", false);
            this.SetProperty("HasChoices", true);
            this.ApplySkiny();
        }
        OnShowDropDown() {
            super.OnShowDropDown();
            try {
                if (!this.GetProperty("LiveOptions") || this.GetProperty("LiveOptions").substr(0, 15) === '[{"V":"CDE_NOP"')
                    this.LoadComboContent(false);
            }
            catch (ee) {
                cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", this.ControlText + ":onBeforeShow", "Exception :" + ee);
            }
        }
        LoadComboContent(bForceShow) {
            const tChoiceOptions = this.GetProperty("LiveOptions");
            if (!tChoiceOptions) {
                const tThingID = this.GetThingID();
                if ((tThingID === null || tThingID === void 0 ? void 0 : tThingID.length) > 0) {
                    if (cdeNMI.MyEngine) {
                        cdeNMI.MyEngine.PublishToNMI('NMI_GET_DATA:PROPERTYPICKER:' + this.GetProperty("ID") + ':' + this.GetProperty("UXID") + ':' + tThingID, '', this.MyFieldInfo ? this.MyFieldInfo.cdeN : null);
                        if (bForceShow)
                            this.UpdatePicker(bForceShow);
                    }
                    else {
                        this.DoShow = bForceShow;
                        this.SetProperty("LiveOptions", '[{"V":"CDE_NOP","N":"No NMI Engine available - cannot load"}]');
                    }
                }
                else {
                    this.DoShow = bForceShow;
                    this.SetProperty("LiveOptions", '[{"V":"CDE_NOP","N":"You have to Select a Thing first"}]');
                }
            }
            else {
                this.CreateComboOptions(tChoiceOptions, this.GetProperty("Value"), true);
                this.UpdatePicker(bForceShow);
            }
            this.DoShow = false;
        }
        UpdatePicker(bForceShow) {
            this.NeedRefresh = true;
            this.ApplySkiny();
            if (bForceShow)
                this.ShowComboPicker();
        }
        ComboUpdateValue(pValue, DoRemove) {
            if (pValue === "CDE_PPP") {
                this.SetProperty("LiveOptions", null);
                this.LoadComboContent(false);
            }
            else {
                return super.ComboUpdateValue(pValue, DoRemove);
            }
            return false;
        }
        GetThingID() {
            const tFld = this.GetProperty("ThingFld");
            if (tFld === 0)
                return null;
            let tCtrl;
            if (this.MyTE && this.MyTE.MyDataView)
                tCtrl = this.MyTE.MyDataView.GetControlByFldNo(this.MyTRF.RowNo, tFld);
            else {
                if (this.MyDataView)
                    tCtrl = this.MyDataView.GetControlByFldNo(this.MyTRF.RowNo, tFld);
            }
            if (!tCtrl)
                return null;
            return tCtrl.GetProperty("Value");
        }
    }
    cdeNMI.ctrlPropertyPicker = ctrlPropertyPicker;
})(cdeNMI || (cdeNMI = {}));
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
var cdeNMI;
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
(function (cdeNMI) {
    class ctrlDeviceTypePicker extends cdeNMI.ctrlPropertyPicker {
        constructor(pTRF) {
            super(pTRF);
            this.MyThingFriendlyName = null;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.RefreshCombo = '[{"V":"CDE_NOP","N":"loading...please wait"}]';
            this.MyBaseType = cdeNMI.cdeControlType.DeviceTypePicker;
            this.ControlText = "ctrlDeviceTypePicker";
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            return true;
        }
        LoadComboContent(bForceShow) {
            const tChoiceOptions = this.GetProperty("LiveOptions");
            if (!tChoiceOptions) {
                if (cdeNMI.MyEngine) {
                    let tFilter = "";
                    if (this.GetProperty("Filter"))
                        tFilter = cdeNMI.GenerateFinalString(this.GetProperty("Filter"), null, this.MyTRF);
                    const tRemotes = cde.CBool(this.GetProperty("IncludeRemotes"));
                    cdeNMI.MyEngine.PublishToNMI('NMI_GET_DATA:DEVICETYPEPICKER:' + this.GetProperty("ID") + ':' + this.GetProperty("UXID") + ';76;' + this.MyFieldInfo.FldOrder + ':' + tRemotes + ':' + tFilter, '', this.MyFieldInfo ? this.MyFieldInfo.cdeN : null);
                }
                else {
                    this.CreateComboOptions('[{"V":"CDE_NOP","N":"No DeviceType available - nothing to show"}]', "CDE_NOP", false);
                    this.UpdatePicker(bForceShow);
                }
            }
            else {
                this.CreateComboOptions(tChoiceOptions, this.GetProperty("Value"), true);
                this.UpdatePicker(bForceShow);
            }
        }
    }
    cdeNMI.ctrlDeviceTypePicker = ctrlDeviceTypePicker;
    class ctrlThingPicker extends cdeNMI.ctrlPropertyPicker {
        constructor(pTRF) {
            super(pTRF);
            this.MyThingFriendlyName = null;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.RefreshCombo = '[{"G":"Other Options...","V":"CDE_PPP","N":"Please select..."}]';
            this.MyBaseType = cdeNMI.cdeControlType.ThingPicker;
            this.ControlText = "ctrlThingPicker";
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            return true;
        }
        SetProperty(pName, pValue) {
            if (pName === "Value" || pName === "iValue") {
                if (this.GetProperty("Value") !== pValue)
                    this.MyThingFriendlyName = null;
                this.GetNameFromValue(pValue);
                if (this.MyThingFriendlyName) {
                    const tC = new cdeNMI.TheComboOption();
                    tC.value = pValue;
                    tC.label = this.MyThingFriendlyName;
                    pValue = tC;
                    pName = "SetChoiceV";
                }
            }
            if (pName === "ThingFriendlyName" && pValue) {
                const newFriendlyName = this.ReplaceNodeIdInFriendlyNameWithNodeName(pValue);
                this.MyThingFriendlyName = newFriendlyName;
                const tC = new cdeNMI.TheComboOption();
                tC.value = this.GetProperty("Value");
                tC.label = this.GetNameFromValue(newFriendlyName);
                pValue = tC;
                pName = "SetChoice";
            }
            if (pName === "LiveOptions" && pValue) {
                // When a thinkpicker has remote things, the owner nodeid gets sent with the friendly name
                // NMI.JS maintains a list of all nodes it can see, so the node name replacement best happens here, rather than on the relay
                try {
                    const tJOpgs = JSON.parse(pValue);
                    let changed = false;
                    for (let i = 0; i < tJOpgs.length; i++) {
                        tJOpgs[i].N = this.ReplaceNodeIdInFriendlyNameWithNodeName(tJOpgs[i].N);
                        changed = true;
                    }
                    if (changed) {
                        super.SetProperty(pName, JSON.stringify(tJOpgs));
                        return;
                    }
                }
                catch (eee) {
                    cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "ctrlThingPicker:SetProperty LiveOptions", eee);
                }
                super.SetProperty(pName, pValue);
                return;
            }
            super.SetProperty(pName, pValue);
        }
        ReplaceNodeIdInFriendlyNameWithNodeName(pVal) {
            // Syntax: <friendlyName> on (<cdeN guid with dashes 36 characters>)
            let retVal = pVal;
            if (pVal.length > 41 && pVal.endsWith(")") && pVal.substring(pVal.length - 41, pVal.length - 37) === "on (") {
                const cdeN = pVal.substring(pVal.length - 37, pVal.length - 1);
                let nodeName = cdeNMI.MyEngine.GetKnownNodeName(cdeN);
                if (nodeName && nodeName.length > 0) {
                    retVal = pVal.substring(0, pVal.length - 41) + "on " + nodeName;
                }
            }
            return retVal;
        }
        GetNameFromValue(pVal) {
            if (!pVal || pVal.length === 0)
                return pVal;
            if (!this.MyThingFriendlyName) {
                if (cdeNMI.MyEngine) {
                    cdeNMI.MyEngine.PublishToNMI('NMI_GET_DATA:THINGRESOLVE:' + this.GetProperty("ID") + ':' + this.GetProperty("UXID") + ';63;' + this.MyFieldInfo.FldOrder + ':' + pVal, '', this.MyFieldInfo ? this.MyFieldInfo.cdeN : null);
                }
                return pVal;
            }
            else {
                return this.MyThingFriendlyName;
            }
        }
        SetThingFriendlyName(pValue) {
            if (!this.GetProperty("LiveOptions"))
                return;
            try {
                const tJOpgs = JSON.parse(this.GetProperty("LiveOptions"));
                for (let i = 0; i < tJOpgs.length; i++) {
                    if (tJOpgs[i].V === pValue) {
                        this.SetProperty("ThingFriendlyName", tJOpgs[i].N);
                        return;
                    }
                }
            }
            catch (eee) {
                cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "ctrlThingPicker:GetFriendlyName", eee);
            }
        }
        LoadComboContent(bForceShow) {
            const tChoiceOptions = this.GetProperty("LiveOptions");
            if (!tChoiceOptions) {
                if (cdeNMI.MyEngine) {
                    const tEngs = cde.CBool(this.GetProperty("IncludeEngines"));
                    const tRemotes = cde.CBool(this.GetProperty("IncludeRemotes"));
                    let tFilter = "";
                    if (this.GetProperty("Filter"))
                        tFilter = cdeNMI.GenerateFinalString(this.GetProperty("Filter"), null, this.MyTRF);
                    cdeNMI.MyEngine.PublishToNMI('NMI_GET_DATA:THINGPICKER:' + this.GetProperty("ID") + ':' + this.GetProperty("UXID") + ';63;' + this.MyFieldInfo.FldOrder + ':' + tEngs + ':' + tRemotes + ':' + tFilter, '', this.MyFieldInfo ? this.MyFieldInfo.cdeN : null);
                }
                else {
                    this.CreateComboOptions('[{"G":"Other Options...","V":"CDE_NOP","N":"No NMI Engine available - cannot load"}]', "CDE_NOP", false);
                    this.UpdatePicker(bForceShow);
                }
            }
            else {
                this.CreateComboOptions(tChoiceOptions, this.GetProperty("Value"), true);
                this.UpdatePicker(bForceShow);
            }
        }
        ComboUpdateValue(pValue, DoRemove) {
            if (pValue === "CDE_PPP") {
                this.SetProperty("LiveOptions", null);
                this.LoadComboContent(false);
            }
            else {
                if (!DoRemove) {
                    this.SetThingFriendlyName(pValue);
                    return super.ComboUpdateValue(pValue, DoRemove);
                }
            }
            return false;
        }
    }
    cdeNMI.ctrlThingPicker = ctrlThingPicker;
})(cdeNMI || (cdeNMI = {}));
// SPDX-FileCopyrightText: 2009-2023 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
var cdeNMI;
// SPDX-FileCopyrightText: 2009-2023 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
(function (cdeNMI) {
    /**
* Creates a pin button that can be used to visualize pin/unpinned elements
*
* (4.1 Ready!)
*/
    class ctrlPinButton extends cdeNMI.TheNMIBaseControl {
        constructor(pTRF) {
            super(null, pTRF);
            this.divPin = null;
            this.rootDiv = null;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.PinButton;
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            this.rootDiv = document.createElement("div");
            this.rootDiv.style.position = "relative";
            this.PreventDefault = true;
            this.SetElement(this.rootDiv, true);
            this.divPin = document.createElement("div");
            this.rootDiv.appendChild(this.divPin);
            this.RegisterEvent("PointerUp", (pControl, evt, pPointer) => {
                this.SetProperty("Value", !this.GetProperty("Value"));
                if (this.GetProperty("OnClick"))
                    this.GetProperty("OnClick")(this.GetProperty("Value"), evt, pPointer);
            });
            return true;
        }
        SetProperty(pName, pValue) {
            if (pName === "ClassName" && this.divPin) {
                this.divPin.className = pValue;
                return;
            }
            else if (pName === "Top" && this.divPin) {
                pValue = cde.CInt(pValue);
                this.divPin.style.top = pValue + "px";
                return;
            }
            else if (pName === "Foreground" && this.divPin) {
                this.divPin.style.color = pValue;
                return;
            }
            else if (pName === "Right" && this.divPin) {
                pValue = cde.CInt(pValue);
                this.divPin.style.right = pValue + "px";
                return;
            }
            else if (pName === "OnPointerDown" && this.divPin) {
                if (pValue) {
                    this.PreventManipulation = true;
                    this.HookEvents(false);
                    this.RegisterEvent("PointerDown", pValue);
                }
            }
            else if (pName === "Content") {
                this.divPin.innerHTML = pValue;
                return;
            }
            super.SetProperty(pName, pValue);
        }
    }
    cdeNMI.ctrlPinButton = ctrlPinButton;
    /**
* Creates a touch overlay ontop of the screen but attached to another control specified by pTargetControl
* this is used for entries in Tables or other inline controls
*
*
* (4.1 Ready!)
*/
    class ctrlTouchOverlay extends cdeNMI.TheNMIBaseControl {
        constructor(pTRF) {
            super(null, pTRF);
            this.divTiles = null;
            this.CurrentControl = null;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.TouchOverlay;
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            this.CurrentControl = pTargetControl;
            this.divTiles = document.createElement('div');
            this.divTiles.className = "cdeOverlay";
            this.SetElement(this.divTiles, false);
            this.HookEvents(false);
            return true;
        }
    }
    cdeNMI.ctrlTouchOverlay = ctrlTouchOverlay;
    /**
* Creates a dynamic control from an HTML5 snipplet with subcontrols
*
* (4.1 Ready!) TODO: Verify with FacePlate containing Macros
*/
    class ctrlFacePlate extends cdeNMI.TheNMIBaseControl {
        constructor() {
            super(null, null);
            this.mCtrlDIV = null;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID); //sets all the properties that are coming from the plugin on the elements
            if (cde.CBool(this.GetSetting("IsPlainHTML")) === true && pTargetControl) {
                this.SetElement(pTargetControl.GetContainerElement());
            }
            else {
                this.mCtrlDIV = new cdeNMI.ctrlTileGroup();
                this.mCtrlDIV.InitControl(pTargetControl);
                this.mCtrlDIV.MyRootElement.style.width = "inherit";
                this.mCtrlDIV.MyRootElement.style.height = "inherit";
                this.SetElement(this.mCtrlDIV.GetElement());
            }
            return true;
        }
        SetProperty(pName, pValue) {
            super.SetProperty(pName, pValue);
            if (!this.GetContainerElement())
                return;
            if (pName === "HTML") {
                cdeNMI.cdeParseHTML(this, this.MyTRF, pValue);
            }
            else if (pName === "HTMLUrl") {
                cdeNMI.MyEngine.cdeGetResource(pValue, (cookie, data) => {
                    if (data && !data.startsWith("ERR:")) {
                        cdeNMI.cdeParseHTML(this, this.MyTRF, data);
                        this.FireEvent(true, "OnIsLoaded", true);
                    }
                });
            }
            else if (pName === "Background") {
                this.mCtrlDIV.GetElement().style.background = pValue;
            }
        }
    }
    cdeNMI.ctrlFacePlate = ctrlFacePlate;
    /**
* Creates a area that allows to upload files to the owner Service (Plugin) and Relay
*
* (4.1 Ready!)
*/
    class ctrlDropUploader extends cdeNMI.TheNMIBaseControl {
        constructor(pTRF) {
            super(null, pTRF);
            this.mFileList = [];
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.DropUploader;
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            this.mContentTarget = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileGroup).Create(pTargetControl, { TRF: this.MyTRF });
            this.mContentTarget.SetProperty("ClassName", "ctrlDropUploader");
            this.mContentTarget.SetInitialSize(0);
            this.mZoomImg = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.Picture).Create(this.mContentTarget);
            this.mZoomImg.SetProperty("Visibility", false);
            this.mZoomImg.SetProperty("Style", "width:100%;height:100%");
            this.mInfo = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SmartLabel).Create(this.mContentTarget, { PreInitBag: ["Element=p"] });
            const holder = this.mContentTarget.GetElement();
            holder.ondragover = () => {
                this.mContentTarget.GetElement().className = 'ctrlDropUploaderHover';
                return false;
            };
            holder.ondragend = () => {
                this.mContentTarget.GetElement().className = 'ctrlDropUploader';
                return false;
            };
            holder.ondragleave = () => {
                this.mContentTarget.GetElement().className = 'ctrlDropUploader';
                return false;
            };
            holder.ondrop = (e) => {
                e.stopPropagation();
                e.preventDefault();
                this.mContentTarget.GetElement().className = 'ctrlDropUploader';
                this.ProcessFiles(e.dataTransfer.files);
            };
            this.SetElement(this.mContentTarget.GetElement());
            return true;
        }
        SetProperty(pName, pValue) {
            if (pName === "iValue" || pName === "Value") {
                if (this.mZoomImg && (pValue.toLowerCase().indexOf(".jpg") > 0 || pValue.toLowerCase().indexOf(".jpeg") > 0 || pValue.toLowerCase().indexOf(".png") > 0)) {
                    this.mZoomImg.SetProperty("Visibility", true);
                    this.mZoomImg.SetProperty("Source", pValue);
                    this.mInfo.SetProperty("Visibility", false);
                }
                else {
                    this.mInfo.SetProperty("Visibility", true);
                    this.mInfo.GetElement().innerHTML = pValue;
                }
            }
            else if (pName === "Title") {
                this.mInfo.SetProperty("iValue", pValue);
            }
            else if (pName === "Foreground" && this.mContentTarget) {
                this.mContentTarget.SetProperty("Foreground", pValue);
            }
            else if (pName === "Background" && this.mContentTarget) {
                this.mContentTarget.SetProperty("Background", pValue);
            }
            else {
                super.SetProperty(pName, pValue);
            }
        }
        UploadNext() {
            if (this.mFileList.length) {
                const nextFile = this.mFileList.shift();
                let tFileSize = this.GetProperty("MaxFileSize");
                if (!tFileSize) {
                    tFileSize = 512000;
                }
                if (tFileSize > 500000000)
                    tFileSize = 500000000;
                if (nextFile.size >= tFileSize) { // 262144) { // 256kb
                    this.mInfo.GetElement().innerHTML += "File " + nextFile.name + " size " + nextFile.size + " too big - Max: " + tFileSize;
                    this.OnComplete(nextFile.size);
                }
                else {
                    this.mInfo.GetElement().innerHTML = "Reading: " + nextFile.name;
                    this.UploadFile(nextFile, status);
                }
            }
            else {
                this.mContentTarget.GetElement().className = 'ctrlDropUploader';
            }
        }
        OnComplete(size) {
            this.UploadNext();
        }
        UploadFile(file, status) {
            const reader = new FileReader();
            this.mInfo.GetElement().innerHTML = "Uploading: " + file.name;
            ;
            reader.onload = (evt) => {
                const tres = reader.result;
                if (this.MyEngineName) {
                    let tFileName = file.name;
                    let tDir = this.GetProperty("TargetDir");
                    if (tDir) {
                        if (tDir.substring(tDir.length - 1) !== '\\')
                            tDir += "\\";
                        tFileName = tDir + tFileName;
                    }
                    if (this.MyFieldInfo) {
                        let tPushName = "CDE_FILEPUSH:" + tFileName + ":" + this.MyFieldInfo.cdeO;
                        if (this.GetProperty("Cookie"))
                            tPushName += ":" + this.GetProperty("Cookie");
                        if (cde.CBool(this.GetProperty("AllowGlobalPush")) && cde.MyBaseAssets.MyEngines[this.MyEngineName])
                            cdeCommCore.PublishCentral(this.MyEngineName, tPushName, tres);
                        else
                            cdeCommCore.PublishToNode(this.MyFieldInfo.cdeN, this.MyEngineName, tPushName, tres);
                    }
                }
                this.FireEvent(false, "OnFilePushed", evt.target);
                if (this.mZoomImg && tres.indexOf("image") > 0) {
                    this.mZoomImg.SetProperty("Visibility", true);
                    this.mZoomImg.SetProperty("Source", tres);
                    this.mInfo.SetProperty("Visibility", false);
                }
                else {
                    this.mInfo.SetProperty("Visibility", true);
                    this.mInfo.GetElement().innerHTML = file.name + " - Done";
                }
            };
            reader.readAsDataURL(file);
        }
        ProcessFiles(pFileList) {
            if (!pFileList || !pFileList.length || this.mFileList.length)
                return;
            for (const element of pFileList) {
                this.mFileList.push(element);
            }
            this.UploadNext();
        }
        ///legacy support
        static Create(pTargetControl, pTargetEngine, pTRF, pTitle) {
            const t = new ctrlDropUploader(pTRF);
            t.MyEngineName = pTargetEngine;
            t.InitControl(pTargetControl, pTRF);
            if (pTitle)
                t.SetProperty("Title", pTitle);
            return t;
        }
    }
    cdeNMI.ctrlDropUploader = ctrlDropUploader;
    /**
    * Creates a Zoom Image - size of one Tile and zooms to 3x Tiles if zooming is enabled
    *
    * This control is NOT and input control for Form or Table
    * (4.1 Ready!)
    */
    class ctrlZoomImage extends cdeNMI.TheNMIBaseControl {
        constructor(pTRF) {
            super(null, pTRF);
            this.Img = null;
            this.imgNumber = 0;
            this.MyZoom = null;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.Picture;
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            this.HostDiv = document.createElement('div');
            this.Img = document.createElement('img');
            this.Img.className = "Blocked";
            this.Img.style.width = "inherit";
            this.Img.style.height = "inherit";
            this.Img.addEventListener('error', (evt) => {
                this.OnImgError(evt);
            });
            this.HostDiv.appendChild(this.Img);
            if (cde.CBool(this.GetSetting("EnableZoom")) === true) {
                this.MyZoom = new Zoom(this.Img, { rotate: cde.CBool(this.GetSetting("AllowRotate")) }, null);
            }
            super.SetProperty("ZoomLevel", 1);
            this.SetElement(this.HostDiv, true);
            this.RegisterEvent("Resize", (sender, newSize) => {
                if (newSize <= cde.CInt(this.GetProperty("MaxTileWidth")) && newSize >= cde.CInt(this.GetProperty("MinTileWidth"))) {
                    this.MyTE.SetProperty("TileWidth", newSize);
                    switch (newSize) {
                        case 6:
                            this.MyTE.SetProperty("TileHeight", 5);
                            break;
                        default:
                            this.MyTE.SetProperty("TileHeight", (newSize / 4 * 3));
                            break;
                    }
                }
            });
            return true;
        }
        SetProperty(pName, pValue) {
            let tTile = 0;
            if (pName === "Name") {
                if (this.Img)
                    this.Img.alt = pValue;
            }
            else if ((pName === "Source" || pName === "Value" || pName === "iValue") && this.Img) {
                try {
                    if (pValue && pValue.startsWith("FA")) {
                        pValue = "<i class='fa faIcon " + (pValue.substr(3, 1) === "S" ? "fa-spin " : "") + "fa-" + pValue.substr(2, 1) + "x'>&#x" + pValue.substr(4, pValue.length - 4) + ";</i>";
                    }
                    else if (pValue && (pValue.substring(0, 5) === "data:" || cde.CBool(super.GetProperty("IsBlob")) || pValue.length > 512)) {
                        let tformat = super.GetProperty("ImgFormat");
                        if (!tformat)
                            tformat = "jpeg";
                        if (pValue.substr(0, 5) !== "data:")
                            pValue = "data:image/" + tformat + ";base64," + pValue;
                        if (!this.HostDiv.className)
                            this.HostDiv.className = "cdeLiveImg";
                        this.Img.src = pValue;
                    }
                    else if (pValue) {
                        const tPa = cde.CStr(pValue).split(';');
                        let tImgSrc = pValue;
                        if (tPa.length > 1) {
                            this.SetProperty("ImageOpacity", tPa[1]);
                            if (tPa.length > 2)
                                tImgSrc = tPa[0];
                            else
                                tImgSrc = cde.FixupPath(tPa[0]);
                        }
                        this.Img.src = cde.FixupPath(tImgSrc + cdeNMI.GenerateFinalString("<%ISID%>"));
                    }
                }
                catch (ex) {
                    cdeNMI.ShowToastMessage(pValue + ":IMG SETP ERROR:" + ex);
                }
                if (pName === "Source" || !pValue)
                    return;
            }
            else if (pName === "ZoomLevel") {
                this.OnClickFunction(this, null, null);
            }
            else if (pName === "ControlTW") {
                tTile = cdeNMI.GetSizeFromTile(cde.CInt(pValue));
                if (tTile > 0) {
                    const tSKY = cde.CInt(this.GetProperty("TileFactorX"));
                    if (tSKY > 1)
                        tTile /= tSKY;
                    this.Img.width = tTile;
                    this.Img.style.width = tTile + "px";
                }
            }
            else if (pName === "ControlTH") {
                tTile = cdeNMI.GetSizeFromTile(cde.CInt(pValue));
                if (tTile > 0) {
                    const tSKY = cde.CInt(this.GetProperty("TileFactorY"));
                    if (tSKY > 1)
                        tTile /= tSKY;
                    this.Img.height = tTile;
                    this.Img.style.height = tTile + "px";
                }
            }
            else if (pName === "Width") {
                tTile = cde.CDbl(pValue);
                if (tTile > 0) {
                    const tSKY = cde.CInt(this.GetProperty("TileFactorX"));
                    if (tSKY > 1)
                        tTile /= tSKY;
                    this.Img.width = tTile;
                }
            }
            else if (pName === "Height") {
                tTile = cde.CDbl(pValue);
                if (tTile > 0) {
                    const tSKY = cde.CInt(this.GetProperty("TileFactorY"));
                    if (tSKY > 1)
                        tTile /= tSKY;
                    this.Img.height = tTile;
                }
            }
            else if (pName === "ImageOpacity" && this.Img) {
                this.Img.style.opacity = pValue;
            }
            else if (pName === "StartSequence") {
                this.RequestRedraw();
            }
            else if (pName === "Background") {
                this.HostDiv.style.backgroundColor = pValue;
            }
            else if (pName === "EnableZoom") {
                this.EnabledZoom();
                this.HookEvents(false);
            }
            else if (pName === "ClassName") {
                this.Img.className = pValue;
            }
            else if (pName === "OnClick") {
                this.HookEvents(false);
                //if (pValue && (typeof (pValue) == 'string') && pValue.toString().substr(0, 4) == "TTS:")
                //    pValue = "cdeNMI.MyScreenManager.TransitToScreen('" + pValue.substr(4) + "', true)";    //4.107:TODO Update with real SCreenManager
                this.RegisterEvent("OnClick", pValue);
                this.RegisterEvent("PointerUp", this.DoFireClick);
                this.Img.style.cursor = "pointer";
            }
            else if (pName === "AutoAdjust" && this.MyTarget) {
                this.Img.width = this.MyTarget.GetElement().clientWidth;
                this.Img.height = this.MyTarget.GetElement().clientHeight;
            }
            super.SetProperty(pName, pValue);
        }
        OnImgError(evt) {
            if (cdeNMI.MyEngine) {
                const t = this.Img.src;
                const f = cdeNMI.GetLocation(t).pathname;
                cdeNMI.MyEngine.cdeGetImage(f, (pThis, pData) => {
                    let tPlanar;
                    try {
                        tPlanar = JSON.parse(pData);
                        const tP = tPlanar.ImageSource.indexOf(".");
                        const tExt = tPlanar.ImageSource.substr(tP + 1);
                        pThis.SetProperty("Source", "data:image/" + tExt + ";base64," + tPlanar.Bits);
                    }
                    catch (ex) {
                        cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "SetProperty:OnImgError", "Image settting for  Inlining (" + tPlanar.ImageSource + ") failed with " + ex);
                    }
                }, this);
            }
        }
        EnabledZoom() {
            this.HostDiv.style.width = "";
            this.HostDiv.style.height = "";
            this.Img.style.cursor = "pointer";
            this.RegisterEvent("PointerUp", (obj, evt, pPointer) => {
                this.OnClickFunction(obj, evt, pPointer);
            });
        }
        OnClickFunction(obj, evt, pPointer) {
            if (!this.Img || (pPointer && pPointer.PathLength() > cdeNMI.MyNMISettings.DeadPathLength))
                return;
            if (!this.Img ||
                cde.CBool(this.GetProperty("Disabled")) || (this.MyTRF && this.MyTRF.FldInfo && (this.MyTRF.FldInfo.Flags & 2) === 0)) {
                if (cde.CBool(this.GetProperty("EnableZoom")) === true && this.MyZoom) {
                    this.MyZoom.destroy();
                    this.MyZoom = new Zoom(this.Img, { rotate: cde.CBool(this.GetSetting("AllowRotate")) }, null);
                }
                return;
            }
            if (evt) {
                evt.cancelBubble = true;
                evt.stopPropagation();
            }
            let tH = cde.CDbl(this.GetProperty("FullHeight"));
            if (tH === 0)
                tH = this.Img.naturalHeight;
            if (tH === 0)
                tH = cdeNMI.GetSizeFromTile(1);
            let tW = cde.CDbl(this.GetProperty("FullWidth"));
            if (tW === 0)
                tW = this.Img.naturalWidth;
            if (tW === 0)
                tW = cdeNMI.GetSizeFromTile(1);
            let cTW = cde.CDbl(this.GetProperty("ControlTW"));
            if (cTW === 0)
                cTW = 1;
            let cTH = cde.CDbl(this.GetProperty("ControlTH"));
            if (cTH === 0)
                cTH = 1;
            switch (super.GetProperty("ZoomLevel")) {
                case 1:
                    {
                        if (this.Img.src.substr(0, 5) !== "data:" && this.Img.src.indexOf("_s.") > 0) {
                            let tUrl = this.Img.src.substr(0, this.Img.src.indexOf("_s."));
                            tUrl += this.Img.src.substr(this.Img.src.lastIndexOf("."));
                            this.Img.src = tUrl;
                            tW = this.Img.naturalWidth;
                        }
                        const tWid = cdeNMI.GetSizeFromTile(3);
                        if (tWid > tW) {
                            this.ShowNaturalSize(cTW, cTH, tW / tH);
                            break;
                        }
                        //$(this.Img).
                        //    animate({
                        //        "width": tWid,
                        //        "height": (tWid / (tW / tH))
                        //    },
                        //        500,
                        //        "easeOutCirc");
                        super.SetProperty("ZoomLevel", 2);
                    }
                    break;
                case 2:
                    {
                        const tWid2 = cdeNMI.GetSizeFromTile(6);
                        if (tWid2 > tW) {
                            this.ShowNaturalSize(cTW, cTH, tW / tH);
                            break;
                        }
                        //$(this.Img).
                        //    animate({
                        //        "width": tWid2,
                        //        "height": (tWid2 / (tW / tH))
                        //    },
                        //        500,
                        //        "easeOutCirc");
                        super.SetProperty("ZoomLevel", 3);
                    }
                    break;
                case 3:
                    {
                        let tWid3 = cdeNMI.GetSizeFromTile(12);
                        if (tWid3 > tW) {
                            tWid3 = tW;
                        }
                        //$(this.Img).
                        //    animate({
                        //        "width": tWid3,
                        //        "height": (tWid3 / (tW / tH))
                        //    },
                        //        500,
                        //        "easeOutCirc");
                        super.SetProperty("ZoomLevel", 0);
                    }
                    break;
                default:
                    this.ShowNaturalSize(cTW, cTH, tW / tH);
                    break;
            }
        }
        ShowNaturalSize(cTW, cTH, cRatio) {
            //var tWid3: number = cdeNMI.GetSizeFromTile(cTW);
            //if (cde.CBool(this.GetProperty("AutoAdjust"))) {
            //    //$(this.Img).animate({
            //    //    "width": cdeNMI.GetSizeFromTile(cTW),
            //    //    "height": cdeNMI.GetSizeFromTile(cTH)
            //    //}, 500, "easeOutCirc");
            //} else {
            //    //$(this.Img).animate({
            //    //    "width": tWid3,
            //    //    "height": (tWid3 / cRatio)
            //    //}, 500, "easeOutCirc");
            //}
            super.SetProperty("ZoomLevel", 1);
        }
        RedrawImage() {
            if (this.imgNumber > this.GetProperty("LastSeqNo")) {
                if (this.GetProperty("DoLoop") === true) {
                    this.imgNumber = 0;
                    this.RequestRedraw();
                }
            }
            else {
                this.Img.src = this.GetProperty("Value") + ("00000" + (this.imgNumber++).toString()).slice(-5) + ".png"; // "raining/Raining_"
                this.RequestRedraw();
            }
        }
        RequestRedraw() {
            const tWindow = window;
            if (tWindow.webkitRequestAnimationFrame)
                tWindow.webkitRequestAnimationFrame(() => {
                    this.RedrawImage();
                });
            else
                window.setTimeout(() => {
                    this.RedrawImage();
                }, Math.floor(1000 / 60));
        }
        //Backward compat
        static Create(pTargetControl, pWidth, pHeight, pUrl, pClass) {
            const tTemp = new ctrlZoomImage();
            tTemp.InitControl(pTargetControl);
            if (pClass)
                tTemp.SetProperty("ClassName", pClass);
            if (pUrl) {
                if (pUrl.substring(0, 5) === "data:")
                    tTemp.HostDiv.className = "cdeLiveImg";
                tTemp.SetProperty("iValue", pUrl);
            }
            if (pWidth >= 0 && pHeight >= 0) {
                tTemp.EnabledZoom();
            }
            tTemp.SetProperty("FullHeight", pHeight);
            tTemp.SetProperty("FullWidth", pWidth);
            return tTemp;
        }
    }
    cdeNMI.ctrlZoomImage = ctrlZoomImage;
    /**
* Creates a progress bar
*
* (4.1 Ready!)
*/
    class ctrlProgressBar extends cdeNMI.TheNMIBaseControl {
        constructor(pTRF) {
            super(null, pTRF);
            this.mWidth = 0;
            this.mHeight = 0;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.ProgressBar;
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            this.mBaseCtrl = cdeNMI.MyTCF.CreateBaseControl().Create(pTargetControl, { TRF: this.MyTRF });
            this.mBaseCtrl.SetElement(document.createElement("div"));
            this.mBaseCtrl.GetElement().className = "ctrlProgressBar";
            this.mBaseCtrl.SetInitialSize(0);
            this.mContentTarget = document.createElement("progress");
            this.mContentTarget.className = "ctrlProgressBar";
            this.mBaseCtrl.GetElement().appendChild(this.mContentTarget);
            this.SetElement(this.mBaseCtrl.GetElement());
            this.SetProperty("MaxValue", 100);
            return true;
        }
        SetProperty(pName, pValue) {
            super.SetProperty(pName, pValue);
            if (pName === "Background") {
                this.mContentTarget.style.background = pValue;
            }
            else if (pName === "Foreground") {
                this.mContentTarget.style.color = pValue;
            }
            else if (pName === "BarClassName") {
                this.mContentTarget.className = pValue;
            }
            else if (pName === "MaxValue") {
                pValue = cde.CInt(pValue);
                this.mContentTarget.max = pValue;
            }
            else if (pName === "Value" || pName === "iValue") {
                this.mContentTarget.value = cde.CDbl(pValue);
            }
        }
        //legacy support
        static Create(pTargetControl, pTRF, pValue, pMaxVal) {
            const t = new ctrlProgressBar(pTRF);
            t.InitControl(pTargetControl, pTRF);
            if (pMaxVal) {
                t.SetProperty("MaxValue", pMaxVal);
            }
            if (!pValue)
                pValue = 0;
            t.SetProperty("iValue", pValue);
            return t;
        }
    }
    cdeNMI.ctrlProgressBar = ctrlProgressBar;
    class ctrlProgressBarCool extends cdeNMI.TheNMIBaseControl {
        constructor(pTRF) {
            super(null, pTRF);
            this.mWidth = 0;
            this.mHeight = 0;
            this.mMaxValue = 100;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.ProgressBar;
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            this.mBaseCtrl = cdeNMI.MyTCF.CreateBaseControl().Create(pTargetControl, { TRF: this.MyTRF });
            this.mBaseCtrl.SetElement(document.createElement("div"));
            this.mBaseCtrl.GetElement().className = "cdeMeter";
            this.mBaseCtrl.SetInitialSize(0);
            this.mContentTarget = document.createElement("span");
            this.mBaseCtrl.GetElement().appendChild(this.mContentTarget);
            this.mContentTarget.style.width = "0px";
            this.mContentTarget.style.height = (this.mBaseCtrl.MyHeight - 20) + "px";
            this.SetElement(this.mBaseCtrl.GetElement());
            cde.MyBaseAssets.RegisterEvent("ThemeSwitched", () => {
                if (!this.GetProperty("Background")) {
                    if (cde.MyBaseAssets.MyServiceHostInfo.IsLiteTheme)
                        this.mBaseCtrl.GetElement().style.background = "rgba(80, 80, 80, 0.1)";
                    else
                        this.mBaseCtrl.GetElement().style.background = "rgba(80, 80, 80, 0.5)";
                }
                this.DoRender();
            });
            return true;
        }
        SetProperty(pName, pValue) {
            super.SetProperty(pName, pValue);
            if (pName === "Background") {
                this.mContentTarget.style.background = pValue;
            }
            else if (pName === "Foreground") {
                this.mContentTarget.style.color = pValue;
            }
            else if (pName === "BarClassName") {
                this.mContentTarget.className = pValue;
            }
            else if (pName === "MaxValue") {
                this.mMaxValue = cde.CInt(pValue);
                this.DoRender();
            }
            else if (pName === "Value" || pName === "iValue") {
                this.DoRender();
            }
        }
        DoRender() {
            let tLen = this.GetProperty("Value");
            if (tLen > this.mMaxValue)
                tLen = this.mMaxValue;
            const tWid = (this.mBaseCtrl.MyWidth - 20) / this.mMaxValue * tLen;
            this.mContentTarget.style.width = tWid + "px";
        }
        //legacy support
        static Create(pTargetControl, pTRF, pValue, pMaxVal) {
            const t = new ctrlProgressBarCool(pTRF);
            t.InitControl(pTargetControl, pTRF);
            if (pMaxVal) {
                t.SetProperty("MaxValue", pMaxVal);
            }
            if (!pValue)
                pValue = 0;
            t.SetProperty("iValue", pValue);
            return t;
        }
    }
    cdeNMI.ctrlProgressBarCool = ctrlProgressBarCool;
    /**
* Creates a VideoViewer. Target has to be set to zero to creat its own frame. Otherwise it will fill the parent container with the video
*
* (4.1 Ready!)
*/
    class ctrlVideoViewer extends cdeNMI.TheNMIBaseControl {
        constructor(pTRF) {
            super(null, pTRF);
            this.mVideo = null;
            this.mVideoSource = null;
            this.divFrame = null;
            this.mCamBut = null;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.VideoViewer;
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            this.mVideo = document.createElement("video");
            this.mVideo.style.backgroundColor = "black";
            this.mVideo.autoplay = true;
            this.mVideo.style.width = "inherit";
            this.mVideo.style.height = "inherit";
            this.mVideo.onerror = () => { cdeNMI.ShowToastMessage("Cannot play Video"); };
            this.mVideoSource = document.createElement('source');
            this.mVideo.appendChild(this.mVideoSource);
            this.divFrame = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileGroup);
            this.divFrame.InitControl(pTargetControl, this.MyTRF);
            this.divFrame.SetProperty("Background", "gray");
            this.divFrame.SetInitialSize(0);
            this.mCamBut = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(this.divFrame, { PostInitBag: ["Text=MyCam", "TileWidth=1", "TileHeight=1"] });
            this.mCamBut.SetProperty("OnClick", () => {
                this.ShowLiveVideo();
            });
            this.mCamBut.SetProperty("Visibility", false);
            this.divFrame.GetElement().appendChild(this.mVideo);
            this.SetElement(this.divFrame.GetElement());
            return true;
        }
        SetProperty(pName, pValue) {
            super.SetProperty(pName, pValue);
            if ((pName === "Source" || pName === "Value" || pName === "iValue") && this.mVideo) {
                if (pValue === "LIVE")
                    this.ShowLiveVideo();
                else {
                    this.mVideoSource.src = pValue;
                    this.mVideo.play();
                }
            }
            else if (pName === "ShowCam") {
                this.mCamBut.SetProperty("Visibility", true);
            }
            else if (pName === "Background") {
                this.mVideo.style.backgroundColor = pValue;
            }
            else if (pName === "MainBackground") {
                this.divFrame.SetProperty("Background", pValue);
            }
            else if (pName === "ClassName" && this.mVideo) {
                this.mVideo.className = pValue;
            }
            else if (pName === "ShowControls" && this.mVideo) {
                if (cde.CBool(pValue))
                    this.mVideo.setAttribute("controls", "");
                else
                    this.mVideo.removeAttribute("controls");
            }
        }
        ShowLiveVideo() {
            const n = navigator;
            n.getUserMedia = n.getUserMedia || n.webkitGetUserMedia || n.mozGetUserMedia || n.msGetUserMedia;
            try {
                if (n.getUserMedia) {
                    this.mVideoSource.src = null;
                    n.getUserMedia({ video: true, audio: true }, (stream) => {
                        this.mVideoSource.src = stream;
                        this.mVideo.play();
                    }, (error) => {
                        if (cdeNMI.MyPopUp)
                            cdeNMI.MyPopUp.Show("An Video-Display error occurred: [CODE " + error.code + "]", true);
                    });
                }
                else {
                    if (cdeNMI.MyPopUp)
                        cdeNMI.MyPopUp.Show("Native camera is not supported in this browser!", true);
                }
            }
            catch (e) {
                if (cdeNMI.MyPopUp)
                    cdeNMI.MyPopUp.Show("An Video-Display error occurred: " + e, true);
            }
        }
    }
    cdeNMI.ctrlVideoViewer = ctrlVideoViewer;
    /* Creates a single Check Box
    *
    * (4.1 Ready!)
    */
    class ctrlCheckBox extends cdeNMI.TheNMIBaseControl {
        constructor(pTRF) {
            super(null, pTRF);
            this.MyCheckBox = null;
            this.InnerCheck = null;
            this.InnerText = null;
            this.IsCustomCheck = false;
        }
        static CreateOLD(pTarget, pScreenID, pTRF, IsChecked, pTitle, pIsOverLay, pClassName) {
            const tTile = new ctrlCheckBox(pTRF);
            tTile.InitControl(pTarget, pTRF, null, pScreenID);
            if (pClassName)
                tTile.SetProperty("ClassName", pClassName);
            tTile.SetProperty("iValue", IsChecked);
            if (cde.CBool(pIsOverLay))
                tTile.SetProperty("IsOverlay", pIsOverLay);
            if (pTitle)
                tTile.SetProperty("Title", pTitle);
            return tTile;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.SingleCheck;
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            this.MyCheckBox = document.createElement("div");
            this.MyCheckBox.className = "ctrlCheckBox";
            this.MyCheckBox.style.width = (cdeNMI.GetSizeFromTile(1) - 4) + "px";
            this.MyCheckBox.style.height = (cdeNMI.GetSizeFromTile(1) - 4) + "px";
            this.InnerCheck = document.createElement("div");
            this.InnerCheck.className = "ctrlCheckBoxInner";
            this.InnerCheck.style.width = (cdeNMI.GetSizeFromTile(1) - 6) + "px";
            this.InnerCheck.style.height = (cdeNMI.GetSizeFromTile(1) - 6) + "px";
            this.InnerCheck.style.pointerEvents = "none";
            this.MyCheckBox.appendChild(this.InnerCheck);
            const tHeader = this.GetSetting("Title");
            if (tHeader)
                this.SetProperty("Title", tHeader);
            this.IsCustomCheck = true;
            this.SetElement(this.MyCheckBox, true);
            this.SetProperty("Disabled", (!this.MyFieldInfo || (this.MyFieldInfo.Flags & 2) === 0)); //TODO: We need a consequent way of doing this!
            if (cde.CBool(this.GetSetting("DefaultValue")))
                this.SetProperty("iValue", true);
            else
                this.SetProperty("iValue", false);
            this.EnableDisable(cde.CBool(this.GetProperty("Disabled")));
            return true;
        }
        SetProperty(pName, pValue) {
            if (pName === "Value" || pName === "iValue") {
                if (cde.CBool(this.GetProperty("IsChecked")) !== cde.CBool(pValue))
                    this.IsDirty = true;
                if (cde.CBool(pValue))
                    this.SetProperty("IsChecked", true);
                else
                    this.SetProperty("IsChecked", false);
                this.ShowToggle();
            }
            else if (pName === "CheckImage") {
                if (pValue && pValue !== "CDE_NOP") {
                    if (pValue.toLowerCase().indexOf(".png") < 0 &&
                        pValue.toLowerCase().indexOf(".jpg") < 0) {
                        if (!this.InnerText) {
                            this.InnerText = document.createElement("span");
                            this.InnerCheck.appendChild(this.InnerText);
                        }
                        this.InnerText.className = "cdeCheckIcon";
                        this.InnerText.innerHTML = pValue;
                        if (this.GetProperty("Foreground"))
                            this.InnerText.style.color = this.GetProperty("Foreground");
                        else
                            this.InnerText.style.color = "black";
                        this.InnerCheck.style.backgroundImage = "none";
                    }
                    else
                        this.InnerCheck.style.backgroundImage = pValue;
                    this.IsCustomCheck = true;
                    this.InnerCheck.style.display = "";
                }
                else {
                    this.IsCustomCheck = false;
                    this.InnerCheck.style.display = "";
                    this.InnerCheck.style.backgroundImage = 'url("../Images/cdeInnerCheck.png")';
                    this.InnerText.className = "cdeCheckText";
                    this.InnerText.innerHTML = this.GetProperty("Title");
                    this.ShowToggle();
                }
                this.ShowToggle();
            }
            else if (pName === "Background" && this.MyCheckBox) {
                this.MyCheckBox.style.background = pValue;
            }
            else if (pName === "Foreground" && this.InnerText) {
                this.InnerText.style.color = pValue;
            }
            else if (pName === "AreYouSure") {
                this.UnregisterEvent("PointerUp");
                this.EnableDisable(cde.CBool(this.GetProperty("Disabled")));
            }
            else if (pName === "Disabled") {
                if ((!this.MyFieldInfo || (this.MyFieldInfo.Flags & 2) === 0))
                    pValue = true;
                this.EnableDisable(cde.CBool(pValue));
            }
            else if (pName === "IsOverlay") {
                cdeNMI.SetZIndex(this.MyCheckBox, cde.CBool(pValue) ? 1300 : 0);
                cdeNMI.SetZIndex(this.InnerCheck, cde.CBool(pValue) ? 1300 : 0);
            }
            else if (pName === "Title" && this.InnerCheck) {
                if (!this.InnerText) {
                    this.InnerText = document.createElement("span");
                    this.InnerText.className = "cdeCheckText";
                    this.InnerCheck.appendChild(this.InnerText);
                }
                this.InnerText.innerHTML = pValue;
            }
            super.SetProperty(pName, pValue);
        }
        SetTE(pTE) {
            super.SetTE(pTE);
            if (this.MyTE && cde.CBool(this.GetProperty("NoTE")) === true) {
                this.MyTE.MyTELabel.SetProperty("Visibility", true);
                this.MyTE.MyTELabel.SetProperty("PixelHeight", 18);
                this.MyTE.MyTELabel.SetProperty("FontSize", 15);
            }
        }
        PostCreate(pTE) {
            if (!cde.CBool(pTE.GetProperty("IsInTable"))) {
                this.SetProperty("IsHitTestDisabled", true);
                this.SetProperty("NoClick", true);
            }
            if ((this.MyFieldInfo.Flags & 2) !== 0)
                pTE.MyTEContainer.SetProperty("OnClick", (sender, evt) => {
                    if (!evt.AYSFired && this.GetProperty("AreYouSure")) {
                        if (cdeNMI.MyPopUp)
                            cdeNMI.MyPopUp.Show(this.GetProperty("AreYouSure"), false, null, 1, () => {
                                this.ToggleCheck(null);
                            });
                    }
                    else
                        this.ToggleCheck(evt);
                });
            else
                this.SetProperty("Disabled", true);
        }
        EnableDisable(IsDisabled) {
            this.UnregisterEvent("PointerUp");
            if (!IsDisabled) {
                this.RegisterEvent("PointerUp", (sender, evt) => {
                    if (this.GetProperty("NoClick") !== true) {
                        if (this.GetProperty("AreYouSure")) {
                            if (cdeNMI.MyPopUp)
                                cdeNMI.MyPopUp.Show(this.GetProperty("AreYouSure"), false, null, 1, () => {
                                    this.ToggleCheck(null);
                                });
                        }
                        else
                            this.ToggleCheck(evt);
                    }
                });
            }
        }
        ToggleCheck(evt) {
            if (!cde.CBool(this.GetProperty("IsChecked")))
                this.SetProperty("IsChecked", true);
            else
                this.SetProperty("IsChecked", false);
            this.ShowToggle();
            if (this.GetProperty("NoClick") === true || this.GetProperty("UpdateTable") === true)
                this.SetProperty("Value", cde.CBool(this.GetProperty("IsChecked")));
            else
                this.SetProperty("iValue", cde.CBool(this.GetProperty("IsChecked")));
        }
        ShowToggle() {
            if (!cde.CBool(this.GetProperty("IsChecked"))) {
                this.InnerCheck.style.opacity = "0.05";
                if (!this.IsCustomCheck)
                    this.InnerCheck.style.display = "none";
            }
            else {
                this.InnerCheck.style.opacity = "1";
                if (!this.IsCustomCheck)
                    this.InnerCheck.style.display = "";
            }
        }
        //backward compat
        static Create(pTarget, pScreenID, pTRF, IsChecked, pTitle, pIsOverLay, pClassName) {
            const tTile = new ctrlCheckBox(pTRF);
            tTile.InitControl(pTarget, pTRF, null, pScreenID);
            if (pClassName)
                tTile.SetProperty("ClassName", pClassName);
            tTile.SetProperty("iValue", IsChecked);
            if (cde.CBool(pIsOverLay))
                tTile.SetProperty("IsOverlay", pIsOverLay);
            if (pTitle)
                tTile.SetProperty("Title", pTitle);
            return tTile;
        }
    }
    cdeNMI.ctrlCheckBox = ctrlCheckBox;
    /**
    * Creates a row of Check Box fields
    *
    * (4.1 Ready!)
    */
    class ctrlCheckField extends cdeNMI.TheNMIBaseControl {
        constructor(pTRF) {
            super(null, pTRF);
            this.MyDIV = null;
            this.tSendButton = null;
            this.tInfo = null;
            this.BitCount = 1;
        }
        static CreateOLD(pTarget, pScreenID, pTRF, pFldValue, pIsOverLay, pClassName) {
            const tTile = new ctrlCheckField(pTRF);
            tTile.InitControl(pTarget, pTRF, null, pScreenID);
            if (pClassName)
                tTile.SetProperty("ClassName", pClassName);
            tTile.SetProperty("iValue", pFldValue);
            if (cde.CBool(pIsOverLay))
                tTile.SetProperty("IsOverlay", pIsOverLay);
            return tTile;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.CheckField;
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            this.MyDIV = document.createElement("div");
            this.MyDIV.className = "ctrlCheckField";
            this.SetElement(this.MyDIV);
            let taTitle = null;
            let HasOptions = false;
            if (this.GetSetting("Options")) {
                taTitle = this.GetSetting("Options").split(';');
                HasOptions = true;
            }
            else if (this.GetSetting("ImageList")) {
                taTitle = this.GetSetting("ImageList").split(',');
                HasOptions = true;
            }
            const tTileFY = cde.CInt(this.GetSetting("TileFactorY"));
            let tTileX = cdeNMI.GetControlWidth(this);
            if (tTileX < 2)
                tTileX = 2;
            this.MyCheckBoxes = new Array();
            this.MyLabels = new Array();
            this.MyTiles = new Array();
            if (!this.MyFieldInfo) {
                this.MyCheckBoxes[0] = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SingleCheck).Create(this, { ScreenID: pScreenID, TRF: new cdeNMI.TheTRF("", 0, new cdeNMI.TheFieldInfo(cdeNMI.cdeControlType.SingleCheck, 1, "no TRF", 0)) });
            }
            else {
                this.BitCount = cde.CInt(this.GetSetting("Bits"));
                if (this.BitCount === 0 && taTitle && taTitle.length > 0)
                    this.BitCount = taTitle.length;
                if (HasOptions) {
                    this.SetProperty("TileHeight", this.BitCount);
                    if (tTileFY > 1)
                        this.SetProperty("TileFactorY", tTileFY);
                }
                //TODO: Here is the loop that creates the CheckBoxes (toggles). Instead of using checkboxes with 1x1 tilewidth can you create another smartlabel behind each toggle for the label 
                for (let i = this.BitCount - 1; i >= 0; i--) {
                    let tTitle = (1 << i).toString();
                    if (taTitle && taTitle.length > i)
                        tTitle = taTitle[i];
                    if (HasOptions) {
                        this.MyTiles[i] = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileGroup);
                        this.MyTiles[i].InitControl(this);
                        this.MyTiles[i].SetProperty("TileWidth", tTileX);
                        this.MyTiles[i].SetProperty("TileHeight", 1);
                        this.MyTiles[i].SetProperty("Display", "table");
                        this.MyCheckBoxes[i] = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SingleCheck).Create(this.MyTiles[i], { ScreenID: pScreenID, TRF: new cdeNMI.TheTRF("", 0, new cdeNMI.TheFieldInfo(cdeNMI.cdeControlType.SingleCheck, 1, "no TRF", this.MyFieldInfo.Flags & 2)) });
                        this.MyCheckBoxes[i].RegisterEvent("OniValueChanged", () => {
                            this.GetCheckValue("Value");
                        });
                        this.MyLabels[i] = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SmartLabel).Create(this.MyTiles[i], { PreInitBag: ["Element=div"], TRF: new cdeNMI.TheTRF("", 0, new cdeNMI.TheFieldInfo(cdeNMI.cdeControlType.SmartLabel, 1, "no TRF", 256)) });
                        this.MyLabels[i].SetProperty("Value", tTitle);
                        this.MyLabels[i].SetProperty("TileWidth", tTileX - 1);
                        this.MyLabels[i].SetProperty("Display", "table-cell");
                        this.MyLabels[i].SetProperty("HorizontalAlignment", "left");
                        this.MyLabels[i].SetProperty("VerticalAlignment", "middle");
                        if (tTileFY > 1) {
                            this.MyTiles[i].SetProperty("TileFactorY", tTileFY);
                            this.MyCheckBoxes[i].SetProperty("TileFactorY", tTileFY);
                            this.MyLabels[i].SetProperty("TileFactorY", tTileFY);
                        }
                    }
                    else
                        this.MyCheckBoxes[i] = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SingleCheck).Create(this, { ScreenID: pScreenID, TRF: new cdeNMI.TheTRF("", 0, new cdeNMI.TheFieldInfo(cdeNMI.cdeControlType.SingleCheck, 1, "no TRF", this.MyFieldInfo.Flags & 2)) });
                }
            }
            if (this.MyTRF && this.MyTRF.FldInfo && (this.MyTRF.FldInfo.Flags & 2) !== 0) {
                //this.tSendButton = cdeNMI.MyTCF.CreateNMIControl(cdeControlType.TileButton).Create(this, { PreInitBag: ["ControlTW=1", "ControlTH=1"], PostInitBag: ["Title=<span class='fa fa-3x'>&#xf058;</span>", "ClassName=cdeOkButton"] });
                //this.tSendButton.SetProperty("OnClick", (pSender: INMIControl, evt: Event) => {
                //    if (this.IsDisabled) return;
                //    cdeNMI.StopPointerEvents(evt);
                //    this.GetCheckValue("Value");
                //});
                if (this.GetSetting("ResultLabel"))
                    this.tInfo = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SmartLabel).Create(this, { PreInitBag: ["ControlTW=2", "ControlTH=1", "NoTE=true"], PostInitBag: ["Text=" + this.GetSetting("ResultLabel"), "ClassName=cdeResultLabel"] });
            }
            this.SetProperty("Disabled", (!this.MyFieldInfo || (this.MyFieldInfo.Flags & 2) === 0)); //TODO: We need a consequent way of doing this!
            if (cdeNMI.MyEngine) {
                if (cde.GuidToString(this.MyFieldInfo.cdeMID) === "DD3DF621ACAC4B77985687165138B028") {
                    cdeNMI.MyEngine.RegisterEvent("NMI_UIDACL", (sender, tsm) => {
                        if (cde.GuidToString(tsm.OWN) === cde.GuidToString(this.MyFieldInfo.cdeMID))
                            this.SetProperty("iValue", cde.CInt(tsm.PLS));
                    });
                }
            }
            return true;
        }
        GetProperty(pName) {
            if (pName === "iValue" || pName === "Value") {
                this.GetCheckValue("iValue");
            }
            return super.GetProperty(pName);
        }
        SetProperty(pName, pValue) {
            let i;
            if (pName === "Value" || pName === "iValue") {
                if (pValue) {
                    const tVal = cde.CInt(pValue);
                    if (this.MyFieldInfo) {
                        for (i = cde.CInt(this.MyFieldInfo["Bits"]) - 1; i >= 0; i--) {
                            if ((tVal & (1 << i)) !== 0)
                                this.MyCheckBoxes[i].SetProperty("iValue", true);
                            else
                                this.MyCheckBoxes[i].SetProperty("iValue", false);
                        }
                    }
                    else {
                        this.MyCheckBoxes[0].SetProperty("iValue", false);
                    }
                    if (this.tInfo)
                        this.tInfo.SetProperty("Text", this.GetProperty("ResultLabel") + tVal);
                }
            }
            else if (pName === "ImageList" && this.MyCheckBoxes) {
                const tImgs = pValue.split(',');
                for (i = 0; i < this.MyCheckBoxes.length; i++) {
                    if (i >= tImgs.length)
                        this.MyCheckBoxes[i].SetProperty("CheckImage", null);
                    else
                        this.MyCheckBoxes[i].SetProperty("CheckImage", tImgs[i]);
                }
            }
            else if (pName === "IsOverlay") {
                cdeNMI.SetZIndex(this.MyDIV, cde.CBool(pValue) ? 1300 : 0);
                cdeNMI.SetZIndex(this.tSendButton.GetElement(), cde.CBool(pValue) ? 1300 : 0);
                for (i = 0; i < this.MyCheckBoxes.length; i++) {
                    this.MyCheckBoxes[i].SetProperty("IsOverlay", pValue);
                }
            }
            else if (pName === "Disabled") {
                if ((!this.MyFieldInfo || (this.MyFieldInfo.Flags & 2) === 0))
                    pValue = true;
                this.EnableDisable(cde.CBool(pValue));
            }
            else if (pName === "FontSize") {
                for (let i = 0; i < this.BitCount; i++) {
                    if (this.MyLabels && this.MyLabels[i])
                        this.MyLabels[i].SetProperty("FontSize", pValue);
                }
            }
            else if (pName === "Options" && pValue) {
                const taTitle = pValue.split(';');
                for (i = cde.CInt(this.MyFieldInfo["Bits"]) - 1; i >= 0; i--) {
                    let tTitle = (1 << i).toString();
                    if (taTitle && taTitle.length > i)
                        tTitle = taTitle[i];
                    this.MyCheckBoxes[i].SetProperty("Title", tTitle);
                }
            }
            super.SetProperty(pName, pValue);
        }
        PostCreate(pTE) {
            if (this.MyFieldInfo["IsInTable"] === true) {
                this.SetProperty("IsOverlay", true);
            }
        }
        GetCheckValue(pName) {
            let tNewValue = 0;
            for (let i = this.BitCount - 1; i >= 0; i--) {
                if (cde.CBool(this.MyCheckBoxes[i].GetProperty("IsChecked")))
                    tNewValue += (1 << i);
            }
            this.SetProperty(pName, tNewValue);
            return tNewValue;
        }
        EnableDisable(IsDisabled) {
            if (this.tSendButton)
                this.tSendButton.SetProperty("Disabled", IsDisabled);
            for (let i = 0; i < this.MyCheckBoxes.length; i++)
                this.MyCheckBoxes[i].SetProperty("Disabled", IsDisabled);
        }
    }
    cdeNMI.ctrlCheckField = ctrlCheckField;
    /**
* Creates a button that can be pushed to the right side and reveals more buttons underneath
*
* (4.1 Ready!)
*/
    class ctrlRevealButton extends cdeNMI.TheNMIBaseControl {
        constructor(pTRF) {
            super(null, pTRF);
            this.divPin = null;
            this.mInnerDiv = null;
            this.mImgControl = null;
            this.mMoveDiv = null;
            this.mlastX = 0;
            this.mNoFire = false;
            this.mInsideControls = null;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.RevealButton;
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            this.divPin = document.createElement("div");
            this.divPin.style.position = "relative";
            this.divPin.style.cssFloat = "left";
            this.PreventDefault = true;
            this.SetElement(this.divPin, true);
            this.SetProperty("IsOpen", false);
            return true;
        }
        SetProperty(pName, pValue) {
            if (pName === "ClassName") {
                this.divPin.className = pValue;
                return;
            }
            else if (pName === "TabIndex") {
                pValue = cde.CInt(pValue);
                this.SetTabIndex(pValue);
            }
            else if (pName === "Image") {
                if (pValue) {
                    const t = this;
                    t.mImgControl = pValue;
                    t.GetElement().appendChild(pValue.GetElement());
                    t.mImgControl.SetProperty("Parent", t);
                    //t.mImgControl.RegisterEvent("OnClick", clickEvt);
                    t.mImgControl.GetElement().style.cssFloat = "right";
                    t.mImgControl.HookEvents(false);
                    t.mImgControl.RegisterEvent("PointerUp", (pControl, evt, pPointer) => {
                        t.SetProperty("LastX", -1);
                        const tParent = pControl.GetProperty("Parent");
                        if (!tParent.mNoFire && pPointer.PathLength() < cdeNMI.MyNMISettings.DeadPathLength)
                            pControl.FireEvent(true, "OnClick", evt);
                    });
                    if (this.GetProperty("InsideControls") > 0)
                        this.InitInsides();
                }
            }
            else if (pName === "ControlArray") {
                if (pValue && pValue.length > 0) {
                    const t = this;
                    t.mInsideControls = pValue;
                    t.mMoveDiv = document.createElement("div");
                    t.mMoveDiv.style.width = "0px";
                    t.mMoveDiv.style.height = cdeNMI.GetSizeFromTile(1) + "px";
                    t.mMoveDiv.style.cssFloat = "left";
                    t.mMoveDiv.style.overflow = "hidden";
                    t.mMoveDiv.id = t.GetProperty("ID");
                    t.divPin.appendChild(t.mMoveDiv);
                    t.mInnerDiv = document.createElement("div");
                    t.mInnerDiv.style.height = cdeNMI.GetSizeFromTile(1) + "px";
                    t.mInnerDiv.style.display = "none";
                    t.mMoveDiv.appendChild(t.mInnerDiv);
                    t.SetProperty("InsideControls", pValue.length);
                    for (let i = 0; i < pValue.length; i++) {
                        t.SetProperty("InsideControl" + i, pValue);
                        t.mInnerDiv.appendChild(pValue[i].GetElement());
                        pValue[i].GetElement().style.verticalAlign = "middle";
                        pValue[i].GetElement().style.display = "table-cell";
                        pValue[i].GetElement().tabIndex = -1;
                    }
                    t.mInnerDiv.style.width = (cdeNMI.GetSizeFromTile(pValue.length) + 1) + "px";
                    t.InitInsides();
                    this.SetTabIndex(-1);
                }
            }
            super.SetProperty(pName, pValue);
        }
        SetTabIndex(startIndex) {
            if (!this.mInsideControls)
                return;
            for (let i = 0; i < this.mInsideControls.length; i++) {
                if (startIndex < 0)
                    this.mInsideControls[i].GetElement().tabIndex = -1;
                else
                    this.mInsideControls[i].GetElement().tabIndex = startIndex++;
            }
        }
        InitInsides() {
            if (this.GetProperty("InsideControls") > 0 && this.mImgControl) {
                this.mImgControl.RegisterEvent("PointerDown", (pControl, evt, pPointer) => {
                    this.SetProperty("LastX", pPointer.AdjPosition.x);
                    const tParent = pControl.GetProperty("Parent");
                    tParent.mNoFire = false;
                });
                this.mImgControl.RegisterEvent("PointerMove", (pControl, evt, pPointer) => {
                    const tParent = pControl.GetProperty("Parent");
                    //var div;      //V4.107: Move to Velocity
                    if (pPointer.Shift.x > 2 && tParent.GetProperty("IsOpen") !== true) {
                        tParent.SetProperty("IsOpen", true);
                        tParent.SetTabIndex(cde.CInt(tParent.GetProperty("TabIndex")) + 1);
                        //div = $("#" + tParent.GetProperty("ID"));
                        tParent.mInnerDiv.style.display = 'table';
                        tParent.mInnerDiv.style.width = cdeNMI.GetSizeFromTile(tParent.GetProperty("InsideControls")) + 2 + 'px';
                        tParent.mMoveDiv.style.width = cdeNMI.GetSizeFromTile(tParent.GetProperty("InsideControls")) + 2 + 'px';
                        //div.animate({ width: cdeNMI.GetSizeFromTile(this.GetProperty("InsideControls")) + 2 + 'px' }, 100, "easeOutBack", () => {
                        //});
                    }
                    else if (pPointer.Shift.x < -2 && tParent.GetProperty("IsOpen") === true) {
                        tParent.SetProperty("IsOpen", false);
                        tParent.SetTabIndex(-1);
                        //div = $("#" + tParent.GetProperty("ID"));
                        //div.animate({ width: '0px' }, 100, "easeOutBack", () => {
                        tParent.mMoveDiv.style.width = "0px";
                        tParent.mInnerDiv.style.width = "0px";
                        tParent.mInnerDiv.style.display = 'none';
                        //});
                    }
                });
            }
            return true;
        }
    }
    cdeNMI.ctrlRevealButton = ctrlRevealButton;
    class ctrlImageSlider2 extends cdeNMI.TheNMIBaseControl {
        constructor() {
            super(null, null);
            this.myControlContainer = null;
            this.myPropertyBag = null;
        }
        SetProperty(pName, pValue) {
            super.SetProperty(pName, pValue);
            if (pName === "iValue") {
                this.myBar.SetProperty("iValue", pValue);
            }
        }
        InitControl(pTargetElem, pTRF, pPropertyBag, pScreenID) {
            super.InitControl(pTargetElem, pTRF, pPropertyBag, pScreenID);
            if (pPropertyBag)
                this.myPropertyBag = pPropertyBag;
            else {
                if (pTRF && pTRF.FldInfo && pTRF.FldInfo.PropertyBag)
                    this.myPropertyBag = pTRF.FldInfo.PropertyBag;
            }
            this.myControlContainer = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileGroup).Create(pTargetElem);
            this.myControlContainer.SetInitialSize(0);
            //SIZING: Needs to be the same on all SF Controls
            let tW = cde.CInt(this.MyParentCtrl.GetProperty("ControlTW"));
            if (this.GetSetting("TileWidth"))
                tW = cde.CInt(this.GetSetting("TileWidth"));
            let tH = cde.CInt(this.MyParentCtrl.GetProperty("ControlTH"));
            if (this.GetSetting("TileHeight"))
                tH = cde.CInt(this.GetSetting("TileHeight"));
            ////////////////////////////// To here
            this.SetElement(this.myControlContainer.GetElement(), true, this.myControlContainer.GetElement());
            this.AddMyControls(tW, tH, pTRF);
            cde.MyBaseAssets.RegisterEvent("ThemeSwitched", () => {
                this.SetImg();
            });
            this.SetImg();
            return true;
        }
        SetImg() {
            let bWasSet = false;
            if (cde.MyBaseAssets.MyServiceHostInfo.IsLiteTheme) {
                if (this.GetProperty("LiteSource")) {
                    this.myImage.SetProperty("Source", this.GetProperty("LiteSource"));
                    bWasSet = true;
                }
            }
            else {
                if (this.GetProperty("DarkSource")) {
                    this.myImage.SetProperty("Source", this.GetProperty("DarkSource"));
                    bWasSet = true;
                }
            }
            if (!bWasSet && this.GetProperty("Source")) {
                this.myImage.SetProperty("Source", this.GetProperty("Source"));
            }
        }
        AddMyControls(tWidth, tHeight, pTRF) {
            this.myGroup = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileGroup).Create(this.myControlContainer, { TRF: pTRF });
            this.myGroup.SetProperty("ClassName", "cIBGroup");
            this.myImage = cdeNMI.ctrlZoomImage.Create(this.myGroup);
            this.myImage.SetProperty("ControlTW", tWidth);
            this.myImage.SetProperty("ControlTH", tHeight);
            this.myImage.SetProperty("Z-Index", 50);
            this.myImage.SetProperty("IsAbsolute", true);
            this.myImage.SetProperty("Style", "pointer-events: none");
            const tImg = this.GetSetting("Source");
            if (tImg)
                this.myImage.SetProperty("Source", tImg);
            this.myBar = cdeNMI.ctrlBarChart.Create(this.myGroup, pTRF);
            this.myBar.SetProperty("ControlTW", tWidth);
            this.myBar.SetProperty("ControlTH", tHeight);
            this.myBar.SetProperty("IsAbsolute", true);
            this.myBar.SetProperty("iValue", this.GetSetting("Value"));
            cdeNMI.TheNMIBaseControl.SetPropertiesFromBag(this.myBar, this.myPropertyBag);
            this.myBar.RegisterEvent("OnValueChanged", (pBar, evt, pVal) => {
                this.SetProperty("Value", pVal[1]);
            });
        }
        ApplySkin() {
            //overrided if necessary
        }
    }
    cdeNMI.ctrlImageSlider2 = ctrlImageSlider2;
    class ctrlToggleButton2 extends cdeNMI.TheNMIBaseControl {
        constructor(pTRF) {
            super(null, pTRF);
            this.MyCheckBox = null;
            this.IsCustomCheck = false;
            this.MyLabel = null;
            this.MyToggleSwitch = null;
            this.MyCheckBoxSwitch = null;
            this.InnerToggleDiv = null;
        }
        static CreateOLD(pTarget, pScreenID, pTRF, IsChecked, pTitle, pIsOverLay, pClassName) {
            const tTile = new ctrlCheckBox(pTRF);
            tTile.InitControl(pTarget, pTRF, null, pScreenID);
            if (pClassName)
                tTile.SetProperty("ClassName", pClassName);
            tTile.SetProperty("iValue", IsChecked);
            if (cde.CBool(pIsOverLay))
                tTile.SetProperty("IsOverlay", pIsOverLay);
            if (pTitle)
                tTile.SetProperty("Title", pTitle);
            return tTile;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.SingleCheck;
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            this.MyCheckBox = document.createElement("div");
            this.MyCheckBox.className = "cdeToggleSwitch";
            var cw = cde.CInt(this.GetSetting("CheckWidth"));
            if (cw == 0)
                cw = 1;
            this.MyCheckBox.style.height = (cdeNMI.GetSizeFromTile(cw)) + "px";
            this.MyCheckBox.style.width = (cdeNMI.GetSizeFromTile(cw)) + "px";
            this.MyLabel = document.createElement("label");
            this.MyLabel.className = "cdeSwitchLabel";
            this.MyLabel.style.maxWidth = (cdeNMI.GetSizeFromTile(cw)) + "px";
            const tL = this.GetSetting("Label");
            this.MyLabel.innerHTML = tL ? tL : (cde.CBool(this.GetSetting("IsInTable")) === true ? "" : "&nbsp;");
            this.MyToggleSwitch = document.createElement("label");
            this.MyToggleSwitch.className = "cdeSwitch";
            this.MyCheckBoxSwitch = document.createElement("input");
            this.MyCheckBoxSwitch.type = "checkbox";
            this.MyCheckBoxSwitch.className = "cdeCheckboxInput";
            this.MyToggleSwitch.appendChild(this.MyCheckBoxSwitch);
            this.MyCheckBox.appendChild(this.MyLabel);
            this.MyCheckBox.appendChild(this.MyToggleSwitch);
            this.InnerToggleDiv = document.createElement("div");
            this.InnerToggleDiv.className = "cdeCheckboxInnerDiv";
            this.MyToggleSwitch.appendChild(this.InnerToggleDiv);
            const tHeader = this.GetSetting("Title");
            if (tHeader) {
                this.SetProperty("Title", tHeader);
            }
            this.IsCustomCheck = true;
            this.SetElement(this.MyCheckBox, true);
            this.SetProperty("Disabled", (!this.MyFieldInfo || (this.MyFieldInfo.Flags & 2) === 0));
            if (cde.CBool(this.GetSetting("DefaultValue"))) {
                this.SetProperty("iValue", true);
            }
            else {
                this.SetProperty("iValue", false);
            }
            this.EnableDisable(cde.CBool(this.GetProperty("Disabled")));
            return true;
        }
        SetProperty(pName, pValue) {
            if (pName === "Value" || pName === "iValue") {
                if (cde.CBool(this.GetProperty("IsChecked")) !== cde.CBool(pValue))
                    this.IsDirty = true;
                if (cde.CBool(pValue)) {
                    this.SetProperty("IsChecked", true);
                    this.MyCheckBox.classList.add("toggleChecked");
                }
                else {
                    this.SetProperty("IsChecked", false);
                    this.MyCheckBox.classList.remove("toggleChecked");
                }
            }
            else if (pName === "Label") {
                this.MyLabel.textContent = pValue;
            }
            else if (pName === "HideLabel") {
                this.MyLabel.style.display = "none";
            }
            else if (pName === "TileHeight" || pValue === "ControlTH") {
                let tfy = cde.CInt(this.GetProperty("TileFactorY"));
                if (tfy === 0)
                    tfy = 1;
                this.MyCheckBox.style.height = (cdeNMI.GetSizeFromTile(cde.CInt(pValue)) / tfy) + "px";
            }
            else if (pName === "TileFactorY") {
                let tfy = cde.CInt(pValue);
                if (tfy < 1)
                    tfy = 1;
                let th = cde.CInt(this.GetProperty("TileHeight"));
                if (th === 0)
                    th = 1;
                this.MyCheckBox.style.height = (cdeNMI.GetSizeFromTile(th) / tfy) + "px";
                if (tfy > 1)
                    this.MyLabel.style.display = "none";
            }
            super.SetProperty(pName, pValue);
            //if (this.MyCheckBox) {
            //    var t = this.MyCheckBox.style.height;
            //}
        }
        PostCreate(pTE) {
            if (!cde.CBool(pTE.GetProperty("IsInTable"))) {
                this.SetProperty("IsHitTestDisabled", true);
                this.SetProperty("NoClick", true);
            }
            if ((this.MyFieldInfo.Flags & 2) !== 0)
                pTE.MyTEContainer.SetProperty("OnClick", (sender, evt) => {
                    if (!evt.AYSFired && this.GetProperty("AreYouSure")) {
                        if (cdeNMI.MyPopUp)
                            cdeNMI.MyPopUp.Show(this.GetProperty("AreYouSure"), false, null, 1, () => {
                                this.ToggleCheck(null);
                            });
                    }
                    else
                        this.ToggleCheck(evt);
                });
            else {
                this.SetProperty("Disabled", true);
            }
        }
        EnableDisable(IsDisabled) {
            this.UnregisterEvent("PointerUp");
            if (!IsDisabled) {
                this.RegisterEvent("PointerUp", (sender, evt) => {
                    if (this.GetProperty("NoClick") !== true) {
                        if (this.GetProperty("AreYouSure")) {
                            if (cdeNMI.MyPopUp)
                                cdeNMI.MyPopUp.Show(this.GetProperty("AreYouSure"), false, null, 1, () => {
                                    this.ToggleCheck(null);
                                });
                        }
                        else
                            this.ToggleCheck(evt);
                    }
                });
            }
        }
        // Sets IsChecked properties and transforms UX toggle based on state
        ToggleCheck(pEvent) {
            if (!cde.CBool(this.GetProperty("IsChecked"))) {
                this.SetProperty("IsChecked", true);
                this.MyCheckBox.classList.add("toggleChecked");
            }
            else {
                this.SetProperty("IsChecked", false);
                this.MyCheckBox.classList.remove("toggleChecked");
            }
            if (this.GetProperty("NoClick") === true || this.GetProperty("UpdateTable") === true) {
                this.SetProperty("Value", cde.CBool(this.GetProperty("IsChecked")));
            }
            else {
                this.SetProperty("iValue", cde.CBool(this.GetProperty("IsChecked")));
            }
        }
        //backward compat
        static Create(pTarget, pScreenID, pTRF, IsChecked, pTitle, pIsOverLay, pClassName) {
            const tTile = new ctrlCheckBox(pTRF);
            tTile.InitControl(pTarget, pTRF, null, pScreenID);
            if (pClassName)
                tTile.SetProperty("ClassName", pClassName);
            tTile.SetProperty("iValue", IsChecked);
            if (cde.CBool(pIsOverLay))
                tTile.SetProperty("IsOverlay", pIsOverLay);
            if (pTitle)
                tTile.SetProperty("Title", pTitle);
            return tTile;
        }
    }
    cdeNMI.ctrlToggleButton2 = ctrlToggleButton2;
})(cdeNMI || (cdeNMI = {}));
// SPDX-FileCopyrightText: 2009-2023 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
var cdeNMI;
// SPDX-FileCopyrightText: 2009-2023 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
(function (cdeNMI) {
    /**
         * Creates a new Drawing Canvas (HTML5 Canvas Element)
          *ctrlCanvasDraw is the base OBject for other controls:
          * 34: BarChart
          * 33: Slider
          * 38: DrawOverlay
          * This control is NOT and input control for Form or Table
         * (4.1 Ready!)
         */
    class ctrlCanvasDraw extends cdeNMI.TheNMIBaseControl {
        constructor(pTRF) {
            super(null, pTRF);
            this.bgcanvas = null;
            this.fgcanvas = null;
            this.bgctx = null;
            this.fgctx = null;
            this.redrawPending = false;
            this.foregroundPolylines = new Array();
            this.mBaseDiv = null;
            this.WidthRatio = 1;
            this.HeightRatio = 1;
            this.MyWidth = 0;
            this.MyHeight = 0;
            this.tObjPointer = -1;
            this.tStrokePointer = 0;
            this.tAsyncStrokes = null;
            this.MyFirstPoint = null;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.CanvasDraw;
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            let tBase = null;
            if (this.MyTarget)
                this.mBaseDiv = this.MyTarget.GetContainerElement();
            else {
                this.mBaseDiv = document.createElement("div");
                tBase = this.mBaseDiv;
            }
            if (!this.DoesSupportsCanvas) {
                const nocanvas = document.createElement("div");
                nocanvas.style.position = "absolute";
                nocanvas.appendChild(document.createTextNode("Canvas drawing is not supported for your browser."));
                this.mBaseDiv.appendChild(nocanvas);
                return false;
            }
            if (!cde.CBool(this.GetSetting("NoBackBuffer"))) {
                this.bgcanvas = document.createElement("canvas");
                this.bgcanvas.width = 0;
                this.bgcanvas.height = 0;
                this.bgctx = this.bgcanvas.getContext("2d");
                if (!tBase)
                    this.bgcanvas.style.position = "relative";
                this.bgcanvas.style.top = "0px";
                this.bgcanvas.style.left = "0px";
                this.mBaseDiv.appendChild(this.bgcanvas);
            }
            this.fgcanvas = document.createElement("canvas");
            this.fgctx = this.fgcanvas.getContext("2d");
            this.fgcanvas.width = 0;
            this.fgcanvas.height = 0;
            if (!cde.CBool(this.GetSetting("IsInTable")))
                this.fgcanvas.style.position = "absolute";
            this.fgcanvas.style.top = "0px";
            this.fgcanvas.style.left = "0px";
            this.SetProperty("Foreground", "#000000");
            this.mBaseDiv.appendChild(this.fgcanvas);
            this.PreventManipulation = true;
            this.SetElement(tBase ? tBase : this.fgcanvas);
            return true;
        }
        SetProperty(pName, pValue) {
            let bDrawCanvas = false;
            let tShape = null;
            let bHasPW = cde.CInt(this.GetProperty("PixelWidth")) > 0;
            let bHasPH = cde.CInt(this.GetProperty("PixelHeight")) > 0;
            if (pName === "DataContextSilent") {
                super.SetProperty("DataContext", pValue);
            }
            else {
                if (pName === "Style") {
                    if (this.bgcanvas)
                        this.bgcanvas.style.cssText += pValue;
                    if (this.fgcanvas)
                        this.fgcanvas.style.cssText += pValue;
                }
                else {
                    if ((pName === "Value" || pName === "iValue") && pValue) {
                        const tV = pValue.toString();
                        if (tV.substring(0, 3) === "SH:") {
                            this.SetProperty("SetShapes", tV.substring(3));
                            return;
                        }
                    }
                    super.SetProperty(pName, pValue);
                }
            }
            if (pName === "OnPointerDown") {
                if (pValue) {
                    this.PreventDefault = true;
                    this.HookEvents(false);
                }
                this.RegisterEvent("PointerDown", pValue);
            }
            else if (pName === "OnPointerMove") {
                if (pValue) {
                    this.PreventDefault = true;
                    this.HookEvents(false);
                }
                this.RegisterEvent("PointerMove", pValue);
            }
            else if (pName === "OnPointerUp") {
                if (pValue) {
                    this.PreventDefault = true;
                    this.HookEvents(false);
                }
                this.RegisterEvent("PointerUp", pValue);
            }
            else if (pName === "OnPointerCancel") {
                if (pValue) {
                    this.PreventDefault = true;
                    this.HookEvents(false);
                }
                this.RegisterEvent("PointerCancel", pValue);
            }
            else if (pName === "OnKeyDown") {
                if (pValue) {
                    this.PreventDefault = true;
                    this.HookEvents(false);
                }
                this.RegisterEvent("KeyDown", pValue);
            }
            else if (pName === "OnKeyUp") {
                if (pValue) {
                    this.PreventDefault = true;
                    this.HookEvents(false);
                }
                this.RegisterEvent("KeyUp", pValue);
            }
            else if (pName === "IsVertical") {
                if (typeof pValue === "undefined" || cde.CBool(pValue)) {
                    pValue = true;
                    super.SetProperty("IsVertical", pValue);
                }
                this.DrawCanvasBackground();
            }
            else if (pName === "IsInverted") {
                if (typeof pValue === "undefined" || cde.CBool(pValue)) {
                    pValue = true;
                    super.SetProperty("IsInverted", pValue);
                }
                this.DrawCanvasBackground();
            }
            else if (pName === "Background") {
                this.DrawCanvasBackground();
            }
            else if (pName === "AddShape") {
                try {
                    tShape = JSON.parse(pValue);
                    if (tShape) {
                        this.AddDrawingObject(tShape);
                        bDrawCanvas = true;
                    }
                }
                catch (error) {
                    cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "cdeNMI:ctrlCanvasDraw", "DrawCanvas-AddShape :" + error);
                }
            }
            else if ((pName === "DrawShapes" || pName === "SetShapes") && pValue) {
                try {
                    if (pName === "SetShapes")
                        this.ClearPicture();
                    const tShapes = JSON.parse(pValue);
                    for (let i = 0; i < tShapes.length; i++) {
                        this.AddDrawingObject(tShapes[i], tShapes[i].ID + i.toString(), i < tShapes.length - 1);
                    }
                    bDrawCanvas = true;
                }
                catch (error) {
                    cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "cdeNMI:ctrlCanvasDraw", "DrawCanvas-DrawShapes :" + error);
                }
            }
            else if (pName === "DrawShape" && pValue) {
                try {
                    tShape = JSON.parse(pValue);
                    if (tShape) {
                        this.AddDrawingObject(tShape, tShape.ID);
                        bDrawCanvas = true;
                    }
                }
                catch (error) {
                    cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "cdeNMI:ctrlCanvasDraw", "DrawCanvas-DrawShape :" + error);
                }
            }
            else if (pName === "SetShape") {
                if (pValue) {
                    this.ClearPicture();
                    try {
                        tShape = JSON.parse(pValue);
                        if (tShape) {
                            this.AddDrawingObject(tShape);
                            bDrawCanvas = true;
                        }
                    }
                    catch (error) {
                        cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "cdeNMI:ctrlCanvasDraw", "DrawCanvas-SetShape :" + error);
                    }
                }
            }
            else if (pName === "TileFactorX") {
                if (!bHasPW) {
                    const tFX = cde.CInt(pValue);
                    if (tFX > 1) {
                        pValue = cde.CInt(this.GetProperty("ControlTW"));
                        if (pValue === 0)
                            pValue = 1;
                        pValue = cdeNMI.GetSizeFromTile(pValue);
                        this.SetProperty("AbsWidth", pValue / tFX);
                    }
                }
            }
            else if (pName === "TileFactorY") {
                if (!bHasPH) {
                    const tFX = cde.CInt(pValue);
                    if (tFX > 1) {
                        pValue = cde.CInt(this.GetProperty("ControlTH"));
                        if (pValue === 0)
                            pValue = 1;
                        pValue = cdeNMI.GetSizeFromTile(pValue);
                        this.SetProperty("AbsHeight", pValue / tFX);
                    }
                }
            }
            else if (pName === "DrawMargin") {
                const tMarg = cde.CDbl(pValue);
                const tHe = this.MyHeight - (tMarg * 2);
                const tWi = this.MyWidth - (tMarg * 2);
                if (this.bgcanvas) {
                    this.bgcanvas.style.top = tMarg.toString() + "px";
                    this.bgcanvas.style.left = tMarg.toString() + "px";
                    this.bgcanvas.style.height = tHe + "px";
                    this.bgcanvas.height = tHe;
                    this.bgcanvas.style.width = tWi + "px";
                    this.bgcanvas.width = tWi;
                }
                if (this.fgcanvas) {
                    this.fgcanvas.style.top = tMarg.toString() + "px";
                    this.fgcanvas.style.left = tMarg.toString() + "px";
                    this.fgcanvas.style.height = tHe + "px";
                    this.fgcanvas.height = tHe;
                    this.fgcanvas.style.width = tWi + "px";
                    this.fgcanvas.width = tWi;
                }
            }
            else if (pName === "ControlTW") {
                this.SetDrawWidth(pValue);
            }
            else if (pName === "ControlTH") {
                this.SetDrawHeight(pValue);
            }
            else if (pName === "CanvasHeight") {
                pValue = cde.CInt(pValue);
                if (this.fgcanvas && this.fgcanvas.height !== pValue) {
                    this.fgcanvas.height = pValue;
                }
                if (this.bgcanvas && this.bgcanvas.height !== pValue) {
                    this.bgcanvas.height = pValue;
                }
                this.HeightRatio = cde.CDbl(pValue) / this.MyHeight;
                bDrawCanvas = true;
            }
            else if (pName === "CanvasWidth") {
                pValue = cde.CInt(pValue);
                if (this.fgcanvas && this.fgcanvas.width !== pValue) {
                    this.fgcanvas.width = pValue;
                }
                if (this.bgcanvas && this.bgcanvas.width !== pValue) {
                    this.bgcanvas.width = pValue;
                }
                this.WidthRatio = pValue / this.MyWidth;
                bDrawCanvas = true;
            }
            else if (pName === "AbsHeight" || pName === "PixelHeight") {
                pValue = cde.CInt(pValue);
                if (this.fgcanvas && this.fgcanvas.height !== pValue) {
                    this.fgcanvas.style.height = pValue + "px";
                    this.fgcanvas.height = pValue;
                }
                if (this.bgcanvas && this.bgcanvas.height !== pValue) {
                    this.bgcanvas.style.height = pValue + "px";
                    this.bgcanvas.height = pValue;
                }
                this.MyHeight = pValue;
                this.HeightRatio = 1;
                bDrawCanvas = true;
            }
            else if (pName === "AbsWidth" || pName === "PixelWidth") {
                pValue = cde.CInt(pValue);
                if (this.fgcanvas && this.fgcanvas.width !== pValue) {
                    this.fgcanvas.style.width = pValue + "px";
                    this.fgcanvas.width = pValue;
                }
                if (this.bgcanvas && this.bgcanvas.width !== pValue) {
                    this.bgcanvas.style.width = pValue + "px";
                    this.bgcanvas.width = pValue;
                }
                this.MyWidth = pValue;
                this.WidthRatio = 1;
                bDrawCanvas = true;
            }
            else if (pName === "YRatio" && this.fgcanvas) {
                const tRat = cde.CDbl(this.fgcanvas.style.width.substring(0, this.fgcanvas.style.width.length - 2)) / cde.CDbl(pValue);
                this.fgcanvas.style.height = tRat + "px";
                this.MyHeight = tRat;
            }
            if (!bDrawCanvas && pName === "DataContextSilent")
                bDrawCanvas = false;
            else
                bDrawCanvas = true;
            if (bDrawCanvas) {
                this.RequestRedraw();
            }
        }
        SetDrawWidth(pValue) {
            if (cde.CInt(this.GetProperty("PixelWidth")) == 0) {
                let tFX = cde.CInt(this.GetProperty("TileFactorX"));
                if (tFX === 0)
                    tFX = 1;
                pValue = cde.CInt(pValue);
                if (pValue === 0)
                    pValue = 1;
                pValue = cdeNMI.GetSizeFromTile(pValue);
                this.SetProperty("AbsWidth", pValue / tFX);
            }
        }
        SetDrawHeight(pValue) {
            if (cde.CInt(this.GetProperty("PixelHeight")) == 0) {
                let tFX = cde.CInt(this.GetProperty("TileFactorY"));
                if (tFX === 0)
                    tFX = 1;
                pValue = cde.CInt(pValue);
                if (pValue === 0)
                    pValue = 1;
                pValue = cdeNMI.GetSizeFromTile(pValue);
                this.SetProperty("AbsHeight", pValue / tFX);
            }
        }
        ApplySkin() {
            this.ResizeCanvas();
        }
        ResizeCanvas() {
            if (this.mBaseDiv.clientWidth === 0 || this.mBaseDiv.clientHeight === 0)
                return;
            if (cde.CBool(this.GetProperty("AutoAdjust")) || this.MyWidth === 0 || this.MyHeight === 0) {
                if (this.MyWidth !== this.mBaseDiv.clientWidth) {
                    this.MyWidth = this.mBaseDiv.clientWidth;
                    this.SetProperty("AbsWidth", this.MyWidth);
                }
                if (this.MyHeight !== this.mBaseDiv.clientHeight) {
                    this.MyHeight = this.mBaseDiv.clientHeight;
                    this.SetProperty("AbsHeight", this.MyHeight);
                }
            }
        }
        DoesSupportsCanvas() {
            return !!document.createElement('canvas').getContext;
        }
        GetPNG() {
            if (!this.bgcanvas)
                return "";
            return this.bgcanvas.toDataURL("image/png");
        }
        GetBGRenderContext() {
            return this.bgcanvas.getContext('2d');
        }
        AddDrawingObject(pObject, id, drawLater) {
            let tDrawingObjects = this.GetProperty("DataContext");
            if (!tDrawingObjects)
                tDrawingObjects = [];
            if (id)
                tDrawingObjects[id] = pObject;
            else
                tDrawingObjects[cdeNMI.MyNMISettings.IDCounter++] = pObject;
            this.SetProperty("DataContext", tDrawingObjects);
            if (!drawLater)
                this.RequestRedraw();
        }
        DrawCanvasBackground() {
            if (!this.bgctx)
                return;
            if (this.bgctx.canvas.height === 0 || this.bgctx.canvas.width === 0)
                this.ResizeCanvas();
            this.bgctx.globalAlpha = 1;
            if (this.GetProperty("ForegroundOpacity"))
                this.fgctx.globalAlpha = parseFloat(this.GetProperty("ForegroundOpacity"));
            let tIsTrans = false;
            if (this.GetProperty("Background")) {
                this.bgctx.fillStyle = ctrlCanvasDraw.ProcessColor(this, this.bgctx, this.GetProperty("Background"));
                if (this.GetProperty("Background").toLowerCase() === "transparent")
                    tIsTrans = true;
            }
            else {
                this.bgctx.fillStyle = "transparent";
                tIsTrans = true;
            }
            if (tIsTrans)
                this.bgctx.clearRect(0, 0, this.bgctx.canvas.width, this.bgctx.canvas.height);
            else
                this.bgctx.fillRect(0, 0, this.bgctx.canvas.width, this.bgctx.canvas.height);
            if (this.GetProperty("Playback") === true) {
                this.tObjPointer = 0;
                this.tAsyncStrokes = this.MyBackDrawObjects;
                this.tStrokePointer = 0;
                this.DrawLinesAsync(this, this.bgctx);
            }
            else {
                for (const id in this.MyBackDrawObjects) {
                    if (this.MyBackDrawObjects[id].Visibility && this.MyBackDrawObjects[id].HasEnded) {
                        this.DrawObject(this.bgctx, this.MyBackDrawObjects[id]);
                    }
                }
            }
        }
        ClearPicture() {
            this.MyBackDrawObjects = [];
            if (this.bgctx)
                this.bgctx.clearRect(0, 0, this.bgctx.canvas.width, this.bgctx.canvas.height);
            if (this.fgctx)
                this.fgctx.clearRect(0, 0, this.fgctx.canvas.width, this.fgctx.canvas.height);
            this.foregroundPolylines = [];
            this.DrawCanvasBackground();
            this.SetProperty("DataContext", null);
        }
        RedrawForeground() {
            this.redrawPending = false;
            if (!cde.CBool(this.GetProperty("Playback")) && !cde.CBool(this.GetProperty("NoClear")))
                this.fgctx.clearRect(0, 0, this.fgctx.canvas.width, this.fgctx.canvas.height);
            let tDrawingObjects = this.GetProperty("DataContext");
            if (!tDrawingObjects)
                tDrawingObjects = [];
            let id;
            for (id in this.foregroundPolylines) {
                if (this.foregroundPolylines[id].HasEnded) {
                    tDrawingObjects.push(this.foregroundPolylines[id]);
                    delete this.foregroundPolylines[id.toString()];
                }
                else
                    this.DrawPolyline(this.fgctx, this.foregroundPolylines[id].ComplexData, this.foregroundPolylines[id].Foreground, this.foregroundPolylines[id].Fill);
            }
            if (tDrawingObjects.length > 0 && this.GetProperty("Playback") === true) {
                for (id in tDrawingObjects) {
                    if (!this.MyBackDrawObjects)
                        this.MyBackDrawObjects = [];
                    if (!tDrawingObjects[id].IsTemp)
                        this.MyBackDrawObjects.push(tDrawingObjects[id]);
                    delete tDrawingObjects[id];
                }
                this.DrawCanvasBackground();
            }
            else {
                for (id in tDrawingObjects) {
                    if (tDrawingObjects[id].Visibility) {
                        this.DrawObject(cde.CBool(tDrawingObjects[id].HasEnded) && this.bgctx ? this.bgctx : this.fgctx, tDrawingObjects[id]);
                    }
                    if (tDrawingObjects[id].HasEnded || tDrawingObjects[id].Type !== 2) {
                        if (!this.MyBackDrawObjects)
                            this.MyBackDrawObjects = [];
                        if (!tDrawingObjects[id].IsTemp)
                            this.MyBackDrawObjects.push(tDrawingObjects[id]);
                        delete tDrawingObjects[id];
                    }
                }
            }
            this.SetProperty("DataContextSilent", tDrawingObjects);
        }
        DrawObject(pctx, tDrawingObjects) {
            switch (tDrawingObjects.Type) {
                case 1: //Rectangle
                    pctx.fillStyle = ctrlCanvasDraw.ProcessColor(this, pctx, tDrawingObjects.Fill);
                    pctx.fillRect(tDrawingObjects.Left, tDrawingObjects.Top, tDrawingObjects.Width, tDrawingObjects.Height);
                    break;
                case 2: //Polyline
                    this.DrawPolyline(tDrawingObjects.HasEnded && this.bgctx ? this.bgctx : pctx, tDrawingObjects.ComplexData, tDrawingObjects.Foreground, tDrawingObjects.Fill);
                    break;
                case 3: //Text
                    if (!tDrawingObjects.ComplexData)
                        return;
                    if (tDrawingObjects.ComplexData.Font)
                        pctx.font = tDrawingObjects.ComplexData.Font;
                    pctx.strokeStyle = ctrlCanvasDraw.ProcessColor(this, pctx, tDrawingObjects.Fill);
                    pctx.strokeText(tDrawingObjects.ComplexData.Text, tDrawingObjects.Left, tDrawingObjects.Top);
                    break;
                case 4: //Filled Cicrle
                    pctx.beginPath();
                    pctx.arc(tDrawingObjects.Left, tDrawingObjects.Top, tDrawingObjects.Width, 0, 2 * Math.PI, false);
                    pctx.fillStyle = ctrlCanvasDraw.ProcessColor(this, pctx, tDrawingObjects.Fill);
                    pctx.fill();
                    break;
                case 5: //Empty Circle
                    pctx.beginPath();
                    pctx.arc(tDrawingObjects.Left, tDrawingObjects.Top, tDrawingObjects.Width, 0, 2 * Math.PI, false);
                    pctx.lineWidth = tDrawingObjects.StrokeThickness;
                    pctx.strokeStyle = ctrlCanvasDraw.ProcessColor(this, pctx, tDrawingObjects.Fill);
                    pctx.stroke();
                    break;
                case 6: //Image Draw
                    {
                        const tIMG = document.createElement("img");
                        tIMG.src = "data:image/jpeg;base64," + tDrawingObjects.ComplexData;
                        pctx.drawImage(tIMG, tDrawingObjects.Left, tDrawingObjects.Top);
                    }
                    break;
                case 7: //drawIcon
                    try {
                        if (jdenticon) {
                            pctx.setTransform(1, 0, 0, 1, tDrawingObjects.Left, tDrawingObjects.Top);
                            jdenticon.drawIcon(pctx, tDrawingObjects.ComplexData, tDrawingObjects.Width);
                        }
                    }
                    catch (_a) {
                        //ignored
                    }
                    break;
            }
        }
        RequestRedraw() {
            if (!this.redrawPending) {
                this.redrawPending = true;
                if (window.requestAnimationFrame) {
                    window.requestAnimationFrame(() => {
                        this.RedrawForeground();
                    });
                }
                else {
                    //if (window.webkitRequestAnimationFrame)
                    //    window.webkitRequestAnimationFrame(() => {
                    //        this.RedrawForeground();
                    //    });
                    //else
                    window.setTimeout(() => {
                        this.RedrawForeground();
                    }, Math.floor(1000 / 60));
                }
            }
        }
        DrawPolyline(ctx, pPoints, pColor, pFillColor) {
            if (pPoints.length === 1) {
                ctx.beginPath();
                ctx.arc(pPoints[0].PO.x, pPoints[0].PO.y, 10, 0, Math.PI, true);
                ctx.arc(pPoints[0].PO.x, pPoints[0].PO.y, 10, Math.PI, Math.PI * 2, true);
                if (pColor)
                    ctx.fillStyle = pColor;
                ctx.globalAlpha = 0.5;
                ctx.fill();
            }
            else if (pPoints.length > 1) {
                for (let i = 1; i < pPoints.length; ++i) {
                    ctx.beginPath();
                    ctx.moveTo(pPoints[i - 1].PO.x, pPoints[i - 1].PO.y);
                    ctx.lineCap = "round";
                    ctx.strokeStyle = pColor;
                    ctx.globalAlpha = 1;
                    ctx.lineTo(pPoints[i].PO.x, pPoints[i].PO.y);
                    let pStrokeThickness = pPoints[i].PO.t;
                    if (pStrokeThickness < 1)
                        pStrokeThickness = 1;
                    ctx.lineWidth = pStrokeThickness * cdeNMI.MyNMISettings.StrokeSize;
                    ctx.stroke();
                }
                if (pFillColor) {
                    ctx.fillStyle = pFillColor;
                    ctx.globalAlpha = 0.3;
                    ctx.fill();
                }
            }
        }
        DrawLinesAsync(thisObj, ctx) {
            if (!thisObj.tAsyncStrokes || thisObj.tObjPointer < 0 || thisObj.tAsyncStrokes.length <= thisObj.tObjPointer)
                return;
            let tStrokeP = thisObj.tAsyncStrokes[thisObj.tObjPointer].ComplexData;
            thisObj.tStrokePointer++;
            if (thisObj.tStrokePointer >= tStrokeP.length) {
                if (thisObj.tAsyncStrokes[thisObj.tObjPointer].Fill) {
                    ctx.fillStyle = thisObj.tAsyncStrokes[thisObj.tObjPointer].Fill;
                    ctx.globalAlpha = 0.3;
                    ctx.fill();
                }
                thisObj.tObjPointer++;
                if (thisObj.tObjPointer < thisObj.tAsyncStrokes.length) {
                    tStrokeP = thisObj.tAsyncStrokes[thisObj.tObjPointer].ComplexData;
                    thisObj.tStrokePointer = 1;
                }
                else {
                    thisObj.tObjPointer = -1;
                    thisObj.tStrokePointer = -1;
                    thisObj.SetProperty("Playback", false);
                    return;
                }
            }
            ctx.beginPath();
            ctx.moveTo(tStrokeP[thisObj.tStrokePointer - 1].PO.x, tStrokeP[thisObj.tStrokePointer - 1].PO.y);
            ctx.lineCap = "round";
            ctx.strokeStyle = thisObj.tAsyncStrokes[thisObj.tObjPointer].Foreground;
            ctx.globalAlpha = 1;
            ctx.lineTo(tStrokeP[thisObj.tStrokePointer].PO.x, tStrokeP[thisObj.tStrokePointer].PO.y);
            let pStrokeThickness = tStrokeP[thisObj.tStrokePointer].PO.t;
            if (pStrokeThickness < 1)
                pStrokeThickness = 1;
            ctx.lineWidth = pStrokeThickness * cdeNMI.MyNMISettings.StrokeSize;
            ctx.stroke();
            let tDelay = tStrokeP[thisObj.tStrokePointer].DT - tStrokeP[thisObj.tStrokePointer - 1].DT;
            if (thisObj.tStrokePointer < 2)
                tDelay = tStrokeP[1].DT;
            setTimeout(thisObj.DrawLinesAsync, tDelay, thisObj, ctx);
        }
        BeginPolyline(pTarget, pEvent, pPointer) {
            if (cde.CBool(pTarget.GetProperty("IsDisabled")) === true)
                return;
            const tCanvDraw = pTarget;
            if (tCanvDraw.foregroundPolylines[pPointer.Identifier.toString()])
                tCanvDraw.EndPolyline(pTarget, pEvent, pPointer);
            let tColor = pTarget.GetProperty("Foreground");
            if (pTarget.GetProperty("UseRandomColor") === true)
                tColor = cdeNMI.CColorToHex('rgb(' + Math.floor(Math.random() * 180) + ',' + Math.floor(Math.random() * 180) + ',' + Math.floor(Math.random() * 180) + ')'); //NOSONAR not crypto related
            const tSt = new cdeNMI.TheStrokePoint();
            tSt.DT = Math.ceil((new Date()).getTime() - (new Date(2014, 4, 1)).getTime());
            tSt.PG = pPointer.Identifier.toString();
            tSt.PO = pPointer.AdjPosition;
            tCanvDraw.MyFirstPoint = new cdeNMI.TheDrawingPoint(pPointer.Position.x, pPointer.Position.y);
            tCanvDraw.MyFirstPoint.t = pPointer.Buttons;
            tCanvDraw.foregroundPolylines[pPointer.Identifier.toString()] = {
                Type: 2,
                Visibility: true,
                ComplexData: [tSt],
                Foreground: tColor
            };
            tCanvDraw.RequestRedraw();
        }
        ExtendPolylineTo(pTarget, pEvent, pPointer) {
            const tCanvDraw = pTarget;
            if (tCanvDraw.foregroundPolylines[pPointer.Identifier.toString()]) {
                const polyline = tCanvDraw.foregroundPolylines[pPointer.Identifier.toString()];
                const p0 = polyline.ComplexData[0];
                const tSt = new cdeNMI.TheStrokePoint();
                tSt.DT = Math.ceil((new Date()).getTime() - (new Date(2014, 4, 1)).getTime()) - p0.DT;
                tSt.PG = pPointer.Identifier.toString();
                tSt.PO = pPointer.AdjPosition;
                tCanvDraw.foregroundPolylines[pPointer.Identifier.toString()].ComplexData.push(tSt);
            }
            tCanvDraw.RequestRedraw();
        }
        EndPolyline(pTarget, pEvent, pPointer) {
            const tCanvDraw = pTarget;
            if (tCanvDraw.foregroundPolylines[pPointer.Identifier.toString()]) {
                const polyline = tCanvDraw.foregroundPolylines[pPointer.Identifier.toString()];
                const p0 = polyline.ComplexData[0];
                const tSt = new cdeNMI.TheStrokePoint();
                tSt.DT = Math.ceil((new Date()).getTime() - (new Date(2014, 4, 1)).getTime()) - p0.DT;
                tSt.PG = pPointer.Identifier.toString();
                tSt.PO = pPointer.AdjPosition;
                tCanvDraw.foregroundPolylines[pPointer.Identifier.toString()].ComplexData.push(tSt);
                if (polyline) {
                    const distance = cdeNMI.Vector2Distance(p0.PO, tSt.PO);
                    if (tCanvDraw.GetProperty("FillDistance") && distance < tCanvDraw.GetProperty("FillDistance")) {
                        polyline.Fill = polyline.Foreground;
                    }
                    polyline.HasEnded = true;
                    tCanvDraw.RequestRedraw();
                    tCanvDraw.FireEvent(false, "OnDrawEnd", pPointer, polyline);
                    const tTargetCtrl = cdeNMI.GetControlFromPoint(tCanvDraw.MyFirstPoint.x, tCanvDraw.MyFirstPoint.y);
                    if (tTargetCtrl) {
                        if (tCanvDraw.MyFirstPoint.t > 1 && distance < 5) {
                            tTargetCtrl.FireEvent(true, "NMI_SHAPE_RECOGNIZED", "rightmouse", 10);
                        }
                        else if (cdeNMI.MyShapeRecognizer && cde.CBool(pTarget.GetProperty("EnableRecognizer"))) {
                            const tRes = cdeNMI.MyShapeRecognizer.RecogizeShape(polyline, 0);
                            if (tRes)
                                tTargetCtrl.FireEvent(true, "NMI_SHAPE_RECOGNIZED", tRes.Name, tRes.Score);
                        }
                    }
                }
            }
        }
        static ProcessColor(pThis, pgbctx, tFill) {
            const tCmd = tFill.substring(0, 3);
            switch (tCmd) {
                case "SVG": //Syntax: "SVG:<svgCode>"
                    {
                        const data = tFill.substring(4);
                        const DOMURL = self.URL || self.webkitURL || self;
                        const svg = new Blob([data], { type: "image/svg+xml;charset=utf-8" });
                        const url = DOMURL.createObjectURL(svg);
                        const img = new Image();
                        img.crossOrigin = 'Anonymous';
                        img.src = url; // data
                        pgbctx.drawImage(img, 100, 100);
                    }
                    return "transparent";
                case "HUE":
                    {
                        let gradient = null;
                        if (pThis.GetProperty("IsVertical"))
                            gradient = pgbctx.createLinearGradient(0, 0, 0, pgbctx.canvas.height);
                        else
                            gradient = pgbctx.createLinearGradient(0, 0, pgbctx.canvas.width, 0);
                        if (pThis.GetProperty("IsInverted")) {
                            gradient.addColorStop(0, "#FF0000");
                            gradient.addColorStop(0.17, "#FF00FF");
                            gradient.addColorStop(0.33, "#0000FF");
                            gradient.addColorStop(0.50, "#00FFFF");
                            gradient.addColorStop(0.67, "#00FF00");
                            gradient.addColorStop(0.83, "#FFFF00");
                            gradient.addColorStop(1, "#FF0000");
                        }
                        else {
                            gradient.addColorStop(0, "#FF0000");
                            gradient.addColorStop(0.17, "#FFFF00");
                            gradient.addColorStop(0.33, "#00FF00");
                            gradient.addColorStop(0.50, "#00FFFF");
                            gradient.addColorStop(0.67, "#0000FF");
                            gradient.addColorStop(0.83, "#FF00FF");
                            gradient.addColorStop(1, "#FF0000");
                        }
                        return gradient;
                    }
                default:
                    {
                        let tBar;
                        if (tFill.length > 9 && tFill.toLowerCase().substring(0, 9) === "gradient(") {
                            tBar = tFill.substr(9, tFill.length - 10).split(',');
                            let tMode = 1;
                            if (pThis.GetProperty("IsVertical"))
                                tMode = 2;
                            return ctrlCanvasDraw.CreateGradient(pgbctx, tBar, tMode, cde.CBool(pThis.GetProperty("IsInverted")));
                        }
                        else if (tFill.length > 10 && tFill.toLowerCase().substring(0, 10) === "gradientc(") {
                            tBar = tFill.substr(10, tFill.length - 11).split(',');
                            return ctrlCanvasDraw.CreateGradient(pgbctx, tBar, 0, cde.CBool(pThis.GetProperty("IsInverted")));
                        }
                        else if (tFill.toLowerCase() === "transparent")
                            tFill = "rgba(0,0,0,0)";
                    }
                    break;
            }
            return tFill;
        }
        static CreateGradient(pgbctx, tBar, pMode, bInverted) {
            let gradient;
            switch (pMode) {
                case 1:
                    gradient = pgbctx.createLinearGradient(0, 0, pgbctx.canvas.width, 0);
                    break;
                case 2:
                    gradient = pgbctx.createLinearGradient(0, 0, 0, pgbctx.canvas.height);
                    break;
                default:
                    gradient = pgbctx.createRadialGradient(pgbctx.canvas.width / 2, pgbctx.canvas.height / 2, 1, pgbctx.canvas.width / 2, pgbctx.canvas.height / 2, pgbctx.canvas.height / 2);
                    break;
            }
            let i;
            if (bInverted) {
                for (i = 0; i < tBar.length; i++) {
                    gradient.addColorStop(i, tBar[i]);
                }
            }
            else {
                for (i = 0; i < tBar.length; i++) {
                    gradient.addColorStop(i, tBar[(tBar.length - 1) - i]);
                }
            }
            return gradient;
        }
    }
    cdeNMI.ctrlCanvasDraw = ctrlCanvasDraw;
    /**
    * Creates a Canvas with Touch and Pen sensitve area
    *
    * (4.1 Ready!)
    */
    class ctrlTouchDraw extends cdeNMI.TheNMIBaseControl {
        constructor(pTRF) {
            super(null, pTRF);
            this.drawingTarget = null; // target of the actual drawing
            this.mBaseDiv = null;
            this.mTextFld = null;
            this.mStrokes = new Array();
            this.mIsTextFldVisible = false;
            this.mIsSynced = false;
            this.mTextToggleButton = null;
            this.mSaveButton = null;
            this.mClearButton = null;
            this.mPlayButton = null;
            this.tBlack = null;
            this.tRed = null;
            this.tGreen = null;
            this.tYellow = null;
            this.tBlue = null;
            this.tPink = null;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.TouchDraw;
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            if (this.MyFieldInfo) {
                this.mIsSynced = cde.CBool(this.GetSetting("IsSynced"));
            }
            this.mBaseDiv = cdeNMI.MyTCF.CreateBaseControl().Create(pTargetControl, { TRF: this.MyTRF });
            this.mBaseDiv.SetElement(document.createElement("div"));
            this.mBaseDiv.SetInitialSize(1);
            this.drawingTarget = cdeNMI.MyTCF.CreateBaseControl().Create(this.mBaseDiv);
            this.drawingTarget.SetElement(document.createElement("div"));
            this.drawingTarget.GetElement().style.cursor = "default";
            this.drawingTarget.GetElement().style.width = "inherit";
            this.drawingTarget.GetElement().style.height = "inherit";
            this.mBaseDiv.AppendChild(this.drawingTarget);
            const holder = this.mBaseDiv.GetElement();
            holder.ondragover = () => {
                this.drawingTarget.GetElement().style.borderLeftWidth = "5px";
                this.drawingTarget.GetElement().style.borderLeftColor = "red";
                return false;
            };
            holder.ondragend = () => {
                this.drawingTarget.GetElement().style.borderLeftWidth = "0px";
                return false;
            };
            holder.ondragleave = () => {
                this.drawingTarget.GetElement().style.borderLeftWidth = "0px";
                return false;
            };
            holder.ondrop = (e) => {
                e.stopPropagation();
                e.preventDefault();
                this.drawingTarget.GetElement().style.borderLeftWidth = "0px";
                this.ProcessFiles(e.dataTransfer.files);
            };
            this.MyDrawingObject = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.CanvasDraw).Create(this.drawingTarget, { TRF: pTRF });
            this.MyDrawingObject.SetProperty("FillDistance", 25);
            if (!this.MyDrawingObject.MyFormID)
                this.MyDrawingObject.MyFormID = this.MyFormID;
            if (!this.MyFieldInfo || !this.MyFieldInfo.Flags || (this.MyFieldInfo && (this.MyFieldInfo.Flags & 2) !== 0)) {
                this.MyDrawingObject.SetProperty("OnPointerDown", this.MyDrawingObject.BeginPolyline);
                this.MyDrawingObject.SetProperty("OnPointerMove", this.MyDrawingObject.ExtendPolylineTo);
                this.MyDrawingObject.SetProperty("OnPointerUp", this.MyDrawingObject.EndPolyline);
                this.MyDrawingObject.SetProperty("OnPointerCancel", this.MyDrawingObject.EndPolyline);
                this.MyDrawingObject.RegisterEvent("OnDrawEnd", (thisObj, pPointer, polyline) => {
                    const pPointerID = pPointer.Identifier;
                    this.mStrokes.push(polyline);
                    this.SetProperty("Value", JSON.stringify(this.mStrokes));
                    if (this.mIsSynced && this.MyTRF && cdeNMI.MyEngine) {
                        cdeNMI.MyEngine.GetBaseEngine().PublishCentral("NEWDRAWOBJECT:" + this.MyTRF.GetHash() + ":REMOTE_" + pPointerID, JSON.stringify(polyline));
                    }
                });
                if (this.mIsSynced)
                    this.RegisterSyncEvents();
                let tButLoc = 0;
                this.mClearButton = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(this.drawingTarget, { PostInitBag: ["TileWidth=1", "TileHeight=1", "Text=Clear", "Style=position:absolute; right:0px;background-color:white; background-image:none; top:0px"] }); //TODO: Convert Style to ClassName!
                this.mClearButton.SetProperty("OnClick", () => {
                    this.ClearPicture();
                    this.SetProperty("Value", "");
                    this.FireEvent(false, "OnClearPicture");
                    if (this.mIsSynced && this.MyTRF && cdeNMI.MyEngine)
                        cdeNMI.MyEngine.GetBaseEngine().PublishCentral("CLEARCANVAS:" + this.MyTRF.GetHash());
                    return false;
                });
                this.mClearButton.SetProperty("TileTop", tButLoc++);
                this.mClearButton.SetProperty("Foreground", "black");
                if (cde.CBool(this.GetSetting("HideClear")))
                    this.mClearButton.SetProperty("Visibility", false);
                this.mSaveButton = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(this.drawingTarget, { PostInitBag: ["TileWidth=1", "TileHeight=1", "Text=Save", "Style=position:absolute; right:0px;background-color:white; background-image:none;"] });
                this.mSaveButton.SetProperty("OnClick", (sender, e, tPs) => {
                    let imageData;
                    let fileExt = ".PNG";
                    if (e.button === 2 || tPs > 1 || (this.GetProperty("FileFormat") && this.GetProperty("FileFormat").toString().length > 0)) {
                        imageData = JSON.stringify(this.mStrokes);
                        let tExt = this.GetProperty("FileFormat");
                        if (!tExt)
                            tExt = "ink2me";
                        fileExt = "." + tExt;
                        if (cde.MyContentEngine)
                            cde.MyContentEngine.SaveFile(imageData, cdeNMI.DateToMini(new Date()) + fileExt, "image/png", false);
                    }
                    else {
                        imageData = this.MyDrawingObject.GetPNG();
                        const tRaw = cdeNMI.convertBase64ToBinary(imageData);
                        if (cde.MyContentEngine)
                            cde.MyContentEngine.SaveFile(tRaw, cdeNMI.DateToMini(new Date()) + fileExt, "image/png", false);
                    }
                    this.FireEvent(false, "OnSavePicture", imageData);
                    if (this.mIsSynced && imageData.length > 1) {
                        cdeNMI.ShowToastMessage("Drawing sent to owner");
                        if (cde.MyContentEngine) {
                            if (this.MyFieldInfo)
                                cde.MyContentEngine.PublishToNode(this.MyFieldInfo.cdeN, "CDE_FILEPUSH:IMG" + cdeNMI.DateToMini(new Date()) + fileExt, imageData);
                            else
                                cde.MyContentEngine.PublishToService("CDE_FILEPUSH:IMG" + cdeNMI.DateToMini(new Date()) + fileExt, imageData);
                        }
                    }
                    return false;
                });
                this.mSaveButton.SetProperty("TileTop", tButLoc++);
                this.mSaveButton.SetProperty("Foreground", "black");
                this.mSaveButton.SetProperty("Visibility", this.mIsSynced);
                this.mPlayButton = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(this.drawingTarget, { PostInitBag: ["TileWidth=1", "TileHeight=1", "Text=Play", "Style=position:absolute; right:0px;background-color:white; background-image:none;"] });
                this.mPlayButton.SetProperty("OnClick", () => {
                    this.MyDrawingObject.SetProperty("Playback", true);
                    this.MyDrawingObject.DrawCanvasBackground();
                    if (this.mIsSynced && this.MyTRF && cdeNMI.MyEngine)
                        cdeNMI.MyEngine.GetBaseEngine().PublishCentral("PLAYBOARD:" + this.MyTRF.GetHash());
                    return false;
                });
                this.mPlayButton.SetProperty("TileTop", tButLoc++);
                this.mPlayButton.SetProperty("Foreground", "black");
                if (!cde.CBool(this.GetSetting("ShowPlay")))
                    this.mPlayButton.SetProperty("Visibility", false);
                if ((this.MyFieldInfo && (this.MyFieldInfo.Flags & 32) !== 0) || (this.GetProperty("Value") && this.GetProperty("Value").substring(0, 2) !== "[{")) {
                    this.ShowTextField(this.GetProperty("Value"), false);
                    this.mTextToggleButton = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(this.mBaseDiv, { PostInitBag: ["TileWidth=1", "TileHeight=1", "Text=Enter Text", "Style=position:absolute; right:0px"] });
                    this.mTextToggleButton.SetProperty("OnClick", () => {
                        if (this.mIsTextFldVisible) {
                            this.mIsTextFldVisible = false;
                            this.drawingTarget.SetProperty("Visibility", true);
                            this.mTextFld.SetProperty("Visibility", false);
                            this.mTextToggleButton.SetProperty("Text", "Enter Text");
                            this.mSaveButton.SetProperty("Disabled", false);
                        }
                        else {
                            this.mIsTextFldVisible = true;
                            this.drawingTarget.SetProperty("Visibility", false);
                            this.mTextFld.SetProperty("Visibility", true);
                            this.mTextToggleButton.SetProperty("Text", "Draw");
                            this.mSaveButton.SetProperty("Disabled", true);
                        }
                        return false;
                    });
                    this.mTextToggleButton.SetProperty("TileTop", 2);
                    this.mTextToggleButton.SetProperty("Foreground", "black");
                }
                else {
                    this.tBlack = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(this.drawingTarget, { PostInitBag: ["TileWidth=1", "TileHeight=1", "Text=Black", "Style=position:absolute; right:0px; background-color:black; background-image:none;"] });
                    this.tBlack.SetProperty("OnClick", () => {
                        this.MyDrawingObject.SetProperty("Foreground", "#000000");
                        return false;
                    });
                    this.tBlack.SetProperty("TileTop", tButLoc++);
                    if (!cde.CBool(this.GetSetting["ShowColors"]))
                        this.tBlack.SetProperty("Visibility", false);
                    this.tRed = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(this.drawingTarget, { PostInitBag: ["TileWidth=1", "TileHeight=1", "Text=Red", "Style=position:absolute; right:0px; background-color:#FF0000; background-image:none;"] });
                    this.tRed.SetProperty("OnClick", () => {
                        this.MyDrawingObject.SetProperty("Foreground", "#FF0000");
                        return false;
                    });
                    this.tRed.SetProperty("TileTop", tButLoc++);
                    if (!cde.CBool(this.GetSetting["ShowColors"]))
                        this.tRed.SetProperty("Visibility", false);
                    this.tGreen = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(this.drawingTarget, { PostInitBag: ["TileWidth=1", "TileHeight=1", "Text=Green", "Style=position:absolute; right:0px; background-color:#00FF00; background-image:none;"] });
                    this.tGreen.SetProperty("OnClick", () => {
                        this.MyDrawingObject.SetProperty("Foreground", "#00FF00");
                        return false;
                    });
                    this.tGreen.SetProperty("TileTop", tButLoc++);
                    if (!cde.CBool(this.GetSetting["ShowColors"]))
                        this.tGreen.SetProperty("Visibility", false);
                    this.tYellow = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(this.drawingTarget, { PostInitBag: ["TileWidth=1", "TileHeight=1", "Text=Yellow", "Style=position:absolute; right:0px; background-color:#FFFF00; background-image:none;"] });
                    this.tYellow.SetProperty("OnClick", () => {
                        this.MyDrawingObject.SetProperty("Foreground", "#FFFF00");
                        return false;
                    });
                    this.tYellow.SetProperty("TileTop", tButLoc++);
                    if (!cde.CBool(this.GetSetting["ShowColors"]))
                        this.tYellow.SetProperty("Visibility", false);
                    this.tBlue = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(this.drawingTarget, { PostInitBag: ["TileWidth=1", "TileHeight=1", "Text=Blue", "Style=position:absolute; right:0px; background-color:#0000FF; background-image:none;"] });
                    this.tBlue.SetProperty("OnClick", () => {
                        this.MyDrawingObject.SetProperty("Foreground", "#0000FF");
                        return false;
                    });
                    this.tBlue.SetProperty("TileTop", tButLoc++);
                    if (!cde.CBool(this.GetSetting["ShowColors"]))
                        this.tBlue.SetProperty("Visibility", false);
                    this.tPink = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(this.drawingTarget, { PostInitBag: ["TileWidth=1", "TileHeight=1", "Text=Pink", "Style=position:absolute; right:0px; background-color:#FF00FF; background-image:none;"] });
                    this.tPink.SetProperty("OnClick", () => {
                        this.MyDrawingObject.SetProperty("Foreground", "#FF00FF");
                        return false;
                    });
                    this.tPink.SetProperty("TileTop", tButLoc++);
                    if (!cde.CBool(this.GetSetting["ShowColors"]))
                        this.tPink.SetProperty("Visibility", false);
                }
            }
            if (window.addEventListener) {
                window.addEventListener("resize", () => { this.ResizeEventHandler(); }, false);
            }
            this.SetElement(this.mBaseDiv.GetElement());
            if (!this.MyFieldInfo || (this.MyFieldInfo && (this.MyFieldInfo.Flags & 2) !== 0)) {
                this.PreventDefaultManipulationAndMouseEvent(null);
            }
            if (this.MyFormID && cdeNMI.MyScreenManager) {
                const tScreen = cdeNMI.MyScreenManager.GetScreenByID(this.MyFormID);
                if (tScreen)
                    tScreen.RegisterEvent("OnLoaded", () => this.ResizeEventHandler());
            }
            this.MyDrawingObject.ApplySkin();
            pTargetControl.RegisterEvent("OnLoaded", () => {
                this.ResizeEventHandler();
            });
            return true;
        }
        SetProperty(pName, pValue) {
            if (pName === "iValue") {
                if (pValue === this.GetProperty("Value"))
                    return;
                this.mStrokes = new Array();
                this.ClearPicture();
                if (!pValue || pValue === '') {
                    if (this.MyDrawingObject)
                        this.MyDrawingObject.SetProperty("DataContext", null);
                }
                else {
                    if (pValue.substring(0, 2) === "[{") {
                        if (this.MyDrawingObject) {
                            let pObjects;
                            try {
                                pObjects = JSON.parse(pValue);
                                this.MyDrawingObject.SetProperty("DataContext", pObjects);
                            }
                            catch (e) {
                                this.MyDrawingObject.SetProperty("DataContext", null);
                            }
                        }
                    }
                    else {
                        if (!this.mTextFld)
                            this.ShowTextField(pValue, true);
                        else
                            this.mTextFld.SetProperty("Value", pValue);
                    }
                }
            }
            else if (pName === "IsSynced") {
                pValue = cde.CBool(pValue);
                if (this.mIsSynced === false && pValue)
                    this.RegisterSyncEvents();
                this.mIsSynced = pValue;
                if (this.mSaveButton)
                    this.mSaveButton.SetProperty("Visibility", this.mIsSynced);
            }
            else if (pName === "ShowSave") {
                this.mSaveButton.SetProperty("Visibility", cde.CBool(pValue));
            }
            else if (pName === "ShowPlay") {
                this.mPlayButton.SetProperty("Visibility", cde.CBool(pValue));
            }
            else if (pName === "ShowColors") {
                this.tBlack.SetProperty("Visibility", cde.CBool(pValue));
                this.tBlue.SetProperty("Visibility", cde.CBool(pValue));
                this.tGreen.SetProperty("Visibility", cde.CBool(pValue));
                this.tPink.SetProperty("Visibility", cde.CBool(pValue));
                this.tRed.SetProperty("Visibility", cde.CBool(pValue));
                this.tYellow.SetProperty("Visibility", cde.CBool(pValue));
            }
            else if (pName === "IsAbsolute") {
                if (cde.CBool(pValue)) {
                    this.mBaseDiv.GetElement().style.position = "absolute";
                    this.drawingTarget.GetElement().style.position = "absolute";
                }
                else {
                    this.mBaseDiv.GetElement().style.position = "relative";
                    this.drawingTarget.GetElement().style.position = "relative";
                }
            }
            else if (pName === "IsOverlay") {
                pValue = cde.CBool(pValue);
                this.tBlack.SetProperty(pName, pValue);
                this.tYellow.SetProperty(pName, pValue);
                this.tGreen.SetProperty(pName, pValue);
                this.tRed.SetProperty(pName, pValue);
                this.tBlue.SetProperty(pName, pValue);
                this.tPink.SetProperty(pName, pValue);
                this.mSaveButton.SetProperty(pName, pValue);
                this.mPlayButton.SetProperty(pName, pValue);
                this.mClearButton.SetProperty(pName, pValue);
            }
            if (this.MyDrawingObject && pName !== "Style") {
                this.MyDrawingObject.SetProperty(pName, pValue);
            }
            super.SetProperty(pName, pValue);
            if (pName === "AutoAdjust") {
                this.ResizeEventHandler();
            }
        }
        GetProperty(pName) {
            if (pName === "Value" && this.MyFieldInfo && (this.MyFieldInfo.Flags & 1) === 0) {
                if (this.mIsTextFldVisible)
                    return this.mTextFld.GetProperty("Value");
            }
            return super.GetProperty(pName);
        }
        ProcessFiles(pFileList) {
            if (!pFileList || !pFileList.length)
                return;
            const file = pFileList[0];
            if (file.name.length > 8 && file.name.substring(file.name.length - 7) === ".ink2me") {
                const reader = new FileReader();
                reader.onload = () => {
                    const tres = reader.result;
                    this.SetProperty("iValue", tres);
                    if (this.mIsSynced && this.MyTRF && cdeNMI.MyEngine) {
                        cdeNMI.MyEngine.GetBaseEngine().PublishCentral("SCREENSYNC:" + this.MyTRF.GetHash(), tres);
                    }
                };
                reader.readAsText(file);
            }
        }
        PostCreate(pTE) {
            this.RegisterEvent("OnSavePicture", (thisObj, pData) => {
                if (cde.MyContentEngine) {
                    if (this.MyFieldInfo)
                        cde.MyContentEngine.PublishToNode(this.MyFieldInfo.cdeN, "CDE_FILEPUSH:IMG" + cdeNMI.DateToMini(new Date()) + ".PNG", pData);
                    else
                        cde.MyContentEngine.PublishToService("CDE_FILEPUSH:IMG" + cdeNMI.DateToMini(new Date()) + ".PNG", pData);
                }
            });
        }
        RegisterSyncEvents() {
            this.RegisterIncomingMessage(cdeNMI.eTheNMIEngine, (thisObj, pMSG) => {
                const tCmd = pMSG.Message.TXT.split(':');
                if (tCmd[1] === thisObj.MyTRF.GetHash()) {
                    switch (tCmd[0]) {
                        case "CLEARCANVAS":
                            thisObj.MyDrawingObject.ClearPicture();
                            break;
                        case "NEWDRAWOBJECT":
                            thisObj.MyDrawingObject.AddDrawingObject(JSON.parse(pMSG.Message.PLS), tCmd[2]);
                            break;
                        case "PLAYBOARD":
                            this.MyDrawingObject.SetProperty("Playback", true);
                            this.MyDrawingObject.DrawCanvasBackground();
                            break;
                        case "SCREENSYNC":
                            this.SetProperty("iValue", pMSG.Message.PLS);
                            break;
                        default:
                            break;
                    }
                }
            });
        }
        AddDrawingObject(pObject, id) {
            this.MyDrawingObject.AddDrawingObject(pObject, id);
        }
        SetMsgsAndTargetWidth(tEle) {
            if (!this.MyTarget)
                return;
            const multidrawWidth = tEle.offsetWidth;
            const multidrawHeight = tEle.offsetHeight;
            if (multidrawWidth > 0 && this.drawingTarget) {
                this.drawingTarget.GetElement().style.width = multidrawWidth.toString() + "px";
            }
            if (multidrawHeight > 0 && this.drawingTarget)
                this.drawingTarget.GetElement().style.height = multidrawHeight.toString() + "px";
            this.MyDrawingObject.ApplySkin();
            this.MyDrawingObject.DrawCanvasBackground();
            this.MyDrawingObject.RequestRedraw();
        }
        ClearPicture() {
            if (this.mTextFld)
                this.mTextFld.SetProperty("Value", "");
            if (this.MyDrawingObject)
                this.MyDrawingObject.ClearPicture();
        }
        ResizeEventHandler() {
            this.mBaseDiv.GetElement().style.width = "inherit";
            this.mBaseDiv.GetElement().style.height = "inherit";
            this.MyDrawingObject.ApplySkin();
            this.SetMsgsAndTargetWidth(this.MyTarget.GetElement());
        }
        ShowTextField(pContent, bShowRightAway) {
            if (!this.mBaseDiv)
                return;
            const tFldInfo = new cdeNMI.TheFieldInfo(cdeNMI.cdeControlType.TextArea, 8, "");
            if (this.MyFieldInfo) {
                tFldInfo.Flags = this.MyFieldInfo.Flags;
                tFldInfo.FormID = this.MyFieldInfo.FormID;
            }
            this.mTextFld = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SingleEnded).Create(null, { TRF: new cdeNMI.TheTRF("", 0, tFldInfo), PostInitBag: ["iValue=" + pContent] });
            this.mTextFld.SetProperty("Rows", 10);
            this.mBaseDiv.AppendChild(this.mTextFld);
            if (bShowRightAway)
                this.drawingTarget.SetProperty("Visibility", false);
            else
                this.mTextFld.SetProperty("Visibility", false);
        }
        //legacy support
        static Create(pTarget, pTRF, pUseAbsolute, pXL, pYL, pFldContent) {
            const tTile = new cdeNMI.ctrlTouchDraw(pTRF);
            tTile.InitControl(pTarget, pTRF);
            if (pFldContent)
                tTile.SetProperty("iValue", pFldContent);
            return tTile;
        }
    }
    cdeNMI.ctrlTouchDraw = ctrlTouchDraw;
    /**
    * Creates A draw Overlay ontop of another Control
    * The pTargetControl will be overlayed by the ctrlDrawOverlay
    * pTRF is handed to ctrlTouchDraw
    *
    * This control is NOT and input control for Form or Table
    *
    * (4.1 Ready!)
    */
    class ctrlDrawOverlay extends cdeNMI.TheNMIBaseControl {
        constructor(pTRF) {
            super(null, pTRF);
            this.divTiles = null;
            this.mDrawCanvas = null;
            this.CurrentControl = null;
            this.WasTouchedDownOn = false; //Workaround for Chrome
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.DrawOverlay;
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            this.divTiles = document.createElement('div');
            this.divTiles.style.position = "absolute";
            this.divTiles.style.top = "0px";
            this.divTiles.style.left = "0px";
            if (pTargetControl) {
                this.divTiles.style.width = pTargetControl.GetContainerElement().clientWidth - 5 + "px"; //-5 required to avoid scrollbars
                this.divTiles.style.height = pTargetControl.GetContainerElement().clientHeight - 5 + "px";
            }
            this.divTiles.id = "cdeOverlay";
            this.divTiles.className = "cdeDrawOverlay";
            this.divTiles.style.transformOrigin = "top left";
            const tScreen = cdeNMI.MyScreenManager.GetScreenByID(pScreenID);
            if (tScreen && tScreen.ScreenScale != 1.0 && tScreen.ScreenScale != 0.0) {
                this.divTiles.style.transform = "scale(" + 1 / tScreen.ScreenScale + ")";
            }
            this.SetElement(this.divTiles, false);
            this.PreventDefault = true;
            this.PreventManipulation = true;
            this.PreventDefaultManipulationAndMouseEvent(null);
            this.mDrawCanvas = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TouchDraw).Create(this, { TRF: (this.MyTRF ? this.MyTRF : new cdeNMI.TheTRF("", 0, this.MyFieldInfo)) });
            this.CurrentControl = this.mDrawCanvas;
            this.HookEvents(false);
            return true;
        }
        SetProperty(pName, pValue) {
            if (pName === "AutoAdjust") {
                super.SetProperty(pName, pValue);
                if (window.addEventListener) {
                    window.addEventListener("resize", () => { this.ResizeEventHandler(); }, false);
                }
                this.ResizeEventHandler();
            }
            this.mDrawCanvas.SetProperty(pName, pValue);
        }
        ResizeEventHandler() {
            const w = window.innerWidth
                || document.documentElement.clientWidth
                || document.body.clientWidth;
            const h = window.innerHeight
                || document.documentElement.clientHeight
                || document.body.clientHeight;
            this.divTiles.style.width = w + "px";
            this.divTiles.style.height = h + "px";
        }
        //Legacy Support
        static Create(pTargetControl, pTRF, pClassName) {
            const t = new ctrlDrawOverlay(pTRF);
            t.InitControl(pTargetControl, pTRF);
            if (pClassName)
                t.SetProperty("ClassName", pClassName);
            return t;
        }
    }
    cdeNMI.ctrlDrawOverlay = ctrlDrawOverlay;
    /**
* Creates a vertical or horizontal bar Chart
*
* (4.1 Ready!)
*/
    class ctrlHashIcon extends cdeNMI.TheNMIBaseControl {
        constructor(pTRF) {
            super(null, pTRF);
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.BarChart;
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            this.mBaseCtrl = cdeNMI.MyTCF.CreateBaseControl().Create(pTargetControl, { TRF: this.MyTRF });
            this.mBaseCtrl.SetElement(document.createElement("div"));
            this.mBaseCtrl.SetInitialSize(1);
            this.mBaseCtrl.GetElement().style.position = "relative";
            this.mCanvas = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.CanvasDraw).Create(this.mBaseCtrl, { TRF: pTRF });
            this.SetElement(this.mBaseCtrl.GetElement(), true);
            if (this.MyFormID && cdeNMI.MyScreenManager) {
                const tScreen = cdeNMI.MyScreenManager.GetScreenByID(this.MyFormID);
                if (tScreen)
                    tScreen.RegisterEvent("OnLoaded", () => this.ApplySkin());
            }
            return true;
        }
        ApplySkin() {
            this.UpdateBar(this.GetProperty("Value"));
        }
        UpdateBar(pValue) {
            if (!this.mCanvas)
                return;
            this.mCanvas.ApplySkin();
            if (this.mCanvas.MyHeight === 0 || this.mCanvas.MyWidth === 0) {
                this.mCanvas.ResizeCanvas();
                if (this.mCanvas.MyHeight === 0 || this.mCanvas.MyWidth === 0)
                    return;
            }
            this.tIcon = new cdeNMI.TheDrawingObject();
            this.tIcon.Type = 7;
            this.tIcon.Visibility = true;
            this.tIcon.ComplexData = pValue;
            this.tIcon.Width = cdeNMI.GetSizeFromTile(cde.CInt(this.GetProperty("TileWidth"))) - 8;
            this.tIcon.Left = 4;
            this.tIcon.Top = 4;
            this.mRectangle = [];
            this.mRectangle.push(this.tIcon);
            this.mCanvas.SetProperty("DataContext", this.mRectangle);
        }
        SetProperty(pName, pValue) {
            if (pName === "iValue" || pName === "Value") {
                this.UpdateBar(pValue);
            }
            else if ((pName === "ControlTW" || pName === "ControlTH" || pName === "DrawMargin") && this.mCanvas) {
                pValue = cde.CInt(pValue);
                this.mCanvas.SetProperty(pName, pValue);
            }
            super.SetProperty(pName, pValue);
        }
    }
    cdeNMI.ctrlHashIcon = ctrlHashIcon;
    /**
* Creates a vertical or horizontal bar Chart
*
* (4.1 Ready!)
*/
    class ctrlBarChart extends cdeNMI.TheNMIBaseControl {
        constructor(pTRF) {
            super(null, pTRF);
            this.wasDrawnOnce = false;
            this.mBarColor = "#52D0EB";
            this.mMaxValue = 100;
            this.mMinValue = 0;
            this.IsPointerDown = false;
            this.PointerID = 0;
            this.Scale = 1.0;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.BarChart;
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            if (cde.MyBaseAssets.MyServiceHostInfo.IsLiteTheme)
                this.mBarColor = 'rgba(82,208,235,0.9)';
            else
                this.mBarColor = 'rgba(29,163,209,0.9)';
            this.mBaseCtrl = cdeNMI.MyTCF.CreateBaseControl().Create(pTargetControl, { TRF: this.MyTRF });
            this.mBaseCtrl.SetElement(document.createElement("div"));
            this.mBaseCtrl.GetElement().className = "ctrlBarChart";
            this.mBaseCtrl.GetElement().style.position = "relative";
            this.mCanvas = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.CanvasDraw).Create(this.mBaseCtrl, { TRF: pTRF });
            this.SetElement(this.mBaseCtrl.GetElement(), true);
            this.SetProperty("Disabled", (!this.MyFieldInfo || (this.MyFieldInfo.Flags & 2) === 0));
            if (this.MyFormID && cdeNMI.MyScreenManager) {
                const tScreen = cdeNMI.MyScreenManager.GetScreenByID(this.MyFormID);
                if (tScreen) {
                    tScreen.RegisterEvent("OnLoaded", () => this.ApplySkin());
                    if (tScreen.ScreenScale != 1.0 && tScreen.ScreenScale != 0.0) {
                        this.Scale = 1.0; // 1/tScreen.ScreenScale
                    }
                }
            }
            cde.MyBaseAssets.RegisterEvent("ThemeSwitched", () => {
                if (cde.MyBaseAssets.MyServiceHostInfo.IsLiteTheme)
                    this.mBarColor = 'rgba(82,208,235,0.9)';
                else
                    this.mBarColor = 'rgba(29,163,209,0.9)';
                this.UpdateBar(this.GetProperty("Value"));
            });
            return true;
        }
        SetProperty(pName, pValue) {
            let isDirty = false;
            if (pName === "iValue" || pName === "Value") {
                if (!cde.IsNotSet(this.GetProperty("Format")))
                    pValue = parseFloat(pValue).toFixed(parseInt(this.GetProperty("Format")));
            }
            else if (pName === "Disabled") {
                if ((!this.MyFieldInfo || (this.MyFieldInfo.Flags & 2) === 0))
                    pValue = true;
                this.EnableDisable(cde.CBool(pValue));
            }
            super.SetProperty(pName, pValue);
            let tStyle;
            if (pName === "Foreground") {
                tStyle = document.createElement("span");
                tStyle.style.color = pValue;
                this.mBarColor = tStyle.style.color;
                isDirty = true;
            }
            else if (pName === "Value" || pName === "iValue") {
                this.FireEvent(true, "BarChanged", "SetProperty", pValue);
                isDirty = true;
            }
            else if (pName === "MaxValue") {
                this.mMaxValue = cde.CDbl(pValue);
                isDirty = true;
            }
            else if (pName === "MinValue") {
                this.mMinValue = cde.CDbl(pValue);
                isDirty = true;
            }
            else if (pName === "MainBackground") {
                this.mBaseCtrl.GetElement().style.backgroundColor = pValue;
                isDirty = true;
            }
            else if (pName === "Background") {
                if (cde.CInt(pValue) > 0) {
                    tStyle = document.createElement("span");
                    tStyle.style.color = pValue;
                    this.mCanvas.SetProperty("Background", tStyle.style.color);
                }
                else
                    this.mCanvas.SetProperty("Background", pValue);
                isDirty = true;
            }
            else if (pName === "ForegroundOpacity") {
                this.mCanvas.SetProperty("Opacity", pValue);
                isDirty = true;
            }
            else if (pName === "LabelColor") {
                isDirty = true;
            }
            else if (pName === "IsVertical") {
                pValue = cde.CBool(pValue);
                if (pValue) {
                    super.SetProperty("IsVertical", pValue);
                }
                this.mCanvas.SetProperty("IsVertical", pValue);
                isDirty = true;
            }
            else if (pName === "IsInverted") {
                pValue = cde.CBool(pValue);
                if (cde.CBool(pValue)) {
                    super.SetProperty("IsInverted", pValue);
                }
                this.mCanvas.SetProperty("IsInverted", pValue);
                isDirty = true;
            }
            else if ((pName === "ControlTW" || pName === "ControlTH" || pName === "DrawMargin" || pName === "TileFactorX" || pName === "TileFactorY") && this.mCanvas) {
                pValue = cde.CInt(pValue);
                this.mCanvas.SetProperty(pName, pValue);
                isDirty = true;
            }
            else if (pName === "BarColorChanged") {
                this.RegisterEvent(pName, pValue);
            }
            if (isDirty)
                this.UpdateBar(this.GetProperty("Value"));
        }
        ApplySkin() {
            this.UpdateBar(this.GetProperty("Value"));
        }
        UpdateBar(pValue) {
            if (!this.mCanvas)
                return;
            this.mCanvas.ApplySkin();
            if (this.mCanvas.MyHeight === 0 || this.mCanvas.MyWidth === 0) {
                this.mCanvas.ResizeCanvas();
                if (this.mCanvas.MyHeight === 0 || this.mCanvas.MyWidth === 0)
                    return;
            }
            if (pValue === "")
                pValue = 0;
            this.wasDrawnOnce = true;
            this.tText = new cdeNMI.TheDrawingObject();
            this.tText.Type = 3;
            this.tText.Visibility = true;
            this.tRect = new cdeNMI.TheDrawingObject();
            this.tRect.Type = 1;
            if (this.GetProperty("IsVertical") === true) {
                this.tRect.Left = 0;
                this.tText.Left = 12;
                this.tRect.Width = this.mCanvas.MyWidth;
                if (this.GetProperty("IsInverted") === true) {
                    this.tRect.Top = 0;
                    this.tRect.Height = (this.mCanvas.MyHeight / (this.mMaxValue - this.mMinValue) * (parseFloat(pValue) - this.mMinValue));
                    this.tText.Top = this.tRect.Height + 12;
                }
                else {
                    this.tRect.Top = this.mCanvas.MyHeight - (this.mCanvas.MyHeight / (this.mMaxValue - this.mMinValue) * (parseFloat(pValue) - this.mMinValue));
                    this.tRect.Height = this.mCanvas.MyHeight;
                    this.tText.Top = this.tRect.Top - 12;
                }
                this.tRect.Fill = this.mBarColor;
            }
            else {
                this.tRect.Top = 0;
                this.tText.Top = 12;
                if (this.GetProperty("IsInverted") === true) {
                    this.tRect.Left = this.mCanvas.MyWidth - (this.mCanvas.MyWidth / (this.mMaxValue - this.mMinValue) * (cde.CDbl(pValue) - this.mMinValue));
                    this.tRect.Width = this.mCanvas.MyWidth;
                    this.tText.Left = this.tRect.Left + 12;
                }
                else {
                    this.tRect.Left = 0;
                    this.tRect.Width = (this.mCanvas.MyWidth / (this.mMaxValue - this.mMinValue) * (cde.CDbl(pValue) - this.mMinValue));
                    this.tText.Left = this.tRect.Width + 12;
                }
                this.tRect.Height = this.mCanvas.MyHeight;
                this.tRect.Fill = this.mBarColor;
            }
            if (cde.CBool(this.GetProperty("AutoAdjust"))) {
                if (cde.CDbl(pValue) > this.mMaxValue)
                    this.mMaxValue = parseFloat(pValue);
                if (cde.CDbl(pValue) < this.mMinValue)
                    this.mMinValue = parseFloat(pValue);
            }
            this.tRect.Visibility = true;
            this.tRect.IsTemp = true;
            this.mRectangle = [];
            this.mRectangle.push(this.tRect);
            this.tText.ComplexData = {};
            this.tText.ComplexData.Text = cde.CDbl(pValue).toFixed(0);
            this.tText.ComplexData.Font = "8pt Roboto";
            if (this.GetProperty("LabelColor"))
                this.tText.Fill = this.GetProperty("LabelColor");
            else
                this.tText.Fill = "black";
            this.tText.IsTemp = true;
            this.mRectangle.push(this.tText);
            this.mCanvas.SetProperty("DataContext", this.mRectangle);
        }
        CreateClip(pCanvas) {
            const ctx = pCanvas.getContext('2d');
            // Create a shape, of some sort
            ctx.beginPath();
            ctx.moveTo(10, 10);
            ctx.lineTo(100, 30);
            ctx.lineTo(180, 10);
            ctx.lineTo(200, 60);
            ctx.arcTo(222, 70, 120, 0, 10);
            ctx.lineTo(200, 180);
            ctx.lineTo(100, 150);
            ctx.lineTo(70, 180);
            ctx.lineTo(20, 130);
            ctx.lineTo(50, 70);
            ctx.closePath();
            // Clip to the current path
            ctx.clip();
        }
        EnableDisable(IsDisabled) {
            if (IsDisabled) {
                this.UnregisterEvent("PointerDown");
                this.UnregisterEvent("PointerMove");
                this.UnregisterEvent("PointerUp");
                this.UnregisterEvent("PointerCancel");
                this.PreventManipulation = false;
                this.PreventDefault = false;
            }
            else {
                this.RegisterEvent("PointerDown", (sender, evt, pt) => { this.sinkPointerDown(sender, evt, pt); });
                this.RegisterEvent("PointerMove", (sender, evt, pt) => { this.sinkTranslate(sender, evt, pt); });
                this.RegisterEvent("PointerUp", (sender, evt, pt) => { this.sinkPointerUp(sender, evt, pt); });
                this.RegisterEvent("PointerCancel", (sender, evt, pt) => { this.sinkPointerCancel(sender, evt, pt); });
                this.PreventManipulation = true;
                this.PreventDefault = true;
            }
            this.PreventDefaultManipulationAndMouseEvent(null);
        }
        sinkPointerCancel(pTarget, pEvent, pPointer) {
            if (this.GetProperty("Disabled") === true)
                return;
            const thisObj = pTarget;
            if (cde.CBool(thisObj.GetProperty("AllowSetOnCancel")) && (pPointer.pointerType !== cdeNMI.cdeInputEventType.MOUSE || cdeNMI.IsMouseDown)) {
                thisObj.sinkPointerUp(pTarget, pEvent, pPointer);
            }
            else
                thisObj.UpdateBar(thisObj.GetProperty("Value"));
        }
        sinkPointerUp(pTarget, pEvent, pPointer) {
            if (pTarget.GetProperty("Disabled") === true)
                return;
            const thisObj = pTarget;
            thisObj.IsPointerDown = false;
            thisObj.PointerID = 0;
            if (pPointer.pointerEvent === cdeNMI.cdeInputEvent.END)
                thisObj.CalcNewPos(pPointer.AdjPosition.x / thisObj.Scale, pPointer.AdjPosition.y / thisObj.Scale, 1);
        }
        sinkPointerDown(pTarget, pEvent, pPointer) {
            if (pTarget.GetProperty("Disabled") === true)
                return;
            const thisObj = pTarget;
            if (!thisObj.IsPointerDown && thisObj.GetProperty("Disabled") !== true) {
                thisObj.IsPointerDown = true;
                thisObj.PointerID = pPointer.Identifier;
                thisObj.CalcNewPos(pPointer.AdjPosition.x / thisObj.Scale, pPointer.AdjPosition.y / thisObj.Scale, 0);
            }
        }
        sinkTranslate(pTarget, pEvent, pPointer) {
            if (pTarget.GetProperty("Disabled") === true)
                return;
            const thisObj = pTarget;
            const tPS = thisObj.GetProperty("TouchPoints");
            if (tPS > 1)
                thisObj.CalcNewPos(pPointer.AdjPosition.x / thisObj.Scale, pPointer.AdjPosition.y / thisObj.Scale, 2);
            else
                thisObj.CalcNewPos(pPointer.AdjPosition.x / thisObj.Scale, pPointer.AdjPosition.y / thisObj.Scale, 0);
        }
        CalcNewPos(pX, pY, bSetVal) {
            if (!this.mCanvas)
                return;
            if (this.mCanvas.MyHeight === 0 || this.mCanvas.MyWidth === 0) {
                this.mCanvas.ResizeCanvas();
                if (this.mCanvas.MyHeight === 0 || this.mCanvas.MyWidth === 0)
                    return;
            }
            const tVal = this.GetProperty("Value");
            let tNewVal;
            if (this.GetProperty("IsVertical") === true) {
                if (this.GetProperty("IsInverted") !== true)
                    tNewVal = ((this.mCanvas.MyHeight - pY) * ((this.mMaxValue - this.mMinValue) / this.mCanvas.MyHeight)) + this.mMinValue;
                else
                    tNewVal = ((pY) * ((this.mMaxValue - this.mMinValue) / this.mCanvas.MyHeight)) + this.mMinValue;
            }
            else {
                if (this.GetProperty("IsInverted") !== true)
                    tNewVal = ((pX) * ((this.mMaxValue - this.mMinValue) / this.mCanvas.MyWidth)) + this.mMinValue;
                else
                    tNewVal = ((this.mCanvas.MyWidth - pX) * ((this.mMaxValue - this.mMinValue) / this.mCanvas.MyWidth)) + this.mMinValue;
            }
            if (!cde.CBool(this.GetProperty("UseFloat")))
                tNewVal = Math.round(tNewVal);
            if (tVal !== tNewVal && tNewVal !== -1) {
                if (bSetVal > 0) {
                    if (bSetVal === 1 || Math.abs(tNewVal - tVal) > 10) {
                        this.SetProperty("Value", tNewVal);
                        this.FireEvent(false, "ValueSet", { x: pX, y: pY });
                        if (this.MyFieldInfo && cde.CBool(this.GetProperty("SendColor")) === true) {
                            const ctx = this.mCanvas.GetBGRenderContext();
                            const colorData = ctx.getImageData(pX, pY, 1, 1).data;
                            const tColor = "rgb(" + colorData[0] + "," + colorData[1] + "," + colorData[2] + ")";
                            this.FireEvent(false, "BarColorChanged", this.rgbToHex(tColor));
                        }
                    }
                    if (bSetVal === 1) {
                        const MatTouch = new cdeNMI.TheMaterialTouch();
                        MatTouch.ShowWave(this.GetElement(), { x: pX, y: pY });
                    }
                }
                else {
                    this.FireEvent(true, "BarChanged", "CalcNewPos", tNewVal);
                    this.UpdateBar(tNewVal);
                }
            }
        }
        hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return "rgb(" + parseInt(result[1], 16) + "," + parseInt(result[2], 16) + "," + parseInt(result[3], 16) + ")";
        }
        rgbToHex(rgb) {
            const result = rgb.match(/\d+/g);
            function hex(x) {
                const digits = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "A", "B", "C", "D", "E", "F"];
                return isNaN(x) ? "00" : digits[(x - x % 16) / 16] + digits[x % 16];
            }
            return "#" + hex(result[0]) + hex(result[1]) + hex(result[2]);
        }
        //Backwards Compat
        static Create(pTarget, pTRF) {
            const t = new ctrlBarChart(pTRF);
            t.InitControl(pTarget, pTRF);
            return t;
        }
    }
    cdeNMI.ctrlBarChart = ctrlBarChart;
    /**
     * Creates a vertical or horizontal slider looking like a rubber band
     * MultiTouch Scroll increases Value 5x Touchpoint - but Bar should not scroll differently!
     * (4.1 Ready!)
    **/
    class ctrlEndlessSlider extends cdeNMI.TheNMIBaseControl {
        constructor(pTRF) {
            super(null, pTRF);
            this.mCanvas = null;
            this.LastMiniValue = 0;
            this.mBaseCtrl = null;
            this.mDebugLabel = null;
            this.mDebugLabel2 = null;
            this.mRangeSet = "";
            this.mAllowRollover = false;
            this.mAllowOffBelowMin = false;
            this.mMinVal = 0;
            this.mMaxVal = 1000;
            this.mSnapper = 0;
            this.mRoundTo = 1;
            this.mStepFactor = 10;
            this.mLines = 15;
            this.mLineWidth = 10;
            this.mLineGap = 40;
            this.mIsVertical = false;
            this.mIsInverted = false;
            this.mReturnDeltaOnly = false;
            this.mLineColor = "black";
            this.Is10x = false;
            this.TranslateSpeed = 1;
            this.IsPointerDown = false;
            this.LastMousePositionX = 0;
            this.LastMousePositionY = 0;
            this.ScrollValueTemp = 0;
            this.mLastScrollValue = 0;
            this.PointerID = 0;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.Slider;
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            this.mBaseCtrl = cdeNMI.MyTCF.CreateBaseControl().Create(pTargetControl, { TRF: this.MyTRF });
            this.mBaseCtrl.SetElement(document.createElement("div"));
            this.mBaseCtrl.SetInitialSize(1);
            this.mBaseCtrl.GetElement().className = "ctrlEndlessSlider";
            this.mBaseCtrl.GetElement().style.position = "relative";
            this.mCanvas = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.CanvasDraw).Create(this.mBaseCtrl, { TRF: pTRF });
            this.SetProperty("iValue", 0);
            this.CreateLines();
            this.SetElement(this.mBaseCtrl.GetElement(), true);
            this.SetProperty("Disabled", !this.MyFieldInfo || (this.MyFieldInfo.Flags & 2) === 0);
            if (this.MyFormID && cdeNMI.MyScreenManager) {
                const tScreen = cdeNMI.MyScreenManager.GetScreenByID(this.MyFormID);
                if (tScreen)
                    tScreen.RegisterEvent("OnLoaded", () => this.ApplySkin());
            }
            return true;
        }
        SetProperty(pName, pValue) {
            if (pName === "Disabled") {
                if ((!this.MyFieldInfo || (this.MyFieldInfo.Flags & 2) === 0))
                    pValue = true;
                this.EnableDisable(cde.CBool(pValue));
            }
            super.SetProperty(pName, pValue);
            let UpdateLines = true;
            if (pName === "Foreground") {
                this.mLineColor = pValue;
            }
            else if (pName === "iValue") {
                this.mLastScrollValue = cde.CDbl(pValue) / this.mStepFactor;
                super.SetProperty("iValue", cde.CDbl(pValue));
                UpdateLines = false;
                this.CreateLines();
                this.RepositionLines();
            }
            else if (pName === "Value") {
                super.SetProperty("iValue", cde.CDbl(pValue));
                this.ScrollValueTemp = cde.CDbl(pValue) / this.mStepFactor;
                this.internalValueChanged(this.ScrollValueTemp, true);
                this.mLastScrollValue = this.ScrollValueTemp;
                UpdateLines = false;
                this.IsDirty = true;
            }
            else if (pName === "MaxValue") {
                this.mMaxVal = cde.CDbl(pValue);
                UpdateLines = false;
            }
            else if (pName === "MinValue") {
                this.mMinVal = cde.CDbl(pValue);
                UpdateLines = false;
            }
            else if (pName === "StepFactor") {
                this.mStepFactor = cde.CDbl(pValue);
                UpdateLines = false;
            }
            else if (pName === "AllowRollover") {
                this.mAllowRollover = cde.CBool(pValue);
                UpdateLines = false;
            }
            else if (pName === "IsVertical") {
                this.mIsVertical = cde.CBool(pValue);
            }
            else if (pName === "Background") {
                this.mCanvas.SetProperty("Background", pValue);
                this.mCanvas.RequestRedraw();
            }
            else if (pName === "MainBackground") {
                this.mBaseCtrl.GetElement().style.backgroundColor = pValue;
                this.mCanvas.RequestRedraw();
            }
            else if (pName === "LineWidth") {
                this.mLineWidth = cde.CInt(pValue);
            }
            else if (pName === "LineGap") {
                this.mLineGap = cde.CInt(pValue);
            }
            else if ((pName === "ControlTW" || pName === "ControlTH") && this.mCanvas) {
                this.mCanvas.SetProperty(pName, cde.CInt(pValue));
                UpdateLines = true;
            }
            if (UpdateLines) {
                this.ApplySkin();
            }
        }
        ApplySkin() {
            this.CreateLines();
            this.RepositionLines();
        }
        EnableDisable(IsDisabled) {
            if (IsDisabled) {
                this.UnregisterEvent("PointerDown");
                this.UnregisterEvent("PointerMove");
                this.UnregisterEvent("PointerUp");
                this.PreventManipulation = false;
                this.PreventDefault = false;
            }
            else {
                this.RegisterEvent("PointerDown", this.sinkPointerDown);
                this.RegisterEvent("PointerMove", this.sinkTranslate);
                this.RegisterEvent("PointerUp", this.sinkPointerUp);
                this.PreventManipulation = true;
                this.PreventDefault = true;
            }
            this.PreventDefaultManipulationAndMouseEvent(null);
        }
        sinkPointerUp(pTarget) {
            const thisObj = pTarget;
            thisObj.IsPointerDown = false;
            thisObj.PointerID = 0;
            thisObj.OnJumpBack();
        }
        sinkPointerDown(pTarget, pEvent, pPointer) {
            const thisObj = pTarget;
            if (!thisObj.IsPointerDown && thisObj.GetProperty("Disabled") !== true) {
                thisObj.LastMousePositionX = pPointer.AdjPosition.x;
                thisObj.LastMousePositionY = pPointer.AdjPosition.y;
                thisObj.IsPointerDown = true;
                thisObj.PointerID = pPointer.Identifier;
            }
        }
        sinkTranslate(pTarget, pEvent, pPointer) {
            const thisObj = pTarget;
            let tTrans = thisObj.TranslateSpeed;
            const tPS = thisObj.GetProperty("TouchPoints");
            if (thisObj.MyFieldInfo && (thisObj.MyFieldInfo.Flags & 2) === 0)
                return;
            if (tPS > 1)
                tTrans *= (5 * tPS);
            if (thisObj.IsPointerDown && pPointer.Identifier === thisObj.PointerID && thisObj.mCanvas) {
                if (thisObj.mIsVertical)
                    thisObj.internalValueChanged(thisObj.mLastScrollValue + ((((thisObj.LastMousePositionY - pPointer.AdjPosition.y) * (thisObj.Is10x ? tTrans * 10 : tTrans))) / thisObj.mCanvas.MyHeight), true);
                else
                    thisObj.internalValueChanged(thisObj.mLastScrollValue - ((((thisObj.LastMousePositionX - pPointer.AdjPosition.x) * (thisObj.Is10x ? tTrans * 10 : tTrans))) / thisObj.mCanvas.MyWidth), true);
                if (!thisObj.mReturnDeltaOnly)
                    thisObj.mLastScrollValue = thisObj.ScrollValueTemp;
                thisObj.LastMousePositionX = pPointer.AdjPosition.x;
                thisObj.LastMousePositionY = pPointer.AdjPosition.y;
            }
        }
        internalValueChanged(value, DoFireEvent) {
            let tRoundTo = this.mRoundTo;
            const tStepFactor = this.mStepFactor;
            let tVal = value * tStepFactor;
            let tSnap = this.mSnapper;
            if (this.mRangeSet) {
                for (let i = 0; i < this.mRangeThreshhold.length; i++) {
                    if (tVal > this.mRangeThreshhold[i]) {
                        this.TranslateSpeed = this.mRangeSpeed[i];
                        tRoundTo = this.mRangeRounder[i];
                        tSnap = this.mRangeSnapper[i];
                    }
                }
            }
            let tt;
            if (tSnap > 0 && this.LastMiniValue > 0) {
                tt = Math.floor(this.LastMiniValue * 1000);
                const tS = Math.floor(tSnap * 1000);
                if ((tt % tS) < 5 && Math.abs(value - this.ScrollValueTemp) < 0.003) {
                    this.RepositionLines();
                    return this.LastMiniValue;
                }
            }
            if (tRoundTo > 0) {
                tt = Math.floor(tVal / tRoundTo);
                tVal = tt * tRoundTo;
            }
            let tMini = tVal;
            if (this.mAllowRollover) {
                const diff = this.mMaxVal - this.mMinVal;
                tMini = tVal - this.mMinVal;
                tMini %= diff;
                if (tMini < 0)
                    tMini = this.mMaxVal + tMini;
                if (tMini > this.mMaxVal)
                    tMini -= this.mMaxVal;
                tMini += this.mMinVal;
            }
            else {
                if (tMini < this.mMinVal) {
                    if (this.mAllowOffBelowMin && (this.mLastScrollValue >= 0)) {
                        if (this.mLastScrollValue === 0 && value > 0)
                            tMini = this.mMinVal;
                        else
                            tMini = 0;
                    }
                    else
                        tMini = this.mMinVal;
                    value = tMini / tStepFactor;
                    this.mLastScrollValue = value;
                }
                if (tMini > this.mMaxVal) {
                    tMini = this.mMaxVal;
                    value = tMini / tStepFactor;
                    this.mLastScrollValue = value;
                }
            }
            this.LastMiniValue = tMini;
            if (isNaN(this.ScrollValueTemp))
                this.ScrollValueTemp = value;
            this.SetProperty("iValue", tMini);
            if (DoFireEvent) {
                this.FireEvent(false, "OniValueChanged", "iValChanged", tMini);
                this.FireEvent(true, "BarChanged", "iValChanged", tMini);
            }
            this.ScrollValueTemp = value;
            return tMini;
        }
        OnJumpBack() {
            this.SetProperty("iValue", this.LastMiniValue);
            this.IsDirty = true;
            this.FireEvent(true, "OnValueChanged", "OnJumpBack", this.LastMiniValue, this.MyTRF);
            if (!this.mReturnDeltaOnly)
                this.mLastScrollValue = this.ScrollValueTemp;
        }
        CreateLines() {
            if (!this.mCanvas)
                return;
            this.mCanvas.ApplySkin();
            if (this.mIsVertical)
                this.mLines = this.mCanvas.MyHeight / this.mLineGap;
            else
                this.mLines = this.mCanvas.MyWidth / this.mLineGap;
            this.mGripLines = [];
            for (let i = 0; i < this.mLines; i++) {
                const r = new cdeNMI.TheDrawingObject();
                r.Type = 1;
                r.StrokeThickness = 0;
                r.Fill = this.mLineColor;
                r.Width = this.mLineWidth;
                r.Height = this.mCanvas.MyHeight;
                r.Left = 0;
                r.Top = 0;
                r.IsTemp = true;
                if (this.mIsVertical) {
                    r.Width = this.mCanvas.MyWidth;
                    r.Height = this.mLineWidth;
                }
                this.mGripLines.push(r);
            }
        }
        RepositionLines() {
            if (!this.mCanvas || !this.mGripLines)
                return;
            for (let i = 0; i < this.mGripLines.length; i++) {
                let x;
                if (this.mIsVertical)
                    x = (this.ScrollValueTemp / (this.Is10x ? this.TranslateSpeed * 10 : this.TranslateSpeed) * this.mCanvas.MyHeight * 0.9) % this.mLineGap + i * this.mLineGap;
                else
                    x = (this.ScrollValueTemp / (this.Is10x ? this.TranslateSpeed * 10 : this.TranslateSpeed) * this.mCanvas.MyWidth * 0.9) % this.mLineGap + i * this.mLineGap;
                let tSize = this.mCanvas.MyWidth;
                if (this.mIsVertical)
                    tSize = this.mCanvas.MyHeight;
                if (x >= 0 && x < tSize) {
                    if (this.mIsVertical) {
                        if (!this.mIsInverted)
                            this.mGripLines[i].Top = this.mCanvas.MyHeight - x;
                        else
                            this.mGripLines[i].Top = x;
                    }
                    else
                        this.mGripLines[i].Left = x;
                    this.mGripLines[i].Visibility = true;
                }
                else
                    this.mGripLines[i].Visibility = false;
            }
            this.tText = new cdeNMI.TheDrawingObject(12, 12);
            this.tText.Type = 3;
            this.tText.Visibility = true;
            this.tText.ComplexData = {};
            this.tText.ComplexData.Text = cde.CDbl(this.LastMiniValue).toFixed(0);
            this.tText.ComplexData.Font = "8pt Roboto";
            if (this.GetProperty("LabelColor"))
                this.tText.Fill = this.GetProperty("LabelColor");
            else
                this.tText.Fill = "black";
            this.tText.IsTemp = true;
            this.mGripLines.push(this.tText);
            this.mCanvas.SetProperty("DataContext", this.mGripLines);
        }
    }
    cdeNMI.ctrlEndlessSlider = ctrlEndlessSlider;
    /**
* Creates a Canvas Based Shape
     *
     * This control is NOT and input control for Form or Table
* (4.1 Ready!)
*/
    class ctrlShape extends cdeNMI.TheNMIBaseControl {
        constructor(pTRF) {
            super(null, pTRF);
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.Shape;
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            this.mBaseCtrl = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileGroup);
            this.mBaseCtrl.InitControl(pTargetControl, this.MyTRF);
            this.mBaseCtrl.SetInitialSize(1);
            this.mBaseCtrl.SetProperty("ClassName", "ctrlShape");
            this.mBaseCtrl.SetProperty("Style", "position:relative;background-color:transparent");
            this.mCanvas = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.CanvasDraw);
            this.mCanvas.SetProperty("NoBackBuffer", true);
            this.mCanvas.InitControl(this.mBaseCtrl);
            if (!this.MyFieldInfo || (this.MyFieldInfo && (this.MyFieldInfo.Flags & 2) !== 0)) {
                this.mCanvas.SetProperty("OnPointerDown", (evt, pT, pP) => { this.SendPointer(evt, pT, pP); });
                if (cde.CBool(this.GetProperty("EnableMouseMove")))
                    this.mCanvas.SetProperty("OnPointerMove", (evt, pT, pP) => { this.SendPointer(evt, pT, pP); });
                this.mCanvas.SetProperty("OnPointerUp", (evt, pT, pP) => { this.SendPointer(evt, pT, pP); });
                this.mCanvas.SetProperty("OnPointerCancel", (evt, pT, pP) => { this.SendPointer(evt, pT, pP); });
                this.mCanvas.SetProperty("OnKeyUp", (evt) => { this.SendKey(evt); });
                this.mCanvas.SetProperty("OnKeyDown", (evt) => { this.SendKey(evt); });
            }
            this.SetElement(this.mBaseCtrl.GetElement());
            if (this.MyFormID && cdeNMI.MyScreenManager) {
                const tScreen = cdeNMI.MyScreenManager.GetScreenByID(this.MyFormID);
                if (tScreen)
                    tScreen.RegisterEvent("OnLoaded", () => this.ApplySkin());
            }
            return true;
        }
        SetProperty(pName, pValue) {
            if (pName === "Background") {
                this.mCanvas.SetProperty(pName, pValue);
            }
            else if (pName === "AddShape" || pName === "DrawShapes" || pName === "DrawShape" || pName === "AllowMoveWithoutDown" || pName === "Playback" || pName === "NoClear") {
                this.mCanvas.SetProperty(pName, pValue);
            }
            else if (pName === "SetShape" || pName === "Value" || pName === "iValue") {
                this.mCanvas.SetProperty("SetShape", pValue);
            }
            else if (pName === "EnableMouseMove") {
                if (cde.CBool(pValue))
                    this.mCanvas.SetProperty("OnPointerMove", (evt, pT, pP) => { this.SendPointer(evt, pT, pP); });
                else
                    this.mCanvas.SetProperty("OnPointerMove", null);
            }
            else if (pName === "YRatio" && this.mBaseCtrl) {
                const tEle = this.mBaseCtrl.GetElement();
                if (tEle.style.width !== "inherit") {
                    const tRat = cde.CDbl(tEle.style.width.substr(0, tEle.style.width.length - 2)) / cde.CDbl(pValue);
                    tEle.style.height = tRat + "px";
                    tEle.style.maxHeight = tRat + "px";
                }
                this.mCanvas.SetProperty(pName, pValue);
            }
            else if ((pName === "ControlTW" || pName === "ControlTH" || pName === "DataContext" || pName === "CanvasWidth" || pName === "CanvasHeight" || pName === "TileFactorX" || pName === "TileFactorY") && this.mCanvas) {
                this.mCanvas.SetProperty(pName, pValue);
            }
            super.SetProperty(pName, pValue);
        }
        ApplySkin() {
            this.mCanvas.ApplySkin();
            if (this.GetProperty("Value"))
                this.SetProperty("iValue", this.GetProperty("Value"));
        }
        SendKey(pEvent) {
            if (cde.CBool(this.GetProperty("SendPointer"))) {
                let tEng = cdeNMI.eTheNMIEngine;
                if (this.GetProperty("EngineName"))
                    tEng = this.GetProperty("EngineName");
                const tKey = new cdeNMI.TheKey(pEvent);
                if (cde.MyBaseAssets.MyEngines[tEng]) {
                    if (this.MyFieldInfo)
                        cde.MyBaseAssets.MyEngines[tEng].PublishToNode(this.MyFieldInfo.cdeN, "UPDATE_KEY:" + this.GetProperty("MyThing"), JSON.stringify(tKey));
                    else
                        cde.MyBaseAssets.MyEngines[tEng].PublishToService("UPDATE_KEY:" + this.GetProperty("MyThing"), JSON.stringify(tKey));
                }
            }
        }
        SendPointer(pTarget, pEvent, pPointer) {
            if (cde.CBool(this.GetProperty("SendPointer"))) {
                this.mCanvas.GetElement().setAttribute('tabindex', '0');
                this.mCanvas.GetElement().focus();
                let tEng = cdeNMI.eTheNMIEngine;
                if (this.GetProperty("EngineName"))
                    tEng = this.GetProperty("EngineName");
                pPointer.AdjPosition.x *= this.mCanvas.WidthRatio;
                pPointer.AdjPosition.y *= this.mCanvas.HeightRatio;
                if (cde.MyBaseAssets.MyEngines[tEng]) {
                    if (this.MyFieldInfo)
                        cde.MyBaseAssets.MyEngines[tEng].PublishToNode(this.MyFieldInfo.cdeN, "UPDATE_POINTER:" + this.GetProperty("MyThing"), JSON.stringify(pPointer));
                    else
                        cde.MyBaseAssets.MyEngines[tEng].PublishToService("UPDATE_POINTER:" + this.GetProperty("MyThing"), JSON.stringify(pPointer));
                }
            }
        }
    }
    cdeNMI.ctrlShape = ctrlShape;
    /*************************************************

* Creates a Circular Gauge with a start and end angle. By default white on 50% opacity as a full circle starting with zero at the StartAngle
*
* (4.3 Ready!)
*/
    class ctrlCircularGauge2 extends cdeNMI.TheNMIBaseControl {
        constructor() {
            super(null, null);
            this.containerTileGroup = null;
            this.canvas = null;
            this.context = null;
            this.tempValue = 0;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            this.containerTileGroup = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileGroup).Create(pTargetControl);
            let tMax = cde.CInt(this.GetProperty("MaxValue"));
            if (tMax === cde.CInt(this.GetProperty("MinValue")))
                tMax = 100;
            this.SetProperty("MaxValue", tMax);
            if (this.GetProperty("MainBackground"))
                this.containerTileGroup.SetProperty("Background", this.GetProperty("MainBackground"));
            this.canvas = document.createElement("canvas");
            this.containerTileGroup.GetElement().appendChild(this.canvas);
            const tW = cde.CInt(this.GetSetting("ControlTW"));
            const tH = cde.CInt(this.GetSetting("ControlTH"));
            this.canvas.width = 0;
            this.canvas.height = 0;
            this.context = this.canvas.getContext("2d");
            if (tW > 0) {
                this.containerTileGroup.SetProperty("TileWidth", tW);
                this.canvas.width = cdeNMI.GetSizeFromTile(this.containerTileGroup.GetProperty("TileWidth"));
            }
            if (tH > 0) {
                this.containerTileGroup.SetProperty("TileHeight", tH);
                this.canvas.height = cdeNMI.GetSizeFromTile(this.containerTileGroup.GetProperty("TileHeight"));
            }
            cde.MyBaseAssets.RegisterEvent("ThemeSwitched", () => {
                this.DoRedraw();
            });
            this.DoRedraw();
            this.AnimateFrame(true);
            super.SetElement(this.containerTileGroup.GetElement());
            return true;
        }
        SetProperty(pName, pValue) {
            super.SetProperty(pName, pValue);
            let bIsDirty = false;
            if (pName === "MainBackground") {
                if (!this.containerTileGroup)
                    return;
                this.containerTileGroup.SetProperty("Background", pValue);
            }
            else if (pName === "Background") {
                bIsDirty = true;
            }
            else if (pName === "ControlTW" && this.context) {
                this.containerTileGroup.SetProperty("TileWidth", pValue);
                this.canvas.width = cdeNMI.GetSizeFromTile(this.containerTileGroup.GetProperty("TileWidth"));
                bIsDirty = true;
            }
            else if (pName === "ControlTH" && this.context) {
                this.containerTileGroup.SetProperty("TileHeight", pValue);
                this.canvas.height = cdeNMI.GetSizeFromTile(this.containerTileGroup.GetProperty("TileHeight"));
                bIsDirty = true;
            }
            else if (pName === "StartAngle" || pName === "EndAngle") {
                bIsDirty = true;
            }
            else if (pName === "PlotBand") {
                this.myPlotBand = JSON.parse(pValue);
                bIsDirty = true;
            }
            if (pName === "iValue" || pName === "Value") {
                this.savedInt = pValue;
                bIsDirty = true;
            }
            if (pName === "MaxValue" || pName === "MinValue" || pName === "Foreground") {
                bIsDirty = true;
            }
            if (bIsDirty && this.context)
                this.AnimateFrame(true);
        }
        DoRedraw() {
            if (!this.context || this.canvas.width === 0 || this.canvas.height === 0)
                return;
            this.context.clearRect(0, 0, this.canvas.width, this.canvas.height); // to clear canvas
            // circle
            let thick = (this.canvas.width / 7);
            let radius = (this.canvas.width / 2) - thick;
            if (this.canvas.height < this.canvas.width) {
                thick = (this.canvas.height / 7);
                radius = (this.canvas.height / 2) - thick;
            }
            this.context.beginPath();
            this.context.textAlign = 'center';
            this.context.strokeStyle = this.GetProperty("Foreground");
            const upperLimit = cde.CInt(this.GetProperty("UpperLimit"));
            const lowerLimit = cde.CInt(this.GetProperty("LowerLimit"));
            const maxValue = cde.CInt(this.GetProperty("MaxValue"));
            const minValue = cde.CInt(this.GetProperty("MinValue"));
            //arc
            const x = this.canvas.width / 2;
            const y = this.canvas.height / 2;
            const counterClockwise = cde.CBool(this.GetProperty("IsInverted"));
            let tSetStartAngle = cde.CInt(this.GetProperty("StartAngle")) - 90;
            if (tSetStartAngle < 0)
                tSetStartAngle += 360;
            let fullEndAngle = 360;
            if (this.GetProperty("EndAngle"))
                fullEndAngle = cde.CInt(this.GetProperty("EndAngle"));
            let tSetEndAngle;
            if (counterClockwise) {
                tSetEndAngle = fullEndAngle - tSetStartAngle;
                if (tSetEndAngle < 0)
                    tSetEndAngle += 360;
            }
            else {
                tSetEndAngle = fullEndAngle + tSetStartAngle;
                if (tSetEndAngle > 360)
                    tSetEndAngle -= 360;
            }
            const newAngVal = cdeNMI.cdeMinMax(this.tempValue, minValue, maxValue, fullEndAngle, 0);
            const startAngle = (Math.PI / 180) * tSetStartAngle;
            //Back Circle
            this.context.beginPath();
            this.context.arc(x, y, radius, startAngle, tSetEndAngle * (Math.PI / 180), counterClockwise);
            this.context.lineWidth = thick;
            if (this.GetProperty("Background"))
                this.context.strokeStyle = ctrlCanvasDraw.ProcessColor(this, this.context, this.GetProperty("Background"));
            else {
                if (cde.MyBaseAssets.MyServiceHostInfo.IsLiteTheme)
                    this.context.strokeStyle = "rgba(80, 80, 80, 0.1)";
                else
                    this.context.strokeStyle = "rgba(80, 80, 80, 0.5)";
            }
            this.context.stroke();
            //Value Circle
            let endAngle = 0;
            if (counterClockwise)
                endAngle = (Math.PI / 180) * (newAngVal + tSetStartAngle); //this is the point where the arc stops
            else
                endAngle = (Math.PI / 180) * ((fullEndAngle - newAngVal) + tSetStartAngle); //this is the point where the arc stops
            let whitePart;
            if (this.GetProperty("Foreground"))
                whitePart = ctrlCanvasDraw.ProcessColor(this, this.context, this.GetProperty("Foreground"));
            else {
                if (cde.MyBaseAssets.MyServiceHostInfo.IsLiteTheme)
                    whitePart = 'rgba(82,208,235,0.9)';
                else
                    whitePart = 'rgba(29,163,209,0.9)';
            }
            this.context.beginPath();
            this.context.arc(x, y, radius, startAngle, endAngle, counterClockwise);
            this.context.lineWidth = thick;
            this.context.strokeStyle = whitePart;
            this.context.stroke();
            const context = this.context;
            const gradient = context.createLinearGradient(x, y, this.canvas.width, this.canvas.height / 2);
            gradient.addColorStop(0.2, 'rgba(255,50,50,0.302)');
            gradient.addColorStop(.6, 'rgba(255,0,0,.549)');
            gradient.addColorStop(.6, 'rgba(255,0,0,1.0)');
            //Limit Shaders
            if (upperLimit > minValue) {
                const valMaxLim = cdeNMI.cdeMinMax(upperLimit, maxValue, minValue, fullEndAngle, 0);
                //if (this.tempValue > upperLimit)
                {
                    context.beginPath();
                    context.lineWidth = thick;
                    context.strokeStyle = gradient;
                    context.arc(x, y, radius, (valMaxLim + tSetStartAngle) * (Math.PI / 180), tSetEndAngle * (Math.PI / 180), counterClockwise);
                    context.stroke();
                }
            }
            if (lowerLimit > minValue) {
                const valLowLim = cdeNMI.cdeMinMax(lowerLimit, maxValue, minValue, fullEndAngle, 0);
                //if (this.tempValue < lowerLimit)
                {
                    context.beginPath();
                    context.lineWidth = thick;
                    context.strokeStyle = gradient;
                    if (!counterClockwise)
                        endAngle = (Math.PI / 180) * (valLowLim + tSetStartAngle); //this is the point where the arc stops
                    else
                        endAngle = (Math.PI / 180) * ((fullEndAngle - valLowLim) + tSetStartAngle); //this is the point where the arc stops
                    context.arc(x, y, radius, startAngle, endAngle, counterClockwise);
                    context.stroke();
                }
            }
            if (this.myPlotBand) {
                for (const idx in this.myPlotBand) {
                    const tFrom = cdeNMI.cdeMinMax(this.myPlotBand[idx].from, maxValue, minValue, fullEndAngle, 0);
                    const tTo = cdeNMI.cdeMinMax(this.myPlotBand[idx].to, maxValue, minValue, fullEndAngle, 0);
                    context.beginPath();
                    context.lineWidth = thick * .4;
                    context.strokeStyle = this.myPlotBand[idx].color;
                    if (!counterClockwise)
                        endAngle = (Math.PI / 180) * (tTo + tSetStartAngle); //this is the point where the arc stops
                    else
                        endAngle = (Math.PI / 180) * ((fullEndAngle - tTo) + tSetStartAngle); //this is the point where the arc stops
                    context.arc(x, y, radius * .88, (Math.PI / 180) * (tFrom + tSetStartAngle), endAngle, counterClockwise);
                    context.stroke();
                }
            }
            //text
            //RobotoLight
            this.context.font = thick + 'pt Roboto';
            if (this.GetProperty("Foreground"))
                this.context.fillStyle = this.GetProperty("Foreground");
            else
                this.context.fillStyle = whitePart;
            let tLabel;
            if (cde.CBool(this.GetProperty("DontAnimate")) === false) {
                if (this.GetProperty("Format"))
                    tLabel = this.tempValue.toFixed(cde.CInt(this.GetProperty("Format")));
                else
                    tLabel = Math.floor(this.tempValue).toString();
            }
            else {
                if (this.GetProperty("Format"))
                    tLabel = cde.CDbl(this.GetProperty("Value")).toFixed(cde.CInt(this.GetProperty("Format")));
                else
                    tLabel = Math.floor(cde.CDbl(this.GetProperty("Value"))).toString();
            }
            //centering canvas text
            this.context.fillText(tLabel, x, y + (thick / 2));
            //SubTitle Text
            if (this.GetProperty("SubTitle")) {
                context.font = '16pt Roboto';
                context.fillStyle = whitePart;
                context.fillText(this.GetProperty("SubTitle"), x, y + (thick * 2));
            }
        }
        AnimateFrame(pForce) {
            this.myframe = requestAnimationFrame(() => { this.AnimateFrame(false); });
            if (cde.CBool(this.GetProperty("DontAnimate")) === true) {
                cancelAnimationFrame(this.myframe);
                this.tempValue = cde.CDbl(this.GetProperty("Value"));
                this.DoRedraw();
                return;
            }
            let tDbl;
            if (cde.CDbl(this.GetProperty("Value")) < this.tempValue) {
                tDbl = (this.tempValue - cde.CDbl(this.GetProperty("Value"))) / 20;
                this.tempValue -= tDbl;
                if (!pForce && (cde.CDbl(this.GetProperty("Value")) > this.tempValue || Math.abs(tDbl) < 0.001)) {
                    cancelAnimationFrame(this.myframe);
                    this.tempValue = cde.CDbl(this.GetProperty("Value"));
                }
            }
            else {
                tDbl = (cde.CDbl(this.GetProperty("Value")) - this.tempValue) / 20;
                this.tempValue += tDbl;
                if (!pForce && (cde.CDbl(this.GetProperty("Value")) < this.tempValue || Math.abs(tDbl) < 0.001)) {
                    cancelAnimationFrame(this.myframe);
                    this.tempValue = cde.CDbl(this.GetProperty("Value"));
                }
            }
            this.DoRedraw();
        }
    }
    cdeNMI.ctrlCircularGauge2 = ctrlCircularGauge2;
    /**
* Creates a
*
* (4.3 Ready)
*/
    class ctrlSmartGauge2 extends cdeNMI.TheNMIBaseControl {
        constructor() {
            super(null, null);
            this.GaugeShell = null;
            this.tempValue = 0;
            this.whiteRGBA = 'rgba(255,255,255,0.5)';
            this.blackRGBA = 'rgba(0,0,0,0.5)';
            this.darkslategrayRGBA = 'rgba(47,79,79,.5)';
            this.mBackground = 'rgba(80,80,80,0.5)';
            this.mycanvas = null;
            this.mycontext = null;
            this.startAngle = 0;
            this.endAngle = 0;
            this.counterClockwise = false;
            this.mWidth = 0;
            this.mHeight = 0;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            this.GaugeShell = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileGroup).Create(pTargetControl);
            this.GaugeShell.GetElement().style.width = "inherit";
            this.GaugeShell.GetElement().style.height = "inherit";
            this.mycanvas = document.createElement("Canvas");
            this.GaugeShell.GetElement().appendChild(this.mycanvas);
            this.mycontext = this.mycanvas.getContext('2d');
            if (cde.CInt(this.GetProperty("MaxValue")) === 0)
                this.SetProperty("MaxValue", 100);
            this.startAngle = (1 * Math.PI);
            this.endAngle = 0 * Math.PI;
            this.counterClockwise = false;
            this.SetElement(this.GaugeShell.GetElement());
            this.AnimateFrame(true);
            if (cdeNMI.MyScreenManager) {
                const tScreen = cdeNMI.MyScreenManager.GetScreenByID(this.MyFieldInfo.FormID);
                if (tScreen)
                    tScreen.RegisterEvent("OnLoaded", () => this.ApplySkin());
            }
            cde.MyBaseAssets.RegisterEvent("ThemeSwitched", () => {
                this.DoRender();
            });
            return true;
        }
        SetProperty(pName, pValue) {
            super.SetProperty(pName, pValue);
            let bIsDirty = false;
            if (pName === "Value" || pName === "iValue" || pName === "Foreground" || pName === "Title" || pName === "SubTitle") {
                bIsDirty = true;
            }
            else if (pName === "MainBackground" && this.GaugeShell) {
                this.GaugeShell.SetProperty("Background", pValue);
            }
            else if (pName === "Background" && this.GaugeShell) {
                this.mBackground = pValue;
                this.IsDirty = true;
            }
            else if (pName === "Title") {
                bIsDirty = true;
            }
            else if (pName === "SubTitle" || pName === "LowerLimit" || pName === "UpperLimit") {
                bIsDirty = true;
            }
            if (bIsDirty)
                this.AnimateFrame(true);
        }
        ApplySkin() {
            if (!this.GaugeShell.GetElement())
                return;
            this.mWidth = this.GaugeShell.GetElement().clientWidth;
            this.mycanvas.width = this.mWidth;
            this.mHeight = this.GaugeShell.GetElement().clientHeight;
            this.mycanvas.height = this.mHeight;
            if (this.mHeight > 0 && this.mWidth > 0)
                this.AnimateFrame(true);
        }
        DoRender() {
            if (!this.mycanvas || this.mWidth === 0 || this.mHeight === 0)
                return;
            const context = this.mycontext;
            const canvas = this.mycanvas;
            const x = this.mycanvas.width / 2;
            const y = this.mycanvas.height - 16;
            const radius = x - (y * .20);
            context.clearRect(0, 0, canvas.width, canvas.height);
            if (!this.GetProperty("Background")) {
                if (cde.MyBaseAssets.MyServiceHostInfo.IsLiteTheme)
                    this.mBackground = "rgba(80, 80, 80, 0.1)";
                else
                    this.mBackground = "rgba(80, 80, 80, 0.5)";
            }
            context.beginPath();
            context.arc(x, y, radius, this.startAngle, this.endAngle, this.counterClockwise);
            context.lineWidth = y * 0.01;
            context.strokeStyle = this.mBackground;
            context.fillStyle = this.mBackground;
            context.stroke();
            let myBlue = this.GetProperty("Foreground");
            if (!myBlue) {
                if (cde.MyBaseAssets.MyServiceHostInfo.IsLiteTheme)
                    myBlue = 'rgba(82,208,235,0.9)';
                else
                    myBlue = 'rgba(29,163,209,0.9)';
            }
            const upperLimit = cde.CInt(this.GetProperty("UpperLimit"));
            const lowerLimit = cde.CInt(this.GetProperty("LowerLimit"));
            let myValue = cde.CDbl(this.tempValue);
            if (!cde.CBool(this.GetProperty("UseFloat")))
                myValue = Math.floor(myValue);
            const maxValue = cde.CInt(this.GetProperty("MaxValue"));
            const minValue = cde.CInt(this.GetProperty("MinValue"));
            if (myValue > maxValue)
                myValue = maxValue;
            context.clearRect(0, canvas.height - 12, canvas.width, 12);
            let valAngle = cdeNMI.cdeMinMax(myValue, maxValue, minValue, 180, 0);
            if (valAngle < 0)
                valAngle = 0;
            //value visual
            context.beginPath();
            context.arc(x, y, radius, this.startAngle, this.startAngle + (valAngle * (Math.PI / 180)), this.counterClockwise);
            context.lineWidth = y * .15;
            context.strokeStyle = myBlue;
            context.stroke();
            //value text
            //small RED  value visual to the right
            const gradient = context.createLinearGradient(x, y, canvas.width, canvas.height / 2);
            gradient.addColorStop(0.2, 'rgba(255,50,50,0.302)');
            gradient.addColorStop(.6, 'rgba(255,0,0,.549)');
            gradient.addColorStop(.6, 'rgba(255,0,0,1.0)');
            let whitePart;
            if (this.GetProperty("LabelForeground"))
                whitePart = ctrlCanvasDraw.ProcessColor(this, context, this.GetProperty("LabelForeground"));
            else {
                if (!cde.MyBaseAssets.MyServiceHostInfo.IsLiteTheme)
                    whitePart = 'rgba(82,208,235,0.9)';
                else
                    whitePart = 'rgba(29,163,209,0.9)';
            }
            //Title Text
            if (this.GetProperty("Title") && cde.CBool(this.GetProperty("NoTE"))) {
                context.font = '16pt Roboto';
                context.fillStyle = whitePart;
                context.fillText(this.GetProperty("Title"), x - context.measureText(this.GetProperty("Title")).width / 2, 18);
            }
            //SubTitle Text
            if (this.GetProperty("SubTitle")) {
                context.font = '16pt Roboto';
                context.fillStyle = whitePart;
                context.fillText(this.GetProperty("SubTitle"), x - context.measureText(this.GetProperty("SubTitle")).width / 2, y + 10);
            }
            if (upperLimit > minValue) {
                const valMaxLim = cdeNMI.cdeMinMax(upperLimit, maxValue, minValue, 180, 0);
                if (myValue > upperLimit) {
                    context.beginPath();
                    context.lineWidth = 10;
                    context.strokeStyle = gradient;
                    context.arc(x, y, radius * .90, this.startAngle + (valMaxLim * (Math.PI / 180)), this.startAngle + (valAngle * (Math.PI / 180)), this.counterClockwise);
                    context.stroke();
                }
                //upper limit TEXT
                context.font = '10pt Roboto';
                context.fillStyle = 'rgb(255,192,0)';
                context.fillText(upperLimit.toString(), x * 1.20, y * 0.95);
                //upper limit 
                context.beginPath();
                context.arc(x, y, radius - 3, this.startAngle + ((valMaxLim - 1) * (Math.PI / 180)), this.startAngle + ((valMaxLim + 1) * (Math.PI / 180)), this.counterClockwise);
                context.lineWidth = y * .2;
                context.strokeStyle = 'rgba(255,192,0,.8)';
                context.stroke();
            }
            if (lowerLimit > minValue) {
                const valLowLim = cdeNMI.cdeMinMax(lowerLimit, maxValue, minValue, 180, 0);
                if (myValue < lowerLimit) {
                    context.beginPath();
                    context.lineWidth = 10;
                    context.strokeStyle = gradient;
                    context.arc(x, y, radius * .90, this.startAngle + (valAngle * (Math.PI / 180)), this.startAngle + (valLowLim * (Math.PI / 180)), this.counterClockwise);
                    context.stroke();
                }
                //lower limit text
                context.font = '10pt Roboto';
                context.fillStyle = 'rgb(255,192,0)';
                context.fillText(lowerLimit.toString(), x * .70, y * .95);
                //lower limit
                context.beginPath();
                context.arc(x, y, radius - 3, this.startAngle + ((valLowLim - 1) * (Math.PI / 180)), this.startAngle + ((valLowLim + 1) * (Math.PI / 180)), this.counterClockwise);
                context.lineWidth = y * .2;
                context.strokeStyle = 'rgba(255,192,0,.8)';
                context.stroke();
            }
            /////////////////////white line/////////this must change with background color
            context.strokeStyle = this.mBackground;
            context.lineWidth = 1;
            context.beginPath();
            context.arc(x, y, radius, this.startAngle, this.startAngle + (valAngle * (Math.PI / 180)), this.counterClockwise);
            context.stroke();
            let fontHeight = cde.CDbl(this.GetProperty("LabelFontSize"));
            if (fontHeight === 0)
                fontHeight = this.mycanvas.height * 0.25;
            context.font = fontHeight + 'pt Roboto';
            let myLabCol = this.GetProperty("LabelColor");
            if (!myLabCol)
                myLabCol = whitePart;
            if (myValue < lowerLimit && lowerLimit > minValue) {
                context.fillStyle = 'red';
            }
            else if (myValue > upperLimit && upperLimit > minValue) {
                context.fillStyle = 'red';
            }
            else
                context.fillStyle = myLabCol;
            let dValue = this.GetProperty("Value");
            if (cde.CInt(this.GetProperty("Digits")) > 0)
                dValue = cde.CDbl(this.GetProperty("Value")).toFixed(cde.CInt(this.GetProperty("Digits")));
            //centering canvas text
            if (cde.CBool(this.GetProperty("AnimateValue")))
                context.fillText(myValue.toString(), x - context.measureText(myValue.toString()).width / 2, y * 0.85);
            else
                context.fillText(dValue.toString(), x - context.measureText(dValue.toString()).width / 2, y * 0.85);
            //min-value(0) text
            context.fillStyle = myLabCol;
            context.font = '10pt Roboto';
            context.fillText(minValue.toString(), x - radius, y + 11);
            //max-value(0) text
            context.font = '10pt Roboto';
            context.fillText(maxValue.toString(), (x + radius) - (radius * .15), y + 11);
        }
        AnimateFrame(bForceDraw) {
            this.myframe = requestAnimationFrame(() => { this.AnimateFrame(false); });
            let tDbl;
            if (cde.CDbl(this.GetProperty("Value")) < this.tempValue) {
                tDbl = (this.tempValue - cde.CDbl(this.GetProperty("Value"))) / 20;
                this.tempValue -= tDbl;
                if (!bForceDraw && (cde.CDbl(this.GetProperty("Value")) > this.tempValue || Math.abs(tDbl) < 0.001)) {
                    cancelAnimationFrame(this.myframe);
                    this.tempValue = cde.CDbl(this.GetProperty("Value"));
                    //return;
                }
            }
            else {
                tDbl = (cde.CDbl(this.GetProperty("Value")) - this.tempValue) / 20;
                this.tempValue += tDbl;
                if (!bForceDraw && (cde.CDbl(this.GetProperty("Value")) < this.tempValue || Math.abs(tDbl) < 0.001)) {
                    cancelAnimationFrame(this.myframe);
                    this.tempValue = cde.CDbl(this.GetProperty("Value"));
                    //return;
                }
            }
            this.DoRender();
        }
    }
    cdeNMI.ctrlSmartGauge2 = ctrlSmartGauge2;
})(cdeNMI || (cdeNMI = {}));
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
var cdeNMI;
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
(function (cdeNMI) {
    /**
* Creates an edit field for many different cdeControlTypes:
* 1: SingleLine
* 5: TextArea
* 10: Password (shows as ****)
* 12: Number
* 16: eMail
* 17: ComboOption
* 31: URL
* 32: currency
* (4.1 Ready!)
*/
    class ctrlEditBox extends cdeNMI.TheNMIBaseControl {
        constructor(pTRF) {
            super(null, pTRF);
            this.MyEditBox = null;
            this.MyConfirmBox = null;
            this.MyCombo = null;
            this.EnterButton = null;
            this.DropButton = null;
            this.MyMotLockButton = null;
            this.MyMotLockButton2 = null;
            this.MyTextArea = null;
            this.mFrameDiv = null;
            this.mMotLoc = null;
            this.mMotLoc2 = null;
            this.mUpdButton = null;
            this.mBackDiv = null;
            this.JustIn = false;
            this.JustInC = false;
            this.RequiresUpdateButton = false;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.SingleEnded;
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            this.RequiresUpdateButton = cde.CBool(this.GetProperty("RequireUpdateButton"));
            this.mFrameDiv = document.createElement("div");
            //this.mFrameDiv.style.margin = "auto";
            this.mFrameDiv.style.width = "inherit";
            this.mFrameDiv.style.height = "inherit";
            this.mFrameDiv.className = "ctrlInput";
            this.SetElement(this.mFrameDiv);
            if (this.MyFieldInfo && this.MyFieldInfo.Type === cdeNMI.cdeControlType.TextArea) //Text Area
             {
                this.MyTextArea = document.createElement("textarea");
                this.MyTextArea.className = "ctrlTextArea";
                this.MyTextArea.style.cssFloat = "left";
                this.mFrameDiv.appendChild(this.MyTextArea);
                this.MyTextArea.onblur = () => this.EditElement("13", this.MyTextArea);
            }
            else {
                if (this.MyFieldInfo && (this.MyFieldInfo.Type === cdeNMI.cdeControlType.ComboOption) && cde.CInt(this.GetProperty("MultiLines")) > 1) {
                    this.MyTextArea = document.createElement("textarea");
                    this.MyTextArea.className = "ctrlTextArea";
                    this.MyTextArea.style.cssFloat = "left";
                    this.mFrameDiv.appendChild(this.MyTextArea);
                    let tR = cde.CInt(this.GetProperty("MultiLines"));
                    if (tR < 2)
                        tR = 2;
                    if (cde.CInt(this.GetSetting("TileFactorY")) > 1 && !this.MyTextArea.classList.contains("cdeSmall"))
                        this.MyTextArea.classList.add("cdeSmall");
                    this.MyTextArea.rows = tR;
                }
                else {
                    this.MyEditBox = document.createElement("input");
                    this.MyEditBox.style.cssFloat = "left";
                    if (!cde.CBool(this.GetProperty("EnableAutoFill")) && !cde.CBool(this.GetProperty("InTemplate"))) {
                        this.MyEditBox.name = "EB" + cde.GuidToString(this.MyFieldInfo.cdeMID) + "_" + Math.floor((Math.random() * 1000) + 1); //NOSONAR not crypto related
                        this.MyEditBox.autocomplete = "new-password";
                    }
                    this.mFrameDiv.appendChild(this.MyEditBox);
                    if (this.MyFieldInfo && this.MyFieldInfo.Type === 12)
                        this.MyEditBox.className = "cdeInputNumber";
                    else
                        this.MyEditBox.className = "cdeInput";
                    if (cde.CInt(this.GetSetting("TileFactorY")) > 1 && !this.MyEditBox.classList.contains("cdeSmall"))
                        this.MyEditBox.classList.add("cdeSmall");
                }
                let tAddEnter = false;
                if (this.MyFieldInfo) {
                    switch (this.MyFieldInfo.Type) {
                        case cdeNMI.cdeControlType.Password:
                            tAddEnter = false;
                            this.MyBaseType = cdeNMI.cdeControlType.Password;
                            this.MyEditBox.type = "password";
                            this.MyEditBox.addEventListener("focusin", () => {
                                this.JustIn = true;
                            });
                            if (!cde.CBool(this.GetProperty("HideMTL"))) {
                                this.mMotLoc = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.MuTLock).Create(this, { ScreenID: pScreenID, TRF: this.MyTRF });
                                this.mMotLoc.SetProperty("PassField", this);
                                this.mMotLoc.SetProperty("Visibility", cde.CBool(this.GetProperty("AutoShowMTL")));
                                this.mMotLoc.SetProperty("Style", "position:fixed;margin-top:" + cdeNMI.GetSizeFromTile(1) + "px");
                                this.MyMotLockButton = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(this, { PreInitBag: ["ControlTW=1", "ControlTH=1"], PostInitBag: ["Title=<span class='fa fa-2x'>&#xf00A;</span>", "ClassName=cdeMTL"] });
                                this.MyMotLockButton.SetProperty("Cookie", this);
                                this.MyMotLockButton.SetProperty("OnClick", (pSender, evt) => {
                                    const tEd = pSender.GetProperty("Cookie");
                                    cdeNMI.StopPointerEvents(evt);
                                    if (tEd.mMotLoc.Visibility) {
                                        tEd.mMotLoc.SetProperty("Visibility", false);
                                        if (tEd.MyEditBox.value.length > 0 && cdeNMI.Key13Event)
                                            cdeNMI.Key13Event(evt);
                                    }
                                    else {
                                        tEd.mMotLoc.SetProperty("Visibility", true);
                                        tEd.ShowHideMTL(true);
                                    }
                                });
                                this.SetProperty("ShowOverflow", true);
                                this.ShowHideMTL(cde.CBool(this.GetProperty("AutoShowMTL")));
                            }
                            if (cde.CBool(this.GetProperty("EnforceAndConfirm"))) {
                                this.MyConfirmBox = document.createElement("input");
                                this.MyConfirmBox.style.cssFloat = "left";
                                this.MyConfirmBox.className = "cdeInput";
                                this.MyConfirmBox.type = "password";
                                if (!cde.CBool(this.GetProperty("EnableAutoFill")) && !cde.CBool(this.GetProperty("InTemplate"))) {
                                    this.MyConfirmBox.name = "EB" + cde.GuidToString(this.MyFieldInfo.cdeMID) + "_" + Math.floor((Math.random() * 1000) + 1); //NOSONAR not crypto related
                                    this.MyConfirmBox.autocomplete = "new-password";
                                }
                                this.MyConfirmBox.addEventListener("focusin", () => {
                                    this.JustInC = true;
                                });
                                this.mFrameDiv.appendChild(this.MyConfirmBox);
                                if (!cde.CBool(this.GetProperty("HideMTL"))) {
                                    this.mMotLoc2 = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.MuTLock).Create(this, { ScreenID: pScreenID, TRF: this.MyTRF });
                                    this.mMotLoc2.SetProperty("PassField", this);
                                    this.mMotLoc2.SetProperty("Visibility", false);
                                    this.mMotLoc2.SetProperty("Style", "position:fixed;margin-top:" + cdeNMI.GetSizeFromTile(2) + "px");
                                    this.MyMotLockButton2 = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(this, { PreInitBag: ["ControlTW=1", "ControlTH=1"], PostInitBag: ["Title=<span class='fa fa-2x'>&#xf00A;</span>", "ClassName=cdeMTL"] });
                                    this.MyMotLockButton2.SetProperty("Cookie", this);
                                    this.MyMotLockButton2.SetProperty("OnClick", (pSender, evt) => {
                                        const tEd = pSender.GetProperty("Cookie");
                                        cdeNMI.StopPointerEvents(evt);
                                        if (tEd.mMotLoc2.Visibility) {
                                            tEd.mMotLoc2.SetProperty("Visibility", false);
                                            if (tEd.MyConfirmBox.value.length > 0 && cdeNMI.Key13Event)
                                                cdeNMI.Key13Event(evt);
                                        }
                                        else {
                                            tEd.mMotLoc2.SetProperty("Visibility", true);
                                            tEd.ShowHideMTL(true, true);
                                        }
                                    });
                                    this.SetProperty("ShowOverflow", true);
                                }
                                if (this.RequiresUpdateButton === true) {
                                    this.mUpdButton = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(this, { PreInitBag: ["ControlTW=3", "ControlTH=1"], PostInitBag: ["Title=Set Password", "ClassName=cdePWDUpdateButton"] });
                                    this.mUpdButton.SetProperty("Cookie", this);
                                    this.mUpdButton.SetProperty("OnClick", (pSender, evt) => {
                                        const tEd = pSender.GetProperty("Cookie");
                                        cdeNMI.StopPointerEvents(evt);
                                        tEd.CheckAndWriteValue(tEd.MyEditBox, false);
                                    });
                                }
                            }
                            break;
                        case cdeNMI.cdeControlType.Number:
                            this.MyEditBox.type = "number";
                            this.MyBaseType = cdeNMI.cdeControlType.Number;
                            break;
                        case cdeNMI.cdeControlType.URL:
                            this.MyEditBox.type = "url";
                            this.MyBaseType = cdeNMI.cdeControlType.URL;
                            break;
                        case cdeNMI.cdeControlType.eMail:
                            this.MyEditBox.type = "email";
                            this.MyBaseType = cdeNMI.cdeControlType.eMail;
                            break;
                        case cdeNMI.cdeControlType.ComboOption: //With Combo
                            {
                                this.MyBaseType = cdeNMI.cdeControlType.ComboOption;
                                const tOptions = this.MyFieldInfo["Options"];
                                if (this.MyTRF.ModelID || (tOptions && tOptions.indexOf("PROPERTYPICKER") < 0)) {
                                    const tGR = cdeNMI.MyTCF.CreateBaseControl().Create(this, { TRF: pTRF });
                                    const tDiv = document.createElement("div");
                                    tDiv.style.width = "inherit";
                                    tDiv.style.height = "0";
                                    tDiv.id = cde.GuidToString(this.MyTRF.FldInfo.cdeMID) + "_CBODIV";
                                    tGR.SetElement(tDiv);
                                    this.DropButton = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(this, { PreInitBag: ["ControlTW=1", "ControlTH=1"], PostInitBag: ["Title=<span class='fa fa-3x'>&#xf03a;</span>"] });
                                    if (cde.CInt(this.GetProperty("TileFactorY")) > 1)
                                        this.DropButton.SetProperty("TileFactorY", cde.CInt(this.GetProperty("TileFactorY")));
                                    this.DropButton.SetProperty("OnClick", (pSender, evt) => {
                                        cdeNMI.StopPointerEvents(evt);
                                        try {
                                            this.MyFieldInfo["OptionsLive"] = cdeNMI.GenerateFinalString(this.MyFieldInfo["Options"], cdeNMI.MyNMIModels[this.MyTRF.ModelID].MyStorageMirror[this.MyTRF.TableName][this.MyTRF.RowNo]);
                                        }
                                        catch (e) {
                                            //ignored
                                        }
                                        this.MyCombo.ShowComboPicker();
                                    });
                                    this.MyTRF.FldInfo["HideInput"] = true;
                                    this.MyCombo = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.ComboBox).Create(tGR, { ScreenID: pScreenID, TRF: this.MyTRF, PostInitBag: ["ClassName=cdeInvisible", "iValue=" + this.GetProperty("Value")] });
                                    this.MyCombo.RegisterEvent("OnValueChanged", (pCtrl, evt, pVal) => {
                                        if (pVal !== "" && pVal !== "CDE_NOP")
                                            this.SetProperty("Value", pVal);
                                    });
                                    this.SetProperty("OnValueChanged", (sender, evt, pval) => {
                                        if (pval)
                                            this.MyCombo.SetProperty("iValue", pval);
                                    });
                                    if (!cde.CBool(this.MyFieldInfo["IsOverlay"]) && !cde.CBool(this.MyFieldInfo["IsInTable"])) {
                                        if (this.MyTextArea)
                                            this.MyTextArea.onblur = () => this.EditElement("13", this.MyTextArea);
                                        else
                                            this.MyEditBox.onblur = () => this.EditElement("13", this.MyEditBox);
                                    }
                                }
                            }
                            break;
                        default:
                            if ((this.MyFieldInfo.Flags & 1) !== 0) {
                                this.MyEditBox.type = "password";
                                this.MyEditBox.addEventListener("focusin", () => {
                                    this.MyEditBox.value = "";
                                });
                            }
                            else
                                this.MyEditBox.type = "text";
                            break;
                    }
                }
                if (tAddEnter) {
                    this.EnterButton = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(this, { PreInitBag: ["ControlTW=1", "ControlTH=1"], PostInitBag: ["Title=<span class='fa fa-3x'>&#xf058;</span>"] });
                    this.EnterButton.SetProperty("OnClick", (pSender, evt) => {
                        cdeNMI.StopPointerEvents(evt);
                        this.CheckAndWriteValue(this.MyEditBox, false);
                    });
                    this.EnterButton.SetProperty("Visibility", false);
                }
                if (!this.MyFieldInfo || (this.MyFieldInfo.Flags & 2) !== 0) {
                    if (this.MyTextArea) {
                        this.MyTextArea.onkeypress = (evt) => this.EditElement(evt, this.MyEditBox);
                        this.MyTextArea.onfocus = () => {
                            cdeNMI.DisableKey36Event = true;
                        };
                    }
                    else {
                        this.MyEditBox.onkeypress = (evt) => this.EditElement(evt, this.MyEditBox);
                        this.MyEditBox.onfocus = () => {
                            cdeNMI.DisableKey36Event = true;
                        };
                    }
                    if (this.MyConfirmBox) {
                        this.MyConfirmBox.onkeypress = (evt) => this.EditElement(evt, this.MyConfirmBox);
                        this.MyConfirmBox.onfocus = () => {
                            cdeNMI.DisableKey36Event = true;
                        };
                    }
                }
            }
            this.SetProperty("iValue", super.GetProperty("Value"));
            if (this.MyFieldInfo && (this.MyFieldInfo.Flags & 2) === 0)
                this.SetProperty("Disabled", true);
            this.SetProperty("IsOverlay", cde.CBool(this.MyFieldInfo["IsOverlay"]) || cde.CBool(this.MyFieldInfo["IsInTable"]) || cde.CBool(this.GetProperty("AutoShowMTL")));
            if (this.MyFormID && cdeNMI.MyScreenManager) {
                const tScreen = cdeNMI.MyScreenManager.GetScreenByID(this.MyFormID);
                if (tScreen)
                    tScreen.RegisterEvent("OnLoaded", () => this.ApplySkin());
            }
            return true;
        }
        OnUnload() {
            //New in 4.202.3: Disable any controls under a closed Collapsible Group
            this.SetProperty("Disabled", true);
            super.OnUnload();
        }
        OnLoad() {
            let tW = this.mFrameDiv.clientWidth;
            let setSize = false;
            if (tW > 0) {
                if (this.GetProperty("TileFactorX")) {
                    tW -= (20 / cde.CInt(this.GetProperty("TileFactorX")));
                }
                else
                    tW -= 20;
                setSize = (this.MyBaseType !== cdeNMI.cdeControlType.ComboOption);
                if (setSize === true && ((!cde.CBool(this.GetProperty("HideMTL")) && this.MyBaseType === cdeNMI.cdeControlType.Password)))
                    setSize = false;
            }
            const tEnable = !(!this.MyTRF || !this.MyTRF.FldInfo || (this.MyTRF.FldInfo.Flags & 2) !== 0);
            this.SetProperty("Disabled", tEnable);
            if (this.MyEditBox) {
                if (setSize)
                    this.MyEditBox.style.width = tW + "px";
            }
            if (this.MyConfirmBox) {
                if (setSize)
                    this.MyConfirmBox.style.width = tW + "px";
            }
            if (this.MyTextArea) {
                if (setSize)
                    this.MyTextArea.style.width = tW + "px";
            }
            super.OnLoad();
        }
        SetProperty(pName, pValue) {
            if ((pName === "Value" || pName === "iValue") && (this.MyEditBox || this.MyTextArea)) {
                if (this.MyFieldInfo && (!pValue || pValue === "" || pValue === "-")) {
                    if (this.MyFieldInfo.Type === 31 && this.MyFieldInfo["DefaultValue"] === "") {
                        pValue = "http://";
                    }
                    else {
                        if (this.MyFieldInfo["DefaultValue"])
                            pValue = this.MyFieldInfo["DefaultValue"];
                        else {
                            if (this.MyFieldInfo.Type === cdeNMI.cdeControlType.Number)
                                pValue = 0;
                            else
                                pValue = "";
                        }
                    }
                    if (this.MyEditBox && cdeNMI.HasPlaceholderSupport) {
                        let tHelpText = this.MyFieldInfo["HelpText"];
                        if (!tHelpText)
                            tHelpText = this.MyFieldInfo["EditPlaceholder"];
                        if (tHelpText)
                            this.MyEditBox.placeholder = tHelpText;
                    }
                }
                //if (this.MyFieldInfo && this.MyFieldInfo.Type === cdeControlType.ComboOption)
                //    pValue = pValue;
                if (this.MyCombo)
                    this.MyCombo.SetProperty("iValue", pValue);
                if (this.MyTextArea)
                    this.MyTextArea.value = pValue;
                else {
                    this.MyEditBox.value = pValue;
                    if (this.MyConfirmBox)
                        this.MyConfirmBox.value = pValue;
                }
            }
            else if (pName === "EditPlaceholder" && this.MyEditBox) {
                this.MyEditBox.placeholder = pValue;
            }
            else if (pName === "Disabled" && this.MyEditBox) {
                if ((!this.MyFieldInfo || (this.MyFieldInfo.Flags & 2) === 0))
                    pValue = true;
                this.MyEditBox.disabled = cde.CBool(pValue);
                if (this.MyConfirmBox)
                    this.MyConfirmBox.disabled = cde.CBool(pValue);
            }
            else if (pName === "Disabled" && this.MyTextArea) {
                if ((!this.MyFieldInfo || (this.MyFieldInfo.Flags & 2) === 0))
                    pValue = true;
                this.MyTextArea.disabled = cde.CBool(pValue);
            }
            else if (pName === "Rows" && this.MyTextArea) {
                pValue = cde.CInt(pValue);
                this.MyTextArea.rows = pValue;
            }
            else if (pName === "Background") {
                if (this.MyTextArea)
                    this.MyTextArea.style.background = pValue;
                if (this.MyEditBox)
                    this.MyEditBox.style.background = pValue;
                if (this.MyConfirmBox)
                    this.MyConfirmBox.style.background = pValue;
            }
            else if (pName === "Foreground") {
                if (this.MyTextArea)
                    this.MyTextArea.style.color = pValue;
                if (this.MyEditBox)
                    this.MyEditBox.style.color = pValue;
                if (this.MyConfirmBox)
                    this.MyConfirmBox.style.color = pValue;
            }
            else if (pName === "ControlTW") {
                if (this.MyFieldInfo && ((this.MyFieldInfo.Type === cdeNMI.cdeControlType.Password && !cde.CBool(this.GetProperty("HideMTL"))) || this.MyFieldInfo.Type === cdeNMI.cdeControlType.ComboOption)) {
                    if (this.MyTextArea)
                        this.MyTextArea.style.width = (cdeNMI.GetSizeFromTile(pValue - 1) - 6) + "px";
                    if (this.MyEditBox)
                        this.MyEditBox.style.width = (cdeNMI.GetSizeFromTile(pValue - 1) - 6) + "px";
                    if (this.MyConfirmBox)
                        this.MyConfirmBox.style.width = (cdeNMI.GetSizeFromTile(pValue - 1) - 6) + "px";
                }
            }
            else if (pName === "TileFactorY" && this.MyEditBox) {
                this.MyEditBox.style.height = (50 / cde.CInt(pValue)) + "px";
                if (cde.CInt(pValue) > 1) {
                    if (this.MyEditBox && !this.MyEditBox.classList.contains("cdeSmall"))
                        this.MyEditBox.classList.add("cdeSmall");
                    if (this.MyTextArea && !this.MyTextArea.classList.contains("cdeSmall"))
                        this.MyTextArea.classList.add("cdeSmall");
                }
            }
            else if (pName === "Z-Index" && this.MyCombo) {
                pValue = cde.CInt(pValue);
                this.MyCombo.SetProperty("Z-Index", pValue);
                this.DropButton.SetProperty("Z-Index", pValue);
            }
            else if (pName === "IsOverlay") {
                if (this.MyTextArea)
                    cdeNMI.SetZIndex(this.MyTextArea, cde.CBool(pValue) ? 1300 : 0);
                if (this.MyEditBox)
                    cdeNMI.SetZIndex(this.MyEditBox, cde.CBool(pValue) ? 1300 : 0);
                if (this.MyConfirmBox)
                    cdeNMI.SetZIndex(this.MyConfirmBox, cde.CBool(pValue) ? 1300 : 0);
                if (this.mMotLoc) {
                    this.ShowHideMTL(pValue);
                }
                if (this.mMotLoc2) {
                    this.ShowHideMTL(pValue, true);
                }
                if (this.DropButton)
                    cdeNMI.SetZIndex(this.DropButton.GetElement(), cde.CBool(pValue) ? 1300 : 0);
                if (this.MyCombo)
                    cdeNMI.SetZIndex(this.MyCombo.GetElement(), cde.CBool(pValue) ? 1300 : 0);
                if (cde.CBool(pValue)) {
                    if (this.EnterButton)
                        this.EnterButton.SetProperty("Visibility", true);
                    if (this.MyEditBox) {
                        cdeNMI.Key27Event = (evt) => this.EditRestore(evt, this.MyEditBox);
                        cdeNMI.Key13Event = (evt) => this.EditElement(evt, this.MyEditBox);
                        if (cdeNMI.MyTouchOverlay)
                            this.MyEditBox.focus();
                    }
                    if (this.MyTextArea) {
                        cdeNMI.Key27Event = (evt) => this.EditRestore(evt, this.MyTextArea);
                        cdeNMI.Key13Event = (evt) => this.EditElement(evt, this.MyTextArea);
                        if (cdeNMI.MyTouchOverlay)
                            this.MyTextArea.focus();
                    }
                    if (this.MyConfirmBox) {
                        cdeNMI.Key27Event = (evt) => this.EditRestore(evt, this.MyConfirmBox);
                        cdeNMI.Key13Event = (evt) => this.EditElement(evt, this.MyConfirmBox);
                    }
                }
                else {
                    if (!this.MyFieldInfo || (!cde.CBool(this.MyFieldInfo["InTemplate"]) && this.MyFieldInfo.Type !== cdeNMI.cdeControlType.ComboOption)) {
                        if (this.MyEditBox)
                            this.MyEditBox.onchange = () => this.EditElement("13", this.MyEditBox);
                        if (this.MyConfirmBox)
                            this.MyConfirmBox.onchange = () => this.EditElement("13", this.MyConfirmBox);
                        if (this.MyTextArea)
                            this.MyTextArea.onchange = () => this.EditElement("13", this.MyTextArea);
                    }
                }
                if (this.EnterButton)
                    cdeNMI.SetZIndex(this.EnterButton.GetElement(), cde.CBool(pValue) ? 1300 : 0);
            }
            else if (pName === "InnerClassName") {
                if (this.MyEditBox)
                    this.MyEditBox.className = pValue;
                if (this.MyConfirmBox)
                    this.MyConfirmBox.className = pValue;
                if (this.MyTextArea)
                    this.MyTextArea.className = pValue;
            }
            else if (pName === "InnerStyle") {
                if (this.MyEditBox)
                    this.MyEditBox.style.cssText = pValue;
                if (this.MyConfirmBox)
                    this.MyConfirmBox.style.cssText = pValue;
                if (this.MyTextArea)
                    this.MyTextArea.style.cssText = pValue;
            }
            else if (pName === "TabIndex") {
                if (this.MyEditBox)
                    this.MyEditBox.tabIndex = pValue;
                if (this.MyConfirmBox)
                    this.MyConfirmBox.tabIndex = pValue;
                if (this.MyTextArea)
                    this.MyTextArea.tabIndex = pValue;
            }
            else if (pName === "LiveOptions" && this.MyCombo) {
                this.MyCombo.SetProperty(pName, pValue);
            }
            super.SetProperty(pName, pValue);
        }
        ShowHideMTL(pValue, IsSecond = false) {
            if (cde.CBool(IsSecond) === true) {
                if (this.MyMotLockButton2) {
                    cdeNMI.SetZIndex(this.MyMotLockButton2.GetElement(), cde.CBool(pValue) ? 1300 : 0);
                    this.mMotLoc2.SetProperty("IsOverlay", pValue);
                }
            }
            else {
                cdeNMI.SetZIndex(this.MyMotLockButton.GetElement(), cde.CBool(pValue) ? 1300 : 0);
                this.mMotLoc.SetProperty("IsOverlay", pValue);
            }
        }
        SetTE(pTE) {
            super.SetTE(pTE);
            if (this.MyCombo)
                this.MyCombo.SetTE(pTE);
        }
        EditRestore(pEvent, pEle) {
            const tModel = cdeNMI.MyNMIModels[this.MyScreenID];
            cdeNMI.ResetKeyCorder();
            if (this.MyTRF && this.MyTRF.TableName && this.MyTRF.TableName !== "" && tModel) {
                const tFldContent = cdeNMI.GetFldContent(tModel.MyStorageMirror[this.MyTRF.TableName][this.MyTRF.RowNo], this.MyFieldInfo, false);
                this.FireEvent(false, "OnValueChanged", pEvent, tFldContent, this.MyTRF);
            }
        }
        EditElement(pEvent, pEle) {
            let chCode;
            if (typeof pEvent === 'string')
                chCode = cde.CInt(pEvent);
            else
                chCode = ('keyCode' in pEvent) ? pEvent.keyCode : pEvent.charCode;
            //cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "KeyCode:HandleEvent", chCode);
            if (chCode === 13) {
                cdeNMI.StopPointerEvents(pEvent);
                this.CheckAndWriteValue(pEle, this.RequiresUpdateButton);
                cdeNMI.ResetKeyCorder();
            }
            else if (chCode === 27) {
                this.EditRestore(pEvent, pEle);
            }
            else if (this.JustIn && pEle === this.MyEditBox) {
                this.JustIn = false;
                this.MyEditBox.value = ""; // pEvent.key;
            }
            else if (this.JustInC && pEle === this.MyConfirmBox) {
                this.JustInC = false;
                this.MyConfirmBox.value = ""; // pEvent.key;
            }
        }
        CheckAndWriteValue(pEle, pValidateOnly = false) {
            switch (this.MyFieldInfo.Type) {
                case cdeNMI.cdeControlType.Number:
                    if (cde.CInt(this.GetProperty("MaxValue")) > 0 && cde.CInt(pEle.value) > cde.CInt(this.GetProperty("MaxValue"))) {
                        cdeNMI.ShowToastMessage("Entry is too High. Max Value=" + cde.CInt(this.GetProperty("MaxValue")));
                        this.SetProperty("iValue", super.GetProperty("Value"));
                        return;
                    }
                    if (cde.CInt(pEle.value) < cde.CInt(this.GetProperty("MinValue"))) {
                        cdeNMI.ShowToastMessage("Entry is too low. Min Value=" + cde.CInt(this.GetProperty("MaxValue")));
                        this.SetProperty("iValue", super.GetProperty("Value"));
                        return;
                    }
                    break;
                case cdeNMI.cdeControlType.eMail:
                    if (!cdeNMI.Check4ValidEmail(pEle.value)) {
                        cdeNMI.ShowToastMessage("Entry is not a valid Email Address");
                        this.SetProperty("AddClassName", "cdeValidateError");
                        return;
                    }
                    this.SetProperty("RemoveClassName", "cdeValidateError");
                    break;
                case cdeNMI.cdeControlType.IPAddress:
                    if (!cdeNMI.ValidateIPaddress(pEle.value)) {
                        cdeNMI.ShowToastMessage("Entry is not a valid IP-Address");
                        this.SetProperty("AddClassName", "cdeValidateError");
                        return;
                    }
                    this.SetProperty("RemoveClassName", "cdeValidateError");
                    break;
                case cdeNMI.cdeControlType.Password:
                    if (this.MyConfirmBox) {
                        if (!cdeNMI.IsSamePassword(this.MyEditBox.value, this.MyConfirmBox.value, true)) {
                            this.SetProperty("AddClassName", "cdeValidateError");
                            if (cdeNMI.MyToast)
                                cdeNMI.MyToast.ShowToastMessage("Passwords are not matching, please update");
                            return;
                        }
                        else if (!cdeNMI.Check4ValidPassword(this.MyEditBox.value)) {
                            this.SetProperty("AddClassName", "cdeValidateError");
                            if (cdeNMI.MyToast)
                                cdeNMI.MyToast.ShowToastMessage("Password is too short or is not strong enough. Must be at least 8 characters");
                            return;
                        }
                        this.SetProperty("RemoveClassName", "cdeValidateError");
                    }
                    break;
                default:
                    {
                        if (!pEle.value || pEle.value.length === 0 || !this.GetProperty("Validator"))
                            break;
                        const ipformat = new RegExp(this.GetProperty("Validator"));
                        if (!pEle.value.match(ipformat)) {
                            let tValText = this.GetProperty("ValidateErrorText");
                            if (!tValText)
                                tValText = "Entry does not validate. Please verify your entry";
                            cdeNMI.ShowToastMessage(tValText);
                            this.SetProperty("AddClassName", "cdeValidateError");
                            return;
                        }
                        this.SetProperty("RemoveClassName", "cdeValidateError");
                    }
                    break;
            }
            if (pValidateOnly === true)
                return;
            if (this.MyFieldInfo.Type === cdeNMI.cdeControlType.Password && cdeNMI.MyToast) {
                if (this.HasEvent("OnReturn"))
                    this.FireEvent(true, "OnReturn");
                else
                    cdeNMI.MyToast.ShowToastMessage("Password was set successfully");
            }
            this.IsDirty = true;
            this.FireEvent(false, "OnValueChanged", "CheckAndWriteValue", pEle.value, this.MyTRF);
            this.FireEvent(false, "OnPropertyChanged", "CheckAndWriteValue", pEle.value, "Value");
        }
        ApplySkin() {
            if (this.MyFieldInfo &&
                ((this.MyFieldInfo.Type === cdeNMI.cdeControlType.Password && !cde.CBool(this.GetProperty("HideMTL"))) || this.MyFieldInfo.Type === cdeNMI.cdeControlType.ComboOption)) {
                if (this.MyTextArea && this.MyTextArea.parentElement && this.MyTextArea.parentElement.clientWidth > 0)
                    this.MyTextArea.style.width = this.MyTextArea.parentElement.clientWidth - (cdeNMI.GetSizeFromTile(1) + 6) + "px";
                if (this.MyEditBox && this.MyEditBox.parentElement && this.MyEditBox.parentElement.clientWidth > 0)
                    this.MyEditBox.style.width = this.MyEditBox.parentElement.clientWidth - (cdeNMI.GetSizeFromTile(1) + 6) + "px";
                if (this.MyConfirmBox)
                    this.MyConfirmBox.style.width = this.MyConfirmBox.parentElement.clientWidth - (cdeNMI.GetSizeFromTile(1) + 6) + "px";
            }
        }
        GetProperty(pName) {
            if (pName === "Value") {
                if (this.MyEditBox)
                    return this.MyEditBox.value;
                else if (this.MyTextArea)
                    return this.MyTextArea.value;
            }
            return super.GetProperty(pName);
        }
        //Backwards Conpat
        static Create(pTargetControl, pScreenID, pTRF, pContent, pShowOverlay, pClassName) {
            const tTile = new ctrlEditBox(pTRF);
            tTile.InitControl(pTargetControl, pTRF, null, pScreenID);
            if (pContent)
                tTile.SetProperty("iValue", pContent);
            if (cde.CBool(pShowOverlay))
                tTile.SetProperty("IsOverlay", true);
            else
                tTile.SetProperty("IsOverlay", false);
            if (pClassName)
                tTile.SetProperty("InnerClassName", pClassName);
            return tTile;
        }
    }
    cdeNMI.ctrlEditBox = ctrlEditBox;
})(cdeNMI || (cdeNMI = {}));
// SPDX-FileCopyrightText: 2009-2023 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
var cdeNMI;
// SPDX-FileCopyrightText: 2009-2023 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
(function (cdeNMI) {
    /**
    * Creates a group of elements in a DIV
    * The pTargetControl will be overlayed by the ctrlDrawOverlay
    * pTRF is handed to ctrlTouchDraw
    *
    * This control is a Container Control
    * (4.1 Ready!)
    */
    class ctrlTileGroup extends cdeNMI.TheNMIBaseControl {
        constructor(pTRF) {
            super(null, pTRF);
            this.divTiles = null;
            this.divDragContent = null;
            this.h1Title = null;
            this.dragPosition = { x: 0, y: 0 };
        }
        static Create(pTargetEleme, pTRF, pPropertyBag, pScreenID, pCaption, pClassName) {
            const t = new ctrlTileGroup(pTRF);
            t.InitControl(pTargetEleme, pTRF, pPropertyBag, pScreenID);
            if (pCaption)
                t.SetProperty("Label", pCaption);
            if (pClassName)
                t.SetProperty("ClassName", pCaption);
            return t;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.TileGroup;
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            this.divTiles = document.createElement('div');
            this.divTiles.className = "cdeTiles";
            this.divTiles.style.cssFloat = "left";
            if (pTRF && pTRF.FldInfo) {
                this.divTiles.setAttribute("cdefo", cde.CStr(pTRF.FldInfo.FldOrder));
                this.divTiles.setAttribute("cdemid", cde.GuidToString(pTRF.FldInfo.cdeMID));
                if (cde.CBool(this.GetSetting("DisallowEdit")) === false)
                    this.divTiles.setAttribute("cdesel", "true");
            }
            if (cde.CBool(this.GetSetting("AllowDragOld"))) {
                this.divDragContent = document.createElement('div');
                this.divDragContent.style.position = "absolute";
                this.divDragContent.style.overflow = "hidden";
                this.divTiles.style.position = "relative";
                this.divTiles.appendChild(this.divDragContent);
                this.SetElement(this.divTiles, false, this.divDragContent);
            }
            else {
                this.SetElement(this.divTiles);
            }
            return true;
        }
        SetProperty(pName, pValue) {
            super.SetProperty(pName, pValue);
            let tWid;
            if (pName === "Caption" || pName === "Label" || pName === "Title" || pName === "Value" || pName === "iValue") {
                if (pValue) {
                    let tNewVal = pValue;
                    if (pName === "Caption" || pName === "Label" || pName === "Title")
                        tNewVal = cdeNMI.TL.T(pValue);
                    if (this.GetProperty("Format") && (pName === "Value" || pName === "iValue")) {
                        tNewVal = this.GetProperty("Format").format(pValue);
                    }
                    if (this.MyBaseType !== cdeNMI.cdeControlType.CollapsibleGroup && cde.CBool(this.GetProperty("IsDivOnly"))) {
                        if (tNewVal && tNewVal.startsWith("FA") && tNewVal.length === 8) {
                            tNewVal = "<i class='fa faIcon " + (tNewVal.substring(3, 4) === "S" ? "fa-spin " : "") + "fa-" + tNewVal.substring(2, 3) + "x'>&#x" + tNewVal.substring(4) + ";</i>";
                        }
                        this.divTiles.innerHTML = tNewVal;
                        this.divTiles.style.cssFloat = "none";
                    }
                    else {
                        if (!cde.CBool(this.GetProperty("HideCaption"))) {
                            if (!this.h1Title) {
                                let titleEle = "h1";
                                if (this.GetProperty("LabelElement"))
                                    titleEle = this.GetProperty("LabelElement");
                                this.h1Title = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SmartLabel).Create(null, { PreInitBag: ["Element=" + titleEle] });
                                if (this.GetProperty("LabelClassName"))
                                    this.h1Title.SetProperty("ClassName", this.GetProperty("LabelClassName"));
                                else {
                                    if ((cde.MyBaseAssets.MyServiceHostInfo.WebPlatform !== 5) && (this.GetProperty("IsSmall") || cde.CInt(this.GetProperty("TileFactorY")) > 1))
                                        this.h1Title.SetProperty("ClassName", "cdeTileGroupHeaderSmall");
                                    else
                                        this.h1Title.SetProperty("ClassName", "cdeTileGroupHeader");
                                }
                                this.h1Title.GetElement().style.cssFloat = null;
                                this.divTiles.appendChild(this.h1Title.GetElement());
                            }
                            this.h1Title.SetProperty("iValue", tNewVal);
                        }
                    }
                }
                else {
                    if (this.h1Title) {
                        this.h1Title.GetElement().parentElement.removeChild(this.h1Title.GetElement());
                        this.h1Title = null;
                    }
                    return;
                }
            }
            else if (pName === "HideCaption" && this.h1Title && cde.CBool(pValue)) {
                this.h1Title.GetElement().parentElement.removeChild(this.h1Title.GetElement());
                this.h1Title = null;
            }
            else if (pName === "OnClick" && pValue) {
                this.PreventManipulation = true;
                this.HookEvents(false);
                this.RegisterEvent("OnClick", pValue);
                this.RegisterEvent("PointerUp", this.DoFireClick);
            }
            else if (pName === "OnHover" && pValue) {
                this.GetElement().addEventListener("mouseenter", (evt) => this.onHover(evt));
                this.RegisterEvent("OnHover", pValue);
            }
            else if ((pName === "TileWidth" || pName === "TileFactorX") && this.MyRootElement) {
                pValue = this.GetProperty("TileWidth");
                if (!pValue)
                    pValue = 1;
                if (cde.CInt(pValue) > 0) {
                    tWid = this.SetWidth(this.divTiles, cde.CInt(pValue), 0);
                    this.divTiles.style.maxWidth = tWid + "px";
                    if (this.divDragContent) {
                        this.divDragContent.style.width = tWid + "px";
                        this.divDragContent.style.maxWidth = tWid + "px";
                    }
                }
                else {
                    if (this.divDragContent) {
                        this.divTiles.style.width = this.divDragContent.clientWidth + "px";
                        this.divTiles.style.maxWidth = this.divDragContent.clientWidth + "px";
                    }
                    else {
                        this.divTiles.style.width = "inherit";
                        this.divTiles.style.maxWidth = "inherit";
                    }
                }
                this.SetProperty("ControlTW", pValue);
            }
            else if ((pName === "TileHeight" || pName === "TileFactorY") && this.MyRootElement) {
                pValue = this.GetProperty("TileHeight");
                if (!pValue)
                    pValue = 1;
                if (cde.CInt(pValue) > 0) {
                    tWid = this.SetHeight(this.divTiles, cde.CInt(pValue), 0);
                    this.divTiles.style.maxHeight = tWid + "px";
                    if (this.divDragContent)
                        this.divDragContent.style.height = tWid + "px";
                }
                else {
                    if (this.divDragContent) {
                        this.divTiles.style.height = this.divDragContent.clientHeight + "px";
                        this.divTiles.style.maxHeight = this.divDragContent.clientHeight + "px";
                    }
                    else {
                        this.divTiles.style.height = "inherit";
                        this.divTiles.style.maxHeight = "inherit";
                    }
                }
                this.SetProperty("ControlTH", pValue);
            }
            else if (pName === "MaxTileHeight" && this.MyRootElement) {
                if (cde.CInt(pValue) > 0) {
                    tWid = cdeNMI.GetSizeFromTile(cde.CInt(pValue));
                    if (cde.CInt(this.GetProperty("TileFactorY")) > 1)
                        tWid /= cde.CInt(this.GetProperty("TileFactorY"));
                    this.divTiles.style.maxHeight = tWid + "px";
                }
                else {
                    this.divTiles.style.maxHeight = "inherit";
                }
            }
            else if (pName === "Background" && this.MyRootElement && this.MyBaseType !== cdeNMI.cdeControlType.CollapsibleGroup) {
                this.divTiles.style.background = pValue;
            }
            else if (pName === "GroupBackground" && this.MyRootElement) {
                this.divTiles.style.background = pValue;
            }
            else if (pName === "IsVScrollable" && this.MyRootElement) {
                this.MyRootElement.style.overflowY = "auto";
            }
            else if (pName === "IsHScrollable" && this.MyRootElement) {
                this.MyRootElement.style.overflowX = "auto";
            }
            else if (pName === "Overflow" && this.MyRootElement) {
                this.MyRootElement.style.overflow = pValue;
            }
            else if (pName === "LabelClassName" && this.h1Title) {
                this.h1Title.SetProperty("ClassName", pValue);
            }
            else if (pName === "CaptionBackground" && this.h1Title) {
                this.h1Title.SetProperty("Background", pValue);
            }
            else if (pName === "LabelForeground" && this.h1Title) {
                this.h1Title.SetProperty("Foreground", pValue);
            }
            else if (pName === "LabelFontSize" && this.h1Title) {
                this.h1Title.SetProperty("FontSize", pValue);
            }
            else if (pName === "PixelHeight") {
                super.SetProperty("PixelHeight", pValue);
                if (this.divDragContent) {
                    if (pValue.toString().endsWith("px") || pValue.toString().endsWith("%") || pValue === "auto")
                        this.divDragContent.style.height = pValue;
                    else
                        this.divDragContent.style.height = pValue + "px";
                    this.divTiles.style.height = this.divDragContent.clientHeight + "px";
                }
            }
            else if (pName === "LabelFormat") {
                this.SetProperty("Format", pValue);
                this.SetProperty("iValue", this.GetProperty("Value"));
            }
        }
        onHover(evt) {
            this.FireEvent(true, "OnHover", evt);
        }
        ApplySkin() {
            if (this.divDragContent)
                this.divTiles.style.height = this.divDragContent.clientHeight + "px";
        }
        AppendChild(pEle) {
            try {
                this.MyChildren.push(pEle);
                if (pEle.GetElement()) {
                    if (this.GetContainerElement() !== pEle.GetElement())
                        this.GetContainerElement().appendChild(pEle.GetElement());
                    this.ApplySkin();
                }
            }
            catch (eee) {
                cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "TileGroup:AppendChild", eee.message + ":" + eee.stack);
            }
        }
        AppendElement(pEle) {
            this.GetContainerElement().appendChild(pEle);
            this.ApplySkin();
        }
    }
    cdeNMI.ctrlTileGroup = ctrlTileGroup;
    /**
    * Creates a Collapsible Tile Group allowing to structure a Form
    *
    * (4.1 Ready!)
    */
    class ctrlCollapsibleGroup extends cdeNMI.ctrlTileGroup {
        constructor(pTRF) {
            super(pTRF);
            this.mHideOpenButton = null;
            this.mExpandLeftButton = null;
            this.mExpandRightButton = null;
            this.mDragButton = null;
            this.mContentGroup = null;
            this.pos1 = 0;
            this.pos2 = 0;
            this.pos3 = 0;
            this.pos4 = 0;
            this.oldz = "";
            this.oldBC = "";
            this.IsDragging = false;
            this.mDefaultSize = 6;
            this.IsTesla = false;
            this.colOpen = (event) => {
                if (event)
                    event.target.removeEventListener("transitionend", this.colOpen);
                if (this.mTitleGroup.GetElement().classList.contains("cdeCollapsibleOpen"))
                    this.mTitleGroup.GetElement().classList.remove("cdeCollapsibleOpen");
                if (!this.mTitleGroup.GetElement().classList.contains("cdeCollapsibleOpen"))
                    this.mTitleGroup.GetElement().classList.add("cdeCollapsibleClosed");
                if (this.mHideOpenButton)
                    this.mHideOpenButton.SetProperty("Title", "<span class='fa fa-lg cdeFormPin'>&#xF078;<span>");
                this.OnUnload();
            };
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.SetTRF(pTRF, pPropertyBag);
            super.InitControl(pTargetControl, null, null, pScreenID);
            this.MyBaseType = cdeNMI.cdeControlType.CollapsibleGroup;
            super.SetProperty("ClassName", "cdeCollapsibleGroup");
            if (!this.GetSetting("TileWidth") && this.GetSetting("MinTileWidth"))
                this.SetProperty("TileWidth", this.GetSetting("MinTileWidth"));
            this.IsTesla = false;
            this.mTitleGroup = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileGroup);
            const tGrpInfo = new cdeNMI.TheFieldInfo(cdeNMI.cdeControlType.TileGroup, (pTRF && pTRF.FldInfo) ? pTRF.FldInfo.Flags : 2, null);
            tGrpInfo.FldOrder = (pTRF && pTRF.FldInfo) ? pTRF.FldInfo.FldOrder : 0;
            this.mTitleGroup.InitControl(this, new cdeNMI.TheTRF(null, 0, tGrpInfo));
            this.mTitleGroup.GetElement().style.width = "100%";
            this.mTitleGroup.GetElement().style.maxWidth = "100%";
            this.mTitleGroup.GetElement().style.cssFloat = null;
            this.mTitleGroup.SetProperty("TileHeight", 1);
            this.SetGroupHeaderSize();
            this.mTitleGroup.HookEvents(false);
            this.RegisterEvent("Resize", (sender, tNewW) => {
                let tW = this.GetElement().clientWidth / cdeNMI.GetSizeFromTile(1);
                tW = Math.floor(tW / 6) * this.mDefaultSize;
                if (!cde.CBool(this.GetSetting("AllowHorizontalExpand")) && tNewW !== cde.CInt(this.GetProperty("TileWidth")))
                    return;
                if (tW > tNewW) {
                    if (!this.GetSetting("MinTileWidth") || tNewW >= cde.CInt(this.GetSetting("MinTileWidth"))) {
                        this.SetProperty("TileWidth", tNewW);
                        this.FireResize(tNewW);
                    }
                }
                else if (tW < tNewW) {
                    if (!this.GetSetting("MaxTileWidth") || tNewW <= cde.CInt(this.GetSetting("MaxTileWidth"))) {
                        this.SetProperty("TileWidth", tNewW);
                        this.FireResize(tNewW);
                    }
                }
            });
            this.mContentGroup = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileGroup);
            this.mContentGroup.InitControl(this);
            this.mContentGroup.SetProperty("ClassName", "cdeInsideCollapsible");
            this.mContentGroup.GetElement().style.width = "inherit";
            const tCloseGroup = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileGroup);
            tCloseGroup.InitControl(this);
            tCloseGroup.GetElement().style.height = (cdeNMI.GetSizeFromTile(1) / 4) + "px";
            tCloseGroup.SetProperty("ClassName", "cdeCloseGroup");
            this.SetElement(this.GetElement(), false, this.mContentGroup.GetElement());
            this.mTitleGroup.RegisterEvent("PointerUp", (pControl, evt) => {
                if (evt.type === "mousedown" || this.IsDragging)
                    return;
                if (this.MyFieldInfo && (this.MyFieldInfo.Flags & 2) !== 0)
                    this.ToggleDrop(!cde.CBool(cde.CBool(this.GetProperty("IsOpen"))), false);
            });
            let lgsize = "2x";
            if (!this.IsTesla && cde.CBool(this.GetSetting("IsSmall")))
                lgsize = "lg";
            if (cde.CBool(this.GetSetting("AllowHorizontalExpand")) === true && cde.CBool(this.GetSetting("HidePins")) !== true && this.GetSetting("MaxTileWidth")) {
                this.mExpandLeftButton = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(this.mTitleGroup, { PreInitBag: ["ControlTW=1", "ControlTH=1"], PostInitBag: ["iValue=<span class='fa fa-" + lgsize + " cdeFormPin'>&#xF0A9;<span>"] });
                this.mExpandLeftButton.SetProperty("OnClick", (sender, evt) => {
                    let tW = this.MyRootElement.clientWidth / cdeNMI.GetSizeFromTile(1);
                    tW = Math.floor(tW / 6) * this.mDefaultSize;
                    if (!this.GetProperty("MaxTileWidth") || tW <= cde.CInt(this.GetProperty("MaxTileWidth")) - this.mDefaultSize && cdeNMI.MyScreenManager && this.SetWidth(null, tW + this.mDefaultSize, 0, true) < cdeNMI.MyScreenManager.DocumentWidth && cdeNMI.MyScreenManager.DocumentWidth > 0) {
                        tW += this.mDefaultSize;
                        this.SetNewWidth(tW);
                        this.ResizeParentsUp(this, tW);
                        this.FireResize(tW);
                    }
                    evt.stopPropagation();
                });
                this.mExpandLeftButton.SetProperty("Float", "right");
                if (!this.IsTesla && cde.CBool(this.GetSetting("IsSmall"))) {
                    this.mExpandLeftButton.SetProperty("TileFactorX", 2);
                    this.mExpandLeftButton.SetProperty("TileFactorY", 2);
                }
                this.mExpandRightButton = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(this.mTitleGroup, { PreInitBag: ["ControlTW=1", "ControlTH=1"], PostInitBag: ["iValue=<span class='fa fa-" + lgsize + " cdeFormPin'>&#xF0A8;<span>"] });
                this.mExpandRightButton.SetProperty("OnClick", (sender, evt) => {
                    let tW = this.MyRootElement.clientWidth / cdeNMI.GetSizeFromTile(1);
                    tW = Math.floor(tW / 6) * this.mDefaultSize;
                    if (tW > this.mDefaultSize && (!this.GetProperty("MinTileWidth") || tW >= cde.CInt(this.GetProperty("MinTileWidth")) + this.mDefaultSize) && !this.IsAChildBigger(tW - this.mDefaultSize)) {
                        tW -= this.mDefaultSize;
                        this.SetNewWidth(tW);
                        this.ResizeChildrenDown(this, tW);
                        this.FireResize(tW);
                    }
                    evt.stopPropagation();
                });
                this.mExpandRightButton.SetProperty("Float", "right");
                if (!this.IsTesla && cde.CBool(this.GetSetting("IsSmall"))) {
                    this.mExpandRightButton.SetProperty("TileFactorX", 2);
                    this.mExpandRightButton.SetProperty("TileFactorY", 2);
                }
            }
            if (cde.CBool(this.GetSetting("HidePins")) !== true && (!this.MyFieldInfo || this.MyFieldInfo.Flags === undefined || (this.MyFieldInfo.Flags & 2) !== 0)) {
                this.mHideOpenButton = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(this.mTitleGroup, { PreInitBag: ["ControlTW=1", "ControlTH=1"], PostInitBag: ["iValue=<span class='fa fa-lg cdeFormPin'>&#xF078;<span>"] });
                this.mHideOpenButton.SetProperty("Float", "left");
                if (!this.IsTesla && cde.CBool(this.GetSetting("IsSmall"))) {
                    this.mHideOpenButton.SetProperty("TileFactorX", 2);
                    this.mHideOpenButton.SetProperty("TileFactorY", 2);
                }
            }
            if (cde.CBool(this.GetSetting("AllowDrag"))) {
                this.mDragButton = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(this.mTitleGroup, { PreInitBag: ["ControlTW=1", "ControlTH=1"], PostInitBag: ["iValue=<span class='fa fa-lg cdeFormPin'>&#xF0b2;<span>"] });
                this.mDragButton.SetProperty("Float", "right");
                this.mDragButton.SetProperty("HoverClassName", "cdeDragButton");
                if (!this.IsTesla && cde.CBool(this.GetSetting("IsSmall"))) {
                    this.mDragButton.SetProperty("TileFactorX", 2);
                    this.mDragButton.SetProperty("TileFactorY", 2);
                }
                this.mDragButton.SetProperty("OnPointerDown", (sender, e) => {
                    if (this.IsDragging) {
                        this.closeDragElement(e);
                        return;
                    }
                    e = e || window.event;
                    e.preventDefault();
                    this.pos3 = e.clientX;
                    this.pos4 = e.clientY;
                    this.IsDragging = true;
                    document.onpointerup = (evt) => { this.closeDragElement(evt); };
                    this.oldz = this.MyRootElement.style.zIndex;
                    this.MyRootElement.style.zIndex = "4000";
                    this.oldBC = this.GetElement().style.backgroundColor;
                    this.GetElement().style.backgroundColor = "rgba(0,0,0,.4)";
                    document.onpointermove = (evt) => { this.elementDrag(evt); };
                });
            }
            else {
                this.SetProperty("Overflow", "hidden");
            }
            this.ApplySkin();
            this.ToggleDrop(!cde.CBool(cde.CBool(this.GetProperty("DoClose"))), true);
            return true;
        }
        SetProperty(pName, pValue) {
            if (pName === "UseMargin" && cde.MyBaseAssets.MyServiceHostInfo.WebPlatform !== 1) {
                if (cde.CBool(pValue) === true)
                    super.SetProperty("Margin", cdeNMI.GetSizeFromTile(1) / 4);
                else
                    super.SetProperty("Margin", 0);
                return;
            }
            else if (pName === "Caption" || pName === "Label" || pName === "Title" || pName === "Value" || pName === "iValue") {
                let tNewVal = pValue;
                if (this.GetProperty("Format") && (pName === "Value" || pName === "iValue")) {
                    tNewVal = this.GetProperty("Format").format(pValue);
                }
                else {
                    tNewVal = cdeNMI.TL.T(tNewVal);
                }
                this.mTitleGroup.SetProperty(pName, tNewVal);
                if (cde.CBool(this.GetProperty("HideCaption")) || (cde.CBool(this.GetProperty("HidePins")) && cde.IsNotSet(pValue))) {
                    this.mTitleGroup.SetProperty("Visibility", false);
                }
                else {
                    this.mTitleGroup.SetProperty("Visibility", true);
                }
                return;
            }
            else if (pName === "HideCaption" && this.mTitleGroup && cde.CBool(pValue)) {
                this.mTitleGroup.SetProperty("Visibility", false);
            }
            else if (pName === "CaptionBackground") {
                this.mTitleGroup.SetProperty("Background", pValue);
            }
            else if (pName === "ContentBackground") {
                this.mContentGroup.SetProperty("Background", pValue);
            }
            else if (pName === "LabelForeground") {
                this.mTitleGroup.SetProperty(pName, pValue);
                if (this.mExpandLeftButton)
                    this.mExpandLeftButton.SetProperty("Foreground", pValue);
                if (this.mExpandRightButton)
                    this.mExpandRightButton.SetProperty("Foreground", pValue);
            }
            else if (pName === "LabelClassName") {
                this.mTitleGroup.SetProperty("LabelClassName", pValue);
                this.mTitleGroup.SetProperty("ClassName", pValue);
                this.ToggleDrop(!cde.CBool(cde.CBool(this.GetProperty("DoClose"))), true);
                return;
            }
            else if (pName === "DoClose") {
                this.ToggleDrop(!cde.CBool(pValue), true);
            }
            else if (pName === "Background" || pName === "GroupBackground" || pName === "IsVScrollable" || pName === "IsHScrollable") {
                super.SetProperty(pName, pValue);
                return;
            }
            else if (pName === "HidePins") {
                const tHide = (pName === "HidePins" ? !cde.CBool(pValue) : false);
                if (this.mHideOpenButton && (!tHide || (this.MyFieldInfo && (this.MyFieldInfo.Flags & 2) === 0)))
                    this.mHideOpenButton.SetProperty("Visibility", tHide);
                if (cde.CBool(pValue) && cde.IsNotSet(this.mTitleGroup.GetProperty("Value"))) {
                    this.mTitleGroup.SetProperty("Visibility", false);
                }
                else {
                    this.mTitleGroup.SetProperty("Visibility", true);
                }
            }
            super.SetProperty(pName, pValue);
            if (pName === "TileHeight" && cde.CBool(cde.CBool(this.GetProperty("DoClose")))) {
                this.ToggleDrop(!cde.CBool(cde.CBool(this.GetProperty("DoClose"))), true);
            }
            else if (!this.IsTesla && pName === "IsSmall" && this.mTitleGroup) {
                this.SetGroupHeaderSize();
            }
        }
        closeDragElement(e) {
            cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "closedrag", "closed");
            e.stopPropagation();
            e.preventDefault();
            this.IsDragging = false;
            /* stop moving when mouse button is released:*/
            document.onpointermove = null;
            document.onpointerup = null;
            this.MyRootElement.style.zIndex = this.oldz;
            //Snap control infront of the control its on - except it was right infront of it
            this.MyRootElement.style.top = "0px";
            this.MyRootElement.style.left = "0px";
            this.GetElement().style.backgroundColor = this.oldBC;
            this.ApplySkin();
        }
        elementDrag(e) {
            e = e || window.event;
            e.preventDefault();
            // calculate the new cursor position:
            this.pos1 = this.pos3 - e.clientX;
            this.pos2 = this.pos4 - e.clientY;
            this.pos3 = e.clientX;
            this.pos4 = e.clientY;
            if (this.pos1 === 0 && this.pos2 === 0) {
                this.closeDragElement(e);
                return;
            }
            this.IsDragging = true;
            cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "ElemetDrag", this.pos1 + "," + this.pos2 + "," + this.pos3 + "," + this.pos4);
            // set the element's new position:
            this.MyRootElement.style.top = (this.MyRootElement.offsetTop - this.pos2) + "px";
            this.MyRootElement.style.left = (this.MyRootElement.offsetLeft - this.pos1) + "px";
        }
        SetNewWidth(tW) {
            if (tW > 0) {
                if (!cde.CBool(this.GetSetting("AllowHorizontalExpand")) && tW !== cde.CInt(this.GetProperty("TileWidth")))
                    tW = cde.CInt(this.GetProperty("TileWidth"));
                this.SetProperty("TileWidth", tW);
            }
        }
        ResizeParentsUp(pTargetControl, tW) {
            if (!pTargetControl.MyTarget)
                return;
            if (pTargetControl.MyTarget.MyBaseType === cdeNMI.cdeControlType.CollapsibleGroup && cde.CBool(pTargetControl.MyTarget.GetProperty("AllowHorizontalExpand")) === true) {
                if (cde.CInt(pTargetControl.MyTarget.GetProperty("TileWidth")) < tW) {
                    pTargetControl.MyTarget.FireEvent(true, "Resize", tW);
                    this.ResizeParentsUp(pTargetControl.MyTarget, tW);
                }
            }
        }
        ResizeChildrenDown(pTargetControl, tW) {
            for (const i in pTargetControl.MyChildren) {
                const tChildControl = pTargetControl.MyChildren[i];
                if (tChildControl.MyBaseType === cdeNMI.cdeControlType.CollapsibleGroup && cde.CBool(tChildControl.GetProperty("AllowHorizontalExpand")) === true) {
                    if (!tChildControl.GetProperty("TileWidth") || tW < cde.CInt(tChildControl.GetProperty("TileWidth")) && (!tChildControl.GetProperty("MinTileWidth") || tW >= cde.CInt(tChildControl.GetProperty("MinTileWidth")))) {
                        tChildControl.FireEvent(true, "Resize", tW);
                        this.ResizeChildrenDown(tChildControl, tW);
                    }
                }
            }
        }
        IsAChildSmaller(pTarget, tW) {
            for (const i in pTarget.MyChildren) {
                if (pTarget.MyChildren[i] && cde.CInt(pTarget.MyChildren[i].GetProperty("TileWidth")) < tW)
                    return true;
            }
            return false;
        }
        FireResize(pSize) {
            for (const i in this.MyChildren) {
                this.MyChildren[i].FireEvent(true, "Resize", pSize);
            }
        }
        SetGroupHeaderSize() {
            if (!this.mTitleGroup)
                return;
            if (!this.IsTesla && (this.GetProperty("IsSmall") || cde.CInt(this.GetProperty("TileFactorY")) > 1)) {
                this.mTitleGroup.GetElement().style.height = (cdeNMI.GetSizeFromTile(1) / 2) + "px";
                this.mTitleGroup.SetProperty("ClassName", "cdeTileGroupHeaderSmall");
                this.mTitleGroup.SetProperty("LabelClassName", "cdeTileGroupHeaderSmall");
            }
            else {
                this.mTitleGroup.SetProperty("ClassName", "cdeTileGroupHeader");
            }
            this.ToggleDrop(!cde.CBool(this.GetProperty("DoClose")), true);
        }
        ToggleDrop(doClose, doForce) {
            if (!doForce && cde.CBool(this.GetProperty("HidePins")))
                return;
            if (!doClose) {
                this.SetProperty("IsOpen", false);
                let tNH = (cdeNMI.GetSizeFromTile(1));
                if (!this.IsTesla && this.GetProperty("IsSmall"))
                    tNH /= 2;
                super.SetProperty("Style", "max-height:" + tNH + "px");
                this.colOpen(null);
            }
            else {
                this.SetProperty("IsOpen", true);
                if (this.mTitleGroup.GetElement().classList.contains("cdeCollapsibleClosed"))
                    this.mTitleGroup.GetElement().classList.remove("cdeCollapsibleClosed");
                this.mTitleGroup.GetElement().classList.add("cdeCollapsibleOpen");
                if (this.mHideOpenButton)
                    this.mHideOpenButton.SetProperty("Title", "<span class='fa fa-lg cdeFormPin'>&#xF077;<span>");
                if (cdeNMI.GetSizeFromTile(super.GetProperty("TileHeight")) > 0) {
                    let tNH = (cdeNMI.GetSizeFromTile(super.GetProperty("TileHeight")));
                    if (!this.IsTesla && this.GetProperty("IsSmall"))
                        tNH /= 2;
                    super.SetProperty("Style", "max-height:" + tNH + "px;");
                }
                else {
                    super.SetProperty("Style", "max-height:none;");
                }
                this.OnLoad();
            }
        }
    }
    cdeNMI.ctrlCollapsibleGroup = ctrlCollapsibleGroup;
})(cdeNMI || (cdeNMI = {}));
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
var cdeNMI;
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
(function (cdeNMI) {
    class ThePopup extends cdeNMI.TheNMIBaseControl {
        constructor(pTarget) {
            super(pTarget, null);
            this.elePopupButtonContent = null;
            this.tileButOkButton = null;
            this.tileButYesButton = null;
            this.tileButNoButton = null;
            this.mTouchOverlay = null;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.Popup;
            const tButFlt = "margin:0 auto;";
            this.tileButOkButton = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(null, { PreInitBag: ["ControlTW=2", "ControlTH=1"], PostInitBag: ["Title=OK", "ClassName=cdeOkButton", "Style=" + tButFlt] });
            this.tileButOkButton.SetProperty("OnClick", () => this.DoOk());
            this.tileButYesButton = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(null, { PreInitBag: ["ControlTW=2", "ControlTH=1"], PostInitBag: ["Title=Yes", "ClassName=cdeYesButton", "Style=" + tButFlt] });
            this.tileButYesButton.SetProperty("OnClick", (sender, evt, pointer, cookie, parent) => this.DoYes(parent, cookie));
            this.tileButNoButton = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(null, { PreInitBag: ["ControlTW=2", "ControlTH=1"], PostInitBag: ["Title=No", "ClassName=cdeNoButton", "Style=" + tButFlt] });
            this.tileButNoButton.SetProperty("OnClick", () => this.DoNo());
            this.gridPopups = document.getElementById("gridPopups");
            if (!this.gridPopups) {
                this.gridPopups = document.createElement("div");
                this.gridPopups.id = "gridPopups";
                this.gridPopups.className = "cdeScreenPopup";
                this.gridPopups.style.display = "none";
                this.gridPopups.style.height = "0px";
                this.gridPopups.innerHTML = "<div class=\"cdeCenteredPopup\" id=\"gridPopupsInner\"><div class=\"cdePopupContent41\" id=\"cdePopupQuestion\">" + cdeNMI.TL.T("Are you sure?") + "</div><table class=\"MyFullTable\"><tr><td id=\"popupButtonContainer\" class=\"cdeFlexRow\"></td></tr></table></div>";
                const tBody = document.getElementsByTagName("body");
                if (tBody)
                    tBody[0].appendChild(this.gridPopups);
                else
                    document.appendChild(document.createElement("body")).appendChild(this.gridPopups);
            }
            this.gridPopups.addEventListener("animationend", () => this.EndHide());
            this.gridPopupsInner = document.getElementById("gridPopupsInner");
            this.gridPopupsInner.style.width = cdeNMI.GetSizeFromTile(6) + "px";
            this.cdePopupQuestion = document.getElementById("cdePopupQuestion");
            this.elePopupButtonContent = document.getElementById("popupButtonContainer");
            this.SetElement(this.elePopupButtonContent);
            return true;
        }
        SetProperty(pName, pValue) {
            super.SetProperty(pName, pValue);
            if (pName === "YesLabel") {
                this.tileButYesButton.SetProperty("Text", pValue);
            }
            if (pName === "NoLabel") {
                this.tileButNoButton.SetProperty("Text", pValue);
            }
            if (pName === "OkLabel") {
                this.tileButOkButton.SetProperty("Text", pValue);
            }
        }
        AddControl(pControl) {
            if (pControl)
                this.cdePopupQuestion.appendChild(pControl.GetElement());
        }
        DoYes(pParent, pCookie) {
            this.Hide(true);
            if (this.cdeEventYes) {
                this.cdeEventYes(this, pParent, pCookie);
            }
            this.cdeEventYes = null;
            this.cdeEventNo = null;
        }
        DoNo() {
            this.Hide(true);
            if (this.cdeEventNo) {
                this.cdeEventNo(this);
            }
            this.cdeEventYes = null;
            this.cdeEventNo = null;
        }
        DoOk() {
            this.Hide(true);
            if (this.cdeEventYes) {
                this.cdeEventYes(this);
            }
            this.cdeEventYes = null;
            this.cdeEventNo = null;
        }
        Hide(pPlayAni) {
            if (cde.MyBaseAssets.MyServiceHostInfo.WebPlatform === 2 && cdeNMI.MyScreenManager)
                cdeNMI.MyScreenManager.ShowHeader(false);
            this.gridPopups.classList.remove("cde-animate-popup");
            if (pPlayAni)
                this.gridPopups.classList.add("cde-animate-fadeout");
            else
                this.EndHide();
        }
        EndHide() {
            if (this.gridPopups.classList.contains("cde-animate-popup") || !this.gridPopups.classList.contains("cde-animate-fadeout")) {
                return;
            }
            this.gridPopups.classList.remove("cde-animate-fadeout");
            this.gridPopups.style.display = 'none';
            if (cdeNMI.MyNMIPortal)
                cdeNMI.MyNMIPortal.DeleteControl(this.mTouchOverlay);
            this.mTouchOverlay = null;
        }
        Show(pMessageText, bShowOkOnly, pControl, pBackColor, sinkYes, sinkNo, pCookie, pParent) {
            this.Hide(false);
            if (this.mTouchOverlay) {
                if (cdeNMI.MyNMIPortal)
                    cdeNMI.MyNMIPortal.DeleteControl(this.mTouchOverlay);
                this.mTouchOverlay = null;
            }
            if (cde.MyBaseAssets.MyServiceHostInfo.WebPlatform === 2 && cdeNMI.MyScreenManager)
                cdeNMI.MyScreenManager.ShowHeader(true);
            if (!this.gridPopups)
                return null;
            this.cdeEventYes = null;
            this.cdeEventNo = null;
            if (pMessageText !== '')
                this.cdePopupQuestion.innerHTML = cdeNMI.TL.T(pMessageText);
            this.elePopupButtonContent.innerHTML = "";
            if (!cdeNMI.MyNMIPortal) {
                cdeNMI.MyNMIPortal = cdeNMI.MyTCF.CreateBaseControl();
                cdeNMI.MyNMIPortal.SetElement(document.getElementById("MyNMIPortal"));
            }
            this.mTouchOverlay = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TouchOverlay).Create(cdeNMI.MyNMIPortal);
            this.mTouchOverlay.SetProperty("Z-Index", 90);
            if (bShowOkOnly) {
                this.elePopupButtonContent.appendChild(this.tileButOkButton.GetElement());
                if (typeof sinkYes !== "undefined")
                    this.cdeEventYes = sinkYes;
            }
            else {
                if (pCookie) {
                    this.tileButYesButton.SetProperty("Cookie", pCookie);
                    this.tileButYesButton.SetProperty("Parent", pParent);
                }
                this.elePopupButtonContent.appendChild(this.tileButNoButton.GetElement());
                this.elePopupButtonContent.appendChild(this.tileButYesButton.GetElement());
                if (typeof sinkYes !== "undefined")
                    this.cdeEventYes = sinkYes;
                if (typeof sinkNo !== "undefined")
                    this.cdeEventNo = sinkNo;
            }
            this.SetProperty("YesLabel", "Yes");
            this.SetProperty("NoLabel", "No");
            this.SetProperty("OkLabel", "OK");
            switch (pBackColor) {
                case 1:
                    this.gridPopupsInner.className = "cdeCenteredPopup cdePopupBackAlarm";
                    break;
                default:
                    this.gridPopupsInner.className = "cdeCenteredPopup cdePopupBackInfo";
                    break;
            }
            this.AddControl(pControl);
            this.gridPopups.classList.add("cde-animate-popup");
            this.gridPopups.style.display = 'block';
            this.gridPopups.style.height = this.gridPopupsInner.clientHeight + "px";
            //this.gridPopups.style.height = "0px";
            // Velocity(document.querySelectorAll("#gridPopups"), { height: this.gridPopupsInner.clientHeight + "px" }, [1000, 20] );
            //$('#gridPopups').animate({ height: cdeNMI.ThePopup.ActivePopup.gridPopupsInner.clientHeight + "px" }, 1000, "easeOutBounce");
            return this;
        }
        //Backwards Compat
        static Show(pMessageText, bShowOkOnly, pControl, pBackColor, sinkYes, sinkNo, pCookie, pParent) {
            if (cdeNMI.MyPopUp)
                return cdeNMI.MyPopUp.Show(pMessageText, bShowOkOnly, pControl, pBackColor, sinkYes, sinkNo, pCookie, pParent);
            return null;
        }
    }
    cdeNMI.ThePopup = ThePopup;
    /**
 * Creates a Toast Control CANNOT BE USED IN FORMS
 *
 * (4.1 Ready!) Static control - CANNOT be Lazy Created!
 */
    class TheToast extends cdeNMI.TheNMIBaseControl {
        /////***********************************************
        /////   Toast/Notification Functions
        /////***********************************************
        constructor(pTarget) {
            super(pTarget, null);
            this.mToastTopic = null;
            this.mToastText = null;
            this.mToastDebug = null;
            this.mToastGroup = null;
            this.mBaseCtrl = null;
            this.IsAlert = false;
            this.mRowElement = null;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.Toast;
            this.mBaseCtrl = cdeNMI.MyTCF.CreateBaseControl();
            this.mRowElement = document.getElementById("cdeMessageToast");
            if (!this.mRowElement) {
                this.mRowElement = document.createElement("div");
                this.mRowElement.className = "cdeBrowserBottom";
                this.mRowElement.id = "cdeMessageToast";
                this.mRowElement.style.display = "none";
                this.mRowElement.style.width = "inherit";
                const tBody = document.getElementsByTagName("body");
                if (tBody)
                    tBody[0].appendChild(this.mRowElement);
                else
                    document.appendChild(document.createElement("body")).appendChild(this.mRowElement);
            }
            this.mBaseCtrl.SetElement(this.mRowElement);
            this.mBaseCtrl.SetProperty("Z-Index", 5000);
            this.mBaseCtrl.GetElement().addEventListener("animationend", () => this.EndHide());
            this.SetElement(this.mBaseCtrl.GetElement());
            this.mToastGroup = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileGroup).Create(this);
            this.mToastGroup.SetProperty("ClassName", "cdeToast");
            this.mToastGroup.SetProperty("OnClick", () => {
                //$("#cdeMessageToast").stop()
                this.HideToast();
                this.IsAlert = false;
                this.mBaseCtrl.GetElement().style.display = 'none';
                this.SetProperty("Visibility", false);
            });
            this.mToastTopic = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SmartLabel).Create(this.mToastGroup, { PreInitBag: ["Element=div"], PostInitBag: ["ClassName=cdeTextCrop ToastTopic"] }); //  ctrlSmartLabel.Create(this.mToastGroup, null, null, "", "div", false, "cdeTextCrop ToastTopic");
            this.mToastText = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SmartLabel).Create(this.mToastGroup, { PreInitBag: ["Element=div"], PostInitBag: ["ClassName=cdeTextCrop ToastText"] }); // ctrlSmartLabel.Create(this.mToastGroup, null, null, "", "div", false, "cdeTextCrop ToastText");
            this.mToastDebug = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SmartLabel).Create(this.mToastGroup, { PreInitBag: ["Element=div"], PostInitBag: ["ClassName=cdeTextCrop ToastDebug"] }); // ctrlSmartLabel.Create(this.mToastGroup, null, null, "", "div", false, "cdeTextCrop ToastDebug");
            this.SetProperty("Visibility", false);
            if (cdeNMI.MyEngine)
                cdeNMI.MyEngine.RegisterEvent("NMI_TOAST", this.ShowToastMessage);
            return true;
        }
        SetProperty(pName, pValue) {
            if (!this.mToastGroup)
                return;
            if (pName !== "Visibility" && this.GetProperty("Visibility") !== true)
                return;
            super.SetProperty(pName, pValue);
            if (pName === "Text" || pName === "Value" || pName === "iValue")
                this.mToastTopic.SetProperty("Text", pValue);
            else if (pName === "LongText")
                this.mToastText.SetProperty("Value", pValue);
        }
        ShowHideToast() {
            if (!this.mToastGroup)
                return;
            if (this.mBaseCtrl.GetElement().style.display === 'none') {
                this.mBaseCtrl.GetElement().style.display = '';
                this.mBaseCtrl.GetElement().style.height = this.mToastGroup.GetElement().style.height;
                this.SetProperty("Visibility", true);
            }
            else {
                this.mBaseCtrl.GetElement().style.display = 'none';
                this.mBaseCtrl.GetElement().style.height = '0px';
                this.ClearDebug();
                this.SetProperty("Visibility", false);
            }
        }
        ShowToastMessage(pTopic, pText, pTime) {
            if (!this.mToastGroup)
                return;
            if (!this.IsAlert) {
                if (pTopic === "ALERT")
                    this.IsAlert = true;
                else
                    this.mToastTopic.SetProperty("Text", pTopic);
                if (pText)
                    this.mToastText.SetProperty("Text", pText);
                else
                    this.mToastText.SetProperty("Text", "");
                if (this.GetProperty("Visibility") !== true) {
                    this.SetProperty("Visibility", true);
                    this.mBaseCtrl.GetElement().classList.add("cde-animate-bottom");
                    this.mBaseCtrl.GetElement().style.display = '';
                    let tDura = 2000;
                    if (pTime && pTime > 500)
                        tDura = pTime;
                    setTimeout(() => {
                        this.HideToast();
                    }, tDura);
                    if (cde.MyBaseAssets.MyCommStatus.UserPref && cde.MyBaseAssets.MyCommStatus.UserPref.SpeakToasts)
                        cdeSpeech.talk(pTopic);
                }
            }
        }
        HideToast() {
            this.mBaseCtrl.GetElement().classList.remove("cde-animate-bottom");
            this.mBaseCtrl.GetElement().classList.add("cde-animate-fadeout");
        }
        EndHide() {
            if (this.mBaseCtrl.GetElement().classList.contains("cde-animate-bottom"))
                return;
            this.mBaseCtrl.GetElement().classList.remove("cde-animate-fadeout");
            this.mBaseCtrl.GetElement().style.display = 'none';
            this.SetProperty("Visibility", false);
            this.IsAlert = false;
        }
        ShowDebug(pText) {
            if (this.mToastDebug)
                this.mToastDebug.SetProperty("Value", pText);
        }
        ClearDebug() {
            if (this.mToastDebug)
                this.mToastDebug.SetProperty("Value", "");
        }
    }
    cdeNMI.TheToast = TheToast;
    class ctrlToolTip extends cdeNMI.TheNMIBaseControl {
        constructor(pTarget) {
            super(pTarget, null);
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.ToolTip;
            return true;
        }
        Hide() {
            //override if necessary
        }
        Show(pCtrlID, pToolTipText) {
            //override if necessary
        }
    }
    cdeNMI.ctrlToolTip = ctrlToolTip;
    class ctrlUserMenu extends cdeNMI.TheNMIBaseControl {
        constructor(pTarget) {
            super(pTarget, null);
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.UserMenu;
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            let tF = cde.CInt(this.GetSetting("TileFactorY"));
            let iS = "5x";
            if (tF === 0)
                tF = 1;
            else
                iS = "3x";
            this.mOuterGroup = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileGroup).Create(pTargetControl, { PreInitBag: ["ControlTW=2", "ControlTH=1", "TileFactorX=" + tF, "TileFactorY=" + tF] });
            if (cde.MyBaseAssets.MyServiceHostInfo.IsUserLoggedIn === true) {
                this.mAccountButton = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(this.mOuterGroup, { PreInitBag: ["ControlTW=1", "ControlTH=1", "TileFactorX=" + tF, "TileFactorY=" + tF], PostInitBag: ["Title=<span class='fa fa-" + iS + "'>&#xf2bd;</span>", "ClassName=MyHeaderButton"] });
                this.mAccountButton.SetProperty("OnClick", () => {
                    cdeNMI.MyScreenManager.TransitToScreen("E15AE1F2-69F3-42DC-97E8-B0CC2A8526A6", true);
                });
            }
            this.mLogoutButton = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(this.mOuterGroup, { PreInitBag: ["ControlTW=1", "ControlTH=1", "TileFactorX=" + tF, "TileFactorY=" + tF], PostInitBag: ["Title=<span class='fa fa-" + iS + "'>&#xf011;</span>", "ClassName=MyHeaderButton"] });
            this.mLogoutButton.SetProperty("OnClick", (pSender, evt) => {
                if (evt.button === 2 && cde.MyBaseAssets.MyServiceHostInfo.WasPortalRequested === true) {
                    cdeNMI.MyScreenManager.TransitToScreen(cde.MyBaseAssets.MyServiceHostInfo.PortalScreen);
                }
                else
                    cdeNMI.ResetBrowserToPortal();
            });
            this.SetElement(this.mOuterGroup.GetElement());
            return true;
        }
    }
    cdeNMI.ctrlUserMenu = ctrlUserMenu;
})(cdeNMI || (cdeNMI = {}));
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
var cdeNMI;
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
(function (cdeNMI) {
    /**
    * Creates a smart Label
    * SetProperty("Element") before InitControl to use any other element then <span> for the smart logo
    *
    * (4.1 Ready!)
    *
    * Requires "IsInTable" and "Element" in PreInitBag
    */
    class ctrlSmartLabel extends cdeNMI.TheNMIBaseControl {
        constructor(pTRF) {
            super(null, pTRF);
            this.MyLabelDiv = null;
            this.MyLabelTextDiv = null;
            this.MyEditControl = null;
            this.MyAnchor = null;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.SmartLabel;
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            if (this.MyFieldInfo) {
                this.SetProperty("Format", this.GetSetting("Format"));
                this.SetProperty("IsInTable", this.GetSetting("IsInTable"));
            }
            const HookEvents = false;
            if (this.MyFieldInfo) {
                if (this.GetSetting("Element"))
                    this.MyLabelDiv = document.createElement(this.GetSetting("Element"));
                else {
                    this.MyLabelDiv = document.createElement("div");
                    this.MyLabelDiv.style.width = "100%";
                }
            }
            else {
                if (this.GetSetting("Element"))
                    this.MyLabelDiv = document.createElement(this.GetSetting("Element"));
                else
                    this.MyLabelDiv = document.createElement("span");
            }
            const tS = this.GetSetting("ValueTitle");
            if (tS) {
                this.MyLabelTextDiv = document.createElement("div");
                this.MyLabelTextDiv.style.width = "100%";
                this.MyLabelTextDiv.innerHTML = tS;
                if (this.GetSetting("ValueTitleColor"))
                    this.MyLabelTextDiv.style.color = this.GetSetting("ValueTitleColor");
                if (this.GetSetting("ValueTitleSize"))
                    this.MyLabelTextDiv.style.fontSize = this.GetSetting("ValueTitleSize") + "px";
            }
            this.MyLabelDiv.innerHTML = "&nbsp;";
            this.SetElement(this.MyLabelDiv, HookEvents);
            if (this.MyLabelTextDiv)
                this.MyLabelDiv.parentElement.insertBefore(this.MyLabelTextDiv, this.MyLabelDiv);
            return true;
        }
        SetProperty(pName, pValue) {
            if (cde.CBool(super.GetProperty("IsInTable")) && (pName === "TileHeight" || pName === "TileWidth" || pName === "TileLeft" || pName === "TileTop"))
                return;
            super.SetProperty(pName, pValue);
            if (pName === "Value" || pName === "Text" || pName === "iValue") {
                if (pName === "Text")
                    pValue = cdeNMI.TL.T(pValue);
                pValue = cdeNMI.GenerateFinalString(pValue, this.GetProperty("Cookie"));
                if (this.MyLabelDiv) {
                    if (this.GetProperty("ThingFriendlyName"))
                        this.MyLabelDiv.innerHTML = this.GetProperty("ThingFriendlyName");
                    else {
                        if (cde.CBool(super.GetProperty("IsInTable")))
                            this.GetToolTip(this.MyLabelDiv, this.ShowFieldContent(!cde.IsNotSet(pValue) ? pValue.toString() : '', this.MyFieldInfo, this.MyScreenID));
                        else
                            this.MyLabelDiv.innerHTML = this.ShowFieldContent(!cde.IsNotSet(pValue) ? pValue.toString() : '', this.MyFieldInfo, this.MyScreenID);
                    }
                }
                if (this.MyEditControl)
                    this.MyEditControl.SetProperty(pName, pValue);
            }
            else if (pName === "Format") {
                if (this.MyLabelDiv) {
                    const tValue = super.GetProperty("Value");
                    if (cde.CBool(super.GetProperty("IsInTable")))
                        this.GetToolTip(this.MyLabelDiv, this.ShowFieldContent(!cde.IsNotSet(tValue) ? tValue.toString() : '', this.MyFieldInfo, this.MyScreenID));
                    else
                        this.MyLabelDiv.innerHTML = this.ShowFieldContent(!cde.IsNotSet(pValue) ? pValue.toString() : '', this.MyFieldInfo, this.MyScreenID);
                }
            }
            else if (pName === "UXID" && this.MyFieldInfo.Type === cdeNMI.cdeControlType.ThingPicker) {
                if (cdeNMI.MyEngine) {
                    cdeNMI.MyEngine.PublishToNMI('NMI_GET_DATA:THINGRESOLVE:' + this.GetProperty("ID") + ':' + this.GetProperty("UXID") + ';20:' + this.GetProperty("Value"), '', this.MyFieldInfo ? this.MyFieldInfo.cdeN : null); //fld Type instead of fldorder  + this.MyFieldInfo.FldOrder
                }
            }
            else if (pName === "ThingFriendlyName") {
                this.MyLabelDiv.innerHTML = pValue;
            }
            else if (pName === "ID") {
                if (this.MyLabelDiv)
                    this.MyLabelDiv.id = pValue;
            }
            else if (pName === "MainBackground" || pName === "MainClassName" || pName === "ContainerClassName") {
                if (this.MyTE)
                    this.MyTE.SetProperty(pName, pValue);
            }
            else if (pName === "Background") {
                if (this.MyTE)
                    this.MyTE.SetProperty("MainBackground", pValue);
                else {
                    if (this.MyLabelDiv)
                        this.MyLabelDiv.style.background = pValue;
                }
            }
            else if (pName === "Foreground") {
                if (this.MyLabelDiv)
                    this.MyLabelDiv.style.color = pValue;
            }
            else if (pName === "TileWidth") {
                if (this.MyLabelDiv) {
                    this.MyLabelDiv.style.width = cdeNMI.GetSizeFromTile(this.GetProperty("TileWidth")).toString() + "px";
                    if (cde.CBool(this.GetProperty("Truncate")))
                        this.MyLabelDiv.style.maxWidth = cdeNMI.GetSizeFromTile(this.GetProperty("TileWidth")).toString() + "px";
                }
            }
            else if (pName === "TileHeight") {
                if (this.MyLabelDiv)
                    this.MyLabelDiv.style.height = cdeNMI.GetSizeFromTile(this.GetProperty("TileHeight")).toString() + "px";
            }
            else if (pName === "Disabled") {
                if (this.MyEditControl)
                    this.MyEditControl.SetProperty(pName, pValue);
            }
            else if (pName === "Truncate" && cde.CBool(pValue) === true) {
                if (this.MyLabelDiv) {
                    this.MyLabelDiv.style.textOverflow = "ellipsis";
                    this.MyLabelDiv.style.overflow = "hidden";
                    this.MyLabelDiv.style.maxWidth = cdeNMI.GetSizeFromTile(this.GetProperty("TileWidth")).toString() + "px";
                }
            }
        }
        GetToolTip(pHTMLCtrl, pContent) {
            if (!cdeNMI.MyToolTip || !pContent || pContent.length === 0 || !cde.MyBaseAssets.MyCommStatus.UserPref || cde.MyBaseAssets.MyCommStatus.UserPref.ShowToolTipsInTable === false) {
                pHTMLCtrl.innerHTML = pContent;
                return;
            }
            if (pContent.length > cde.CInt(this.GetSetting("FldWidth")) * 7 && pContent.indexOf('-') < 0 && pContent.indexOf(' ') < 0) {
                pHTMLCtrl.innerHTML = "";
                if (!this.MyAnchor) {
                    const tAnchor = "a_" + this.GetProperty("ID");
                    this.MyAnchor = document.createElement("a");
                    this.MyAnchor.id = tAnchor;
                    this.MyAnchor.innerHTML = "<i class='fa'>&#xf103;</i>";
                    this.MyAnchor.addEventListener("mouseenter", () => {
                        if (cdeNMI.MyToolTip)
                            cdeNMI.MyToolTip.Show(tAnchor, this.GetProperty("ToolTip") ? this.GetProperty("ToolTip") : (this.GetProperty("Text") ? this.GetProperty("Text") : this.GetProperty("Value")));
                    }, false);
                }
                pHTMLCtrl.appendChild(this.MyAnchor);
                pHTMLCtrl.insertAdjacentHTML('beforeend', pContent);
            }
            else {
                pHTMLCtrl.innerHTML = pContent;
            }
        }
        sinkValueChanged(pCtrl, pValue) {
            // bug fix #1263: ThingFiendlyName property of this control was updated only once on initialization.
            if (pCtrl.MyBaseType === cdeNMI.cdeControlType.ThingPicker) {
                this.SetProperty("ThingFriendlyName", pCtrl.GetProperty("ThingFriendlyName")); // bug #1263: let's keep it updated,
            }
            this.restoreValue(pCtrl, pValue);
            this.SetProperty("Value", pValue);
        }
        restoreValue(pCtrl, pValue) {
            cdeNMI.ResetKeyCorder();
            if (cdeNMI.MyTouchOverlay) {
                cdeNMI.MyTouchOverlay.UnregisterEvent("Touched", null);
                this.DeleteControl(cdeNMI.MyTouchOverlay);
                cdeNMI.MyTouchOverlay = null;
            }
            if (this.MyEditControl) {
                this.DeleteControl(this.MyEditControl);
                this.MyEditControl = null;
            }
            this.SetProperty("IsUnhooked", false);
            const pStr = pCtrl.ShowFieldContent(pValue, this.MyFieldInfo);
            try {
                if (cde.CBool(super.GetProperty("IsInTable")))
                    this.GetToolTip(this.MyLabelDiv, pStr);
                else
                    this.MyLabelDiv.innerHTML = pStr;
            }
            catch (_a) {
                //ignored
            }
        }
        EditControl(evt, pPointer, pCtrl) {
            if (this.MyFieldInfo.Type === cdeNMI.cdeControlType.SingleCheck) {
                if (cde.CBool(this.GetSetting("IsReadOnly")) || this.IsDisabled)
                    return;
                if (pPointer.IsOnObject) {
                    cdeNMI.StopPointerEvents(evt);
                    if (!cdeNMI.MyTouchOverlay) {
                        this.MyLabelDiv.innerHTML = "";
                        cdeNMI.MyTouchOverlay = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TouchOverlay).Create(this);
                        cdeNMI.MyTouchOverlay.RegisterEvent("Touched", () => this.restoreValue(this, cde.CStr(this.GetProperty("Value"))));
                        this.MyEditControl = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SingleCheck).Create(this, { ScreenID: this.MyScreenID, TRF: this.MyTRF });
                        cdeNMI.MyTouchOverlay.CurrentControl = this;
                        this.MyEditControl.SetProperty("UpdateTable", true);
                        this.MyEditControl.SetProperty("OnValueChanged", (pCtrl, evt, pVal) => this.sinkValueChanged(pCtrl, pVal));
                    }
                }
            }
            else {
                if ((this.MyFieldInfo.Flags & 2) !== 0 && this.MyFieldInfo.Type !== cdeNMI.cdeControlType.SmartLabel) {
                    if (this.GetSetting("IsReadOnly") === true || this.IsDisabled || (cde.CBool(this.GetSetting("WriteOnce")) === true && cde.CStr(this.GetProperty("Value"))))
                        return;
                    if (!cdeNMI.MyTouchOverlay) {
                        cdeNMI.StopPointerEvents(evt);
                        if (this.MyFieldInfo.Type === cdeNMI.cdeControlType.TileButton) {
                            this.FireEvent(false, "OnClick");
                            return;
                        }
                        this.SetProperty("IsUnhooked", true);
                        this.MyLabelDiv.innerHTML = "";
                        cdeNMI.MyTouchOverlay = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TouchOverlay).Create(this);
                        cdeNMI.MyTouchOverlay.RegisterEvent("Touched", () => this.restoreValue(this, cde.CStr(this.GetProperty("Value"))));
                        cdeNMI.MyTouchOverlay.SetProperty("PreventDefault", true);
                        const tE = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileEntry);
                        this.MyTRF.FldInfo["IsInTable"] = this.GetSetting("IsInTable");
                        tE.MyDataView = this.MyDataView;
                        tE.InitControl(this, this.MyTRF, null, this.MyScreenID);
                        tE.SetProperty("Z-Index", 1300);
                        tE.SetProperty("NoTE", true);
                        switch (this.MyTRF.FldInfo.Type) {
                            case cdeNMI.cdeControlType.CheckField:
                                tE.SetProperty("TileWidth", this.MyTRF.FldInfo["Bits"]);
                                break;
                            case cdeNMI.cdeControlType.ComboOption:
                                tE.SetProperty("TileWidth", cde.CInt(this.MyTRF.FldInfo["FldWidth"]) - 1);
                                break;
                            default:
                                tE.SetProperty("TileWidth", this.MyTRF.FldInfo["FldWidth"]);
                                break;
                        }
                        tE.CreateControl("inTableClick", (pNewControl) => {
                            pNewControl.SetProperty("UXID", pNewControl.MyFieldInfo.cdeMID);
                            pNewControl.SetProperty("Z-Index", 1300);
                            pNewControl.SetProperty("OnValueChanged", (pCtrl, evtName, pVal) => {
                                if (!cdeNMI.MyTouchOverlay)
                                    return;
                                this.SetProperty("LiveOptions", pCtrl.GetProperty("LiveOptions"));
                                if (this.MyNMIControl) {
                                    this.MyNMIControl.SetProperty("Value", pVal);
                                }
                                this.sinkValueChanged(pCtrl, pVal);
                            });
                            ;
                        });
                        this.MyEditControl = tE;
                    }
                }
            }
        }
        //Backwards Compat
        static Create(pTargetControl, pScreenID, pTRF, pLabelText, pHElement, pIsReadOnly, pClass, pCookie, pParent, pIsInTable) {
            const t = new ctrlSmartLabel(pTRF);
            if (pHElement)
                t.SetProperty("Element", pHElement);
            t.SetProperty("IsInTable", cde.CBool(pIsInTable));
            t.InitControl(pTargetControl, pTRF, null, pScreenID);
            if (cde.CBool(pIsReadOnly))
                t.SetProperty("IsReadOnly", pIsReadOnly);
            if (pParent)
                t.SetProperty("Parent", pParent);
            if (pCookie)
                t.SetProperty("Cookie", pCookie);
            if (pLabelText)
                t.SetProperty("iValue", pLabelText);
            if (pClass)
                t.SetProperty("ClassName", pClass);
            return t;
        }
    }
    cdeNMI.ctrlSmartLabel = ctrlSmartLabel;
})(cdeNMI || (cdeNMI = {}));
// SPDX-FileCopyrightText: 2009-2023 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
var cdeNMI;
// SPDX-FileCopyrightText: 2009-2023 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
(function (cdeNMI) {
    /**
* Creates a Tiled Button
*
* (4.1 Ready!)
*/
    class ctrlTileButton extends cdeNMI.TheNMIBaseControl {
        constructor(pTRF) {
            super(null, pTRF);
            this.s2 = null;
            this.divTitle = null;
            this.divOuter = null;
            this.divInner = null;
            this.divControl = null;
            this.IsDIV = false;
            this.mFormat = null;
            this.IsTesla = false;
            this.IsCustomTile = false;
            this.mHoverAdd = "cdeButtonHover2";
        }
        static Create(pTarget, pOnClick, pTitle, pTileX, pTileY, pClass, pStyleInsert, pCookie, pParent, pAllowMT) {
            const tTile = new ctrlTileButton();
            if (pTileX)
                tTile.SetProperty("ControlTW", pTileX);
            if (pTileY)
                tTile.SetProperty("ControlTH", pTileY);
            tTile.InitControl(pTarget);
            if (pTitle) {
                tTile.SetProperty("Title", pTitle);
            }
            if (pCookie)
                tTile.SetProperty("Cookie", pCookie);
            if (pParent)
                tTile.SetProperty("Parent", pParent);
            if (pClass)
                tTile.SetProperty("ClassName", pClass);
            if (pStyleInsert)
                tTile.SetProperty("Style", pStyleInsert);
            if (pOnClick)
                tTile.SetProperty("OnClick", pOnClick);
            if (pAllowMT)
                tTile.SetProperty("PreventDefault", pAllowMT);
            return tTile;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.TileButton;
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            this.IsTesla = (cde.MyBaseAssets.MyServiceHostInfo.WebPlatform === 5);
            if (this.IsTesla)
                this.mHoverAdd = "cdeTesButton";
            if (cde.MyBaseAssets.MyServiceHostInfo.WebPlatform === 1)
                this.mHoverAdd = null;
            if (cde.CBool(this.GetSetting("IsCustomTile")) === true) {
                this.IsCustomTile = true;
                this.s2 = document.createElement('div');
                this.SetElement(this.s2, false);
                this.MyContainerElement = this.s2;
                this.SetInitialSize();
            }
            else {
                this.s2 = document.createElement('button');
                this.s2.type = "button";
                this.SetProperty("ButtonStyle", 0); //custom
                this.SetTileStyle();
                this.RegisterEvent("PointerDown", (pTarget, pEvent, pPointer) => this.eventTileDown(pTarget, pEvent, pPointer));
                this.RegisterEvent("PointerUp", (pTarget, pEvent, pPointer) => this.eventTileExit(pTarget, pEvent, pPointer));
                this.SetElement(this.s2, false);
                this.SetProperty("Disabled", (this.MyFieldInfo && (typeof this.MyFieldInfo.Flags !== "undefined") && (this.MyFieldInfo.Flags & 2) === 0)); //Must allow Click if MyFieldInfo is not set
                this.CreateTileButtonContent();
                this.MyContainerElement = this.divInner;
            }
            return true;
        }
        SetProperty(pName, pValue) {
            if (pName === "TileWidth")
                pName = "ControlTW";
            if (pName === "TileHeight")
                pName = "ControlTH";
            super.SetProperty(pName, pValue);
            if (pName === "HTML") {
                cdeNMI.cdeParseHTML(this, this.MyTRF, pValue);
            }
            else if (pName === "StaticHTMLUrl") {
                if (cdeNMI.MyEngine) {
                    cdeNMI.MyEngine.cdeGetResource(pValue, (cookie, data) => {
                        if (data && !data.startsWith("ERR:")) {
                            while (true) {
                                const tSeg = cdeNMI.ReturnStringSegment(data, "<%P:", "%>");
                                if (tSeg === null)
                                    break;
                                const tTCB = new cdeNMI.TheControlBlock();
                                tTCB.TargetID = "CNMIC" + (cdeNMI.MyNMISettings.IDCounter++);
                                this.SetProperty(tSeg.Inner + "_TCB", tTCB);
                                let tP = this.GetProperty(tSeg.Inner);
                                if (!tP)
                                    tP = "";
                                data = data.replace(tSeg.Outer, "<span ID=" + tTCB.TargetID + ">" + tP + "</span>");
                            }
                            this.GetContainerElement().innerHTML = cdeNMI.GenerateFinalString(data, false, this.MyTRF);
                        }
                    });
                }
            }
            else if (pName === "HTMLUrl") {
                if (cdeNMI.MyEngine) {
                    cdeNMI.MyEngine.cdeGetResource(pValue, (cookie, data) => {
                        if (data && !data.startsWith("ERR:"))
                            cdeNMI.cdeParseHTML(this, this.MyTRF, data);
                    });
                }
            }
            else if (pName === "Background") {
                if (this.s2)
                    this.s2.style.backgroundColor = pValue;
            }
            else if (pName === "BackgroundImage") {
                if (this.s2)
                    this.s2.style.backgroundImage = pValue;
            }
            else if (pName === "Foreground") {
                if (this.divTitle)
                    this.divTitle.style.color = pValue;
            }
            else if (pName === "IsHitTestDisabled" && this.divOuter) {
                if (cde.CBool(pValue))
                    this.divOuter.style.pointerEvents = 'none';
                else
                    this.divOuter.style.pointerEvents = '';
            }
            else if (pName === "FontSize") {
                if (this.divTitle)
                    this.divTitle.style.fontSize = pValue + "px";
            }
            else if (pName === "TabIndex") {
                if (this.s2) {
                    pValue = cde.CInt(pValue);
                    this.s2.tabIndex = cde.CInt(pValue);
                }
            }
            else if (pName === "Format") {
                let UpdateTitle = false;
                if (!this.mFormat)
                    UpdateTitle = true;
                this.mFormat = pValue;
                if (UpdateTitle) {
                    this.SetProperty("RTitle", this.divTitle.innerHTML);
                    this.SetTileTitle("Text", this.divTitle.innerHTML);
                }
            }
            else if ((pName === "Title" || pName === "Caption" || pName === "Text" || pName === "Value" || pName === "iValue") && pValue) {
                this.SetProperty("RTitle", pValue);
                this.SetTileTitle(pName, pValue);
            }
            else if (pName === "OnPointerDown" && this.s2) {
                if (pValue) {
                    this.PreventManipulation = true;
                    this.HookEvents(false);
                    this.RegisterEvent("PointerDown", pValue);
                }
            }
            else if (pName === "OnClick" && this.s2) {
                if (pValue) {
                    this.PreventManipulation = true;
                    this.HookEvents(false);
                    this.SetHoverStyle(cde.CBool(this.GetProperty("Disabled")));
                    this.RegisterEvent("FireOnClick", this.FireClick);
                    this.RegisterEvent("OnClick", pValue);
                    this.s2.onkeyup = (evt) => {
                        if (evt.keyCode === 13 || evt.keyCode === 32) {
                            this.WasClicked = false;
                            this.FireClick(this, evt);
                        }
                        else if (evt.keyCode === 36 && cdeNMI.MyScreenManager) {
                            cdeNMI.MyScreenManager.GotoStationHome(false);
                        }
                    };
                }
            }
            else if (pName === "OnTileDown") {
                this.RegisterEvent("OnTileDown", pValue);
                if (pValue) {
                    this.PreventManipulation = true;
                    this.HookEvents(false);
                }
            }
            else if (pName === "EnableTap") {
                this.PreventManipulation = true;
                this.HookEvents(false);
                this.SetHoverStyle(cde.CBool(this.GetProperty("Disabled")), true);
            }
            else if ((pName === "Disabled" || pName === "DisableClick") && this.s2) {
                this.SetHoverStyle(cde.CBool(pValue));
                if (!this.IsDIV && !this.IsCustomTile) {
                    try {
                        this.s2.disabled = cde.CBool(pValue);
                        if (cde.CBool(pValue))
                            this.s2.style.outlineStyle = "none";
                    }
                    catch (_a) { }
                }
                if (pName === "Disabled") {
                    if (this.MyNMIControl)
                        this.MyNMIControl.SetProperty(pName, pValue);
                }
            }
            else if (this.MyNMIControl && pName.substring(0, 1) === ".") {
                if (this.MyNMIControl)
                    this.MyNMIControl.SetProperty(pName.substring(1), pValue);
            }
            else if (pName === "ControlTW" || pName === "TileFactorX" || pName === "ControlTH" || pName === "TileFactorY") {
                this.SetTileStyle();
                this.SetSizes();
            }
            else if ((pName === "ClassName")) {
                if ((cde.MyBaseAssets.MyServiceHostInfo.WebPlatform === 1) && pValue) {
                    let tHovClass = this.GetProperty("HoverClassName");
                    if (!tHovClass)
                        tHovClass = "cdeButtonHover2";
                    if (tHovClass && this.s2.classList.contains(tHovClass))
                        this.s2.classList.remove(tHovClass);
                }
                this.SetSizes();
            }
            else if (pName === "InnerControl" && pValue) {
                this.SetInnerControl(pValue);
            }
            else if (pName === "SubTitle" && pValue) {
                this.SetTileTitle("Title", this.GetProperty("RTitle"));
            }
            else if (pName.toLowerCase() === "thumbnail") {
                const tParts = pValue.split(';');
                if (tParts[0].startsWith("FA")) {
                    this.SetTileTitle("Title", this.GetProperty("RTitle"));
                }
                else {
                    const tInsideCtrl = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.Picture).Create(null, { PostInitBag: ["iValue=" + tParts[0], "FullWidth=-1", "FullHeight=-1"] });
                    if (tParts.length > 1) {
                        tInsideCtrl.SetProperty("Opacity", tParts[1]);
                        if (tParts.length > 2)
                            tInsideCtrl.SetProperty("ClassName", tParts[2]);
                    }
                    else
                        tInsideCtrl.SetProperty("Opacity", 0.2);
                    this.SetInnerControl(tInsideCtrl);
                }
            }
        }
        SetHoverStyle(bIsDisabled, bAddForce) {
            if (!this.s2 || !this.mHoverAdd)
                return;
            if (bIsDisabled) {
                if (this.s2.classList.contains(this.mHoverAdd))
                    this.s2.classList.remove(this.mHoverAdd);
                this.SetProperty("TabIndex", -1);
            }
            else {
                if (super.GetProperty("OnClick") || bAddForce === true) {
                    if (!this.s2.classList.contains(this.mHoverAdd))
                        this.s2.classList.add(this.mHoverAdd);
                }
                else {
                    if (this.s2.classList.contains(this.mHoverAdd))
                        this.s2.classList.remove(this.mHoverAdd);
                }
            }
        }
        SetTileStyle() {
            const pTileX = cde.CInt(this.GetProperty("ControlTW"));
            const pTileY = cde.CInt(this.GetProperty("ControlTH"));
            if (pTileX < 2) {
                if (!this.GetProperty("ClassName") && this.s2)
                    this.s2.className = "cdeLiveTileSmall";
                this.SetProperty("ButtonStyle", 1); //small
            }
            else {
                if (pTileY < pTileX) {
                    if (pTileX > 6) {
                        if (!this.GetProperty("ClassName") && this.s2)
                            this.s2.className = "cdeLiveTileVeryLong";
                        this.SetProperty("ButtonStyle", 4); //Normal
                    }
                    else {
                        if (!this.GetProperty("ClassName") && this.s2)
                            this.s2.className = "cdeLiveTileLong";
                        this.SetProperty("ButtonStyle", 3); //Normal
                    }
                }
                else {
                    if (!this.GetProperty("ClassName") && this.s2)
                        this.s2.className = "cdeLiveTile";
                    this.SetProperty("ButtonStyle", 2); //Normal
                }
            }
            this.SetHoverStyle(cde.CBool(this.GetProperty("Disabled")));
        }
        SetTileTitle(pName, pValue) {
            if (this.mFormat)
                pValue = this.mFormat.format(pValue);
            if (!this.MyNMIControl || this.MyNMIControl.MyBaseType === cdeNMI.cdeControlType.Picture || pName === "Title" || pName === "Text") {
                const tS = this.GetProperty("Thumbnail");
                if (this.divTitle && (pValue || tS)) {
                    if (pValue)
                        pValue = cdeNMI.IconShim(pValue);
                    if (tS && tS.startsWith("FA")) {
                        pValue = "<i class='fa" + (tS.substr(3, 1) === "B" ? "b" : "") + " faIcon " + (tS.substr(3, 1) === "S" ? "fa-spin " : "") + "fa-" + tS.substr(2, 1) + "x'>&#x" + tS.substr(4, tS.length - 4) + ";</i></br>" + (pValue ? pValue : "");
                    }
                    const tSubT = this.GetProperty("SubTitle");
                    if (tSubT)
                        pValue += "</br><span style='font-size:10px'>" + tSubT + "</span>";
                    this.divTitle.innerHTML = ((pName === "Text" || pName === "Title") ? cdeNMI.TL.T(pValue) : cdeNMI.IconFAShim(pValue));
                    this.divInner.style.display = '';
                }
            }
            else {
                if (cde.CInt(this.MyNMIControl.MyBaseType) !== cde.CInt(cdeNMI.cdeControlType.Picture)) ///BUG IN TS 2.1: should works 
                    this.MyNMIControl.SetProperty(pName, pValue);
            }
        }
        CreateTileButtonContent() {
            if (!this.s2)
                return;
            this.s2.innerHTML = "";
            this.SetTileStyle();
            this.divOuter = document.createElement("div");
            this.divOuter.style.overflow = "hidden";
            this.divOuter.style.pointerEvents = "none";
            this.divOuter.style.position = "relative";
            this.divInner = document.createElement("div");
            this.divTitle = document.createElement("div");
            if (this.GetProperty("Value"))
                this.divTitle.innerHTML = this.GetProperty("Value");
            else if (this.GetProperty("Title"))
                this.divTitle.innerHTML = this.GetProperty("Title");
            this.divInner.appendChild(this.divTitle);
            this.divOuter.appendChild(this.divInner);
            this.SetSizes();
            this.s2.appendChild(this.divOuter);
        }
        SetSizes() {
            this.SetInitialSize();
            if (!this.divOuter)
                return;
            this.divOuter.style.width = "inherit";
            this.divOuter.style.height = "inherit";
            this.divInner.style.width = "inherit";
            this.divInner.style.zIndex = "10";
            this.divOuter.className = "cdeFlexRow cdeFlexCenter";
            this.divInner.className = "cdeFlexO0";
            if (this.GetProperty("ClassName"))
                this.s2.className = this.GetProperty("ClassName");
            if (this.divTitle) {
                if (this.GetProperty("ClassName")) {
                    const tCls = this.GetProperty("ClassName").split(' ');
                    let tFinCls = "";
                    for (const element of tCls) {
                        tFinCls += element + "inner ";
                    }
                    this.divTitle.className = tFinCls;
                }
                else {
                    if (this.GetProperty("ButtonStyle") === "2") {
                        this.SetButtonStyle2();
                    }
                    else {
                        if (this.GetProperty("ButtonStyle") === "1")
                            this.divTitle.className = "cdeTileTextSmall";
                        else
                            this.divTitle.className = "cdeTileTextNoImg";
                    }
                }
            }
            this.SetHoverStyle(cde.CBool(this.GetProperty("Disabled")));
        }
        SetButtonStyle2() {
            this.divTitle.className = "cdeTileText";
            this.divInner.className = "cdeFlexO2";
            this.divOuter.className = "cdeFlexRow cdeFlexCenter cdeFlexStart";
        }
        SetInnerControl(pControl) {
            if (this.divTitle && pControl) {
                this.MyNMIControl = pControl;
                this.divControl = document.createElement("div");
                this.divControl.className = "cdeFlexRow cdeFlexCenter";
                this.divControl.style.width = "inherit";
                this.divControl.style.position = "absolute";
                this.divControl.style.left = "0";
                this.divControl.style.top = "0";
                if (this.divTitle.innerHTML !== "") {
                    this.divInner.style.alignSelf = "flex-end";
                    this.divInner.style.marginBottom = "5px";
                }
                this.divControl.appendChild(this.MyNMIControl.GetElement());
                this.divOuter.appendChild(this.divControl);
            }
        }
        ///EVENTS /////
        eventHoverIn(eventObject) {
            this.ShowHoverIn(eventObject.target);
        }
        ShowHoverIn(eventObject) {
            if (!(eventObject instanceof HTMLButtonElement))
                return;
            let tHovClass = this.GetProperty("HoverClassName");
            if (!tHovClass)
                tHovClass = this.mHoverAdd;
            if (tHovClass)
                eventObject.classList.add(tHovClass);
        }
        eventHoverOut(eventObject) {
            this.ShowHoverOut(eventObject.target);
        }
        ShowHoverOut(eventObject) {
            if (!(eventObject instanceof HTMLButtonElement))
                return;
            let tHovClass = this.GetProperty("HoverClassName");
            if (!tHovClass)
                tHovClass = this.mHoverAdd;
            if (tHovClass && eventObject.classList.contains(tHovClass))
                eventObject.classList.remove(tHovClass);
        }
        eventTileDown(pTarget, pEvent, pPointer) {
            if (!this.GetProperty("Disabled")) {
                if (pPointer.IsOnObject || cde.CBool(this.GetProperty("IgnoreHitTarget"))) {
                    this.WasClicked = false;
                    this.SetProperty("IsDown", true);
                    this.ShowHoverIn(this.s2);
                    this.FireEvent(true, "OnTileDown", pEvent, pPointer);
                }
            }
        }
        eventTileExit(pTarget, pEvent, pPointer) {
            if (!this.GetProperty("Disabled")) {
                this.SetProperty("IsDown", false);
                this.ShowHoverOut(this.s2);
                if ((pPointer.IsOnObject || cde.CBool(this.GetProperty("IgnoreHitTarget"))) && pPointer.PathLength() < cdeNMI.MyNMISettings.DeadPathLength) {
                    this.FireClick(this, pEvent);
                }
            }
        }
        FireClick(pSender, pEvent) {
            if (this.HasEvent("OnClick") && !this.WasClicked) {
                if (this.GetProperty("AreYouSure")) {
                    if (cdeNMI.MyPopUp)
                        cdeNMI.MyPopUp.Show(this.GetProperty("AreYouSure"), false, null, 1, () => {
                            if (pEvent)
                                pEvent.AYSFired = true;
                            this.DoFireClick(this, pEvent);
                        });
                }
                else
                    this.DoFireClick(this, pEvent);
            }
        }
        OnNUITag(pTag, pCookie) {
            this.WasClicked = false;
            this.FireClick(null);
        }
    }
    cdeNMI.ctrlTileButton = ctrlTileButton;
    class ctrlLogoButton extends ctrlTileButton {
        constructor(pTRF) {
            super(pTRF);
            this.MyLogoParts = Array();
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.LogoButton;
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            this.tLogoGroup = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileGroup).Create(null);
            this.tLogoGroup.SetProperty("IsDivOnly", true);
            let tF = cde.CInt(this.GetSetting("TileFactorY"));
            if (tF < 1)
                tF = 1;
            let tS = cde.CInt(this.GetSetting("TileHeight"));
            if (tS < 1)
                tS = 1;
            this.tLogoGroup.SetProperty("Style", "font-size:" + (cdeNMI.GetSizeFromTile(tS) / tF) + "px");
            this.MyLogoParts[0] = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SmartLabel).Create(this.tLogoGroup, { PreInitBag: ["Element=span"], PostInitBag: ["ClassName=cl cl-B cdeButtonHover2"] });
            this.MyLogoParts[0].SetProperty("Foreground", "#1DA3D1");
            this.MyLogoParts[1] = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SmartLabel).Create(this.tLogoGroup, { PreInitBag: ["Element=span"], PostInitBag: ["ClassName=cl cl-C cdeButtonHover2"] });
            this.MyLogoParts[1].SetProperty("Foreground", "#1DA3D1");
            this.MyLogoParts[2] = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SmartLabel).Create(this.tLogoGroup, { PreInitBag: ["Element=span"], PostInitBag: ["ClassName=cl cl-D cdeButtonHover2"] });
            this.MyLogoParts[2].SetProperty("Foreground", "#1DA3D1");
            this.MyLogoParts[3] = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SmartLabel).Create(this.tLogoGroup, { PreInitBag: ["Element=span"], PostInitBag: ["ClassName=cl cl-E cdeButtonHover2"] });
            this.MyLogoParts[3].SetProperty("Foreground", "#CCCCCC");
            this.MyLogoParts[4] = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SmartLabel).Create(this.tLogoGroup, { PreInitBag: ["Element=span"], PostInitBag: ["ClassName=cl cl-F cdeButtonHover2"] });
            this.MyLogoParts[4].SetProperty("Foreground", "#52D0EB");
            this.MyLogoParts[5] = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SmartLabel).Create(this.tLogoGroup, { PreInitBag: ["Element=span"], PostInitBag: ["ClassName=cl cl-G cdeButtonHover2"] });
            this.MyLogoParts[5].SetProperty("Foreground", "#CCCCCC");
            this.MyLogoParts[6] = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SmartLabel).Create(this.tLogoGroup, { PreInitBag: ["Element=span"], PostInitBag: ["ClassName=cl cl-H cdeButtonHover2"] });
            this.MyLogoParts[6].SetProperty("Foreground", "#52D0EB");
            this.MyLogoParts[7] = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SmartLabel).Create(this.tLogoGroup, { PreInitBag: ["Element=span"], PostInitBag: ["ClassName=cl cl-I cdeButtonHover2"] });
            this.MyLogoParts[7].SetProperty("Foreground", "#52D0EB");
            this.MyLogoParts[8] = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SmartLabel).Create(this.tLogoGroup, { PreInitBag: ["Element=span"], PostInitBag: ["ClassName=cl cl-J cdeButtonHover2"] });
            this.MyLogoParts[8].SetProperty("Foreground", "#CCCCCC");
            this.MyLogoParts[9] = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SmartLabel).Create(this.tLogoGroup, { PreInitBag: ["Element=span"], PostInitBag: ["ClassName=cl cl-K cdeButtonHover2"] });
            this.MyLogoParts[9].SetProperty("Foreground", "#1DA3D1");
            this.SetProperty("InnerControl", this.tLogoGroup);
            return true;
        }
        SetProperty(pName, pValue) {
            if (pName === "Value" || pName === "iValue") {
                //Dont set any value!!
                return;
            }
            else if (pName === "FontSize") {
                this.tLogoGroup.SetProperty("Style", "font-size:" + cde.CInt(pValue) + "px");
            }
            else if (pName === "Relay") {
                this.MyLogoParts[9].SetProperty("Foreground", this.GetState(cde.CInt(pValue)));
            }
            else if (pName === "LogoState") {
                for (let i = 0; i < 10; i++)
                    this.MyLogoParts[i].SetProperty("Foreground", this.GetState(cde.CInt(pValue)));
            }
            else if (pName === "LogoColor") {
                for (let i = 0; i < 10; i++)
                    this.MyLogoParts[i].SetProperty("Foreground", pValue);
            }
            else if (pName === "Reset") {
                this.MyLogoParts[0].SetProperty("Foreground", "#1DA3D1");
                this.MyLogoParts[1].SetProperty("Foreground", "#1DA3D1");
                this.MyLogoParts[2].SetProperty("Foreground", "#1DA3D1");
                this.MyLogoParts[3].SetProperty("Foreground", "#CCCCCC");
                this.MyLogoParts[4].SetProperty("Foreground", "#52D0EB");
                this.MyLogoParts[5].SetProperty("Foreground", "#CCCCCC");
                this.MyLogoParts[6].SetProperty("Foreground", "#52D0EB");
                this.MyLogoParts[7].SetProperty("Foreground", "#52D0EB");
                this.MyLogoParts[8].SetProperty("Foreground", "#CCCCCC");
                this.MyLogoParts[9].SetProperty("Foreground", "#1DA3D1");
            }
            super.SetProperty(pName, pValue);
        }
        ///"gray;green;yellow;red;blue;brown;purple;black";
        GetState(pStatusLevel) {
            switch (pStatusLevel) {
                case 1: return "green";
                case 2: return "yellow";
                case 3: return "red";
                case 4: return "blue";
                case 5: return "brown";
                case 6: return "purple";
                case 7: return "black";
            }
            return "#ccc";
        }
    }
    cdeNMI.ctrlLogoButton = ctrlLogoButton;
})(cdeNMI || (cdeNMI = {}));
// SPDX-FileCopyrightText: 2009-2023 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
var cdeNMI;
// SPDX-FileCopyrightText: 2009-2023 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
(function (cdeNMI) {
    /**
* Creates a Tile Entry used in Forms
*
* (3.2 Ready!)
*/
    class ctrlTileEntry extends cdeNMI.TheNMIBaseControl {
        constructor(pTRF) {
            super(null, pTRF);
            this.MyControlTypeName = null;
            this.MyTEContainer = null;
            this.MyTEContent = null;
            this.mOldClassName = null;
            this.MyTELabel = null;
            this.mTEContentOuter = null;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.TileEntry;
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            this.MyTEContainer = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileGroup).Create(pTargetControl, { ScreenID: pScreenID });
            this.MyTEContainer.SetProperty("ClassName", "cdeFlexRow cdeFlexCenter cdeTileContainer");
            if (pTRF && pTRF.FldInfo) {
                this.MyTEContainer.GetElement().setAttribute("cdefo", cde.CStr(pTRF.FldInfo.FldOrder));
                this.MyTEContainer.GetElement().setAttribute("cdemid", cde.GuidToString(pTRF.FldInfo.cdeMID));
                if (cde.CBool(this.GetSetting("DisallowEdit")) === false)
                    this.MyTEContainer.GetElement().setAttribute("cdesel", "true");
            }
            this.MyTELabel = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileGroup).Create(this.MyTEContainer, { ScreenID: pScreenID });
            this.MyTELabel.SetProperty("LabelElement", "span");
            this.MyTELabel.SetProperty("LabelClassName", "cdeTileEntryLabel");
            this.MyTELabel.SetProperty("ClassName", "cdeFlexLabel");
            this.mTEContentOuter = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileGroup).Create(this.MyTEContainer, { ScreenID: pScreenID });
            this.mTEContentOuter.SetProperty("ClassName", "cdeFlexRow cdeFlexCenter cdeFlexStart cdeControlContainer");
            this.MyTEContent = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileGroup).Create(this.mTEContentOuter, { ScreenID: pScreenID });
            this.MyTEContent.SetProperty("ClassName", "cdeTileEntryText");
            this.SetElement(this.MyTEContainer.GetElement(), false, this.MyTEContent.GetElement(), true);
            if (pTRF.FldInfo["RenderTarget"]) {
                this.SetProperty("Visibility", false);
            }
            if (cde.CInt(this.GetSetting("PixelWidth")) == 0) {
                let tTileWidth = cde.CInt(this.GetSetting("TileWidth"));
                if (tTileWidth <= 0) {
                    if (cde.CBool(this.GetSetting("InheritWidth"))) {
                        if (pTargetControl.GetProperty("ControlTW"))
                            tTileWidth = pTargetControl.GetProperty("ControlTW");
                        else
                            tTileWidth = Math.round(pTargetControl.GetElement().clientWidth / cdeNMI.GetSizeFromTile(1));
                    }
                    else {
                        if (tTileWidth === 0)
                            tTileWidth = 6;
                    }
                }
                //if (cde.CInt(this.GetSetting("TileWidth")) >= 0)
                this.SetProperty("TileWidth", tTileWidth);
            }
            if (cde.CInt(this.GetSetting("PixelHeight")) == 0) {
                let tTileHeight = 1;
                if (cde.CInt(this.GetSetting("TileHeight")) > 0)
                    tTileHeight = this.GetSetting("TileHeight");
                if (cde.CInt(this.GetSetting("TileHeight")) >= 0)
                    this.SetProperty("TileHeight", tTileHeight);
            }
            this.MyControlTypeName = pTRF.FldInfo["ControlType"];
            if (this.MyControlTypeName) {
                const tN = cdeNMI.MyTCF.GetControlByName(this.MyControlTypeName);
                if (tN) {
                    const tNA = tN.split(':');
                    this.MyControlTypeName = tNA[0];
                    if (tNA.length > 1)
                        this.MyEngineName = tNA[1];
                }
            }
            if (cde.CInt(this.MyControlTypeName) > 0) {
                this.MyControlTypeName = cdeNMI.MyTCF.GetControlType(pTRF.FldInfo.Type);
            }
            if (!this.MyEngineName)
                this.MyEngineName = pTRF.FldInfo["EngineName"];
            if (pTRF.FldInfo.Type !== cdeNMI.cdeControlType.UserControl) {
                this.MyEngineName = cdeNMI.eTheNMIEngine;
                this.MyControlTypeName = cdeNMI.MyTCF.GetControlType(pTRF.FldInfo.Type);
                if (!this.MyControlTypeName)
                    this.MyControlTypeName = "cdeNMI.ctrlEditBox";
            }
            if (!this.MyControlTypeName || this.MyControlTypeName === "")
                this.MyControlTypeName = pTRF.FldInfo["DefaultValue"];
            if (!this.MyControlTypeName) {
                this.SetProperty("PlaceHolder", "Missing Type for UserControl");
                return false;
            }
            if (!pTRF.FldInfo["RenderTarget"] && !pTRF.FldInfo["PlaceHolder"])
                this.SetProperty("PlaceHolder", "(Waiting for control #" + pTRF.FldInfo.FldOrder + ": " + this.MyControlTypeName + ")");
            else {
                if (!pTRF.FldInfo["PlaceHolder"])
                    this.SetProperty("PlaceHolder", pTRF.FldInfo["PlaceHolder"]);
            }
            switch (pTRF.FldInfo.Type) { //TODO: I dont want this here but in the ctrlTable - it needs to decide how it looks inside 
                case cdeNMI.cdeControlType.Table:
                    if (cde.IsNotSet(pTRF.FldInfo["ClassName"]))
                        pTRF.FldInfo["ClassName"] = "CMyTable";
                    break;
                default:
                    break;
            }
            pTargetControl.RegisterEvent("OnLoaded", () => {
                this.MyTEContent.FireEvent(true, "OnLoaded");
            });
            this.RegisterEvent("Resize", (sender, newSize) => {
                if (this.MyNMIControl)
                    this.MyNMIControl.FireEvent(true, "Resize", newSize);
            });
            return true;
        }
        SetProperty(pName, pValue) {
            if (pName === "IsOwnerDown") {
                if (pValue === true) {
                    if (this.GetProperty(pName) === true)
                        return;
                    this.mOldClassName = this.MyTEContainer.GetElement().className;
                    this.MyTEContainer.GetElement().className += " cdeNodeGone";
                }
                else {
                    if (this.GetProperty(pName) !== true)
                        return;
                    this.MyTEContainer.GetElement().className = this.mOldClassName;
                }
            }
            //Properties only on TE not propagated anywhere
            if (pName === "IsInTable") {
                super.SetProperty(pName, pValue);
                return;
            }
            if (pName === "Visibility") {
                this.MyTEContainer.SetProperty(pName, pValue);
                return;
            }
            if (pName === "MinTileWidth" && cde.CInt(pValue) > 0) {
                super.SetProperty(pName, pValue);
                pName = "TileWidth";
            }
            else if (pName === "MinTileHeight" && pValue) {
                super.SetProperty(pName, pValue);
                pName = "TileHeight";
            }
            //Properties on TE but will be propageted
            if (pName === "NoTE" || pName === "TileWidth" || pName === "TileHeight") {
                super.SetProperty(pName, pValue);
            }
            else if (pName === "Z-Index" && this.MyTEContent) {
                pValue = cde.CInt(pValue);
                this.MyTEContent.SetProperty("Z-Index", pValue);
            }
            ///Properties for Forms but not Tables
            if (pName === "IsAbsolute" || pName === "Top" || pName === "Left" || pName === "TileTop" || pName === "TileLeft") {
                if (cde.CBool(this.GetProperty("IsInTable")))
                    return;
                super.SetProperty(pName, pValue);
                return;
            }
            if (pName === "TileWidth" || pName === "NoTE") {
                if (cde.CInt(this.GetProperty("TileWidth")) < cde.CInt(this.GetProperty("MinTileWidth")))
                    return;
                if (pName == "NoTE" && cde.CInt(this.GetSetting("PixelWidth")) > 0) {
                    if (!this.DontHideLabel)
                        this.MyTELabel.SetProperty("Visibility", false);
                    return;
                }
                let tScale = 1;
                if (cde.CInt(this.GetProperty("TileFactorX")) > 1)
                    tScale = cde.CInt(this.GetProperty("TileFactorX"));
                if (cde.CBool(this.GetProperty("NoTE")) || cde.CInt(this.GetProperty("TileWidth")) < (3 * tScale)) {
                    if (!this.DontHideLabel)
                        this.MyTELabel.SetProperty("Visibility", false);
                    this.MyTEContainer.SetProperty("TileWidth", cde.CInt(this.GetProperty("TileWidth")));
                    this.mTEContentOuter.SetProperty("TileWidth", cde.CInt(this.GetProperty("TileWidth")));
                    super.SetProperty("ControlTW", cde.CInt(this.GetProperty("TileWidth")));
                }
                else {
                    this.MyTELabel.SetProperty("Visibility", true);
                    this.MyTELabel.SetProperty("TileWidth", 2);
                    this.mTEContentOuter.SetProperty("TileWidth", cde.CInt(this.GetProperty("TileWidth")) - 2);
                    super.SetProperty("ControlTW", cde.CInt(this.GetProperty("TileWidth")) - 2);
                }
                if (this.MyNMIControl) {
                    this.MyNMIControl.SetProperty("ControlTW", cde.CInt(this.GetProperty("ControlTW")));
                }
                return;
            }
            else if (pName === "TileHeight") {
                if (cde.CInt(pValue) < cde.CInt(this.GetProperty("MinTileHeight")))
                    return;
                this.MyTEContainer.SetProperty("TileHeight", cde.CInt(pValue));
                this.mTEContentOuter.SetProperty("TileHeight", cde.CInt(pValue));
                this.MyTELabel.SetProperty("TileHeight", cde.CInt(pValue));
                super.SetProperty("ControlTH", cde.CInt(this.GetProperty("TileHeight")));
                if (this.MyNMIControl) {
                    this.MyNMIControl.SetProperty("ControlTH", cde.CInt(this.GetProperty("ControlTH")));
                }
                return;
            }
            else if (pName === "TileFactorX") {
                this.MyTEContainer.SetProperty("TileFactorX", cde.CInt(pValue));
                this.mTEContentOuter.SetProperty("TileFactorX", cde.CInt(pValue));
                this.MyTELabel.SetProperty("TileFactorX", cde.CInt(pValue));
                //return;
            }
            else if (pName === "TileFactorY") {
                this.MyTEContainer.SetProperty("TileFactorY", cde.CInt(pValue));
                this.mTEContentOuter.SetProperty("TileFactorY", cde.CInt(pValue));
                this.MyTELabel.SetProperty("TileFactorY", cde.CInt(pValue));
                //return;
            }
            else if (pName === "ContainerStyle" && this.MyTELabel) {
                this.MyTEContainer.SetProperty("Style", pValue);
            }
            else if (pName === "ContainerClassName" && this.MyTEContainer) {
                this.MyTEContainer.SetProperty("ClassName", pValue);
                return;
            }
            else if (pName === "LabelClassName" && this.MyTELabel) {
                this.MyTELabel.SetProperty("ClassName", pValue);
                this.MyTELabel.SetProperty("LabelClassName", pValue);
                return;
            }
            else if (pName === "LabelForeground" && this.MyTELabel) {
                this.MyTELabel.SetProperty("LabelForeground", pValue);
                return;
            }
            else if (pName === "LabelFontSize" && this.MyTELabel) {
                this.MyTELabel.SetProperty("LabelFontSize", pValue);
                return;
            }
            else if ((pName === "LabelBackground" || pName === "CaptionBackground") && this.MyTELabel) {
                this.MyTELabel.SetProperty("CaptionBackground", pValue);
                return;
            }
            else if (pName === "ContentOuterClassName" && this.mTEContentOuter) {
                this.mTEContentOuter.SetProperty("ClassName", pValue);
                return;
            }
            else if (pName === "MainClassName" && this.MyTEContent) {
                this.MyTEContent.SetProperty("ClassName", pValue);
                return;
            }
            else if (pName === "MainBackground" && this.MyTEContent) {
                this.MyTEContent.SetProperty("Background", pValue);
                return;
            }
            else if (pName === "VerticalAlignment" && this.MyTEContent && pValue) {
                this.MyTEContent.GetElement().className = 'cdeTileEntryText cdeFlexRow';
                switch (pValue.toString().toLowerCase()) {
                    case "top":
                        this.MyTEContent.GetElement().style.alignItems = 'flex-start';
                        break;
                    case "bottom":
                        this.MyTEContent.GetElement().style.alignItems = 'flex-end';
                        break;
                    default:
                        this.MyTEContent.GetElement().style.alignItems = 'center';
                        break;
                }
                return;
            }
            else if ((pName === "Label" || pName === "Title") && this.MyTELabel) {
                this.MyTELabel.SetProperty("Label", pValue);
                if (!cde.CBool(this.GetProperty("NoTE")))
                    return;
            }
            else if (pName === "PlaceHolder" && this.MyTEContent) {
                this.MyTEContent.SetProperty("Label", pValue);
                return;
            }
            if (this.MyNMIControl) {
                this.MyNMIControl.SetProperty(pName, pValue);
            }
        }
        OnLoad(bIsVisible) {
            if (this.MyNMIControl)
                this.MyNMIControl.OnLoad(bIsVisible);
            super.OnLoad(bIsVisible);
        }
        OnUnload() {
            if (this.MyNMIControl)
                this.MyNMIControl.OnUnload();
            super.OnUnload();
        }
        GetProperty(pName) {
            if ((pName === "DataItem" || pName === "iValue" || pName === "Value") && this.MyNMIControl) {
                return this.MyNMIControl.GetProperty(pName);
            }
            return super.GetProperty(pName);
        }
        CreateControl(tFldID, callback) {
            if (!cdeNMI.MyTCF) {
                cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "TileEntry:CreateControl", "MyTCF not initialized!");
                return null;
            }
            return cdeNMI.MyTCF.CreateControlLazy(this, this.MyEngineName, this.MyControlTypeName, (tgtCtrl, e, cookieTFldID) => {
                if (e.InitControl(tgtCtrl, this.MyTRF, null, this.MyScreenID)) {
                    try {
                        e.SetTE(this);
                        cdeNMI.MyTCF.SetControlEssentials(this, e);
                        this.SetProperty("PlaceHolder", null);
                        cdeNMI.AddFieldComment(this.MyTEContent.GetElement(), this.MyFieldInfo);
                        e.PostCreate(this);
                        if (callback)
                            callback(e, cookieTFldID);
                    }
                    catch (eee) {
                        this.SetProperty("PlaceHolder", eee);
                    }
                }
            }, tFldID);
        }
        ApplySkin() {
            if (this.MyNMIControl)
                this.MyNMIControl.ApplySkin();
        }
        //Backward compat
        static Create(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            const tTile = new ctrlTileEntry(pTRF);
            //if (pTRF && pTRF.FldInfo && (!pTRF.FldInfo.Type || pTRF.FldInfo.Type === 0))
            //  pTRF.FldInfo.Type = cdeControlType.SingleEnded; //If no Type is specified use 1 (Edit). Might be removed!
            tTile.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            return tTile;
        }
    }
    cdeNMI.ctrlTileEntry = ctrlTileEntry;
})(cdeNMI || (cdeNMI = {}));
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
var cdeNMI;
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
(function (cdeNMI) {
    class ctrlStatusLight extends cdeNMI.TheNMIBaseControl {
        constructor() {
            super(null, null);
            this.bIsOn = false;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            this.statusLightHolder = new cdeNMI.ctrlTileGroup(pTRF);
            this.statusLightHolder.InitControl(pTargetControl);
            this.statusLightHolder.SetProperty("ClassName", "cdeFlexRow cdeFlexCenter");
            this.statusLightHolder.MyRootElement.style.width = "inherit";
            this.statusLightHolder.MyRootElement.style.height = "inherit";
            let tWid = cde.CInt(this.GetSetting("TileWidth"));
            let tHei = cde.CInt(this.GetSetting("TileHeight"));
            let tIsInTable = false;
            if (pTRF && pTRF.FldInfo) {
                if (pTRF.FldInfo["ControlTW"]) {
                    tWid = pTRF.FldInfo["ControlTW"];
                    this.statusLightHolder.SetProperty("TileWidth", tWid);
                }
                if (pTRF.FldInfo["ControlTH"]) {
                    tHei = pTRF.FldInfo["ControlTH"];
                    this.statusLightHolder.SetProperty("TileHeight", tHei);
                }
                tIsInTable = cde.CBool(pTRF.FldInfo["IsInTable"]);
            }
            if (!tIsInTable) {
                this.statusLightTitle = new cdeNMI.ctrlSmartLabel();
                this.statusLightTitle.InitControl(this.statusLightHolder);
                this.statusLightTitle.SetProperty("Visibility", false);
            }
            this.mShape = new cdeNMI.ctrlShape();
            this.mShape.MyFieldInfo = new cdeNMI.TheFieldInfo(cdeNMI.cdeControlType.StatusLight, tWid, null, 0);
            this.mShape.SetProperty("AutoAdjust", true);
            this.mShape.InitControl(this.statusLightHolder);
            if (tWid)
                this.mShape.SetProperty("ControlTW", tWid);
            if (tHei)
                this.mShape.SetProperty("ControlTH", tHei);
            let tFX = cde.CInt(this.GetSetting("TileFactorX"));
            if (tFX > 1)
                this.mShape.SetProperty("TileFactorX", tFX);
            tFX = cde.CInt(this.GetSetting("TileFactorY"));
            if (tFX > 1) {
                this.mShape.SetProperty("TileFactorY", tFX);
            }
            this.SetProperty("iValue", 0);
            this.SetElement(this.statusLightHolder.GetElement());
            if (this.MyFormID && cdeNMI.MyScreenManager) {
                const tScreen = cdeNMI.MyScreenManager.GetScreenByID(this.MyFormID);
                if (tScreen)
                    tScreen.RegisterEvent("OnLoaded", () => this.ApplySkin());
            }
            return true;
        }
        SetProperty(pName, pValue) {
            let bIsDirty = false;
            if ((pName === "Value" || pName === "iValue" || pName === "LightColor")) {
                bIsDirty = true;
            }
            else if (pName === "SubTitle" && this.statusLightTitle) {
                this.statusLightTitle.SetProperty("Text", pValue);
                this.statusLightTitle.SetProperty("Visibility", true);
            }
            else if (pName === "Foreground" && this.statusLightTitle) {
                this.statusLightTitle.SetProperty(pName, pValue);
            }
            else if (pName === "IsBlinking" && cde.CInt(pValue) > 0) {
                if (!this.Blinker) {
                    this.Blinker = setInterval(() => {
                        if (cde.CInt(this.GetProperty("IsBlinking")) === 0) {
                            clearInterval(this.Blinker);
                            this.Blinker = null;
                            return;
                        }
                        if (this.bIsOn)
                            this.SetProperty("Opacity", "0.1");
                        else
                            this.SetProperty("Opacity", "1");
                        this.bIsOn = !this.bIsOn;
                    }, cde.CInt(pValue));
                }
            }
            else if ((pName === "ControlTW" || pName === "ControlTH" || pName === "TileWidth" || pName === "TileHeight" || pName === "TileFactorX" || pName === "TileFactorY") && this.mShape && this.mShape) {
                pValue = cde.CInt(pValue);
                this.mShape.SetProperty(pName, pValue);
                bIsDirty = true;
            }
            super.SetProperty(pName, pValue);
            if (bIsDirty && this.mShape && this.mShape.mCanvas) {
                const tL = this.mShape.mCanvas.MyWidth;
                const tH = this.mShape.mCanvas.MyHeight;
                if (tL === 0 || tH === 0)
                    return;
                let tW = tL;
                if (tH < tL)
                    tW = tH;
                let tM = 5;
                if (this.GetProperty("SubTitle"))
                    tM = 20;
                const tFillColor = this.GetProperty("LightColor");
                if (tFillColor) {
                    this.myShapeDraw = [{ Type: 4, Fill: tFillColor, Width: (tW / 2) - tM, Top: tH / 2, Left: tL / 2, Visibility: true, IsTemp: true }];
                }
                else {
                    switch (cde.CInt(this.GetProperty("Value")) % 8) {
                        default:
                            this.myShapeDraw = [{
                                    Type: 4, Fill: "gradientc(#808080, #FFFFFF)", Width: (tW / 2) - tM, Top: tH / 2, Left: tL / 2, Visibility: true, IsTemp: true
                                }];
                            break;
                        case 1:
                            this.myShapeDraw = [{ Type: 4, Fill: "gradientc(#008000, #00FF00)", Width: (tW / 2) - tM, Top: tH / 2, Left: tL / 2, Visibility: true, IsTemp: true }];
                            break;
                        case 2:
                            this.myShapeDraw = [{ Type: 4, Fill: "gradientc(#808000, #FFFF00)", Width: (tW / 2) - tM, Top: tH / 2, Left: tL / 2, Visibility: true, IsTemp: true }];
                            break;
                        case 3:
                            this.myShapeDraw = [{ Type: 4, Fill: "gradientc(#800000, #FF0000)", Width: (tW / 2) - tM, Top: tH / 2, Left: tL / 2, Visibility: true, IsTemp: true }];
                            break;
                        case 4:
                            this.myShapeDraw = [{ Type: 4, Fill: "gradientc(#000080, #0000FF)", Width: (tW / 2) - tM, Top: tH / 2, Left: tL / 2, Visibility: true, IsTemp: true }];
                            break;
                        case 5:
                            this.myShapeDraw = [{ Type: 4, Fill: "gradientc(#000000, #6f4200)", Width: (tW / 2) - tM, Top: tH / 2, Left: tL / 2, Visibility: true, IsTemp: true }];
                            break;
                        case 6:
                            this.myShapeDraw = [{ Type: 4, Fill: "gradientc(#400080, #8000FF)", Width: (tW / 2) - tM, Top: tH / 2, Left: tL / 2, Visibility: true, IsTemp: true }];
                            break;
                        case 7:
                            this.myShapeDraw = [{ Type: 4, Fill: "gradientc(#000000, #808080)", Width: (tW / 2) - tM, Top: tH / 2, Left: tL / 2, Visibility: true, IsTemp: true }];
                            break;
                    }
                }
                if (this.mShape) {
                    this.mShape.SetProperty("DataContext", this.myShapeDraw);
                }
            }
        }
        OnLoad() {
            this.ApplySkin();
        }
        ApplySkin() {
            this.mShape.ApplySkin();
            this.SetProperty("iValue", this.GetProperty("Value"));
        }
    }
    cdeNMI.ctrlStatusLight = ctrlStatusLight;
    /**
* Creates the standard About Button
V3.2 Ready
*/
    class ctrlAboutButton extends cdeNMI.TheNMIBaseControl {
        constructor() {
            super(null, null);
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            this.SetProperty("NoTE", true);
            this.SetProperty("MinTileHeight", -1);
            this.SetProperty("MinTileWidth", 6);
            //container
            this.aboutButtonContainer = new cdeNMI.ctrlTileGroup(pTRF);
            this.aboutButtonContainer.InitControl(pTargetControl);
            this.aboutButtonContainer.SetProperty("TileWidth", 6);
            this.aboutButtonContainer.SetProperty("Background", "rgba(128,128,128,.1)");
            this.aboutButtonContainer.SetProperty("ClassName", "cdeFlexCol cdeAboutBox");
            //top line
            this.topName = new cdeNMI.ctrlTileGroup();
            this.topName.InitControl(this.aboutButtonContainer);
            this.topName.SetProperty("TileWidth", 6);
            this.topName.SetProperty("TileHeight", 2);
            this.topName.SetProperty("ClassName", "cdeFlexRow cdeFlexCenter");
            this.topName.HookEvents(true);
            this.topName.RegisterEvent("PointerUp", () => {
                if (this.GetProperty("TargetLink") && cdeNMI.MyScreenManager) {
                    cdeNMI.MyScreenManager.TransitToScreen(this.GetProperty("TargetLink"));
                }
            });
            this.statusShape = new ctrlStatusLight();
            this.statusShape.InitControl(this.topName);
            this.statusShape.SetProperty("TileWidth", 2);
            this.statusShape.SetProperty("TileHeight", 2);
            this.leftTopGroup = new cdeNMI.ctrlTileGroup();
            this.leftTopGroup.InitControl(this.topName);
            this.leftTopGroup.SetProperty("TileWidth", 4);
            this.leftTopGroup.SetProperty("ClassName", "cdeFlexCol");
            this.pluginName = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SmartLabel).Create(this.leftTopGroup, { ScreenID: pScreenID, PreInitBag: ["Element=div"] });
            //cdeNMI.ctrlSmartLabel.Create(this.leftTopGroup, pScreenID, null, null, "div");
            this.pluginName.SetProperty("TileWidth", 4);
            this.pluginName.SetProperty("TileHeight", 1);
            this.pluginName.SetProperty("Style", "font-size:30px;");
            this.serviceName = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SmartLabel).Create(this.leftTopGroup, { ScreenID: pScreenID, PreInitBag: ["Element=div"] });
            //cdeNMI.ctrlSmartLabel.Create(this.leftTopGroup, pScreenID, null, null, "div");
            this.serviceName.SetProperty("TileWidth", 4);
            this.serviceName.SetProperty("TileHeight", 1);
            this.serviceName.SetProperty("Style", "overflow-y:auto;overflow-x:hidden;font-size:16px;");
            //middle
            this.collaBox = new cdeNMI.ctrlCollapsibleGroup();
            const tF = new cdeNMI.TheFieldInfo(cdeNMI.cdeControlType.CollapsibleGroup, 0, null, 2);
            tF.PropertyBag = ["IsSmall=true"];
            this.collaBox.InitControl(this.aboutButtonContainer, new cdeNMI.TheTRF("NONE", 0, tF));
            this.collaBox.SetProperty("TileWidth", 6);
            this.collaBox.SetProperty("Title", "About...");
            this.collaBox.SetProperty("IsSmall", true);
            this.collaBox.SetProperty("DoClose", true);
            this.middleBox = new cdeNMI.ctrlTileGroup();
            this.middleBox.InitControl(this.collaBox);
            this.middleBox.SetProperty("TileWidth", 6);
            this.middleBox.SetProperty("TileHeight", 1);
            this.middleBox.SetProperty("ClassName", "cdeFlexRow");
            this.mdlSquare = new cdeNMI.ctrlTileGroup();
            this.mdlSquare.InitControl(this.middleBox);
            this.mdlSquare.SetProperty("TileWidth", 5);
            this.mdlSquare.SetProperty("TileHeight", 1);
            this.mdlSquare.SetProperty("ClassName", "cdeFlexRow cdeFlexCenter");
            this.mdlText = new cdeNMI.ctrlSmartLabel();
            this.mdlText.InitControl(this.mdlSquare);
            this.leftSquare = new cdeNMI.ctrlTileGroup();
            this.leftSquare.InitControl(this.middleBox);
            this.leftSquare.SetProperty("TileWidth", 1);
            this.leftSquare.SetProperty("TileHeight", 1);
            this.leftSquare.SetProperty("ClassName", "cdeFlexRow cdeFlexCenter");
            this.iconImage = new cdeNMI.ctrlZoomImage();
            this.iconImage.InitControl(this.leftSquare);
            this.iconImage.SetProperty("TileWidth", 1);
            this.iconImage.SetProperty("TileHeight", 1);
            this.iconImage.SetProperty("Visibility", false);
            this.iconText = new cdeNMI.ctrlSmartLabel();
            this.iconText.InitControl(this.leftSquare);
            this.iconText.SetProperty("TileWidth", 1);
            this.iconText.SetProperty("Visibility", false);
            //Next Line
            this.rightSquare = new cdeNMI.ctrlTileGroup();
            this.rightSquare.InitControl(this.collaBox);
            this.rightSquare.SetProperty("TileWidth", 6);
            this.rightSquare.SetProperty("TileHeight", 1);
            this.rightSquare.SetProperty("ClassName", "cdeFlexRow cdeFlexCenter");
            this.rightSquare.SetProperty("Style", "-webkit-align-content: flex-start; -ms-flex-line-pack: start; align-content:flex-start;");
            this.versionText = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SmartLabel).Create(this.rightSquare, { ScreenID: pScreenID, TRF: cdeNMI.TheTRF.SetFlagsOnly(256), PreInitBag: ["Element=div"] });
            //cdeNMI.ctrlSmartLabel.Create(this.rightSquare, pScreenID, null, null, "div");
            this.versionText.SetProperty("TileWidth", 3);
            this.copyrightText = new cdeNMI.ctrlSmartLabel();
            this.copyrightText.InitControl(this.rightSquare);
            this.copyrightText.SetProperty("TileWidth", 3);
            //bottom
            this.adTile = new cdeNMI.ctrlTileGroup();
            this.adTile.InitControl(this.collaBox);
            this.adTile.SetProperty("TileWidth", 6);
            this.adTile.SetProperty("TileHeight", 1);
            this.adTile.SetProperty("ClassName", "cdeFlexRow cdeFlexCenter");
            this.advertise = new cdeNMI.ctrlSmartLabel();
            this.advertise.InitControl(this.adTile);
            this.SetElement(this.aboutButtonContainer.GetElement());
            if (this.MyFormID && cdeNMI.MyScreenManager) {
                const tScreen = cdeNMI.MyScreenManager.GetScreenByID(this.MyFormID);
                if (tScreen)
                    tScreen.RegisterEvent("OnLoaded", () => this.ApplySkin());
            }
            return true;
        }
        SetProperty(pName, pValue) {
            super.SetProperty(pName, pValue);
            if (!this.aboutButtonContainer)
                return;
            //setting properties
            //Title
            if (pName === "Title") {
                this.pluginName.SetProperty("iValue", pValue);
            }
            else if (pName === "SubTitle") {
                this.serviceName.SetProperty("iValue", pValue);
            }
            else if (pName === "Background") {
                this.aboutButtonContainer.SetProperty(pName, pValue);
                if (pValue === "black") {
                    this.mdlText.SetProperty("Foreground", "white");
                    this.pluginName.SetProperty("Foreground", "white");
                    this.mdlText.SetProperty("Foreground", "white");
                    this.copyrightText.SetProperty("Foreground", "white");
                    this.versionText.SetProperty("Foreground", "white");
                    this.advertise.SetProperty("Foreground", "white");
                    this.statusShape.SetProperty("Foreground", "white");
                    this.iconText.SetProperty("Foreground", "white");
                }
            }
            else if (pName === "Foreground") {
                this.aboutButtonContainer.SetProperty(pName, pValue);
                this.mdlText.SetProperty("Foreground", pValue);
                this.pluginName.SetProperty("Foreground", pValue);
                this.mdlText.SetProperty("Foreground", pValue);
                this.copyrightText.SetProperty("Foreground", pValue);
                this.versionText.SetProperty("Foreground", pValue);
                this.advertise.SetProperty("Foreground", pValue);
                this.statusShape.SetProperty("Foreground", pValue);
                this.iconText.SetProperty("Foreground", pValue);
            }
            else if (pName === "Value" || pName === "iValue") {
                this.statusShape.SetProperty("iValue", pValue);
            }
            else if (pName === "Description") {
                this.mdlText.SetProperty("Text", pValue);
            }
            else if (pName === "Copyright") {
                this.copyrightText.SetProperty("Text", pValue + "<BR>" + this.GetProperty("Author"));
            }
            else if (pName === "Author") {
                this.copyrightText.SetProperty("Text", this.GetProperty("Copyright") + "<BR>" + pValue);
            }
            else if (pName === "Version" || pName === "NodeText") {
                this.versionText.SetProperty("Text", "Current Version: " + this.GetProperty("Version") + "</br><span style='font-size:10px'>" + this.GetProperty("NodeText") + "</span>");
            }
            else if (pName === "Icon") {
                this.iconImage.SetProperty("iValue", pValue);
                this.iconImage.SetProperty("Visibility", true);
            }
            else if (pName === "IconText") {
                this.iconText.SetProperty("Text", pValue);
                this.iconText.SetProperty("Visibility", true);
            }
            else if (pName === "AdText") {
                this.advertise.SetProperty("Text", "To learn more visit</br><a href=" + pValue + " target='_blank'>" + pValue + "</a>");
            }
            else if (pName === "StatusText") {
                this.statusShape.SetProperty("Title", pValue);
            }
            else if (pName === "LastMessage") {
                this.serviceName.SetProperty("Text", pValue);
            }
        }
        ApplySkin() {
            this.statusShape.ApplySkin();
        }
    }
    cdeNMI.ctrlAboutButton = ctrlAboutButton;
    /**
* Creates a MuTLock (Multi-Touch Lock for Password Code)
*
* (3.2 Ready!)
*/
    class ctrlMoTLock extends cdeNMI.TheNMIBaseControl {
        constructor(pTRF) {
            super(null, pTRF);
            this.divMoTLock = null;
            this.hControl = null;
            this.mMoTLockCode = "";
            this.mMoTLockDigits = "";
            this.mShowOverlay = false;
            this.mTouched = 0;
            this.mPassField = null;
            this.k1 = null;
            this.k2 = null;
            this.k3 = null;
            this.k4 = null;
            this.k5 = null;
            this.k6 = null;
            this.k7 = null;
            this.k8 = null;
            this.k9 = null;
            this.k0 = null;
            this.kreset = null;
            this.kenter = null;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.MuTLock;
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            const tHead = "Enter Pin";
            this.divMoTLock = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileGroup).Create(pTargetControl, { TRF: pTRF }); //ctrlTileGroup.Create(pTargetControl, pTRF);
            this.divMoTLock.SetProperty("LabelClassName", "cdeMutLock");
            this.divMoTLock.SetProperty("Label", tHead);
            this.divMoTLock.GetElement().style.marginLeft = "0px";
            this.divMoTLock.GetElement().style.position = "fixed";
            this.divMoTLock.GetElement().style.zIndex = "50";
            this.divMoTLock.GetElement().style.backgroundColor = "black";
            this.divMoTLock.SetProperty("TileWidth", 3);
            this.divMoTLock.SetProperty("OnClick", () => {
                if (this.mPassField === null && this.MyTE !== null) {
                    if (this.MyTE.MyTEContainer.GetContainerElement().style.overflow === "initial")
                        this.MyTE.MyTEContainer.GetContainerElement().style.overflow = "hidden";
                    else
                        this.MyTE.MyTEContainer.GetContainerElement().style.overflow = "initial";
                }
            });
            this.k7 = cdeNMI.ctrlTileButton.Create(this.divMoTLock, null, "7", 1, 1);
            this.k7.PreventManipulation = true;
            this.k7.PreventDefault = true;
            this.k7.SetProperty("OnTileDown", () => this.SetDigit(7));
            this.k7.SetProperty("OnClick", (sender, evt) => this.CombiDone(evt));
            this.k7.SetProperty("ClassName", "cdeMutButton");
            this.k7.SetProperty("FontSize", 42);
            this.k8 = cdeNMI.ctrlTileButton.Create(this.divMoTLock, null, "8", 1, 1);
            this.k8.PreventManipulation = true;
            this.k8.PreventDefault = true;
            this.k8.SetProperty("OnTileDown", () => this.SetDigit(8));
            this.k8.SetProperty("OnClick", (sender, evt) => this.CombiDone(evt));
            this.k8.SetProperty("ClassName", "cdeMutButton");
            this.k8.SetProperty("FontSize", 42);
            this.k9 = cdeNMI.ctrlTileButton.Create(this.divMoTLock, null, "9", 1, 1);
            this.k9.PreventManipulation = true;
            this.k9.PreventDefault = true;
            this.k9.SetProperty("OnTileDown", () => this.SetDigit(9));
            this.k9.SetProperty("OnClick", (sender, evt) => this.CombiDone(evt));
            this.k9.SetProperty("ClassName", "cdeMutButton");
            this.k9.SetProperty("FontSize", 42);
            this.k4 = cdeNMI.ctrlTileButton.Create(this.divMoTLock, null, "4", 1, 1);
            this.k4.PreventManipulation = true;
            this.k4.PreventDefault = true;
            this.k4.SetProperty("OnTileDown", () => this.SetDigit(4));
            this.k4.SetProperty("OnClick", (sender, evt) => this.CombiDone(evt));
            this.k4.SetProperty("ClassName", "cdeMutButton");
            this.k4.SetProperty("FontSize", 42);
            this.k5 = cdeNMI.ctrlTileButton.Create(this.divMoTLock, null, "5", 1, 1);
            this.k5.PreventManipulation = true;
            this.k5.PreventDefault = true;
            this.k5.SetProperty("OnTileDown", () => this.SetDigit(5));
            this.k5.SetProperty("OnClick", (sender, evt) => this.CombiDone(evt));
            this.k5.SetProperty("ClassName", "cdeMutButton");
            this.k5.SetProperty("FontSize", 42);
            this.k6 = cdeNMI.ctrlTileButton.Create(this.divMoTLock, null, "6", 1, 1);
            this.k6.PreventManipulation = true;
            this.k6.PreventDefault = true;
            this.k6.SetProperty("OnTileDown", () => this.SetDigit(6));
            this.k6.SetProperty("OnClick", (sender, evt) => this.CombiDone(evt));
            this.k6.SetProperty("ClassName", "cdeMutButton");
            this.k6.SetProperty("FontSize", 42);
            this.k1 = cdeNMI.ctrlTileButton.Create(this.divMoTLock, null, "1", 1, 1);
            this.k1.PreventManipulation = true;
            this.k1.PreventDefault = true;
            this.k1.SetProperty("OnTileDown", () => this.SetDigit(1));
            this.k1.SetProperty("OnClick", (sender, evt) => this.CombiDone(evt));
            this.k1.SetProperty("ClassName", "cdeMutButton");
            this.k1.SetProperty("FontSize", 42);
            this.k2 = cdeNMI.ctrlTileButton.Create(this.divMoTLock, null, "2", 1, 1);
            this.k2.PreventManipulation = true;
            this.k2.PreventDefault = true;
            this.k2.SetProperty("OnTileDown", () => this.SetDigit(2));
            this.k2.SetProperty("OnClick", (sender, evt) => this.CombiDone(evt));
            this.k2.SetProperty("ClassName", "cdeMutButton");
            this.k2.SetProperty("FontSize", 42);
            this.k3 = cdeNMI.ctrlTileButton.Create(this.divMoTLock, null, "3", 1, 1);
            this.k3.PreventManipulation = true;
            this.k3.PreventDefault = true;
            this.k3.SetProperty("OnTileDown", () => this.SetDigit(3));
            this.k3.SetProperty("OnClick", (sender, evt) => this.CombiDone(evt));
            this.k3.SetProperty("ClassName", "cdeMutButton");
            this.k3.SetProperty("FontSize", 42);
            this.k0 = cdeNMI.ctrlTileButton.Create(this.divMoTLock, null, "0", 1, 1);
            this.k0.PreventManipulation = true;
            this.k0.PreventDefault = true;
            this.k0.SetProperty("OnTileDown", () => this.SetDigit(0));
            this.k0.SetProperty("OnClick", (sender, evt) => this.CombiDone(evt));
            this.k0.SetProperty("ClassName", "cdeMutButton");
            this.k0.SetProperty("FontSize", 42);
            this.kreset = cdeNMI.ctrlTileButton.Create(this.divMoTLock, null, "Reset", 2, 1);
            this.kreset.PreventManipulation = true;
            this.kreset.PreventDefault = true;
            this.kreset.SetProperty("ClassName", "cdeMutButton");
            this.kreset.SetProperty("OnClick", (sender, evt, tps) => {
                if (tps > 0) {
                    cdeNMI.StopPointerEvents(evt);
                    this.mMoTLockCode = "";
                    this.mTouched = 0;
                    this.mMoTLockDigits = "";
                    if (this.mPassField) {
                        if (!this.mShowOverlay)
                            this.mPassField.SetProperty("Value", this.mMoTLockCode);
                        else
                            this.mPassField.SetProperty("iValue", this.mMoTLockCode);
                    }
                    else
                        this.SetProperty("Value", this.mMoTLockCode);
                }
            });
            this.kenter = cdeNMI.ctrlTileButton.Create(this.divMoTLock, null, "Enter", 3, 1);
            this.kenter.PreventManipulation = true;
            this.kenter.PreventDefault = true;
            this.kenter.SetProperty("Visibility", false);
            this.kenter.SetProperty("ClassName", "cdeMutButton");
            this.kenter.SetProperty("OnClick", (sender, evt) => {
                if (this.mPassField) {
                    this.mPassField.IsDirty = true;
                    this.mPassField.FireEvent(false, "OnValueChanged", evt, this.mMoTLockCode);
                }
                else
                    this.SetProperty("Value", this.mMoTLockCode);
            });
            this.PreventManipulation = true;
            this.SetElement(this.divMoTLock.GetElement());
            return true;
        }
        SetProperty(pName, pValue) {
            super.SetProperty(pName, pValue);
            if (pName === "PassField") {
                this.mPassField = pValue;
                this.divMoTLock.GetElement().style.position = "fixed";
            }
            else if (pName === "Background") {
                if (this.divMoTLock)
                    this.divMoTLock.GetElement().style.backgroundColor = pValue;
            }
            else if (pName === "IsOverlay") {
                this.mShowOverlay = cde.CBool(pValue);
                this.divMoTLock.GetElement().style.zIndex = (cde.CBool(this.mShowOverlay) ? 1300 : 0).toString();
                cdeNMI.SetZIndex(this.k7.GetElement(), cde.CBool(this.mShowOverlay) ? 1300 : 0);
                cdeNMI.SetZIndex(this.k8.GetElement(), cde.CBool(this.mShowOverlay) ? 1300 : 0);
                cdeNMI.SetZIndex(this.k9.GetElement(), cde.CBool(this.mShowOverlay) ? 1300 : 0);
                cdeNMI.SetZIndex(this.k4.GetElement(), cde.CBool(this.mShowOverlay) ? 1300 : 0);
                cdeNMI.SetZIndex(this.k5.GetElement(), cde.CBool(this.mShowOverlay) ? 1300 : 0);
                cdeNMI.SetZIndex(this.k6.GetElement(), cde.CBool(this.mShowOverlay) ? 1300 : 0);
                cdeNMI.SetZIndex(this.k1.GetElement(), cde.CBool(this.mShowOverlay) ? 1300 : 0);
                cdeNMI.SetZIndex(this.k2.GetElement(), cde.CBool(this.mShowOverlay) ? 1300 : 0);
                cdeNMI.SetZIndex(this.k3.GetElement(), cde.CBool(this.mShowOverlay) ? 1300 : 0);
                cdeNMI.SetZIndex(this.k0.GetElement(), cde.CBool(this.mShowOverlay) ? 1300 : 0);
                cdeNMI.SetZIndex(this.kreset.GetElement(), cde.CBool(this.mShowOverlay) ? 1300 : 0);
                this.kenter.SetProperty("Visibility", this.mShowOverlay);
                cdeNMI.SetZIndex(this.kenter.GetElement(), cde.CBool(this.mShowOverlay) ? 1300 : 0);
            }
        }
        SetDigit(digit) {
            this.mTouched++;
            this.mMoTLockDigits += digit.toString();
        }
        CombiDone(evt) {
            if (this.mTouched > 0) {
                this.mTouched = 0;
                if (this.mMoTLockCode.length > 0)
                    this.mMoTLockCode += ";";
                this.mMoTLockCode += this.mMoTLockDigits;
                this.mMoTLockDigits = "";
                cdeNMI.StopPointerEvents(evt);
                if (this.mPassField) {
                    if (!this.mShowOverlay)
                        this.mPassField.SetProperty("Value", this.mMoTLockCode);
                    else
                        this.mPassField.SetProperty("iValue", this.mMoTLockCode);
                }
            }
        }
        //backwards compat
        static Create(pTargetControl, pTRF, pPassField, pSize, pShowOverlay) {
            const t = new ctrlMoTLock(pTRF);
            if (pPassField)
                t.SetProperty("PassField", pPassField);
            t.InitControl(pTargetControl, pTRF);
            if (cde.CBool(pShowOverlay))
                t.SetProperty("IsOverlay", pShowOverlay);
            if (pSize)
                t.SetProperty("TileWidth", pSize);
            return t;
        }
    }
    cdeNMI.ctrlMoTLock = ctrlMoTLock;
    /**
* Creates a Mesh-Picker picker dialog for users that have access to multiple meshes
*
* (4.1 Ready!)
*/
    class ctrlMeshPicker extends cdeNMI.TheNMIBaseControl {
        constructor(pTRF) {
            super(null, pTRF);
            this.mPickerGroup = null;
            this.mMeshList = null;
            this.mNodesFld = null;
            this.MyMeshes = null;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.MuTLock;
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            this.mPickerGroup = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileGroup).Create(this, { PostInitBag: ["TileWidth=12", "ClassName=cdeLoginBlock"] });
            cdeNMI.TheControlFactory.AddAdHocSmartControl(this.mPickerGroup, "HEADER", cdeNMI.cdeControlType.SmartLabel, "", 0, ["NoTE=true", "TileHeight=1", "TileWidth=12", "iValue=Please choose a mesh", "FontSize=36"]);
            const tMeshListFrame = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileGroup).Create(this.mPickerGroup, { PostInitBag: ["TileWidth=6", "TileHeight=6"] });
            const tSearch = cdeNMI.TheControlFactory.AddAdHocSmartControl(tMeshListFrame, "SEARCH", cdeNMI.cdeControlType.SingleEnded, "Search for Mesh", 2, ["TileHeight=1", "TileFactorY=2", "TileWidth=5"]);
            tSearch.MyNMIControl.RegisterEvent("OnValueChanged", (sender, evt, pval) => {
                this.SetProperty("Filter", pval);
            });
            this.mMeshList = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileGroup).Create(tMeshListFrame, { PostInitBag: ["TileWidth=6", "TileHeight=5", "Style=overflow-y: auto;"] });
            const tExplainer = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileGroup).Create(this.mPickerGroup, { PostInitBag: ["TileWidth=6", "TileHeight=6"] });
            cdeNMI.TheControlFactory.AddAdHocSmartControl(tExplainer, "NIM", cdeNMI.cdeControlType.SmartLabel, "", 0, ["NoTE=true", "TileHeight=1", "TileFactorY=2", "TileWidth=6", "iValue=Nodes in the Mesh"]);
            this.mNodesFld = cdeNMI.TheControlFactory.AddAdHocSmartControl(tExplainer, "NODES", cdeNMI.cdeControlType.SmartLabel, "", 256, ["NoTE=true", "TileHeight=5"]);
            this.SetElement(this.mPickerGroup.GetElement());
            return true;
        }
        SetMesh(pMeshes) {
            if (pMeshes)
                this.MyMeshes = pMeshes;
            if (!this.MyMeshes)
                return;
            if (this.mMeshList) {
                this.mMeshList.GetElement().innerHTML = null;
                this.mNodesFld.SetProperty("iValue", "");
                const pFilter = cde.CStr(this.GetProperty("Filter"));
                for (let i = 0; i < this.MyMeshes.length; i++) {
                    if (!this.MyMeshes[i].HomeNode)
                        this.MyMeshes[i].HomeNode = "";
                    if (pFilter && this.MyMeshes[i].MeshHash.indexOf(pFilter) < 0 && this.MyMeshes[i].HomeNode.indexOf(pFilter) < 0 && this.MyMeshes[i].NodeNames.join().indexOf(pFilter) < 0)
                        continue;
                    this.CreateMeshButton(i);
                }
            }
        }
        SetProperty(pName, pValue) {
            if (pName === "SetMesh") {
                this.SetMesh(pValue);
                return;
            }
            super.SetProperty(pName, pValue);
            if (pName === "Filter") {
                this.SetMesh(null);
            }
        }
        CreateMeshButton(i) {
            const tMeshBut = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileGroup).Create(this.mMeshList, { PostInitBag: ["TileHeight=3", "TileFactorY=2", "TileWidth=11", "TileFactorX=2", "Style=box-shadow: rgba(0,0,0,.3) 0 1px 1px;"] });
            tMeshBut.SetProperty("Mesh", this.MyMeshes[i]);
            tMeshBut.SetProperty("OnClick", (pSender) => {
                const tM = pSender.GetProperty("Mesh");
                this.mNodesFld.SetProperty("FontSize", "36");
                this.mNodesFld.SetProperty("iValue", "Loading Mesh (" + tM.MeshHash + ")...");
                if (cdeNMI.MyEngine)
                    cdeNMI.MyEngine.SelectMesh(tM.cdeMID);
            });
            tMeshBut.SetProperty("OnHover", (pSender) => {
                const tM = pSender.GetProperty("Mesh");
                if (tM) {
                    let tNs = "<bl style='font-size:24px;'>";
                    for (let j = 0; j < tM.NodeNames.length; j++) {
                        //if (tNs.length > 0) tNs += "</br>";
                        tNs += "<li>" + tM.NodeNames[j] + "</li>";
                    }
                    tNs += "</bl>";
                    this.mNodesFld.SetProperty("iValue", tNs);
                }
            });
            cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileGroup).Create(tMeshBut, { PostInitBag: ["TileWidth=5", "TileHeight=1", "TileFactorY=4"] });
            cdeNMI.TheControlFactory.AddAdHocSmartControl(tMeshBut, "ICON" + i, cdeNMI.cdeControlType.HashIcon, "", 0, ["NoTE=true", "TileHeight=1", "TileWidth=1", "iValue=" + this.MyMeshes[i].MeshHash]);
            cdeNMI.TheControlFactory.AddAdHocSmartControl(tMeshBut, "LABEL" + i, cdeNMI.cdeControlType.SmartLabel, "", 256, ["NoTE=true", "TileHeight=1", "TileWidth=4", "iValue=" + this.MyMeshes[i].HomeNode + "<br>(" + this.MyMeshes[i].MeshHash + ")", "ClassName=cdePickerLabel"]);
        }
    }
    cdeNMI.ctrlMeshPicker = ctrlMeshPicker;
})(cdeNMI || (cdeNMI = {}));
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
var cdeNMI;
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
(function (cdeNMI) {
    class TheDataViewBase extends cdeNMI.TheNMIBaseControl {
        constructor(pTRF) {
            super(null, null);
            this.MyTableControls = [];
            this.MyFormControls = new Array(); //TODO:4.1 Merge the two!
            this.MyTableName = null;
            this.MyStorageName = null;
            this.MyAdderRow = null;
        }
        GetControlByFldNo(pRowNo, pFld) {
            if (!this.MyTRF)
                return null;
            if (this.MyAdderRow) {
                return this.MyAdderRow[this.MyTRF.TableName + "_" + pFld];
            }
            else {
                if (this.MyBaseType === cdeNMI.cdeControlType.FormView) {
                    if (this.MyTRF.FldInfo["TableReference"])
                        return this.MyFormControls[this.MyTRF.FldInfo["TableReference"] + "_" + pRowNo + "_" + pFld];
                    else
                        return this.MyFormControls[this.MyTRF.TableName + "_" + pRowNo + "_" + pFld];
                }
                else
                    return this.MyTableControls[pRowNo][this.MyTRF.TableName + "_" + pRowNo + "_" + pFld];
            }
        }
        ValidateRules(pScreenID, pFormID, pTableName, pRow, pFldEntries, pLocalOnly, pForceWrite) {
            const tModel = cdeNMI.MyNMIModels[pScreenID];
            if (!pFormID)
                pFormID = this.MyTableName;
            if (!tModel.MyStorageMeta[pFormID] || tModel.MyStorageMeta[pFormID].AreRulesRunning === true)
                return false;
            tModel.MyStorageMeta[pFormID].AreRulesRunning = true;
            try {
                let bIsDirty = false;
                let tID = "";
                let tFldInfo = null;
                let tFldEntry = null;
                let tDirtyMask = "";
                const tOldValues = [];
                let RowData = null;
                if (tModel.MyStorageMirror[pTableName])
                    RowData = tModel.MyStorageMirror[pTableName][pRow];
                if (!RowData)
                    RowData = {};
                if (RowData.cdeMID)
                    tID = RowData.cdeMID;
                if (RowData.hasOwnProperty('SecToken'))
                    RowData.SecToken = 'CDE!';
                RowData.nmiTableName = pTableName;
                RowData.nmiScreenID = pScreenID;
                const tScreen = cdeNMI.MyScreenManager.GetScreenByID(pFormID);
                if (tScreen && tScreen.GetProperty("MyOwnerTable"))
                    RowData.nmiOwner = tScreen.GetProperty("MyOwnerTable");
                let j;
                for (j = 0; j < tModel.MyStorageMeta[pFormID].FormFields.length; j++) {
                    try {
                        tFldInfo = tModel.MyStorageMeta[pFormID].FormFields[j];
                        if (!tFldInfo)
                            continue;
                        tFldEntry = pFldEntries[pTableName + "_" + pRow + "_" + tFldInfo.FldOrder];
                        let WasDirty = false;
                        if (tFldEntry && tFldInfo.Type !== cdeNMI.cdeControlType.CollapsibleGroup && tFldInfo.Type !== cdeNMI.cdeControlType.TileGroup) { //TODO: do not process any control that uses the OnUpdateName with Format!
                            if (tFldEntry.MyNMIControl && tFldEntry.MyNMIControl.MyBaseType !== 27)
                                tFldEntry = tFldEntry.MyNMIControl;
                            if (!pLocalOnly && tFldInfo && tFldInfo.DataItem && (((tFldInfo.Flags & 2) !== 0 && !cde.CBool(tFldInfo["WriteOnce"])) || pForceWrite)) {
                                let tNewValue = tFldEntry.GetProperty("Value");
                                if (!tFldEntry.IsDirty && tFldInfo["DefaultValue"] && (cde.IsNotSet(tNewValue) || tNewValue === tFldInfo["DefaultValue"])) {
                                    tNewValue = tFldInfo["DefaultValue"];
                                    tFldEntry.IsDirty = true;
                                }
                                if (tFldEntry.IsDirty) {
                                    tFldEntry.IsDirty = false;
                                    if (cdeNMI.UpdFldContent(RowData, tFldInfo, tNewValue, tOldValues)) {
                                        bIsDirty = true;
                                        WasDirty = true;
                                    }
                                }
                            }
                            if (tFldEntry) {
                                for (const tDItem in tFldEntry.MyDataItems) {
                                    if (tFldEntry.MyDataItems.hasOwnProperty(tDItem)) {
                                        const pVal = tFldEntry.MyDataItems[tDItem];
                                        let nVal = cdeNMI.GenerateFinalString(pVal, RowData);
                                        if (nVal === pVal) {
                                            nVal = cdeNMI.GenerateFinalString(pVal, pFldEntries);
                                        }
                                        tFldEntry.SetProperty(tDItem, nVal);
                                    }
                                }
                            }
                            if (pForceWrite || ((tFldInfo.Flags & 2) !== 0 && !cde.CBool(tFldInfo["WriteOnce"])) || WasDirty)
                                tDirtyMask += "1";
                            else
                                tDirtyMask += "0";
                        }
                        else
                            tDirtyMask += "0";
                    }
                    catch (ext) {
                        cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "Validator:Error:" + ext, ext.stack);
                    }
                }
                if (bIsDirty || pForceWrite) {
                    if (!pLocalOnly || pForceWrite) {
                        if (RowData.hasOwnProperty('SecToken') && cde.MyContentEngine) {
                            if (RowData.SecToken === "")
                                RowData.SecToken = cde.MyContentEngine.RSAEncrypt("CDE!"); //Attention: Token can exceed encryptable Size!
                            else
                                RowData.SecToken = cde.MyContentEngine.RSAEncrypt(RowData.SecToken); //Attention: Token can exceed encryptable Size!
                        }
                        if (cdeNMI.MyEngine) {
                            if (tID === "")
                                cdeNMI.MyEngine.PublishToNMI('NMI_INS_DATA:' + pTableName + ':' + pScreenID + ':' + pFormID, JSON.stringify(RowData), tModel.cdeN);
                            else
                                cdeNMI.MyEngine.PublishToNMI('NMI_UPD_DATA:' + pTableName + ':' + tID + ':' + pScreenID + ':' + tDirtyMask, JSON.stringify(RowData), RowData.cdeN);
                        }
                    }
                    if (cdeNMI.MyEngine && tID !== "")
                        cdeNMI.MyEngine.FireEvent(false, "RecordUpdated_" + pTableName + "_" + pRow, cde.GuidToString(tModel.cdeMID), pTableName, pRow, tDirtyMask);
                }
                for (j = 0; j < tModel.MyStorageMeta[pFormID].FormFields.length; j++) {
                    tFldInfo = tModel.MyStorageMeta[pFormID].FormFields[j];
                    tFldEntry = pFldEntries[pTableName + "_" + pRow + "_" + tFldInfo.FldOrder];
                    let IsHidden = false;
                    const tHideCondition = tFldInfo["HideCondition"];
                    if (tHideCondition && tHideCondition !== "") {
                        let tRealCondition = "";
                        try {
                            tRealCondition = cdeNMI.GenerateFinalString(tHideCondition, RowData);
                            IsHidden = cde.cdeEval(tRealCondition);
                        }
                        catch (e) {
                            //cdeNMI.ShowToastMessage("Validating Hide-Condition Error:" + e, "in: (" + tHideCondition + ") resolved to<br/>" + tRealCondition);
                            cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "Validating Hide-Condition Error:" + e, "in: (" + tHideCondition + ") resolved to<br/>" + tRealCondition);
                            IsHidden = true;
                        }
                    }
                    let IsGreyd = false;
                    const tGrayCondition = tFldInfo["GreyCondition"];
                    if (tGrayCondition && tGrayCondition !== "") {
                        let tRealCondition = "";
                        try {
                            tRealCondition = cdeNMI.GenerateFinalString(tGrayCondition, RowData);
                            IsGreyd = cde.cdeEval(tRealCondition);
                        }
                        catch (e) {
                            //cdeNMI.ShowToastMessage("Validating Gray-Condition Error:" + e, "in: (" + tGrayCondition + ") resolved to<br/>" + tRealCondition);
                            cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "Validating Gray-Condition Error:" + e, "in: (" + tGrayCondition + ") resolved to<br/>" + tRealCondition);
                            IsGreyd = true;
                        }
                    }
                    if (tFldEntry) {
                        if (tHideCondition && tHideCondition !== "") {
                            tFldEntry.SetProperty("Visibility", !IsHidden);
                        }
                        if (tGrayCondition && tGrayCondition !== "") {
                            tFldEntry.SetProperty("Disabled", IsGreyd);
                        }
                    }
                }
            }
            catch (eee) {
                cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "Validator:Error", eee);
            }
            tModel.MyStorageMeta[pFormID].AreRulesRunning = false;
            return true;
        }
        SortTableByProperty(pTable, pDataItem, IsNumeric, pSortDescending) {
            if (!pTable)
                return [];
            return pTable.sort((a, b) => {
                let c;
                let d;
                if (pDataItem.indexOf('.') > 0) {
                    c = cdeNMI.GetFldContentByName(a, pDataItem, false);
                    d = cdeNMI.GetFldContentByName(b, pDataItem, false);
                    if (IsNumeric) {
                        c = cde.CDbl(c);
                        d = cde.CDbl(d);
                    }
                }
                else {
                    c = IsNumeric ? cde.CDbl(a[pDataItem]) : cde.CStr(a[pDataItem]);
                    d = IsNumeric ? cde.CDbl(b[pDataItem]) : cde.CStr(b[pDataItem]);
                }
                if (c === d)
                    return 0;
                return pSortDescending ? d > c ? 1 : -1 : d < c ? 1 : -1;
            });
        }
        ReplaceMarcos(tInStr, pFormControls) {
            let outStr = tInStr;
            for (const tfld in pFormControls) {
                const tCtrl = pFormControls[tfld];
                if (tCtrl && tCtrl.MyBaseType === cdeNMI.cdeControlType.TileEntry && tCtrl.MyNMIControl.MyFieldInfo && tCtrl.MyNMIControl.MyFieldInfo["DataItem"]) {
                    const tDI = tCtrl.MyNMIControl.MyFieldInfo["DataItem"];
                    do {
                        tInStr = outStr;
                        outStr = outStr.replace('<%' + tDI + '%>', tCtrl.GetProperty("Value"));
                    } while (tInStr !== outStr);
                }
            }
            while (outStr.indexOf("<%") >= 0) {
                if (outStr.indexOf("%>") > 0) {
                    const tPre = outStr.substr(0, outStr.indexOf("<%"));
                    outStr = tPre + outStr.substr(outStr.indexOf("%>") + 2);
                }
                else
                    break;
            }
            return outStr;
        }
        ///Creates the FormField Definition for a given TableRow
        CreateFormInfo(pTableRow, pParentClass, pForm, pFldIdx) {
            let lastName = "";
            for (const index in pTableRow) {
                if (index.length > 3 && index.substring(0, 3) === "cde" && !((index === "cdeMID" || index === "cdeA") && pParentClass === ""))
                    continue;
                let tIndex = index;
                if (pParentClass !== "")
                    tIndex = pParentClass + "." + tIndex;
                lastName = tIndex;
                if (typeof pTableRow[index] === "object") {
                    pFldIdx = this.CreateFormInfo(pTableRow[index], lastName, pForm, pFldIdx);
                    continue;
                }
                if (tIndex.length > 13 && tIndex.substr(0, 13) === "MyPropertyBag" && tIndex.substr(tIndex.length - 6, 6) === ".Value")
                    continue;
                let tHeader = tIndex;
                if (tIndex.substr(0, 13) === "MyPropertyBag") {
                    const th = tIndex.split('.');
                    tHeader = th[1];
                    if (th.length > 3) {
                        for (let i = 2; i < th.length - 1; i++) {
                            tHeader += "." + th[i];
                        }
                    }
                }
                if (pTableRow[tIndex] && typeof pTableRow[tIndex] === "string" && pTableRow[tIndex].substring(0, 5) === "/Date")
                    pForm.FormFields[pFldIdx] = new cdeNMI.TheFieldInfo(21, 2, tHeader);
                else {
                    if (pTableRow[tIndex] && typeof pTableRow[tIndex] === "string" && pTableRow[tIndex].length > 1000)
                        pForm.FormFields[pFldIdx] = new cdeNMI.TheFieldInfo(29, 0, tHeader);
                    else {
                        if (index === "cdeA")
                            pForm.FormFields[pFldIdx] = new cdeNMI.TheFieldInfo(24, 1, tHeader);
                        else
                            pForm.FormFields[pFldIdx] = new cdeNMI.TheFieldInfo(1, 1, tHeader);
                    }
                }
                pForm.FormFields[pFldIdx].FormID = cde.GuidToString(pForm.cdeMID);
                pForm.FormFields[pFldIdx].DataItem = tIndex;
                pForm.FormFields[pFldIdx].FldOrder = pFldIdx;
                if (tIndex.substr(0, 13) === "MyPropertyBag") {
                    if (tIndex.substr(tIndex.length - 5, 5) === ".Name") {
                        pForm.FormFields[pFldIdx]["Title"] = tHeader;
                        pForm.FormFields[pFldIdx].DataItem = tIndex.substr(0, tIndex.length - 5) + '.Value';
                    }
                }
                pForm.FormFields[pFldIdx++].Flags = 0;
            }
            if (pParentClass === "") {
                pForm.FormFields[pFldIdx] = new cdeNMI.TheFieldInfo(cdeNMI.cdeControlType.FormButton, 1, "Details", 2, cde.GuidToString(pForm.cdeMID));
                pForm.FormFields[pFldIdx].FldOrder = 1000;
                pForm.FormFields[pFldIdx].DataItem = "CDE_DETAILS";
                pForm.FormFields[pFldIdx].PropertyBag = ["ClassName=cdeTableButton", "Value=<span class='fa fa-3x'>&#xf044;</span>"];
            }
            return pFldIdx;
        }
        RemoveTableHooks() {
            if (!this.MyTableControls)
                return;
            for (let i = 0; i < this.MyTableControls.length; i++) {
                this.RemoveFormHooks(this.MyTableControls[i]);
            }
        }
        RemoveFormHooks(pFormControls) {
            for (const vd in pFormControls) {
                if (pFormControls.hasOwnProperty(vd)) {
                    const tID = pFormControls[vd].GetProperty("ID");
                    if (tID && tID.length > 0) {
                        let tOwn = "TABLES";
                        if (pFormControls[vd].MyNMIControl)
                            pFormControls[vd].MyNMIControl.FireEvent(false, "OnDelete");
                        if (pFormControls[vd].MyNMIControl && pFormControls[vd].MyNMIControl.MyTRF && pFormControls[vd].MyNMIControl.MyTRF.FldInfo && pFormControls[vd].MyNMIControl.MyTRF.FldInfo.cdeMID)
                            tOwn = cde.GuidToString(pFormControls[vd].MyNMIControl.MyTRF.FldInfo.cdeMID);
                        cdeNMI.MyTCF.UnregisterControl(tOwn, tID);
                    }
                }
            }
        }
        DeleteRecord(pDataRow) {
            //override if required
        }
        OnLoaded() {
            //override if required
        }
    }
    cdeNMI.TheDataViewBase = TheDataViewBase;
})(cdeNMI || (cdeNMI = {}));
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
var cdeNMI;
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
(function (cdeNMI) {
    class TheDashboard extends cdeNMI.TheNMIBaseControl {
        constructor(pTRF) {
            super(null, pTRF);
            this.mDashboardScreen = null;
            this.mScreenIDs = null;
            this.mTileCount = 0;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.Dashboard;
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            this.SetupDashboard(this.GetSetting("ScreenGuid"));
            return true;
        }
        SetupDashboard(pScreenID) {
            const tScreenInfo = cdeNMI.MyNMIModels[this.MyScreenID];
            if (!tScreenInfo || !tScreenInfo.MyDashboard)
                return;
            cdeNMI.ThePB.ConvertPropertiesFromBag(tScreenInfo.MyDashboard);
            let IsNewDashboard = false;
            if (!pScreenID)
                pScreenID = tScreenInfo.MyDashboard.cdeMID;
            this.mDashboardScreen = cdeNMI.MyScreenManager ? cdeNMI.MyScreenManager.GetScreenByID(pScreenID) : null;
            if (!this.mDashboardScreen) {
                this.mDashboardScreen = new cdeNMI.TheNMIScreen();
                this.mDashboardScreen.InitControl(null, null, tScreenInfo.MyDashboard.PropertyBag, cde.GuidToString(tScreenInfo.MyDashboard.cdeMID));
                this.mDashboardScreen.SetProperty("MyDashboard", this);
                IsNewDashboard = true;
                this.mDashboardScreen.SetProperty("Visibility", false);
            }
            this.mDashboardScreen.SetProperty("IsDashboard", true);
            if (this.mTileCount > 0 && tScreenInfo.MyDashboard["InitialState"] === "error")
                return;
            this.mDashboardScreen.Clear(false);
            this.mScreenIDs = [];
            this.SetElement(this.mDashboardScreen.GetElement());
            if (!tScreenInfo.MyDashboard["Title"] && tScreenInfo.MyDashboard.DashboardTitle)
                tScreenInfo.MyDashboard["Title"] = tScreenInfo.MyDashboard.DashboardTitle; //3.2 Compat
            if (tScreenInfo.MyDashboard["Title"] && tScreenInfo.MyDashboard["Title"].length > 0) {
                this.mDashboardScreen.SetProperty("Title", tScreenInfo.MyDashboard["Title"]);
            }
            let tDashPanels;
            try {
                for (const element of tScreenInfo.MyDashPanels) {
                    element["Category"] = cdeNMI.ThePB.GetValueFromBagByName(element.PropertyBag, "Category", true);
                    element["PanelTitle"] = cdeNMI.ThePB.GetValueFromBagByName(element.PropertyBag, "Caption");
                }
                tDashPanels = cdeNMI.SortArrayEx(tScreenInfo.MyDashPanels, "Category,FldOrder,PanelTitle", false, false);
            }
            catch (eee) {
                tDashPanels = tScreenInfo.MyDashPanels;
            }
            let lastCate = "";
            let tTileGroup = null;
            let tTileCount = 0;
            let i;
            for (i = 0; i < tDashPanels.length; i++) {
                const tCategory = tDashPanels[i]["Category"];
                if (i === 0 || lastCate !== tCategory && cdeNMI.ThePB.GetValueFromBagByName(tDashPanels[i].PropertyBag, "Visibility") !== "false") {
                    let tTitle = "";
                    if (tCategory !== " NA" && !cde.IsNotSet(tCategory)) {
                        tTitle = tCategory;
                    }
                    if (tTitle.substring(tTitle.length - 5) === "-HIDE")
                        tTitle = " ";
                    tTileGroup = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileGroup).Create(null);
                    tTileGroup.SetProperty("LabelElement", "h1");
                    tTileGroup.SetProperty("LabelClassName", "cdeDashCategory");
                    tTileGroup.SetProperty("ClassName", "cdeDashCategory cdeTiles");
                    if (tTitle.substring(tTitle.length - 5) !== "-NONE") {
                        let dots = 0;
                        for (const element of tTitle) {
                            if (element !== ".")
                                break;
                            dots++;
                        }
                        tTitle = tTitle.substring(dots);
                        tTileGroup.SetProperty("Caption", tTitle);
                    }
                    this.mDashboardScreen.AppendChild(tTileGroup);
                    lastCate = tCategory;
                }
                const tLabelClass = cdeNMI.ThePB.GetValueFromBagByName(tDashPanels[i].PropertyBag, "CategoryLabelClassName");
                if (tLabelClass) {
                    tTileGroup.SetProperty("LabelClassName", tLabelClass);
                }
                let pDashType = new Array();
                if (tDashPanels[i].ControlClass)
                    pDashType = tDashPanels[i].ControlClass.split(':');
                else
                    pDashType[0] = "";
                const tClass = cdeNMI.ThePB.GetValueFromBagByName(tDashPanels[i].PropertyBag, "CategoryClassName");
                const tHideFromSideBar = cde.CBool(cdeNMI.ThePB.GetValueFromBagByName(tDashPanels[i].PropertyBag, "HideFromSideBar"));
                const tRSB = cde.CBool(cdeNMI.ThePB.GetValueFromBagByName(tDashPanels[i].PropertyBag, "RSB"));
                if (tClass)
                    tTileGroup.SetProperty("ClassName", tClass);
                let tOnClick = null;
                let tStyleExt = "";
                let IsForm = false;
                let tNeverHide = false;
                let tHasRenderTarget = false;
                let tTargetScreen = null;
                let tPanelTitle = cdeNMI.ThePB.GetValueFromBagByName(tDashPanels[i].PropertyBag, "Caption");
                if (!tPanelTitle) {
                    tPanelTitle = "";
                }
                switch (pDashType[0]) {
                    case "cdeUpdater":
                        tOnClick = () => { cdeNMI.RequestUpdate(); };
                        tStyleExt = "background-color: green; color: white;";
                        break;
                    case "jsAction":
                        if (pDashType.length < 2)
                            continue;
                        tOnClick = tDashPanels[i].ControlClass;
                        break;
                    case "CMyInfo":
                        break;
                    case "CMyNavigator":
                        if (pDashType.length > 1) {
                            tOnClick = () => {
                                if (cdeNMI.MyScreenManager)
                                    cdeNMI.MyScreenManager.TransitToScreen(pDashType[1]);
                            };
                            this.mScreenIDs.push(pDashType[1]);
                        }
                        break;
                    default:
                        {
                            tTargetScreen = cdeNMI.MyScreenManager ? cdeNMI.MyScreenManager.GetScreenByID(tDashPanels[i].cdeMID) : null;
                            let tForceLoad = cde.CBool(cde.CBool(cdeNMI.ThePB.GetValueFromBagByName(tDashPanels[i].PropertyBag, "ForceLoad")) || cdeNMI.ThePB.GetValueFromBagByName(tDashPanels[i].PropertyBag, "DefaultPortal") != null || (tPanelTitle.substring(tPanelTitle.length - 5) !== "-HIDE" && (cdeNMI.ThePB.GetValueFromBagByName(tDashPanels[i].PropertyBag, "HTMLUrl") !== null || cdeNMI.ThePB.GetValueFromBagByName(tDashPanels[i].PropertyBag, "HTML") !== null)));
                            if (cdeNMI.ThePB.GetValueFromBagByName(tDashPanels[i].PropertyBag, "RenderTarget")) {
                                tHasRenderTarget = true;
                                tNeverHide = cde.CBool(cdeNMI.ThePB.GetValueFromBagByName(tDashPanels[i].PropertyBag, "NeverHide"));
                                if (!tForceLoad)
                                    tForceLoad = tNeverHide;
                            }
                            let tLoadSubScreens = tForceLoad;
                            let tRRT = false;
                            if (!tTargetScreen) {
                                tTargetScreen = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.Screen, true);
                                if (!tTargetScreen)
                                    continue;
                                tTargetScreen.MyHostNode = tDashPanels[i].cdeN;
                                //debugger
                                tTargetScreen.InitControl(tHasRenderTarget ? null : cdeNMI.MyScreenManager, null, tDashPanels[i].PropertyBag, cde.GuidToString(tDashPanels[i].cdeMID));
                                if (!cde.CBool(cdeNMI.ThePB.GetValueFromBagByName(tDashPanels[i].PropertyBag, "IsPinned")) && !tNeverHide)
                                    tTargetScreen.SetProperty("Visibility", false);
                                if (tDashPanels[i].HtmlContent)
                                    tTargetScreen.AppendContent(tDashPanels[i].HtmlContent);
                                else {
                                    tTargetScreen.SetProperty("ClassName", pDashType[0]);
                                    tTargetScreen.AppendContent("<h1 class='cdeHeadline'>Loading...please wait</h1><progress>loading...</progress>");
                                }
                                tLoadSubScreens = true;
                                this.mDashboardScreen.MyChildren[cde.GuidToString(tDashPanels[i].cdeMID)] = tTargetScreen;
                            }
                            else {
                                tRRT = true;
                            }
                            if (tLoadSubScreens || tRSB || tScreenInfo.ForceReload || tDashPanels[i].ControlClass === "CMyLiveScreen") {
                                if (cdeNMI.MyEngine) {
                                    if (pDashType.length > 1 && pDashType[1] !== "" && !cdeNMI.MyEngine.HasDataToFetch(cde.GuidToString(tDashPanels[i].cdeMID) + ":" + tDashPanels[i].ControlClass)) {
                                        cdeNMI.MyEngine.AddDataToFetch(cde.GuidToString(tDashPanels[i].cdeMID) + ":" + tDashPanels[i].ControlClass + ":" + cde.GuidToString(this.MyScreenID) + ":true");
                                        if (tForceLoad)
                                            cdeNMI.MyEngine.CheckDataToFetch(cde.GuidToString(tDashPanels[i].cdeMID));
                                    }
                                }
                                else {
                                    this.FireEvent(true, "FetchData", cde.GuidToString(tDashPanels[i].cdeMID) + ":" + tDashPanels[i].ControlClass + ":" + cde.GuidToString(this.MyScreenID) + ":true");
                                }
                            }
                            if (tDashPanels[i].Flags && (tDashPanels[i].Flags & 8) !== 0)
                                tTargetScreen.SetProperty("NoShowAll", true);
                            if (pDashType[0] === "CMyDashboard") {
                                tTargetScreen.SetProperty("IsDashboard", true);
                            }
                            tTargetScreen.SetProperty("ControlClass", tDashPanels[i].ControlClass);
                            tTargetScreen.SetProperty("DashID", this.MyScreenID);
                            let tSTitle = cdeNMI.ThePB.GetValueFromBagByName(tDashPanels[i].PropertyBag, "ScreenTitle");
                            if (!tSTitle)
                                tSTitle = cdeNMI.ThePB.GetValueFromBagByName(tDashPanels[i].PropertyBag, "Title");
                            tTargetScreen.SetProperty("ScreenTitle", tSTitle);
                            if (tPanelTitle.substring(tPanelTitle.length - 5) === "-HIDE" || tHideFromSideBar === true) {
                                tTargetScreen.SetProperty("HideFromSideBar", true);
                            }
                            tTargetScreen.SetProperty("Description", cdeNMI.ThePB.GetValueFromBagByName(tDashPanels[i].PropertyBag, "Description"));
                            tTargetScreen.SetProperty("HidePins", cde.CBool(cdeNMI.ThePB.GetValueFromBagByName(tDashPanels[i].PropertyBag, "HidePins")));
                            tTargetScreen.SetProperty("HidePinPins", cde.CBool(cdeNMI.ThePB.GetValueFromBagByName(tDashPanels[i].PropertyBag, "HidePinPins")));
                            tTargetScreen.SetProperty("IsPopup", cde.CBool(cdeNMI.ThePB.GetValueFromBagByName(tDashPanels[i].PropertyBag, "IsPopup")));
                            tOnClick = (pSender, evt, pointer) => {
                                if (cdeNMI.MyScreenManager) {
                                    if (evt.button === 2)
                                        cdeNMI.MyScreenManager.TransitToScreen(pSender.GetProperty("cdeMID"));
                                    else
                                        cdeNMI.MyScreenManager.TransitToScreen(pSender.GetProperty("DefaultPortal"));
                                }
                            };
                            this.mScreenIDs.push(tDashPanels[i].cdeMID);
                            if (cdeNMI.MyScreenManager && !tNeverHide) { // !tHasRenderTarget) {
                                cdeNMI.MyScreenManager.RegisterScreen(tTargetScreen.MyScreenID, tTargetScreen, true);
                                if (!tRRT)
                                    cdeNMI.MyScreenManager.TransitToWaitingScreen(cde.GuidToString(tDashPanels[i].cdeMID));
                            }
                            tTileCount++;
                            IsForm = true;
                        }
                        break;
                }
                if (tPanelTitle.substring(tPanelTitle.length - 5) !== "-HIDE" && !tNeverHide) {
                    const tTileButton = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(tTileGroup, { PreInitBag: ["IsCustomTile=" + cde.CBool(cdeNMI.ThePB.GetValueFromBagByName(tDashPanels[i].PropertyBag, "IsCustomTile"))], PostInitBag: ["ControlTW=2", "ControlTH=2", "Title=" + tPanelTitle, "Style=" + tStyleExt] });
                    tTileButton.SetProperty("OnClick", tOnClick);
                    tTileButton.SetProperty("TabIndex", tDashPanels[i].FldOrder + 101);
                    if (IsForm) {
                        tTileButton.MyTRF = new cdeNMI.TheTRF(cde.GuidToString(tDashPanels[i].cdeO), 0, new cdeNMI.TheFieldInfo(cdeNMI.cdeControlType.TileButton, 2, tPanelTitle, 2)); //.cdeO was .cdeMID
                        tTileButton.MyTRF.ModelID = this.MyScreenID;
                        tTileButton.MyFieldInfo = tTileButton.MyTRF.FldInfo;
                        tTileButton.MyFieldInfo.FldOrder = tDashPanels[i].FldOrder;
                        tTileButton.MyFieldInfo.cdeO = tDashPanels[i].cdeO;
                        tTileButton.MyFieldInfo.cdeN = tDashPanels[i].cdeN;
                        tTileButton.MyFieldInfo.cdeMID = tDashPanels[i].cdeMID;
                    }
                    else {
                        tTileButton.SetProperty("UXID", cde.GuidToString(tDashPanels[i].cdeMID));
                    }
                    tTileButton.SetProperty("ID", "DASH_" + cde.GuidToString(tDashPanels[i].cdeMID));
                    tTileButton.RegisterNMIControl();
                    this.mDashboardScreen.MyChildren[cde.GuidToString(tDashPanels[i].cdeMID)] = tTileButton;
                    tTileButton.SetProperty("cdeMID", tDashPanels[i].cdeMID);
                    if (cdeNMI.ThePB.GetValueFromBagByName(tDashPanels[i].PropertyBag, "DefaultPortal") != null)
                        tTileButton.SetProperty("DefaultPortal", cde.CStr(cdeNMI.ThePB.GetValueFromBagByName(tDashPanels[i].PropertyBag, "DefaultPortal")));
                    else
                        tTileButton.SetProperty("DefaultPortal", tDashPanels[i].cdeMID);
                    if (tDashPanels[i].PropertyBag) {
                        cdeNMI.ThePB.SetPropertiesFromBag(tTileButton, tDashPanels[i].PropertyBag, tDashPanels); //ok..is after InitControl
                        if (tTileButton.GetProperty("IsRefresh"))
                            this.mDashboardScreen.MyRefreshButton = tTileButton;
                    }
                    if (cdeNMI.MyEngine && cdeNMI.MyEngine.IsNodeDown(tDashPanels[i].cdeN)) {
                        tTileButton.SetProperty("IsOwnerDown", true);
                    }
                    if (tTargetScreen) {
                        tTargetScreen.MyRC = this.mTileCount;
                        if (!tTargetScreen.GetProperty("NUITags"))
                            tTargetScreen.SetProperty("NUITags", "Screen " + TheDashboard.AllTileCount++);
                        if (tTargetScreen.MyNMIControl) {
                            tTargetScreen.MyNMIControl.FireEvent(true, "RRT");
                        }
                    }
                    this.mTileCount++;
                }
                else {
                    if (tTargetScreen)
                        tTargetScreen.SetProperty("IsHidden", true);
                }
            }
            if (tTileCount > 1) {
                if (cde.CBool(tScreenInfo.MyDashboard["HideShowAll"]) === false) {
                    this.mDashboardScreen.MyShowAllPin.SetProperty("Visibility", true);
                    this.mDashboardScreen.MyShowAllPin.SetProperty("OnClick", () => {
                        this.ShowAllScreens();
                    });
                }
            }
            this.mDashboardScreen.SetInitialized(true);
            if (IsNewDashboard) {
                if (!cde.MyBaseAssets.MyServiceHostInfo.WasInitialScreenVisible) {
                    if (cde.MyBaseAssets.MyCommStatus.LastStartScreen) {
                        cdeNMI.MyEngine.GetScene(cde.MyBaseAssets.MyCommStatus.LastStartScreen);
                    }
                    else if (cde.MyBaseAssets.MyServiceHostInfo.StartScreen !== "" && tScreenInfo.MyDashboard["InitialState"] !== "error")
                        cdeNMI.MyScreenManager.GotoStationHome(false);
                    else {
                        if (tScreenInfo.MyDashboard["InitialState"] && tScreenInfo.MyDashboard["InitialState"] !== "error")
                            cdeNMI.MyScreenManager.TransitToScreen(tScreenInfo.MyDashboard["InitialState"]);
                        else {
                            cdeNMI.MyScreenManager.GotoStationHome(false);
                        }
                    }
                }
                if (cdeNMI.MyScreenManager) {
                    cdeNMI.MyScreenManager.RegisterScreen(this.mDashboardScreen.MyScreenID, this.mDashboardScreen, false);
                    cdeNMI.MyScreenManager.TransitToWaitingScreen(this.mDashboardScreen.MyScreenID);
                }
            }
        }
        ShowAllScreens() {
            const mScreenIDs = this.mScreenIDs;
            for (const id in mScreenIDs) {
                if (Object.prototype.hasOwnProperty.call(mScreenIDs, id)) {
                    const tScreen = cdeNMI.MyScreenManager ? cdeNMI.MyScreenManager.GetScreenByID(mScreenIDs[id]) : null;
                    if (tScreen && !cde.CBool(tScreen.GetProperty("NoShowAll"))) {
                        tScreen.SetProperty("IsPinned", true);
                        if (cdeNMI.MyEngine)
                            cdeNMI.MyEngine.CheckDataToFetch(mScreenIDs[id]);
                        const isVisible = tScreen.GetProperty("Visibility") ? false : true;
                        tScreen.SetProperty("Visibility", isVisible);
                        tScreen.ShowPin();
                    }
                }
            }
        }
    }
    TheDashboard.AllTileCount = 0;
    cdeNMI.TheDashboard = TheDashboard;
})(cdeNMI || (cdeNMI = {}));
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
var cdeNMI;
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
(function (cdeNMI) {
    /////////////////////////////////////////////////////////////////////////
    /////***********************************************
    /////   C-DMyForms GENERATOR
    /////***********************************************
    /**
    * Creates a complete form for a given StorageMirror
    *
    * (4.1 Ready!)
    */
    class ctrlFormView extends cdeNMI.TheDataViewBase {
        constructor(pTRF) {
            super(pTRF);
            this.MyScreenInfo = null;
            this.MyFormInfo = null;
            this.mBaseDiv = null;
            this.formMain = null;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.FormView;
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            if (!this.MyTRF) {
                return false;
            }
            this.MyTableName = cde.GuidToString(this.MyTRF.TableName);
            this.MyStorageName = this.GetSetting("TableReference");
            if (!this.MyStorageName)
                this.MyStorageName = this.MyTableName;
            this.MyScreenInfo = cdeNMI.MyNMIModels[this.MyScreenID];
            const pClassName = 'CMyForm';
            let tRenderTarget = null;
            if (!tRenderTarget)
                tRenderTarget = 'Inline_' + cde.GuidToString(this.MyTableName);
            const tDiv = document.getElementById(tRenderTarget);
            if (tDiv)
                this.mBaseDiv = tDiv;
            if (!this.mBaseDiv && !pTargetControl && this.MyScreenInfo.MyStorageMeta[this.MyTableName]) {
                this.mBaseDiv = document.getElementById('Content_' + cde.GuidToString(this.MyScreenInfo.MyStorageMeta[this.MyTableName].TargetElement));
            }
            if (!this.mBaseDiv) {
                this.mBaseDiv = document.createElement("div");
                this.mBaseDiv.className = pClassName;
                if (this.MyTarget) {
                    const tF = cdeNMI.MyTCF.GetRegisteredControl("TABLES", this.MyTableName);
                    if (tF)
                        tF.RemoveFormHooks(tF.MyFormControls);
                    this.MyTarget.GetElement().innerHTML = ""; //OK
                }
            }
            else {
                const tF = cdeNMI.MyTCF.GetRegisteredControl("TABLES", this.MyTableName);
                if (tF)
                    tF.RemoveFormHooks(tF.MyFormControls);
                this.mBaseDiv.innerHTML = ""; //OK
            }
            this.mBaseDiv.style.width = "inherit";
            this.mBaseDiv.style.height = "inherit";
            this.mBaseDiv.style.margin = "auto";
            this.SetElement(this.mBaseDiv);
            const tCurrentRow = cde.CInt(this.MyTRF.RowNo);
            if (this.MyFieldInfo && cde.CBool(this.MyFieldInfo["ILF"]) && !this.MyScreenInfo.IsLiveForm)
                this.MyScreenInfo.IsLiveForm = true;
            if (!this.MyScreenInfo.IsLiveForm && !this.MyScreenInfo.MyStorageMirror[this.MyStorageName] && !this.MyScreenInfo.MyStorageMeta[this.MyTableName]) {
                this.formMain = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileGroup).Create(this);
                cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SmartLabel).Create(this.formMain, { PreInitBag: ["Element=h1"], PostInitBag: ["iValue=Neither meta-data nor storage data defined"] });
            }
            else {
                if ((this.MyScreenInfo.IsLiveForm || this.MyScreenInfo.MyStorageMirror[this.MyStorageName]) && tCurrentRow >= 0) {
                    cdeNMI.MyEngine.RegisterEvent("RecordUpdated_" + this.MyStorageName + "_" + tCurrentRow, (pSI, pModelGUID, tTabName, tRowID) => {
                        //Updates a form from changes in the corresponding table p- but no templates or wizards (they should always be blank)
                        if (pModelGUID && pModelGUID !== "" && !this.GetSetting("TableReference")) {
                            const tMod = cdeNMI.MyNMIModels[pModelGUID];
                            for (const cc in this.MyFormControls) {
                                const tN = this.MyFormControls[cc].GetProperty("DataItem");
                                if (tN) {
                                    if (!Object.prototype.hasOwnProperty.call(tMod.MyStorageMirror[tTabName][tRowID], 'SecToken')) {
                                        const tCont = cdeNMI.GetFldContent(tMod.MyStorageMirror[tTabName][tRowID], this.MyFormControls[cc].MyFieldInfo, this.MyScreenInfo.IsGenerated);
                                        if (this.MyFormControls[cc].GetProperty("Value") !== tCont)
                                            this.MyFormControls[cc].SetProperty("iValue", tCont);
                                    }
                                }
                            }
                            this.ValidateRules(pModelGUID, null, tTabName, tRowID, this.MyFormControls, true, false); //Runs values change in a table against the form - no push to Relay
                        }
                    });
                    if (!this.MyScreenInfo.IsLiveForm) {
                        if (!this.MyScreenInfo.MyStorageMirror[this.MyStorageName][tCurrentRow] || !this.MyScreenInfo.MyStorageMirror[this.MyStorageName][tCurrentRow].cdeM || this.MyScreenInfo.MyStorageMirror[this.MyStorageName][tCurrentRow].cdeM === "") {
                            if (!this.MyScreenInfo.MyStorageMeta[this.MyTableName] || this.MyScreenInfo.MyStorageMeta[this.MyTableName].FormFields.length === 0) {
                                if (!this.MyScreenInfo.MyStorageMeta[this.MyTableName]) {
                                    this.MyScreenInfo.MyStorageMeta[this.MyTableName] = new cdeNMI.TheFormInfo();
                                    this.MyScreenInfo.MyStorageMeta[this.MyTableName].FormTitle = this.MyTableName;
                                    this.MyScreenInfo.MyStorageMeta[this.MyTableName].FormFields = [];
                                }
                                this.CreateFormInfo(this.MyScreenInfo.MyStorageMirror[this.MyStorageName][tCurrentRow], "", this.MyScreenInfo.MyStorageMeta[this.MyTableName], 0);
                                this.MyScreenInfo.IsGenerated = true;
                            }
                        }
                        else {
                            this.MyScreenInfo.MyStorageMeta[this.MyTableName] = JSON.parse(this.MyScreenInfo.MyStorageMirror[this.MyStorageName][tCurrentRow].cdeM);
                        }
                    }
                }
                if (!this.MyScreenInfo.MyStorageMeta[this.MyTableName] || this.MyScreenInfo.MyStorageMeta[this.MyTableName].FormFields.length === 0) {
                    this.formMain = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileGroup).Create(this);
                    cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SmartLabel).Create(this.formMain, { PreInitBag: ["Element=h1"], PostInitBag: ["iValue=This form does not contain any controls, yet"] });
                }
                else {
                    this.MyFormInfo = this.MyScreenInfo.MyStorageMeta[this.MyTableName];
                    let tC = this;
                    if (this.MyFormInfo.IsUsingAbsolute) {
                        tC = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileGroup).Create(this);
                        tC.SetProperty("ClassName", "cdeRelativeDiv");
                    }
                    this.formMain = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileGroup).Create(tC);
                    this.formMain.cdeMID = this.MyScreenInfo.cdeMID;
                    if (this.MyFieldInfo && this.MyFieldInfo["TitleClassName"])
                        this.formMain.SetProperty("LabelClassName", this.MyFieldInfo["TitleClassName"]);
                    else
                        this.formMain.SetProperty("LabelClassName", "cdeFormTitle");
                    this.formMain.SetProperty("IsSmall", true);
                    this.formMain.SetProperty("Float", "none");
                    this.formMain.SetProperty("HidePins", true);
                    const icn = cdeNMI.ThePB.GetValueFromBagByName(this.MyFormInfo.PropertyBag, "InnerClassName");
                    if (icn) {
                        this.formMain.SetProperty("ClassName", icn);
                    }
                    else {
                        if (this.MyFormInfo.IsUsingAbsolute) {
                            this.formMain.SetProperty("ClassName", "CMyCanvas");
                        }
                        else {
                            this.formMain.SetProperty("ClassName", "cdeInnerForm");
                        }
                    }
                    //Set Form Properties from Bag
                    const tCap = cdeNMI.ThePB.GetValueFromBagByName(this.MyFormInfo.PropertyBag, "Caption");
                    if (tCap && cdeNMI.MyScreenManager) {
                        const tSCreen = cdeNMI.MyScreenManager.GetScreenByID(this.MyTableName);
                        if (tSCreen)
                            tSCreen.SetProperty("Caption", tCap);
                        cdeNMI.ThePB.RemoveProperty(this.MyFormInfo.PropertyBag, "Caption");
                    }
                    const bUseMargin = cde.CBool(cdeNMI.ThePB.GetValueFromBagByName(this.MyFormInfo.PropertyBag, "UseMargin"));
                    cdeNMI.ThePB.SetPropertiesFromBag(this.formMain, this.MyFormInfo.PropertyBag);
                    if (this.MyFormInfo.IsUsingAbsolute) {
                        tC.SetProperty("TileWidth", this.formMain.GetProperty("TileWidth"));
                        tC.SetProperty("TileHeight", this.formMain.GetProperty("TileHeight"));
                    }
                    else {
                        this.formMain.GetElement().style.width = "fit-content";
                        this.formMain.GetElement().style.maxWidth = "unset";
                    }
                    let tRowID = null;
                    if (this.MyScreenInfo.MyStorageMirror[this.MyStorageName] && tCurrentRow >= 0) {
                        this.MyDataRow = this.MyScreenInfo.MyStorageMirror[this.MyStorageName][tCurrentRow];
                        if (this.MyScreenInfo.MyStorageMirror[this.MyStorageName][tCurrentRow] && this.MyScreenInfo.MyStorageMirror[this.MyStorageName][tCurrentRow].cdeMID)
                            tRowID = this.MyScreenInfo.MyStorageMirror[this.MyStorageName][tCurrentRow].cdeMID;
                    }
                    const tFormFields = cdeNMI.SortArrayByProperty(this.MyFormInfo.FormFields, "FldOrder", true, false);
                    for (const tFldInfo of tFormFields) {
                        if (tFldInfo && (tFldInfo.Flags & 16) !== 0)
                            continue; //Skip if NoShowInForm is set
                        const tFldID = this.MyStorageName + '_' + tCurrentRow + '_' + tFldInfo.FldOrder;
                        //Set tFldInfo with Extra Properties from PropertyBag
                        cdeNMI.ThePB.ConvertPropertiesFromBag(tFldInfo);
                        //Calculate Parent Field
                        let fldParent = this.formMain;
                        const PFldNo = cde.CInt(tFldInfo["ParentFld"]);
                        if (PFldNo > 0 && PFldNo < tFldInfo.FldOrder) {
                            if (this.MyFormControls[this.MyStorageName + '_' + tCurrentRow + '_' + PFldNo])
                                fldParent = this.MyFormControls[this.MyStorageName + '_' + tCurrentRow + '_' + PFldNo];
                            else
                                continue; //No draw if parent is not found
                        }
                        //Calculate TRF of Control
                        let tOwnerThingID = this.MyStorageName;
                        const tTRF = new cdeNMI.TheTRF(tOwnerThingID, tCurrentRow, tFldInfo);
                        tTRF.RowID = tRowID;
                        tTRF.ModelID = this.MyScreenID;
                        tFldInfo["IsInTable"] = false;
                        switch (tFldInfo.Type) {
                            case cdeNMI.cdeControlType.Table:
                                {
                                    const tTE = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileEntry).Create(fldParent, { ScreenID: this.MyScreenID, TRF: tTRF, PostInitBag: ["ContentOuterClassName=cdeTableInline", "ContainerClassName=cdeTableTEContainer"] });
                                    this.MyFormControls[tFldID] = tTE;
                                    if (cdeNMI.MyTCF)
                                        cdeNMI.MyTCF.RegisterControl(cde.GuidToString(tFldInfo.cdeMID), "TE", tTE);
                                    tTE.MyDataView = this;
                                    tTE.CreateControl(tFldID, () => {
                                        //ignored
                                    });
                                    if (tFldInfo && tFldInfo.PropertyBag && tFldInfo.PropertyBag.length > 0) {
                                        cdeNMI.ThePB.SetPropertiesFromBag(tTE, tFldInfo.PropertyBag, null, false, false);
                                    }
                                }
                                continue;
                            case cdeNMI.cdeControlType.CollapsibleGroup:
                                this.MyFormControls[tFldID] = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.CollapsibleGroup).Create(fldParent, { TRF: tTRF });
                                if (bUseMargin === true)
                                    this.MyFormControls[tFldID].SetProperty("UseMargin", true);
                                break;
                            case cdeNMI.cdeControlType.TileGroup:
                                this.MyFormControls[tFldID] = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileGroup).Create(fldParent, { TRF: tTRF });
                                this.MyFormControls[tFldID].SetProperty("ClassName", "cdeTileGroup");
                                break;
                            case cdeNMI.cdeControlType.FormButton:
                                switch (tFldInfo.DataItem) {
                                    case "CDE_DELETE":
                                        if (tFldInfo["TableReference"]) {
                                            this.MyFormControls[tFldID] = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(fldParent, { PreInitBag: ["ControlTW=1", "ControlTH=1"], PostInitBag: ["Title=<span class='fa fa-3x'>&#xf1f8;</span>", "ClassName=cdeBadActionButton cdeDeleteButton"] });
                                            this.MyFormControls[tFldID].SetProperty("OnClick", (pSender, evt) => {
                                                const tMe = pSender;
                                                if (evt.shiftKey) {
                                                    tMe.DeleteRecord(tMe.MyDataRow);
                                                    cdeNMI.MyScreenManager.TransitToScreen(tFldInfo["TableReference"]);
                                                }
                                                else {
                                                    if (cdeNMI.MyPopUp)
                                                        cdeNMI.MyPopUp.Show('Are you sure you want to delete this record? ', false, null, 1, () => {
                                                            tMe.DeleteRecord(tMe.MyDataRow);
                                                            cdeNMI.MyScreenManager.TransitToScreen(tFldInfo["TableReference"]);
                                                        }, null, tMe.MyDataRow, tMe);
                                                }
                                            });
                                            if (!this.MyDataRow)
                                                this.MyFormControls[tFldID].SetProperty("Disabled", true);
                                        }
                                        break;
                                }
                                break;
                            default:
                                {
                                    const tTE = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileEntry).Create(fldParent, { ScreenID: this.MyScreenID, TRF: tTRF });
                                    this.MyFormControls[tFldID] = tTE;
                                    tTE.MyDataView = this;
                                    tTE.CreateControl(tFldID, (e) => {
                                        e.SetProperty("OnValueChanged", (sender) => {
                                            let tLocalOnly = this.MyFormInfo.IsPostingOnSubmit;
                                            if (this.MyScreenInfo.IsLiveForm && cdeNMI.MyEngine) {
                                                cdeNMI.MyEngine.PublishToNMI('SETP', sender.MyFieldInfo.DataItem + '=' + sender.GetProperty("Value"), sender.MyFieldInfo.cdeO, true); //ThingProperties
                                                tLocalOnly = true;
                                            }
                                            //Checks rules after each ValueChange. tLocalOnly is true for Templates and Wizards
                                            this.ValidateRules(this.MyScreenID, this.MyTableName, this.MyStorageName, sender.MyTRF ? sender.MyTRF.RowNo : 0, this.MyFormControls, tLocalOnly, false); //if IsPostingOnSubmit is true, no push to node
                                        });
                                        if (e.MyBaseType === cdeNMI.cdeControlType.TileButton && cde.CBool(e.GetProperty("IsSubmit")) === true) { //Wizard and Template submit
                                            e.SetProperty("OnClick", (sender) => {
                                                this.ValidateRules(this.MyScreenID, this.MyTableName, this.MyStorageName, sender.MyTRF ? sender.MyTRF.RowNo : 0, this.MyFormControls, false, true); //Submit button pushed - all values will be written and sent to Node
                                                if (!this.PropertyBag["FinishPage"] && !this.PropertyBag["ProcessingPage"]) {
                                                    if (this.PropertyBag["FinishScreenID"]) {
                                                        const tScrParts = this.PropertyBag["FinishScreenID"];
                                                        if (tScrParts === "CLOSE") {
                                                            const tLast = cdeNMI.MyScreenManager.GetCurrentScreen();
                                                            if (tLast) {
                                                                const tOld = tLast.GetProperty("OldScreen");
                                                                if (tOld)
                                                                    cdeNMI.MyScreenManager.TransitToScreen(tOld);
                                                            }
                                                        }
                                                        else {
                                                            cdeNMI.MyScreenManager.TransitToScreen(tScrParts); // this.PropertyBag["FinishScreenID"]);
                                                        }
                                                    }
                                                    else if (this.MyTRF.FldInfo["TableReference"])
                                                        cdeNMI.MyScreenManager.TransitToScreen(this.MyTRF.FldInfo["TableReference"]);
                                                }
                                            });
                                        }
                                    });
                                }
                                continue;
                        }
                        cdeNMI.MyTCF.SetControlEssentials(this.MyFormControls[tFldID], this.MyFormControls[tFldID], tTRF);
                    }
                }
            }
            this.ValidateRules(this.MyScreenID, this.MyTableName, this.MyStorageName, tCurrentRow, this.MyFormControls, true, false); //Just verify all rules on the form
            cdeNMI.TheFlashCache.FlushCache();
            this.RegisterEvent("RRT", () => { this.RenderRenderTargets(); });
            this.SetProperty("ID", "FORM_" + this.MyTableName);
            this.RegisterNMIControl();
            return true;
        }
        OnLoad(bIsVisible) {
            if (this.GetProperty("TTSCookie") && cdeNMI.MyScreenManager) {
                const tRID = this.GetProperty("TTSCookie");
                this.SetProperty("TTSCookie", null);
                cdeNMI.MyScreenManager.CreateDataViewScreen(this.MyScreenInfo, null, this.MyTableName, this.GetProperty("ExtraInfo"), this.MyTableName, false, tRID);
                return;
            }
            else {
                if (this.MyFieldInfo && this.MyFieldInfo["TableReference"] && this.MyFormInfo.IsAlwaysEmpty === true) {
                    cdeNMI.MyScreenManager.CreateDataViewScreen(this.MyScreenInfo, null, this.MyTableName, this.GetProperty("ExtraInfo"), this.MyTableName, true);
                }
            }
            if (this.GetProperty("StartGroup"))
                this.SetProperty("SetGroup", "GRP:" + this.GetProperty("StartGroup"));
            super.OnLoad(bIsVisible);
        }
        OnLoaded() {
            super.OnLoad();
        }
        SetProperty(pName, pValue) {
            if (pName === "TileWidth") {
                if (cde.CBool(this.GetProperty("UseMargin")))
                    pValue = cde.CInt(pValue) + 1;
            }
            super.SetProperty(pName, pValue);
            if (pName === "SetGroup") {
                cdeNMI.MyTCF.ToggleGroup(this.MyTableName, pValue.substr(4));
            }
        }
        ResetData() {
            for (const i in this.MyFormControls) {
                const tF = this.MyFormControls[i];
                if (tF.MyBaseType === cdeNMI.cdeControlType.TileEntry) {
                    tF.MyNMIControl.SetToDefault(false);
                }
            }
            return false;
        }
        ReloadData() {
            for (const i in this.MyFormControls) {
                const tF = this.MyFormControls[i];
                if (cde.CBool(tF.GetProperty("IsRefresh"))) {
                    if (tF.MyBaseType === cdeNMI.cdeControlType.TileEntry)
                        tF.DoFireClick(tF.MyNMIControl);
                    else
                        tF.DoFireClick(tF);
                    return true;
                }
            }
            return false;
        }
        RenderRenderTargets() {
            if (!this.MyFormInfo)
                return;
            const tFormFields = cdeNMI.SortArrayByProperty(this.MyFormInfo.FormFields, "FldOrder", true, false);
            for (const tFldInfo of tFormFields) {
                if (tFldInfo && (tFldInfo.Flags & 16) !== 0)
                    continue;
                if (tFldInfo["RenderTarget"]) {
                    const tCurrentRow = cde.CInt(this.MyTRF.RowNo);
                    const tFldID = this.MyTableName + '_' + tCurrentRow + '_' + tFldInfo.FldOrder;
                    const tTRF = new cdeNMI.TheTRF(this.MyTableName, tCurrentRow, tFldInfo);
                    tTRF.ModelID = this.MyScreenID;
                    const tTarget = cdeNMI.GenerateFinalString(tFldInfo["RenderTarget"], false, tTRF);
                    const tCtrl = this.MyFormControls[tFldID];
                    tCtrl.FindRenderTarget(tTarget);
                }
            }
        }
        DeleteRecord(pDataRow) {
            if (cdeNMI.MyEngine)
                cdeNMI.MyEngine.PublishToNMI('NMI_DEL_ID:' + this.MyTableName + ":" + pDataRow.cdeMID, pDataRow.cdeN);
        }
    }
    cdeNMI.ctrlFormView = ctrlFormView;
})(cdeNMI || (cdeNMI = {}));
// SPDX-FileCopyrightText: 2009-2023 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
var cdeNMI;
// SPDX-FileCopyrightText: 2009-2023 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
(function (cdeNMI) {
    class ctrlTableRow extends cdeNMI.TheNMIBaseControl {
        constructor(pTRF) {
            super(null, pTRF);
            this.mRow = null;
        }
        static Create(pTargetControl, pTRF, pRow, pIndex, pClassName, IsHeader) {
            const tTile = new ctrlTableRow(pTRF);
            if (pRow)
                tTile.mRow = pRow;
            tTile.InitControl(pTargetControl, pTRF);
            if (pClassName)
                tTile.SetProperty("ClassName", pClassName);
            return tTile;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.TableRow;
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            this.MyTRF = pTRF;
            if (!this.mRow)
                this.mRow = document.createElement("tr");
            this.SetElement(this.mRow);
            return null;
        }
        SetProperty(pName, pValue) {
            super.SetProperty(pName, pValue);
            if (pName === "ClassName" && this.mRow)
                this.mRow.className = pValue;
        }
        AppendChild(pChild) {
            this.mRow.appendChild(pChild.GetElement());
        }
    }
    cdeNMI.ctrlTableRow = ctrlTableRow;
    /**
     * Creates a table Cell
     *
     * (3.2 Ready!)
     */
    class ctrlTableCell extends cdeNMI.TheNMIBaseControl {
        constructor(pTRF) {
            super(null, pTRF);
            this.mCell = null;
            this.mRow = null;
        }
        static Create(pTargetControl, pTRF, pRow, pIndex, pClassName, IsHeader) {
            const tTile = new ctrlTableCell(pTRF);
            const tBag = [];
            if (IsHeader)
                tBag.push("IsHeader=true");
            if (pIndex)
                tBag.push("ColumnIndex=" + pIndex);
            if (pRow)
                tTile.mRow = pRow;
            tTile.InitControl(pTargetControl, pTRF, tBag);
            if (pClassName)
                tTile.SetProperty("ClassName", pClassName);
            return tTile;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.TableCell;
            if (!pTRF)
                pTRF = new cdeNMI.TheTRF(null, 0, new cdeNMI.TheFieldInfo(this.MyBaseType, 0, null));
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            if (this.mRow && this.MyFieldInfo)
                this.mCell = this.mRow.insertCell(cde.CInt(this.MyFieldInfo["ColumnIndex"]));
            else {
                if (this.MyFieldInfo && cde.CBool(this.MyFieldInfo["IsHeader"]))
                    this.mCell = document.createElement('th');
                else
                    this.mCell = document.createElement('td');
            }
            this.mCell.className = "cdeTabEntry";
            const bIsEdit = (pTRF.FldInfo.Flags & 2) !== 0;
            this.SetElement(this.mCell, bIsEdit); //true);
            return true;
        }
        SetProperty(pName, pValue) {
            super.SetProperty(pName, pValue);
            if (pName === "ClassName" && this.mCell)
                this.mCell.className = pValue;
            if (pName === "CellStyle" && this.mCell)
                this.mCell.style.cssText = pValue;
        }
        AppendChild(pChild) {
            this.MyChildren.push(pChild);
            this.mCell.appendChild(pChild.GetElement());
        }
    }
    cdeNMI.ctrlTableCell = ctrlTableCell;
    /**
* Creates a Table View of a given StorageMirror
* Requires TRF to be set with the Table Name!
*
* (3.2 Ready!)
*/
    class ctrlTableView extends cdeNMI.TheDataViewBase {
        constructor(pTRF) {
            super(pTRF);
            this.MyScreenInfo = null;
            this.MyFormInfo = null;
            this.MyTableTitle = null;
            this.btnAdder = null;
            this.inputFilter = null;
            this.InfoText = null;
            this.mBaseDiv = null;
            this.IsPropertyTable = false;
            this.IsNMIOnly = false;
            this.mSortFldID = -1;
            this.mColHeader = null;
            this.rowAdder = null;
            this.tableMain = null;
            this.tableContainer = null;
            this.tableBody = null;
            this.mTableRows = [];
            this.mCurrentFormFieldsInfo = null;
            this.MyMetaData = null;
            this.MyMirrorName = null;
            this.MyStorageModel = null;
            this.IsInEdit = false;
            this.MyNMIEditControl = null;
            this.AllowedNMIEditorProps = ["Style:1", "Visibility:4", "NUITags:1", "TEClassName:1", "TileFactorX:12", "TileFactorY:12", "Top:12",
                "Left:12", "Caption:1", "TileLeft:12", "TileTop:12", "MinValue:12", "MaxValue:12", "Title:1", "Format:1", "MainBackground:1", "Foreground:1",
                "Label:1", "LabelClassName:1", "LabelForeground:1", "TileWidth:12", "TileHeight:12", "PixelWidth:12", "PixelHeight:12", "Background:1",
                "ClassName:1", "IsAbsolute:4", "Opacity:12", "FontSize:12", "ParentFld:12", "NoTE:4"];
            //Drag Drop Functions
            this.mFileList = [];
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.Table;
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            const pTableInfo = this.GetSetting("ExtraInfo");
            if (pTableInfo) {
                const tStr = pTableInfo.split(':');
                if (tStr.length > 4)
                    this.SetProperty("PageSize", cde.CInt(tStr[4]));
                if (tStr.length > 5)
                    this.SetProperty("CurrentPage", cde.CInt(tStr[5]));
                if (tStr.length > 7)
                    this.SetProperty("CurrentFilter", tStr[7]);
            }
            if (!this.MyTRF) {
                console.log("pTRF HAS to be specified!");
                return false;
            }
            this.MyScreenInfo = cdeNMI.MyNMIModels[this.MyScreenID];
            this.SetProperty("NoTE", true);
            this.RegisterNMIControl();
            let pTableName = this.MyTRF.TableName;
            if (this.MyFieldInfo && this.MyFieldInfo.Type === cdeNMI.cdeControlType.Table && this.MyFieldInfo.DataItem)
                pTableName = this.MyFieldInfo.DataItem;
            ///Create Meta Data for Property Bag Table
            if (pTableName.substring(0, 13).toLowerCase() === "mypropertybag") {
                const tTableParas = pTableName.split(';');
                if (tTableParas.length > 2 && tTableParas[1] == '2') {
                    const tFldId = cde.GuidToString(tTableParas[2]);
                    this.IsNMIOnly = true;
                    pTableName = cde.GuidToString("PBX" + tFldId);
                    const tControls = cdeNMI.MyTCF.MyNMIControls[tFldId];
                    if (tControls) {
                        for (const tControl in tControls) {
                            this.MyNMIEditControl = tControls[tControl];
                            this.RefreshControlPropTable(pTableName, tControls[tControl]);
                        }
                    }
                    else {
                        if (pTargetControl)
                            pTargetControl.GetElement().innerHTML = "Target Control not registered and cannot be edited";
                    }
                }
                else {
                    this.MyMirrorName = this.MyTRF.TableName;
                    if (tTableParas.length > 3) {
                        const tM = cde.GuidToString(tTableParas[2]);
                        const tT = cde.GuidToString(tTableParas[3]);
                        if (!cdeNMI.MyNMIModels[tM] || !cdeNMI.MyNMIModels[tM].MyStorageMirror[tT] || !cdeNMI.MyNMIModels[tM].MyStorageMirror[tT][this.MyTRF.RowNo] || !cdeNMI.MyNMIModels[tM].MyStorageMirror[tT][this.MyTRF.RowNo].MyPropertyBag) {
                            if (pTargetControl)
                                pTargetControl.GetElement().innerHTML = "Store of Thing or No Properties found";
                            return false;
                        }
                        this.MyStorageModel = cdeNMI.MyNMIModels[tM].MyStorageMirror[tT];
                        this.MyMirrorName = tT;
                    }
                    else {
                        if (!this.MyTRF || !this.MyFieldInfo || !this.MyScreenInfo.MyStorageMirror[this.MyMirrorName] || !this.MyScreenInfo.MyStorageMirror[this.MyMirrorName][this.MyTRF.RowNo] || !this.MyScreenInfo.MyStorageMirror[this.MyMirrorName][this.MyTRF.RowNo].MyPropertyBag) {
                            if (pTargetControl)
                                pTargetControl.GetElement().innerHTML = "Not a Thing or No Properties found";
                            return false;
                        }
                        this.MyStorageModel = this.MyScreenInfo.MyStorageMirror[this.MyMirrorName];
                    }
                    this.IsNMIOnly = (tTableParas.length > 1 && tTableParas[1] === '1');
                    pTableName = cde.GuidToString("PB" + this.MyTRF.RowID);
                    this.RefreshPropTable(pTableName, this.MyStorageModel, this.MyTRF.RowNo);
                }
                this.MyMetaData = new cdeNMI.TheFormInfo();
                this.MyMetaData.FormFields = [];
                this.MyMetaData.IsReadOnly = (this.MyFieldInfo.Flags & 2) === 0;
                this.MyMetaData.IsGenerated = false;
                this.MyMetaData.TargetElement = pTableName;
                if (!cde.IsNotSet(this.MyFieldInfo["Caption"]))
                    this.MyMetaData.PropertyBag = ["Caption=" + this.MyFieldInfo["Caption"]];
                let tSizeX = 3;
                if (cde.CInt(this.MyFieldInfo["TileWidth"]) < 3)
                    tSizeX = 1;
                let tSizeX1 = 2;
                if (cde.CInt(this.MyFieldInfo["TileWidth"]) > 4)
                    tSizeX1 = cde.CInt(this.MyFieldInfo["TileWidth"]) - 4;
                for (let index = 0; index < (this.IsNMIOnly ? 2 : 4); index++) {
                    switch (index) {
                        case 0:
                            this.MyMetaData.FormFields[index] = new cdeNMI.TheFieldInfo(1, tSizeX, "Name");
                            this.MyMetaData.FormFields[index].FldOrder = 1;
                            this.MyMetaData.FormFields[index].DataItem = "Name";
                            this.MyMetaData.FormFields[index].Flags = 0;
                            break;
                        case 1:
                            this.MyMetaData.FormFields[index] = new cdeNMI.TheFieldInfo(1, tSizeX1, "Value");
                            this.MyMetaData.FormFields[index].FldOrder = 2;
                            this.MyMetaData.FormFields[index].DataItem = "Value";
                            this.MyMetaData.FormFields[index].Flags = 2;
                            this.MyMetaData.FormFields[index].FormID = "PROPTABLEInline";
                            break;
                        case 2:
                            this.MyMetaData.FormFields[index] = new cdeNMI.TheFieldInfo(21, 3, "Time");
                            this.MyMetaData.FormFields[index].FldOrder = 3;
                            this.MyMetaData.FormFields[index].DataItem = "cdeCTIM";
                            this.MyMetaData.FormFields[index].Flags = 0;
                            break;
                        case 3:
                            this.MyMetaData.FormFields[index] = new cdeNMI.TheFieldInfo(1, 3, "Meta");
                            this.MyMetaData.FormFields[index].FldOrder = 4;
                            this.MyMetaData.FormFields[index].DataItem = "cdeM";
                            this.MyMetaData.FormFields[index].Flags = 0;
                            break;
                    }
                }
                this.IsPropertyTable = true;
            }
            this.MyTableName = cde.GuidToString(pTableName);
            ///Set sizing of the Table
            if (!this.IsPropertyTable) {
                const tDiv = document.getElementById('Inline_' + this.MyTableName);
                if (tDiv)
                    this.mBaseDiv = tDiv;
                if (!this.mBaseDiv && !pTargetControl && this.MyScreenInfo.MyStorageMeta[this.MyTableName])
                    this.mBaseDiv = document.getElementById('Content_' + cde.GuidToString(this.MyScreenInfo.MyStorageMeta[this.MyTableName].TargetElement));
                if (!this.mBaseDiv) {
                    if (this.MyTarget) {
                        this.mBaseDiv = this.MyTarget.GetContainerElement();
                        if (this.mBaseDiv && !this.mBaseDiv.id && this.MyFieldInfo) {
                            this.mBaseDiv.id = 'Content_' + cde.GuidToString(this.MyTarget.MyFieldInfo.cdeMID);
                        }
                        this.RemoveTableHooks();
                        this.MyTarget.GetContainerElement().innerHTML = ""; //OK
                    }
                }
                else {
                    this.RemoveTableHooks();
                    this.mBaseDiv.innerHTML = ""; //OK
                }
            }
            else {
                this.mBaseDiv = document.createElement("div");
                if (this.MyFieldInfo && cde.CInt(this.MyFieldInfo["TileHeight"]) > 0) {
                    this.mBaseDiv.className = "cdeTableContainer";
                }
                else {
                    this.mBaseDiv.style.height = "inherit";
                }
            }
            let pClassName = 'CMyTable';
            if (this.MyFieldInfo && this.MyFieldInfo["TableClassName"])
                pClassName = this.MyFieldInfo["TableClassName"];
            this.SetElement(this.mBaseDiv);
            if (this.MyMetaData) {
                this.MyScreenInfo.MyStorageMeta[this.MyTableName] = this.MyMetaData;
            }
            else {
                if (this.MyScreenInfo.MyStorageMirror[this.MyTableName] && this.MyScreenInfo.MyStorageMirror[this.MyTableName][0] &&
                    this.MyScreenInfo.MyStorageMirror[this.MyTableName][0].cdeM) {
                    this.MyScreenInfo.MyStorageMeta[this.MyTableName] = JSON.parse(this.MyScreenInfo.MyStorageMirror[this.MyTableName][0].cdeM);
                }
            }
            this.MyFormInfo = new cdeNMI.TheFormInfo();
            if (this.MyScreenInfo.MyStorageMeta[this.MyTableName] !== undefined && this.MyScreenInfo.MyStorageMeta[this.MyTableName].IsGenerated === true)
                this.MyScreenInfo.MyStorageMeta[this.MyTableName] = null;
            if (!this.MyScreenInfo.MyStorageMeta[this.MyTableName] || !this.MyScreenInfo.MyStorageMeta[this.MyTableName].FormFields || this.MyScreenInfo.MyStorageMeta[this.MyTableName].FormFields.length === 0) {
                if (!this.MyScreenInfo.MyStorageMirror[this.MyTableName]) {
                    this.DisplayHeader(this.mBaseDiv, "No Data Available, yet", this.GetSetting("IsLiveData"));
                    if (cdeNMI.MyEngine && this.MyTarget && this.MyTarget.MyFieldInfo) {
                        cdeNMI.MyEngine.PublishToNMI("NMI_GET_DATA:" + cde.GuidToString(this.MyTarget.MyFieldInfo.cdeMID) + ":CMyTable:" + this.MyTableName + ":" + this.MyScreenID + ":true:true", '', this.MyFieldInfo ? this.MyFieldInfo.cdeN : null);
                    }
                    return false;
                }
                this.MyFormInfo.AssociatedClassName = this.MyTableName;
                this.MyFormInfo.FormFields = [];
                this.CreateFormInfo(this.MyScreenInfo.MyStorageMirror[this.MyTableName][0], "", this.MyFormInfo, 0);
                this.MyFormInfo.IsReadOnly = true;
                this.MyFormInfo.IsGenerated = true;
                this.MyFormInfo.TargetElement = this.MyTableName;
                this.MyScreenInfo.MyStorageMeta[this.MyTableName] = this.MyFormInfo;
            }
            this.MyFormInfo = this.MyScreenInfo.MyStorageMeta[this.MyTableName];
            if (this.MyFormInfo) {
                if (!this.MyFieldInfo) {
                    this.MyFieldInfo = new cdeNMI.TheFieldInfo(cdeNMI.cdeControlType.Table, 0, "");
                    this.MyFieldInfo.PropertyBag = this.MyFormInfo.PropertyBag;
                    cdeNMI.ThePB.ConvertPropertiesFromBag(this.MyFieldInfo);
                }
                else {
                    cdeNMI.ThePB.ConvertPropertiesFromBag(this.MyFieldInfo, this.MyFormInfo.PropertyBag);
                }
            }
            if (cde.CInt(this.MyFieldInfo["TileWidth"]) > 0) {
                this.mBaseDiv.style.width = cdeNMI.GetSizeFromTile(this.MyFieldInfo["TileWidth"]) + "px";
            }
            else {
                this.mBaseDiv.style.width = "inherit";
            }
            if (this.MyFieldInfo && cde.CInt(this.MyFieldInfo["TileHeight"]) > 0)
                this.mBaseDiv.style.height = "initial";
            this.DisplayHeader(this.mBaseDiv, this.MyFieldInfo["Caption"], this.MyFormInfo.IsLiveData);
            this.tableContainer = document.createElement("div");
            if (this.MyFieldInfo["TableContainerClassName"])
                this.tableContainer.className = this.MyFieldInfo["TableContainerClassName"];
            else
                this.tableContainer.className = "cdeTableContainer";
            if (cde.CInt(this.MyFieldInfo["TileWidth"]) > 0) {
                this.tableContainer.style.width = cdeNMI.GetSizeFromTile(this.MyFieldInfo["TileWidth"]) + "px";
            }
            else {
                this.tableContainer.style.width = "inherit";
            }
            this.mBaseDiv.appendChild(this.tableContainer);
            this.tableMain = document.createElement("table");
            this.tableMain.className = pClassName;
            this.tableContainer.appendChild(this.tableMain);
            const tHeader = document.createElement("THEAD");
            if (this.MyFieldInfo["HeaderClassName"])
                tHeader.className = this.MyFieldInfo["HeaderClassName"];
            else
                tHeader.className = "cdeFixedHeader";
            this.tableMain.appendChild(tHeader);
            const tHeadRow = ctrlTableRow.Create(null, null, null, null, "cdeHeaderRow");
            tHeader.appendChild(tHeadRow.GetElement());
            this.mCurrentFormFieldsInfo = null;
            if (this.MyFormInfo.IsGenerated)
                this.mCurrentFormFieldsInfo = this.MyFormInfo.FormFields;
            else
                this.mCurrentFormFieldsInfo = cdeNMI.SortArrayByProperty(this.MyFormInfo.FormFields, "FldOrder", true, false);
            this.mColHeader = new Array();
            let tOrderBy;
            let tSortDescending = false;
            if (this.MyFormInfo.OrderBy) {
                tOrderBy = this.MyFormInfo.OrderBy.split(' ');
                if (tOrderBy.length > 1 && tOrderBy[1].toLocaleLowerCase() === "desc")
                    tSortDescending = true;
            }
            let i;
            for (i = 0; i < this.mCurrentFormFieldsInfo.length; i++) {
                if (!this.mCurrentFormFieldsInfo[i] || (this.mCurrentFormFieldsInfo[i].Flags & 8) !== 0 || this.mCurrentFormFieldsInfo[i].Type === cdeNMI.cdeControlType.FacePlate)
                    continue;
                cdeNMI.ThePB.ConvertPropertiesFromBag(this.mCurrentFormFieldsInfo[i]);
                const tTd = ctrlTableCell.Create(null, null, null, 0, "cdeTH", true);
                tTd.HookEvents(false);
                if (this.mCurrentFormFieldsInfo[i]["THClassName"])
                    tTd.SetProperty("ClassName", this.mCurrentFormFieldsInfo[i]["THClassName"]);
                let tHWidth = 1;
                if (cde.CInt(this.mCurrentFormFieldsInfo[i]["FldWidth"]) > 0)
                    tHWidth = cde.CInt(this.mCurrentFormFieldsInfo[i]["FldWidth"]);
                tTd.SetProperty("TileWidth", tHWidth);
                tTd.GetElement().style.height = (cdeNMI.GetSizeFromTile(1) / 2) + "px";
                const tHCellDiv = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileGroup).Create(tTd);
                tHCellDiv.SetProperty("ClassName", "cdeTHCell");
                tHCellDiv.SetProperty("TileWidth", tHWidth);
                if (this.mCurrentFormFieldsInfo[i].Type === 22) {
                    let tHead = "&nbsp;";
                    if (this.mCurrentFormFieldsInfo[i]["TableHeader"])
                        tHead = this.mCurrentFormFieldsInfo[i]["TableHeader"];
                    tHCellDiv.GetElement().innerHTML = tHead;
                }
                else {
                    const tI = new cdeNMI.TheFieldInfo(22, 0, "", 2);
                    tI.FldOrder = i;
                    let tHead = this.mCurrentFormFieldsInfo[i]["Title"];
                    if (this.mCurrentFormFieldsInfo[i]["TableHeader"])
                        tHead = this.mCurrentFormFieldsInfo[i]["TableHeader"];
                    this.mColHeader[i] = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SmartLabel).Create(tHCellDiv, { ScreenID: this.MyScreenID, TRF: new cdeNMI.TheTRF(tHead, 0, tI), PostInitBag: [tHead ? "iValue=" + tHead : ""] });
                    this.mColHeader[i].SetProperty("Cookie", this);
                    this.mColHeader[i].HookEvents(true);
                    this.mColHeader[i].RegisterEvent("PointerUp", (thisOb) => {
                        if (!this.rowAdder) {
                            const tTable = thisOb.GetProperty("Cookie");
                            if (tTable.mSortFldID >= 0 && tTable.mSortFldID !== thisOb.MyFieldInfo.FldOrder) {
                                tTable.mColHeader[tTable.mSortFldID].SetProperty("ClassName", "");
                            }
                            tTable.mSortFldID = thisOb.MyFieldInfo.FldOrder;
                            tSortDescending = false;
                            if (!thisOb.GetProperty("ClassName") || thisOb.GetProperty("ClassName") === "cdeTHsortdn") {
                                thisOb.SetProperty("ClassName", "cdeTHsortup");
                                tSortDescending = true;
                            }
                            else
                                thisOb.SetProperty("ClassName", "cdeTHsortdn");
                            this.SortTableByProperty(tTable.MyScreenInfo.MyStorageMirror[tTable.MyTableName], tTable.mCurrentFormFieldsInfo[thisOb.MyFieldInfo.FldOrder].DataItem, cdeNMI.MyTCF.IsTypeNumeric(tTable.mCurrentFormFieldsInfo[thisOb.MyFieldInfo.FldOrder].Type), tSortDescending);
                            if (this.MyTableTitle)
                                this.MyTableTitle.SetProperty("Visibility", false);
                            if (this.InfoText) {
                                this.InfoText.SetProperty("Text", "Sorting...<i class='fa fa-spinner fa-pulse'></i>");
                                this.InfoText.SetProperty("Visibility", true);
                            }
                            window.setTimeout(() => {
                                tTable.UpdateBody(false);
                            }, 100);
                        }
                    });
                }
                if (this.MyFormInfo.OrderBy && this.mCurrentFormFieldsInfo[i].DataItem === tOrderBy[0]) {
                    if (!tSortDescending)
                        this.mColHeader[i].SetProperty("ClassName", "cdeTHsortdn");
                    else
                        this.mColHeader[i].SetProperty("ClassName", "cdeTHsortup");
                }
                tHeadRow.AppendChild(tTd);
            }
            if (!this.MyScreenInfo.MyStorageMirror[this.MyTableName]) {
                return false;
            }
            if (this.MyFormInfo.OrderBy) {
                for (i = 0; i < this.mCurrentFormFieldsInfo.length; i++) {
                    if (this.mCurrentFormFieldsInfo[i] && this.mCurrentFormFieldsInfo[i].DataItem === tOrderBy[0]) {
                        this.SortTableByProperty(this.MyScreenInfo.MyStorageMirror[this.MyTableName], this.mCurrentFormFieldsInfo[i].DataItem, cdeNMI.MyTCF.IsTypeNumeric(this.mCurrentFormFieldsInfo[i].Type), tSortDescending);
                        break;
                    }
                }
            }
            // table body
            this.tableBody = document.createElement("TBODY");
            this.tableBody.className = "cdeScrollBody";
            const tH = cde.CInt(this.GetProperty("TileHeight"));
            if (tH > 0) {
                this.tableBody.style.height = cdeNMI.GetSizeFromTile(tH - 1) + "px";
            }
            this.tableMain.appendChild(this.tableBody);
            this.UpdateBody(true);
            return true;
        }
        LaterApplySkin() {
            const tH = cde.CInt(this.GetProperty("TileHeight"));
            if (tH > 0 && this.MyTarget) {
                this.tableBody.style.height = this.MyTarget.GetContainerElement().style.height;
            }
        }
        SetTE(pTEControl) {
            if (cde.CInt(pTEControl.MyTarget.GetProperty("TileWidth")) !== 0)
                this.SetProperty("TileWidth", cde.CInt(pTEControl.MyTarget.GetProperty("TileWidth")));
            if (pTEControl.MyFieldInfo["MaxFileSize"])
                this.SetProperty("MaxFileSize", pTEControl.MyFieldInfo["MaxFileSize"]);
            if (pTEControl.MyFieldInfo["IsDropTarget"])
                this.SetProperty("IsDropTarget", pTEControl.MyFieldInfo["IsDropTarget"]);
            if (pTEControl.MyFieldInfo["AllowGlobalPush"])
                this.SetProperty("AllowGlobalPush", pTEControl.MyFieldInfo["AllowGlobalPush"]);
            if (pTEControl.MyFieldInfo["EngineName"])
                this.SetProperty("EngineName", pTEControl.MyFieldInfo["EngineName"]);
            this.MyFieldInfo.cdeO = pTEControl.MyFieldInfo.cdeO;
            pTEControl.RegisterEvent("Resize", (sender, size) => {
                this.SetProperty("TileWidth", size);
            });
        }
        SetProperty(pName, pValue) {
            if (pName !== "MID")
                super.SetProperty(pName, pValue);
            if (pName === "Reload") {
                cdeNMI.ResetKeyCorder();
                if (this.MyScreenInfo)
                    this.MyScreenInfo.MyStorageMirror[this.MyTableName] = null;
                this.RefreshData(this.MyTableName, cde.CInt(this.GetProperty("CurrentPage")));
            }
            else if (pName === "TileWidth" && this.mBaseDiv) {
                pValue = cde.CInt(pValue);
                if (pValue > 0) {
                    this.mBaseDiv.style.width = cdeNMI.GetSizeFromTile(pValue).toString() + "px";
                }
                this.mBaseDiv.style.overflowX = "auto";
            }
            else if (pName === "TileHeight" && this.mBaseDiv) {
                pValue = cde.CInt(pValue);
                if (this.tableBody && cde.CInt(pValue) > 1) {
                    this.tableBody.style.height = cdeNMI.GetSizeFromTile(cde.CInt(pValue) - 1).toString() + "px";
                    this.mBaseDiv.style.height = "initial";
                }
                this.mBaseDiv.style.overflowY = "auto";
            }
            else if (pName === "Style" && this.mBaseDiv) {
                this.mBaseDiv.style.cssText = pValue;
            }
            else if (pName === "InnerClassName" && this.tableMain) {
                this.tableMain.className = pValue;
            }
            else if (pName === "Title" && this.MyTableTitle) {
                this.MyTableTitle.SetProperty("Text", pValue);
            }
            else if (pName === "IsDropTarget" && this.mBaseDiv) {
                if (cde.CBool(pValue) === true) {
                    this.mBaseDiv.ondragover = () => {
                        this.mBaseDiv.classList.add('ctrlDropUploaderHover');
                        return false;
                    };
                    this.mBaseDiv.ondragend = () => {
                        this.mBaseDiv.classList.remove('ctrlDropUploaderHover');
                        return false;
                    };
                    this.mBaseDiv.ondragleave = () => {
                        this.mBaseDiv.classList.remove('ctrlDropUploaderHover');
                        return false;
                    };
                    this.mBaseDiv.ondrop = (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        this.mBaseDiv.classList.remove('ctrlDropUploaderHover');
                        this.ProcessFiles(e.dataTransfer.files);
                    };
                }
            }
        }
        DisplayHeader(pParent, pHeaderTitle, pIsLiveData) {
            const tHeadTd = document.createElement("div");
            tHeadTd.className = "cdeMainTableHeader";
            pParent.appendChild(tHeadTd);
            let tAddHeadline = true;
            let HasContent = false;
            if (cde.IsNotSet(pHeaderTitle)) {
                pHeaderTitle = "&nbsp;";
                tAddHeadline = false;
            }
            if (tAddHeadline) {
                const tScr = cdeNMI.MyScreenManager.GetScreenByID(this.MyTableName);
                if (tScr && cde.CBool(tScr.GetProperty("HidePins")) === false) {
                    tScr.SetProperty("Caption", pHeaderTitle);
                    tAddHeadline = false;
                }
                else {
                    this.MyTableTitle = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SmartLabel).Create(null, { PreInitBag: ["Element=h1"], PostInitBag: ["iValue=" + cdeNMI.GenerateFinalString(pHeaderTitle), "ClassName=cdeTableHeader"] });
                    if (this.MyFieldInfo && this.MyFieldInfo["TNClassName"])
                        this.MyTableTitle.SetProperty("ClassName", this.MyFieldInfo["TNClassName"]);
                }
            }
            if (!pIsLiveData) {
                if (!this.IsPropertyTable) {
                    if (tAddHeadline) {
                        const tRefreshBut = cdeNMI.ctrlTileButton.Create(null, (e) => {
                            cdeNMI.ResetKeyCorder();
                            this.MyScreenInfo.MyStorageMirror[this.MyTableName] = null;
                            this.RefreshData(this.MyTableName, cde.CInt(this.GetProperty("CurrentPage")), e.button === 2);
                        }, "<span class='fa cdeTableHeaderIcon'>&#xf021;</span>", 1, 1);
                        tRefreshBut.SetProperty("TileFactorX", 2);
                        tRefreshBut.SetProperty("TileFactorY", 2);
                        tHeadTd.appendChild(tRefreshBut.GetElement());
                    }
                    if (cde.CInt(this.GetProperty("PageSize")) > 0) {
                        HasContent = true;
                        const tBut = cdeNMI.ctrlTileButton.Create(null, () => {
                            if (!this.rowAdder && cde.CInt(this.GetProperty("CurrentPage")) > 0) {
                                cdeNMI.ResetKeyCorder();
                                this.MyScreenInfo.MyStorageMirror[this.MyTableName] = null;
                                this.RefreshData(this.MyTableName, 0);
                            }
                        }, "<span class='fa cdeTableHeaderIcon'>&#xf049;</span>", 1, 1);
                        tBut.SetProperty("TileFactorX", 2);
                        tBut.SetProperty("TileFactorY", 2);
                        tHeadTd.appendChild(tBut.GetElement());
                        const tBut2 = cdeNMI.ctrlTileButton.Create(null, () => {
                            if (!this.rowAdder && cde.CInt(this.GetProperty("CurrentPage")) > 0) {
                                cdeNMI.ResetKeyCorder();
                                this.MyScreenInfo.MyStorageMirror[this.MyTableName] = null;
                                this.RefreshData(this.MyTableName, cde.CInt(this.GetProperty("CurrentPage")) - 1);
                            }
                        }, "<span class='fa cdeTableHeaderIcon'>&#xf048;</span>", 1, 1);
                        tBut2.SetProperty("TileFactorX", 2);
                        tBut2.SetProperty("TileFactorY", 2);
                        tHeadTd.appendChild(tBut2.GetElement());
                        const tBut3 = cdeNMI.ctrlTileButton.Create(null, () => {
                            if (!this.rowAdder) {
                                cdeNMI.ResetKeyCorder();
                                this.MyScreenInfo.MyStorageMirror[this.MyTableName] = null;
                                this.RefreshData(this.MyTableName, cde.CInt(this.GetProperty("CurrentPage")) + 1);
                            }
                        }, "<span class='fa cdeTableHeaderIcon'>&#xf051;</span>", 1, 1);
                        tBut3.SetProperty("TileFactorX", 2);
                        tBut3.SetProperty("TileFactorY", 2);
                        tHeadTd.appendChild(tBut3.GetElement());
                        const tBut4 = cdeNMI.ctrlTileButton.Create(null, () => {
                            if (!this.rowAdder) {
                                cdeNMI.ResetKeyCorder();
                                this.MyScreenInfo.MyStorageMirror[this.MyTableName] = null;
                                this.RefreshData(this.MyTableName, -1);
                            }
                        }, "<span class='fa cdeTableHeaderIcon'>&#xf050;</span>", 1, 1);
                        tBut4.SetProperty("TileFactorX", 2);
                        tBut4.SetProperty("TileFactorY", 2);
                        tHeadTd.appendChild(tBut4.GetElement());
                    }
                }
                if (cde.CBool(this.MyFieldInfo["ShowExportButton"])) {
                    HasContent = true;
                    const tButEx = cdeNMI.ctrlTileButton.Create(null, () => {
                        this.RefreshData(this.MyTableName, cde.CInt(this.GetProperty("CurrentPage")), true, true);
                    }, "<span class='fa cdeTableHeaderIcon'>&#xf019;</span>", 1, 1);
                    tButEx.SetProperty("TileFactorX", 2);
                    tButEx.SetProperty("TileFactorY", 2);
                    tHeadTd.appendChild(tButEx.GetElement());
                }
                if (this.MyFormInfo && this.MyFormInfo.FormFields) {
                    if (!this.MyFormInfo.IsReadOnly && this.MyFieldInfo["AddButtonText"]) {
                        let i = this.MyFormInfo.FormFields.length;
                        let HasDelete = false;
                        while (i--) {
                            if (this.MyFormInfo.FormFields[i].DataItem === "CDE_DELETE") {
                                HasDelete = true;
                                break;
                            }
                        }
                        if (HasDelete) {
                            this.btnAdder = cdeNMI.ctrlTileButton.Create(null, () => this.AddRecord(this.MyScreenID), this.MyFieldInfo["AddButtonText"], 2, 1);
                            this.btnAdder.SetProperty("TileFactorY", 2);
                            if (this.MyFieldInfo["AddButtonClassName"])
                                this.btnAdder.SetProperty("ClassName", this.MyFieldInfo["AddButtonClassName"]);
                            else
                                this.btnAdder.SetProperty("ClassName", "cdeAddButton");
                            tHeadTd.appendChild(this.btnAdder.GetElement());
                        }
                    }
                    if (cde.CBool(this.MyFieldInfo["ShowFilterField"])) {
                        HasContent = true;
                        const tFilterIcon = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SmartLabel).Create(null, { PostInitBag: ["ClassName=cdeFilterInputIcon", "TileWidth=1", "TileFactorX=2", "Style=float:left;", "Text=<i class='fa fa-2x'>&#xf002;</i>"] });
                        tHeadTd.appendChild(tFilterIcon.GetElement());
                        const tFld2 = new cdeNMI.TheFieldInfo(cdeNMI.cdeControlType.SingleEnded, 3, "Filter:", 2);
                        let tFiVal = this.GetProperty("CurrentFilter");
                        if (!tFiVal)
                            tFiVal = "";
                        this.inputFilter = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SingleEnded).Create(null, { TRF: new cdeNMI.TheTRF(this.MyTableName, 1, tFld2), PostInitBag: ["ClassName=cdeInput cdeFilterInput", "TileWidth=2", "iValue=" + tFiVal] });
                        this.inputFilter.SetProperty("TileFactorY", 2);
                        this.inputFilter.RegisterEvent("OnValueChanged", (sender, eventName, pvalue) => {
                            if (this.GetProperty("CurrentFilter") === pvalue)
                                return;
                            this.SetProperty("CurrentFilter", pvalue);
                            this.RefreshData(this.MyTableName, cde.CInt(this.GetProperty("CurrentPage")), true);
                        });
                        tHeadTd.appendChild(this.inputFilter.GetElement());
                    }
                }
                this.InfoText = cdeNMI.ctrlSmartLabel.Create(null, null, null, "", "span", true);
                this.InfoText.SetProperty("TileFactorY", 2);
                this.InfoText.SetProperty("ClassName", "cdeRefresher");
                this.InfoText.SetProperty("Visibility", false);
                if (HasContent === true)
                    tHeadTd.style.height = (cdeNMI.GetSizeFromTile(1) / 2) + "px";
                tHeadTd.appendChild(this.InfoText.GetElement());
            }
            if (tAddHeadline)
                tHeadTd.appendChild(this.MyTableTitle.GetElement());
        }
        UpdateBody(IsNewTable) {
            if (!IsNewTable) {
                this.RemoveTableHooks();
            }
            this.MyTableControls = [];
            this.mTableRows = [];
            if (!this.tableBody)
                return;
            this.tableBody.innerHTML = ""; //OK
            for (let i = 0; i < this.MyScreenInfo.MyStorageMirror[this.MyTableName].length; i++) {
                const tRow = ctrlTableRow.Create(null, this.MyTRF);
                this.MyTableControls[i] = [];
                tRow.SetProperty("ClassName", (i % 2 === 0) ? 'cdeRowEven' : 'cdeRowOdd');
                this.tableBody.appendChild(tRow.GetElement());
                const tDataRow = this.MyScreenInfo.MyStorageMirror[this.MyTableName][i];
                this.mTableRows[tDataRow.cdeMID] = tRow;
                let j = 0;
                for (const tFldInfo of this.mCurrentFormFieldsInfo) {
                    if (!tFldInfo || (tFldInfo.Flags & 8) !== 0 || tFldInfo.Type === cdeNMI.cdeControlType.FacePlate)
                        continue;
                    const tD = ctrlTableCell.Create(null, null);
                    tRow.AppendChild(tD);
                    if (!tFldInfo.FldOrder)
                        tFldInfo.FldOrder = (j++ + 1) * 10;
                    const tFldID = this.MyTableName + '_' + i + '_' + tFldInfo.FldOrder;
                    if ((tFldInfo.Flags & 2) !== 0)
                        tD.HookEvents(false);
                    if (!this.MyFormInfo.IsReadOnly && tFldInfo.DataItem === "CDE_DELETE") {
                        tD.SetProperty("ClassName", 'cdeTH');
                        tD.SetProperty("TileWidth", 1);
                        this.MyTableControls[i][tFldID] = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(null, { TRF: new cdeNMI.TheTRF(this.MyTableName, i, tFldInfo), PreInitBag: ["ControlTW=1", "ControlTH=1"], PostInitBag: ["Title=<span class='fa fa-3x'>&#xf1f8;</span>", "ClassName=cdeBadActionButton cdeDeleteButton"] });
                        this.MyTableControls[i][tFldID].SetProperty("Cookie", this);
                        this.MyTableControls[i][tFldID].SetProperty("Cookie2", tDataRow);
                        this.MyTableControls[i][tFldID].SetProperty("OnClick", (pSender, evt) => {
                            const tMe = pSender.GetProperty("Cookie");
                            if (evt.shiftKey) {
                                tMe.DeleteRecord(pSender.GetProperty("Cookie2"));
                            }
                            else {
                                if (cdeNMI.MyPopUp)
                                    cdeNMI.MyPopUp.Show('Are you sure you want to delete this record? ', false, null, 1, (tPopup, pParent, cookie) => {
                                        pParent.DeleteRecord(cookie);
                                    }, null, pSender.GetProperty("Cookie2"), tMe);
                            }
                        });
                        tD.AppendChild(this.MyTableControls[i][tFldID]);
                    }
                    else if (tFldInfo.DataItem === "CDE_DETAILS") {
                        tD.SetProperty("ClassName", 'cdeTH');
                        tD.SetProperty("TileWidth", 1);
                        this.MyTableControls[i][tFldID] = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(null, { TRF: new cdeNMI.TheTRF(this.MyTableName, i, tFldInfo), PreInitBag: ["ControlTW=1", "ControlTH=1"], PostInitBag: ["Title=<span class='fa fa-3x'>&#xf044;</span>", "ClassName=cdeTransitButton cdeDetailButton"] });
                        this.MyTableControls[i][tFldID].SetProperty("Cookie", i);
                        this.MyTableControls[i][tFldID].SetProperty("OnClick", (pSender) => {
                            if (!this.rowAdder) {
                                cdeNMI.TogglePortalFull(false);
                                if (this.GetProperty("TemplateID") && cdeNMI.MyScreenManager) {
                                    const tRowID = this.MyScreenInfo.MyStorageMirror[this.MyTableName][cde.CInt(pSender.GetProperty("Cookie"))].cdeMID;
                                    const tTemplID = cde.GuidToString(this.GetProperty("TemplateID"));
                                    cdeNMI.MyScreenManager.TransitToScreen(tTemplID, true, false, tRowID);
                                }
                                else {
                                    cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.FormView).Create(this.MyTarget, { ScreenID: this.MyScreenID, TRF: new cdeNMI.TheTRF(this.MyTableName, pSender.GetProperty("Cookie"), null) });
                                }
                            }
                        });
                        tD.AppendChild(this.MyTableControls[i][tFldID]);
                    }
                    else {
                        let tFldContent = "";
                        if (tFldInfo.DataItem) {
                            tFldContent = cdeNMI.GetFldContent(tDataRow, tFldInfo, this.MyFormInfo.IsGenerated);
                            if (tFldContent === undefined)
                                tFldContent = "";
                        }
                        if (tFldInfo["TCClassName"])
                            tD.SetProperty("ClassName", tFldInfo["TCClassName"]);
                        else
                            tD.SetProperty("ClassName", 'cdeTabEntry');
                        let tDWidth = 1;
                        if (cde.CInt(tFldInfo["FldWidth"]) > 0)
                            tDWidth = cde.CInt(tFldInfo["FldWidth"]);
                        tD.SetProperty("TileWidth", tDWidth);
                        if (tFldInfo["HorizontalAlignment"])
                            tD.SetProperty("HorizontalAlignment", tFldInfo["HorizontalAlignment"]);
                        const tDCellDiv = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileGroup).Create(tD);
                        tDCellDiv.SetProperty("ClassName", "cdeTDCell");
                        tDCellDiv.SetProperty("TileWidth", tDWidth);
                        let HookEvent = true;
                        tFldInfo["IsInTable"] = true;
                        let fTYpe = tFldInfo.Type;
                        if (this.MyNMIEditControl && tFldInfo.DataItem == "Value")
                            fTYpe = cde.CInt(tDataRow["ControlID"]);
                        switch (fTYpe) {
                            case cdeNMI.cdeControlType.Picture:
                                if (tFldContent && (tFldContent.length > 512 || cde.CBool(cdeNMI.ThePB.GetSetting(tFldInfo, "IsBlob"))))
                                    tFldContent = "data:image/jpeg;base64," + tFldContent;
                                this.MyTableControls[i][tFldID] = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.Picture).Create(null, { PostInitBag: ["iValue=" + tFldContent] });
                                if (cde.CInt(tFldInfo["FldWidth"]) > 0) {
                                    this.MyTableControls[i][tFldID].SetProperty("ControlTW", cde.CInt(tFldInfo["FldWidth"]));
                                    this.MyTableControls[i][tFldID].SetProperty("ControlTH", 1);
                                }
                                break;
                            case cdeNMI.cdeControlType.Table:
                                this.MyTableControls[i][tFldID] = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.Table).Create(null, { ScreenID: this.MyScreenID, TRF: new cdeNMI.TheTRF(this.MyTableName, i, tFldInfo), PostInitBag: ["InnerClassName=cdeInlineTable"] });
                                break;
                            case cdeNMI.cdeControlType.CanvasDraw:
                                HookEvent = false;
                                this.MyTableControls[i][tFldID] = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.CanvasDraw).Create(null, { TRF: new cdeNMI.TheTRF(this.MyTableName, i, tFldInfo), PostInitBag: ["iValue=" + tFldContent] });
                                if (cde.CInt(tFldInfo["FldWidth"]) > 0) {
                                    this.MyTableControls[i][tFldID].SetProperty("ControlTW", cde.CInt(tFldInfo["FldWidth"]));
                                    this.MyTableControls[i][tFldID].SetProperty("ControlTH", 1);
                                }
                                break;
                            case cdeNMI.cdeControlType.TouchDraw:
                                this.MyTableControls[i][tFldID] = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TouchDraw).Create(null, { TRF: new cdeNMI.TheTRF(this.MyTableName, i, tFldInfo), PostInitBag: ["iValue=" + tFldContent] });
                                break;
                            case cdeNMI.cdeControlType.FormButton:
                            case cdeNMI.cdeControlType.TileButton:
                                {
                                    tFldInfo["OnClick"] = cdeNMI.GenerateFinalString(tFldInfo["OnClick"], tDataRow);
                                    let tTit = "";
                                    if (tFldInfo.DataItem)
                                        tTit = cdeNMI.GenerateFinalString("%" + tFldInfo.DataItem + "%", tDataRow);
                                    else
                                        tTit = cdeNMI.GenerateFinalString(tFldInfo["Title"], tDataRow);
                                    this.MyTableControls[i][tFldID] = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(this, { ScreenID: this.MyScreenID, TRF: new cdeNMI.TheTRF(this.MyTableName, i, tFldInfo), PostInitBag: ["iValue=" + (tTit ? tTit : "")] });
                                }
                                break;
                            case cdeNMI.cdeControlType.SingleCheck:
                                this.MyTableControls[i][tFldID] = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SingleCheck).Create(this, { ScreenID: this.MyScreenID, TRF: new cdeNMI.TheTRF(this.MyTableName, i, tFldInfo), PreInitBag: ["IsInTable=true"], PostInitBag: ["iValue=" + cde.CBool(tFldContent)] });
                                this.MyTableControls[i][tFldID].SetProperty("UpdateTable", true);
                                break;
                            case cdeNMI.cdeControlType.CircularGauge:
                                if (cde.CInt(tFldInfo["FldWidth"]) > 0)
                                    tFldInfo["ControlTW"] = cde.CInt(tFldInfo["FldWidth"]);
                                else
                                    tFldInfo["ControlTW"] = 1;
                                tFldInfo["ControlTH"] = 1;
                                this.MyTableControls[i][tFldID] = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.CircularGauge).Create(this, { ScreenID: this.MyScreenID, TRF: new cdeNMI.TheTRF(this.MyTableName, i, tFldInfo), PreInitBag: ["IsInTable=true"], PostInitBag: ["iValue=" + cde.CDbl(tFldContent)] });
                                break;
                            case cdeNMI.cdeControlType.BarChart:
                                if (cde.CInt(tFldInfo["FldWidth"]) > 0)
                                    tFldInfo["ControlTW"] = cde.CInt(tFldInfo["FldWidth"]);
                                else
                                    tFldInfo["ControlTW"] = 1;
                                tFldInfo["ControlTH"] = 1;
                                this.MyTableControls[i][tFldID] = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.BarChart).Create(this, { ScreenID: this.MyScreenID, TRF: new cdeNMI.TheTRF(this.MyTableName, i, tFldInfo), PreInitBag: ["IsInTable=true"], PostInitBag: ["iValue=" + cde.CDbl(tFldContent)] });
                                break;
                            case cdeNMI.cdeControlType.StatusLight:
                                {
                                    const tSL = new cdeNMI.ctrlStatusLight();
                                    if (cde.CInt(tFldInfo["FldWidth"]) > 0)
                                        tFldInfo["ControlTW"] = cde.CInt(tFldInfo["FldWidth"]);
                                    else
                                        tFldInfo["ControlTW"] = 1;
                                    tFldInfo["ControlTH"] = 1;
                                    tSL.InitControl(null, new cdeNMI.TheTRF(this.MyTableName, i, tFldInfo), null, this.MyScreenID);
                                    tSL.SetProperty("iValue", tFldContent);
                                    this.MyTableControls[i][tFldID] = tSL;
                                }
                                break;
                            case cdeNMI.cdeControlType.CollapsibleGroup:
                            case cdeNMI.cdeControlType.TileGroup:
                                this.MyTableControls[i][tFldID] = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileGroup).Create(null, { TRF: new cdeNMI.TheTRF(this.MyTableName, i, tFldInfo) });
                                this.MyTableControls[i][tFldID].SetProperty("ClassName", "cdeTileGroup");
                                this.MyTableControls[i][tFldID].SetProperty("IsDivOnly", tFldInfo["IsDivOnly"]);
                                this.MyTableControls[i][tFldID].SetProperty("iValue", tFldContent);
                                break;
                            case cdeNMI.cdeControlType.UserControl:
                                if (cde.CInt(tFldInfo["FldWidth"]) > 0)
                                    tFldInfo["ControlTW"] = cde.CInt(tFldInfo["FldWidth"]);
                                else
                                    tFldInfo["ControlTW"] = 1;
                                tFldInfo["ControlTH"] = 1;
                                tFldInfo["IsInTable"] = true;
                                tFldInfo["DataRow"] = tDataRow;
                                tFldInfo["FldID"] = tFldID;
                                tFldInfo["iValue"] = tFldContent;
                                cdeNMI.MyTCF.CreateControlLazy(tDCellDiv, tFldInfo["EngineName"], tFldInfo["ControlType"], (parent, resControl, cookie) => {
                                    this.MyTableControls[cookie.RowNo][cookie.FldInfo["FldID"]] = resControl;
                                    resControl.InitControl(parent, cookie);
                                    resControl.SetProperty("iValue", cookie.FldInfo["iValue"]);
                                    this.FinishControlSetup(cookie.RowNo, cookie.FldInfo["FldID"], cookie.FldInfo, cookie.FldInfo["DataRow"], true, parent);
                                }, new cdeNMI.TheTRF(this.MyTableName, i, tFldInfo));
                                continue;
                            default:
                                const oTRF = new cdeNMI.TheTRF(this.MyTableName, i, tFldInfo);
                                oTRF.FldInfo.Type = fTYpe;
                                this.MyTableControls[i][tFldID] = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.SmartLabel).
                                    Create(null, {
                                    ScreenID: this.MyScreenID,
                                    TRF: oTRF,
                                    PreInitBag: ["Element=div", "IsReadOnly=" + this.MyFormInfo.IsReadOnly, "IsInTable=true"],
                                    PostInitBag: ["iValue=" + tFldContent],
                                    Cookie: tDataRow
                                });
                                if ((tFldInfo.Flags & 2) !== 0 && tFldInfo.Type !== cdeNMI.cdeControlType.SmartLabel) {
                                    tD.MyNMIControl = this.MyTableControls[i][tFldID];
                                    this.MyTableControls[i][tFldID].MyNMIControl = tD;
                                    tD.MyNMIControl.MyDataView = this;
                                    tD.RegisterEvent("PointerUp", (pControl, evt, pPointer) => {
                                        cdeNMI.StopPointerEvents(evt);
                                        pControl.MyNMIControl.EditControl(evt, pPointer, pControl);
                                    });
                                }
                                break;
                        }
                        this.FinishControlSetup(i, tFldID, tFldInfo, tDataRow, HookEvent, tDCellDiv);
                    }
                }
                cdeNMI.MyEngine.UnregisterEvent("RecordUpdated_" + this.MyTableName + "_" + i, this.UpdateRecord);
                cdeNMI.MyEngine.RegisterEvent("RecordUpdated_" + this.MyTableName + "_" + i, this.UpdateRecord);
                this.ValidateRules(this.MyScreenID, this.MyTableName, this.MyTableName, i, this.MyTableControls[i], true, false); //Run local rules on Table Row
            }
            cdeNMI.TheFlashCache.FlushCache();
            this.InfoText.SetProperty("Text", "");
            this.InfoText.SetProperty("Visibility", false);
            if (this.MyTableTitle)
                this.MyTableTitle.SetProperty("Visibility", true);
        }
        FinishControlSetup(i, tFldID, tFldInfo, tDataRow, HookEvent, tDCellDiv) {
            if (!this.MyTableControls[i][tFldID].MyTRF)
                this.MyTableControls[i][tFldID].MyTRF = new cdeNMI.TheTRF(this.MyTableName, i, tFldInfo);
            if (this.MyScreenInfo.MyStorageMirror[this.MyTableName] && tDataRow && tDataRow.cdeMID)
                this.MyTableControls[i][tFldID].MyTRF.RowID = tDataRow.cdeMID;
            this.MyTableControls[i][tFldID].MyTRF.ModelID = this.MyScreenID;
            this.MyTableControls[i][tFldID].MyDataView = this;
            if (this.MyNMIEditControl)
                this.MyTableControls[i][tFldID].SetProperty("TargetPropName", tDataRow["Name"]);
            if (HookEvent) {
                this.MyTableControls[i][tFldID].SetProperty("OnValueChanged", (pCtrl, evt, pValue, pTRF) => {
                    if (this.MyNMIEditControl && pCtrl.GetProperty("TargetPropName")) {
                        this.MyNMIEditControl.SaveProperty(pCtrl.GetProperty("TargetPropName"), pValue);
                    }
                    if (pTRF) {
                        this.ValidateRules(this.MyScreenID, this.MyTableName, this.MyTableName, pTRF.RowNo, this.MyTableControls[pTRF.RowNo], false, false); //Push Table changes to Relay
                    }
                });
            }
            if (tFldInfo.PropertyBag && tFldInfo.PropertyBag.length > 0) {
                cdeNMI.ThePB.SetPropertiesFromBag(this.MyTableControls[i][tFldID], tFldInfo.PropertyBag, this.MyScreenInfo.MyStorageMirror[this.MyTableName] ? tDataRow : null, false, true);
            }
            if (tFldInfo.DataItem) {
                this.MyTableControls[i][tFldID].SetProperty("DataItem", tFldInfo.DataItem);
            }
            if ((tFldInfo.Flags & 0x40) !== 0 || tFldInfo.Type === cdeNMI.cdeControlType.ThingPicker) {
                this.MyTableControls[i][tFldID].SetProperty("TID", tDataRow.cdeMID);
                this.MyTableControls[i][tFldID].SetProperty("UXID", tFldInfo.cdeMID);
                this.MyTableControls[i][tFldID].RegisterNMIControl();
            }
            tDCellDiv.AppendChild(this.MyTableControls[i][tFldID]);
        }
        UpdateRecord(pSI, pModelMID, tTabName, tRowID, tMask) {
            if (this.MyTableName && this.MyTableName === tTabName) {
                const tMod = cdeNMI.MyNMIModels[pModelMID];
                if (tMod) {
                    let cnt = 0;
                    for (const cc in this.MyTableControls[tRowID]) {
                        const tN = this.MyTableControls[tRowID][cc].GetProperty("DataItem");
                        if (tN && (!tMask || tMask.substr(cnt, 1) === '1')) {
                            if (!Object.prototype.hasOwnProperty.call(tMod.MyStorageMirror[tTabName][tRowID], 'SecToken'))
                                this.MyTableControls[tRowID][cc].SetProperty("iValue", cdeNMI.GetFldContent(tMod.MyStorageMirror[tTabName][tRowID], this.MyTableControls[tRowID][cc].MyFieldInfo, this.MyFormInfo.IsGenerated)); //     tMod.MyStorageMirror[tTabName][tRowID][tN]);
                        }
                        cnt++; //V5: This was missing!
                    }
                    this.ValidateRules(pModelMID, tTabName, tTabName, tRowID, this.MyTableControls[tRowID], true, false); //Validate rules in Row
                }
            }
        }
        ReloadData() {
            this.MyScreenInfo.MyStorageMirror[this.MyTableName] = null;
            this.RefreshData(this.MyTableName, cde.CInt(this.GetProperty("CurrentPage")), false);
            return true;
        }
        RefreshData(pTableName, pPageNo, bForceReload = false, pFileDownload = false) {
            if (this.IsPropertyTable && pFileDownload !== true) {
                this.RefreshPropTable(pTableName, this.MyStorageModel, this.MyTRF.RowNo);
                this.UpdateBody(true);
            }
            else {
                let tID = "auto";
                if (this.MyTarget) {
                    if (this.MyTarget.MyNMIControl && this.MyTarget.MyNMIControl.MyBaseType === cdeNMI.cdeControlType.Table) {
                        tID = cde.GuidToString(this.MyTarget.MyFieldInfo.cdeMID);
                    }
                    else if (this.MyTarget.MyScreenID)
                        tID = this.MyTarget.MyScreenID;
                }
                if (cdeNMI.MyEngine) {
                    let tFilter = this.GetProperty("CurrentFilter");
                    if (!tFilter)
                        tFilter = "";
                    let tData = "CMyTable";
                    if (pFileDownload === true)
                        tData = "CMyData";
                    cdeNMI.MyEngine.PublishToNMI('NMI_GET_DATA:' + tID + ':' + tData + ':' + pTableName + ':' + this.MyScreenID + (bForceReload === true ? ":false:true" : ""), pPageNo.toString() + (tFilter.length > 0 ? (":;:" + tFilter) : ""), this.MyTRF ? this.MyTRF.GetNodeID() : null);
                }
                if (pFileDownload === true)
                    return;
                if (this.MyTableTitle)
                    this.MyTableTitle.SetProperty("Visibility", false);
                if (this.InfoText) {
                    this.InfoText.SetProperty("Text", "Refreshing...<i class='fa fa-spinner fa-pulse'></i>");
                    this.InfoText.SetProperty("Visibility", true);
                }
                if (cdeNMI.MyToast)
                    cdeNMI.MyToast.ShowToastMessage("Table Refresh request sent to Relay");
            }
        }
        RefreshPropTable(pTableName, pStorageModel, tRowNo) {
            this.MyScreenInfo.MyStorageMirror[pTableName] = [];
            for (const idx in pStorageModel[tRowNo].MyPropertyBag) {
                if (this.IsNMIOnly && (pStorageModel[tRowNo].MyPropertyBag[idx].cdeE & 64) === 0)
                    continue;
                this.MyScreenInfo.MyStorageMirror[pTableName].push(pStorageModel[tRowNo].MyPropertyBag[idx]);
            }
            this.SortTableByProperty(this.MyScreenInfo.MyStorageMirror[pTableName], "Name", false, false);
        }
        RefreshControlPropTable(pTableName, pControl) {
            this.MyScreenInfo.MyStorageMirror[pTableName] = [];
            if (!pControl)
                return;
            for (const idx in this.AllowedNMIEditorProps) {
                const tProps = this.AllowedNMIEditorProps[idx].split(':');
                let tval = pControl.GetProperty(tProps[0]);
                if (!tval)
                    tval = "";
                let tID = "1";
                if (tProps.length > 1)
                    tID = tProps[1];
                this.MyScreenInfo.MyStorageMirror[pTableName].push({ Name: tProps[0], Value: tval, ControlID: tID });
            }
            this.SortTableByProperty(this.MyScreenInfo.MyStorageMirror[pTableName], "Name", false, false);
        }
        TableHighlightRow() {
            if (document.getElementById && document.createTextNode) {
                const tables = document.getElementsByTagName('table');
                for (const tTabs of tables) {
                    if (tTabs.className === 'cdeHilite') {
                        const trs = tTabs.getElementsByTagName('tr');
                        for (const tRow of trs) {
                            if (tRow.parentNode.nodeName === 'TBODY') {
                                tRow.onmouseover = (ev) => {
                                    const target = (ev.target);
                                    target.setAttribute("oldClass", target.className);
                                    target.className = 'cdeHilightRow';
                                    return false;
                                };
                                tRow.onmouseout = (ev) => {
                                    const target = (ev.target);
                                    target.className = target.attributes["oldClass"].nodeValue;
                                    return false;
                                };
                            }
                        }
                    }
                }
            }
        }
        DeleteRecord(pDataRow) {
            const pMID = pDataRow.cdeMID;
            if (cdeNMI.MyEngine)
                cdeNMI.MyEngine.PublishToNMI('NMI_DEL_ID:' + this.MyTableName + ":" + pMID, "", pDataRow.cdeN);
            this.mTableRows[pMID].SetProperty("ClassName", "rowDeleted");
        }
        CancelAddRecord() {
            this.IsInEdit = false;
            cdeNMI.ResetKeyCorder();
            if (this.rowAdder) {
                this.tableMain.deleteRow(1);
                this.rowAdder = null;
            }
            if (this.btnAdder)
                this.btnAdder.SetProperty("Visibility", true);
        }
        SaveRecord() {
            this.IsInEdit = false;
            cdeNMI.ResetKeyCorder();
            const tTableRecord = [];
            if (this.MyScreenInfo.MyStorageMirror[this.MyTableName] && this.MyScreenInfo.MyStorageMirror[this.MyTableName][0])
                tTableRecord[0] = this.MyScreenInfo.MyStorageMirror[this.MyTableName][0].constructor();
            else
                tTableRecord[0] = {};
            for (const tFldInfo of this.mCurrentFormFieldsInfo) {
                if (!tFldInfo)
                    continue;
                const tFldID = this.MyTableName + "_" + tFldInfo.FldOrder;
                if (!this.MyAdderRow[tFldID] || !this.MyAdderRow[tFldID].MyNMIControl)
                    continue;
                if (tFldInfo.DataItem !== "CDE_DELETE" && (tFldInfo.Flags & 2) !== 0 && this.MyAdderRow[tFldID]) {
                    let tVal;
                    switch (tFldInfo.Type) {
                        case 4: //Checkbox
                            tVal = cde.CBool(this.MyAdderRow[tFldID].MyNMIControl.GetProperty("IsChecked"));
                            break;
                        case 1:
                        default:
                            tVal = this.MyAdderRow[tFldID].MyNMIControl.GetProperty("Value");
                            break;
                    }
                    cdeNMI.UpdFldContent(tTableRecord[0], tFldInfo, tVal, null);
                }
            }
            if (this.rowAdder) {
                this.tableMain.deleteRow(1);
                this.rowAdder = null;
                this.MyAdderRow = null;
                this.btnAdder.SetProperty("Visibility", true);
            }
            if (cdeNMI.MyEngine) {
                let tID = "auto";
                if (this.MyTarget) {
                    if (this.MyTarget.MyNMIControl && this.MyTarget.MyNMIControl.MyBaseType === cdeNMI.cdeControlType.Table)
                        tID = cde.GuidToString(this.MyTarget.MyFieldInfo.cdeMID);
                    else if (this.MyTarget.MyScreenID)
                        tID = this.MyTarget.MyScreenID;
                }
                cdeNMI.MyEngine.PublishToNMI('NMI_INS_DATA:' + this.MyTableName + ":" + this.MyScreenID + ":" + tID, JSON.stringify(tTableRecord[0]), this.MyFormInfo.cdeN);
                cdeNMI.ShowToastMessage("New Record was sent to owner");
            }
            else {
                cdeNMI.ShowToastMessage("No Engine Found");
            }
        }
        AddRecord(pScreenID) {
            if (this.GetSetting("AddTemplateType") && cdeNMI.MyScreenManager) {
                cdeNMI.MyScreenManager.TransitToScreen(this.GetSetting("AddTemplateType"), true, false, null, this.MyTableName);
                return;
            }
            if (!this.tableMain)
                return;
            if (this.rowAdder)
                return;
            this.rowAdder = this.tableMain.insertRow(1);
            this.MyAdderRow = [];
            let tFCnt = 0;
            for (let i = 0; i < this.mCurrentFormFieldsInfo.length; i++) {
                const tFldInfo = this.mCurrentFormFieldsInfo[i];
                this.rowAdder.className = "cdeHilightRow";
                const cell3 = ctrlTableCell.Create(null, new cdeNMI.TheTRF(this.MyTableName, 0, tFldInfo), this.rowAdder, tFCnt);
                if ((this.mCurrentFormFieldsInfo[i].Flags & 8) !== 0)
                    cell3.SetProperty("Visibility", false);
                if (tFldInfo.DataItem === "CDE_DELETE") {
                    cell3.SetProperty("TileWidth", 1);
                    cell3.SetProperty("ClassName", "cdeTH");
                    cdeNMI.Key13Event = () => { this.SaveRecord(); };
                    const tSB = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(cell3, { PreInitBag: ["ControlTW=1", "ControlTH=1", "TileFactorY=2"], PostInitBag: ["Title=<span class='fa fa-2x'>&#xf058;</span>"] });
                    tSB.SetProperty("OnClick", () => { this.SaveRecord(); });
                    cdeNMI.Key27Event = () => { this.CancelAddRecord(); };
                    const tCB = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileButton).Create(cell3, { PreInitBag: ["ControlTW=1", "ControlTH=1", "TileFactorY=2"], PostInitBag: ["Title=<span class='fa fa-2x'>&#xf057;</span>"] });
                    tCB.SetProperty("OnClick", () => { this.CancelAddRecord(); });
                }
                else {
                    if (tFldInfo.DataItem !== "CDE_DETAILS" &&
                        tFldInfo.Type !== 29 &&
                        tFldInfo.Type !== 27 &&
                        tFldInfo.Type !== 22 &&
                        tFldInfo.Type !== 23 &&
                        tFldInfo.Type !== 33 &&
                        (tFldInfo.Flags & 2) !== 0) {
                        tFldInfo["Value"] = tFldInfo["DefaultValue"];
                        const tE = new cdeNMI.ctrlTileEntry();
                        tE.InitControl(cell3, new cdeNMI.TheTRF(this.MyTableName, 0, tFldInfo), ["IsInTable=true"], pScreenID);
                        tE.SetProperty("NoTE", true);
                        tE.MyDataView = this;
                        if (tFldInfo.Type === cdeNMI.cdeControlType.CheckField)
                            tE.SetProperty("TileWidth", tFldInfo["Bits"]);
                        else
                            tE.SetProperty("TileWidth", tFldInfo["FldWidth"]);
                        tE.CreateControl("Id" + i, null);
                        tE.SetProperty("UXID", tFldInfo.cdeMID); //Sets the guid of the control
                        this.MyAdderRow[this.MyTableName + "_" + tFldInfo.FldOrder] = tE;
                    }
                }
                cell3.MyRootElement.style.verticalAlign = "top";
                tFCnt++;
            }
            this.btnAdder.SetProperty("Visibility", false);
            this.IsInEdit = true;
        }
        UploadNext() {
            if (this.mFileList.length) {
                const nextFile = this.mFileList.shift();
                let tFileSize = this.GetProperty("MaxFileSize");
                if (!tFileSize) {
                    tFileSize = 512000;
                }
                if (tFileSize > 500000000)
                    tFileSize = 500000000;
                if (nextFile.size >= tFileSize) { // 262144) { // 256kb
                    cdeNMI.MyToast.ShowToastMessage("File " + nextFile.name + " size " + nextFile.size + " too big - Max: " + tFileSize);
                    this.OnComplete(nextFile.size);
                }
                else {
                    cdeNMI.MyToast.ShowToastMessage("Reading: " + nextFile.name);
                    this.UploadFile(nextFile);
                }
            }
            else {
                this.mBaseDiv.classList.remove('ctrlDropUploaderHover');
            }
        }
        OnComplete(size) {
            this.UploadNext();
        }
        UploadFile(file) {
            const reader = new FileReader();
            reader.onload = (evt) => {
                const tres = reader.result;
                if (this.MyEngineName) {
                    let tFileName = file.name;
                    let tDir = this.GetProperty("TargetDir");
                    if (tDir) {
                        if (tDir.substring(tDir.length - 1) !== '\\')
                            tDir += "\\";
                        tFileName = tDir + tFileName;
                    }
                    if (this.MyFieldInfo) {
                        let tPushName = "CDE_FILEPUSH:" + tFileName + ":" + this.MyFieldInfo.cdeO;
                        if (this.GetProperty("Cookie"))
                            tPushName += ":" + this.GetProperty("Cookie");
                        if (cde.CBool(this.GetProperty("AllowGlobalPush")) && cde.MyBaseAssets.MyEngines[this.MyEngineName])
                            cdeCommCore.PublishCentral(this.MyEngineName, tPushName, tres);
                        else
                            cdeCommCore.PublishToNode(this.MyFieldInfo.cdeN, this.MyEngineName, tPushName, tres);
                    }
                }
                this.FireEvent(false, "OnFilePushed", evt.target);
            };
            reader.readAsDataURL(file);
        }
        ProcessFiles(pFileList) {
            if (!pFileList || !pFileList.length || this.mFileList.length)
                return;
            for (const tFile of pFileList) {
                this.mFileList.push(tFile);
            }
            this.UploadNext();
        }
        //Legacy Compliance
        static Create(pTargetControl, pScreenID, pTRF, pTableInfo, pIsLiveData, pClassName, pMetaData) {
            const tTable = new ctrlTableView(pTRF);
            if (pMetaData)
                tTable.MyMetaData = pMetaData;
            if (cdeCommonUtils.CBool(pIsLiveData))
                tTable.SetProperty("IsLiveData", true);
            else
                tTable.SetProperty("IsLiveData", false);
            if (pTableInfo) {
                const tStr = pTableInfo.split(':');
                if (tStr.length > 4)
                    tTable.SetProperty("PageSize", cdeCommonUtils.CInt(tStr[4]));
                if (tStr.length > 5)
                    tTable.SetProperty("CurrentPage", cdeCommonUtils.CInt(tStr[5]));
            }
            tTable.InitControl(pTargetControl, pTRF, null, pScreenID);
            if (pClassName)
                tTable.SetProperty("InnerClassName", pClassName);
            return tTable;
        }
    }
    cdeNMI.ctrlTableView = ctrlTableView;
})(cdeNMI || (cdeNMI = {}));
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
var cdeNMI;
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
(function (cdeNMI) {
    /////////////////////////////////////////////////////////////////////////
    /////***********************************************
    /////   C-DMyForms GENERATOR
    /////***********************************************
    /**
    * Creates a complete form for a given StorageMirror
    *
    * (4.1 Ready!)
    */
    class ctrlIFrameView extends cdeNMI.TheDataViewBase {
        constructor(pTRF) {
            super(pTRF);
            this.MyScreenInfo = null;
            this.MyFormInfo = null;
            this.MyTableName = null;
            this.mBaseDiv = null;
            this.mDivDashboardContent = null;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.FormView;
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            this.MyTableName = cde.GuidToString(this.MyTRF.TableName);
            this.MyScreenInfo = cdeNMI.MyNMIModels[this.MyScreenID];
            if (this.MyTRF)
                this.MyTRF.ModelID = this.MyScreenID;
            const tDiv = document.getElementById('Inline_' + cde.GuidToString(this.MyTableName));
            if (tDiv)
                this.mBaseDiv = tDiv;
            if (!this.mBaseDiv && !pTargetControl && this.MyScreenInfo.MyStorageMeta[this.MyTableName]) {
                this.mBaseDiv = document.getElementById('Content_' + cde.GuidToString(this.MyScreenInfo.MyStorageMeta[this.MyTableName].TargetElement));
            }
            const pClassName = 'CMyForm';
            if (!this.mBaseDiv) {
                this.mBaseDiv = document.createElement("div");
                this.mBaseDiv.className = pClassName;
                if (this.MyTarget) {
                    this.MyTarget.GetElement().innerHTML = ""; //OK
                }
            }
            else {
                this.mBaseDiv.innerHTML = ""; //OK
            }
            this.mBaseDiv.style.width = "inherit";
            this.mBaseDiv.style.height = (window.innerHeight - cdeNMI.GetSizeFromTile(1)) + "px";
            this.mDivDashboardContent = document.createElement("iframe");
            this.mDivDashboardContent.className = "cdeDashboardIFrame";
            this.mDivDashboardContent.style.width = "inherit";
            this.mDivDashboardContent.style.height = "inherit";
            this.mDivDashboardContent.onload = (evt) => {
                this.FireEvent(true, "OnIFrameLoaded", evt);
            };
            this.mDivDashboardContent.id = "cdeIFrame_" + this.MyScreenID;
            this.mBaseDiv.appendChild(this.mDivDashboardContent);
            this.SetElement(this.mBaseDiv, false, this.mDivDashboardContent);
            this.SetProperty("ID", "FORM_" + this.MyTableName);
            this.RegisterNMIControl();
            return true;
        }
        SetProperty(pName, pValue) {
            if (pName === "ClassName" && this.mDivDashboardContent) {
                this.mDivDashboardContent.className = pValue;
            }
            else
                super.SetProperty(pName, pValue);
            if (pName === "Source") {
                if (this.GetProperty("AddHeader") && cde.MyCommChannel) {
                    cde.MyCommChannel.GetGlobalResource(pValue, this.GetProperty("AddHeader"), (t) => {
                        this.MyContainerElement.src = "data:text/html;charset=utf-8," + escape(t);
                    });
                    /*
    $.ajax({
        type: "GET",
        url: "https://app.icontact.com/icp/a/",
        contentType: "application/json",
        beforeSend: function(xhr, settings){
                xhr.setRequestHeader("some_custom_header", "foo");},
        success: function(data){
            $("#output_iframe_id").attr('src',"data:text/html;charset=utf-8," + escape(data))
        }
    });                 * */
                }
                else
                    this.MyContainerElement.src = pValue;
            }
            else if (pName === "OnIFrameLoaded") {
                if (typeof pValue === "string" && pValue.substr(0, 4) === "NOWN") {
                    const tP = pValue.split(':');
                    this.RegisterEvent("OnIFrameLoaded", () => {
                        if (cdeNMI.MyEngine && this.MyTRF)
                            cdeNMI.MyEngine.GetBaseEngine().PublishToOwner(this.MyTRF.GetOwner(), "OnLoaded:" + this.MyTRF.GetMID() + (tP.length > 1 ? (":" + tP[1]) : ""), this.GetProperty("Source"), this.MyTRF.GetNodeID(), null, this.MyTRF.GetMID());
                    });
                }
                else
                    this.RegisterEvent("OnIFrameLoaded", pValue);
            }
            else if (pName === "Caption" || pName === "Title") {
                if (cdeNMI.MyScreenManager) {
                    const tS = cdeNMI.MyScreenManager.GetScreenByID(this.MyTableName);
                    if (tS)
                        tS.SetProperty(pName, pValue);
                }
            }
            else if (pName === "TileHeight") {
                if (!cde.CBool(this.GetSetting("HidePins")))
                    this.mDivDashboardContent.style.height = (this.GetElement().clientHeight - 44) + "px"; //44=39 +5
                else
                    this.mDivDashboardContent.style.height = "inherit";
            }
            else if (pName === "TileWidth") {
                this.ApplySkin();
            }
            else if (pName === "AllowScrolling") {
                this.mDivDashboardContent.style.overflow = "auto";
                this.ApplySkin();
            }
        }
    }
    cdeNMI.ctrlIFrameView = ctrlIFrameView;
})(cdeNMI || (cdeNMI = {}));
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
var cdeNMI;
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
(function (cdeNMI) {
    /**
* Creates a new Login Screen Control
*
* (4.1 Ready!)
*/
    class TheLoginScreen extends cdeNMI.TheNMIScreen {
        constructor(pTRF) {
            super(pTRF);
            this.mUID = null;
            this.mPWD = null;
            this.mPWD2 = null;
            this.mRelay = null;
            this.mScope = null;
            this.mLoginButton = null;
            this.mHeader = null;
            this.mHeaderHelp = null;
            this.mStatusMsg = null;
            this.tLoginGroup = null;
            this.mMeshPicker = null;
            this.bFinishCalled = false;
            this.bLoginFired = false;
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.LoginScreen;
            if (!pPropertyBag)
                pPropertyBag = [];
            pPropertyBag.push("HidePins=true");
            pPropertyBag.push("ScreenTitle=Login Screen");
            pPropertyBag.push("DashBoardID=LOGIN");
            super.InitControl(pTargetControl, pTRF, pPropertyBag, "CDELOGINSCREEN");
            this.SetProperty("ScreenClassName", "cde-animate-login cdeLoginScreen");
            this.SetProperty("ClassName", "cdeLoginContent");
            this.tLoginGroup = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileGroup).Create(this, { PostInitBag: ["TileWidth=6", "ClassName=cdeLoginBlock"] });
            const tIcon = new cdeNMI.TheTRF("NOTABLE", 0, new cdeNMI.TheFieldInfo(cdeNMI.cdeControlType.LogoButton, 4, "", 0, "", ["TileWidth=2", "TileHeight=2", "ClassName=cdeLogo cdeLoginItemAnim", "Style=outline-style:none;"]));
            const tIconTE = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileEntry).Create(this.tLoginGroup, { TRF: tIcon });
            tIconTE.CreateControl("LOGO");
            tIconTE.SetProperty("OnClick", () => {
                if (cde.MyBaseAssets.MyServiceHostInfo.PortalReset)
                    cde.MyBaseAssets.MyServiceHostInfo.PortalReset();
                else {
                    location.reload();
                    //cdeNMI.ResetBrowserToPortal();
                }
            });
            const tHeader = new cdeNMI.TheTRF("NOTABLE", 0, new cdeNMI.TheFieldInfo(cdeNMI.cdeControlType.SmartLabel, 4, "", 2, "", ["NoTE=true", "TileHeight=1", "TileWidth=4", "ClassName=cdeDlgTitleBar", "ContainerStyle=margin-top: 34px;", "iValue=Welcome to your NMI Portal"]));
            this.mHeader = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileEntry).Create(this.tLoginGroup, { TRF: tHeader });
            this.mHeader.CreateControl("HEADER");
            let tLogText = "Please login with your credentials";
            if (cde.MyBaseAssets.MyServiceHostInfo.LoginDisallowed) {
                if (this.GetProperty("ReasonText"))
                    tLogText = this.GetProperty("ReasonText");
                else
                    tLogText = "This Node is locked. NMI Access is disallowed";
            }
            else if (cde.MyBaseAssets.HasAutoLogin === true)
                tLogText = "Autologin...please wait";
            const tHeader2 = new cdeNMI.TheTRF("NOTABLE", 0, new cdeNMI.TheFieldInfo(cdeNMI.cdeControlType.SmartLabel, 4, "", 258, "", ["NoTE=true", "TileHeight=1", "TileWidth=4", "TileFactorY=2", "iValue=" + tLogText]));
            this.mHeaderHelp = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileEntry).Create(this.tLoginGroup, { TRF: tHeader2 });
            this.mHeaderHelp.CreateControl("HEADERHELP");
            let tStatus = "Waiting...";
            let tStatusClass = "cdeEngineStatusYellow";
            if (!cde.MyBaseAssets.MyServiceHostInfo.LoginDisallowed) {
                if (!cde.MyBaseAssets.MyServiceHostInfo.AutoConnectRelay || cde.MyBaseAssets.MyServiceHostInfo.AutoConnectRelay === "") {
                    const tRelays = new cdeNMI.TheTRF("NOTABLE", 0, new cdeNMI.TheFieldInfo(cdeNMI.cdeControlType.ComboOption, 4, "Select Relay", 2, "", ["EditPlaceholder=Select or enter a relay", "Options=" + cde.MyBaseAssets.MyServiceHostInfo.KnownRelays]));
                    this.mRelay = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileEntry).Create(this.tLoginGroup, { TRF: tRelays });
                    this.mRelay.CreateControl("UID");
                }
                if (cde.MyBaseAssets.HasAutoLogin === false) {
                    if (cde.MyBaseAssets.MyServiceHostInfo.EnablePinLogin) {
                        const tPWD = new cdeNMI.TheTRF("NOTABLE", 0, new cdeNMI.TheFieldInfo(cdeNMI.cdeControlType.Password, 4, "PIN", 3, "", ["EditPlaceholder=Enter Pin", "InTemplate=true", "AutoShowMTL=true"]));
                        this.mPWD = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileEntry).Create(this.tLoginGroup, { TRF: tPWD });
                        this.mPWD.CreateControl("PWD");
                        this.mPWD.MyNMIControl.RegisterEvent("OnValueChanged", () => {
                            this.LoginClick();
                        });
                    }
                    else {
                        const tUID = new cdeNMI.TheTRF("NOTABLE", 0, new cdeNMI.TheFieldInfo(cdeNMI.cdeControlType.eMail, 4, "Username", 2, "", ["EditPlaceholder=Enter email", "InTemplate=true"]));
                        this.mUID = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileEntry).Create(this.tLoginGroup, { TRF: tUID });
                        this.mUID.CreateControl("UID");
                        const tPWD = new cdeNMI.TheTRF("NOTABLE", 0, new cdeNMI.TheFieldInfo(cdeNMI.cdeControlType.Password, 4, "Password", 3, "", ["EditPlaceholder=Enter Password", "InTemplate=true"]));
                        this.mPWD = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileEntry).Create(this.tLoginGroup, { TRF: tPWD });
                        this.mPWD.CreateControl("PWD");
                        if (cde.MyBaseAssets.MyServiceHostInfo.AdminPWMustBeSet) {
                            const tPWD2 = new cdeNMI.TheTRF("NOTABLE", 0, new cdeNMI.TheFieldInfo(cdeNMI.cdeControlType.Password, 4, "Repeat Password", 3, "", ["EditPlaceholder=Repeat Password", "InTemplate=true"]));
                            this.mPWD2 = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileEntry).Create(this.tLoginGroup, { TRF: tPWD2 });
                            this.mPWD2.CreateControl("PWD2");
                            if (cde.MyBaseAssets.MyServiceHostInfo.AllowSetScopeWithSetAdmin) {
                                const tScope = new cdeNMI.TheTRF("NOTABLE", 0, new cdeNMI.TheFieldInfo(cdeNMI.cdeControlType.Password, 4, "Security ID", 3, "", ["EditPlaceholder=Security ID", "Visibility=false", "InTemplate=true"]));
                                this.mScope = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileEntry).Create(this.tLoginGroup, { TRF: tScope });
                                this.mScope.CreateControl("SCOPE");
                            }
                        }
                        const tLogBut = new cdeNMI.TheTRF("NOTABLE", 0, new cdeNMI.TheFieldInfo(cdeNMI.cdeControlType.TileButton, 4, "Login", 2, "", ["NoTE=true"]));
                        this.mLoginButton = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileEntry).Create(this.tLoginGroup, { TRF: tLogBut });
                        this.mLoginButton.CreateControl("LOGBUT");
                        this.mLoginButton.MyNMIControl.SetProperty("OnClick", () => { this.LoginClick(); });
                        this.mPWD.MyNMIControl.RegisterEvent("OnReturn", () => { this.LoginClick(); });
                    }
                }
            }
            else {
                if (this.GetProperty("StatusText"))
                    tStatus = this.GetProperty("StatusText");
                else
                    tStatus = "Node locked!";
                tStatusClass = "cdeEngineStatusRed";
            }
            const tStatMsg = new cdeNMI.TheTRF("NOTABLE", 0, new cdeNMI.TheFieldInfo(cdeNMI.cdeControlType.SmartLabel, 4, "Status...", 2, "", ["NoTE=true", "TileFactorY=2", "TileHeight=1", "TileWidth=6", "ClassName=" + tStatusClass, "iValue=" + tStatus]));
            this.mStatusMsg = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.TileEntry).Create(this.tLoginGroup, { TRF: tStatMsg });
            this.mStatusMsg.CreateControl("LOGSTATUS");
            if (cdeNMI.MyEngine && !cde.MyBaseAssets.MyServiceHostInfo.LoginDisallowed) {
                cdeNMI.MyEngine.RegisterEvent("CDE_LOGIN_EVENT", (s, a, r, b) => { this.FinishLogin(a, r, b); });
                cdeNMI.MyEngine.RegisterEvent("CDE_SETSTATUSMSG", (s, a, b) => { this.SetStatusMsg(a, b); });
                cdeNMI.MyEngine.RegisterEvent("CDE_SELECT_MESH", (s, a) => { this.ShowMeshSelect(a); });
                cdeNMI.MyEngine.RequestEngineStatus();
            }
            //this.SetElement(this.tLoginGroup.GetElement(), true, this.tLoginGroup.GetElement());
            this.ResetDialog();
            return true;
        }
        SetProperty(pName, pValue) {
            super.SetProperty(pName, pValue);
            if (pName === "Text" || pName === "Value" || pName === "iValue") {
                this.mHeaderHelp.SetProperty("Text", pValue);
            }
            else if (pName === "Visibility") {
                if (cde.CBool(pValue)) {
                    if (cdeNMI.MyScreenManager)
                        cdeNMI.MyScreenManager.ShowHeader(false);
                }
                else {
                    if (cdeNMI.MyScreenManager)
                        cdeNMI.MyScreenManager.ShowHeader(true);
                }
            }
        }
        LoginClick() {
            if (cde.MyBaseAssets.MyServiceHostInfo.AdminPWMustBeSet) {
                if (cdeNMI.Check4ValidPassword(this.mPWD.MyNMIControl.GetProperty("Value"))) {
                    if (cdeNMI.IsSamePassword(this.mPWD.MyNMIControl.GetProperty("Value"), this.mPWD2.MyNMIControl.GetProperty("Value"), true)) {
                        if (cdeNMI.Check4ValidEmail(this.mUID.MyNMIControl.GetProperty("Value"))) {
                            cdeNMI.Key13Event = null;
                            this.SetProperty("Text", "...updating Admin credentials...");
                            this.mUID.MyNMIControl.SetProperty("Disabled", true);
                            this.mPWD.MyNMIControl.SetProperty("Disabled", true);
                            this.mPWD2.MyNMIControl.SetProperty("Disabled", true);
                            if (this.mScope)
                                this.mScope.MyNMIControl.SetProperty("Disabled", true);
                            this.mLoginButton.MyNMIControl.SetProperty("Disabled", true);
                            let toEncr = this.mUID.GetProperty("Value") + ";:;" + this.mPWD.GetProperty("Value");
                            if (this.mScope && cde.MyBaseAssets.MyServiceHostInfo.AllowSetScopeWithSetAdmin)
                                toEncr += ";:;" + this.mScope.GetProperty("Value");
                            let cred = toEncr;
                            if (cde.MyContentEngine) {
                                cred = cde.MyContentEngine.RSAEncrypt(cred);
                                cde.MyContentEngine.PublishToFirstNode('CDE_UPD_ADMIN:' + cde.MyBaseAssets.MyServiceHostInfo.AdminRole, cred);
                            }
                        }
                        else {
                            this.ShakeNError("Please enter a valid email address.");
                        }
                    }
                    else {
                        this.ShakeNError("Admin Passwords do not match, please try again");
                    }
                }
                else {
                    this.ShakeNError("Passwords must be at least 8 characters, please try again");
                }
            }
            else {
                let tTarget = null;
                if (!cde.MyBaseAssets.MyServiceHostInfo.AutoConnectRelay) {
                    tTarget = this.mRelay.GetProperty("Value");
                    this.mRelay.SetProperty("Disabled", true);
                }
                if (!cde.MyBaseAssets.MyServiceHostInfo.IsUsingUserMapper || cde.MyBaseAssets.MyServiceHostInfo.EnablePinLogin) {
                    cdeNMI.Key13Event = null;
                    if (cde.MyBaseAssets.MyServiceHostInfo.EnablePinLogin === true)
                        this.SetProperty("Text", "...login with PIN...");
                    else
                        this.SetProperty("Text", "...setting scope...");
                    const tScope = this.mPWD.GetProperty("Value");
                    if (this.mUID)
                        this.mUID.SetProperty("Disabled", true);
                    this.mPWD.SetProperty("Disabled", true);
                    if (this.mPWD2)
                        this.mPWD2.SetProperty("Disabled", true);
                    if (this.mLoginButton)
                        this.mLoginButton.SetProperty("Disabled", true);
                    if (cdeNMI.MyEngine)
                        cdeNMI.MyEngine.Login(tTarget, tScope);
                    else {
                        if (this.HasEvent("OnLogin"))
                            this.FireEvent(true, "OnLogin", tScope);
                        else {
                            if (cdeNMI.MyPopUp)
                                cdeNMI.MyPopUp.Show("NMI requires login but no login provider found. Access is denied.", true, null, null, () => {
                                    cdeNMI.ResetBrowserToPortal();
                                });
                        }
                    }
                }
                else {
                    if (cdeNMI.MyEngine) {
                        const tRes = cdeNMI.MyEngine.ValidateUID(this.mUID.MyNMIControl.GetProperty("Value"));
                        if (tRes) {
                            this.ShakeNError(tRes);
                            return;
                        }
                    }
                    cdeNMI.Key13Event = null;
                    this.SetProperty("Text", "...verifying credentials...");
                    this.mUID.SetProperty("Disabled", true);
                    this.mPWD.SetProperty("Disabled", true);
                    if (this.mPWD2)
                        this.mPWD2.SetProperty("Disabled", true);
                    this.mLoginButton.SetProperty("Disabled", true);
                    if (cdeNMI.MyEngine)
                        cdeNMI.MyEngine.Login(tTarget, this.mUID.GetProperty("Value"), this.mPWD.GetProperty("Value"));
                    else {
                        if (this.HasEvent("OnLogin"))
                            this.FireEvent(true, "OnLogin", this.mUID.GetProperty("Value"), this.mPWD.GetProperty("Value"));
                        else {
                            if (cdeNMI.MyPopUp)
                                cdeNMI.MyPopUp.Show("NMI requires login but no login provider found. Access is denied.", true, null, null, () => {
                                    cdeNMI.ResetBrowserToPortal();
                                });
                        }
                    }
                }
            }
        }
        ShakeNError(pText) {
            this.tLoginGroup.GetElement().addEventListener("animationend", () => {
                //this.tLoginGroup.GetElement().removeEventListener("animationend", arguments.callee);
                this.tLoginGroup.GetElement().classList.remove("cde-animate-shake");
                this.ResetDialog();
            });
            this.tLoginGroup.GetElement().classList.add("cde-animate-shake");
            this.mStatusMsg.SetProperty("Text", pText);
            this.mStatusMsg.SetProperty("ClassName", "cdeEngineStatusRed");
        }
        ShowMeshSelect(pMeshes) {
            this.tLoginGroup.SetProperty("Visibility", false);
            this.mMeshPicker = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.MeshPicker).Create(this);
            this.mMeshPicker.SetProperty("SetMesh", pMeshes);
        }
        FinishLogin(bSuccess, pReason, pUserPref) {
            if (this.bFinishCalled || this.bLoginFired)
                return;
            if (!bSuccess) {
                this.ShakeNError(pReason);
            }
            else {
                this.bFinishCalled = true;
                cdeNMI.TL.RegisterEvent("OnLCIDChanged", () => {
                    if (this.bLoginFired)
                        return;
                    this.bLoginFired = true;
                    if (this.tLoginGroup.GetProperty("Visibility") === false) {
                        this.mMeshPicker.GetElement().addEventListener("animationend", () => {
                            this.SetProperty("Visibility", false);
                            this.mMeshPicker.GetElement().classList.remove("cdeLogin-animate-zoom");
                            this.FireEvent(false, "OnLogin", bSuccess, pUserPref);
                        });
                        this.mMeshPicker.GetElement().classList.add("cdeLogin-animate-zoom");
                    }
                    else {
                        this.tLoginGroup.GetElement().addEventListener("animationend", () => {
                            this.SetProperty("Visibility", false);
                            this.tLoginGroup.GetElement().classList.remove("cdeLogin-animate-zoom");
                            this.FireEvent(false, "OnLogin", bSuccess, pUserPref);
                        });
                        this.tLoginGroup.GetElement().classList.add("cdeLogin-animate-zoom");
                        this.mStatusMsg.SetProperty("ClassName", "cdeEngineStatusGreen");
                        this.mStatusMsg.SetProperty("Text", "Done...Requesting Portal...please wait");
                    }
                });
                this.mStatusMsg.SetProperty("Text", "Login successful! Loading language...please wait");
                this.mStatusMsg.SetProperty("ClassName", "cdeEngineStatusYellow");
                cdeNMI.TL.SetLCID(cde.MyBaseAssets.MyServiceHostInfo.CurrentLCID);
            }
        }
        ResetDialog() {
            if (cde.MyBaseAssets.HasAutoLogin === true)
                return;
            if (cde.MyBaseAssets.MyServiceHostInfo.LoginDisallowed)
                return;
            cdeNMI.Key13Event = () => {
                this.LoginClick();
            };
            this.mUID.SetProperty("Disabled", false);
            this.mPWD.SetProperty("Disabled", false);
            if (this.mPWD2)
                this.mPWD2.SetProperty("Disabled", false);
            this.mLoginButton.SetProperty("Disabled", false);
            this.mUID.SetProperty("Value", "");
            this.mPWD.SetProperty("Value", "");
            if (this.mScope) {
                this.mScope.SetProperty("Visibility", false);
                this.mScope.SetProperty("Disabled", false);
            }
            if (this.mPWD2)
                this.mPWD2.SetProperty("Value", "");
            if (this.mScope)
                this.mScope.SetProperty("Value", "");
            this.mPWD.SetProperty("Label", "Password");
            this.mPWD.SetProperty("EditPlaceholder", "Enter Password");
            if (cde.MyBaseAssets.MyServiceHostInfo.AdminPWMustBeSet) {
                this.mLoginButton.MyNMIControl.SetProperty("Text", "Set Password");
                if (this.mScope)
                    this.mScope.SetProperty("Visibility", true);
                this.mUID.SetProperty("Visibility", true);
                this.mPWD2.SetProperty("Visibility", true);
                this.mPWD2.MyNMIControl.RegisterEvent("OnReturn", () => { this.LoginClick(); });
                if (cde.MyBaseAssets.MyServiceHostInfo.AllowSetScopeWithSetAdmin)
                    this.mScope.SetProperty("Visibility", true);
                this.mHeaderHelp.MyNMIControl.SetProperty("Text", "The Administrator password and email are not set, yet. Please enter a strong password to ensure maximum security.");
            }
            else {
                if (cde.MyBaseAssets.MyServiceHostInfo.IsUsingUserMapper) {
                    this.mLoginButton.MyNMIControl.SetProperty("Text", "Login");
                    this.mUID.SetProperty("Visibility", true);
                    if (this.mPWD2)
                        this.mPWD2.SetProperty("Visibility", false);
                    this.mHeaderHelp.MyNMIControl.SetProperty("Text", "Please login with your credentials");
                }
                else {
                    this.mLoginButton.MyNMIControl.SetProperty("Text", "Set Security ID");
                    this.mUID.SetProperty("Visibility", false);
                    this.mPWD.SetProperty("Label", "Security ID");
                    this.mPWD.SetProperty("EditPlaceholder", "Enter Security ID");
                    if (this.mPWD2)
                        this.mPWD2.SetProperty("Visibility", false);
                    this.mHeaderHelp.MyNMIControl.SetProperty("Text", "Please enter your Security ID");
                }
            }
        }
        SetStatusMsg(pStatusMsg, pState) {
            let tColor = "cdeEngineStatusGreen";
            switch (pState) {
                case 2:
                    tColor = "cdeEngineStatusYellow";
                    break;
                case 3:
                    tColor = "cdeEngineStatusRed";
                    break;
            }
            this.mStatusMsg.SetProperty("Text", pStatusMsg);
            this.mStatusMsg.SetProperty("ClassName", tColor);
        }
    }
    cdeNMI.TheLoginScreen = TheLoginScreen;
})(cdeNMI || (cdeNMI = {}));
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
var cdeNMI;
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
(function (cdeNMI) {
    class ctrlCertPicker extends cdeNMI.ctrlPropertyPicker {
        constructor(pTRF) {
            super(pTRF);
        }
        InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID) {
            this.MyBaseType = cdeNMI.cdeControlType.CertPicker;
            this.ControlText = "ctrlCertPicker";
            this.RefreshCombo = '[{"V":"CDE_NOP","N":"click to see certificate-thumb and list"}]';
            super.InitControl(pTargetControl, pTRF, pPropertyBag, pScreenID);
            return true;
        }
        LoadComboContent(bForceShow) {
            const tChoiceOptions = this.GetProperty("LiveOptions");
            if (!tChoiceOptions) {
                if (cdeNMI.MyEngine) {
                    cdeNMI.MyEngine.PublishToNMI('NMI_GET_DATA:CERTPICKER:' + this.GetProperty("ID") + ':' + this.GetProperty("UXID"), '', this.MyFieldInfo ? this.MyFieldInfo.cdeN : null);
                    if (bForceShow)
                        this.UpdatePicker(bForceShow);
                }
                else {
                    this.DoShow = bForceShow;
                    this.SetProperty("LiveOptions", '[{"V":"CDE_NOP","N":"No NMI Engine available - cannot load"}]');
                }
            }
            else {
                this.CreateComboOptions(tChoiceOptions, this.GetProperty("Value"), true);
                this.UpdatePicker(bForceShow);
            }
            this.DoShow = false;
        }
    }
    cdeNMI.ctrlCertPicker = ctrlCertPicker;
})(cdeNMI || (cdeNMI = {}));
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
var cdeNMI;
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
(function (cdeNMI) {
    //Required for Backwards Compat with Convenience Apps
    class TheMainPage {
        static SetHoloLens() {
            if (cdeNMI.MyScreenManager)
                cdeNMI.MyScreenManager.SetHoloLens();
            return "";
        }
        static GotoStationHome(IsManual) {
            if (cdeNMI.MyScreenManager)
                cdeNMI.MyScreenManager.GotoStationHome(IsManual);
        }
        static ClearAndGoHome() {
            if (cdeNMI.MyScreenManager)
                cdeNMI.MyScreenManager.ClearAndGoHome();
        }
        static GetDeepLink() {
            if (cdeNMI.MyScreenManager)
                return cdeNMI.MyScreenManager.GetDeepLink();
            return "";
        }
        static TransitToScreen(pID, pMust, bDontTry) {
            if (cdeNMI.MyScreenManager)
                return cdeNMI.MyScreenManager.TransitToScreen(pID, pMust, bDontTry);
        }
    }
    cdeNMI.TheMainPage = TheMainPage;
    function FireEvent(FireAsync, pEventName, ...params) {
        cde.MyBaseAssets.FireEvent(FireAsync, pEventName, ...params);
    }
    cdeNMI.FireEvent = FireEvent;
    function RegisterEvent(pEventName, pCallback) {
        cde.MyBaseAssets.RegisterEvent(pEventName, (sender, ...param) => { pCallback(...param); });
    }
    cdeNMI.RegisterEvent = RegisterEvent;
    function AddCSSToHeader(pCSSFile, pCSSFileLite) {
        cde.AddCSSToHeader(pCSSFile, pCSSFileLite);
    }
    cdeNMI.AddCSSToHeader = AddCSSToHeader;
})(cdeNMI || (cdeNMI = {}));
var cdeCommonUtils;
(function (cdeCommonUtils) {
    function FixupPath(pInPath) {
        return cde.FixupPath(pInPath);
    }
    cdeCommonUtils.FixupPath = FixupPath;
    function DateToString(inDate) {
        return cde.DateToString(inDate);
    }
    cdeCommonUtils.DateToString = DateToString;
    function IsNotSet(pInVal) {
        return cde.IsNotSet(pInVal);
    }
    cdeCommonUtils.IsNotSet = IsNotSet;
    function CStr(pInVal) {
        return cde.CStr(pInVal);
    }
    cdeCommonUtils.CStr = CStr;
    function CInt(pInVal) {
        return cde.CInt(pInVal);
    }
    cdeCommonUtils.CInt = CInt;
    function CBool(inStr) {
        return cde.CBool(inStr);
    }
    cdeCommonUtils.CBool = CBool;
    function CDbl(pInVal) {
        return cde.CDbl(pInVal);
    }
    cdeCommonUtils.CDbl = CDbl;
    function GuidToString(InGuid) {
        return cde.GuidToString(InGuid);
    }
    cdeCommonUtils.GuidToString = GuidToString;
    function cdeLogEvent(e) {
        cde.MyEventLogger.FireEvent(true, "CDE_NEW_LOGENTRY", "BackCompat:cdeLogEvent", e);
    }
    cdeCommonUtils.cdeLogEvent = cdeLogEvent;
    function cdeMinMax(pValue, sourceMax, sourceMin, targetMax, targetMin) {
        return cdeNMI.cdeMinMax(pValue, sourceMax, sourceMin, targetMax, targetMin);
    }
    cdeCommonUtils.cdeMinMax = cdeMinMax;
    function toRadians(degrees) {
        return cdeNMI.toRadians(degrees);
    }
    cdeCommonUtils.toRadians = toRadians;
    ;
})(cdeCommonUtils || (cdeCommonUtils = {}));
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
var cdeNMI;
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
(function (cdeNMI) {
    function StartupNMI() {
        if (cde.MyBaseAssets.MyServiceHostInfo.DebugLevel > 3)
            debugger;
        if (document.getElementById("cdeLogView")) {
            cde.MyEventLogger.RegisterEvent("CDE_NEW_LOGENTRY", (pSender, location, Logtext) => {
                const ele = document.getElementById("cdeLogView");
                if (ele)
                    ele.innerHTML = cdeNMI.FormatDateNow("YYYY-MM-DD HH:mm:ss") + ": " + location + ":" + Logtext + "</br>" + ele.innerHTML;
            });
        }
        if (cde.MyBaseAssets.MyServiceHostInfo.ShowLogInConsole === true) {
            cde.MyEventLogger.RegisterEvent("CDE_NEW_LOGENTRY", (pSender, location, Logtext) => {
                const pText = cdeNMI.FormatDateNow("YYYY-MM-DD HH:mm:ss") + ": " + location + ":" + Logtext;
                if (typeof Debug !== "undefined")
                    Debug.writeln(pText);
                else
                    console.log(pText);
            });
        }
        //Step 1: Register all overrides (can be done in StartEngine of custom Engines)
        if (cde.MyBaseAssets.MyServiceHostInfo.ShowClassic)
            cdeNMI.MyTCF.RegisterControlType(cdeNMI.cdeControlType.ScreenManager, "cdeNMI.TheScreenManagerClassic");
        else {
            if (cde.MyBaseAssets.MyServiceHostInfo.ScreenManagerClass) {
                cdeNMI.MyTCF.RegisterControlType(cdeNMI.cdeControlType.ScreenManager, cde.MyBaseAssets.MyServiceHostInfo.ScreenManagerClass);
            }
            else {
                cdeNMI.MyTCF.RegisterControlType(cdeNMI.cdeControlType.ScreenManager, "cdeNMI.TheScreenManagerModern");
            }
        }
        cdeNMI.MyTCF.RegisterControlType(cdeNMI.cdeControlType.ProgressBar, "cdeNMI.ctrlProgressBarCool");
        cdeNMI.MyTCF.RegisterControlType(cdeNMI.cdeControlType.SingleCheck, "cdeNMI.ctrlToggleButton2");
        //cde.MyBaseAssets.MyServiceHostInfo.DisableWebWorker = true;
        //cde.MyBaseAssets.MyServiceHostInfo.PortalReset = function () { return; };
        //debugger;
        //Step 2: Create Communication Channel
        if (window.SharedWorker && !cde.MyBaseAssets.MyServiceHostInfo.DisableWebWorker)
            cde.MyCommChannel = new cdeWEB.cdeWebWorkerComm();
        else
            cde.MyCommChannel = new cdeWEB.cdeWebComm();
        //Step 3: Start Engine Host (starts the ContentService Engine)
        cde.StartEngineHost();
        //Step 4: Start NMI Communication Engine -not required if only manual screens have to be debugged
        //cdeNMI.TheNMIServiceLocal.StartEngine();    //This Engine does not need the CommChannel
        cdeNMI.TheNMIService.StartEngine();
        //Step 5: Login/start communication - Login should be done via NMI!
        if (cde.MyBaseAssets.MyServiceHostInfo.AutoConnectRelay && cde.MyCommChannel) {
            const tConfig = new cde.TheCommConfig(cde.MyBaseAssets.MyServiceHostInfo.WsTimeOut);
            tConfig.DisableRSA = cde.CBool(cde.MyBaseAssets.MyServiceHostInfo.DisableRSA);
            if (cde.MyBaseAssets.MyServiceHostInfo.AutoConnectRelay === "INCDE") {
                tConfig.RequestPath = "<%=ISBPATH%>";
                if (tConfig.RequestPath.substring(0, 3) === "<%=")
                    tConfig.RequestPath = null;
                tConfig.uri = cde.MyBaseAssets.MyCommStatus.MyServiceUrl;
                tConfig.wsuri = cde.MyBaseAssets.MyServiceHostInfo.MyWSServiceUrl;
                if (cde.MyBaseAssets.MyServiceHostInfo.UToken) {
                    tConfig.Creds = new cde.TheCDECredentials();
                    tConfig.Creds.QToken = cde.MyBaseAssets.MyServiceHostInfo.UToken;
                }
                tConfig.NoISB = true;
            }
            else {
                tConfig.uri = cde.MyBaseAssets.MyServiceHostInfo.AutoConnectRelay;
            }
            cde.MyCommChannel.RegisterEvent("CDE_CONN_CHANGED", (sender, bSuccess) => {
                if (bSuccess)
                    cdeNMI.CreatePortalControls();
                else {
                    cdeNMI.ShowMessage("Connection Failed", "A connection could not be established. Please verify your settings.");
                }
            });
            cde.MyCommChannel.RegisterEvent("CDE_SESSION_ENDED", (sender, pReason) => {
                if (cde.MyBaseAssets.MyServiceHostInfo.PortalReset)
                    cde.MyBaseAssets.MyServiceHostInfo.PortalReset();
                else {
                    cde.MyBaseAssets.MyServiceHostInfo.LoginDisallowed = true;
                    if (cde.MyBaseAssets.MyCommStatus) {
                        cde.MyBaseAssets.MyCommStatus.UserPref = null;
                        cde.MyBaseAssets.MyCommStatus.IsConnected = false;
                    }
                    if (cde.MyCommChannel) {
                        cde.MyCommChannel.ForceDisconnect = true;
                    }
                    cdeNMI.RemoveCookies();
                    const tLogView = document.getElementById("cdeLogView");
                    document.body.innerHTML = "";
                    if (tLogView)
                        document.body.appendChild(tLogView);
                    cdeNMI.ShowMessage(pReason, "Please refresh this page to login again", true);
                }
            });
            cde.MyCommChannel.RegisterEvent("CDE_NO_CONNECT", (sender, pReason) => {
                cdeNMI.ShowMessage("Connection Failed", pReason);
            });
            cde.MyCommChannel.StartCommunication(tConfig); //This is async now...we need connection update messages to show
        }
        else
            cdeNMI.CreatePortalControls();
    }
    cdeNMI.StartupNMI = StartupNMI;
    function ShowMessage(pStatus, pReason, bAllowReload = false) {
        cde.MyBaseAssets.MyServiceHostInfo.LoginDisallowed = true;
        cdeNMI.MyLoginScreen = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.LoginScreen, true);
        if (cdeNMI.MyLoginScreen) {
            cdeNMI.MyLoginScreen.SetProperty("StatusText", pStatus);
            cdeNMI.MyLoginScreen.SetProperty("ReasonText", pReason);
            cdeNMI.MyLoginScreen.Create(null);
            if (bAllowReload && cde.MyBaseAssets.MyServiceHostInfo.ReloadAfterLogout > 0) {
                setInterval(() => {
                    cdeNMI.ResetBrowserToPortal();
                }, cde.MyBaseAssets.MyServiceHostInfo.ReloadAfterLogout * 1000);
            }
        }
    }
    cdeNMI.ShowMessage = ShowMessage;
    function CreatePortalControls() {
        //Step 6: Create other Portal Controls
        cdeNMI.MyToast = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.Toast, true).Create(null);
        cdeNMI.MyPopUp = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.Popup, true).Create(null);
        cdeNMI.MyToolTip = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.ToolTip, true).Create(null);
        cdeNMI.MyShapeRecognizer = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.ShapeRecognizer, true);
        //Step 7: Switch to the correct language
        cdeNMI.TL.RegisterEvent("OnLCIDChanged", () => {
            //Step 8: if you want a screen manager - create it 
            if (cdeNMI.MyScreenManager || cdeNMI.MyLoginScreen) {
                return;
            }
            if (!cde.MyBaseAssets.MyCommStatus.IsUserLoggedIn && !cde.MyBaseAssets.MyServiceHostInfo.DoAllowAnonymous) {
                cdeNMI.MyLoginScreen = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.LoginScreen, true);
                if (cdeNMI.MyLoginScreen) {
                    cdeNMI.MyLoginScreen.RegisterEvent("OnLogin", (s, pLoggedIn, pUserPreferences) => {
                        if (pLoggedIn) {
                            if (pUserPreferences.Transforms) {
                                const scr = document.createElement('script');
                                scr.type = "text/javascript";
                                scr.text = pUserPreferences.Transforms;
                                document.head.appendChild(scr);
                            }
                            cdeNMI.DoLoginSuccess(pUserPreferences);
                        }
                    });
                    cdeNMI.MyLoginScreen.Create(null);
                }
            }
            else {
                try {
                    if (!cde.MyBaseAssets.MyCommStatus.UserPref)
                        cde.MyBaseAssets.MyCommStatus.UserPref = JSON.parse(cde.MyBaseAssets.MyServiceHostInfo.InitUserPref);
                }
                catch (e) {
                    //ignored
                }
                cdeNMI.DoLoginSuccess(cde.MyBaseAssets.MyCommStatus.UserPref);
            }
        });
        cdeNMI.TL.SetLCID(cde.MyBaseAssets.MyServiceHostInfo.CurrentLCID);
    }
    cdeNMI.CreatePortalControls = CreatePortalControls;
    function DoLoginSuccess(pUserPreferences) {
        if (pUserPreferences) {
            if (pUserPreferences.ShowClassic === true || cde.MyBaseAssets.MyServiceHostInfo.WebPlatform === 5)
                cdeNMI.MyTCF.RegisterControlType(cdeNMI.cdeControlType.ScreenManager, "cdeNMI.TheScreenManagerClassic");
            else {
                if (cde.MyBaseAssets.MyServiceHostInfo.ScreenManagerClass) {
                    cdeNMI.MyTCF.RegisterControlType(cdeNMI.cdeControlType.ScreenManager, cde.MyBaseAssets.MyServiceHostInfo.ScreenManagerClass);
                }
                else {
                    cdeNMI.MyTCF.RegisterControlType(cdeNMI.cdeControlType.ScreenManager, "cdeNMI.TheScreenManagerModern");
                }
            }
            cde.MyBaseAssets.MyServiceHostInfo.UPref = JSON.stringify(pUserPreferences);
            if (pUserPreferences.ThemeName === "Lite") {
                cde.MyBaseAssets.MyServiceHostInfo.IsLiteTheme = true;
                cdeNMI.ApplyTheme();
            }
            else if (pUserPreferences.ThemeName === "Dark") {
                cde.MyBaseAssets.MyServiceHostInfo.IsLiteTheme = false;
                cdeNMI.ApplyTheme();
            }
        }
        if (cdeNMI.MyScreenManager)
            return;
        cdeNMI.MyScreenManager = cdeNMI.MyTCF.CreateNMIControl(cdeNMI.cdeControlType.ScreenManager);
        cdeNMI.MyScreenManager.RegisterEvent("OnIsLoaded", () => {
            if (cde.MyBaseAssets.MyServiceHostInfo.RedPill === true && cdeNMI.MyDemoScreens) {
                cdeNMI.MyDemoScreens.Show();
            }
        });
        if (cde.MyBaseAssets.MyServiceHostInfo.RequestGeoLocation === true) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    cde.MyCommChannel.SendQueued(null, cdeNMI.eTheNMIEngine, cdeNMI.eTheNMIEngine, "NMI_MY_LOCATION", (position.coords.longitude + ";" + position.coords.latitude + ";" + position.coords.accuracy), 0, 3, 0, null);
                });
            }
        }
        window.addEventListener("scroll", () => {
            cdeNMI.MyNMISettings.IsScrolling = true;
        });
        cdeNMI.MyScreenManager.Create(null);
        cdeNMI.MyScreenManager.CreateLoginButtonOnly();
        if (cde.MyBaseAssets.MyServiceHostInfo.DoAllowAnonymous || !cdeNMI.MyEngine)
            cdeNMI.MyScreenManager.GotoStationHome(false); //Required only if no Login or Engine is present
    }
    cdeNMI.DoLoginSuccess = DoLoginSuccess;
})(cdeNMI || (cdeNMI = {}));
// SPDX-FileCopyrightText: 2009-2020 TRUMPF Laser GmbH, authors: C-Labs
//
// SPDX-License-Identifier: MPL-2.0
// Type Vector is [ x, y ]
// Type Matrix is [ Vector, Vector ]
// Type Transform is [ Matrix, Vector ]
/**
 * Multiply Scalar with Vector returns a Vector.
 *
 * @param {number} l scalar to multiply with
 * @param {Array<number>} x 2D vector.
 * @return {Array<number>}
 */
const scmult = function (l, x) {
    return [l * x[0], l * x[1]];
};
/**
 * Adding two vectors is another vector.
 *
 * @param {Array<number>} a 2D vector.
 * @param {Array<number>} b 2D vector.
 * @return {Array<number>} Sum vector.
 */
const vcadd = function (a, b) {
    return [a[0] + b[0], a[1] + b[1]];
};
/**
 * Subtracting two vectors is another vector.
 *
 * @param {Array<number>} a 2D vector.
 * @param {Array<number>} b 2D vector.
 * @return {Array<number>} Difference vector.
 */
const minus = function (a, b) {
    return [a[0] - b[0], a[1] - b[1]];
};
/**
 * Dot product of two vectors is scalar.
 *
 * @param {Array<number>} a 2D vector.
 * @param {Array<number>} b 2D vector.
 * @return {number} scalar inner product.
 */
const dot = function (a, b) {
    return a[0] * b[0] + a[1] * b[1];
};
/**
 * Exterior Product of two vectors is a pseudoscalar.
 *
 * @param {Array<number>} a 2D vector.
 * @param {Array<number>} b 2D vector.
 * @return {number} psuedo-scalar exterior product.
 */
const wedge = function (a, b) {
    return a[0] * b[1] - a[1] * b[0];
};
/**
 * Apply Matrix on Vector returns a Vector.
 *
 * @param {Array<Array<number>>} A 2x2 Matrix
 * @param {Array<number>} x 2D vector.
 * @return {Array<number>} 2D vector linear product.
 */
const apply = function (A, x) {
    return vcadd(scmult(x[0], A[0]), scmult(x[1], A[1]));
};
/**
 * Multiply two matrices.
 *
 * @param {Array<Array<number>>} A 2x2 Matrix
 * @param {Array<Array<number>>} B 2x2 Matrix
 * @return {Array<Array<number>>} A 2x2 Matrix
 */
const mult = function (A, B) {
    return [apply(A, B[0]), apply(A, B[1])];
};
/**
 * Represents a transform operation, Ax + b
 *
 * @constructor
 *
 * @param {Array<Array<number>>} A 2x2 Matrix.
 * @param {Array<number>} b 2D scalar.
 */
function Transform(A, b) {
    this.A = A;
    this.b = b;
}
/**
 * Given CSS Transform representation of the class.
 * @return {string} CSS 2D Transform.
 */
Transform.prototype.css = function () {
    const A = this.A;
    const b = this.b;
    return 'matrix(' + A[0][0] + ',' + A[0][1] + ',' + A[1][0] + ',' + A[1][1] +
        ',' + b[0] + ',' + b[1] + ')';
};
/**
 * Multiply two transforms.
 * Defined as
 *  (T o U) (x) = T(U(x))
 *
 * Derivation:
 *  T(U(x))
 *   = T(U.A(x) + U.b)
 *   = T.A(U.A(x) + U.b)) + T.b
 *   = T.A(U.A(x)) + T.A(U.b) + T.b
 *
 * @param {Transform} T
 * @param {Transform} U
 * @return {Transform} T o U
 */
const cascade = function (T, U) {
    return new Transform(mult(T.A, U.A), vcadd(apply(T.A, U.b), T.b));
};
/**
 * Creates the default rotation matrix
 *
 * @param {number} c x-projection (r cos(theta))
 * @param {number} s y-projection (r sin(theta))
 * @return {Array<Array<number>>} Rotation matrix.
 */
const rotate = function (c, s) {
    return [[c, s], [-s, c]];
};
/**
 * Returns matrix that transforms vector a to vector b.
 *
 * @param {Array<number>} a 2D vector.
 * @param {Array<number>} b 2D vector.
 * @return {Array<Array<number>>} Rotation + Scale matrix
 */
const rotscale = function (a, b) {
    const alen = dot(a, a);
    const sig = dot(a, b);
    const del = wedge(a, b);
    return rotate(sig / alen, del / alen);
};
const justscale = function (a, b) {
    const alen = Math.sqrt(dot(a, a));
    const blen = Math.sqrt(dot(b, b));
    const scale = blen / alen;
    return rotate(scale, 0);
};
/**
 * Zoom is a similarity preserving transform from a pair of source
 * points to a new pair of destination points. If rotate it is false
 * then it won't be maintaining the transfer precisely, but will only
 * do scaling part of it.
 *
 * @param {Array<Array<number>>} s two source points.
 * @param {Array<Array<number>>} d two destination points.
 * @param {Boolean} rotate true - rotate; else scale.
 *
 * @return {Transform} that moves point 's' to point 'd'
 */
const zoom = function (s, d, rotate) {
    // Source vector.
    const a = minus(s[1], s[0]);
    // Destination vector.
    const b = minus(d[1], d[0]);
    // Rotation needed for source to dest vector.
    const rs = rotate ? rotscale(a, b) : justscale(a, b);
    // Position of s[0] if rotation is applied.
    const rs0 = apply(rs, s[0]);
    // Since d[0] = rs0 + t
    const t = minus(d[0], rs0);
    return new Transform(rs, t);
};
/**
 * Weighted average of two vectors.
 *
 * @param {Array<number>} u 2D vector.
 * @param {Array<number>} v 2D vector.
 * @param {number} progress (from 0 to 1)
 * @return {Array<number>} (1-p) u + (p) v
 */
const avgVector = function (u, v, progress) {
    const u1 = scmult(1 - progress, u);
    const v1 = scmult(progress, v);
    return vcadd(u1, v1);
};
/**
 * Weighted average of two vectors.
 *
 * @return {Array<Array<number>>} A 2D matrix.
 * @return {Array<Array<number>>} B 2D matrix.
 * @param {number} progress (from 0 to 1)
 * @return {Array<Array<number>>} (1-p) A + (p) B
 */
const avgMatrix = function (A, B, progress) {
    return [avgVector(A[0], B[0], progress), avgVector(A[1], B[1], progress)];
};
/**
 * Weighted average of two transforms.
 * @param {Transform} Z Source Transform
 * @param {Transform} I Destination Transform
 * @param {number} progress (from 0 to 1)
 * @return {Transform} (1-p) Z + (p) I
 */
Transform.avg = function (Z, I, progress) {
    return new Transform(avgMatrix(Z.A, I.A, progress), avgVector(Z.b, I.b, progress));
};
const identity = new Transform([[1, 0], [0, 1]], [0, 0]);
/**
 * Gives a default value for an input object.
 *
 * @param {Object} param input parameter, may be undefined
 * @param {Object} val returned if param is undefined.
 * @return {Object}
 */
const defaults = function (param, val) {
    return (param === undefined) ? val : param;
};
/**
 * Method to override json config objects with default
 * values. If undefined in cfg corresponding value from
 * cfg_def will be picked.
 *
 * @param {Object} cfg input parameter config.
 * @param {Object} cfg_def default fallbacks.
 * @return {Object} new config
 */
const defaultConfig = function (cfg, cfgDef) {
    const newCfg = defaults(cfg, {});
    for (const k in cfgDef) {
        newCfg[k] = defaults(newCfg[k], cfgDef[k]);
    }
    return newCfg;
};
/**
 * @constructor
 * @export
 * @param {Element} elem to attach zoom handler.
 * @param {Object} config to specify additiona features.
 */
function Zoom(elem, config, wnd) {
    this.mayBeDoubleTap = null;
    this.isAnimationRunning = false;
    // SingleFinger = 1, DoubleFinger = 2, NoTouch = 0
    this.curTouch = 0;
    this.elem = elem;
    // keep reference to parent in case elem is moved elsewhere in DOM
    this.elemParent = elem.parentNode;
    this.activeZoom = identity;
    this.resultantZoom = identity;
    this.srcCoords = [0, 0];
    this.destCoords = [0, 0];
    const me = this;
    this.config = defaultConfig(config, {
        "pan": false,
        "rotate": true
    });
    this.wnd = wnd || window;
    // trigger browser optimisations for the transition
    // see https://dev.opera.com/articles/css-will-change-property/
    //elem.style['will-change'] = 'transform';  //Bug in Chromium: https://stackoverflow.com/questions/51971241/webview-crashing-my-app-with-validation-error-deserialization-failed
    elem.style['transform-origin'] = '0 0';
    const getCoordsDouble = function (t) {
        const oX = elem.offsetLeft;
        const oY = elem.offsetTop;
        return [
            [t[0].pageX - oX, t[0].pageY - oY],
            [t[1].pageX - oX, t[1].pageY - oY]
        ];
    };
    const getCoordsSingle = function (t) {
        const oX = elem.offsetLeft;
        const oY = elem.offsetTop;
        const x = t[0].pageX - oX;
        const y = t[0].pageY - oY;
        return [
            [x, y],
            [x + 1, y + 1]
        ];
    };
    const getCoords = function (t) {
        return t.length > 1 ? getCoordsDouble(t) : getCoordsSingle(t);
    };
    const setSrcAndDest = function (touches) {
        me.srcCoords = getCoords(touches);
        me.destCoords = me.srcCoords;
    };
    const setDest = function (touches) {
        me.destCoords = getCoords(touches);
    };
    const handleTouchEvent = function (cb) {
        return function (evt) {
            if (me.isAnimationRunning) {
                return false;
            }
            const touches = evt.touches;
            if (!touches) {
                return false;
            }
            cb(touches);
            evt.preventDefault();
        };
    };
    this._handleZoom = handleTouchEvent(function (touches) {
        const numOfFingers = touches.length;
        if (numOfFingers !== me.curTouch) {
            me.curTouch = numOfFingers;
            me.finalize();
            if (numOfFingers !== 0) {
                setSrcAndDest(touches);
            }
        }
        else {
            setDest(touches);
            me.previewZoom();
        }
    });
    this._handleTouchStart = handleTouchEvent(function (touches) {
        if (touches.length === 1) {
            if (me.mayBeDoubleTap !== null) {
                me.wnd.clearTimeout(me.mayBeDoubleTap);
                me.reset();
                me.mayBeDoubleTap = null;
            }
            else {
                me.mayBeDoubleTap = me.wnd.setTimeout(function () {
                    me.mayBeDoubleTap = null;
                }, 300);
            }
        }
    });
    this.elemParent.addEventListener('touchstart', this._handleTouchStart);
    this.elemParent.addEventListener('touchstart', this._handleZoom);
    this.elemParent.addEventListener('touchmove', this._handleZoom);
    this.elemParent.addEventListener('touchend', this._handleZoom);
}
Zoom.prototype.destroy = function () {
    this.elemParent.removeEventListener('touchstart', this._handleTouchStart);
    this.elemParent.removeEventListener('touchstart', this._handleZoom);
    this.elemParent.removeEventListener('touchmove', this._handleZoom);
    this.elemParent.removeEventListener('touchend', this._handleZoom);
    this.elem.style['will-change'] = null;
    this.elem.style['transform-origin'] = null;
    this.elem.style.transform = null;
};
Zoom.prototype.previewZoom = function () {
    const additionalZoom = zoom(this.srcCoords, this.destCoords, this.config.rotate);
    this.resultantZoom = cascade(additionalZoom, this.activeZoom);
    this.repaint();
};
Zoom.prototype.setZoom = function (newZoom) {
    this.resultantZoom = newZoom;
    this.repaint();
};
Zoom.prototype.finalize = function () {
    this.activeZoom = this.resultantZoom;
};
Zoom.prototype.repaint = function () {
    this.elem.style.transform = this.resultantZoom.css();
};
Zoom.prototype.reset = function () {
    if (this.wnd.requestAnimationFrame) {
        this.isAnimationRunning = true;
        const Z = this.activeZoom;
        let startTime = null;
        const me = this;
        const step = function (time) {
            if (!startTime) {
                startTime = time;
            }
            const progress = (time - startTime) / 100;
            if (progress >= 1) {
                me.setZoom(identity);
                me.isAnimationRunning = false;
            }
            else {
                me.setZoom(Transform.avg(Z, identity, progress));
                me.wnd.requestAnimationFrame(step);
            }
        };
        this.wnd.requestAnimationFrame(step);
    }
    else {
        this.setZoom(identity);
    }
};
//# sourceMappingURL=cde.js.map